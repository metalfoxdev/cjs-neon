!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(exports):"function"==typeof define&&define.amd?define(["exports"],e):e((t="undefined"!=typeof globalThis?globalThis:t||self).pc={})}(this,function(t){function e(t){if(null===t)return"null";var e=typeof t;return"undefined"===e||"number"===e||"string"===e||"boolean"===e?e:Qr[Object.prototype.toString.call(t)]}function i(t,s){var n;for(n in s){var r=s[n];"object"==e(r)?t[n]=i({},r):"array"==e(r)?t[n]=i([],r):t[n]=r}return t}function s(t){return void 0!==t}function n(){this._callbacks={},this._callbackActive={}}function r(t,e){var i=t.length;if(0>(e=e||0)||e>=i)return null;var s=t.charCodeAt(e);return 1<i&&55296<=s&&56319>=s&&(56320<=(t=t.charCodeAt(e+1))&&57343>=t)?{code:1024*(s-55296)+t-56320+65536,long:!0}:{code:s,long:!1}}function a(t,e,i){return!!t&&(!!(t=r(t))&&((t=t.code)>=e&&t<=i))}function o(t,e,i,s){var n=t&&t.length;3===n||4===n?(this.r=t[0],this.g=t[1],this.b=t[2],this.a=void 0!==t[3]?t[3]:1):(this.r=t||0,this.g=e||0,this.b=i||0,this.a=void 0!==s?s:1)}function h(){this._list=[],this._index={}}function l(t){this._index={},this._key=t||null}function c(t){n.call(this),this._index={},this._list=[],this._parent=t}function d(){this._isRunning=!1,this._b=this._a=0}function u(t){t=t.match(/^(([^:\/?#]+):)?(\/\/([^\/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/),this.scheme=t[2],this.authority=t[4],this.path=t[5],this.query=t[7],this.fragment=t[9],this.toString=function(){var t="";return this.scheme&&(t+=this.scheme+":"),this.authority&&(t+="//"+this.authority),t+=this.path,this.query&&(t+="?"+this.query),this.fragment&&(t+="#"+this.fragment),t},this.getQuery=function(){var t,e={};this.query&&decodeURIComponent(this.query).split("&").forEach(function(i,s,n){t=i.split("="),e[t[0]]=t[1]},this);return e},this.setQuery=function(t){var e,i="";for(e in t)t.hasOwnProperty(e)&&(""!==i&&(i+="&"),i+=encodeURIComponent(e)+"="+encodeURIComponent(t[e]));this.query=i}}function p(){}function f(t,e){this._curve=t,this._left=-1/0,this._right=1/0,this._m1=this._m0=this._p1=this._p0=this._recip=0,this._reset(e||0)}function m(t){if(this.keys=[],this.type=1,this.tension=.5,this._eval=new f(this),t)for(var e=0;e<t.length-1;e+=2)this.keys.push([t[e],t[e+1]]);this.sort()}function _(){var t;if(this.curves=[],this._type=1,1<arguments.length)for(t=0;t<arguments.length;t++)this.curves.push(new m(arguments[t]));else if(0===arguments.length)this.curves.push(new m);else{var e=arguments[0];if("number"==typeof e)for(t=0;t<e;t++)this.curves.push(new m);else for(t=0;t<e.length;t++)this.curves.push(new m(e[t]))}}function g(){var t=new Float32Array(9);t[0]=t[4]=t[8]=1,this.data=t}function y(t,e){t&&2===t.length?(this.x=t[0],this.y=t[1]):(this.x=t||0,this.y=e||0)}function v(t,e,i){t&&3===t.length?(this.x=t[0],this.y=t[1],this.z=t[2]):(this.x=t||0,this.y=e||0,this.z=i||0)}function b(t,e,i,s){t&&4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=t||0,this.y=e||0,this.z=i||0,this.w=s||0)}function x(){var t=new Float32Array(16);t[0]=t[5]=t[10]=t[15]=1,this.data=t}function S(t,e,i,s){t&&4===t.length?(this.x=t[0],this.y=t[1],this.z=t[2],this.w=t[3]):(this.x=void 0===t?0:t,this.y=void 0===e?0:e,this.z=void 0===i?0:i,this.w=void 0===s?1:s)}function T(t,e){this.center=t||new v(0,0,0),this.halfExtents=e||new v(.5,.5,.5),this._min=new v,this._max=new v}function w(t,e){this.center=t||new v(0,0,0),this.radius=void 0===e?.5:e}function M(){this.planes=[];for(var t=0;6>t;t++)this.planes[t]=[]}function P(t,e){this.origin=t||new v(0,0,0),this.direction=e||new v(0,0,-1)}function A(t,e){this.halfExtents=e||new v(.5,.5,.5),t=t||Ta.setIdentity(),this._modelTransform=t.clone().invert(),this._worldTransform=t.clone(),this._aabb=new T(new v,this.halfExtents)}function E(t,e){this.normal=e||new v(0,0,1),this.point=t||new v(0,0,0)}function C(t,e,i,s,n){this.usage=s||0,this.format=e,this.numVertices=i,this.id=Ca++,this.numBytes=e.verticesByteSize?e.verticesByteSize:e.size*i,t._vram.vb+=this.numBytes,this.device=t,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),this.device.buffers.push(this)}function I(t){for(var e=0,i=0,s=t.length;i<s;i++)e=(e<<5)-e+t.charCodeAt(i),e|=0;return e}function O(t,e,i){var s;this.elements=[],this.hasTangents=this.hasColor=this.hasUv1=this.hasUv0=!1,this._defaultInstancingFormat=null,this.verticesByteSize=0,this.vertexCount=i,this.interleaved=!i,this.size=e.reduce(function(t,e){return t+4*Math.ceil(e.components*Pa[e.type]/4)},0);var n=0;for(t=0,s=e.length;t<s;t++){var r=e[t],a=r.components*Pa[r.type];i&&(n=oa.roundUp(n,a));var o={name:r.semantic,offset:i?n:r.hasOwnProperty("offset")?r.offset:n,stride:i?a:r.hasOwnProperty("stride")?r.stride:this.size,dataType:r.type,numComponents:r.components,normalize:void 0!==r.normalize&&r.normalize,size:a};this.elements.push(o),n=i?n+a*i:n+4*Math.ceil(a/4),"TEXCOORD0"===r.semantic?this.hasUv0=!0:"TEXCOORD1"===r.semantic?this.hasUv1=!0:"COLOR"===r.semantic?this.hasColor=!0:"TANGENT"===r.semantic&&(this.hasTangents=!0)}i&&(this.verticesByteSize=n),this.update()}function R(t,e,i){switch(this.index=0,this.numComponents=e.numComponents,this.array=i.interleaved?new Ma[e.dataType](t,e.offset):new Ma[e.dataType](t,e.offset,i.vertexCount*e.numComponents),this.stride=e.stride/this.array.constructor.BYTES_PER_ELEMENT,e.numComponents){case 1:this.set=D,this.getToArray=V,this.setFromArray=N;break;case 2:this.set=L,this.getToArray=j,this.setFromArray=k;break;case 3:this.set=F,this.getToArray=G,this.setFromArray=z;break;case 4:this.set=B,this.getToArray=H,this.setFromArray=U}}function D(t){this.array[this.index]=t}function L(t,e){this.array[this.index]=t,this.array[this.index+1]=e}function F(t,e,i){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=i}function B(t,e,i,s){this.array[this.index]=t,this.array[this.index+1]=e,this.array[this.index+2]=i,this.array[this.index+3]=s}function N(t,e,i){this.array[t]=e[i]}function k(t,e,i){this.array[t]=e[i],this.array[t+1]=e[i+1]}function z(t,e,i){this.array[t]=e[i],this.array[t+1]=e[i+1],this.array[t+2]=e[i+2]}function U(t,e,i){this.array[t]=e[i],this.array[t+1]=e[i+1],this.array[t+2]=e[i+2],this.array[t+3]=e[i+3]}function V(t,e,i){e[i]=this.array[t]}function j(t,e,i){e[i]=this.array[t],e[i+1]=this.array[t+1]}function G(t,e,i){e[i]=this.array[t],e[i+1]=this.array[t+1],e[i+2]=this.array[t+2]}function H(t,e,i){e[i]=this.array[t],e[i+1]=this.array[t+1],e[i+2]=this.array[t+2],e[i+3]=this.array[t+3]}function W(t){this.vertexBuffer=t,this.vertexFormatSize=t.getFormat().size,this.buffer=this.vertexBuffer.lock(),this.accessors=[],this.element={},t=this.vertexBuffer.getFormat();for(var e=0;e<t.elements.length;e++){var i=t.elements[e];this.accessors[e]=new R(this.buffer,i,t),this.element[i.name]=this.accessors[e]}}function X(t,e,i,s,n,r){if(null===Ia){var a=new O(t,[{semantic:"POSITION",components:2,type:6}]);(a=new W(Ia=new C(t,a,4))).element.POSITION.set(-1,-1),a.next(),a.element.POSITION.set(1,-1),a.next(),a.element.POSITION.set(-1,1),a.next(),a.element.POSITION.set(1,1),a.end()}if(a=t.renderTarget,t.setRenderTarget(e),t.updateBegin(),s)var o=s.x,h=s.y,l=s.z,c=s.w;else l=e?e.width:t.width,c=e?e.height:t.height,h=o=0;if(n)var d=n.x,u=n.y,p=n.z,f=n.w;else d=o,u=h,p=l,f=c;n=t.vx,s=t.vy,e=t.vw;var m=t.vh;t.setViewport(o,h,l,c),l=t.sx,o=t.sy,h=t.sw,c=t.sh,t.setScissor(d,u,p,f),d=t.getDepthTest(),u=t.getDepthWrite(),p=t.getCullMode(),f=t.writeRed;var _=t.writeGreen,g=t.writeBlue,y=t.writeAlpha;t.setDepthTest(!1),t.setDepthWrite(!1),t.setCullMode(0),t.setColorWrite(!0,!0,!0,!0),r||t.setBlending(!1),t.setVertexBuffer(Ia,0),t.setShader(i),t.draw(Oa),t.setDepthTest(d),t.setDepthWrite(u),t.setCullMode(p),t.setColorWrite(f,_,g,y),t.updateEnd(),t.setRenderTarget(a),t.updateBegin(),t.setViewport(n,s,e,m),t.setScissor(l,o,h,c)}function q(t,e){this.device=t,this.definition=e,this.attributes=[],this.uniforms=[],this.samplers=[],this.failed=this.ready=!1,this.device.createShader(this)}function Y(t,e){return e||(e=Ra),1===t||2===t?e.gamma2_2PS?e.gamma2_2PS:Ra.gamma2_2PS:3===t?"#define HDR\n"+(e.gamma2_2PS?e.gamma2_2PS:Ra.gamma2_2PS):e.gamma1_0PS?e.gamma1_0PS:Ra.gamma1_0PS}function K(t,e){return e||(e=Ra),1===t?e.tonemappingFilmicPS?e.tonemappingFilmicPS:Ra.tonemappingFilmicPS:0===t?e.tonemappingLinearPS?e.tonemappingLinearPS:Ra.tonemappingLinearPS:2===t?e.tonemappingHejlPS?e.tonemappingHejlPS:Ra.tonemappingHejlPS:3===t?e.tonemappingAcesPS?e.tonemappingAcesPS:Ra.tonemappingAcesPS:4===t?e.tonemappingAces2PS?e.tonemappingAces2PS:Ra.tonemappingAces2PS:e.tonemapingNonePS?e.tonemapingNonePS:Ra.tonemappingNonePS}function $(t,e){return e||(e=Ra),"linear"===t?e.fogLinearPS?e.fogLinearPS:Ra.fogLinearPS:"exp"===t?e.fogExpPS?e.fogExpPS:Ra.fogExpPS:"exp2"===t?e.fogExp2PS?e.fogExp2PS:Ra.fogExp2PS:e.fogNonePS?e.fogNonePS:Ra.fogNonePS}function Z(t,e){return e||(e=Ra),t.supportsBoneTextures?e.skinTexVS:"#define BONE_LIMIT "+t.getBoneLimit()+"\n"+e.skinConstVS}function Q(t){var e="precision "+t.precision+" float;\n";return t.webgl2&&(e+="#ifdef GL2\nprecision "+t.precision+" sampler2DShadow;\n#endif\n"),e}function J(t){return t.webgl2?"#version 300 es\n":""}function tt(){return"void main(void) {gl_FragColor = vec4(0.0);}"}function et(){return"void main(void)\n{\n"}function it(t){for(var e={},i=0,s=t.indexOf("attribute");0<=s&&!(0<s&&"/"===t[s-1]);){var n=t.indexOf(";",s),r=t.lastIndexOf(" ",n);n=t.substr(r+1,n-(r+1)),void 0!==(r=Da[n])?e[n]=r:(e[n]="ATTR"+i,i++),s=t.indexOf("attribute",s+1)}return e}function st(t,e,i,s,n,r){var a=t.programLib._cache,o=a[s];return void 0!==o?o:(i=Q(t)+"\n"+(i||"void main(void) {gl_FragColor = vec4(0.0);}"),o=it(e),t.webgl2&&(e=J(t)+Ra.gles3VS+e,i=J(t)+Ra.gles3PS+i),a[s]=new q(t,{attributes:o,vshader:e,fshader:(r||"")+i,useTransformFeedback:n}),a[s])}function nt(t,e){this.device=t,this.name=null,this._height=this._width=4,this._depth=1,this._format=7,this.type="default",this.fixCubemapSeams=this._volume=this._cubemap=!1,this._flipY=!0,this._premultiplyAlpha=!1,this._mipmaps=!0,this._minFilter=5,this._anisotropy=this._magFilter=1,this._addressW=this._addressV=this._addressU=0,this._compareOnRead=!1,this._compareFunc=1,void 0!==e&&(void 0!==e.name&&(this.name=e.name),this._width=void 0!==e.width?e.width:this._width,this._height=void 0!==e.height?e.height:this._height,this._format=void 0!==e.format?e.format:this._format,e.hasOwnProperty("type")?this.type=e.type:e.hasOwnProperty("rgbm")?this.type=e.rgbm?"rgbm":"default":e.hasOwnProperty("swizzleGGGR")&&(this.type=e.swizzleGGGR?"swizzleGGGR":"default"),this._mipmaps=void 0!==e.mipmaps?e.mipmaps:void 0!==e.autoMipmap?e.autoMipmap:this._mipmaps,this._levels=e.levels,this._cubemap=void 0!==e.cubemap?e.cubemap:this._cubemap,this.fixCubemapSeams=void 0!==e.fixCubemapSeams?e.fixCubemapSeams:this.fixCubemapSeams,this._minFilter=void 0!==e.minFilter?e.minFilter:this._minFilter,this._magFilter=void 0!==e.magFilter?e.magFilter:this._magFilter,this._anisotropy=void 0!==e.anisotropy?e.anisotropy:this._anisotropy,this._addressU=void 0!==e.addressU?e.addressU:this._addressU,this._addressV=void 0!==e.addressV?e.addressV:this._addressV,this._compareOnRead=void 0!==e.compareOnRead?e.compareOnRead:this._compareOnRead,this._compareFunc=void 0!==e._compareFunc?e._compareFunc:this._compareFunc,this._flipY=void 0!==e.flipY?e.flipY:this._flipY,this._premultiplyAlpha=void 0!==e.premultiplyAlpha?e.premultiplyAlpha:this._premultiplyAlpha,t.webgl2&&(this._depth=void 0!==e.depth?e.depth:this._depth,this._volume=void 0!==e.volume?e.volume:this._volume,this._addressW=void 0!==e.addressW?e.addressW:this._addressW)),this._compressed=8===this._format||9===this._format||10===this._format||21<=this._format,this._invalid=!1,this._lockedLevel=-1,this._levels||(this._levels=this._cubemap?[[null,null,null,null,null,null]]:[null]),this.dirtyAll(),this._gpuSize=0}function rt(t,e,i,s,n){if(this.usage=s||0,this.format=e,this.numIndices=i,this.device=t,i=this.device.gl,0===e){var r=1;this.glFormat=i.UNSIGNED_BYTE}else 1===e?(r=2,this.glFormat=i.UNSIGNED_SHORT):2===e&&(r=4,this.glFormat=i.UNSIGNED_INT);this.bytesPerIndex=r,this.numBytes=this.numIndices*r,n?this.setData(n):this.storage=new ArrayBuffer(this.numBytes),t._vram.ib+=this.numBytes,this.device.buffers.push(this)}function at(){this.initDefaults()}function ot(t,e,i,s){this.data=t,this.componentCount=e,this.dataType=i,this.dataTypeNormalize=s}function ht(t){this._refCount=0,this.id=qa++,this.device=t||sr.getApplication().graphicsDevice,this.vertexBuffer=null,this.indexBuffer=[null],this.primitive=[{type:0,base:0,count:0}],this._geometryData=this.morph=this.skin=null,this._aabb=new T,this.boneAabb=null}function lt(t,e,i){this._key=[0,0],this._shader=[null,null,null],this.isStatic=!1,this._staticSource=this._staticLightList=null,this.node=t,this._mesh=e,e.incReference(),this.material=i,this._shaderDefs=65536,this._shaderDefs|=e.vertexBuffer.format.hasUv0?4:0,this._shaderDefs|=e.vertexBuffer.format.hasUv1?8:0,this._shaderDefs|=e.vertexBuffer.format.hasColor?16:0,this._shaderDefs|=e.vertexBuffer.format.hasTangents?512:0,this._lightHash=0,this.visible=!0,this.layer=15,this.renderStyle=0,this.castShadow=!1,this._receiveShadow=!0,this._noDepthDrawGl1=this._screenSpace=!1,this._updateAabb=this.pick=this.cull=!0,this._calculateSortDistance=this._updateAabbFunc=null,this.updateKey(),this.instancingData=this._morphInstance=this._skinInstance=null,this.aabb=new T,this._aabbVer=-1,this.visibleThisFrame=this.drawOrder=0,this.isVisibleFunc=null,this.parameters={},this.stencilBack=this.stencilFront=null,this.flipFaces=!1}function ct(t,e,i){this._key=[],this._key[0]=(15&t)<<27|(3===e?1:0)<<26|33554432,this.command=i}function dt(t){this.count=t,this.vertexBuffer=null}function ut(t,e){this.device=e||sr.getApplication().graphicsDevice,this._targets=t,this.device.supportsMorphTargetTexturesCore&&(this.device.extTextureHalfFloat&&this.device.textureHalfFloatRenderable?this._renderTextureFormat=ut.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&this.device.textureFloatRenderable&&(this._renderTextureFormat=ut.FORMAT_FLOAT),this.device.extTextureHalfFloat&&this.device.textureHalfFloatUpdatable?this._textureFormat=ut.FORMAT_HALF_FLOAT:this.device.extTextureFloat&&(this._textureFormat=ut.FORMAT_FLOAT),void 0!==this._renderTextureFormat&&void 0!==this._textureFormat&&(this._useTextureMorph=!0)),this._init(),this._updateMorphFlags(),this._calculateAabb()}function pt(t){this.morph=t,this.device=t.device,this.meshInstance=null,this._weights=[];for(var e=0;e<t._targets.length;e++)this.setWeight(e,t._targets[e].defaultWeight);if(this._activeTargets=[],t.useTextureMorph){for(this.shaderCache={},this.maxSubmitCount=this.device.maxTextures,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),e=function(e,i){return this[i]=t._createTexture(e,t._renderTextureFormat===ut.FORMAT_FLOAT?14:12),new gp({colorBuffer:this[i],depth:!1})}.bind(this),t.morphPositions&&(this.rtPositions=e("MorphRTPos","texturePositions")),t.morphNormals&&(this.rtNormals=e("MorphRTNrm","textureNormals")),this._textureParams=new Float32Array([t.morphTextureWidth,t.morphTextureHeight,1/t.morphTextureWidth,1/t.morphTextureHeight]),e=0;e<this.maxSubmitCount;e++)this["morphBlendTex"+e]=this.device.scope.resolve("morphBlendTex"+e);this.morphFactor=this.device.scope.resolve("morphFactor[0]"),this.zeroTextures=!1}else this.maxSubmitCount=8,this._shaderMorphWeights=new Float32Array(this.maxSubmitCount),this._shaderMorphWeightsA=new Float32Array(this._shaderMorphWeights.buffer,0,4),this._shaderMorphWeightsB=new Float32Array(this._shaderMorphWeights.buffer,16,4),this._activeVertexBuffers=Array(this.maxSubmitCount)}function ft(t){this._dirty=!0,t&&this.initSkin(t)}function mt(){this.graph=null,this.meshInstances=[],this.skinInstances=[],this.morphInstances=[],this.cameras=[],this.lights=[],this._shadersVersion=0,this._immutable=!1}function _t(t,e,i){this.origMeshInstances=t,this._aabb=new T,this.model=this.meshInstance=null,this.dynamic=e,this.batchGroupId=i,this.refCounter=0}function gt(t,e,i,s,n){this.dynamic=i,this.maxAabbSize=s,this.id=t,this.name=e,this.layers=void 0===n?[0]:n,this._sprite=this._ui=!1,this._obj={model:[],element:[],sprite:[]}}function yt(t,e,i){ft.call(this),ft.prototype.init.call(this,t,e.length),this.device=t,this.rootNode=i,this.bones=e}function vt(t,e,i){this.device=t,this.rootNode=e,this.scene=i,this._init=!1,this._batchGroups={},this._batchGroupCounter=0,this._batchList=[],this._dirtyGroups=[]}function bt(t,e){if(t&&!e||!t&&e)return!1;if((t=t.data)===(e=e.data))return!0;if(t instanceof Float32Array&&e instanceof Float32Array){if(t.length!==e.length)return!1;for(var i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}return!1}function xt(t,e){for(var i in t)if(t.hasOwnProperty(i)&&!bt(t[i],e[i]))return!1;for(i in e)if(e.hasOwnProperty(i)&&!bt(e[i],t[i]))return!1;return!0}function St(t,e){var i;for(i=0;i<t.length;i++)if(0>e.indexOf(t[i]))return!1;for(i=0;i<e.length;i++)if(0>t.indexOf(e[i]))return!1;return!0}function Tt(t){return(t=t.node.worldTransform).getX(Qa),t.getY(Ja),t.getZ(to),Qa.cross(Qa,Ja),0<=Qa.dot(to)?1:-1}function wt(){this._aspectRatio=16/9,this._aspectRatioMode=0,this._calculateTransform=this._calculateProjection=null,this._clearColor=new o(.75,.75,.75,1),this._clearColorBuffer=!0,this._clearDepth=1,this._clearDepthBuffer=!0,this._clearStencil=0,this._clearStencilBuffer=!0,this._cullingMask=4294967295,this._cullFaces=!0,this._farClip=1e3,this._flipFaces=!1,this._fov=45,this._horizontalFov=this._frustumCulling=!1,this._layers=[0,1,2,4,3],this._nearClip=.1,this._node=null,this._orthoHeight=10,this._projection=0,this._rect=new b(0,0,1,1),this._renderTarget=null,this._scissorRect=new b(0,0,1,1),this._vrDisplay=null,this._projMat=new x,this._projMatDirty=!0,this._projMatSkybox=new x,this._viewMat=new x,this._viewMatDirty=!0,this._viewProjMat=new x,this._viewProjMatDirty=!0,this.frustum=new M}function Mt(t){n.call(this),this.name="string"==typeof t?t:"Untitled",this.tags=new c(this),this._labels={},this.localPosition=new v(0,0,0),this.localRotation=new S(0,0,0,1),this.localScale=new v(1,1,1),this.localEulerAngles=new v(0,0,0),this.position=new v(0,0,0),this.rotation=new S(0,0,0,1),this.eulerAngles=new v(0,0,0),this._scale=null,this.localTransform=new x,this._dirtyLocal=!1,this._aabbVer=0,this._frozen=!1,this.worldTransform=new x,this._dirtyWorld=!1,this.normalMatrix=new g,this._dirtyNormal=!0,this._parent=this._forward=this._up=this._right=null,this._children=[],this._graphDepth=0,this._enabled=!0,this.scaleCompensation=this._enabledInHierarchy=!1}function Pt(t,e){return t.priority-e.priority}function At(t,e){return e.key-t.key}function Et(){this.list=[],this.length=0,this.done=!1}function Ct(){this.opaqueMeshInstances=[],this.transparentMeshInstances=[],this.shadowCasters=[],this.visibleOpaque=[],this.visibleTransparent=[]}function It(t){void 0!==(t=t||{}).id?(this.id=t.id,vo=Math.max(this.id+1,vo)):this.id=vo++,this.name=t.name,this._refCounter=(this._enabled=void 0===t.enabled||t.enabled)?1:0,this.opaqueSortMode=void 0===t.opaqueSortMode?2:t.opaqueSortMode,this.transparentSortMode=void 0===t.transparentSortMode?3:t.transparentSortMode,this.renderTarget=t.renderTarget,this.shaderPass=void 0===t.shaderPass?0:t.shaderPass,this.passThrough=void 0!==t.passThrough&&t.passThrough,this.overrideClear=void 0!==t.overrideClear&&t.overrideClear,this._clearColor=new o(0,0,0,1),t.clearColor&&this._clearColor.copy(t.clearColor),this._clearColorBuffer=void 0!==t.clearColorBuffer&&t.clearColorBuffer,this._clearDepthBuffer=void 0!==t.clearDepthBuffer&&t.clearDepthBuffer,this._clearStencilBuffer=void 0!==t.clearStencilBuffer&&t.clearStencilBuffer,this._clearOptions={color:[this._clearColor.r,this._clearColor.g,this._clearColor.b,this._clearColor.a],depth:1,stencil:0,flags:(this._clearColorBuffer?1:0)|(this._clearDepthBuffer?2:0)|(this._clearStencilBuffer?4:0)},this.onPreCull=t.onPreCull,this.onPreRender=t.onPreRender,this.onPreRenderOpaque=t.onPreRenderOpaque,this.onPreRenderTransparent=t.onPreRenderTransparent,this.onPostCull=t.onPostCull,this.onPostRender=t.onPostRender,this.onPostRenderOpaque=t.onPostRenderOpaque,this.onPostRenderTransparent=t.onPostRenderTransparent,this.onDrawCall=t.onDrawCall,this.onEnable=t.onEnable,this.onDisable=t.onDisable,this._enabled&&this.onEnable&&this.onEnable(),this.instances=(this.layerReference=t.layerReference)?t.layerReference.instances:new Ct,this.cullingMask=t.cullingMask?t.cullingMask:4294967295,this.opaqueMeshInstances=this.instances.opaqueMeshInstances,this.transparentMeshInstances=this.instances.transparentMeshInstances,this.shadowCasters=this.instances.shadowCasters,this.customCalculateSortValues=this.customSortCallback=null,this._lightComponents=[],this._lights=[],this._sortedLights=[[],[],[]],this.cameras=[],this._dirtyCameras=this._dirtyLights=this._dirty=!1,this._staticLightHash=this._lightHash=this._cameraHash=0,this._needsStaticPrepare=!0,this._staticPrepareDone=!1,this._shaderVersion=-1,this._version=0,this._lightCube=null}function Ot(t,e,i,s){var n=3===s?14:2===s?12:4===s||0===s&&t.webgl2?16:7,r=function(t,e){return 0!==e||t.webgl2?3===e?t.extTextureFloatLinear?1:0:2===e?t.extTextureHalfFloatLinear?1:0:1:0}(t,s);return(e=new nt(t,{format:n,width:e,height:i,mipmaps:!1,minFilter:r,magFilter:r,addressU:1,addressV:1})).name="shadowmap",4===s||0===s&&t.webgl2?(e.compareOnRead=!0,e.compareFunc=1,new gp({depthBuffer:e})):new gp({colorBuffer:e,depth:!0})}function Rt(t,e){(t=new nt(t,{format:7,width:e,height:e,cubemap:!0,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})).name="shadowcube",e=[];for(var i,s=0;6>s;s++)i=new gp({colorBuffer:t,face:s,depth:!0}),e.push(i);return e}function Dt(t,e,i,s){s||(s=0),s=1e4*s+e;var n=Ro[i][s];return n||(n=Ot(t,e,e,i||0),Ro[i][s]=n),n}function Lt(t,e){if(1===e._type){if(0<e._shadowType&&(e._shadowType=0),e._cacheShadowMap){var i=rh[e._shadowResolution];i||(i=Rt(t,e._shadowResolution),rh[e._shadowResolution]=i)}else i=Rt(t,e._shadowResolution);e._shadowCamera.renderTarget=i[0],e._shadowCubeMap=i}else i=e._cacheShadowMap?Dt(t,e._shadowResolution,e._shadowType):Ot(t,e._shadowResolution,e._shadowResolution,e._shadowType),e._shadowCamera.renderTarget=i;e._isCachedShadowMap=e._cacheShadowMap}function Ft(t){t=this.device=t,this._instancingTime=this._morphTime=this._skinTime=this._sortTime=this._cullTime=this._forwardTime=this._depthMapTime=this._shadowMapTime=this._shadowMapUpdates=this._materialSwitches=this._camerasRendered=this._skinDrawCalls=this._forwardDrawCalls=this._shadowDrawCalls=0,this.library=t.getProgramLibrary(),t=t.scope,this.projId=t.resolve("matrix_projection"),this.projSkyboxId=t.resolve("matrix_projectionSkybox"),this.viewId=t.resolve("matrix_view"),this.viewId3=t.resolve("matrix_view3"),this.viewInvId=t.resolve("matrix_viewInverse"),this.viewProjId=t.resolve("matrix_viewProjection"),this.viewPos=new Float32Array(3),this.viewPosId=t.resolve("view_position"),this.nearClipId=t.resolve("camera_near"),this.farClipId=t.resolve("camera_far"),this.cameraParamsId=t.resolve("camera_params"),this.shadowMapLightRadiusId=t.resolve("light_radius"),this.fogColorId=t.resolve("fog_color"),this.fogStartId=t.resolve("fog_start"),this.fogEndId=t.resolve("fog_end"),this.fogDensityId=t.resolve("fog_density"),this.modelMatrixId=t.resolve("matrix_model"),this.normalMatrixId=t.resolve("matrix_normal"),this.poseMatrixId=t.resolve("matrix_pose[0]"),this.boneTextureId=t.resolve("texture_poseMap"),this.boneTextureSizeId=t.resolve("texture_poseMapSize"),this.morphWeightsA=t.resolve("morph_weights_a"),this.morphWeightsB=t.resolve("morph_weights_b"),this.morphPositionTex=t.resolve("morphPositionTex"),this.morphNormalTex=t.resolve("morphNormalTex"),this.morphTexParams=t.resolve("morph_tex_params"),this.alphaTestId=t.resolve("alpha_ref"),this.opacityMapId=t.resolve("texture_opacityMap"),this.ambientId=t.resolve("light_globalAmbient"),this.exposureId=t.resolve("exposure"),this.skyboxIntensityId=t.resolve("skyboxIntensity"),this.lightColorId=[],this.lightDir=[],this.lightDirId=[],this.lightShadowMapId=[],this.lightShadowMatrixId=[],this.lightShadowParamsId=[],this.lightShadowMatrixVsId=[],this.lightShadowParamsVsId=[],this.lightDirVs=[],this.lightDirVsId=[],this.lightRadiusId=[],this.lightPos=[],this.lightPosId=[],this.lightInAngleId=[],this.lightOutAngleId=[],this.lightPosVsId=[],this.lightCookieId=[],this.lightCookieIntId=[],this.lightCookieMatrixId=[],this.lightCookieOffsetId=[],this.depthMapId=t.resolve("uDepthMap"),this.screenSizeId=t.resolve("uScreenSize"),this._screenSize=new Float32Array(4),this.sourceId=t.resolve("source"),this.pixelOffsetId=t.resolve("pixelOffset"),this.weightId=t.resolve("weight[0]"),this.blurVsmShaderCode=[Ra.blurVSMPS,"#define GAUSS\n"+Ra.blurVSMPS],this.blurPackedVsmShaderCode=["#define PACKED\n"+this.blurVsmShaderCode[0],"#define PACKED\n"+this.blurVsmShaderCode[1]],this.blurVsmShader=[{},{}],this.blurPackedVsmShader=[{},{}],this.blurVsmWeights={},this.polygonOffsetId=t.resolve("polygonOffset"),this.polygonOffset=new Float32Array(2),this.fogColor=new Float32Array(3),this.ambientColor=new Float32Array(3),this.cameraParams=new Float32Array(4)}function Bt(t,e){t.data[0]=e.data[0],t.data[1]=e.data[1],t.data[2]=e.data[2],t.data[3]=e.data[4],t.data[4]=e.data[5],t.data[5]=e.data[6],t.data[6]=e.data[8],t.data[7]=e.data[9],t.data[8]=e.data[10]}function Nt(){nr.call(this),this.color=new o(1,1,1,1),this.colorUniform=new Float32Array(4),this.colorMap=null,this.vertexColors=!1}function kt(t){this.lineVertexFormat=new O(t,[{semantic:"POSITION",components:3,type:6},{semantic:"COLOR",components:4,type:1,normalize:!0}]),this.lineBatches=[],this.layers=[],this.layerToBatch={},this.cubeWorldPos=this.cubeLocalPos=this.quadMesh=null,this.identityGraphNode=new Mt}function zt(){this.numLinesAllocated=128,this.mesh=this.vbRam=this.vb=null,this.linesUsed=0,this.layer=this.meshInstance=this.material=null}function Ut(){n.call(this),this.layerList=[],this.subLayerList=[],this.subLayerEnabled=[],this._opaqueOrder={},this._transparentOrder={},this._dirtyCameras=this._dirtyLights=this._dirtyBlend=this._dirty=!1,this._meshInstances=[],this._lights=[],this.cameras=[],this._sortedLights=[[],[],[]],this._lightShadowCasters=[],this._globalLightCameras=[],this._globalLightCameraIds=[],this._renderedRt=[],this._renderedByCam=[],this._renderedLayer=[],this._renderList=[],this._renderListCamera=[]}function Vt(t,e,i,s){if(t.enabled){var n;if(t.model&&t.model.model&&t.model.enabled&&(s&&s.push(t),t.model.lightmapped&&e)){var r=!0,a=t.model.model.meshInstances;for(n=0;n<a.length;n++)if(!a[n].mesh.vertexBuffer.format.hasUv1){r=!1;break}if(r){var o=[];for(n=0;n<a.length;n++){var h=!1;for(r=0;r<a.length;r++)n!==r&&a[n].mesh===a[r].mesh&&(h=!0);h?(e.push(t),i.push([a[n]])):o.push(a[n])}0<o.length&&(e.push(t),i.push(o))}}for(n=0;n<t._children.length;n++)Vt(t._children[n],e,i,s)}}function jt(t,e,i,s,n){this.device=t,this.root=e,this.scene=i,this.renderer=s,this.assets=n}function Gt(t){return t-Math.floor(t)}function Ht(t,e){return t-e*Math.floor(t/e)}function Wt(t){return[Gt(t)-(t=Gt(255*t))/255,t-t/255]}function Xt(t){this._emitter=t}function qt(t,e){e.data[0]=t.data[0],e.data[1]=t.data[1],e.data[2]=t.data[2],e.data[3]=t.data[4],e.data[4]=t.data[5],e.data[5]=t.data[6],e.data[6]=t.data[8],e.data[7]=t.data[9],e.data[8]=t.data[10]}function Yt(t,e){this._emitter=t,this.frameRandomUniform=new Float32Array(3),this.emitterPosUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),this.worldBoundsMulUniform=new Float32Array(3),this.worldBoundsAddUniform=new Float32Array(3),this.inBoundsSizeUniform=new Float32Array(3),this.inBoundsCenterUniform=new Float32Array(3),this.constantParticleTexIN=e.scope.resolve("particleTexIN"),this.constantParticleTexOUT=e.scope.resolve("particleTexOUT"),this.constantEmitterPos=e.scope.resolve("emitterPos"),this.constantEmitterScale=e.scope.resolve("emitterScale"),this.constantSpawnBounds=e.scope.resolve("spawnBounds"),this.constantSpawnPosInnerRatio=e.scope.resolve("spawnPosInnerRatio"),this.constantSpawnBoundsSphere=e.scope.resolve("spawnBoundsSphere"),this.constantSpawnBoundsSphereInnerRatio=e.scope.resolve("spawnBoundsSphereInnerRatio"),this.constantInitialVelocity=e.scope.resolve("initialVelocity"),this.constantFrameRandom=e.scope.resolve("frameRandom"),this.constantDelta=e.scope.resolve("delta"),this.constantRate=e.scope.resolve("rate"),this.constantRateDiv=e.scope.resolve("rateDiv"),this.constantLifetime=e.scope.resolve("lifetime"),this.constantGraphSampleSize=e.scope.resolve("graphSampleSize"),this.constantGraphNumSamples=e.scope.resolve("graphNumSamples"),this.constantInternalTex0=e.scope.resolve("internalTex0"),this.constantInternalTex1=e.scope.resolve("internalTex1"),this.constantInternalTex2=e.scope.resolve("internalTex2"),this.constantInternalTex3=e.scope.resolve("internalTex3"),this.constantEmitterMatrix=e.scope.resolve("emitterMatrix"),this.constantEmitterMatrixInv=e.scope.resolve("emitterMatrixInv"),this.constantNumParticles=e.scope.resolve("numParticles"),this.constantNumParticlesPot=e.scope.resolve("numParticlesPot"),this.constantLocalVelocityDivMult=e.scope.resolve("localVelocityDivMult"),this.constantVelocityDivMult=e.scope.resolve("velocityDivMult"),this.constantRotSpeedDivMult=e.scope.resolve("rotSpeedDivMult"),this.constantSeed=e.scope.resolve("seed"),this.constantStartAngle=e.scope.resolve("startAngle"),this.constantStartAngle2=e.scope.resolve("startAngle2"),this.constantOutBoundsMul=e.scope.resolve("outBoundsMul"),this.constantOutBoundsAdd=e.scope.resolve("outBoundsAdd"),this.constantInBoundsSize=e.scope.resolve("inBoundsSize"),this.constantInBoundsCenter=e.scope.resolve("inBoundsCenter"),this.constantMaxVel=e.scope.resolve("maxVel"),this.constantFaceTangent=e.scope.resolve("faceTangent"),this.constantFaceBinorm=e.scope.resolve("faceBinorm")}function Kt(t,e){Uh[t]=void 0!==Vh[t]&&null!==Vh[t]?Vh[t]:e}function $t(t,e){for(var i=t.length/3,s=Array(4*i),n=0;n<i;n++)s[4*n]=t[3*n],s[4*n+1]=t[3*n+1],s[4*n+2]=t[3*n+2],s[4*n+3]=(255*e[3*n]<<16|255*e[3*n+1]<<8|255*e[3*n+2])/16777216;return s}function Zt(t,e){var i,s,n=e.length,r=t.length/n;for(i=0;i<r;i++)for(s=0;s<n;s++)e[s]=Math.max(e[s],Math.abs(t[i*n+s]))}function Qt(t,e,i){for(var s=new Float32Array(e.length),n=0;n<e.length;n++)s[n]=e[n]-t[n];Zt(s,i),t=i.length;var r=s.length/t;for(e=0;e<r;e++)for(n=0;n<t;n++)s[e*t+n]/=0===i[n]?1:i[n],s[e*t+n]*=.5,s[e*t+n]+=.5;return s}function Jt(t,e){var i,s=e.length/3,n=t.length/3,r=new v,a=new v,o=new v,h=new v,l=new v,c=new v,d=[];for(i=0;i<t.length;i++)d[i]=0;for(i=0;i<s;i++){var u=e[3*i],p=e[3*i+1],f=e[3*i+2];r.set(t[3*u],t[3*u+1],t[3*u+2]),a.set(t[3*p],t[3*p+1],t[3*p+2]),o.set(t[3*f],t[3*f+1],t[3*f+2]),h.sub2(a,r),l.sub2(o,r),c.cross(h,l).normalize(),d[3*u]+=c.x,d[3*u+1]+=c.y,d[3*u+2]+=c.z,d[3*p]+=c.x,d[3*p+1]+=c.y,d[3*p+2]+=c.z,d[3*f]+=c.x,d[3*f+1]+=c.y,d[3*f+2]+=c.z}for(i=0;i<n;i++)t=d[3*i],e=d[3*i+1],s=d[3*i+2],t=1/Math.sqrt(t*t+e*e+s*s),d[3*i]*=t,d[3*i+1]*=t,d[3*i+2]*=t;return d}function te(t,e,i,s){var n,r=s.length/3,a=t.length/3,o=new v,h=new v,l=new v,c=new v,d=new v,u=new y,p=new y,f=new y,m=new Float32Array(3*a),_=new Float32Array(3*a),g=[];for(n=0;n<r;n++){var b=s[3*n],x=s[3*n+1],S=s[3*n+2];l.set(t[3*b],t[3*b+1],t[3*b+2]),c.set(t[3*x],t[3*x+1],t[3*x+2]),d.set(t[3*S],t[3*S+1],t[3*S+2]),u.set(i[2*b],i[2*b+1]),p.set(i[2*x],i[2*x+1]),f.set(i[2*S],i[2*S+1]);var T=c.x-l.x,w=d.x-l.x,M=c.y-l.y,P=d.y-l.y,A=c.z-l.z,E=d.z-l.z,C=p.x-u.x,I=f.x-u.x,O=p.y-u.y,R=f.y-u.y,D=C*R-I*O;0==D?(o.set(0,1,0),h.set(1,0,0)):(D=1/D,o.set((R*T-O*w)*D,(R*M-O*P)*D,(R*A-O*E)*D),h.set((C*w-I*T)*D,(C*P-I*M)*D,(C*E-I*A)*D)),m[3*b]+=o.x,m[3*b+1]+=o.y,m[3*b+2]+=o.z,m[3*x]+=o.x,m[3*x+1]+=o.y,m[3*x+2]+=o.z,m[3*S]+=o.x,m[3*S+1]+=o.y,m[3*S+2]+=o.z,_[3*b]+=h.x,_[3*b+1]+=h.y,_[3*b+2]+=h.z,_[3*x]+=h.x,_[3*x+1]+=h.y,_[3*x+2]+=h.z,_[3*S]+=h.x,_[3*S+1]+=h.y,_[3*S+2]+=h.z}for(O=new v,R=new v,t=new v,i=new v,n=0;n<a;n++)t.set(e[3*n],e[3*n+1],e[3*n+2]),O.set(m[3*n],m[3*n+1],m[3*n+2]),R.set(_[3*n],_[3*n+1],_[3*n+2]),s=t.dot(O),i.copy(t).scale(s),i.sub2(O,i).normalize(),g[4*n]=i.x,g[4*n+1]=i.y,g[4*n+2]=i.z,i.cross(t,O),g[4*n+3]=0>i.dot(R)?-1:1;return g}function ee(t,e,i){var s=i&&void 0!==i.normals?i.normals:null,n=i&&void 0!==i.tangents?i.tangents:null,r=i&&void 0!==i.colors?i.colors:null,a=i&&void 0!==i.uvs?i.uvs:null,o=i&&void 0!==i.uvs1?i.uvs1:null,h=i&&void 0!==i.indices?i.indices:null,l=i&&void 0!==i.blendIndices?i.blendIndices:null,c=i&&void 0!==i.blendWeights?i.blendWeights:null;i=[{semantic:"POSITION",components:3,type:6}],null!==s&&i.push({semantic:"NORMAL",components:3,type:6}),null!==n&&i.push({semantic:"TANGENT",components:4,type:6}),null!==r&&i.push({semantic:"COLOR",components:4,type:1,normalize:!0}),null!==a&&i.push({semantic:"TEXCOORD0",components:2,type:6}),null!==o&&i.push({semantic:"TEXCOORD1",components:2,type:6}),null!==l&&i.push({semantic:"BLENDINDICES",components:2,type:1}),null!==c&&i.push({semantic:"BLENDWEIGHT",components:2,type:6});for(var d=new O(t,i),u=new W(d=new C(t,d,i=e.length/3)),p=0;p<i;p++)u.element.POSITION.set(e[3*p],e[3*p+1],e[3*p+2]),null!==s&&u.element.NORMAL.set(s[3*p],s[3*p+1],s[3*p+2]),null!==n&&u.element.TANGENT.set(n[4*p],n[4*p+1],n[4*p+2],n[4*p+3]),null!==r&&u.element.COLOR.set(r[4*p],r[4*p+1],r[4*p+2],r[4*p+3]),null!==a&&u.element.TEXCOORD0.set(a[2*p],a[2*p+1]),null!==o&&u.element.TEXCOORD1.set(o[2*p],o[2*p+1]),null!==l&&u.element.BLENDINDICES.set(l[2*p],l[2*p+1]),null!==c&&u.element.BLENDWEIGHT.set(c[2*p],c[2*p+1]),u.next();return u.end(),s=null,(n=null!==h)&&(s=new rt(t,1,h.length),new Uint16Array(s.lock()).set(h),s.unlock()),(r=new T).compute(e),(t=new ht(t)).vertexBuffer=d,t.indexBuffer[0]=s,t.primitive[0].type=4,t.primitive[0].base=0,t.primitive[0].count=n?h.length:i,t.primitive[0].indexed=n,t.aabb=r,t}function ie(t,e){var i=e&&void 0!==e.tubeRadius?e.tubeRadius:.2,s=e&&void 0!==e.ringRadius?e.ringRadius:.3,n=e&&void 0!==e.segments?e.segments:30,r=e&&void 0!==e.sides?e.sides:20;e=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;var a,o,h=[],l=[],c=[],d=[];for(a=0;a<=r;a++)for(o=0;o<=n;o++){var u=Math.cos(2*Math.PI*o/n)*(s+i*Math.cos(2*Math.PI*a/r)),p=Math.sin(2*Math.PI*a/r)*i,f=Math.sin(2*Math.PI*o/n)*(s+i*Math.cos(2*Math.PI*a/r)),m=Math.cos(2*Math.PI*o/n)*Math.cos(2*Math.PI*a/r),_=Math.sin(2*Math.PI*a/r),g=Math.sin(2*Math.PI*o/n)*Math.cos(2*Math.PI*a/r),y=a/r,v=1-o/n;h.push(u,p,f),l.push(m,_,g),c.push(y,v),a<r&&o<n&&(u=a*(n+1)+o,p=(a+1)*(n+1)+o,f=a*(n+1)+(o+1),m=(a+1)*(n+1)+(o+1),d.push(u,p,f),d.push(p,m,f))}return i={normals:l,uvs:c,indices:d},e&&(i.tangents=e(h,l,c,d)),ee(t,h,i)}function se(t,e,i,s,n,r){var a,o,h=new v,l=new v,c=new v,d=[],u=[],p=[],f=[],m=[];if(0<i)for(a=0;a<=s;a++)for(o=0;o<=n;o++){var _=o/n*2*Math.PI-Math.PI,g=Math.sin(_),y=new v(g*t,-i/2,(_=Math.cos(_))*t),b=new v(g*e,i/2,_*e);h.lerp(y,b,a/s),l.sub2(b,y).normalize(),g=new v(_,0,-g),c.cross(g,l).normalize(),d.push(h.x,h.y,h.z),u.push(c.x,c.y,c.z),b=o/n,y=a/s,p.push(b,y),g=y,y=b,b=g,b=.875*(b/=3)+.0625,y=.875*y+.0625,f.push(b,y),a<s&&o<n&&(g=a*(n+1)+o,_=a*(n+1)+(o+1),b=(a+1)*(n+1)+o,y=(a+1)*(n+1)+(o+1),m.push(g,_,b),m.push(_,y,b))}if(r){for(t=Math.floor(n/2),a=i/2,i=0;i<=t;i++)for(_=i*Math.PI*.5/t,g=Math.sin(_),_=Math.cos(_),h=0;h<=n;h++)r=2*h*Math.PI/n-Math.PI/2,b=Math.sin(r),r=Math.cos(r),r*=g,o=_,c=b*g,b=1-h/n,y=1-i/t,d.push(r*e,o*e+a,c*e),u.push(r,o,c),p.push(b,y),b=.875*(b/=3)+.0625,y=.875*(y/=3)+.0625,b+=1/3,f.push(b,y);for(l=(s+1)*(n+1),i=0;i<t;++i)for(h=0;h<n;++h)_=(g=i*(n+1)+h)+n+1,m.push(l+g+1,l+_,l+g),m.push(l+g+1,l+_+1,l+_);for(i=0;i<=t;i++)for(_=.5*Math.PI+i*Math.PI*.5/t,g=Math.sin(_),_=Math.cos(_),h=0;h<=n;h++)r=2*h*Math.PI/n-Math.PI/2,b=Math.sin(r),r=Math.cos(r),r*=g,o=_,c=b*g,b=1-h/n,y=1-i/t,d.push(r*e,o*e-a,c*e),u.push(r,o,c),p.push(b,y),b=.875*(b/=3)+.0625,y=.875*(y/=3)+.0625,b+=2/3,f.push(b,y);for(l=(s+1)*(n+1)+(n+1)*(t+1),i=0;i<t;++i)for(h=0;h<n;++h)_=(g=i*(n+1)+h)+n+1,m.push(l+g+1,l+_,l+g),m.push(l+g+1,l+_+1,l+_)}else{if(l=(s+1)*(n+1),0<t)for(a=0;a<n;a++)_=a/n*2*Math.PI,o=-i/2,b=1-((r=Math.sin(_))+1)/2,y=((c=Math.cos(_))+1)/2,d.push(r*t,o,c*t),u.push(0,-1,0),p.push(b,y),b=.875*(b/=3)+.0625,y=.875*(y/=3)+.0625,b+=1/3,f.push(b,y),1<a&&m.push(l,l+a,l+a-1);if(l+=n,0<e)for(a=0;a<n;a++)_=a/n*2*Math.PI,o=i/2,b=1-((r=Math.sin(_))+1)/2,y=((c=Math.cos(_))+1)/2,d.push(r*e,o,c*e),u.push(0,1,0),p.push(b,y),b=.875*(b/=3)+.0625,y=.875*(y/=3)+.0625,b+=2/3,f.push(b,y),1<a&&m.push(l,l+a-1,l+a)}return{positions:d,normals:u,uvs:p,uvs1:f,indices:m}}function ne(t,e){var i=e&&(e.radius||e.baseRadius);i=void 0!==i?i:.5;var s=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;return e=se(i,i,e&&void 0!==e.height?e.height:1,e&&void 0!==e.heightSegments?e.heightSegments:5,e&&void 0!==e.capSegments?e.capSegments:20,!1),s&&(e.tangents=s(e.positions,e.normals,e.uvs,e.indices)),ee(t,e.positions,e)}function re(t,e){var i=e&&void 0!==e.radius?e.radius:.3,s=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;return e=se(i,i,(e&&void 0!==e.height?e.height:1)-2*i,e&&void 0!==e.heightSegments?e.heightSegments:1,e&&void 0!==e.sides?e.sides:20,!0),s&&(e.tangents=s(e.positions,e.normals,e.uvs,e.indices)),ee(t,e.positions,e)}function ae(t,e){var i=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;return e=se(e&&void 0!==e.baseRadius?e.baseRadius:.5,e&&void 0!==e.peakRadius?e.peakRadius:0,e&&void 0!==e.height?e.height:1,e&&void 0!==e.heightSegments?e.heightSegments:5,e&&void 0!==e.capSegments?e.capSegments:18,!1),i&&(e.tangents=i(e.positions,e.normals,e.uvs,e.indices)),ee(t,e.positions,e)}function oe(t,e){var i=e&&void 0!==e.radius?e.radius:.5,s=e&&void 0!==e.latitudeBands?e.latitudeBands:16,n=e&&void 0!==e.longitudeBands?e.longitudeBands:16;e=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;var r,a=[],o=[],h=[],l=[];for(r=0;r<=s;r++){var c=r*Math.PI/s,d=Math.sin(c),u=Math.cos(c);for(c=0;c<=n;c++){var p=2*c*Math.PI/n-Math.PI/2,f=Math.sin(p);p=Math.cos(p),p*=d;var m=u;f*=d;var _=1-c/n,g=1-r/s;a.push(p*i,m*i,f*i),o.push(p,m,f),h.push(_,g)}}for(r=0;r<s;++r)for(c=0;c<n;++c)d=(i=r*(n+1)+c)+n+1,l.push(i+1,d,i),l.push(i+1,d+1,d);return s={normals:o,uvs:h,uvs1:h,indices:l},e&&(s.tangents=e(a,o,h,l)),ee(t,a,s)}function he(t,e){var i=e&&void 0!==e.halfExtents?e.halfExtents:new y(.5,.5),s=e&&void 0!==e.widthSegments?e.widthSegments:5,n=e&&void 0!==e.lengthSegments?e.lengthSegments:5;e=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;var r,a,o=[],h=[],l=[],c=[],d=0;for(r=0;r<=s;r++)for(a=0;a<=n;a++){var u=-i.x+2*i.x*r/s,p=-(-i.y+2*i.y*a/n),f=r/s,m=a/n;o.push(u,0,p),h.push(0,1,0),l.push(f,m),r<s&&a<n&&(c.push(d+n+1,d+1,d),c.push(d+n+1,d+n+2,d+1)),d++}return i={normals:h,uvs:l,uvs1:l,indices:c},e&&(i.tangents=e(o,h,l,c)),ee(t,o,i)}function le(t,e){var i=e&&void 0!==e.halfExtents?e.halfExtents:new v(.5,.5,.5),s=e&&void 0!==e.widthSegments?e.widthSegments:1,n=e&&void 0!==e.lengthSegments?e.lengthSegments:1,r=e&&void 0!==e.heightSegments?e.heightSegments:1;e=!(!e||void 0===e.calculateTangents)&&e.calculateTangents;var a=[new v(-i.x,-i.y,i.z),new v(i.x,-i.y,i.z),new v(i.x,i.y,i.z),new v(-i.x,i.y,i.z),new v(i.x,-i.y,-i.z),new v(-i.x,-i.y,-i.z),new v(-i.x,i.y,-i.z),new v(i.x,i.y,-i.z)],o=[[0,1,3],[4,5,7],[3,2,6],[1,0,4],[1,4,2],[5,0,6]],h=[[0,0,1],[0,0,-1],[0,1,0],[0,-1,0],[1,0,0],[-1,0,0]],l=[],c=[],d=[],u=[],p=[],f=0;return(i=function(t,e,i){var s,n;for(s=0;s<=e;s++)for(n=0;n<=i;n++){var r=new v,m=new v,_=new v,g=new v;r.lerp(a[o[t][0]],a[o[t][1]],s/e),m.lerp(a[o[t][0]],a[o[t][2]],n/i),_.sub2(m,a[o[t][0]]),g.add2(r,_),r=s/e,m=n/i,l.push(g.x,g.y,g.z),c.push(h[t][0],h[t][1],h[t][2]),d.push(r,m),r=.875*(r/=3)+.0625,m=.875*(m/=3)+.0625,r+=t%3/3,m+=Math.floor(t/3)/3,u.push(r,m),s<e&&n<i&&(p.push(f+i+1,f+1,f),p.push(f+i+1,f+i+2,f+1)),f++}})(0,s,r),i(1,s,r),i(2,s,n),i(3,s,n),i(4,n,r),i(5,n,r),s={normals:c,uvs:d,uvs1:u,indices:p},e&&(s.tangents=e(l,c,d,p)),ee(t,l,s)}function ce(){n.call(this),this.root=null,this._gravity=new v(0,-9.8,0),this._layers=null,this._fog="none",this.fogColor=new o(0,0,0),this.fogStart=1,this.fogEnd=1e3,this.fogDensity=0,this.ambientLight=new o(0,0,0),this._toneMapping=this._gammaCorrection=0,this.exposure=1,this._skyboxPrefiltered=[null,null,null,null,null,null],this._firstUpdateSkybox=!0,this.skyboxModel=this._skyboxCubeMap=null,this._skyboxIntensity=1,this._skyboxMip=0,this.lightmapSizeMultiplier=1,this.lightmapMaxResolution=2048,this.lightmapMode=1,this._stats={meshInstances:0,lights:0,dynamicLights:0,bakedLights:0,lastStaticPrepareFullTime:0,lastStaticPrepareSearchTime:0,lastStaticPrepareWriteTime:0,lastStaticPrepareTriAabbTime:0,lastStaticPrepareCombineTime:0,updateShadersTime:0},this.updateSkybox=this.updateShaders=!0,this._shaderVersion=0,this._statsUpdated=!1,this._models=[],this.defaultMaterial=new ar,this.defaultMaterial.name="Default Material",this.defaultMaterial.shadingModel=1}function de(){return"undefined"!=typeof Audio}function ue(){return!("undefined"==typeof AudioContext&&"undefined"==typeof webkitAudioContext)}function pe(t){this.position=new v,this.velocity=new v,this.orientation=new x,ue()&&(this.listener=t.context.listener)}function fe(t){if(n.call(this),ue()||t.forceWebAudioApi){if("undefined"!=typeof AudioContext?this.context=new AudioContext:"undefined"!=typeof webkitAudioContext&&(this.context=new webkitAudioContext),this.context){var e=this.context;if(this.resumeContext=function(){this.context.resume(),window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext)}.bind(this),window.addEventListener("mousedown",this.resumeContext),window.addEventListener("touchend",this.resumeContext),sa.ios){var i=function(){var t=e.createBuffer(1,1,44100),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start(0),s.disconnect(),window.removeEventListener("touchend",i)};window.addEventListener("touchend",i)}}}else console.warn("No support for 3D audio found");de()||console.warn("No support for 2D audio found"),this.listener=new pe(this),this._volume=1,this.suspended=!1}function me(t,e,i,s){this.time=t,this.position=e,this.rotation=i,this.scale=s}function _e(){this._name="",this._keys=[]}function ge(){this.name="",this.duration=0,this._nodes=[],this._nodeDict={}}function ye(t){2===arguments.length&&(t=arguments[1]),this.options=t,this.name=t.name,this.defaultWeight=t.defaultWeight||0,this.aabb=t.aabb,this.aabb||(this.aabb=new T,t.deltaPositions&&this.aabb.compute(t.deltaPositions)),this.deltaPositions=t.deltaPositions}function ve(t,e,i){this.device=t,this.inverseBindPose=e,this.boneNames=i}function be(){}function xe(t,e){if(Mt.call(this,t),t instanceof sr&&(e=t),this._batchHandle=null,this.c={},this._app=e,!e&&(this._app=sr.getApplication(),!this._app))throw Error("Couldn't find current application");this._guid=null,this._template=this._destroying=!1}function Se(t,e){this._components=t,this._data=e}function Te(){this._left=1/0,this._right=-1/0,this._t=this._p1=this._p0=this._recip=this._len=0,this._hermite={valid:!1,p0:0,m0:0,p1:0,m1:0}}function we(t,e,i,s){this._paths=t,this._input=e,this._output=i,this._interpolation=s}function Me(t,e,i,s,n){this._name=t,this._duration=e,this._inputs=i,this._outputs=s,this._curves=n}function Pe(t){var e;for(this._name=t.name+"Snapshot",this._time=-1,this._cache=[],this._results=[],e=0;e<t._inputs.length;++e)this._cache[e]=new Te;var i=t._curves;for(t=t._outputs,e=0;e<i.length;++e){for(var s=t[i[e]._output],n=[],r=0;r<s._components;++r)n[r]=0;this._results[e]=n}}function Ae(t,e,i,s,n){this._name=t.name,this._track=t,this._snapshot=new Pe(t),this._playing=s,this._time=e,this._speed=i,this._loop=n,this._blendWeight=1,this._blendOrder=0}function Ee(t,e,i){this._func=t,this._type=e,this._components=i}function Ce(){}function Ie(t){var e={},i=function(t){e[t.name]={node:t,count:0};for(var s=0;s<t.children.length;++s)i(t.children[s])};i(t),this.nodes=e,this.activeNodes=[],this.handlers={localPosition:function(t){var e=t.localPosition;return new Ee(function(t){e.set.apply(e,t)},"vector",3)},localRotation:function(t){var e=t.localRotation;return new Ee(function(t){e.set.apply(e,t)},"quaternion",4)},localScale:function(t){var e=t.localScale;return new Ee(function(t){e.set.apply(e,t)},"vector",3)},weights:function(t){for(var e=t;e&&e.constructor!==xe;)e=e.parent;if(!(e&&e.model&&e.model.model&&e.model.model.morphInstances))return null;e=e.model.meshInstances;for(var i,s=0;s<e.length;++s)if(e[s].node.name===t.name){i=e[s].morphInstance;break}return i?new Ee(function(t){for(var e=0;e<t.length;++e)i.setWeight(e,t[e])},"vector",i.morph._targets.length):null},materialTexture:function(t,e){for(var i=t;i&&i.constructor!==xe;)i=i.parent;if(!i||!i.model||!i.model.model)return null;i=i.model.meshInstances;for(var s,n=0;n<i.length;++n)if(i[n].node.name===t.name){s=i[n];break}return s?new Ee(t=function(t){(t=this.animComponent.system.app.assets.get(t[0]))&&t.resource&&"texture"===t.type&&(s.material[e]=t.resource,s.material.update())}.bind(this),"vector",1):null}.bind(this)},this.propertyLocator=new be}function Oe(t){this._binder=t,this._clips=[],this._inputs=[],this._outputs=[],this._targets={}}function Re(){}function De(t){n.call(this),this.locale=hl,this._translations={},this._availableLangs={},this._app=t,this._assets=[],this._parser=new Re}function Le(t){this.asset=t}function Fe(t,e,i,s,r){n.call(this),this._id=fl--,this.name=t||"",this.type=e,this.tags=new c(this),this._preload=!1,this.variants=new Le(this),this._file=null,this._data=s||{},this.options=r||{},this._resources=[],this._i18n={},this.loading=this.loaded=!1,this.registry=null,i&&(this.file=i)}function Be(){}function Ne(){this.retryRequests=!1}function ke(){this.retryRequests=!1}function ze(t){var e;if(this._layers=[],this._parameters={},Array.isArray(t.layers))this._layers=t.layers;else for(var i in t.layers){var s=t.layers[i],n={name:s.name,states:[],transitions:[]};for(e=0;e<s.states.length;e++)n.states.push(t.states[s.states[e]]);for(e=0;e<s.transitions.length;e++){var r=t.transitions[s.transitions[e]];if(r.conditions&&!Array.isArray(r.conditions)){for(var a=Object.keys(r.conditions),o=[],h=0;h<a.length;h++){var l=r.conditions[a[h]];l.parameterName&&o.push(l)}r.conditions=o}Number.isInteger(r.from)&&(r.from=t.states[r.from].name),Number.isInteger(r.to)&&(r.to=t.states[r.to].name),n.transitions.push(r)}this._layers.push(n)}for(var c in t.parameters)e=t.parameters[c],this._parameters[e.name]={type:e.type,value:e.value}}function Ue(){this.retryRequests=!1}function Ve(t){t instanceof Audio?this.audio=t:this.buffer=t}function je(t){this.manager=t,this.retryRequests=!1}function Ge(){this.retryRequests=!1}function He(t){this._blobUrls={};for(var e=0,i=t.length;e<i;e++)t[e].url&&(this._blobUrls[t[e].name]=t[e].url)}function We(t){function e(t){this._fields=t}function i(t){this._arrayBuffer=t||new ArrayBuffer(0),this._bufferView=new DataView(this._arrayBuffer),this._paxHeader=this._globalPaxHeader=null,this._bytesRead=0}if("undefined"!=typeof TextDecoder)var s=new TextDecoder("utf-8"),n=new TextDecoder("windows-1252");else console.warn("TextDecoder not supported - pc.Untar module will not work");e.parse=function(t,i,n){for(var r=new Uint8Array(t,i,n),a=0,o=[];a<n;){var h;for(h=a;h<n&&32!=r[h];h++);if(h>=n)throw Error("Invalid PAX header data format.");var l=parseInt(s.decode(new Uint8Array(t,i+a,h-a)),10);if(2!==(h=s.decode(new Uint8Array(t,i+h+1,l-(h-a)-2)).split("=")).length)throw Error("Invalid PAX header data format.");0===h[1].length&&(h[1]=null),o.push({name:h[0],value:h[1]}),a+=l}return new e(o)},e.prototype.applyHeader=function(t){for(var e=0;e<this._fields.length;e++){var i=this._fields[e].name,s=this._fields[e].value;"path"===i&&(i="name"),null===s?delete t[i]:t[i]=s}},t||(Bl=i),i.prototype._hasNext=function(){return this._bytesRead+4<this._arrayBuffer.byteLength&&0!==this._bufferView.getUint32(this._bytesRead)},i.prototype._readNextFile=function(){var i=new DataView(this._arrayBuffer,this._bytesRead,512),s=n.decode(i);this._bytesRead+=512,i=s.substr(0,100).replace(/\0/g,"");var r=s.substr(257,6),a=parseInt(s.substr(124,12),8),o=s.substr(156,1),h=this._bytesRead,l=null,c=!1;switch(o){case"0":case"":c=!0,t||(l=new Blob([this._arrayBuffer.slice(this._bytesRead,this._bytesRead+a)]),l=URL.createObjectURL(l));break;case"g":this._globalPaxHeader=e.parse(this._arrayBuffer,this._bytesRead,a);break;case"x":this._paxHeader=e.parse(this._arrayBuffer,this._bytesRead,a)}return this._bytesRead+=a,0!==(o=a%512)&&(this._bytesRead+=512-o),c?(-1!==r.indexOf("ustar")&&(0<(s=s.substr(345,155).replace(/\0/g,"")).length&&(i=s.trim()+i.trim())),i={name:i,start:h,size:a,url:l},this._globalPaxHeader&&this._globalPaxHeader.applyHeader(i),this._paxHeader&&(this._paxHeader.applyHeader(i),this._paxHeader=null),i):null},i.prototype.untar=function(t){if(!s)return console.error("Cannot untar because TextDecoder interface is not available for this platform."),[];for(var e=[];this._hasNext();){var i=this._readNextFile();i&&(t&&i.name&&(i.name=t+i.name),e.push(i))}return e},t&&(self.onmessage=function(t){var e=t.data.id;try{var s=new i(t.data.arrayBuffer).untar(t.data.prefix);postMessage({id:e,files:s,arrayBuffer:t.data.arrayBuffer},[t.data.arrayBuffer])}catch(t){postMessage({id:e,error:t.toString()})}})}function Xe(t){if(this._requestId=0,this._pendingRequests={},this._filenamePrefix=t,t=Worker,!Nl){var e=new Blob(["("+We.toString()+")(true)\n\n"],{type:"application/javascript"});Nl=URL.createObjectURL(e)}this._worker=new t(Nl),this._worker.addEventListener("message",this._onMessage.bind(this))}function qe(t){this._assets=t,this._worker=null,this.retryRequests=!1}function Ye(t){this.data=t,this.model=null,this.materials=[],this.textures=[],this.animations=[],this.registry=null}function Ke(t,e){this._device=t,this._defaultMaterial=e}function $e(){this.retryRequests=!1}function Ze(t,e,i){this._device=t,this._registry=e,this._loader=i}function Qe(){}function Je(t,e){this.type=e&&e.type||"msdf",this.em=1,this.textures=t,this.intensity=0,this._data=null,this.data=e}function ti(t){return 3>t.version&&(2>t.version&&(t.info.maps=t.info.maps||[{width:t.info.width,height:t.info.height}]),t.chars=Object.keys(t.chars||{}).reduce(function(e,i){var s=t.chars[i];return i=void 0!==s.letter?s.letter:aa.fromCodePoint(i),2>t.version&&(s.map=s.map||0),e[i]=s,e},{}),t.version=3),t}function ei(t){this._loader=t,this.retryRequests=!1}function ii(t,e){if(n.call(this),this._assets=[],this._registry=e,this._loaded=!1,this._total=this._count=0,this._failed=[],this._waitingAssets=[],t.length&&t[0]instanceof Fe)this._assets=t;else for(var i=0;i<t.length;i++){var s=e.get(t[i]);s?this._assets.push(s):(this._waitForAsset(t[i]),this._total++)}}function si(t,e){this._node=t,this._data=e}function ni(t,e){this._app=t,this._isTemplate=e}function ri(t){this._app=t,this.retryRequests=!1}function ai(){this.retryRequests=!1}function oi(){this.retryRequests=!1}function hi(t,e,i,s,n){this.propertyName=t,this.parent=e,this._scope=n,this._registry=i,this.asset=this.url=this.id=null,this._onAssetLoad=s.load,this._onAssetAdd=s.add,this._onAssetRemove=s.remove}function li(){this.valid=this.removeInvalid=!0,this.enumValidators={occludeSpecular:this._createEnumValidator([0,1,2]),cull:this._createEnumValidator([0,1,2,3]),blendType:this._createEnumValidator([0,1,2,3,4,5,6,7,8,9,10]),shadingModel:this._createEnumValidator([0,1])}}function ci(){this._validator=null}function di(t){this._assets=t.assets,this._device=t.graphicsDevice,this._placeholderTextures=null,this._parser=new ci,this.retryRequests=!1}function ui(t){this._device=t,this._defaultMaterial=sr.getApplication().scene.defaultMaterial}function pi(){this.index=0,this.boneIndices=[0,0,0,0]}function fi(){this.indexCount=this.indexStart=this.vertexCount=this.vertexStart=this.partition=0,this.boneIndices=[],this.vertices=[],this.indices=[],this.indexMap={}}function mi(t,e,i){var s,n;!function(t){var e=t.vertices,i=t.skins,s=t.meshes,n=t.meshInstances;for(t=0;t<s.length;t++)s[t].vertices=e[s[t].vertices],void 0!==s[t].skin&&(s[t].skin=i[s[t].skin]);for(t=0;t<n.length;t++)n[t].mesh=s[n[t].mesh]}(t);var r=t.vertices,a=t.skins,o=t.meshes,h=t.meshInstances,l=function(t){var e=new pi;return e.index=t,e};for(s=a.length-1;0<=s;s--)if(a[s].boneNames.length>i){var c=a.splice(s,1)[0],d=[];for(n=0;n<o.length;n++)o[n].skin===c&&d.push(o[n]);for(n=0;n<d.length;n++){var u=o.indexOf(d[n]);-1!==u&&o.splice(u,1)}if(0===d.length)throw Error("partitionSkin: There should be at least one mesh that references a skin");var p=d[0].vertices;for(n=1;n<d.length;n++)if(d[n].vertices!==p)throw Error("partitionSkin: All meshes that share a skin should also share the same vertex buffer");var f,m=[],_=[],g=[],y=0;for(n=0;n<d.length;n++){for(var v=d[n],b=v.indices,x=v.base;x<v.base+v.count;){u=b[x++],_[0]=l(u),g[0]=u,u=b[x++],_[1]=l(u),g[1]=u,u=b[x++],_[2]=l(u),g[2]=u;for(var S=!1,T=y;T<m.length;T++)if((u=m[T]).addPrimitive(_,g,p,i)){S=!0;break}S||((u=new fi).originalMesh=v,u.addPrimitive(_,g,p,i),m.push(u))}y=m.length}for(v=[],d=[],n=0;n<m.length;n++)if((u=m[n]).vertices.length&&u.indices.length){for(_=v.length,g=u.vertices.length,y=d.length,b=u.indices.length,u.partition=n,u.vertexStart=_,u.vertexCount=g,u.indexStart=y,u.indexCount=b,x=0,S=_;x<g;)v[S++]=u.vertices[x++];for(x=0,S=y;x<b;)d[S++]=u.indices[x++]+_}for(_=[],n=0;n<m.length;n++){for(u=m[n],y=[],b=[],g=0;g<u.boneIndices.length;g++)y.push(c.inverseBindMatrices[u.boneIndices[g]]),b.push(c.boneNames[u.boneIndices[g]]);u={inverseBindMatrices:y,boneNames:b},_.push(u),a.push(u)}for(f in c={},p)c[f]={components:p[f].components,data:[],type:p[f].type};for(f in p)if("blendIndices"===f)for(u=c[f].data,n=0;n<v.length;n++)g=v[n].boneIndices,u.push(g[0],g[1],g[2],g[3]);else for(y=(n=p[f]).data,b=n.components,n=0;n<v.length;n++)for(u=v[n].index,g=0;g<b;g++)c[f].data.push(y[u*b+g]);for(r[r.indexOf(p)]=c,n=0;n<m.length;n++)for(u=m[n],v={aabb:{min:[0,0,0],max:[0,0,0]},vertices:c,skin:_[n],indices:d.splice(0,u.indexCount),type:"triangles",base:0,count:u.indexCount},o.push(v),g=h.length-1;0<=g;g--)h[g].mesh===u.originalMesh&&(h.push({mesh:v,node:h[g].node}),e&&e.push({material:e[g].material,path:e[g].path}));for(n=0;n<m.length;n++)for(u=m[n],g=h.length-1;0<=g;g--)h[g].mesh===u.originalMesh&&(h.splice(g,1),e&&e.splice(g,1))}!function(t){var e=t.vertices,i=t.skins,s=t.meshes,n=t.meshInstances;for(t=0;t<s.length;t++)s[t].vertices=e.indexOf(s[t].vertices),void 0!==s[t].skin&&(s[t].skin=i.indexOf(s[t].skin));for(t=0;t<n.length;t++)n[t].mesh=s.indexOf(n[t].mesh)}(t)}function _i(t){this._device=t,this._defaultMaterial=sr.getApplication().scene.defaultMaterial}function gi(t,e){this._device=t,this._parsers=[],this._defaultMaterial=e,this.retryRequests=!1,this.addParser(new _i(this._device),function(t,e){return".json"===ia.getExtension(t)}),this.addParser(new ui(this._device),function(t,e){return".glb"===ia.getExtension(t)})}function yi(t){this._handlers={},this._requests={},this._cache={},this._app=t}function vi(t){this._app=t,this.retryRequests=!1}function bi(t){this._app=t,this.retryRequests=!1}function xi(t){this._app=t,this._scripts={},this._cache={}}function Si(){this.retryRequests=!1}function Ti(t,e){n.call(this),this._device=t,this._pixelsPerUnit=e&&void 0!==e.pixelsPerUnit?e.pixelsPerUnit:1,this._renderMode=e&&void 0!==e.renderMode?e.renderMode:0,this._atlas=e&&void 0!==e.atlas?e.atlas:null,this._frameKeys=e&&void 0!==e.frameKeys?e.frameKeys:null,this._meshes=[],this._meshesDirty=this._updatingProperties=!1,this._atlas&&this._frameKeys&&this._createMeshes()}function wi(t,e){this._assets=t,this._device=e,this.retryRequests=!1}function Mi(t){this.resource&&(this.resource.atlas=t.resource)}function Pi(t){this.registry.load(t)}function Ai(t,e){this._app=t,this._data=e,this._templateRoot=null}function Ei(t){this._app=t}function Ci(){this.retryRequests=!1}function Ii(){n.call(this),this._frames=this._texture=null}function Oi(t){this._loader=t,this.retryRequests=!1}function Ri(){var t={astc:10,dxt:2,etc2:0,etc1:0,pvr:8,atc:11,none:14},e={astc:10,dxt:3,etc2:1,etc1:16,pvr:9,atc:12,none:16},i={0:21,1:23,2:8,3:10,8:26,9:27,10:28,11:29,12:30,13:7,14:3,16:5},s="undefined"!=typeof performance,n=null,r=[],a=function(r,a,o,h){try{var l=function(n,r,a,o,h){var l=s?performance.now():0,c=new n.BasisFile(new Uint8Array(o));n=c.getImageWidth(0,0),o=c.getImageHeight(0,0);var d=c.getNumImages(),u=c.getNumLevels(0),p=!!c.getHasAlpha();if(!(n&&o&&d&&u))throw c.close(),c.delete(),Error("Invalid image dimensions url="+r+" width="+n+" height="+o+" images="+d+" levels="+u);if(8!==(a=p?e[a]:t[a])&&9!==a||0==(n&n-1)&&n===o||(a=8===a?14:13),h&&h.unswizzleGGGR&&(a=13),!c.startTranscoding())throw c.close(),c.delete(),Error("Failed to start transcoding url="+r);p=[];for(var f=0;f<u;++f){var m=c.getImageTranscodedSizeInBytes(0,f,a),_=new Uint8Array(m);if(!c.transcodeImage(_,0,f,a,1,0))throw c.close(),c.delete(),Error("Failed to transcode image url="+r);if(14===a||16===a){var g=new Uint16Array(m/2);for(d=0;d<m/2;++d)g[d]=_[2*d]+256*_[2*d+1];_=g}p.push(_)}if(c.close(),c.delete(),h&&h.unswizzleGGGR)for(a=14,d=0;d<p.length;++d){for(h=d,c=p[d],u=0;u<c.length;u+=4)m=c[u+3],f=c[u+1],c[u+0]=m,m=2/255*m-1,f=2/255*f-1,c[u+2]=Math.max(0,Math.min(255,Math.floor(127.5*(Math.sqrt(1-Math.min(1,m*m+f*f))+1)))),c[u+3]=255;for(u=new Uint16Array(c.length/4),f=0;f<c.length;f+=4)u[f/4]=(248&c[f+0])<<8|(252&c[f+1])<<3|c[f+2]>>3;p[h]=u}return{format:i[a],width:n+3&-4,height:o+3&-4,levels:p,cubemap:!1,mipmaps:!0,transcodeTime:s?performance.now()-l:0,url:r}}(n,r,a,o,h);l.levels=l.levels.map(function(t){return t.buffer}),self.postMessage({url:r,data:l},l.levels)}catch(t){self.postMessage({url:r.toString(),err:t.toString()})}};self.onmessage=function(t){switch((t=t.data).type){case"init":!function(t){self.BASIS(t?{instantiateWasm:function(e,i){return WebAssembly.instantiate(t,e).then(function(t){i(t)}),{}}}:null).then(function(t){for((n=t).initializeBasis(),t=0;t<r.length;++t)a(r[t].url,r[t].format,r[t].data,r[t].options);r=[]})}(t.module);break;case"transcode":n?a(t.url,t.format,t.data,t.options):r.push(t)}}}function Di(){if(!hc){var t=sr.getApplication().graphicsDevice;hc=t.extCompressedTextureASTC?"astc":t.extCompressedTextureS3TC?"dxt":t.extCompressedTextureETC?"etc2":t.extCompressedTextureETC1?"etc1":t.extCompressedTexturePVRTC?"pvr":t.extCompressedTextureATC?"atc":"none"}return hc}function Li(t){var e=t.data.url,i=t.data.err;t=t.data.data;var s,n=oc[e];if(n)if(i)for(s=0;s<n.length;++s)n[s](i);else{for(t.levels=3===t.format||5===t.format?t.levels.map(function(t){return new Uint16Array(t)}):t.levels.map(function(t){return new Uint8Array(t)}),s=0;s<n.length;++s)n[s](null,t);delete oc[e]}else console.error("internal logical error encountered in basis transcoder")}function Fi(t,e,i,s){oc.hasOwnProperty(t)?oc[t].push(i):(oc[t]=[i],ac.postMessage({type:"transcode",url:t,format:Di(),data:e,options:s},[e]))}function Bi(t,e,i){for(t=["/* basis.js */",t,"/* mappings */\nvar PIXELFORMAT_ETC1 = 21;\nvar PIXELFORMAT_ETC2_RGBA = 23;\nvar PIXELFORMAT_DXT1 = 8;\nvar PIXELFORMAT_DXT5 = 10;\nvar PIXELFORMAT_PVRTC_4BPP_RGB_1 = 26;\nvar PIXELFORMAT_PVRTC_4BPP_RGBA_1 = 27;\nvar PIXELFORMAT_ASTC_4x4 = 28;\nvar PIXELFORMAT_ATC_RGB = 29;\nvar PIXELFORMAT_ATC_RGBA = 30;\nvar PIXELFORMAT_R8_G8_B8_A8 = 7;\nvar PIXELFORMAT_R5_G6_B5 = 3;\nvar PIXELFORMAT_R4_G4_B4_A4 = 5;\n\n/* worker */","("+Ri.toString()+")()\n\n"].join("\n"),t=new Blob([t],{type:"application/javascript"}),t=URL.createObjectURL(t),(ac=new Worker(t)).addEventListener("message",Li),ac.postMessage({type:"init",module:e}),i&&i(),e=0;e<lc.length;++e)Fi((i=lc[e]).url,i.data,i.callback,i.options)}function Ni(t,e,i,s){if(rc&&console.warn("basis module is being downloaded more than once"),rc=!0,nc){var n=null,r=null,a=function(){n&&r&&Bi(n,r,s)},o=function(){la.get(e,{cache:!0,responseType:"arraybuffer",retry:!1},function(t,e){e&&WebAssembly.compile(e).then(function(t){r=t,a()})})};WebAssembly.compileStreaming?WebAssembly.compileStreaming(fetch(e)).then(function(t){r=t,a()}).catch(function(t){console.error(t),console.warn("compileStreaming() failed for "+e+", falling back to arraybuffer download..."),o()}):o(),la.get(t,{cache:!0,responseType:"text",retry:!1},function(t,e){n=e,a()})}else la.get(i,{cache:!0,responseType:"text",retry:!1},function(t,e){e&&Bi(e,null,s)})}function ki(t){if(cc)Ni(cc.glueUrl,cc.wasmUrl,cc.fallbackUrl,t);else{var e=((window.config?window.config.wasmModules:window.PRELOAD_MODULES)||[]).find(function(t){return"BASIS"===t.moduleName});if(e){var i=window.ASSET_PREFIX?window.ASSET_PREFIX:"";Ni(i+e.glueUrl,i+e.wasmUrl,i+e.fallbackUrl,t)}}}function zi(t,e,i,s){ac?Fi(t,e,i,s):(lc.push({url:t,data:e,callback:i,options:s}),rc||ki())}function Ui(t,e){this.retryRequests=!!e}function Vi(t,e){this.crossOrigin=t.prefix?"anonymous":null,this.retryRequests=!!e,this.useImageBitmap=!1}function ji(t,e){this.retryRequests=!!e}function Gi(t,e){this.retryRequests=!!e}function Hi(){}function Wi(t,e,i){this._device=t,this._assets=e,this._loader=i,this.imgParser=new Vi(e,!1),this.parsers={dds:new Gi(e,!1),ktx:new ji(e,!1),basis:new Ui(e,!1)}}function Xi(t){n.call(this),this._loader=t,this._assets=[],this._cache={},this._names={},this._tags=new l("_id"),this._urls={},this.prefix=null}function qi(t){this._assets=t,this._bundleAssets={},this._assetsInBundles={},this._urlsInBundles={},this._fileRequests={},this._assets.on("add",this._onAssetAdded,this),this._assets.on("remove",this._onAssetRemoved,this)}function Yi(t){n.call(this),this.app=t,this._scripts={},this._list=[]}function Ki(t,e){n.call(this);var i=this;this._app=t,this._device=t.graphicsDevice,this.id=e.displayId,this._frameData=null,window.VRFrameData&&(this._frameData=new window.VRFrameData),this.display=e,this._camera=null,this.sitToStandInv=new x,this.leftView=new x,this.leftProj=new x,this.leftViewInv=new x,this.leftPos=new v,this.rightView=new x,this.rightProj=new x,this.rightViewInv=new x,this.rightPos=new v,this.combinedPos=new v,this.combinedView=new x,this.combinedProj=new x,this.combinedViewInv=new x,this.combinedAspect=this.combinedFov=0,this.presenting=!1,i._presentChange=function(t){if((t.display?t.display:t.detail&&t.detail.display?t.detail.display:t.detail&&t.detail.vrdisplay?t.detail.vrdisplay:i.display)===i.display){if(i.presenting=i.display&&i.display.isPresenting,i.presenting){t=i.display.getEyeParameters("left");var e=i.display.getEyeParameters("right");i._app.graphicsDevice.setResolution(2*Math.max(t.renderWidth,e.renderWidth),Math.max(t.renderHeight,e.renderHeight)),i._app._allowResize=!1}else i._app.setCanvasResolution("AUTO"),i._app._allowResize=!0;i.fire("beforepresentchange",i),i.fire("presentchange",i)}},window.addEventListener("vrdisplaypresentchange",i._presentChange,!1)}function $i(t){n.call(this);var e=this;this.isSupported=$i.isSupported,this._index={},this.displays=[],this.display=null,this._app=t,this._onDisplayConnect=this._onDisplayConnect.bind(this),this._onDisplayDisconnect=this._onDisplayDisconnect.bind(this),e._attach(),this._getDisplays(function(t,i){if(t)e.fire("error",t);else{for(t=0;t<i.length;t++)e._addDisplay(i[t]);e.fire("ready",e.displays)}})}function Zi(t,e,i){n.call(this),this.manager=t,this._xrHitTestSource=e,this._transient=i}function Qi(t){n.call(this),this.manager=t,this._supported=!(!window.XRSession||!window.XRSession.prototype.requestHitTestSource),this._session=null,this.sources=[],this._supported&&(this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this))}function Ji(t,e){this._index=t,this._hand=e,this._hand._fingers.push(this),this._joints=[],this._tip=null}function ts(t,e,i,s){this._index=t,this._id=e,this._hand=i,this._hand._joints.push(this),this._hand._jointsById[e]=this,(this._finger=s||null)&&this._finger._joints.push(this),(this._wrist=e===XRHand.WRIST)&&(this._hand._wrist=this),(this._tip=this._finger&&!!Mc[e])&&(this._hand._tips.push(this),this._finger&&(this._finger._tip=this)),this._radius=null,this._localTransform=new x,this._worldTransform=new x,this._localPosition=new v,this._localRotation=new S,this._position=new v,this._rotation=new S,this._dirtyLocal=!0}function es(t){n.call(this);var e=t._xrInputSource.hand;for(this._manager=t._manager,this._inputSource=t,this._tracking=!1,this._fingers=[],this._joints=[],this._jointsById={},this._tips=[],this._wrist=null,e[XRHand.WRIST]&&(this._wrist=new ts(0,XRHand.WRIST,this,null)),t=0;t<Ac.length;t++)for(var i=new Ji(t,this),s=0;s<Ac[t].length;s++){var r=Ac[t][s];e[r]&&new ts(s,r,this,i)}}function is(t,e){n.call(this),this._id=++Rc,this._manager=t,this._xrInputSource=e,this._ray=new P,this._rayLocal=new P,this._grip=!1,this._hand=null,e.hand&&(this._hand=new es(this)),this._worldTransform=this._localTransform=null,this._position=new v,this._rotation=new S,this._localRotation=this._localPosition=null,this._dirtyLocal=!0,this._selecting=!1,this._elementInput=!0,this._elementEntity=null,this._hitTestSources=[]}function ss(t){n.call(this);var e=this;this.manager=t,this._session=null,this._inputSources=[],this._onInputSourcesChangeEvt=function(t){e._onInputSourcesChange(t)},this.manager.on("start",this._onSessionStart,this),this.manager.on("end",this._onSessionEnd,this)}function ns(t){n.call(this),this._manager=t,this._lightProbeRequested=this._available=this._supported=!1,this._lightProbe=null,this._intensity=0,this._rotation=new S,this._color=new o,this._sphericalHarmonics=new Float32Array(27),this._manager.on("start",this._onSessionStart,this),this._manager.on("end",this._onSessionEnd,this)}function rs(t){n.call(this);var e=this;this.app=t,this._supported=!!navigator.xr,this._available={},this._available[vc]=!1,this._available[bc]=!1,this._available[xc]=!1,this._referenceSpace=this._baseLayer=this._session=this._spaceType=this._type=null,this.input=new ss(this),this.hitTest=new Qi(this),this.lightEstimation=new ns(this),this._camera=null,this.views=[],this.viewsPool=[],this._localPosition=new v,this._localRotation=new S,this._depthNear=.1,this._depthFar=1e3,this._height=this._width=0,this._supported&&(navigator.xr.addEventListener("devicechange",function(){e._deviceAvailabilityCheck()}),this._deviceAvailabilityCheck())}function as(t,e){n.call(this),this.system=t,this.entity=e,this.system.schema&&!this._accessorsBuilt&&this.buildAccessors(this.system.schema),this.on("set",function(t,e,i){this.fire("set_"+t,t,e,i)}),this.on("set_enabled",this.onSetEnabled,this)}function os(t){n.call(this),this.app=t,this.store={},this.schema=[]}function hs(t,e){if(!t)return t;switch(e){case"rgb":return t instanceof o?t.clone():new o(t[0],t[1],t[2]);case"rgba":return t instanceof o?t.clone():new o(t[0],t[1],t[2],t[3]);case"vec2":return t instanceof y?t.clone():new y(t[0],t[1]);case"vec3":return t instanceof v?t.clone():new v(t[0],t[1],t[2]);case"vec4":return t instanceof b?t.clone():new b(t[0],t[1],t[2],t[3]);case"boolean":case"number":case"string":case"entity":return t;default:throw Error("Could not convert unhandled type: "+e)}}function ls(){this._written=!1,this._name="",this._keyFrames=[],this._quat=new S,this._pos=new v,this._scale=new v,this._targetNode=null}function cs(t){this._animation=null,this._time=0,this.looping=!0,this._interpolatedKeys=[],this._interpolatedKeyDict={},this._currKeyIndices={},this.graph=null;var e=this;!function t(i){var s=new ls;for(s._name=i.name,e._interpolatedKeys.push(s),e._interpolatedKeyDict[i.name]=s,s=e._currKeyIndices[i.name]=0;s<i._children.length;s++)t(i._children[s])}(t)}function ds(t,e){as.call(this,t,e),this.animationsIndex={},this.on("set_animations",this.onSetAnimations,this),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this)}function us(){this.assets=[],this.speed=1,this.enabled=this.activate=this.loop=!0,this.animations={},this.currAnim=this.prevAnim=this.model=null,this.blending=!1,this.blendSpeed=this.blend=0,this.playing=!1,this.animEvaluator=this.toSkel=this.fromSkel=this.skeleton=null}function ps(t){os.call(this,t),this.id="animation",this.ComponentType=ds,this.DataType=us,this.schema=Nc,this.on("beforeremove",this.onBeforeRemove,this),this.on("update",this.onUpdate,this),os.bind("update",this.onUpdate,this)}function fs(t,e){this.animComponent=t,e?Ie.call(this,e):this.propertyLocator=new be}function ms(t,e,i){this._name=t,this._controller=e,this._component=i}function _s(t,e,i,s){this._controller=t,this._name=e,this._animations=[],this._speed=i||1,this._loop=void 0===s||s}function gs(t,e,i,s,n,r,a,o,h){this._controller=t,this._from=e,this._to=i,this._time=s,this._priority=n,this._conditions=r||[],this._exitTime=a||null,this._transitionOffset=o||null,this._interruptionSource=h||"NONE"}function ys(t,e,i,s,n){for(this._animEvaluator=t,this._states={},this._stateNames=[],t=0;t<e.length;t++)this._states[e[t].name]=new _s(this,e[t].name,e[t].speed,e[t].loop),this._stateNames.push(e[t].name);this._transitions=i.map(function(t){return new gs(this,t.from,t.to,t.time,t.priority,t.conditions,t.exitTime,t.transitionOffset,t.interruptionSource)}.bind(this)),this._findTransitionsFromStateCache={},this._findTransitionsBetweenStatesCache={},this._parameters=s,this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._activate=n,this._totalTransitionTime=this._currTransitionTime=1,this._isTransitioning=!1,this._transitionInterruptionSource="NONE",this._transitionPreviousStates=[],this._timeInStateBefore=this._timeInState=0}function vs(t,e){as.call(this,t,e)}function bs(){this.stateGraphAsset=null,this.animationAssets={},this.speed=1,this.enabled=this.activate=!0,this.playing=!1,this.stateGraph=null,this.layers=[],this.layerIndices={},this.parameters={}}function xs(t){os.call(this,t),this.id="anim",this.ComponentType=vs,this.DataType=bs,this.schema=kc,this.on("beforeremove",this.onBeforeRemove,this),os.bind("animationUpdate",this.onAnimationUpdate,this)}function Ss(t,e){as.call(this,t,e)}function Ts(){this.enabled=!0}function ws(t,e){os.call(this,t),this.id="audiolistener",this.ComponentType=Ss,this.DataType=Ts,this.schema=zc,this.manager=e,this.current=null,os.bind("update",this.onUpdate,this)}function Ms(t,e){as.call(this,t,e),this.on("set_assets",this.onSetAssets,this),this.on("set_loop",this.onSetLoop,this),this.on("set_volume",this.onSetVolume,this),this.on("set_pitch",this.onSetPitch,this),this.on("set_minDistance",this.onSetMinDistance,this),this.on("set_maxDistance",this.onSetMaxDistance,this),this.on("set_rollOffFactor",this.onSetRollOffFactor,this),this.on("set_distanceModel",this.onSetDistanceModel,this),this.on("set_3d",this.onSet3d,this)}function Ps(){this.enabled=!0,this.assets=[],this.activate=!0,this.pitch=this.volume=1,this.loop=!1,this["3d"]=!0,this.minDistance=1,this.maxDistance=1e4,this.rollOffFactor=1,this.distanceModel=il,this.paused=!0,this.sources={},this.channel=this.currentSource=null}function As(t,e){os.call(this,t),this.id="audiosource",this.ComponentType=Ms,this.DataType=Ps,this.schema=Uc,this.manager=e,this.initialized=!1,os.bind("initialize",this.onInitialize,this),os.bind("update",this.onUpdate,this),this.on("remove",this.onRemove,this)}function Es(t,e,i){if(!(t&&t instanceof as))throw Error("The parentComponent argument is required and must be a Component");if(!e||"string"!=typeof e)throw Error("The propertyName argument is required and must be a string");if(i&&"object"!=typeof i)throw Error("If provided, the eventConfig argument must be an object");this._parentComponent=t,this._entityPropertyName=e,this._entity=null,this._app=t.system.app,this._configureEventListeners(i||{},{"entity#destroy":this._onEntityDestroy}),this._toggleLifecycleListeners("on")}function Cs(t,e){as.call(this,t,e),this._visualState=jc.DEFAULT,this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._defaultTint=new o(1,1,1,1),this._defaultSpriteAsset=null,this._defaultSpriteFrame=0,this._imageReference=new Es(this,"imageEntity",{"element#gain":this._onImageElementGain,"element#lose":this._onImageElementLose,"element#set:color":this._onSetColor,"element#set:opacity":this._onSetOpacity,"element#set:spriteAsset":this._onSetSpriteAsset,"element#set:spriteFrame":this._onSetSpriteFrame}),this._toggleLifecycleListeners("on",t)}function Is(){this.active=this.enabled=!0,this.imageEntity=null,this.hitPadding=new b,this.transitionMode=Vc,this.hoverTint=new o(.75,.75,.75),this.pressedTint=new o(.5,.5,.5),this.inactiveTint=new o(.25,.25,.25),this.fadeDuration=0,this.hoverSpriteAsset=null,this.hoverSpriteFrame=0,this.pressedSpriteAsset=null,this.pressedSpriteFrame=0,this.inactiveSpriteAsset=null,this.inactiveSpriteFrame=0}function Os(t){os.call(this,t),this.id="button",this.ComponentType=Cs,this.DataType=Is,this.schema=qc,this.on("beforeremove",this._onRemoveComponent,this),os.bind("update",this.onUpdate,this)}function Rs(t,e){var i=this;this.app=t,this.camera=e,this.effects=[],this.enabled=!1,this.depthTarget=null,this.renderTargetScale=1,this.resizeTimeout=null,this.resizeLast=0,this._resizeTimeoutCallback=function(){i.resizeRenderTargets()},e.on("set_rect",this.onCameraRectChanged,this),this._origStencilColorBuffer=this._origDepthColorBuffer=this._origClearColorBuffer=this._origOverrideClear=!1}function Ds(){this.enabled=!0}function Ls(){this.enabled=!0,this.type="box",this.halfExtents=new v(.5,.5,.5),this.radius=.5,this.axis=1,this.height=2,this.model=this.shape=this.asset=null,this.initialized=!1}function Fs(t,e,i){this.entity=e.entity,this.component=e,this.app=t,"undefined"==typeof Ammo||Qc||(Qc=new Ammo.btVector3,Jc=new Ammo.btQuaternion,td=new Ammo.btTransform),this.initialize(i)}function Bs(){this.list=[]}function Ns(t){this.func=void 0===t.func?7:t.func,this.ref=t.ref||0,this.readMask=void 0===t.readMask?255:t.readMask,this.writeMask=void 0===t.writeMask?255:t.writeMask,this.fail=t.fail||0,this.zfail=t.zfail||0,this.zpass=t.zpass||0}function ks(t,e,i){this._entity=t,this._element=t.element,this.model=new mt,this.node=new Mt,this.model.graph=this.node,this.mesh=e,this.meshInstance=new lt(this.node,this.mesh,i),this.meshInstance.name="ImageElement: "+t.name,this.meshInstance.castShadow=!1,this._meshDirty=this.meshInstance.receiveShadow=!1,this.model.meshInstances.push(this.meshInstance),this._entity.addChild(this.model.graph),this.model._entity=this._entity,this.unmaskMeshInstance=null}function zs(t){this._element=t,this._entity=t.entity,this._system=t.system,this._sprite=this._spriteAsset=this._material=this._materialAsset=this._texture=this._textureAsset=null,this._spriteFrame=0,this._pixelsPerUnit=null,this._rect=new b(0,0,1,1),this._mask=!1,this._maskRef=0,this._outerScale=new y,this._outerScaleUniform=new Float32Array(2),this._innerOffset=new b,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new b,this._atlasRectUniform=new Float32Array(4),this._defaultMesh=this._createMesh(),this._renderable=new ks(this._entity,this._defaultMesh,this._material),this._color=new o(1,1,1,1),this._colorUniform=new Float32Array([1,1,1]),this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",1),this._updateAabbFunc=this._updateAabb.bind(this),this._onScreenChange(this._element.screen),this._element.on("resize",this._onParentResizeOrPivotChange,this),this._element.on("set:pivot",this._onParentResizeOrPivotChange,this),this._element.on("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.on("set:screen",this._onScreenChange,this),this._element.on("set:draworder",this._onDrawOrderChange,this),this._element.on("screen:set:resolution",this._onResolutionChange,this)}function Us(t){n.call(this),this._app=t,t.i18n.on("set:locale",this._onSetLocale,this),this._disableLocalization=this._autoLoad=!1,this._localizedAsset=this._defaultAsset=null}function Vs(t){this._symbols=t,this._last=this._index=0,this._cur=0<this._symbols.length?this._symbols[0]:null,this._buf=[],this._mode="text",this._error=null}function js(t,e){for(var i in e)if(e.hasOwnProperty(i)){var s=e[i];s instanceof Object?(t.hasOwnProperty(i)||(t[i]={}),js(t[i],e[i])):t[i]=s}}function Gs(t){if(0===t.length)return null;for(var e={},i=0;i<t.length;++i){var s=t[i],n={};n[s.name]={value:s.value,attributes:s.attributes},js(e,n)}return e}function Hs(t){var e=new yd(t),i=[],s=[];return e.parse(i,s)?(e=s.find(function(t){return null===t.end}))?(console.warn("Markup error: found unclosed tag='"+e.name+"'"),{symbols:t,tags:null}):(t=function(t,e){function i(t){o=o.filter(function(e){return void 0===t.find(function(t){return t===e})})}function s(t){for(var e=0;e<t.length;++e)o.push(t[e])}var n;if(0===t.length)return null;var r={};for(n=0;n<t.length;++n){var a=t[n];r.hasOwnProperty(a.start)?null===r[a.start].open?r[a.start].open=[a]:r[a.start].open.push(a):r[a.start]={open:[a],close:null},r.hasOwnProperty(a.end)?null===r[a.end].close?r[a.end].close=[a]:r[a.end].close.push(a):r[a.end]={open:null,close:[a]}}var o=[];for(a=Object.keys(r).sort(function(t,e){return t-e}),t=[],n=0;n<a.length;++n){var h=r[a[n]];null!==h.close&&i(h.close),null!==h.open&&s(h.open),t.push({start:a[n],tags:Gs(o)})}for(r=[],a=null,n=0;n<t.length;++n){for(h=t[n];r.length<h.start;)r.push(a?a.tags:null);a=h}for(;r.length<e;)r.push(null);return r}(s,i.length),{symbols:i,tags:t}):(console.warn(e.error()),{symbols:t,tags:null})}function Ws(){}function Xs(){this.quad=this.count=0,this.lines={},this.positions=[],this.normals=[],this.uvs=[],this.colors=[],this.indices=[],this.meshInstance=null}function qs(t){this._element=t,this._system=t.system,this._entity=t.entity,this._text="",this._symbols=[],this._colorPalette=[],this._i18nKey=this._symbolColors=null,this._fontAsset=new Us(this._system.app),this._fontAsset.disableLocalization=!0,this._fontAsset.on("load",this._onFontLoad,this),this._fontAsset.on("change",this._onFontChange,this),this._fontAsset.on("remove",this._onFontRemove,this),this._font=null,this._color=new o(1,1,1,1),this._colorUniform=new Float32Array(3),this._spacing=1,this._fontSize=32,this._fontMaxY=this._fontMinY=0,this._maxFontSize=this._originalFontSize=32,this._minFontSize=8,this._autoFitHeight=this._autoFitWidth=!1,this._maxLines=-1,this._scaledLineHeight=this._lineHeight=32,this._wrapLines=!1,this._drawOrder=0,this._alignment=new y(.5,.5),this._autoHeight=this._autoWidth=!0,this.height=this.width=0,this._node=new Mt,this._model=new mt,this._model.graph=this._node,this._entity.addChild(this._node),this._meshInfo=[],this._material=null,this._aabbDirty=!0,this._aabb=new T,this._noResize=!1,this._maskedMaterialSrc=this._currentMaterialType=null,this._rtl=this._unicodeConverter=this._rtlReorder=!1,this._outlineColor=new o(0,0,0,1),this._outlineColorUniform=new Float32Array(4),this._outlineThicknessScale=.2,this._outlineThickness=0,this._shadowColor=new o(0,0,0,1),this._shadowColorUniform=new Float32Array(4),this._shadowOffsetScale=.005,this._shadowOffset=new y(0,0),this._shadowOffsetUniform=new Float32Array(2),this._enableMarkup=!1,this._onScreenChange(this._element.screen),t.on("resize",this._onParentResize,this),t.on("set:screen",this._onScreenChange,this),t.on("screen:set:screenspace",this._onScreenSpaceChange,this),t.on("set:draworder",this._onDrawOrderChange,this),t.on("set:pivot",this._onPivotChange,this),this._system.app.i18n.on("set:locale",this._onLocaleSet,this),this._system.app.i18n.on("data:add",this._onLocalizationData,this),this._system.app.i18n.on("data:remove",this._onLocalizationData,this),this._rangeEnd=this._rangeStart=0}function Ys(t,e){as.call(this,t,e),this._beingInitialized=!1,this._anchor=new b,this._localAnchor=new b,this._pivot=new y,this._height=this._calculatedHeight=this._width=this._calculatedWidth=32,this._margin=new b(0,0,-32,-32),this._modelTransform=new x,this._screenToWorld=new x,this._anchorTransform=new x,this._anchorDirty=!0,this._parentWorldTransform=new x,this._screenTransform=new x,this._screenCorners=[new v,new v,new v,new v],this._canvasCorners=[new y,new y,new y,new y],this._worldCorners=[new v,new v,new v,new v],this._worldCornersDirty=this._canvasCornersDirty=this._cornersDirty=!0,this.entity.on("insert",this._onInsert,this),this._patch(),this.screen=null,this._type=gd,this._group=this._text=this._image=null,this._drawOrder=0,this._useInput=!1,this._layers=[4],this._addedModels=[],this._batchGroupId=-1,this._offsetReadAt=0,this._maskOffset=.5,this._maskedBy=null}function Ks(){this.enabled=!0}function $s(t){os.call(this,t),this.id="element",this.ComponentType=Ys,this.DataType=Ks,this.schema=Cd,this._rtlReorder=this._unicodeConverter=null,this._defaultTexture=new nt(t.graphicsDevice,{width:1,height:1,format:7}),this._defaultTexture.name="element-system",t=this._defaultTexture.lock();var e=new Uint8Array(4);e[0]=255,e[1]=255,e[2]=255,e[3]=255,t.set(e),this._defaultTexture.unlock(),this.defaultScreenSpaceBitmapTextMaterial=this.defaultScreenSpaceTextMaterial=this.defaultBitmapTextMaterial=this.defaultTextMaterial=this.defaultScreenSpaceImageMaskMaterial=this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImageMask9SlicedMaterial=this.defaultScreenSpaceImage9TiledMaterial=this.defaultScreenSpaceImage9SlicedMaterial=this.defaultScreenSpaceImageMaterial=this.defaultImage9TiledMaskMaterial=this.defaultImage9SlicedMaskMaterial=this.defaultImageMaskMaterial=this.defaultImage9TiledMaterial=this.defaultImage9SlicedMaterial=this.defaultImageMaterial=null,this.defaultImageMaterials=[],this.on("beforeremove",this.onRemoveComponent,this)}function Zs(t,e){as.call(this,t,e),this._minHeight=this._minWidth=0,this._maxHeight=this._maxWidth=null,this._fitHeightProportion=this._fitWidthProportion=0,this._excludeFromLayout=!1}function Qs(t){var e="_"+t;Object.defineProperty(Zs.prototype,t,{get:function(){return this[e]},set:function(t){this[e]!==t&&(this[e]=t,this.fire("resize"))}})}function Js(){this.enabled=!0}function tn(){}function en(t){function e(t){return!(t=t.entity.layoutchild)||!t.enabled||!t.excludeFromLayout}function i(t,e,i){switch(t){case Rd:return Bd.NONE;case 1:return e<i?Bd.APPLY_STRETCHING:Bd.NONE;case 2:return e>=i?Bd.APPLY_SHRINKING:Bd.NONE;case 3:return e<i?Bd.APPLY_STRETCHING:e>=i?Bd.APPLY_SHRINKING:Bd.NONE;default:throw Error("Unrecognized fitting mode: "+t)}}function s(t,e){return l(t,e.size)+(t.length-1)*m.spacing[e.axis]}function n(t,e,i){var s=d(t,i.maxSize),n=c(t,i.fittingProportion),r=f(n,s);e=Nd[i.axis]-e;for(var o=0;o<t.length;++o){var h=s[o],l=a(h,e,n,r),u=t[h][i.size]+l,p=Math.min(u,t[h][i.maxSize]);t[h][i.size]=p,e-=l-Math.max(u-p,0)}}function r(t,e,i){var s=d(t,i.minSize,!0),n=c(t,i.fittingProportion);if(1===n.length)n=[1];else{for(var r=[],o=n.length,h=0;h<o;++h)r.push((1-n[h])/(o-1));n=r}for(r=f(n,s),e-=Nd[i.axis],o=0;o<t.length;++o){var l=a(h=s[o],e,n,r),u=t[h][i.size]-l,p=Math.max(u,t[h][i.minSize]);t[h][i.size]=p,e-=l-Math.max(p-u,0)}}function a(t,e,i,s){return i=i[t],t=s[t],1e-5>Math.abs(i)&&1e-5>Math.abs(t)?e:e*i/t}function o(t){for(var e=[],i=0;i<t.length;++i){var s=t[i],n=Math.max(h(s,"minWidth"),0),r=Math.max(h(s,"minHeight"),0),a=Math.max(h(s,"maxWidth"),n),o=Math.max(h(s,"maxHeight"),r),l=h(s,"width");l=Math.min(Math.max(l,n),a);var c=h(s,"height");c=Math.min(Math.max(c,r),o);var d=h(s,"fitWidthProportion");s=h(s,"fitHeightProportion"),e.push({minWidth:n,minHeight:r,maxWidth:a,maxHeight:o,width:l,height:c,fitWidthProportion:d,fitHeightProportion:s})}return e}function h(t,e){var i=t.entity.layoutchild;return i&&i.enabled&&void 0!==i[e]&&null!==i[e]?i[e]:void 0!==t[e]?t[e]:Fd[e]}function l(t,e){return t.reduce(function(t,i){return t+i[e]},0)}function c(t,e){var i,s=l(t,e),n=[],r=t.length;if(0===s)for(i=0;i<r;++i)n.push(1/r);else for(i=0;i<r;++i)n.push(t[i][e]/s);return n}function d(t,e,i){return t.forEach(u),t.slice().sort(function(t,s){return i?s[e]-t[e]:t[e]-s[e]}).map(p)}function u(t,e){t.index=e}function p(t){return t.index}function f(t,e){var i=[];i[e[t.length-1]]=t[e[t.length-1]];for(var s=t.length-2;0<=s;--s)i[e[s]]=i[e[s+1]]+t[e[s]];return i}var m,_=Dd[t],g=Dd[Ld[t]];return function(t,a){t=t.filter(e),m=a,Nd.x=m.containerSize.x-m.padding.x-m.padding.z,Nd.y=m.containerSize.y-m.padding.y-m.padding.w,a=t;for(var h=0;h<a.length;++h){var l=a[h],c=l.anchor;0===c.x&&0===c.y&&0===c.z&&0===c.w||(l.anchor=b.ZERO)}if(m.wrap){a=[[]],h=o(t),l=0,c=2===m[_.fitting];for(var d=0;d<t.length;++d){0<a[a.length-1].length&&(l+=m.spacing[_.axis]);var u=h[d][_.size];l+=u,!c&&l>Nd[_.axis]&&0!==a[a.length-1].length&&(l=u,a.push([])),a[a.length-1].push(t[d]),c&&l>Nd[_.axis]&&d!==t.length-1&&(l=0,a.push([]))}t=a}else t=[t];if(a=0===m.orientation&&m.reverseX||1===m.orientation&&m.reverseY,h=0===m.orientation&&m.reverseY||1===m.orientation&&m.reverseX,a)for(l=0;l<t.length;++l)a&&t[l].reverse();for(h&&t.reverse(),a=[],h=0;h<t.length;++h)c=s(l=o(t[h]),_),(d=i(m[_.fitting],c,Nd[_.axis]))===Bd.APPLY_STRETCHING?n(l,c,_):d===Bd.APPLY_SHRINKING&&r(l,c,_),a.push(l);for(u=[],d=[],l=0;l<t.length;++l){for((c=t[l]).largestElement=null,c.largestSize={width:Number.NEGATIVE_INFINITY,height:Number.NEGATIVE_INFINITY},h=0;h<c.length;++h){var p=a[l][h];p[g.size]>c.largestSize[g.size]&&(c.largestElement=c[h],c.largestSize=p)}u.push(c.largestElement),d.push(c.largestSize)}for(h=s(d,g),(l=i(m[g.fitting],h,Nd[g.axis]))===Bd.APPLY_STRETCHING?n(d,h,g):l===Bd.APPLY_SHRINKING&&r(d,h,g),l=0;l<t.length;++l)for(c=t[l],h=0;h<c.length;++h)d=a[l][h],u=1===t.length?Nd[g.axis]:c.largestSize[g.size],(p=i(m[g.fitting],d[g.size],u))===Bd.APPLY_STRETCHING?d[g.size]=Math.min(u,d[g.maxSize]):p===Bd.APPLY_SHRINKING&&(d[g.size]=Math.max(u,d[g.minSize]));t:{for((h={})[_.axis]=0,h[g.axis]=0,t[_.size]=Number.NEGATIVE_INFINITY,l=[],c=0;c<t.length;++c){if(0===(d=t[c]).length){h=void 0;break t}u=[],p=a[c];for(var f=0;f<d.length;++f){var y=d[f],v=p[f];h[g.axis]-=-v[g.size]*y.pivot[g.axis],h[_.axis]-=-v[_.size]*y.pivot[_.axis],u[f]={},u[f][_.axis]=h[_.axis],u[f][g.axis]=h[g.axis],h[g.axis]+=-v[g.size]*y.pivot[g.axis],h[_.axis]+=v[_.size]*(1-y.pivot[_.axis])+m.spacing[_.axis]}d[_.size]=h[_.axis]-m.spacing[_.axis],d[g.size]=d.largestSize[g.size],t[_.size]=Math.max(t[_.size],d[_.size]),h[_.axis]=0,h[g.axis]+=d[g.size]+m.spacing[g.axis],l.push(u)}t[g.size]=h[g.axis]-m.spacing[g.axis],h=l}for(l=h,c=m.alignment[_.axis],d=m.alignment[g.axis],u=m.padding[_.axis],p=m.padding[g.axis],f=0;f<t.length;++f){y=t[f],v=a[f];for(var x=l[f],S=(Nd[_.axis]-y[_.size])*c+u,T=(Nd[g.axis]-t[g.size])*d+p,w=0;w<y.length;++w){var M=(y[g.size]-v[w][g.size])*m.alignment[g.axis];x[w][_.axis]+=S,x[w][g.axis]+=T+M}}for(l=0;l<t.length;++l)for(c=t[l],d=a[l],u=h[l],p=0;p<c.length;++p)(f=c[p])[_.calculatedSize]=d[p][_.size],f[g.calculatedSize]=d[p][g.size],0===m.orientation?f.entity.setLocalPosition(u[p][_.axis],u[p][g.axis],f.entity.getLocalPosition().z):f.entity.setLocalPosition(u[p][g.axis],u[p][_.axis],f.entity.getLocalPosition().z);return a=t.width,t=t.height,{bounds:new b((Nd.x-a)*m.alignment.x+m.padding.x,(Nd.y-t)*m.alignment.y+m.padding.y,a,t)}}}function sn(t,e){as.call(this,t,e),this._orientation=0,this._reverseX=!1,this._reverseY=!0,this._alignment=new y(0,1),this._padding=new b,this._spacing=new y,this._heightFitting=this._widthFitting=Rd,this._wrap=!1,this._layoutCalculator=new tn,this._listenForReflowEvents(this.entity,"on"),this.entity.children.forEach(function(t){this._listenForReflowEvents(t,"on")}.bind(this)),this.entity.on("childinsert",this._onChildInsert,this),this.entity.on("childremove",this._onChildRemove,this),t.app.systems.element.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.element.on("beforeremove",this._onElementOrLayoutComponentRemove,this),t.app.systems.layoutchild.on("add",this._onElementOrLayoutComponentAdd,this),t.app.systems.layoutchild.on("beforeremove",this._onElementOrLayoutComponentRemove,this)}function nn(t){return t.element}function rn(t){return t.enabled&&t.element&&t.element.enabled}function an(t){var e="_"+t;Object.defineProperty(sn.prototype,t,{get:function(){return this[e]},set:function(t){this[e]!==t&&(this[e]=t,this._scheduleReflow())}})}function on(){this.enabled=!0}function hn(t){os.call(this,t),this.id="layoutgroup",this.ComponentType=sn,this.DataType=on,this.schema=zd,this._reflowQueue=[],this.on("beforeremove",this._onRemoveComponent,this),os.bind("postUpdate",this._onPostUpdate,this)}function ln(t,e){as.call(this,t,e),this._cookieAssetId=this._cookieAsset=null,this._cookieAssetAdd=!1,this._cookieMatrix=null}function cn(){for(var t,e=Yd,i=Kd,s=0;s<e.length;s++)t=i[s],this[e[s]]=t&&t.clone?t.clone():t}function dn(t){os.call(this,t),this.id="light",this.ComponentType=ln,this.DataType=cn,this.on("beforeremove",this._onRemoveComponent,this)}function un(t,e){as.call(this,t,e),this._type="asset",this._model=this._asset=null,this._mapping={},this._receiveShadows=this._castShadows=!0,this._materialAsset=null,this._material=t.defaultMaterial,this._castShadowsLightmap=!0,this._lightmapped=!1,this._lightmapSizeMultiplier=1,this._isStatic=!1,this._layers=[0],this._batchGroupId=-1,this._area=null,this._assetOld=0,this._materialEvents=null,this._clonedModel=this._dirtyMaterialAsset=this._dirtyModelAsset=!1,e.on("remove",this.onRemoveChild,this),e.on("insert",this.onInsertChild,this)}function pn(){this.enabled=!0}function fn(t){os.call(this,t),this.id="model",this.ComponentType=un,this.DataType=pn,this.schema=Zd,this.sphere=this.plane=this.cylinder=this.cone=this.capsule=this.box=null,this.defaultMaterial=t.scene.defaultMaterial,this.on("beforeremove",this.onRemove,this)}function mn(){this.rate=this.numParticles=1,this.rate2=null,this.startAngle=0,this.startAngle2=null,this.lifetime=50,this.emitterExtents=new v,this.emitterExtentsInner=new v,this.initialVelocity=this.emitterShape=this.emitterRadiusInner=this.emitterRadius=0,this.wrapBounds=new v,this.screenSpace=this.localSpace=!1,this.normalMapAsset=this.normalMap=this.colorMapAsset=this.colorMap=null,this.loop=!0,this.preWarm=!1,this.mode=this.sort=0,this.scene=null,this.halfLambert=this.lighting=!1,this.intensity=1,this.stretch=0,this.alignToMotion=!1,this.depthSoftening=0,this.mesh=this.meshAsset=null,this.noFog=this.depthWrite=!1,this.orientation=0,this.particleNormal=new v(0,1,0),this.animTilesY=this.animTilesX=1,this.animStartFrame=0,this.animNumAnimations=this.animNumFrames=1,this.animIndex=0,this.randomizeAnimIndex=!1,this.animSpeed=1,this.animLoop=!0,this.radialSpeedGraph2=this.radialSpeedGraph=this.rotationSpeedGraph2=this.rotationSpeedGraph=this.velocityGraph2=this.velocityGraph=this.localVelocityGraph2=this.localVelocityGraph=this.alphaGraph2=this.alphaGraph=this.colorGraph2=this.colorGraph=this.scaleGraph2=this.scaleGraph=null,this.blendType=2,this.model=null,this.enabled=!0,this.paused=!1,this.autoPlay=!0,this.layers=[0]}function _n(t){os.call(this,t),this.id="particlesystem",this.ComponentType=su,this.DataType=mn,this.schema=lu,this.propertyTypes={emitterExtents:"vec3",emitterExtentsInner:"vec3",particleNormal:"vec3",wrapBounds:"vec3",localVelocityGraph:"curveset",localVelocityGraph2:"curveset",velocityGraph:"curveset",velocityGraph2:"curveset",colorGraph:"curveset",colorGraph2:"curveset",alphaGraph:"curve",alphaGraph2:"curve",rotationSpeedGraph:"curve",rotationSpeedGraph2:"curve",radialSpeedGraph:"curve",radialSpeedGraph2:"curve",scaleGraph:"curve",scaleGraph2:"curve"},this.on("beforeremove",this.onBeforeRemove,this),os.bind("update",this.onUpdate,this)}function gn(t,e){this._constructor=t,this._pool=[],this._count=0,this._resize(e)}function yn(t,e){as.call(this,t,e),"undefined"==typeof Ammo||nu||(nu=new Ammo.btTransform,ru=new Ammo.btVector3,au=new Ammo.btVector3,ou=new Ammo.btQuaternion,hu=new Ammo.btVector3(0,0,0)),this.on("set_mass",this.onSetMass,this),this.on("set_linearDamping",this.onSetLinearDamping,this),this.on("set_angularDamping",this.onSetAngularDamping,this),this.on("set_linearFactor",this.onSetLinearFactor,this),this.on("set_angularFactor",this.onSetAngularFactor,this),this.on("set_friction",this.onSetFriction,this),this.on("set_restitution",this.onSetRestitution,this),this.on("set_type",this.onSetType,this),this.on("set_group",this.onSetGroupOrMask,this),this.on("set_mask",this.onSetGroupOrMask,this),this.on("set_body",this.onSetBody,this),this._linearVelocity=new v(0,0,0),this._angularVelocity=new v(0,0,0)}function vn(){this.enabled=!0,this.mass=1,this.angularDamping=this.linearDamping=0,this.linearFactor=new v(1,1,1),this.angularFactor=new v(1,1,1),this.friction=.5,this.restitution=0,this.type=ed,this.group=id,this.mask=sd,this.body=null,this.simulationEnabled=!1}function bn(t,e,i){this.entity=t,this.point=e,this.normal=i}function xn(t,e,i){0===arguments.length?(this.b=this.a=null,this.localPointA=new v,this.localPointB=new v,this.pointA=new v,this.pointB=new v,this.normal=new v):(this.a=t,this.b=e,this.localPointA=i.localPoint,this.localPointB=i.localPointOther,this.pointA=i.point,this.pointB=i.pointOther,this.normal=i.normal)}function Sn(t,e,i,s,n){0===arguments.length?(this.localPoint=new v,this.localPointOther=new v,this.point=new v,this.pointOther=new v,this.normal=new v):(this.localPoint=t,this.localPointOther=e,this.point=i,this.pointOther=s,this.normal=n)}function Tn(t,e){this.other=t,this.contacts=e}function wn(t){os.call(this,t),this.id="rigidbody",this._stats=t.stats.frame,this.ComponentType=yn,this.DataType=vn,this.singleContactResultPool=this.contactResultPool=this.contactPointPool=null,this.schema=fu,this.maxSubSteps=10,this.fixedTimeStep=1/60,this.gravity=new v(0,-9.81,0),this._dynamic=[],this._kinematic=[],this._triggers=[],this._compounds=[],this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)}function Mn(t,e){as.call(this,t,e),this._resolution=new y(640,320),this._referenceResolution=new y(640,320),this._scaleMode=mu,this.scale=1,this._scaleBlend=.5,this._priority=0,this.cull=this._screenSpace=!1,this._screenMatrix=new x,t.app.graphicsDevice.on("resizecanvas",this._onResize,this)}function Pn(){this.enabled=!0}function An(t){os.call(this,t),this.id="screen",this.ComponentType=Mn,this.DataType=Pn,this.schema=gu,this.windowResolution=new y,this._drawOrderSyncQueue=new h,this.app.graphicsDevice.on("resizecanvas",this._onResize,this),os.bind("update",this._onUpdate,this),this.on("beforeremove",this.onRemoveComponent,this)}function En(t){this.scriptType=t,this.index={}}function Cn(t){n.call(this);var e=this.constructor;this.app=t.app,this.entity=t.entity,this._enabled="boolean"!=typeof t.enabled||t.enabled,this._enabledOld=this.enabled,this.__destroyed=!1,this.__attributes={},this.__attributesRaw=t.attributes||{},this.__scriptType=e,this.__executionOrder=-1}function In(t,e){if(Ql.legacy)return null;if(In.reservedScripts[t])throw Error("script name: '"+t+"' is reserved, please change script name");var i=function(t){Cn.call(this,t)};return(i.prototype=Object.create(Cn.prototype)).constructor=i,i.extend=Cn.extend,i.attributes=new En(i),On(i,t,e),i}function On(t,e,i){if(!t.legacy){if("function"!=typeof t)throw Error("script class: '"+t+"' must be a constructor function (i.e. class).");if(!(t.prototype instanceof Cn))throw Error("script class: '"+Cn.__getScriptName(t)+"' does not extend pc.ScriptType.");if(e=e||t.__name||Cn.__getScriptName(t),In.reservedScripts[e])throw Error("script name: '"+e+"' is reserved, please change script name");t.__name=e,(i?i.scripts:sr.getApplication().scripts).add(t),xi._push(t)}}function Rn(t){this._sortBy=t.sortBy,this.items=[],this.length=0,this.loopIndex=-1,this._sortHandler=this._doSort.bind(this)}function Dn(t,e){as.call(this,t,e),this._scripts=[],this._updateList=new Rn({sortBy:"__executionOrder"}),this._postUpdateList=new Rn({sortBy:"__executionOrder"}),this._scriptsIndex={},this._destroyedScripts=[],this._destroyed=!1,this._scriptsData=null,this._enabled=this._oldState=!0,this._isLoopingThroughScripts=this._beingEnabled=!1,this._executionOrder=-1,this.on("set_enabled",this._onSetEnabled,this)}function Ln(){this.enabled=!0}function Fn(t){os.call(this,t),this.id="script",this.ComponentType=Dn,this.DataType=Ln,this._components=new Rn({sortBy:"_executionOrder"}),this._enabledComponents=new Rn({sortBy:"_executionOrder"}),this.preloading=!0,this.on("beforeremove",this._onBeforeRemove,this),os.bind("initialize",this._onInitialize,this),os.bind("postInitialize",this._onPostInitialize,this),os.bind("update",this._onUpdate,this),os.bind("postUpdate",this._onPostUpdate,this)}function Bn(t,e){as.call(this,t,e),this.on("set_scripts",this.onSetScripts,this)}function Nn(){this.scripts=[],this.enabled=!0,this.instances={},this._instances={},this.runInTools=!1,this.attributes={},this.areScriptsLoaded=this.postInitialized=this.initialized=!1}function kn(t,e){if(n.call(this),!(t&&t instanceof Ys))throw Error("Element was null or not an ElementComponent");if(e&&"x"!==e&&"y"!==e)throw Error("Unrecognized axis: "+e);this._element=t,this._app=t.system.app,this._axis=e||null,this._enabled=!0,this._dragScale=new v,this._dragStartMousePosition=new v,this._dragStartHandlePosition=new v,this._deltaMousePosition=new v,this._deltaHandlePosition=new v,this._isDragging=!1,this._toggleLifecycleListeners("on")}function zn(t,e){as.call(this,t,e),this._viewportReference=new Es(this,"viewportEntity",{"element#gain":this._onViewportElementGain,"element#resize":this._onSetContentOrViewportSize}),this._contentReference=new Es(this,"contentEntity",{"element#gain":this._onContentElementGain,"element#lose":this._onContentElementLose,"element#resize":this._onSetContentOrViewportSize}),this._scrollbarUpdateFlags={},this._scrollbarReferences={},this._scrollbarReferences[0]=new Es(this,"horizontalScrollbarEntity",{"scrollbar#set:value":this._onSetHorizontalScrollbarValue,"scrollbar#gain":this._onHorizontalScrollbarGain}),this._scrollbarReferences[1]=new Es(this,"verticalScrollbarEntity",{"scrollbar#set:value":this._onSetVerticalScrollbarValue,"scrollbar#gain":this._onVerticalScrollbarGain}),this._prevContentSizes={},this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._scroll=new y,this._velocity=new v,this._dragStartPosition=new v,this._disabledContentInput=!1,this._disabledContentInputEntities=[],this._toggleLifecycleListeners("on",t),this._toggleElementListeners("on")}function Un(){this.enabled=!0}function Vn(t,e){as.call(this,t,e),this._app=t.app,this._handleReference=new Es(this,"handleEntity",{"element#gain":this._onHandleElementGain,"element#lose":this._onHandleElementLose,"element#set:anchor":this._onSetHandleAlignment,"element#set:margin":this._onSetHandleAlignment,"element#set:pivot":this._onSetHandleAlignment}),this._toggleLifecycleListeners("on")}function jn(){this.enabled=!0}function Gn(t){os.call(this,t),this.id="scrollbar",this.ComponentType=Vn,this.DataType=jn,this.schema=zu,this.on("beforeremove",this._onRemoveComponent,this)}function Hn(t,e,i){n.call(this),this._component=t,this._assets=t.system.app.assets,this._manager=t.system.manager,this.name=e||"Untitled",i=i||{},this._volume=void 0!==i.volume?oa.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._duration=0<i.duration?i.duration:null,this._startTime=Math.max(0,Number(i.startTime)||0),this._overlap=!!i.overlap,this._autoPlay=!!i.autoPlay,this._lastNode=this._firstNode=null,this._asset=i.asset,this._asset instanceof Fe&&(this._asset=this._asset.id),this._onInstancePlayHandler=this._onInstancePlay.bind(this),this._onInstancePauseHandler=this._onInstancePause.bind(this),this._onInstanceResumeHandler=this._onInstanceResume.bind(this),this._onInstanceStopHandler=this._onInstanceStop.bind(this),this._onInstanceEndHandler=this._onInstanceEnd.bind(this),this.instances=[]}function Wn(t,e){as.call(this,t,e),this._pitch=this._volume=1,this._positional=!0,this._refDistance=1,this._maxDistance=1e4,this._rollOffFactor=1,this._distanceModel="linear",this._slots={},this._playingBeforeDisable={}}function Xn(t,e){Object.defineProperty(Wn.prototype,t,{get:function(){return this[e]},set:function(i){this[e]=i;var s,n=this._slots;for(s in n){var r=n[s];if(!r.overlap)for(var a=0,o=(r=r.instances).length;a<o;a++)r[a][t]=i}}})}function qn(t,e){Object.defineProperty(Wn.prototype,t,{get:function(){return this[e]},set:function(i){this[e]=i;var s,n=this._slots;for(s in n){var r=n[s];if(!r.overlap)for(var a=r.instances,o=0,h=a.length;o<h;o++)a[o][t]=r[t]*i}}})}function Yn(){this.enabled=!0}function Kn(t,e){n.call(this),this._component=t,this._frame=0,this._spriteAsset=this._sprite=null,this.spriteAsset=e.spriteAsset,this.name=e.name,this.fps=e.fps||0,this.loop=e.loop||!1,this._paused=this._playing=!1,this._time=0}function $n(){this.enabled=!0}function Zn(t){os.call(this,t),this.id="sprite",this.ComponentType=Hu,this.DataType=$n,this.schema=Wu,this._default9SlicedMaterialTiledMode=this._default9SlicedMaterialSlicedMode=this._defaultMaterial=this._defaultTexture=null,os.bind("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)}function Qn(t,e){as.call(this,t,e),this._oldState=!0,this._size=new v,this.on("set_enabled",this._onSetEnabled,this)}function Jn(){this.enabled=!0}function tr(t){this.frame={fps:0,ms:0,dt:0,updateStart:0,updateTime:0,renderStart:0,renderTime:0,physicsStart:0,physicsTime:0,cullTime:0,sortTime:0,skinTime:0,morphTime:0,instancingTime:0,triangles:0,otherPrimitives:0,shaders:0,materials:0,cameras:0,shadowMapUpdates:0,shadowMapTime:0,depthMapTime:0,forwardTime:0,_timeToCountFrames:0,_fpsAccum:0},this.drawCalls={forward:0,depth:0,shadow:0,immediate:0,misc:0,total:0,skinned:0,instanced:0,removedByInstancing:0},this.misc={renderTargetCreationTime:0},this.particles={updatesPerFrame:0,_updatesPerFrame:0,frameTime:0,_frameTime:0},this.vram=t._vram,this.shaders=t._shaderStats,Object.defineProperty(this.vram,"totalUsed",{get:function(){return this.tex+this.vb+this.ib}}),Object.defineProperty(this,"scene",{get:function(){return sr._currentApplication.scene._stats}}),Object.defineProperty(this,"lightmapper",{get:function(){return sr._currentApplication.lightmapper._stats}}),Object.defineProperty(this,"batcher",{get:function(){return sr._currentApplication.batcher._stats}})}function er(t,e){this.name=t,this.url=e}function ir(t){this._app=t,this._list=[],this._index={},this._urlIndex={}}function sr(e,i){n.call(this),i=i||{},console.log("Powered by PlayCanvas 1.35.0 100604b"),sr._applications[e.id]=this,sr._currentApplication=this,t.app=this,this._time=0,this.timeScale=1,this.maxDeltaTime=.1,this.frame=0,this.autoRender=!0,this.renderNextFrame=!1,this.useLegacyScriptAttributeCloning=Ql.legacy,this._librariesLoaded=!1,this._fillMode=gc,this._resolutionMode=yc,this._allowResize=!0,this.context=this,i.graphicsDeviceOptions||(i.graphicsDeviceOptions={}),i.graphicsDeviceOptions.xrCompatible=!0,this.graphicsDevice=new mp(e,i.graphicsDeviceOptions),this.stats=new tr(this.graphicsDevice),this._soundManager=new fe(i),this.loader=new yi(this),this._entityIndex={},this.scene=new ce,this.root=new xe(this),this.root._enabledInHierarchy=!0,this._enableList=[],this._enableList.size=0,this.assets=new Xi(this.loader),i.assetPrefix&&(this.assets.prefix=i.assetPrefix),this.bundles=new qi(this.assets),this.enableBundles="undefined"!=typeof TextDecoder,this.scriptsOrder=i.scriptsOrder||[],this.scripts=new Yi(this),this.i18n=new De(this),this.scenes=new ir(this);var s=this;this.defaultLayerWorld=new It({name:"World",id:0}),this.graphicsDevice.webgl2?(this.defaultLayerDepth=new It({enabled:!1,name:"Depth",id:1,onEnable:function(){if(!this.renderTarget){var t=new nt(s.graphicsDevice,{format:17,width:s.graphicsDevice.width,height:s.graphicsDevice.height});t.name="rt-depth2",t.minFilter=0,t.magFilter=0,t.addressU=1,t.addressV=1,this.renderTarget=new gp({colorBuffer:null,depthBuffer:t,autoResolve:!1}),s.graphicsDevice.scope.resolve("uDepthMap").setValue(t)}},onDisable:function(){this.renderTarget&&(this.renderTarget._depthBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPreRenderOpaque:function(t){var e=s.graphicsDevice.gl;this.srcFbo=e.getParameter(e.FRAMEBUFFER_BINDING),this.renderTarget&&this.renderTarget.width===s.graphicsDevice.width&&this.renderTarget.height===s.graphicsDevice.height||(this.onDisable(),this.onEnable()),this.oldClear=this.cameras[t].camera._clearOptions,this.cameras[t].camera._clearOptions=this.depthClearOptions},onPostRenderOpaque:function(t){this.renderTarget&&(this.cameras[t].camera._clearOptions=this.oldClear,t=s.graphicsDevice.gl,s.graphicsDevice.setRenderTarget(this.renderTarget),s.graphicsDevice.updateBegin(),t.bindFramebuffer(t.READ_FRAMEBUFFER,this.srcFbo),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,this.renderTarget._glFrameBuffer),t.blitFramebuffer(0,0,this.renderTarget.width,this.renderTarget.height,0,0,this.renderTarget.width,this.renderTarget.height,t.DEPTH_BUFFER_BIT,t.NEAREST))}}),this.defaultLayerDepth.depthClearOptions={flags:0}):(this.defaultLayerDepth=new It({enabled:!1,name:"Depth",id:1,shaderPass:2,onEnable:function(){if(!this.renderTarget){var t=new nt(s.graphicsDevice,{format:7,width:s.graphicsDevice.width,height:s.graphicsDevice.height});t.name="rt-depth1",t.minFilter=0,t.magFilter=0,t.addressU=1,t.addressV=1,this.renderTarget=new gp(s.graphicsDevice,t,{depth:!0,stencil:s.graphicsDevice.supportsStencil}),s.graphicsDevice.scope.resolve("uDepthMap").setValue(t)}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onPostCull:function(t){var e=this.instances.visibleOpaque[t],i=e.list,n=0,r=s.scene.layers.layerList,a=s.scene.layers.subLayerEnabled,o=s.scene.layers.subLayerList,h=s.defaultLayerWorld.renderTarget;t=this.cameras[t];for(var l,c,d,u,p=0;p<r.length&&(l=r[p])!==this;p++)if(l.renderTarget===h&&l.enabled&&a[p]&&!(0>(c=l.cameras.indexOf(t))))for(c=o[p]?l.instances.visibleTransparent[c]:l.instances.visibleOpaque[c],d=c.length,c=c.list,l=0;l<d;l++)(u=c[l]).material&&u.material.depthWrite&&!u._noDepthDrawGl1&&(i[n]=u,n++);e.length=n},onPreRenderOpaque:function(t){this.renderTarget&&this.renderTarget.width===s.graphicsDevice.width&&this.renderTarget.height===s.graphicsDevice.height||(this.onDisable(),this.onEnable()),this.oldClear=this.cameras[t].camera._clearOptions,this.cameras[t].camera._clearOptions=this.rgbaDepthClearOptions},onDrawCall:function(){s.graphicsDevice.setColorWrite(!0,!0,!0,!0)},onPostRenderOpaque:function(t){this.renderTarget&&(this.cameras[t].camera._clearOptions=this.oldClear)}}),this.defaultLayerDepth.rgbaDepthClearOptions={color:[254/255,254/255,254/255,254/255],depth:1,flags:3}),this.defaultLayerSkybox=new It({enabled:!1,name:"Skybox",id:2,opaqueSortMode:0}),this.defaultLayerUi=new It({enabled:!0,name:"UI",id:4,transparentSortMode:1,passThrough:!1}),this.defaultLayerImmediate=new It({enabled:!0,name:"Immediate",id:3,opaqueSortMode:0,passThrough:!0}),this.defaultLayerComposition=new Ut,this.defaultLayerComposition.pushOpaque(this.defaultLayerWorld),this.defaultLayerComposition.pushOpaque(this.defaultLayerDepth),this.defaultLayerComposition.pushOpaque(this.defaultLayerSkybox),this.defaultLayerComposition.pushTransparent(this.defaultLayerWorld),this.defaultLayerComposition.pushOpaque(this.defaultLayerImmediate),this.defaultLayerComposition.pushTransparent(this.defaultLayerImmediate),this.defaultLayerComposition.pushTransparent(this.defaultLayerUi),this.scene.layers=this.defaultLayerComposition,this._immediateLayer=this.defaultLayerImmediate,this.scene.on("set:layers",function(t,e){t=e.layerList;for(var i=0;i<t.length;i++)switch(e=t[i],e.id){case 1:e.onEnable=s.defaultLayerDepth.onEnable,e.onDisable=s.defaultLayerDepth.onDisable,e.onPreRenderOpaque=s.defaultLayerDepth.onPreRenderOpaque,e.onPostRenderOpaque=s.defaultLayerDepth.onPostRenderOpaque,e.depthClearOptions=s.defaultLayerDepth.depthClearOptions,e.rgbaDepthClearOptions=s.defaultLayerDepth.rgbaDepthClearOptions,e.shaderPass=s.defaultLayerDepth.shaderPass,e.onPostCull=s.defaultLayerDepth.onPostCull,e.onDrawCall=s.defaultLayerDepth.onDrawCall;break;case 4:e.passThrough=s.defaultLayerUi.passThrough;break;case 3:e.passThrough=s.defaultLayerImmediate.passThrough}}),this.renderer=new Ft(this.graphicsDevice),this.renderer.scene=this.scene,this.lightmapper=new jt(this.graphicsDevice,this.root,this.scene,this.renderer,this.assets),this.once("prerender",this._firstBake,this),this.batcher=new vt(this.graphicsDevice,this.root,this.scene),this.once("prerender",this._firstBatch,this),this.keyboard=i.keyboard||null,this.mouse=i.mouse||null,this.touch=i.touch||null,this.gamepads=i.gamepads||null,(this.elementInput=i.elementInput||null)&&(this.elementInput.app=this),this.vr=null,this.xr=new rs(this),this.elementInput&&this.elementInput.attachSelectEvents(),this._inTools=!1,this._skyboxLast=0,this._scriptPrefix=i.scriptPrefix||"",this.enableBundles&&this.loader.addHandler("bundle",new qe(this.assets)),this.loader.addHandler("animation",new Ne),this.loader.addHandler("animclip",new ke),this.loader.addHandler("animstategraph",new Ue),this.loader.addHandler("model",new gi(this.graphicsDevice,this.scene.defaultMaterial)),this.loader.addHandler("material",new di(this)),this.loader.addHandler("texture",new Wi(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("text",new Ci),this.loader.addHandler("json",new oi),this.loader.addHandler("audio",new je(this._soundManager)),this.loader.addHandler("script",new xi(this)),this.loader.addHandler("scene",new vi(this)),this.loader.addHandler("cubemap",new Ze(this.graphicsDevice,this.assets,this.loader)),this.loader.addHandler("html",new ai),this.loader.addHandler("css",new $e),this.loader.addHandler("shader",new Si),this.loader.addHandler("hierarchy",new ri(this)),this.loader.addHandler("scenesettings",new bi(this)),this.loader.addHandler("folder",new Qe),this.loader.addHandler("font",new ei(this.loader)),this.loader.addHandler("binary",new Ge),this.loader.addHandler("textureatlas",new Oi(this.loader)),this.loader.addHandler("sprite",new wi(this.assets,this.graphicsDevice)),this.loader.addHandler("template",new Ei(this)),this.loader.addHandler("container",new Ke(this.graphicsDevice,this.scene.defaultMaterial)),this.systems=new Bs,this.systems.add(new wn(this)),this.systems.add(new _d(this)),this.systems.add(new ps(this)),this.systems.add(new xs(this)),this.systems.add(new fn(this)),this.systems.add(new $c(this)),this.systems.add(new dn(this)),Ql.legacy?this.systems.add(new Au(this)):this.systems.add(new Fn(this)),this.systems.add(new As(this,this._soundManager)),this.systems.add(new Gu(this,this._soundManager)),this.systems.add(new ws(this,this._soundManager)),this.systems.add(new _n(this)),this.systems.add(new An(this)),this.systems.add(new $s(this)),this.systems.add(new Os(this)),this.systems.add(new ku(this)),this.systems.add(new Gn(this)),this.systems.add(new Zn(this)),this.systems.add(new hn(this)),this.systems.add(new Od(this)),this.systems.add(new qu(this)),this._visibilityChangeHandler=this.onVisibilityChange.bind(this),"undefined"!=typeof document&&(void 0!==document.hidden?(this._hiddenAttr="hidden",document.addEventListener("visibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.mozHidden?(this._hiddenAttr="mozHidden",document.addEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.msHidden?(this._hiddenAttr="msHidden",document.addEventListener("msvisibilitychange",this._visibilityChangeHandler,!1)):void 0!==document.webkitHidden&&(this._hiddenAttr="webkitHidden",document.addEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1))),this.meshInstanceArray=[],this.tick=Qu(this)}function nr(){this.name="Untitled",this.id=Ju++,this._shader=null,this.variants={},this.parameters={},this.alphaTest=0,this.blend=this.alphaToCoverage=!1,this.blendSrc=1,this.blendEquation=this.blendDst=0,this.separateAlphaBlend=!1,this.blendSrcAlpha=1,this.blendAlphaEquation=this.blendDstAlpha=0,this.cull=1,this.depthWrite=this.depthTest=!0,this.stencilBack=this.stencilFront=null,this.slopeDepthBias=this.depthBias=0,this.alphaWrite=this.blueWrite=this.greenWrite=this.redWrite=!0,this.meshInstances=[],this._shaderVersion=0,this._scene=null,this._dirtyBlend=!1,this.dirty=!0}function rr(){this._mapXForms=null}function ar(){nr.call(this),this._assetReferences={},this._validator=null,this.shaderOptBuilder=new rr,this.reset()}function or(t){this._device=t,this._cache={},this._generators={},this._precached=this._isClearingCache=!1,this._programsCollection=[],this._defaultStdMatOption={},this._defaultStdMatOptionMin={};var e=new ar;e.shaderOptBuilder.updateRef(this._defaultStdMatOption,t,{},e,null,[],0,null,null),e.shaderOptBuilder.updateMinRef(this._defaultStdMatOptionMin,t,{},e,null,[],3,null,null)}function hr(){this.revision=this.globalId=0}function lr(){pp++,this.version=new hr,this.version.globalId=pp}function cr(t){this.name=t,this.value=null,this.versionObject=new lr}function dr(t){this.name=t,this.variables={},this.namespaces={}}function ur(t,e,i,s){if(this.locationId=s,this.scopeId=t.scope.resolve(e),this.version=new hr,"[0]"===e.substr(e.length-3))switch(i){case 2:i=17;break;case 3:i=21;break;case 4:i=22;break;case 5:i=23}this.dataType=i,this.value=[null,null,null,null],this.array=[]}function pr(t,e){var i=!0,s=t.createTexture();return t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,null),e=t.createFramebuffer(),t.bindFramebuffer(t.FRAMEBUFFER,e),t.framebufferTexture2D(t.FRAMEBUFFER,t.COLOR_ATTACHMENT0,t.TEXTURE_2D,s,0),t.checkFramebufferStatus(t.FRAMEBUFFER)!==t.FRAMEBUFFER_COMPLETE&&(i=!1),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(s),t.bindFramebuffer(t.FRAMEBUFFER,null),t.deleteFramebuffer(e),i}function fr(t,e,i){var s=e._colorBuffer;if(7==s.format){var n=new Uint8Array(s.width*s.height*4),r=t.gl;t.setFramebuffer(e._glFrameBuffer),r.readPixels(0,0,s.width,s.height,r.RGBA,r.UNSIGNED_BYTE,n),s._levels||(s._levels=[]),s._levels[0]||(s._levels[0]=[]),s._levels[0][i]=n}}function mr(t,e){return Math.atan2(t*e,Math.sqrt(t*t+e*e+1))}function _r(t,e){var i,s=t.width;if(7!=t.format)console.error("ERROR: SH: cubemap must be RGBA8");else{if(t._levels[0]){if(!t._levels[0][0].length){if(!(t._levels[0][0]instanceof HTMLImageElement))return void console.error("ERROR: SH: cubemap must be composed of arrays or images");var n=sr.getApplication().graphicsDevice,r=n.gl,a=st(n,Ra.fullscreenQuadVS,Ra.fullscreenQuadPS,"fsQuadSimple"),o=n.scope.resolve("source");for(i=0;6>i;i++){var h=t._levels[0][i],l=new nt(n,{cubemap:!1,type:"default",format:t.format,width:s,height:s,mipmaps:!1});l.name="prefiltered-cube",l._levels[0]=h,l.upload(),(h=new nt(n,{cubemap:!1,type:"default",format:t.format,width:s,height:s,mipmaps:!1})).name="prefiltered-cube",h=new gp(n,h,{depth:!1}),o.setValue(l),X(n,h,a);var c=new Uint8Array(s*s*4);r.bindFramebuffer(r.FRAMEBUFFER,h._glFrameBuffer),r.readPixels(0,0,l.width,l.height,r.RGBA,r.UNSIGNED_BYTE,c),t._levels[0][i]=c}}for(a=[],r=0;r<s;r++)for(n=0;n<s;n++)a[r*s+n]=new v(n/(s-1)*2-1,r/(s-1)*2-1,1).normalize();for(o=new Float32Array(27),i=h=0;6>i;i++)for(r=0;r<s;r++)for(n=0;n<s;n++){l=r*s+n;var d=r,u=s,p=(2*((c=n)+.5)/u-1)*(1-1/u),f=(2*(d+.5)/u-1)*(1-1/u),m=1/u,_=p-m,g=f-m;if(p+=m,f+=m,_=mr(_,g)-mr(_,f)-mr(p,g)+mr(p,f),0===c&&0===d||c===u-1&&0===d||0===c&&d===u-1||c===u-1&&d===u-1?_/=3:0!==c&&0!==d&&c!==u-1&&d!==u-1||(_*=.5),d=4*(c=_)/17,u=8*c/17,_=15*c/17,g=5*c/68,f=15*c/68,m=a[l],0==i)var y=m.z,b=-m.y,x=-m.x;else 1==i?(y=-m.z,b=-m.y,x=m.x):2==i?(y=m.x,b=m.z,x=m.y):3==i?(y=m.x,b=-m.z,x=-m.y):4==i?(y=m.x,b=-m.y,x=m.z):5==i&&(y=-m.x,b=-m.y,x=-m.z);for(e||(y=-y),p=t._levels[0][i][4*l+3]/255,m=0;3>m;m++){var S=t._levels[0][i][4*l+m]/255;"rgbm"===t.type?(S*=8*p,S*=S):S=Math.pow(S,2.2),o[0+m]+=S*d,o[3+m]+=S*u*y,o[6+m]+=S*u*b,o[9+m]+=S*u*x,o[12+m]+=S*_*y*x,o[15+m]+=S*_*x*b,o[18+m]+=S*_*b*y,o[21+m]+=S*g*(3*x*x-1),o[24+m]+=S*f*(y*y-b*b),h+=c}}for(m=0;m<o.length;m++)o[m]*=4*Math.PI/h;return o}console.error("ERROR: SH: cubemap must be synced to CPU")}}function gr(t){this.device=t,this.depthMap=this.shader=null,this.vertexBuffer=yr(t),this.needsDepthBuffer=!1}function yr(t){var e=new O(t,[{semantic:"POSITION",components:2,type:6}]);return(e=new W(t=new C(t,e,4))).element.POSITION.set(-1,-1),e.next(),e.element.POSITION.set(1,-1),e.next(),e.element.POSITION.set(-1,1),e.next(),e.element.POSITION.set(1,1),e.end(),t}function vr(t,e,i,s,n){var r=t.getRenderTarget();t.setRenderTarget(e),t.updateBegin();var a=null!==e?e.width:t.width,o=null!==e?e.height:t.height,h=0,l=0;n&&(h=n.x*a,l=n.y*o,a*=n.z,o*=n.w),n=t.vx,e=t.vy;var c=t.vw,d=t.vh;t.setViewport(h,l,a,o);var u=t.sx,p=t.sy,f=t.sw,m=t.sh;t.setScissor(h,l,a,o),a=t.getBlending(),o=t.getDepthTest(),h=t.getDepthWrite(),l=t.getCullMode();var _=t.writeRed,g=t.writeGreen,y=t.writeBlue,v=t.writeAlpha;t.setBlending(!1),t.setDepthTest(!1),t.setDepthWrite(!1),t.setCullMode(0),t.setColorWrite(!0,!0,!0,!0),t.setVertexBuffer(i,0),t.setShader(s),t.draw(vp),t.setBlending(a),t.setDepthTest(o),t.setDepthWrite(h),t.setCullMode(l),t.setColorWrite(_,g,y,v),t.updateEnd(),t.setRenderTarget(r),t.updateBegin(),t.setViewport(n,e,c,d),t.setScissor(u,p,f,m)}function br(t,e){e=e||3,this.device=t.device;var i=this.device.gl;this._inputBuffer=t,3===e&&t.usage!==e&&(i.bindBuffer(i.ARRAY_BUFFER,t.bufferId),i.bufferData(i.ARRAY_BUFFER,t.storage,i.DYNAMIC_COPY)),this._outputBuffer=new C(t.device,t.format,t.numVertices,e,t.storage)}function xr(){nr.call(this)}function Sr(t,e,i){t instanceof mp&&(t=sr.getApplication()),this.app=t;var s=this.device=t.graphicsDevice;this.library=s.getProgramLibrary(),this.pickColor=new Float32Array(4),this.pickColor[3]=1,this.scene=null,this.drawCalls=[],this.layerComp=this.layer=null,this.clearOptions={color:[1,1,1,1],depth:1,flags:3};var n=this;this._clearDepthOptions={depth:1,flags:2},this.clearDepthCommand=new ct(0,0,function(){s.clear(n._clearDepthOptions)}),this.resize(e,i),this._ignoreOpacityFor=null}function Tr(){}function wr(t,e){e?(this.key=e.keyCode,this.element=e.target,this.event=e):this.event=this.element=this.key=null}function Mr(t){return bp.key=t.keyCode,bp.element=t.target,bp.event=t,bp}function Pr(t){return"string"==typeof t?t.toUpperCase().charCodeAt(0):t}function Ar(t,e){n.call(this),e=e||{},this._element=null,this._keyDownHandler=this._handleKeyDown.bind(this),this._keyUpHandler=this._handleKeyUp.bind(this),this._keyPressHandler=this._handleKeyPress.bind(this),this._keymap={},this._lastmap={},t&&this.attach(t),this.preventDefault=e.preventDefault||!1,this.stopPropagation=e.stopPropagation||!1}function Er(t,e){var i={x:0,y:0};if(e){if(e instanceof Er)throw Error("Expected MouseEvent");i=t._getTargetCoords(e)}else e={};if(i)this.x=i.x,this.y=i.y;else{if(!Cr.isPointerLocked())return;this.y=this.x=0}this.wheelDelta=0,"wheel"===e.type&&(0<e.deltaY?this.wheelDelta=1:0>e.deltaY&&(this.wheelDelta=-1)),Cr.isPointerLocked()?(this.dx=e.movementX||e.webkitMovementX||e.mozMovementX||0,this.dy=e.movementY||e.webkitMovementY||e.mozMovementY||0):(this.dx=this.x-t._lastX,this.dy=this.y-t._lastY),this.button="mousedown"===e.type||"mouseup"===e.type?e.button:-1,this.buttons=t._buttons.slice(0),this.element=e.target,this.ctrlKey=e.ctrlKey||!1,this.altKey=e.altKey||!1,this.shiftKey=e.shiftKey||!1,this.metaKey=e.metaKey||!1,this.event=e}function Cr(t){n.call(this),this._lastY=this._lastX=0,this._buttons=[!1,!1,!1],this._lastbuttons=[!1,!1,!1],this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._contextMenuHandler=function(t){t.preventDefault()},this._target=null,this._attached=!1,this.attach(t)}function Ir(t,e){e=e||{},this._keyboard=e.keyboard||null,this._mouse=e.mouse||null,this._gamepads=e.gamepads||null,this._element=null,this._actions={},this._axes={},this._axesValues={},t&&this.attach(t)}function Or(t,e,i){this.event=t,this.element=e,this.camera=i,this._stopPropagation=!1}function Rr(t,e,i,s,n,r,a){Or.call(this,t,e,i),this.x=s,this.y=n,this.ctrlKey=t.ctrlKey||!1,this.altKey=t.altKey||!1,this.shiftKey=t.shiftKey||!1,this.metaKey=t.metaKey||!1,this.button=t.button,Cr.isPointerLocked()?(this.dx=t.movementX||t.webkitMovementX||t.mozMovementX||0,this.dy=t.movementY||t.webkitMovementY||t.mozMovementY||0):(this.dx=s-r,this.dy=n-a),this.wheelDelta=0,"wheel"===t.type&&(0<t.deltaY?this.wheelDelta=1:0>t.deltaY&&(this.wheelDelta=-1))}function Dr(t,e,i,s,n,r){Or.call(this,t,e,i),this.touches=t.touches,this.changedTouches=t.changedTouches,this.x=s,this.y=n,this.touch=r}function Lr(t,e,i,s){Or.call(this,t,e,i),this.inputSource=s}function Fr(t,e){this._app=null,this._attached=!1,this._target=null,this._enabled=!0,this._lastY=this._lastX=0,this._upHandler=this._handleUp.bind(this),this._downHandler=this._handleDown.bind(this),this._moveHandler=this._handleMove.bind(this),this._wheelHandler=this._handleWheel.bind(this),this._touchstartHandler=this._handleTouchStart.bind(this),this._touchcancelHandler=this._touchendHandler=this._handleTouchEnd.bind(this),this._touchmoveHandler=this._handleTouchMove.bind(this),this._sortHandler=this._sortElements.bind(this),this._elements=[],this._pressedElement=this._hoveredElement=null,this._touchedElements={},this._touchesForWhichTouchLeaveHasFired={},this._selectedElements={},this._selectedPressedElements={},this._useMouse=!e||!1!==e.useMouse,this._useTouch=!e||!1!==e.useTouch,this._useXr=!e||!1!==e.useXr,this._selectEventsAttached=!1,sa.touch&&(this._clickedEntities={}),this.attach(t)}function Br(){this.gamepadsSupported=!!navigator.getGamepads||!!navigator.webkitGetGamepads,this.current=[],this.previous=[],this.deadZone=.25}function Nr(t){var e=Ur(t);this.id=t.identifier,this.x=e.x,this.y=e.y,this.target=t.target,this.touch=t}function kr(t,e){if(this.element=e.target,this.event=e,this.touches=[],this.changedTouches=[],e){var i=e.touches.length;for(t=0;t<i;t++)this.touches.push(new Nr(e.touches[t]));for(i=e.changedTouches.length,t=0;t<i;t++)this.changedTouches.push(new Nr(e.changedTouches[t]))}}function zr(t){n.call(this),this._element=null,this._startHandler=this._handleTouchStart.bind(this),this._endHandler=this._handleTouchEnd.bind(this),this._moveHandler=this._handleTouchMove.bind(this),this._cancelHandler=this._handleTouchCancel.bind(this),this.attach(t)}function Ur(t){for(var e=0,i=0,s=t.target;!(s instanceof HTMLElement);)s=s.parentNode;do{e+=s.offsetLeft-s.scrollLeft,i+=s.offsetTop-s.scrollTop,s=s.offsetParent}while(s);return{x:t.pageX-e,y:t.pageY-i}}function Vr(t,e){n.call(this),this.type="bitmap",this.app=t,this.intensity=0,e=e||{},this.fontWeight=e.fontWeight||"normal",this.glyphSize=this.fontSize=parseInt(e.fontSize,10),this.fontName=e.fontName||"Arial",this.color=e.color||new o(1,1,1),this.padding=e.padding||0,t=4096<e.width?4096:e.width||512;var i=4096<e.height?4096:e.height||512;(e=document.createElement("canvas")).height=i,e.width=t,(t=new nt(this.app.graphicsDevice,{format:7,autoMipmap:!0})).name="font",t.setSource(e),t.minFilter=5,t.magFilter=1,t.addressU=1,t.addressV=1,this.textures=[t],this.chars="",this.data={}}function jr(){}function Gr(t,e,i){(e=new nt(e,{format:i,width:e.width,height:e.height})).name="posteffect-pass",e.minFilter=0,e.magFilter=0,e.addressU=1,e.addressV=1,Kp[t]._colorBuffer=e}function Hr(t){t=t.match(nf)||[];for(var e,i,s=[],n=0;n<t.length;n++)e=t[n].search(rf),i=t[n].search(af),"uColorBuffer"!==(e=t[n].substr(e,i-e))&&s.push(e);return s}function Wr(t,e){this.app=t,this.srcRenderTarget=e.srcRenderTarget,this.hdr=e.hdr,this.blending=e.blending,this.shader=e.shader,this.setup=e.setup;var i=this,s=t.graphicsDevice;if(this.layer=new It({opaqueSortMode:0,transparentSortMode:0,passThrough:!0,name:e.name,onPostRender:function(){if(i.srcRenderTarget?(Zp.x=i.srcRenderTarget.width,Zp.y=i.srcRenderTarget.height,Zp.z=1/i.srcRenderTarget.width,Zp.w=1/i.srcRenderTarget.height):(Zp.x=s.width,Zp.y=s.height,Zp.z=1/s.width,Zp.w=1/s.height),Qp[0]=Zp.x,Qp[1]=Zp.y,Qp[2]=Zp.z,Qp[3]=Zp.w,Yp.setValue(Qp),this._postEffectCombined&&0>this._postEffectCombined)i.setup&&i.setup(s,i,Zp,null,this.renderTarget);else{var e=this._postEffectCombinedSrc?this._postEffectCombinedSrc:i.srcRenderTarget?i.srcRenderTarget:Kp[this._backbufferRtId];1<e._samples&&e.resolve(!0,!1);var n=e._colorBuffer;if(n.magFilter=(this._postEffectCombinedShader?this._postEffectCombinedBilinear:this.postEffectBilinear)?1:0,$p.setValue(n),i.setup&&i.setup(s,i,Zp,e,this.renderTarget),(e=this._postEffectCombinedShader?this._postEffectCombinedShader:this.shader)&&X(s,this.renderTarget,e,null,null,i.blending),!i.srcRenderTarget)for(e=t.scene.layers.layerList,n=0;n<e.length&&e[n]!==i.layer;n++)e[n].renderTarget!==Kp[0]&&e[n].renderTarget!==Kp[1]||(e[n].renderTarget=null)}}}),this.layer._generateCameraHash(),this.layer.isPostEffect=!0,this.layer.unmodifiedUvs=e.unmodifiedUvs,this.layer.postEffectBilinear=e.bilinear,this.layer.postEffect=this,this.layer.shader=e.shader,this.layer.renderTarget=e.destRenderTarget,!$p){$p=s.scope.resolve("uColorBuffer"),Yp=s.scope.resolve("uScreenSize"),e=s.supportsMsaa?4:1;for(var n=0;2>n;n++)Kp[n]=new gp({depth:!0,stencil:s.supportsStencil,samples:e,autoResolve:!1}),Kp[n].name="backbuffer"+n;t.on("prerender",function(){var e,i=t.scene.layers.layerList,n=0,r=0;sf=ef=tf=!1;var a=7;if(t.scene.layers._dirty){var o=0;for(e=0;e<i.length;e++){var h,l=!1;if((h=i[e].isPostEffect)&&!(h=0===o)&&(h=i[e].unmodifiedUvs&&i[e].shader)){t:{var c,d,u,p=i,f=Jp,m=o,_=Hr(i[e].shader.definition.fshader);if(0!==_.length)for(u=0;u<m;u++)for(d=0;d<_.length;d++){h=_[d];var g=Hr(p[f[u]].shader.definition.fshader);for(c=0;c<g.length;c++)if(g[c]===h){h=!0;break t}}h=!1}h=!h}if(h?(Jp[o]=e,o++,e===i.length-1&&(l=!0)):0<o&&(l=!0),l){if(1<o){for(h="post_",l=0;l<o;l++)h+=(g=i[Jp[l]]).name?g.name:g.id,l<o-1&&(h+="_");if(!(g=s.programLib._cache[h])){for(c="vec4 shaderOutput;\n",d="void main() {\n",u=[],l=0;l<o;l++){var y;g=(g=i[Jp[l]].shader.definition.fshader+"\n").replace(df,"//").replace(uf,"//").replace(pf,"//").replace(ff,"shaderOutput"),0<l&&(g=g.replace(mf,"//").replace(_f,"//").replace(gf,"shaderOutput;//")),f=u;var v=(_=g=g.replace(yf,"void main"+l)).length,b=0,x=y=0;for(m="",p=0;p<v;p++){var S=_.charAt(p);"{"===S?(0===y&&(b=p),y++):"}"===S&&(1===y&&(S=p,m+=_.substr(x,b-x+1),x=S),y--)}for(b=null,x=(m+=_.substr(x,_.length-x+1)).match(of)||[],p=0;p<x.length;p++)for(_=x[p].split(","),v=0;v<_.length;v++)y=_[v].replace(hf,"").trim(),0<=f.indexOf(y)?(b||(b=[]),b.push(y)):f.push(y);for(m=m.match(lf)||[],p=0;p<m.length;p++)for(_=m[p].split(","),v=0;v<_.length;v++)y=_[v].replace(cf,"").trim(),0<=(y=f.indexOf(y))&&f.splice(y,1);if(p=b)for(f=0;f<p.length;f++)g=g.replace(new RegExp("\\b"+p[f]+"\\b","g"),p[f]+"NNNN"+l);c+=g,d+="main"+l+"();\n"}d+="gl_FragColor = shaderOutput;\n}\n",g=st(s,Ra.fullscreenQuadVS,c+d,h)}for(l=0;l<o;l++)i[Jp[l]]._postEffectCombined=l===o-1?1:-1;i[Jp[o-1]]._postEffectCombinedShader=g,i[Jp[o-1]]._postEffectCombinedBilinear=i[Jp[0]].postEffectBilinear,i[Jp[o-1]]._postEffectCombinedSrc=i[Jp[0]].postEffect.srcRenderTarget}Jp[0]=e,o=1}}}for(e=0;e<i.length;e++){if(i[e].isPostEffect&&(!i[e].postEffect.srcRenderTarget&&!i[e]._postEffectCombined||!i[e].postEffect._postEffectCombinedSrc&&0<=i[e]._postEffectCombined)){for(l=e-1;l>=n;l--)i[l].renderTarget||(i[l].renderTarget=Kp[r]);i[e]._backbufferRtId=r,n=e,tf=!0,1===r&&(ef=!0),i[e].postEffect.hdr&&(a=s.webgl2&&s.textureFloatRenderable?18:s.extTextureHalfFloatLinear&&s.textureHalfFloatRenderable?12:7),i[e].postEffect.shader&&!i[e].renderTarget&&(r=1-r)}else i[e].isPostEffect||i[e].renderTarget||!tf||(i[e].renderTarget=Kp[r]);i[e].isPostEffect&&!i[e].renderTarget&&(sf=!0)}tf&&(Kp[0].colorBuffer?Kp[0].width===s.width&&Kp[0].height===s.height&&Kp[0]._colorBuffer._format===a||(Kp[0].colorBuffer.destroy(),Kp[0].destroy(),Gr(0,s,a)):Gr(0,s,a)),ef&&(Kp[1].colorBuffer?Kp[1].width===s.width&&Kp[1].height===s.height&&Kp[1]._colorBuffer._format===a||(Kp[1].colorBuffer.destroy(),Kp[1].destroy(),Gr(1,s,a)):Gr(1,s,a))},this),t.on("postrender",function(){var e=t.graphicsDevice;if(tf&&!sf){for(var i,s=t.scene.layers.layerList,n=s.length-1;0<=n&&((i=s[n].renderTarget)!==Kp[0]&&i!==Kp[1]);n--);i&&(1<i._samples&&i.resolve(!0,!1),e.copyRenderTarget(i,null,!0,!1))}},this)}}function Xr(t){this.name="UnsupportedBrowserError",this.message=t||""}function qr(t){this.name="ContextCreationError",this.message=t||""}Array.prototype.find||Object.defineProperty(Array.prototype,"find",{value:function(t,e){if(null==this)throw TypeError('"this" is null or not defined');var i=Object(this),s=i.length>>>0;if("function"!=typeof t)throw TypeError("predicate must be a function");for(var n=0;n<s;){var r=i[n];if(t.call(e,r,n,i))return r;n++}},configurable:!0,writable:!0}),Math.log2=Math.log2||function(t){return Math.log(t)*Math.LOG2E},Math.sign||(Math.sign=function(t){return(0<t)-(0>t)||+t}),"function"!=typeof Object.assign&&Object.defineProperty(Object,"assign",{value:function(t,e){if(null==t)throw new TypeError("Cannot convert undefined or null to object");for(var i=Object(t),s=1;s<arguments.length;s++){var n=arguments[s];if(null!=n)for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(i[r]=n[r])}return i},writable:!0,configurable:!0}),function(){if("undefined"!=typeof navigator&&"undefined"!=typeof document){navigator.pointer=navigator.pointer||navigator.webkitPointer||navigator.mozPointer;var t=function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockchange",!0,!1,null),document.dispatchEvent(t)},e=function(){var t=document.createEvent("CustomEvent");t.initCustomEvent("pointerlockerror",!0,!1,null),document.dispatchEvent(t)};document.addEventListener("webkitpointerlockchange",t,!1),document.addEventListener("webkitpointerlocklost",t,!1),document.addEventListener("mozpointerlockchange",t,!1),document.addEventListener("mozpointerlocklost",t,!1),document.addEventListener("webkitpointerlockerror",e,!1),document.addEventListener("mozpointerlockerror",e,!1),Element.prototype.requestPointerLock=Element.prototype.mozRequestPointerLock?function(){this.mozRequestPointerLock()}:Element.prototype.requestPointerLock||Element.prototype.webkitRequestPointerLock||Element.prototype.mozRequestPointerLock,!Element.prototype.requestPointerLock&&navigator.pointer&&(Element.prototype.requestPointerLock=function(){document.pointerLockElement=this,navigator.pointer.lock(this,t,e)}),document.exitPointerLock=document.exitPointerLock||document.webkitExitPointerLock||document.mozExitPointerLock,document.exitPointerLock||(document.exitPointerLock=function(){navigator.pointer&&(document.pointerLockElement=null,navigator.pointer.unlock())})}}(),function(){if("undefined"!=typeof window){for(var t=0,e=["ms","moz","webkit","o"],i=0;i<e.length&&!window.requestAnimationFrame;++i)window.requestAnimationFrame=window[e[i]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[e[i]+"CancelAnimationFrame"]||window[e[i]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(e,i){var s=(new Date).getTime(),n=Math.max(0,16-(s-t));return i=window.setTimeout(function(){e(s+n)},n),t=s+n,i}),window.cancelAnimationFrame||(window.cancelAnimationFrame=function(t){clearTimeout(t)})}}(),String.prototype.endsWith||(String.prototype.endsWith=function(t,e){return(void 0===e||e>this.length)&&(e=this.length),this.substring(e-t.length,e)===t}),String.prototype.includes||(String.prototype.includes=function(t,e){return"number"!=typeof e&&(e=0),!(e+t.length>this.length)&&-1!==this.indexOf(t,e)}),String.prototype.startsWith||(String.prototype.startsWith=function(t,e){return this.substr(!e||0>e?0:+e,t.length)===t}),function(){var t={},e=function t(e){var i=e.gl;for(this.ext=e,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=Array(e.maxVertexAttribs),e=0;e<this.attribs.length;e++){var s=new t.VertexAttrib(i);this.attribs[e]=s}this.maxAttrib=0};(e.VertexAttrib=function(t){this.enabled=!1,this.buffer=null,this.size=4,this.type=t.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var i=function(e){var i=this;this.gl=e,function(e){var i=e.getError;e.getError=function(){do{var s=i.apply(e);s!=e.NO_ERROR&&(t[s]=!0)}while(s!=e.NO_ERROR);for(s in t)if(t[s])return delete t[s],parseInt(s);return e.NO_ERROR}}(e);var s=this.original={getParameter:e.getParameter,enableVertexAttribArray:e.enableVertexAttribArray,disableVertexAttribArray:e.disableVertexAttribArray,bindBuffer:e.bindBuffer,getVertexAttrib:e.getVertexAttrib,vertexAttribPointer:e.vertexAttribPointer};e.getParameter=function(t){return t==i.VERTEX_ARRAY_BINDING_OES?i.currentVertexArrayObject==i.defaultVertexArrayObject?null:i.currentVertexArrayObject:s.getParameter.apply(this,arguments)},e.enableVertexAttribArray=function(t){var e=i.currentVertexArrayObject;return e.maxAttrib=Math.max(e.maxAttrib,t),e.attribs[t].enabled=!0,s.enableVertexAttribArray.apply(this,arguments)},e.disableVertexAttribArray=function(t){var e=i.currentVertexArrayObject;return e.maxAttrib=Math.max(e.maxAttrib,t),e.attribs[t].enabled=!1,s.disableVertexAttribArray.apply(this,arguments)},e.bindBuffer=function(t,n){switch(t){case e.ARRAY_BUFFER:i.currentArrayBuffer=n;break;case e.ELEMENT_ARRAY_BUFFER:i.currentVertexArrayObject.elementArrayBuffer=n}return s.bindBuffer.apply(this,arguments)},e.getVertexAttrib=function(t,n){var r=i.currentVertexArrayObject.attribs[t];switch(n){case e.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return r.buffer;case e.VERTEX_ATTRIB_ARRAY_ENABLED:return r.enabled;case e.VERTEX_ATTRIB_ARRAY_SIZE:return r.size;case e.VERTEX_ATTRIB_ARRAY_STRIDE:return r.stride;case e.VERTEX_ATTRIB_ARRAY_TYPE:return r.type;case e.VERTEX_ATTRIB_ARRAY_NORMALIZED:return r.normalized;default:return s.getVertexAttrib.apply(this,arguments)}},e.vertexAttribPointer=function(t,e,n,r,a,o){var h=i.currentVertexArrayObject;return h.maxAttrib=Math.max(h.maxAttrib,t),(h=h.attribs[t]).buffer=i.currentArrayBuffer,h.size=e,h.type=n,h.normalized=r,h.stride=a,h.offset=o,h.recache(),s.vertexAttribPointer.apply(this,arguments)},e.instrumentExtension&&e.instrumentExtension(this,"OES_vertex_array_object"),e.canvas.addEventListener("webglcontextrestored",function(){window.console&&window.console.log&&window.console.log("OESVertexArrayObject emulation library context restored"),i.reset_()},!0),this.reset_()};i.prototype.VERTEX_ARRAY_BINDING_OES=34229,i.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var t=0;t<this.vertexArrayObjects.length;++t)this.vertexArrayObjects.isAlive=!1;t=this.gl,this.maxVertexAttribs=t.getParameter(t.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new e(this),this.currentArrayBuffer=this.currentVertexArrayObject=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},i.prototype.createVertexArrayOES=function(){var t=new e(this);return this.vertexArrayObjects.push(t),t},i.prototype.deleteVertexArrayOES=function(t){t.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(t),1),this.currentVertexArrayObject==t&&this.bindVertexArrayOES(null)},i.prototype.isVertexArrayOES=function(t){return!!(t&&t instanceof e&&t.hasBeenBound&&t.ext==this)},i.prototype.bindVertexArrayOES=function(e){var i=this.gl;if(e&&!e.isAlive)t[i.INVALID_OPERATION]=!0,window.console&&window.console.error&&window.console.error("bindVertexArrayOES: attempt to bind deleted arrayObject");else{var s=this.original,n=this.currentVertexArrayObject;if(this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0,n!=(e=this.currentVertexArrayObject)){n&&e.elementArrayBuffer==n.elementArrayBuffer||s.bindBuffer.call(i,i.ELEMENT_ARRAY_BUFFER,e.elementArrayBuffer);for(var r=this.currentArrayBuffer,a=Math.max(n?n.maxAttrib:0,e.maxAttrib),o=0;o<=a;o++){var h=e.attribs[o],l=n?n.attribs[o]:null;if(n&&h.enabled==l.enabled||(h.enabled?s.enableVertexAttribArray.call(i,o):s.disableVertexAttribArray.call(i,o)),h.enabled){var c=!1;n&&h.buffer==l.buffer||(r!=h.buffer&&(s.bindBuffer.call(i,i.ARRAY_BUFFER,h.buffer),r=h.buffer),c=!0),(c||h.cached!=l.cached)&&s.vertexAttribPointer.call(i,o,h.size,h.type,h.normalized,h.stride,h.offset)}}this.currentArrayBuffer!=r&&s.bindBuffer.call(i,i.ARRAY_BUFFER,this.currentArrayBuffer)}}},window.setupVertexArrayObject=function(t){if(t.getSupportedExtensions){if(-1!=t.getSupportedExtensions().indexOf("OES_vertex_array_object"))return}else if(t.getExtension&&t.getExtension("OES_vertex_array_object"))return;if(t.getSupportedExtensions){var e=t.getSupportedExtensions;t.getSupportedExtensions=function(){var t=e.call(this)||[];return t.push("OES_vertex_array_object"),t}}var s=t.getExtension;t.getExtension=function(e){return"OES_vertex_array_object"==e?(t.__OESVertexArrayObject||(t.__OESVertexArrayObject=new i(t)),t.__OESVertexArrayObject):s?s.call(this,e):null}}}();var Yr,Kr,$r,Zr,Qr=function(){for(var t={},e="Array Object Function Date RegExp Float32Array".split(" "),i=0;i<e.length;i++)t["[object "+e[i]+"]"]=e[i].toLowerCase();return t}(),Jr=(Yr=null,Kr=null,$r=null,Zr=null,{display:function(t){for(var e in Yr||(Yr=document.createElement("table"),Kr=document.createElement("tr"),$r=document.createElement("td"),Zr=document.createElement("td"),Yr.style.cssText="position:absolute;font-family:sans-serif;font-size:12px;color:#cccccc",Yr.style.top="0px",Yr.style.left="0px",Yr.style.border="thin solid #cccccc",document.body.appendChild(Yr)),Yr.innerHTML="",t){var i=Kr.cloneNode(),s=$r.cloneNode(),n=Zr.cloneNode();s.textContent=e,n.textContent=t[e],i.appendChild(s),i.appendChild(n),Yr.appendChild(i)}}});Object.assign(n.prototype,{_addCallback:function(t,e,i,s){t&&"string"==typeof t&&e&&(this._callbacks[t]||(this._callbacks[t]=[]),this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].push({callback:e,scope:i||this,once:s||!1}))},on:function(t,e,i){return this._addCallback(t,e,i,!1),this},off:function(t,e,i){if(t)this._callbackActive[t]&&this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());else for(var s in this._callbackActive)this._callbacks[s]&&this._callbacks[s]===this._callbackActive[s]&&(this._callbackActive[s]=this._callbackActive[s].slice());if(t)if(e){if(!(t=this._callbacks[t]))return this;s=t.length;for(var n=0;n<s;n++)t[n].callback===e&&(i&&t[n].scope!==i||(t[n--]=t[--s]));t.length=s}else this._callbacks[t]&&(this._callbacks[t]=[]);else this._callbacks={};return this},fire:function(t,e,i,s,n,r,a,o,h){if(!t||!this._callbacks[t])return this;if(this._callbackActive[t]){this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice());var l=this._callbacks[t].slice()}else this._callbackActive[t]=this._callbacks[t];for(var c=0;(l||this._callbackActive[t])&&c<(l||this._callbackActive[t]).length;c++){var d=(l||this._callbackActive[t])[c];d.callback.call(d.scope,e,i,s,n,r,a,o,h),d.once&&(-1!==(d=this._callbacks[t].indexOf(d))&&(this._callbackActive[t]===this._callbacks[t]&&(this._callbackActive[t]=this._callbackActive[t].slice()),this._callbacks[t].splice(d,1)))}return l||(this._callbackActive[t]=null),this},once:function(t,e,i){return this._addCallback(t,e,i,!0),this},hasEvent:function(t){return this._callbacks[t]&&0!==this._callbacks[t].length||!1}});var ta={attach:function(t){var e=ta;return t._addCallback=e._addCallback,t.on=e.on,t.off=e.off,t.fire=e.fire,t.once=e.once,t.hasEvent=e.hasEvent,t._callbacks={},t._callbackActive={},t},_addCallback:n.prototype._addCallback,on:n.prototype.on,off:n.prototype.off,fire:n.prototype.fire,once:n.prototype.once,hasEvent:n.prototype.hasEvent},ea={create:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)})}},ia={delimiter:"/",join:function(){var t,e=arguments.length,i=arguments[0];for(t=0;t<e-1;++t){var n=arguments[t],r=arguments[t+1];if(!s(n)||!s(r))throw Error("undefined argument to pc.path.join");i=r[0]===ia.delimiter?r:n&&r&&n[n.length-1]!==ia.delimiter&&r[0]!==ia.delimiter?i+(ia.delimiter+r):i+r}return i},normalize:function(t){var e=t.startsWith(ia.delimiter),i=t.endsWith(ia.delimiter);t=t.split("/");for(var s=[],n=0;n<t.length;n++)""!==t[n]&&"."!==t[n]&&(".."===t[n]&&0<s.length?s=s.slice(0,s.length-2):(0<n&&s.push(ia.delimiter),s.push(t[n])));return t=s.join(""),e||t[0]!==ia.delimiter||(t=t.slice(1)),i&&t[t.length-1]!==ia.delimiter&&(t+=ia.delimiter),t},split:function(t){var e=(t=t.split(ia.delimiter)).slice(t.length-1)[0];return[t.slice(0,t.length-1).join(ia.delimiter),e]},getBasename:function(t){return ia.split(t)[1]},getDirectory:function(t){return(t=t.split(ia.delimiter)).slice(0,t.length-1).join(ia.delimiter)},getExtension:function(t){var e=t.split("?")[0].split(".").pop();return e!==t?"."+e:""},isRelativePath:function(t){return"/"!==t.charAt(0)&&null===t.match(/:\/\//)},extractPath:function(t){var e="",i=t.split("/");if(1<i.length)if(ia.isRelativePath(t))if("."===i[0])for(t=0;t<i.length-1;++t)e+=0===t?i[t]:"/"+i[t];else if(".."===i[0])for(t=0;t<i.length-1;++t)e+=0===t?i[t]:"/"+i[t];else for(e=".",t=0;t<i.length-1;++t)e+="/"+i[t];else for(t=0;t<i.length-1;++t)e+=0===t?i[t]:"/"+i[t];return e}},sa={desktop:!1,mobile:!1,ios:!1,android:!1,windows:!1,xbox:!1,gamepads:!1,touch:!1,workers:!1,passiveEvents:!1};if("undefined"!=typeof navigator){var na=navigator.userAgent;/(windows|mac os|linux|cros)/i.test(na)&&(sa.desktop=!0),/xbox/i.test(na)&&(sa.xbox=!0),/(windows phone|iemobile|wpdesktop)/i.test(na)?(sa.desktop=!1,sa.mobile=!0,sa.windows=!0):/android/i.test(na)?(sa.desktop=!1,sa.mobile=!0,sa.android=!0):/ip([ao]d|hone)/i.test(na)&&(sa.desktop=!1,sa.mobile=!0,sa.ios=!0),"undefined"!=typeof window&&(sa.touch="ontouchstart"in window||"maxTouchPoints"in navigator&&0<navigator.maxTouchPoints),sa.gamepads="getGamepads"in navigator,sa.workers="undefined"!=typeof Worker;try{var ra=Object.defineProperty({},"passive",{get:function(){return sa.passiveEvents=!0,!1}});window.addEventListener("testpassive",null,ra),window.removeEventListener("testpassive",null,ra)}catch(Yr){}}var aa={ASCII_LOWERCASE:"abcdefghijklmnopqrstuvwxyz",ASCII_UPPERCASE:"ABCDEFGHIJKLMNOPQRSTUVWXYZ",ASCII_LETTERS:"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",format:function(t){for(var e=1;e<arguments.length;e++)t=t.replace("{"+(e-1)+"}",arguments[e]);return t},toBool:function(t,e){if("true"===t)return!0;if(e){if("false"===t)return!1;throw new TypeError("Not a boolean string")}return!1},getCodePoint:function(t,e){return(t=r(t,e))&&t.code},getCodePoints:function(t){if("string"!=typeof t)throw new TypeError("Not a string");for(var e,i=0,s=[];e=r(t,i);)s.push(e.code),i+=e.long?2:1;return s},getSymbols:function(t){if("string"!=typeof t)throw new TypeError("Not a string");for(var e,i=0,s=t.length,n=[],r=0;i<s;){e=r;var o=t,h=i+r;h===o.length-1?r=1:a(o[h],55296,56319)?(r=o.substring(h,h+2),r=a(o=o.substring(h+2,h+4),127995,127999)||a(r,127462,127487)&&a(o,127462,127487)?4:a(o,65024,65039)?3:2):r=a(o[h+1],65024,65039)?2:1,a(e=t[i+(r=e+r)],8400,8447)&&(e=t[i+r++]),a(e,65024,65039)&&(e=t[i+r++]),e&&8205===e.charCodeAt(0)?r++:(e=t.substring(i,i+r),n.push(e),i+=r,r=0)}return n},fromCodePoint:function(){for(var t,e,i=[],s=0;s<arguments.length;++s)e=(t=Number(arguments[s]))-65536,t=65535<t?[55296+(e>>10),e%1024+56320]:[t],i.push(String.fromCharCode.apply(null,t));return i.join("")}},oa={DEG_TO_RAD:Math.PI/180,RAD_TO_DEG:180/Math.PI,clamp:function(t,e,i){return t>=i?i:t<=e?e:t},intToBytes24:function(t){return[t>>16&255,t>>8&255,255&t]},intToBytes32:function(t){return[t>>24&255,t>>16&255,t>>8&255,255&t]},bytesToInt24:function(t,e,i){return t.length&&(i=t[2],e=t[1],t=t[0]),t<<16|e<<8|i},bytesToInt32:function(t,e,i,s){return t.length&&(s=t[3],i=t[2],e=t[1],t=t[0]),(t<<24|e<<16|i<<8|s)>>>32},lerp:function(t,e,i){return t+(e-t)*oa.clamp(i,0,1)},lerpAngle:function(t,e,i){return 180<e-t&&(e-=360),-180>e-t&&(e+=360),oa.lerp(t,e,oa.clamp(i,0,1))},powerOfTwo:function(t){return 0!==t&&!(t&t-1)},nextPowerOfTwo:function(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t},random:function(t,e){return Math.random()*(e-t)+t},smoothstep:function(t,e,i){return i<=t?0:i>=e?1:(i=(i-t)/(e-t))*i*(3-2*i)},smootherstep:function(t,e,i){return i<=t?0:i>=e?1:(i=(i-t)/(e-t))*i*i*(i*(6*i-15)+10)},roundUp:function(t,e){return 0===e?t:Math.ceil(t/e)*e},float2Half:function(){var t=new Float32Array(1),e=new Int32Array(t.buffer);return function(i){t[0]=i;var s=(i=e[0])>>16&32768,n=i>>12&2047,r=i>>23&255;return 103>r?s:142<r?31744|s|((255==r?0:1)&&8388607&i):113>r?s|((n|=2048)>>114-r)+(n>>113-r&1):s=(s|r-112<<10|n>>1)+(1&n)}}()};Object.assign(o.prototype,{clone:function(){return new o(this.r,this.g,this.b,this.a)},copy:function(t){return this.r=t.r,this.g=t.g,this.b=t.b,this.a=t.a,this},equals:function(t){return this.r===t.r&&this.g===t.g&&this.b===t.b&&this.a===t.a},set:function(t,e,i,s){return this.r=t,this.g=e,this.b=i,this.a=void 0===s?1:s,this},lerp:function(t,e,i){return this.r=t.r+i*(e.r-t.r),this.g=t.g+i*(e.g-t.g),this.b=t.b+i*(e.b-t.b),this.a=t.a+i*(e.a-t.a),this},fromString:function(t){var e=parseInt(t.replace("#","0x"),16);return 7<t.length?t=oa.intToBytes32(e):(t=oa.intToBytes24(e))[3]=255,this.set(t[0]/255,t[1]/255,t[2]/255,t[3]/255),this},toString:function(t){var e="#"+(16777216+(Math.round(255*this.r)<<16)+(Math.round(255*this.g)<<8)+Math.round(255*this.b)).toString(16).slice(1);return!0===t&&(t=Math.round(255*this.a).toString(16),e=this.a<16/255?e+"0"+t:e+t),e}}),Object.defineProperties(o,{BLACK:{value:new o(0,0,0,1)},WHITE:{value:new o(1,1,1,1)},YELLOW:{value:new o(1,1,0,1)},RED:{value:new o(1,0,0,1)},MAGENTA:{value:new o(1,0,1,1)},GREEN:{value:new o(0,1,0,1)},GRAY:{value:new o(.5,.5,.5,1)},CYAN:{value:new o(0,1,1,1)},BLUE:{value:new o(0,0,1,1)}}),Object.freeze(o.BLACK),Object.freeze(o.WHITE),Object.freeze(o.YELLOW),Object.freeze(o.RED),Object.freeze(o.MAGENTA),Object.freeze(o.GREEN),Object.freeze(o.GRAY),Object.freeze(o.CYAN),Object.freeze(o.BLUE),Object.assign(h.prototype,{push:function(t,e){if(this._index[t])throw Error("Key already in index "+t);e=this._list.push(e)-1,this._index[t]=e},has:function(t){return void 0!==this._index[t]},get:function(t){return void 0!==(t=this._index[t])?this._list[t]:null},remove:function(t){var e=this._index[t];if(void 0!==e){for(t in this._list.splice(e,1),delete this._index[t],this._index){var i=this._index[t];i>e&&(this._index[t]=i-1)}return!0}return!1},list:function(){return this._list},clear:function(){for(var t in this._list.length=0,this._index)delete this._index[t]}}),Object.assign(l.prototype,{addItem:function(t){for(var e=t.tags._list,i=0;i<e.length;i++)this.add(e[i],t)},removeItem:function(t){for(var e=t.tags._list,i=0;i<e.length;i++)this.remove(e[i],t)},add:function(t,e){this._index[t]&&-1!==this._index[t].list.indexOf(e)||(this._index[t]||(this._index[t]={list:[]},this._key&&(this._index[t].keys={})),this._index[t].list.push(e),this._key&&(this._index[t].keys[e[this._key]]=e))},remove:function(t,e){if(this._index[t]&&(!this._key||this._index[t].keys[e[this._key]])){var i=this._index[t].indexOf(e);-1!==i&&(this._index[t].list.splice(i,1),this._key&&delete this._index[t].keys[e[this._key]],0===this._index[t].list.length&&delete this._index[t])}},find:function(t){var e,i,s=this,n={},r=[],a=function(t,e){return s._index[t].list.length-s._index[e].list.length};for(e=0;e<t.length;e++){var o=t[e];if(o instanceof Array){if(0===o.length)continue;if(1!==o.length){var h=!1;for(i=0;i<o.length;i++)if(!this._index[o[i]]){h=!0;break}if(h)continue;var l=(o=o.slice(0).sort(a)).slice(1);for(1===l.length&&(l=l[0]),i=0;i<this._index[o[0]].list.length;i++)h=this._index[o[0]].list[i],(this._key?!n[h[this._key]]:-1===r.indexOf(h))&&h.tags.has(l)&&(this._key&&(n[h[this._key]]=!0),r.push(h));continue}o=o[0]}if(o&&"string"==typeof o&&this._index[o])for(i=0;i<this._index[o].list.length;i++)h=this._index[o].list[i],this._key?n[h[this._key]]||(n[h[this._key]]=!0,r.push(h)):-1===r.indexOf(h)&&r.push(h)}return r}}),c.prototype=Object.create(n.prototype),c.prototype.constructor=c,Object.assign(c.prototype,{add:function(){var t=!1,e=this._processArguments(arguments,!0);if(!e.length)return t;for(var i=0;i<e.length;i++)this._index[e[i]]||(t=!0,this._index[e[i]]=!0,this._list.push(e[i]),this.fire("add",e[i],this._parent));return t&&this.fire("change",this._parent),t},remove:function(){var t=!1;if(!this._list.length)return t;var e=this._processArguments(arguments,!0);if(!e.length)return t;for(var i=0;i<e.length;i++)this._index[e[i]]&&(t=!0,delete this._index[e[i]],this._list.splice(this._list.indexOf(e[i]),1),this.fire("remove",e[i],this._parent));return t&&this.fire("change",this._parent),t},clear:function(){if(this._list.length){var t=this._list.slice(0);this._list=[],this._index={};for(var e=0;e<t.length;e++)this.fire("remove",t[e],this._parent);this.fire("change",this._parent)}},has:function(){return!!this._list.length&&this._has(this._processArguments(arguments))},_has:function(t){if(!this._list.length||!t.length)return!1;for(var e=0;e<t.length;e++)if(1===t[e].length){if(this._index[t[e][0]])return!0}else{for(var i=!0,s=0;s<t[e].length;s++)if(!this._index[t[e][s]]){i=!1;break}if(i)return!0}return!1},list:function(){return this._list.slice(0)},_processArguments:function(t,e){var i=[],s=[];if(!t||!t.length)return i;for(var n=0;n<t.length;n++)if(t[n]instanceof Array){e||(s=[]);for(var r=0;r<t[n].length;r++)"string"==typeof t[n][r]&&(e?i.push(t[n][r]):s.push(t[n][r]));!e&&s.length&&i.push(s)}else"string"==typeof t[n]&&(e?i.push(t[n]):i.push([t[n]]));return i}}),Object.defineProperty(c.prototype,"size",{get:function(){return this._list.length}});var ha="undefined"!=typeof window&&window.performance&&window.performance.now&&window.performance.timing?function(){return window.performance.now()}:Date.now;Object.assign(d.prototype,{start:function(){this._isRunning=!0,this._a=ha()},stop:function(){this._isRunning=!1,this._b=ha()},getMilliseconds:function(){return this._b-this._a}}),p.ContentType={FORM_URLENCODED:"application/x-www-form-urlencoded",GIF:"image/gif",JPEG:"image/jpeg",DDS:"image/dds",JSON:"application/json",PNG:"image/png",TEXT:"text/plain",XML:"application/xml",WAV:"audio/x-wav",OGG:"audio/ogg",MP3:"audio/mpeg",MP4:"audio/mp4",AAC:"audio/aac",BIN:"application/octet-stream",BASIS:"image/basis",GLB:"model/gltf-binary"},p.ResponseType={TEXT:"text",ARRAY_BUFFER:"arraybuffer",BLOB:"blob",DOCUMENT:"document",JSON:"json"},p.binaryExtensions=".model .wav .ogg .mp3 .mp4 .m4a .aac .dds .basis .glb".split(" "),p.retryDelay=100,Object.assign(p.prototype,{ContentType:p.ContentType,ResponseType:p.ResponseType,binaryExtensions:p.binaryExtensions,get:function(t,e,i){return"function"==typeof e&&(i=e,e={}),this.request("GET",t,e,i)},post:function(t,e,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=e,this.request("POST",t,i,s)},put:function(t,e,i,s){return"function"==typeof i&&(s=i,i={}),i.postdata=e,this.request("PUT",t,i,s)},del:function(t,e,i){return"function"==typeof e&&(i=e,e={}),this.request("DELETE",t,e,i)},request:function(t,e,s,n){var r=!1;if("function"==typeof s&&(n=s,s={}),s.retry&&(s=Object.assign({retries:0,maxRetries:5},s)),s.callback=n,null==s.async&&(s.async=!0),null==s.headers&&(s.headers={}),null!=s.postdata)if(s.postdata instanceof Document)var a=s.postdata;else if(s.postdata instanceof FormData)a=s.postdata;else if(s.postdata instanceof Object)switch(a=s.headers["Content-Type"],void 0===a&&(s.headers["Content-Type"]=p.ContentType.FORM_URLENCODED,a=s.headers["Content-Type"]),a){case p.ContentType.FORM_URLENCODED:for(o in a="",n=!0,s.postdata)s.postdata.hasOwnProperty(o)&&(n?n=!1:a+="&",a+=escape(o)+"="+escape(s.postdata[o]));break;default:case p.ContentType.JSON:null==a&&(s.headers["Content-Type"]=p.ContentType.JSON),a=JSON.stringify(s.postdata)}else a=s.postdata;if(!1===s.cache){n=ha();var o=new u(e);o.query=o.query?o.query+"&ts="+n:"ts="+n,e=o.toString()}s.query&&(n=i((o=new u(e)).getQuery(),s.query),o.setQuery(n),e=o.toString());var h=new XMLHttpRequest;for(var l in h.open(t,e,s.async),h.withCredentials=void 0!==s.withCredentials&&s.withCredentials,h.responseType=s.responseType||this._guessResponseType(e),s.headers)s.headers.hasOwnProperty(l)&&h.setRequestHeader(l,s.headers[l]);h.onreadystatechange=function(){this._onReadyStateChange(t,e,s,h)}.bind(this),h.onerror=function(){this._onError(t,e,s,h),r=!0}.bind(this);try{h.send(a)}catch(t){r||s.error(h.status,h,t)}return h},_guessResponseType:function(t){return t=new u(t),t=ia.getExtension(t.path),0<=p.binaryExtensions.indexOf(t)?p.ResponseType.ARRAY_BUFFER:".xml"===t?p.ResponseType.DOCUMENT:p.ResponseType.TEXT},_isBinaryContentType:function(t){return 0<=[p.ContentType.MP4,p.ContentType.WAV,p.ContentType.OGG,p.ContentType.MP3,p.ContentType.BIN,p.ContentType.DDS,p.ContentType.BASIS,p.ContentType.GLB].indexOf(t)},_onReadyStateChange:function(t,e,i,s){if(4===s.readyState)switch(s.status){case 0:"/"!=e[0]?this._onSuccess(t,e,i,s):this._onError(t,e,i,s);break;case 200:case 201:case 206:case 304:this._onSuccess(t,e,i,s);break;default:this._onError(t,e,i,s)}},_onSuccess:function(t,e,i,s){if(t=s.getResponseHeader("Content-Type")){var n=t.split(";");n=n[0].trim()}try{if(n===this.ContentType.JSON||e.split("?")[0].endsWith(".json"))var r=JSON.parse(s.responseText);else this._isBinaryContentType(n)?r=s.response:(n&&console.warn("responseType: "+s.responseType+" being served with Content-Type: "+n),r=s.responseType===p.ResponseType.ARRAY_BUFFER?s.response:s.responseType===p.ResponseType.BLOB||s.responseType===p.ResponseType.JSON?s.response:s.responseType===p.ResponseType.DOCUMENT||n===this.ContentType.XML?s.responseXML:s.responseText);i.callback(null,r)}catch(t){i.callback(t)}},_onError:function(t,e,i,s){if(!i.retrying)if(i.retry&&i.retries<i.maxRetries){i.retries++,i.retrying=!0;var n=oa.clamp(Math.pow(2,i.retries)*p.retryDelay,0,i.maxRetryDelay||5e3);console.log(t+": "+e+" - Error "+s.status+". Retrying in "+n+" ms"),setTimeout(function(){i.retrying=!1,this.request(t,e,i,i.callback)}.bind(this),n)}else i.callback(0===s.status?"Network error":s.status,null)}});var la=new p;Object.assign(f.prototype,{evaluate:function(t,e){return(e||t<this._left||t>=this._right)&&this._reset(t),5===(e=this._curve.type)?t=this._p0:(t=0===this._recip?0:(t-this._left)*this._recip,t=0===e?oa.lerp(this._p0,this._p1,t):1===e?oa.lerp(this._p0,this._p1,t*t*(3-2*t)):this._evaluateHermite(this._p0,this._p1,this._m0,this._m1,t)),t},_reset:function(t){var e=this._curve.keys,i=e.length;if(i)if(t<e[0][0])this._left=-1/0,this._right=e[0][0],this._recip=0,this._p0=this._p1=e[0][1],this._m0=this._m1=0;else if(t>=e[i-1][0])this._left=e[i-1][0],this._right=1/0,this._recip=0,this._p0=this._p1=e[i-1][1],this._m0=this._m1=0;else{for(i=0;t>=e[i+1][0];)i++;this._left=e[i][0],this._right=e[i+1][0],t=1/(this._right-this._left),this._recip=isFinite(t)?t:0,this._p0=e[i][1],this._p1=e[i+1][1],this._isHermite()&&this._calcTangents(e,i)}else this._left=-1/0,this._right=1/0,this._p0=this._p1=this._m0=this._m1=this._recip=0},_isHermite:function(){return 2===this._curve.type||3===this._curve.type||4===this._curve.type},_calcTangents:function(t,e){var i=t[e],s=t[e+1],n=0===e?[t[0][0]+(t[0][0]-t[1][0]),t[0][1]+(t[0][1]-t[1][1])]:t[e-1];if(t=e==t.length-2?[t[e+1][0]+(t[e+1][0]-t[e][0]),t[e+1][1]+(t[e+1][1]-t[e][1])]:t[e+2],4===this._curve.type){e=2*(s[0]-i[0])/(s[0]-n[0]);var r=2*(s[0]-i[0])/(t[0]-i[0]);this._m0=this._curve.tension*(isFinite(e)?e:0)*(s[1]-n[1]),this._m1=this._curve.tension*(isFinite(r)?r:0)*(t[1]-i[1])}else r=(s[0]-i[0])/(i[0]-n[0]),e=(s[0]-i[0])/(t[0]-s[0]),n=i[1]+(n[1]-i[1])*(isFinite(r)?r:0),t=s[1]+(t[1]-s[1])*(isFinite(e)?e:0),e=2===this._curve.type?.5:this._curve.tension,this._m0=e*(s[1]-n),this._m1=e*(t-i[1])},_evaluateHermite:function(t,e,i,s,n){var r=n*n,a=n+n,o=1-n;return t*(1+a)*(o*=o)+i*n*o+e*r*(3-a)+s*r*(n-1)}}),Object.assign(m.prototype,{add:function(t,e){for(var i=this.keys,s=i.length,n=0;n<s&&!(i[n][0]>t);n++);return t=[t,e],this.keys.splice(n,0,t),t},get:function(t){return this.keys[t]},sort:function(){this.keys.sort(function(t,e){return t[0]-e[0]})},value:function(t){return this._eval.evaluate(t,!0)},closest:function(t){for(var e=this.keys,i=e.length,s=2,n=null,r=0;r<i;r++){var a=Math.abs(t-e[r][0]);if(!(s>=a))break;s=a,n=e[r]}return n},clone:function(){var t=new m;return t.keys=i(t.keys,this.keys),t.type=this.type,t.tension=this.tension,t},quantize:function(t){t=Math.max(t,2);var e=new Float32Array(t),i=1/(t-1);e[0]=this._eval.evaluate(0,!0);for(var s=1;s<t;s++)e[s]=this._eval.evaluate(i*s);return e},quantizeClamped:function(t,e,i){t=this.quantize(t);for(var s=0;s<t.length;++s)t[s]=Math.min(i,Math.max(e,t[s]));return t}}),Object.defineProperty(m.prototype,"length",{get:function(){return this.keys.length}}),Object.assign(_.prototype,{get:function(t){return this.curves[t]},value:function(t,e){var i=this.curves.length;(e=e||[]).length=i;for(var s=0;s<i;s++)e[s]=this.curves[s].value(t);return e},clone:function(){var t=new _;t.curves=[];for(var e=0;e<this.curves.length;e++)t.curves.push(this.curves[e].clone());return t._type=this._type,t},quantize:function(t){t=Math.max(t,2);for(var e=this.curves.length,i=new Float32Array(t*e),s=1/(t-1),n=0;n<e;n++)for(var r=new f(this.curves[n]),a=0;a<t;a++)i[a*e+n]=r.evaluate(s*a);return i},quantizeClamped:function(t,e,i){t=this.quantize(t);for(var s=0;s<t.length;++s)t[s]=Math.min(i,Math.max(e,t[s]));return t}}),Object.defineProperty(_.prototype,"length",{get:function(){return this.curves.length}}),Object.defineProperty(_.prototype,"type",{get:function(){return this._type},set:function(t){this._type=t;for(var e=0;e<this.curves.length;e++)this.curves[e].type=t}}),Object.assign(g.prototype,{clone:function(){return(new g).copy(this)},copy:function(t){t=t.data;var e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this},set:function(t){var e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],this},equals:function(t){var e=this.data;return t=t.data,e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]},isIdentity:function(){var t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&1===t[4]&&0===t[5]&&0===t[6]&&0===t[7]&&1===t[8]},setIdentity:function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,this},toString:function(){for(var t="[",e=0;9>e;e++)t+=this.data[e],t+=8!==e?", ":"";return t+"]"},transpose:function(){var t=this.data,e=t[1];return t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this}}),Object.defineProperties(g,{ZERO:{value:(new g).set([0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new g}}),Object.freeze(g.ZERO),Object.freeze(g.IDENTITY),Object.assign(y.prototype,{add:function(t){return this.x+=t.x,this.y+=t.y,this},add2:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this},clone:function(){return(new y).copy(this)},copy:function(t){return this.x=t.x,this.y=t.y,this},distance:function(t){var e=this.x-t.x;return t=this.y-t.y,Math.sqrt(e*e+t*t)},dot:function(t){return this.x*t.x+this.y*t.y},equals:function(t){return this.x===t.x&&this.y===t.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthSq:function(){return this.x*this.x+this.y*this.y},lerp:function(t,e,i){return this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this},mul:function(t){return this.x*=t.x,this.y*=t.y,this},mul2:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this},normalize:function(){var t=this.x*this.x+this.y*this.y;return 0<t&&(t=1/Math.sqrt(t),this.x*=t,this.y*=t),this},scale:function(t){return this.x*=t,this.y*=t,this},set:function(t,e){return this.x=t,this.y=e,this},sub:function(t){return this.x-=t.x,this.y-=t.y,this},sub2:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this},toString:function(){return"["+this.x+", "+this.y+"]"}}),Object.defineProperties(y,{ZERO:{value:new y(0,0)},ONE:{value:new y(1,1)},UP:{value:new y(0,1)},DOWN:{value:new y(0,-1)},RIGHT:{value:new y(1,0)},LEFT:{value:new y(-1,0)}}),Object.freeze(y.ZERO),Object.freeze(y.ONE),Object.freeze(y.UP),Object.freeze(y.DOWN),Object.freeze(y.RIGHT),Object.freeze(y.LEFT),Object.assign(v.prototype,{add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this},add2:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this},clone:function(){return(new v).copy(this)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this},cross:function(t,e){var i=t.x,s=t.y;t=t.z;var n=e.x,r=e.y;return e=e.z,this.x=s*e-r*t,this.y=t*n-e*i,this.z=i*r-n*s,this},distance:function(t){var e=this.x-t.x,i=this.y-t.y;return t=this.z-t.z,Math.sqrt(e*e+i*i+t*t)},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z},equals:function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},lerp:function(t,e,i){return this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this.z=t.z+i*(e.z-t.z),this},mul:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this},mul2:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this},normalize:function(){var t=this.x*this.x+this.y*this.y+this.z*this.z;return 0<t&&(t=1/Math.sqrt(t),this.x*=t,this.y*=t,this.z*=t),this},project:function(t){var e=(this.x*t.x+this.y*t.y+this.z*t.z)/(t.x*t.x+t.y*t.y+t.z*t.z);return this.x=t.x*e,this.y=t.y*e,this.z=t.z*e,this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this},set:function(t,e,i){return this.x=t,this.y=e,this.z=i,this},sub:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this},sub2:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+"]"}}),Object.defineProperties(v,{ZERO:{value:new v(0,0,0)},ONE:{value:new v(1,1,1)},UP:{value:new v(0,1,0)},DOWN:{value:new v(0,-1,0)},RIGHT:{value:new v(1,0,0)},LEFT:{value:new v(-1,0,0)},FORWARD:{value:new v(0,0,-1)},BACK:{value:new v(0,0,1)}}),Object.freeze(v.ZERO),Object.freeze(v.ONE),Object.freeze(v.UP),Object.freeze(v.DOWN),Object.freeze(v.RIGHT),Object.freeze(v.LEFT),Object.freeze(v.FORWARD),Object.freeze(v.BACK),Object.assign(b.prototype,{add:function(t){return this.x+=t.x,this.y+=t.y,this.z+=t.z,this.w+=t.w,this},add2:function(t,e){return this.x=t.x+e.x,this.y=t.y+e.y,this.z=t.z+e.z,this.w=t.w+e.w,this},clone:function(){return(new b).copy(this)},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},dot:function(t){return this.x*t.x+this.y*t.y+this.z*t.z+this.w*t.w},equals:function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},lerp:function(t,e,i){return this.x=t.x+i*(e.x-t.x),this.y=t.y+i*(e.y-t.y),this.z=t.z+i*(e.z-t.z),this.w=t.w+i*(e.w-t.w),this},mul:function(t){return this.x*=t.x,this.y*=t.y,this.z*=t.z,this.w*=t.w,this},mul2:function(t,e){return this.x=t.x*e.x,this.y=t.y*e.y,this.z=t.z*e.z,this.w=t.w*e.w,this},normalize:function(){var t=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;return 0<t&&(t=1/Math.sqrt(t),this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},scale:function(t){return this.x*=t,this.y*=t,this.z*=t,this.w*=t,this},set:function(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this},sub:function(t){return this.x-=t.x,this.y-=t.y,this.z-=t.z,this.w-=t.w,this},sub2:function(t,e){return this.x=t.x-e.x,this.y=t.y-e.y,this.z=t.z-e.z,this.w=t.w-e.w,this},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}}),Object.defineProperties(b,{ZERO:{value:new b(0,0,0,0)},ONE:{value:new b(1,1,1,1)}}),Object.freeze(b.ZERO),Object.freeze(b.ONE);var ca=new y;x._getPerspectiveHalfSize=function(t,e,i,s,n){n?(t.x=s*Math.tan(e*Math.PI/360),t.y=t.x/i):(t.y=s*Math.tan(e*Math.PI/360),t.x=t.y*i)},Object.assign(x.prototype,{add2:function(t,e){t=t.data,e=e.data;var i=this.data;return i[0]=t[0]+e[0],i[1]=t[1]+e[1],i[2]=t[2]+e[2],i[3]=t[3]+e[3],i[4]=t[4]+e[4],i[5]=t[5]+e[5],i[6]=t[6]+e[6],i[7]=t[7]+e[7],i[8]=t[8]+e[8],i[9]=t[9]+e[9],i[10]=t[10]+e[10],i[11]=t[11]+e[11],i[12]=t[12]+e[12],i[13]=t[13]+e[13],i[14]=t[14]+e[14],i[15]=t[15]+e[15],this},add:function(t){return this.add2(this,t)},clone:function(){return(new x).copy(this)},copy:function(t){t=t.data;var e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this},equals:function(t){var e=this.data;return t=t.data,e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]},isIdentity:function(){var t=this.data;return 1===t[0]&&0===t[1]&&0===t[2]&&0===t[3]&&0===t[4]&&1===t[5]&&0===t[6]&&0===t[7]&&0===t[8]&&0===t[9]&&1===t[10]&&0===t[11]&&0===t[12]&&0===t[13]&&0===t[14]&&1===t[15]},mul2:function(t,e){var i=t.data,s=e.data,n=this.data;e=i[0],t=i[1];var r=i[2],a=i[3],o=i[4],h=i[5],l=i[6],c=i[7],d=i[8],u=i[9],p=i[10],f=i[11],m=i[12],_=i[13],g=i[14];i=i[15];var y=s[0],v=s[1],b=s[2],x=s[3];return n[0]=e*y+o*v+d*b+m*x,n[1]=t*y+h*v+u*b+_*x,n[2]=r*y+l*v+p*b+g*x,n[3]=a*y+c*v+f*b+i*x,y=s[4],v=s[5],b=s[6],x=s[7],n[4]=e*y+o*v+d*b+m*x,n[5]=t*y+h*v+u*b+_*x,n[6]=r*y+l*v+p*b+g*x,n[7]=a*y+c*v+f*b+i*x,y=s[8],v=s[9],b=s[10],x=s[11],n[8]=e*y+o*v+d*b+m*x,n[9]=t*y+h*v+u*b+_*x,n[10]=r*y+l*v+p*b+g*x,n[11]=a*y+c*v+f*b+i*x,y=s[12],v=s[13],b=s[14],x=s[15],n[12]=e*y+o*v+d*b+m*x,n[13]=t*y+h*v+u*b+_*x,n[14]=r*y+l*v+p*b+g*x,n[15]=a*y+c*v+f*b+i*x,this},mulAffine2:function(t,e){var i=t.data,s=e.data,n=this.data;e=i[0],t=i[1];var r=i[2],a=i[4],o=i[5],h=i[6],l=i[8],c=i[9],d=i[10],u=i[12],p=i[13];i=i[14];var f=s[0],m=s[1],_=s[2];return n[0]=e*f+a*m+l*_,n[1]=t*f+o*m+c*_,n[2]=r*f+h*m+d*_,n[3]=0,f=s[4],m=s[5],_=s[6],n[4]=e*f+a*m+l*_,n[5]=t*f+o*m+c*_,n[6]=r*f+h*m+d*_,n[7]=0,f=s[8],m=s[9],_=s[10],n[8]=e*f+a*m+l*_,n[9]=t*f+o*m+c*_,n[10]=r*f+h*m+d*_,n[11]=0,f=s[12],m=s[13],_=s[14],n[12]=e*f+a*m+l*_+u,n[13]=t*f+o*m+c*_+p,n[14]=r*f+h*m+d*_+i,n[15]=1,this},mul:function(t){return this.mul2(this,t)},transformPoint:function(t,e){var i=this.data,s=t.x,n=t.y;return t=t.z,(e=void 0===e?new v:e).x=s*i[0]+n*i[4]+t*i[8]+i[12],e.y=s*i[1]+n*i[5]+t*i[9]+i[13],e.z=s*i[2]+n*i[6]+t*i[10]+i[14],e},transformVector:function(t,e){var i=this.data,s=t.x,n=t.y;return t=t.z,(e=void 0===e?new v:e).x=s*i[0]+n*i[4]+t*i[8],e.y=s*i[1]+n*i[5]+t*i[9],e.z=s*i[2]+n*i[6]+t*i[10],e},transformVec4:function(t,e){var i=this.data,s=t.x,n=t.y,r=t.z;return t=t.w,(e=void 0===e?new b:e).x=s*i[0]+n*i[4]+r*i[8]+t*i[12],e.y=s*i[1]+n*i[5]+r*i[9]+t*i[13],e.z=s*i[2]+n*i[6]+r*i[10]+t*i[14],e.w=s*i[3]+n*i[7]+r*i[11]+t*i[15],e},setLookAt:function(){var t=new v,e=new v,i=new v;return function(s,n,r){return i.sub2(s,n).normalize(),e.copy(r).normalize(),t.cross(e,i).normalize(),e.cross(i,t),(n=this.data)[0]=t.x,n[1]=t.y,n[2]=t.z,n[3]=0,n[4]=e.x,n[5]=e.y,n[6]=e.z,n[7]=0,n[8]=i.x,n[9]=i.y,n[10]=i.z,n[11]=0,n[12]=s.x,n[13]=s.y,n[14]=s.z,n[15]=1,this}}(),setFrustum:function(t,e,i,s,n,r){var a=2*n,o=e-t,h=s-i,l=r-n,c=this.data;return c[0]=a/o,c[1]=0,c[2]=0,c[3]=0,c[4]=0,c[5]=a/h,c[6]=0,c[7]=0,c[8]=(e+t)/o,c[9]=(s+i)/h,c[10]=(-r-n)/l,c[11]=-1,c[12]=0,c[13]=0,c[14]=-a*r/l,c[15]=0,this},setPerspective:function(t,e,i,s,n){return x._getPerspectiveHalfSize(ca,t,e,i,n),this.setFrustum(-ca.x,ca.x,-ca.y,ca.y,i,s)},setOrtho:function(t,e,i,s,n,r){var a=this.data;return a[0]=2/(e-t),a[1]=0,a[2]=0,a[3]=0,a[4]=0,a[5]=2/(s-i),a[6]=0,a[7]=0,a[8]=0,a[9]=0,a[10]=-2/(r-n),a[11]=0,a[12]=-(e+t)/(e-t),a[13]=-(s+i)/(s-i),a[14]=-(r+n)/(r-n),a[15]=1,this},setFromAxisAngle:function(t,e){e*=oa.DEG_TO_RAD;var i=t.x,s=t.y;t=t.z;var n=Math.cos(e);e=Math.sin(e);var r=1-n,a=r*i,o=r*s,h=this.data;return h[0]=a*i+n,h[1]=a*s+e*t,h[2]=a*t-e*s,h[3]=0,h[4]=a*s-e*t,h[5]=o*s+n,h[6]=o*t+e*i,h[7]=0,h[8]=a*t+e*s,h[9]=o*t-i*e,h[10]=r*t*t+n,h[11]=0,h[12]=0,h[13]=0,h[14]=0,h[15]=1,this},setTranslate:function(t,e,i){var s=this.data;return s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=1,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=t,s[13]=e,s[14]=i,s[15]=1,this},setScale:function(t,e,i){var s=this.data;return s[0]=t,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=e,s[6]=0,s[7]=0,s[8]=0,s[9]=0,s[10]=i,s[11]=0,s[12]=0,s[13]=0,s[14]=0,s[15]=1,this},invert:function(){var t=this.data,e=t[0],i=t[1],s=t[2],n=t[3],r=t[4],a=t[5],o=t[6],h=t[7],l=t[8],c=t[9],d=t[10],u=t[11],p=t[12],f=t[13],m=t[14],_=t[15],g=e*a-i*r,y=e*o-s*r,v=e*h-n*r,b=i*o-s*a,x=i*h-n*a,S=s*h-n*o,T=l*f-c*p,w=l*m-d*p,M=l*_-u*p,P=c*m-d*f,A=c*_-u*f,E=d*_-u*m,C=g*E-y*A+v*P+b*M-x*w+S*T;return 0===C?this.setIdentity():(C=1/C,t[0]=(a*E-o*A+h*P)*C,t[1]=(-i*E+s*A-n*P)*C,t[2]=(f*S-m*x+_*b)*C,t[3]=(-c*S+d*x-u*b)*C,t[4]=(-r*E+o*M-h*w)*C,t[5]=(e*E-s*M+n*w)*C,t[6]=(-p*S+m*v-_*y)*C,t[7]=(l*S-d*v+u*y)*C,t[8]=(r*A-a*M+h*T)*C,t[9]=(-e*A+i*M-n*T)*C,t[10]=(p*x-f*v+_*g)*C,t[11]=(-l*x+c*v-u*g)*C,t[12]=(-r*P+a*w-o*T)*C,t[13]=(e*P-i*w+s*T)*C,t[14]=(-p*b+f*y-m*g)*C,t[15]=(l*b-c*y+d*g)*C),this},set:function(t){var e=this.data;return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],this},setIdentity:function(){var t=this.data;return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},setTRS:function(t,e,i){var s=e.x,n=e.y,r=e.z,a=e.w;e=i.x;var o=i.y;i=i.z;var h=s+s,l=n+n,c=r+r,d=s*h,u=s*l;s*=c;var p=n*l;return n*=c,r*=c,h*=a,l*=a,a*=c,(c=this.data)[0]=(1-(p+r))*e,c[1]=(u+a)*e,c[2]=(s-l)*e,c[3]=0,c[4]=(u-a)*o,c[5]=(1-(d+r))*o,c[6]=(n+h)*o,c[7]=0,c[8]=(s+l)*i,c[9]=(n-h)*i,c[10]=(1-(d+p))*i,c[11]=0,c[12]=t.x,c[13]=t.y,c[14]=t.z,c[15]=1,this},transpose:function(){var t=this.data,e=t[1];return t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},invertTo3x3:function(t){var e=this.data;t=t.data;var i=e[0],s=e[1],n=e[2],r=e[4],a=e[5],o=e[6],h=e[8],l=e[9],c=e[10],d=-c*r+o*h,u=l*r-a*h,p=i*(e=c*a-o*l)+s*d+n*u;return 0===p?this:(p=1/p,t[0]=p*e,t[1]=p*(-c*s+n*l),t[2]=p*(o*s-n*a),t[3]=p*d,t[4]=p*(c*i-n*h),t[5]=p*(-o*i+n*r),t[6]=p*u,t[7]=p*(-l*i+s*h),t[8]=p*(a*i-s*r),this)},getTranslation:function(t){return(t=void 0===t?new v:t).set(this.data[12],this.data[13],this.data[14])},getX:function(t){return(t=void 0===t?new v:t).set(this.data[0],this.data[1],this.data[2])},getY:function(t){return(t=void 0===t?new v:t).set(this.data[4],this.data[5],this.data[6])},getZ:function(t){return(t=void 0===t?new v:t).set(this.data[8],this.data[9],this.data[10])},getScale:function(){var t=new v,e=new v,i=new v;return function(s){return s=void 0===s?new v:s,this.getX(t),this.getY(e),this.getZ(i),s.set(t.length(),e.length(),i.length()),s}}(),setFromEulerAngles:function(t,e,i){t*=oa.DEG_TO_RAD,e*=oa.DEG_TO_RAD,i*=oa.DEG_TO_RAD;var s=Math.sin(-t);t=Math.cos(-t);var n=Math.sin(-e);e=Math.cos(-e);var r=Math.sin(-i);i=Math.cos(-i);var a=this.data;return a[0]=e*i,a[1]=-e*r,a[2]=n,a[3]=0,a[4]=t*r+i*s*n,a[5]=t*i-s*n*r,a[6]=-e*s,a[7]=0,a[8]=s*r-t*i*n,a[9]=i*s+t*n*r,a[10]=t*e,a[11]=0,a[12]=0,a[13]=0,a[14]=0,a[15]=1,this},getEulerAngles:function(){var t=new v;return function(e){e=void 0===e?new v:e,this.getScale(t);var i=t.x,s=t.y,n=t.z,r=this.data,a=Math.asin(-r[2]/i),o=.5*Math.PI;return a<o?a>-o?(s=Math.atan2(r[6]/s,r[10]/n),i=Math.atan2(r[1]/i,r[0]/i)):(i=0,s=-Math.atan2(r[4]/s,r[5]/s)):(i=0,s=Math.atan2(r[4]/s,r[5]/s)),e.set(s,a,i).scale(oa.RAD_TO_DEG)}}(),toString:function(){var t,e="[";for(t=0;16>t;t+=1)e+=this.data[t],e+=15!==t?", ":"";return e+"]"}}),Object.defineProperties(x,{ZERO:{value:(new x).set([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0])},IDENTITY:{value:new x}}),Object.freeze(x.ZERO),Object.freeze(x.IDENTITY),Object.assign(S.prototype,{clone:function(){return new S(this.x,this.y,this.z,this.w)},conjugate:function(){return this.x*=-1,this.y*=-1,this.z*=-1,this},copy:function(t){return this.x=t.x,this.y=t.y,this.z=t.z,this.w=t.w,this},equals:function(t){return this.x===t.x&&this.y===t.y&&this.z===t.z&&this.w===t.w},getAxisAngle:function(t){var e=2*Math.acos(this.w),i=Math.sin(e/2);return 0!==i?(t.x=this.x/i,t.y=this.y/i,t.z=this.z/i,(0>t.x||0>t.y||0>t.z)&&(t.x*=-1,t.y*=-1,t.z*=-1,e*=-1)):(t.x=1,t.y=0,t.z=0),e*oa.RAD_TO_DEG},getEulerAngles:function(t){t=void 0===t?new v:t;var e=this.x,i=this.y,s=this.z,n=this.w,r=2*(n*i-e*s);if(-.99999>=r){var a=2*Math.atan2(e,n);r=-Math.PI/2,e=0}else.99999<=r?(a=2*Math.atan2(e,n),r=Math.PI/2,e=0):(a=Math.atan2(2*(n*e+i*s),1-2*(e*e+i*i)),r=Math.asin(r),e=Math.atan2(2*(n*s+e*i),1-2*(i*i+s*s)));return t.set(a,r,e).scale(oa.RAD_TO_DEG)},invert:function(){return this.conjugate().normalize()},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},mul:function(t){var e=this.x,i=this.y,s=this.z,n=this.w,r=t.x,a=t.y,o=t.z;return t=t.w,this.x=n*r+e*t+i*o-s*a,this.y=n*a+i*t+s*r-e*o,this.z=n*o+s*t+e*a-i*r,this.w=n*t-e*r-i*a-s*o,this},mul2:function(t,e){var i=t.x,s=t.y,n=t.z;t=t.w;var r=e.x,a=e.y,o=e.z;return e=e.w,this.x=t*r+i*e+s*o-n*a,this.y=t*a+s*e+n*r-i*o,this.z=t*o+n*e+i*a-s*r,this.w=t*e-i*r-s*a-n*o,this},normalize:function(){var t=this.length();return 0===t?(this.x=this.y=this.z=0,this.w=1):(t=1/t,this.x*=t,this.y*=t,this.z*=t,this.w*=t),this},set:function(t,e,i,s){return this.x=t,this.y=e,this.z=i,this.w=s,this},setFromAxisAngle:function(t,e){e*=.5*oa.DEG_TO_RAD;var i=Math.sin(e);return e=Math.cos(e),this.x=i*t.x,this.y=i*t.y,this.z=i*t.z,this.w=e,this},setFromEulerAngles:function(t,e,i){var s=.5*oa.DEG_TO_RAD;t*=s,e*=s,i*=s,s=Math.sin(t),t=Math.cos(t);var n=Math.sin(e);e=Math.cos(e);var r=Math.sin(i);return i=Math.cos(i),this.x=s*e*i-t*n*r,this.y=t*n*i+s*e*r,this.z=t*e*r-s*n*i,this.w=t*e*i+s*n*r,this},setFromMat4:function(t){var e=(t=t.data)[0],i=t[1],s=t[2],n=t[4],r=t[5],a=t[6],o=t[8],h=t[9];t=t[10];var l=e*e+i*i+s*s;if(0===l)return this;l=1/Math.sqrt(l);var c=n*n+r*r+a*a;if(0===c)return this;c=1/Math.sqrt(c);var d=o*o+h*h+t*t;return 0===d?this:(i*=l,s*=l,n*=c,a*=c,o*=d=1/Math.sqrt(d),h*=d,0<=(l=(e*=l)+(r*=c)+(t*=d))?(e=Math.sqrt(l+1),this.w=.5*e,e=.5/e,this.x=(a-h)*e,this.y=(o-s)*e,this.z=(i-n)*e):e>r?e>t?(e=Math.sqrt(e-(r+t)+1),this.x=.5*e,e=.5/e,this.w=(a-h)*e,this.y=(i+n)*e,this.z=(s+o)*e):(e=Math.sqrt(t-(e+r)+1),this.z=.5*e,e=.5/e,this.w=(i-n)*e,this.x=(o+s)*e,this.y=(h+a)*e):r>t?(e=Math.sqrt(r-(t+e)+1),this.y=.5*e,e=.5/e,this.w=(o-s)*e,this.z=(a+h)*e,this.x=(n+i)*e):(e=Math.sqrt(t-(e+r)+1),this.z=.5*e,e=.5/e,this.w=(i-n)*e,this.x=(o+s)*e,this.y=(h+a)*e),this)},slerp:function(t,e,i){var s=t.x,n=t.y,r=t.z;t=t.w;var a=e.x,o=e.y,h=e.z,l=t*(e=e.w)+s*a+n*o+r*h;if(0>l&&(e=-e,a=-a,o=-o,h=-h,l=-l),1<=Math.abs(l))return this.w=t,this.x=s,this.y=n,this.z=r,this;var c=Math.acos(l),d=Math.sqrt(1-l*l);return.001>Math.abs(d)?(this.w=.5*t+.5*e,this.x=.5*s+.5*a,this.y=.5*n+.5*o,this.z=.5*r+.5*h,this):(l=Math.sin((1-i)*c)/d,i=Math.sin(i*c)/d,this.w=t*l+e*i,this.x=s*l+a*i,this.y=n*l+o*i,this.z=r*l+h*i,this)},transformVector:function(t,e){void 0===e&&(e=new v);var i=t.x,s=t.y,n=t.z;t=this.x;var r=this.y,a=this.z,o=this.w,h=o*i+r*n-a*s,l=o*s+a*i-t*n,c=o*n+t*s-r*i;return i=-t*i-r*s-a*n,e.x=h*o+i*-t+l*-a-c*-r,e.y=l*o+i*-r+c*-t-h*-a,e.z=c*o+i*-a+h*-r-l*-t,e},toString:function(){return"["+this.x+", "+this.y+", "+this.z+", "+this.w+"]"}}),Object.defineProperties(S,{ZERO:{value:new S(0,0,0,0)},IDENTITY:{value:new S(0,0,0,1)}}),Object.freeze(S.ZERO),Object.freeze(S.IDENTITY);var da=new v,ua=new v,pa=new v,fa=new v,ma=new v;Object.assign(T.prototype,{add:function(t){var e=this.center,i=e.x,s=e.y,n=e.z,r=this.halfExtents,a=r.x,o=r.y,h=r.z,l=i-a;i+=a,a=s-o,s+=o,o=n-h,n+=h;var c=(h=t.center).x,d=h.y;h=h.z;var u=(t=t.halfExtents).x,p=t.y,f=t.z;(t=c-u)<l&&(l=t),(c+=u)>i&&(i=c),(u=d-p)<a&&(a=u),(d+=p)>s&&(s=d),(p=h-f)<o&&(o=p),(h+=f)>n&&(n=h),e.x=.5*(l+i),e.y=.5*(a+s),e.z=.5*(o+n),r.x=.5*(i-l),r.y=.5*(s-a),r.z=.5*(n-o)},copy:function(t){this.center.copy(t.center),this.halfExtents.copy(t.halfExtents),this.type=t.type},clone:function(){return new T(this.center.clone(),this.halfExtents.clone())},intersects:function(t){var e=this.getMax(),i=this.getMin(),s=t.getMax();return t=t.getMin(),i.x<=s.x&&e.x>=t.x&&i.y<=s.y&&e.y>=t.y&&i.z<=s.z&&e.z>=t.z},_intersectsRay:function(t,e){var i=da.copy(this.getMin()).sub(t.origin),s=ua.copy(this.getMax()).sub(t.origin),n=t.direction;return 0===n.x?(i.x=0>i.x?-Number.MAX_VALUE:Number.MAX_VALUE,s.x=0>s.x?-Number.MAX_VALUE:Number.MAX_VALUE):(i.x/=n.x,s.x/=n.x),0===n.y?(i.y=0>i.y?-Number.MAX_VALUE:Number.MAX_VALUE,s.y=0>s.y?-Number.MAX_VALUE:Number.MAX_VALUE):(i.y/=n.y,s.y/=n.y),0===n.z?(i.z=0>i.z?-Number.MAX_VALUE:Number.MAX_VALUE,s.z=0>s.z?-Number.MAX_VALUE:Number.MAX_VALUE):(i.z/=n.z,s.z/=n.z),n=pa.set(Math.min(i.x,s.x),Math.min(i.y,s.y),Math.min(i.z,s.z)),i=fa.set(Math.max(i.x,s.x),Math.max(i.y,s.y),Math.max(i.z,s.z)),s=Math.max(Math.max(n.x,n.y),n.z),(i=Math.min(Math.min(i.x,i.y),i.z)>=s&&0<=s)&&e.copy(t.direction).scale(s).add(t.origin),i},_fastIntersectsRay:function(t){var e=t.direction;return da.sub2(t.origin,this.center),fa.set(Math.abs(da.x),Math.abs(da.y),Math.abs(da.z)),pa.mul2(da,e),!(fa.x>this.halfExtents.x&&0<=pa.x||fa.y>this.halfExtents.y&&0<=pa.y||fa.z>this.halfExtents.z&&0<=pa.z)&&(ma.set(Math.abs(e.x),Math.abs(e.y),Math.abs(e.z)),ua.cross(e,da),ua.set(Math.abs(ua.x),Math.abs(ua.y),Math.abs(ua.z)),!(ua.x>this.halfExtents.y*ma.z+this.halfExtents.z*ma.y||ua.y>this.halfExtents.x*ma.z+this.halfExtents.z*ma.x||ua.z>this.halfExtents.x*ma.y+this.halfExtents.y*ma.x))},intersectsRay:function(t,e){return e?this._intersectsRay(t,e):this._fastIntersectsRay(t)},setMinMax:function(t,e){this.center.add2(e,t).scale(.5),this.halfExtents.sub2(e,t).scale(.5)},getMin:function(){return this._min.copy(this.center).sub(this.halfExtents)},getMax:function(){return this._max.copy(this.center).add(this.halfExtents)},containsPoint:function(t){var e=this.getMin(),i=this.getMax();return!(t.x<e.x||t.x>i.x||t.y<e.y||t.y>i.y||t.z<e.z||t.z>i.z)},setFromTransformedAabb:function(t,e){var i=t.center;t=t.halfExtents;var s=(e=e.data)[0],n=e[4],r=e[8],a=e[1],o=e[5],h=e[9],l=e[2],c=e[6],d=e[10];this.center.set(e[12]+s*i.x+n*i.y+r*i.z,e[13]+a*i.x+o*i.y+h*i.z,e[14]+l*i.x+c*i.y+d*i.z),this.halfExtents.set(Math.abs(s)*t.x+Math.abs(n)*t.y+Math.abs(r)*t.z,Math.abs(a)*t.x+Math.abs(o)*t.y+Math.abs(h)*t.z,Math.abs(l)*t.x+Math.abs(c)*t.y+Math.abs(d)*t.z)},compute:function(t,e){if(0<(e=void 0===e?t.length/3:e)){for(var i=da.set(t[0],t[1],t[2]),s=ua.set(t[0],t[1],t[2]),n=1;n<e;n++){var r=t[3*n],a=t[3*n+1],o=t[3*n+2];r<i.x&&(i.x=r),a<i.y&&(i.y=a),o<i.z&&(i.z=o),r>s.x&&(s.x=r),a>s.y&&(s.y=a),o>s.z&&(s.z=o)}this.setMinMax(i,s)}},intersectsBoundingSphere:function(t){return this._distanceToBoundingSphereSq(t)<=t.radius*t.radius},_distanceToBoundingSphereSq:function(t){for(var e=this.getMin(),i=this.getMax(),s=0,n=["x","y","z"],r=0;3>r;++r){var a=0,o=t.center[n[r]],h=e[n[r]],l=i[n[r]];o<h&&(a+=(h-=o)*h),o>l&&(a+=(h=o-l)*h),s+=a}return s},_expand:function(t,e){da.add2(this.getMin(),t),ua.add2(this.getMax(),e),this.setMinMax(da,ua)}});var _a=new v,ga=new v,ya=new v,va=new v;Object.assign(w.prototype,{containsPoint:function(t){t=_a.sub2(t,this.center).lengthSq();var e=this.radius;return t<e*e},compute:function(t){var e,i=t.length/3;for(e=0;e<i;e++)_a.set(t[3*e],t[3*e+1],t[3*e+2]),ya.addSelf(_a),0==e%100&&(ya.scale(1/i),ga.add(ya),ya.set(0,0,0));ya.scale(1/i),ga.add(ya),this.center.copy(ga);var s=0;for(e=0;e<i;e++)_a.set(t[3*e],t[3*e+1],t[3*e+2]),va.sub2(_a,this.center),s=Math.max(va.lengthSq(),s);this.radius=Math.sqrt(s)},intersectsRay:function(t,e){var i=_a.copy(t.origin).sub(this.center),s=i.dot(ga.copy(t.direction).normalize());return 0<(i=i.dot(i)-this.radius*this.radius)&&0<s?null:!(0>(i=s*s-i))&&(s=Math.abs(-s-Math.sqrt(i)),e&&e.copy(t.direction).scale(s).add(t.origin),!0)},intersectsBoundingSphere:function(t){return _a.sub2(t.center,this.center),t=t.radius+this.radius,_a.lengthSq()<=t*t}}),Object.assign(M.prototype,{setFromMat4:function(t){t=t.data;var e=this.planes,i=e[0];i[0]=t[3]-t[0],i[1]=t[7]-t[4],i[2]=t[11]-t[8],i[3]=t[15]-t[12];var s=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);i[0]/=s,i[1]/=s,i[2]/=s,i[3]/=s,(i=e[1])[0]=t[3]+t[0],i[1]=t[7]+t[4],i[2]=t[11]+t[8],i[3]=t[15]+t[12],s=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),i[0]/=s,i[1]/=s,i[2]/=s,i[3]/=s,(i=e[2])[0]=t[3]+t[1],i[1]=t[7]+t[5],i[2]=t[11]+t[9],i[3]=t[15]+t[13],s=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),i[0]/=s,i[1]/=s,i[2]/=s,i[3]/=s,(i=e[3])[0]=t[3]-t[1],i[1]=t[7]-t[5],i[2]=t[11]-t[9],i[3]=t[15]-t[13],s=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),i[0]/=s,i[1]/=s,i[2]/=s,i[3]/=s,(i=e[4])[0]=t[3]-t[2],i[1]=t[7]-t[6],i[2]=t[11]-t[10],i[3]=t[15]-t[14],s=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),i[0]/=s,i[1]/=s,i[2]/=s,i[3]/=s,(i=e[5])[0]=t[3]+t[2],i[1]=t[7]+t[6],i[2]=t[11]+t[10],i[3]=t[15]+t[14],s=Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]),i[0]/=s,i[1]/=s,i[2]/=s,i[3]/=s},containsPoint:function(t){var e;for(e=0;6>e;e++){var i=this.planes[e];if(0>=i[0]*t.x+i[1]*t.y+i[2]*t.z+i[3])return!1}return!0},containsSphere:function(t){var e=0,i=t.radius,s=t.center;t=s.x;var n=s.y,r=s.z,a=this.planes;for(s=0;6>s;s++){var o=a[s];if((o=o[0]*t+o[1]*n+o[2]*r+o[3])<=-i)return 0;o>i&&e++}return 6===e?2:1}}),P.prototype.set=function(t,e){return this.origin.copy(t),this.direction.copy(e),this};var ba=new P,xa=new v,Sa=new w,Ta=new x;Object.assign(A.prototype,{intersectsRay:function(t,e){return this._modelTransform.transformPoint(t.origin,ba.origin),this._modelTransform.transformVector(t.direction,ba.direction),e?(t=this._aabb._intersectsRay(ba,e),Ta.copy(this._modelTransform).invert().transformPoint(e,e),t):this._aabb._fastIntersectsRay(ba)},containsPoint:function(t){return this._modelTransform.transformPoint(t,xa),this._aabb.containsPoint(xa)},intersectsBoundingSphere:function(t){return this._modelTransform.transformPoint(t.center,Sa.center),Sa.radius=t.radius,!!this._aabb.intersectsBoundingSphere(Sa)}}),Object.defineProperty(A.prototype,"worldTransform",{get:function(){return this._worldTransform},set:function(t){this._worldTransform.copy(t),this._modelTransform.copy(t).invert()}});var wa=new v;Object.assign(E.prototype,{intersectsLine:function(t,e,i){var s=-this.normal.dot(this.point),n=this.normal.dot(t)+s;return(s=0<=(n/=n-(s=this.normal.dot(e)+s))&&1>=n)&&i&&i.lerp(t,e,n),s},intersectsRay:function(t,e){var i=wa.sub2(this.point,t.origin),s=0<=(i=this.normal.dot(i)/this.normal.dot(t.direction));return s&&e&&e.copy(t.direction).scale(i).add(t.origin),s}});var Ma=[Int8Array,Uint8Array,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array],Pa=[1,1,2,2,4,4,4],Aa=[Uint8Array,Uint16Array,Uint32Array],Ea={POSITION:0,NORMAL:1,BLENDWEIGHT:2,BLENDINDICES:3,COLOR:4,TEXCOORD0:5,TEXCOORD1:6,TEXCOORD2:7,TEXCOORD3:8,TEXCOORD4:9,TEXCOORD5:10,TEXCOORD6:11,TEXCOORD7:12,TANGENT:13,ATTR0:0,ATTR1:1,ATTR2:2,ATTR3:3,ATTR4:4,ATTR5:5,ATTR6:6,ATTR7:7,ATTR8:8,ATTR9:9,ATTR10:10,ATTR11:11,ATTR12:12,ATTR13:13,ATTR14:14,ATTR15:15},Ca=0;Object.assign(C.prototype,{destroy:function(){var t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.bufferId&&(e=t.gl,t.boundVao=null,e.bindVertexArray(null),e.deleteBuffer(this.bufferId),t._vram.vb-=this.storage.byteLength,this.bufferId=null)},getFormat:function(){return this.format},getUsage:function(){return this.usage},getNumVertices:function(){return this.numVertices},lock:function(){return this.storage},unlock:function(){var t=this.device.gl;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case 0:var e=t.STATIC_DRAW;break;case 1:e=t.DYNAMIC_DRAW;break;case 2:e=t.STREAM_DRAW;break;case 3:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ARRAY_BUFFER,this.bufferId),t.bufferData(t.ARRAY_BUFFER,this.storage,e)},setData:function(t){return t.byteLength!==this.numBytes?(console.error("VertexBuffer: wrong initial data size: expected "+this.numBytes+", got "+t.byteLength),!1):(this.storage=t,this.unlock(),!0)}}),O.init=function(t){this._defaultInstancingFormat=new O(t,[{semantic:"TEXCOORD2",components:4,type:6},{semantic:"TEXCOORD3",components:4,type:6},{semantic:"TEXCOORD4",components:4,type:6},{semantic:"TEXCOORD5",components:4,type:6}])},Object.defineProperty(O,"defaultInstancingFormat",{get:function(){return this._defaultInstancingFormat}}),Object.assign(O.prototype,{update:function(){this._evaluateHash()},_evaluateHash:function(){var t,e=[],i=[],s=this.elements.length;for(t=0;t<s;t++){var n=this.elements[t],r=n.name;r+=n.dataType,r+=n.numComponents,r+=n.normalize,e.push(r),r+=n.offset,r+=n.stride,r+=n.size,i.push(r)}e.sort(),this.batchingHash=I(e.join()),this.renderingingHash=I(i.join())}}),R.prototype.get=function(t){return this.array[this.index+t]},R.prototype.set=function(t,e,i,s){},R.prototype.setFromArray=function(t,e,i){},R.prototype.getToArray=function(t,e,i){},Object.assign(W.prototype,{next:function(t){void 0===t&&(t=1);for(var e=0,i=this.accessors,s=this.accessors.length;e<s;){var n=i[e++];n.index+=t*n.stride}},end:function(){this.vertexBuffer.unlock()},writeData:function(t,e,i){if(t=this.element[t]){i>this.vertexBuffer.numVertices&&(i=this.vertexBuffer.numVertices);var s,n=t.numComponents;if(this.vertexBuffer.getFormat().interleaved){var r=0;for(s=0;s<i;s++)t.setFromArray(r,e,s*n),r+=t.stride}else if(e.length>i*n)if(i*=n,ArrayBuffer.isView(e))e=e.subarray(0,i),t.array.set(e);else for(s=0;s<i;s++)t.array[s]=e[s];else t.array.set(e)}},readData:function(t,e){var i=0;if(t=this.element[t]){i=this.vertexBuffer.numVertices;var s,n=t.numComponents;if(this.vertexBuffer.getFormat().interleaved){Array.isArray(e)&&(e.length=0);var r=t.index=0;for(s=0;s<i;s++)t.getToArray(r,e,s*n),r+=t.stride}else if(ArrayBuffer.isView(e))e.set(t.array);else for(e.length=0,n*=i,s=0;s<n;s++)e[s]=t.array[s]}return i}});var Ia=null,Oa={type:5,base:0,count:4,indexed:!1};Object.assign(q.prototype,{destroy:function(){this.device.destroyShader(this)}});var Ra={alphaTestPS:"uniform float alpha_ref;\nvoid alphaTest(float a) {\n\tif (a < alpha_ref) discard;\n}\n",ambientConstantPS:"void addAmbient() {\n\tdDiffuseLight += light_globalAmbient;\n}\n",ambientPrefilteredCubePS:"#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n\tfixedReflDir.x *= -1.0;\n\tdDiffuseLight += processEnvironment($DECODE(textureCube(texture_prefilteredCubeMap4, fixedReflDir)).rgb);\n}\n",ambientPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nvoid addAmbient() {\n\tvec3 fixedReflDir = fixSeamsStatic(dNormalW, 1.0 - 1.0 / 4.0);\n\tfixedReflDir.x *= -1.0;\n\tdDiffuseLight += processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, 5.0) ).rgb);\n}\n",ambientSHPS:"uniform vec3 ambientSH[9];\nvoid addAmbient() {\n\tvec3 n = dNormalW;\n\tvec3 color =\n\t\tambientSH[0] +\n\t\tambientSH[1] * n.x +\n\t\tambientSH[2] * n.y +\n\t\tambientSH[3] * n.z +\n\t\tambientSH[4] * n.x * n.z +\n\t\tambientSH[5] * n.z * n.y +\n\t\tambientSH[6] * n.y * n.x +\n\t\tambientSH[7] * (3.0 * n.z * n.z - 1.0) +\n\t\tambientSH[8] * (n.x * n.x - n.y * n.y);\n\tdDiffuseLight += processEnvironment(max(color, vec3(0.0)));\n}\n",aoPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_aoMap;\n#endif\nvoid applyAO() {\n\tdAo = 1.0;\n\t#ifdef MAPTEXTURE\n\tdAo *= texture2D(texture_aoMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAo *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight *= dAo;\n}\n",aoSpecOccPS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tspecOcc = mix(1.0, specOcc, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstPS:"void occludeSpecular() {\n\tfloat specPow = exp2(dGlossiness * 11.0);\n\tfloat specOcc = saturate(pow(dot(dNormalW, dViewDirW) + dAo, 0.01*specPow) - 1.0 + dAo);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccConstSimplePS:"void occludeSpecular() {\n\tfloat specOcc = dAo;\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",aoSpecOccSimplePS:"uniform float material_occludeSpecularIntensity;\nvoid occludeSpecular() {\n\tfloat specOcc = mix(1.0, dAo, material_occludeSpecularIntensity);\n\tdSpecularLight *= specOcc;\n\tdReflection *= specOcc;\n}\n",bakeDirLmEndPS:"\tvec4 dirLm = texture2D(texture_dirLightMap, vUv1);\n\tif (bakeDir > 0.5) {\n\t\tif (dAtten > 0.00001) {\n\t\t\tdirLm.xyz = dirLm.xyz * 2.0 - vec3(1.0);\n\t\t\tdAtten = saturate(dAtten);\n\t\t\tgl_FragColor.rgb = normalize(dLightDirNormW.xyz*dAtten + dirLm.xyz*dirLm.w) * 0.5 + vec3(0.5);\n\t\t\tgl_FragColor.a = dirLm.w + dAtten;\n\t\t\tgl_FragColor.a = max(gl_FragColor.a, 1.0 / 255.0);\n\t\t} else {\n\t\t\tgl_FragColor = dirLm;\n\t\t}\n\t} else {\n\t\tgl_FragColor.rgb = dirLm.xyz;\n\t\tgl_FragColor.a = max(dirLm.w, dAtten > 0.00001? (1.0/255.0) : 0.0);\n\t}\n",bakeLmEndPS:"\tgl_FragColor.rgb = dDiffuseLight;\n\tgl_FragColor.rgb = pow(gl_FragColor.rgb, vec3(0.5));\n\tgl_FragColor.rgb /= 8.0;\n\tgl_FragColor.a = clamp( max( max( gl_FragColor.r, gl_FragColor.g ), max( gl_FragColor.b, 1.0 / 255.0 ) ), 0.0,1.0 );\n\tgl_FragColor.a = ceil(gl_FragColor.a * 255.0) / 255.0;\n\tgl_FragColor.rgb /= gl_FragColor.a;\n",basePS:"uniform vec3 view_position;\nuniform vec3 light_globalAmbient;\nfloat square(float x) {\n\treturn x*x;\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 saturate(vec3 x) {\n\treturn clamp(x, vec3(0.0), vec3(1.0));\n}\n",baseVS:"attribute vec3 vertex_position;\nattribute vec3 vertex_normal;\nattribute vec4 vertex_tangent;\nattribute vec2 vertex_texCoord0;\nattribute vec2 vertex_texCoord1;\nattribute vec4 vertex_color;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nvec3 dPositionW;\nmat4 dModelMatrix;\nmat3 dNormalMatrix;\nvec3 dLightPosW;\nvec3 dLightDirNormW;\nvec3 dNormalW;\n",baseNineSlicedPS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",baseNineSlicedVS:"#define NINESLICED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\n",baseNineSlicedTiledPS:"#define NINESLICED\n#define NINESLICETILED\nvarying vec2 vMask;\nvarying vec2 vTiledUv;\nuniform mediump vec4 innerOffset;\nuniform mediump vec2 outerScale;\nuniform mediump vec4 atlasRect;\nvec2 nineSlicedUv;\n",biasConstPS:"#define SHADOWBIAS\nfloat getShadowBias(float resolution, float maxBias) {\n\treturn maxBias;\n}\n",blurVSMPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\n#ifdef GAUSS\nuniform float weight[SAMPLES];\n#endif\n#ifdef PACKED\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\n#endif\nvoid main(void) {\n\tvec3 moments = vec3(0.0);\n\tvec2 uv = vUv0 - pixelOffset * (float(SAMPLES) * 0.5);\n\tfor (int i=0; i<SAMPLES; i++) {\n\t\tvec4 c = texture2D(source, uv + pixelOffset * float(i));\n\t\t#ifdef PACKED\n\t\tc.xy = vec2(decodeFloatRG(c.xy), decodeFloatRG(c.zw));\n\t\t#endif\n\t\t#ifdef GAUSS\n\t\tmoments += c.xyz * weight[i];\n\t\t#else\n\t\tmoments += c.xyz;\n\t\t#endif\n\t}\n\t#ifndef GAUSS\n\tmoments /= float(SAMPLES);\n\t#endif\n\t#ifdef PACKED\n\tgl_FragColor = vec4(encodeFloatRG(moments.x), encodeFloatRG(moments.y));\n\t#else\n\tgl_FragColor = vec4(moments.x, moments.y, moments.z, 1.0);\n\t#endif\n}\n",clearCoatPS:"#ifdef MAPFLOAT\nuniform float material_clearCoat;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatMap;\n#endif\nvoid getClearCoat() {\n\tccSpecularity = 1.0;\n\t#ifdef MAPFLOAT\n\tccSpecularity *= material_clearCoat;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccSpecularity *= texture2D(texture_clearCoatMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",clearCoatGlossPS:"#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGlossiness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tccGlossiness += 0.0000001;\n}\n",clearCoatNormalPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatNormalMap;\nuniform float material_clearCoatBumpiness;\n#endif\nvoid getClearCoatNormal() {\n\t#ifdef MAPTEXTURE\n\tvec3 normalMap = unpackNormal(texture2D(texture_clearCoatNormalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_clearCoatBumpiness));\n\tccNormalW = dTBN * normalMap;\n\t#else\n\tccNormalW = normalize(dVertexNormalW);\n\t#endif\n\tccReflDirW = normalize(-reflect(dViewDirW, ccNormalW));\n}\n",combineClearCoatPS:"vec3 combineColorCC() {\n\treturn combineColor()+(ccSpecularLight*ccSpecularity+ccReflection.rgb*ccSpecularity*ccReflection.a);\n}\n",combineDiffusePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight;\n}\n",combineDiffuseSpecularPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight, dSpecularLight + dReflection.rgb * dReflection.a, dSpecularity);\n}\n",combineDiffuseSpecularNoConservePS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + (dSpecularLight + dReflection.rgb * dReflection.a) * dSpecularity;\n}\n",combineDiffuseSpecularNoReflPS:"vec3 combineColor() {\n\treturn dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity;\n}\n",combineDiffuseSpecularNoReflSeparateAmbientPS:"uniform vec3 material_ambient;\nvec3 combineColor() {\n\treturn (dDiffuseLight - light_globalAmbient) * dAlbedo + dSpecularLight * dSpecularity + material_ambient * light_globalAmbient;\n}\n",combineDiffuseSpecularOldPS:"vec3 combineColor() {\n\treturn mix(dAlbedo * dDiffuseLight + dSpecularLight * dSpecularity, dReflection.rgb, dReflection.a);\n}\n",cookiePS:"vec4 getCookie2D(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DClip(sampler2D tex, mat4 transform, float intensity) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\treturn mix(vec4(1.0), texture2D(tex, projPos.xy), intensity);\n}\nvec4 getCookie2DXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookie2DClipXform(sampler2D tex, mat4 transform, float intensity, vec4 cookieMatrix, vec2 cookieOffset) {\n\tvec4 projPos = transform * vec4(vPositionW, 1.0);\n\tprojPos.xy /= projPos.w;\n\tprojPos.xy += cookieOffset;\n\tif (projPos.x < 0.0 || projPos.x > 1.0 || projPos.y < 0.0 || projPos.y > 1.0 || projPos.z < 0.0) return vec4(0.0);\n\tvec2 uv = mat2(cookieMatrix) * (projPos.xy-vec2(0.5)) + vec2(0.5);\n\treturn mix(vec4(1.0), texture2D(tex, uv), intensity);\n}\nvec4 getCookieCube(samplerCube tex, mat4 transform, float intensity) {\n\treturn mix(vec4(1.0), textureCube(tex, dLightDirNormW * mat3(transform)), intensity);\n}\n",cubeMapProjectBoxPS:"uniform vec3 envBoxMin, envBoxMax;\nvec3 cubeMapProject(vec3 nrdir) {\n\tvec3 rbmax = (envBoxMax - vPositionW) / nrdir;\n\tvec3 rbmin = (envBoxMin - vPositionW) / nrdir;\n\tvec3 rbminmax;\n\trbminmax.x = nrdir.x>0.0? rbmax.x : rbmin.x;\n\trbminmax.y = nrdir.y>0.0? rbmax.y : rbmin.y;\n\trbminmax.z = nrdir.z>0.0? rbmax.z : rbmin.z;\n\tfloat fa = min(min(rbminmax.x, rbminmax.y), rbminmax.z);\n\tvec3 posonbox = vPositionW + nrdir * fa;\n\tvec3 envBoxPos = (envBoxMin + envBoxMax) * 0.5;\n\treturn posonbox - envBoxPos;\n}\n",cubeMapProjectNonePS:"vec3 cubeMapProject(vec3 dir) {\n\treturn dir;\n}\n",detailModesPS:"vec3 detailMode_mul(vec3 c1, vec3 c2) {\n\treturn c1 * c2;\n}\nvec3 detailMode_add(vec3 c1, vec3 c2) {\n\treturn c1 + c2;\n}\nvec3 detailMode_screen(vec3 c1, vec3 c2) {\n\treturn 1.0 - (1.0 - c1)*(1.0 - c2);\n}\nvec3 detailMode_overlay(vec3 c1, vec3 c2) {\n\treturn mix(1.0 - 2.0*(1.0 - c1)*(1.0 - c2), 2.0*c1*c2, step(c1, vec3(0.5)));\n}\nvec3 detailMode_min(vec3 c1, vec3 c2) {\n\treturn min(c1, c2);\n}\nvec3 detailMode_max(vec3 c1, vec3 c2) {\n\treturn max(c1, c2);\n}\n",diffusePS:"#ifdef MAPCOLOR\nuniform vec3 material_diffuse;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseMap;\n#endif\nvoid getAlbedo() {\n\tdAlbedo = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdAlbedo *= material_diffuse.rgb;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlbedo *= gammaCorrectInput(addAlbedoDetail(texture2D(texture_diffuseMap, $UV).$CH));\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlbedo *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n}\n",diffuseDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_diffuseDetailMap;\n#endif\nvec3 addAlbedoDetail(vec3 albedo) {\n\t#ifdef MAPTEXTURE\n\tvec3 albedoDetail = vec3(texture2D(texture_diffuseDetailMap, $UV).$CH);\n\treturn detailMode_$DETAILMODE(albedo, albedoDetail);\n\t#else\n\treturn albedo;\n\t#endif\n}\n",dilatePS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec2 pixelOffset;\nvoid main(void) {\n\tvec4 c = texture2D(source, vUv0);\n\tc = c.a>0.0? c : texture2D(source, vUv0 - pixelOffset);\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, -pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(pixelOffset.x, 0));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(-pixelOffset.x, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + vec2(0, pixelOffset.y));\n\tc = c.a>0.0? c : texture2D(source, vUv0 + pixelOffset);\n\tgl_FragColor = c;\n}\n",dpAtlasQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tuv = uv * 2.0 - vec2(1.0);\n\tuv *= params.xy;\n\tuv = uv * 0.5 + 0.5;\n\tgl_FragColor = texture2D(source, uv);\n}\n",emissivePS:"#ifdef MAPCOLOR\nuniform vec3 material_emissive;\n#endif\n#ifdef MAPFLOAT\nuniform float material_emissiveIntensity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_emissiveMap;\n#endif\nvec3 getEmission() {\n\tvec3 emission = vec3(1.0);\n\t#ifdef MAPFLOAT\n\temission *= material_emissiveIntensity;\n\t#endif\n\t#ifdef MAPCOLOR\n\temission *= material_emissive;\n\t#endif\n\t#ifdef MAPTEXTURE\n\temission *= $texture2DSAMPLE(texture_emissiveMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\temission *= gammaCorrectInput(saturate(vVertexColor.$VC));\n\t#endif\n\treturn emission;\n}\n",endPS:"\t#ifdef CLEARCOAT\n\tgl_FragColor.rgb = combineColorCC();\n\t#else\n\tgl_FragColor.rgb = combineColor();\n\t#endif\n\tgl_FragColor.rgb += getEmission();\n\tgl_FragColor.rgb = addFog(gl_FragColor.rgb);\n\t#ifndef HDR\n\tgl_FragColor.rgb = toneMap(gl_FragColor.rgb);\n\tgl_FragColor.rgb = gammaCorrectOutput(gl_FragColor.rgb);\n\t#endif\n",envConstPS:"vec3 processEnvironment(vec3 color) {\n\treturn color;\n}\n",envMultiplyPS:"uniform float skyboxIntensity;\nvec3 processEnvironment(vec3 color) {\n\treturn color * skyboxIntensity;\n}\n",extensionPS:"\n",extensionVS:"\n",falloffInvSquaredPS:"float getFalloffInvSquared(float lightRadius) {\n\tfloat sqrDist = dot(dLightDirW, dLightDirW);\n\tfloat falloff = 1.0 / (sqrDist + 1.0);\n\tfloat invRadius = 1.0 / lightRadius;\n\tfalloff *= 16.0;\n\tfalloff *= square( saturate( 1.0 - square( sqrDist * square(invRadius) ) ) );\n\treturn falloff;\n}\n",falloffLinearPS:"float getFalloffLinear(float lightRadius) {\n\tfloat d = length(dLightDirW);\n\treturn max(((lightRadius - d) / lightRadius), 0.0);\n}\n",fixCubemapSeamsNonePS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\treturn vec;\n}\n",fixCubemapSeamsStretchPS:"vec3 fixSeams(vec3 vec, float mipmapIndex) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeams(vec3 vec) {\n\tfloat scale = 1.0 - 1.0 / 128.0;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvec3 fixSeamsStatic(vec3 vec, float invRecMipSize) {\n\tfloat scale = invRecMipSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\n",fogExpPS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogExp2PS:"uniform vec3 fog_color;\nuniform float fog_density;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = exp(-depth * depth * fog_density * fog_density);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogLinearPS:"uniform vec3 fog_color;\nuniform float fog_start;\nuniform float fog_end;\nfloat dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\tfloat depth = gl_FragCoord.z / gl_FragCoord.w;\n\tfloat fogFactor = (fog_end - depth) / (fog_end - fog_start);\n\tfogFactor = clamp(fogFactor, 0.0, 1.0);\n\tfogFactor = gammaCorrectInput(fogFactor);\n\treturn mix(fog_color * dBlendModeFogFactor, color, fogFactor);\n}\n",fogNonePS:"float dBlendModeFogFactor = 1.0;\nvec3 addFog(vec3 color) {\n\treturn color;\n}\n",fresnelSchlickPS:"\nuniform float material_fresnelFactor;\nvoid getFresnel() {\n\tfloat fresnel = 1.0 - max(dot(dNormalW, dViewDirW), 0.0);\n\tfloat fresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= dGlossiness * dGlossiness;\n\tdSpecularity = dSpecularity + (1.0 - dSpecularity) * fresnel;\n\t#ifdef CLEARCOAT\n\tfresnel = 1.0 - max(dot(ccNormalW, dViewDirW), 0.0);\n\tfresnel2 = fresnel * fresnel;\n\tfresnel *= fresnel2 * fresnel2;\n\tfresnel *= ccGlossiness * ccGlossiness;\n\tccSpecularity = ccSpecularity + (1.0 - ccSpecularity) * fresnel;\n\t#endif\n}\n",fullscreenQuadPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",fullscreenQuadVS:"attribute vec2 vertex_position;\nvarying vec2 vUv0;\nvoid main(void)\n{\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tvUv0 = vertex_position.xy*0.5+0.5;\n}\n",gamma1_0PS:"vec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\treturn texture2D(tex, uv);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\treturn texture2D(tex, uv, bias);\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\treturn textureCube(tex, uvw);\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\treturn color;\n}\nvec3 gammaCorrectInput(vec3 color) {\n\treturn color;\n}\nfloat gammaCorrectInput(float color) {\n\treturn color;\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn color;\n}\n",gamma2_2PS:"vec3 gammaCorrectInput(vec3 color) {\n\treturn pow(color, vec3(2.2));\n}\nfloat gammaCorrectInput(float color) {\n\treturn pow(color, 2.2);\n}\nvec4 gammaCorrectInput(vec4 color) {\n\treturn vec4(pow(color.rgb, vec3(2.2)), color.a);\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv) {\n\tvec4 rgba = texture2D(tex, uv);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 texture2DSRGB(sampler2D tex, vec2 uv, float bias) {\n\tvec4 rgba = texture2D(tex, uv, bias);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec4 textureCubeSRGB(samplerCube tex, vec3 uvw) {\n\tvec4 rgba = textureCube(tex, uvw);\n\trgba.rgb = gammaCorrectInput(rgba.rgb);\n\treturn rgba;\n}\nvec3 gammaCorrectOutput(vec3 color) {\n\t#ifdef HDR\n\treturn color;\n\t#else\n\tcolor += vec3(0.0000001);\n\treturn pow(color, vec3(0.45));\n\t#endif\n}\n",genParaboloidPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nvoid main(void) {\n\tvec2 uv = vUv0;\n\tfloat side = uv.x < 0.5? 1.0 : -1.0;\n\tvec2 tc;\n\ttc.x = fract(uv.x * 2.0) * 2.0 - 1.0;\n\ttc.y = uv.y * 2.0 - 1.0;\n\tconst float scale = 1.1;\n\ttc *= scale;\n\tvec3 dir;\n\tdir.y = (dot(tc, tc) - 1.0) * side;\n\tdir.xz = tc * -2.0;\n\tdir.x *= -side * params.y;\n\tdir = fixSeams(dir, params.x);\n\tvec4 color = textureCube(source, dir, -100.0);\n\tgl_FragColor = color;\n}\n",gles3PS:"#define varying in\nout highp vec4 pc_fragColor;\n#define gl_FragColor pc_fragColor\n#define texture2D texture\n#define textureCube texture\n#define texture2DProj textureProj\n#define texture2DLodEXT textureLod\n#define texture2DProjLodEXT textureProjLod\n#define textureCubeLodEXT textureLod\n#define texture2DGradEXT textureGrad\n#define texture2DProjGradEXT textureProjGrad\n#define textureCubeGradEXT textureGrad\n#define GL2\n",gles3VS:"#define attribute in\n#define varying out\n#define texture2D texture\n#define GL2\n#define VERTEXSHADER\n",glossPS:"#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\t#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n\t#endif\n\tdGlossiness += 0.0000001;\n}\n",instancingVS:"attribute vec4 instance_line1;\nattribute vec4 instance_line2;\nattribute vec4 instance_line3;\nattribute vec4 instance_line4;\n",lightDiffuseLambertPS:"float getLightDiffuse() {\n\treturn max(dot(dNormalW, -dLightDirNormW), 0.0);\n}\n",lightDirPointPS:"void getLightDirPoint(vec3 lightPosW) {\n\tdLightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(dLightDirW);\n\tdLightPosW = lightPosW;\n}\n",lightmapDirPS:"uniform sampler2D texture_lightMap;\nuniform sampler2D texture_dirLightMap;\nvoid addLightMap() {\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tvec4 dir = texture2D(texture_dirLightMap, $UV);\n\tif (dot(dir.xyz,vec3(1.0)) < 0.00001) {\n\t\tdDiffuseLight += color;\n\t\treturn;\n\t}\n\tdLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n\tfloat vlight = saturate(dot(dLightDirNormW, -dVertexNormalW));\n\tfloat flight = saturate(dot(dLightDirNormW, -dNormalW));\n\tfloat nlight = (flight / max(vlight,0.01)) * 0.5;\n\tdDiffuseLight += color * nlight * 2.0;\n}\nvoid addDirLightMap() {\n\tvec4 dir = texture2D(texture_dirLightMap, $UV);\n\tif (dot(dir.xyz,vec3(1.0)) < 0.00001) return;\n\tvec3 color = $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\tdLightDirNormW = normalize(dir.xyz * 2.0 - vec3(1.0));\n\tdSpecularLight += vec3(getLightSpecular()) * color;\n}\n",lightmapSinglePS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_lightMap;\n#endif\nvoid addLightMap() {\n\tvec3 lm = vec3(1.0);\n\t#ifdef MAPTEXTURE\n\tlm *= $texture2DSAMPLE(texture_lightMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tlm *= saturate(vVertexColor.$VC);\n\t#endif\n\tdDiffuseLight += lm;\n}\n",lightmapSingleVertPS:"void addLightMap() {\n\tdDiffuseLight += saturate(vVertexColor.$CH);\n}\n",lightSpecularAnisoGGXPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tfloat PI = 3.141592653589793;\n\tfloat roughness = max((1.0 - tGlossiness) * (1.0 - tGlossiness), 0.001);\n\tfloat anisotropy = material_anisotropy * roughness;\n\tfloat at = max((roughness + anisotropy), roughness / 4.0);\n\tfloat ab = max((roughness - anisotropy), roughness / 4.0);\n\tvec3 h = normalize(normalize(-dLightDirNormW) + normalize(dViewDirW));\n\tfloat NoH = dot(tNormalW, h);\n\tfloat ToH = dot(dTBN[0], h);\n\tfloat BoH = dot(dTBN[1], h);\n\tfloat a2 = at * ab;\n\tvec3 v = vec3(ab * ToH, at * BoH, a2 * NoH);\n\tfloat v2 = dot(v, v);\n\tfloat w2 = a2 / v2;\n\tfloat D = a2 * w2 * w2 * (1.0 / PI);\n\tfloat ToV = dot(dTBN[0], dViewDirW);\n\tfloat BoV = dot(dTBN[1], dViewDirW);\n\tfloat ToL = dot(dTBN[0], -dLightDirNormW);\n\tfloat BoL = dot(dTBN[1], -dLightDirNormW);\n\tfloat NoV = dot(tNormalW, dViewDirW);\n\tfloat NoL = dot(tNormalW, -dLightDirNormW);\n\tfloat lambdaV = NoL * length(vec3(at * ToV, ab * BoV, NoV));\n\tfloat lambdaL = NoV * length(vec3(at * ToL, ab * BoL, NoL));\n\tfloat G = 0.5 / (lambdaV + lambdaL);\n\treturn D * G;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularBlinnPS:"\nfloat calcLightSpecular(float tGlossiness, vec3 tNormalW) {\n\tvec3 h = normalize( -dLightDirNormW + dViewDirW );\n\tfloat nh = max( dot( h, tNormalW ), 0.0 );\n\tfloat specPow = exp2(tGlossiness * 11.0);\n\tspecPow = antiAliasGlossiness(specPow);\n\tspecPow = max(specPow, 0.0001);\n\treturn pow(nh, specPow) * (specPow + 2.0) / 8.0;\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dNormalW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccNormalW);\n}\n",lightSpecularPhongPS:"float calcLightSpecular(float tGlossiness, vec3 tReflDirW) {\n\tfloat specPow = tGlossiness;\n\tspecPow = antiAliasGlossiness(specPow);\n\treturn pow(max(dot(tReflDirW, -dLightDirNormW), 0.0), specPow + 0.0001);\n}\nfloat getLightSpecular() {\n\treturn calcLightSpecular(dGlossiness, dReflDirW);\n}\nfloat getLightSpecularCC() {\n\treturn calcLightSpecular(ccGlossiness, ccReflDirW);\n}\n",metalnessPS:"void processMetalness(float metalness) {\n\tconst float dielectricF0 = 0.04;\n\tdSpecularity = mix(vec3(dielectricF0), dAlbedo, metalness);\n\tdAlbedo *= 1.0 - metalness;\n}\n#ifdef MAPFLOAT\nuniform float material_metalness;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_metalnessMap;\n#endif\nvoid getSpecularity() {\n\tfloat metalness = 1.0;\n\t#ifdef MAPFLOAT\n\tmetalness *= material_metalness;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tmetalness *= texture2D(texture_metalnessMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tmetalness *= saturate(vVertexColor.$VC);\n\t#endif\n\tprocessMetalness(metalness);\n}\n",msdfPS:"uniform sampler2D texture_msdfMap;\n#ifdef GL_OES_standard_derivatives\n#define USE_FWIDTH\n#endif\n#ifdef GL2\n#define USE_FWIDTH\n#endif\nfloat median(float r, float g, float b) {\n\treturn max(min(r, g), min(max(r, g), b));\n}\nfloat map (float min, float max, float v) {\n\treturn (v - min) / (max - min);\n}\nuniform float font_sdfIntensity;\nuniform float font_pxrange;\nuniform float font_textureWidth;\nuniform vec4 outline_color;\nuniform float outline_thickness;\nuniform vec4 shadow_color;\nuniform vec2 shadow_offset;\nvec4 applyMsdf(vec4 color) {\n\tvec3 tsample = texture2D(texture_msdfMap, vUv0).rgb;\n\tvec2 uvShdw = vUv0 - shadow_offset;\n\tvec3 ssample = texture2D(texture_msdfMap, uvShdw).rgb;\n\tfloat sigDist = median(tsample.r, tsample.g, tsample.b);\n\tfloat sigDistShdw = median(ssample.r, ssample.g, ssample.b);\n\t#ifdef USE_FWIDTH\n\tvec2 w = fwidth(vUv0);\n\tfloat smoothing = clamp(w.x * font_textureWidth / font_pxrange, 0.0, 0.5);\n\t#else\n\tfloat font_size = 16.0;\n\tfloat smoothing = clamp(font_pxrange / font_size, 0.0, 0.5);\n\t#endif\n\tfloat mapMin = 0.05;\n\tfloat mapMax = clamp(1.0 - font_sdfIntensity, mapMin, 1.0);\n\tfloat sigDistInner = map(mapMin, mapMax, sigDist);\n\tfloat sigDistOutline = map(mapMin, mapMax, sigDist + outline_thickness);\n\tsigDistShdw = map(mapMin, mapMax, sigDistShdw + outline_thickness);\n\tfloat center = 0.5;\n\tfloat inside = smoothstep(center-smoothing, center+smoothing, sigDistInner);\n\tfloat outline = smoothstep(center-smoothing, center+smoothing, sigDistOutline);\n\tfloat shadow = smoothstep(center-smoothing, center+smoothing, sigDistShdw);\n\tvec4 tcolor = (outline > inside) ? outline * vec4(outline_color.a * outline_color.rgb, outline_color.a) : vec4(0.0);\n\ttcolor = mix(tcolor, color, inside);\n\tvec4 scolor = (shadow > outline) ? shadow * vec4(shadow_color.a * shadow_color.rgb, shadow_color.a) : tcolor;\n\ttcolor = mix(scolor, tcolor, outline);\n\treturn tcolor;\n}\n",normalVS:"#ifdef MORPHING_TEXTURE_BASED_NORMAL\nuniform highp sampler2D morphNormalTex;\n#endif\nvec3 getNormal() {\n\t#ifdef SKIN\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\t#elif defined(INSTANCING)\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\t#else\n\tdNormalMatrix = matrix_normal;\n\t#endif\n\tvec3 tempNormal = vertex_normal;\n\t#ifdef MORPHING\n\t#ifdef MORPHING_NRM03\n\ttempNormal += morph_weights_a[0] * morph_nrm0;\n\ttempNormal += morph_weights_a[1] * morph_nrm1;\n\ttempNormal += morph_weights_a[2] * morph_nrm2;\n\ttempNormal += morph_weights_a[3] * morph_nrm3;\n\t#endif\n\t#ifdef MORPHING_NRM47\n\ttempNormal += morph_weights_b[0] * morph_nrm4;\n\ttempNormal += morph_weights_b[1] * morph_nrm5;\n\ttempNormal += morph_weights_b[2] * morph_nrm6;\n\ttempNormal += morph_weights_b[3] * morph_nrm7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_NORMAL\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphNormal = texture2D(morphNormalTex, morphUV).xyz;\n\ttempNormal += morphNormal;\n\t#endif\n\treturn normalize(dNormalMatrix * tempNormal);\n}\n",normalDetailMapPS:"#ifdef MAPTEXTURE\nuniform sampler2D texture_normalDetailMap;\nuniform float material_normalDetailMapBumpiness;\nvec3 blendNormals(vec3 n1, vec3 n2) {\n\tn1 += vec3(0, 0, 1);\n\tn2 *= vec3(-1, -1, 1);\n\treturn normalize(n1*dot(n1, n2)/n1.z - n2);\n}\n#endif\nvec3 addNormalDetail(vec3 normalMap) {\n\t#ifdef MAPTEXTURE\n\tvec3 normalDetailMap = unpackNormal(texture2D(texture_normalDetailMap, $UV));\n\tnormalDetailMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalDetailMap, material_normalDetailMapBumpiness));\n\treturn blendNormals(normalMap, normalDetailMap);\n\t#else\n\treturn normalMap;\n\t#endif\n}\n",normalInstancedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(instance_line1.xyz, instance_line2.xyz, instance_line3.xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalMapPS:"uniform sampler2D texture_normalMap;\nuniform float material_bumpiness;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tnormalMap = normalize(mix(vec3(0.0, 0.0, 1.0), normalMap, material_bumpiness));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalMapFastPS:"uniform sampler2D texture_normalMap;\nvoid getNormal() {\n\tvec3 normalMap = unpackNormal(texture2D(texture_normalMap, $UV));\n\tdNormalMap = addNormalDetail(normalMap);\n\tdNormalW = dTBN * dNormalMap;\n}\n",normalSkinnedVS:"vec3 getNormal() {\n\tdNormalMatrix = mat3(dModelMatrix[0].xyz, dModelMatrix[1].xyz, dModelMatrix[2].xyz);\n\treturn normalize(dNormalMatrix * vertex_normal);\n}\n",normalVertexPS:"void getNormal() {\n\tdNormalW = normalize(dVertexNormalW);\n}\n",normalXYPS:"vec3 unpackNormal(vec4 nmap) {\n\tvec3 normal;\n\tnormal.xy = nmap.wy * 2.0 - 1.0;\n\tnormal.z = sqrt(1.0 - saturate(dot(normal.xy, normal.xy)));\n\treturn normal;\n}\n",normalXYZPS:"vec3 unpackNormal(vec4 nmap) {\n\treturn nmap.xyz * 2.0 - 1.0;\n}\n",opacityPS:"#ifdef MAPFLOAT\nuniform float material_opacity;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_opacityMap;\n#endif\nvoid getOpacity() {\n\tdAlpha = 1.0;\n\t#ifdef MAPFLOAT\n\tdAlpha *= material_opacity;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdAlpha *= texture2D(texture_opacityMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdAlpha *= clamp(vVertexColor.$VC, 0.0, 1.0);\n\t#endif\n}\n",outputAlphaPS:"gl_FragColor.a = dAlpha;\n",outputAlphaOpaquePS:"gl_FragColor.a = 1.0;\n",outputAlphaPremulPS:"gl_FragColor.rgb *= dAlpha;\ngl_FragColor.a = dAlpha;\n",outputCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 encodeRGBM(vec4 color) {\n\tcolor.rgb = pow(color.rgb, vec3(0.5));\n\tcolor.rgb *= 1.0 / 8.0;\n\tcolor.a = saturate( max( max( color.r, color.g ), max( color.b, 1.0 / 255.0 ) ) );\n\tcolor.a = ceil(color.a * 255.0) / 255.0;\n\tcolor.rgb /= color.a;\n\treturn color;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tgl_FragColor = textureCube(source, vec);\n\tif (params.w >= 2.0) gl_FragColor = encodeRGBM(gl_FragColor);\n}\n",outputTex2DPS:"varying vec2 vUv0;\nuniform sampler2D source;\nvoid main(void) {\n\tgl_FragColor = texture2D(source, vUv0);\n}\n",packDepthPS:"\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",packDepthMaskPS:"vec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres.x = 0.0;\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\n",parallaxPS:"uniform sampler2D texture_heightMap;\nuniform float material_heightMapFactor;\nvoid getParallax() {\n\tfloat parallaxScale = material_heightMapFactor;\n\tfloat height = texture2D(texture_heightMap, $UV).$CH;\n\theight = height * parallaxScale - parallaxScale*0.5;\n\tvec3 viewDirT = dViewDirW * dTBN;\n\tviewDirT.z += 0.42;\n\tdUvOffset = height * (viewDirT.xy / viewDirT.z);\n}\n",particlePS:"varying vec4 texCoordsAlphaLife;\nuniform sampler2D colorMap;\nuniform sampler2D colorParam;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nuniform float softening;\nuniform float colorMult;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\n#endif\nvoid main(void) {\n\tvec4 tex  = texture2DSRGB(colorMap, texCoordsAlphaLife.xy);\n\tvec4 ramp = texture2DSRGB(colorParam, vec2(texCoordsAlphaLife.w, 0.0));\n\tramp.rgb *= colorMult;\n\tramp.a += texCoordsAlphaLife.z;\n\tvec3 rgb = tex.rgb * ramp.rgb;\n\tfloat a  = tex.a * ramp.a;\n",particleVS:"vec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc) {\n\treturn mix( texture2D(tex,tc), texture2D(tex,tc + graphSampleSize), fract(tc.x*graphNumSamples) );\n}\nvec4 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex,tc);\n\tvec4 b = texture2D(tex,tc + graphSampleSize);\n\tfloat c = fract(tc.x*graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a, b, c);\n}\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix) {\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY) {\n\t#ifdef SCREEN_SPACE\n\t\tvec3 pos = vec3(-1, 0, 0) * quadXY.x + vec3(0, -1, 0) * quadXY.y;\n\t#else\n\t\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\t#endif\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY) {\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvec2 safeNormalize(vec2 v) {\n\tfloat l = length(v);\n\treturn (l > 1e-06) ? v / l : v;\n}\nvoid main(void) {\n\tvec3 meshLocalPos = particle_vertexData.xyz;\n\tfloat id = floor(particle_vertexData.w);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n\tfloat uv = id / numParticlesPot;\n\treadInput(uv);\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = safeNormalize((mat3(matrix_view) * inVel).xy);\n\tfloat particleLifetime = lifetime;\n\tif (inLife <= 0.0 || inLife > particleLifetime || !inShow) meshLocalPos = vec3(0.0);\n\tvec2 quadXY = meshLocalPos.xy;\n\tfloat nlife = clamp(inLife / particleLifetime, 0.0, 1.0);\n\tvec3 paramDiv;\n\tvec4 params = tex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat scale = params.y;\n\tfloat scaleDiv = paramDiv.x;\n\tfloat alphaDiv = paramDiv.z;\n\tscale += (scaleDiv * 2.0 - 1.0) * scaleDivMult * fract(rndFactor*10000.0);\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#else\n\ttexCoordsAlphaLife = vec4(particle_uv, (alphaDiv * 2.0 - 1.0) * alphaDivMult * fract(rndFactor*1000.0), nlife);\n#endif\n\tvec3 particlePos = inPos;\n\tvec3 particlePosMoved = vec3(0.0);\n\tmat2 rotMatrix;\n",particleAnimFrameClampVS:"\tfloat animFrame = min(floor(texCoordsAlphaLife.w * animTexParams.y) + animTexParams.x, animTexParams.z);\n",particleAnimFrameLoopVS:"\tfloat animFrame = floor(mod(texCoordsAlphaLife.w * animTexParams.y + animTexParams.x, animTexParams.z + 1.0));\n",particleAnimTexVS:"\tfloat animationIndex;\n\tif (animTexIndexParams.y == 1.0) {\n\t\tanimationIndex = floor((animTexParams.w + 1.0) * rndFactor3.z) * (animTexParams.z + 1.0);\n\t} else {\n\t\tanimationIndex = animTexIndexParams.x * (animTexParams.z + 1.0);\n\t}\n\tfloat atlasX = (animationIndex + animFrame) * animTexTilesParams.x;\n\tfloat atlasY = 1.0 - floor(atlasX + 1.0) * animTexTilesParams.y;\n\tatlasX = fract(atlasX);\n\ttexCoordsAlphaLife.xy *= animTexTilesParams.xy;\n\ttexCoordsAlphaLife.xy += vec2(atlasX, atlasY);\n",particleInputFloatPS:"void readInput(float uv) {\n\tvec4 tex = texture2D(particleTexIN, vec2(uv, 0.25));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.75));\n\tinPos = tex.xyz;\n\tinVel = tex2.xyz;\n\tinAngle = (tex.w < 0.0? -tex.w : tex.w) - 1000.0;\n\tinShow = tex.w >= 0.0;\n\tinLife = tex2.w;\n}\n",particleInputRgba8PS:"\n#define PI2 6.283185307179586\nuniform vec3 inBoundsSize;\nuniform vec3 inBoundsCenter;\nuniform float maxVel;\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat decodeFloatRGBA( vec4 rgba ) {\n  return dot( rgba, vec4(1.0, 1.0/255.0, 1.0/65025.0, 1.0/160581375.0) );\n}\nvoid readInput(float uv) {\n\tvec4 tex0 = texture2D(particleTexIN, vec2(uv, 0.125));\n\tvec4 tex1 = texture2D(particleTexIN, vec2(uv, 0.375));\n\tvec4 tex2 = texture2D(particleTexIN, vec2(uv, 0.625));\n\tvec4 tex3 = texture2D(particleTexIN, vec2(uv, 0.875));\n\tinPos = vec3(decodeFloatRG(tex0.rg), decodeFloatRG(tex0.ba), decodeFloatRG(tex1.rg));\n\tinPos = (inPos - vec3(0.5)) * inBoundsSize + inBoundsCenter;\n\tinVel = tex2.xyz;\n\tinVel = (inVel - vec3(0.5)) * maxVel;\n\tinAngle = decodeFloatRG(tex1.ba) * PI2;\n\tinShow = tex2.a > 0.5;\n\tinLife = decodeFloatRGBA(tex3);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\tinLife = inLife * (maxNegLife + maxPosLife) - maxNegLife;\n}\n",particleOutputFloatPS:"void writeOutput() {\n\tif (gl_FragCoord.y<1.0) {\n\t\tgl_FragColor = vec4(outPos, (outAngle + 1000.0) * visMode);\n\t} else {\n\t\tgl_FragColor = vec4(outVel, outLife);\n\t}\n}\n",particleOutputRgba8PS:"uniform vec3 outBoundsMul;\nuniform vec3 outBoundsAdd;\nvec2 encodeFloatRG( float v ) {\n\tvec2 enc = vec2(1.0, 255.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n\treturn enc;\n}\nvec4 encodeFloatRGBA( float v ) {\n\tvec4 enc = vec4(1.0, 255.0, 65025.0, 160581375.0) * v;\n\tenc = fract(enc);\n\tenc -= enc.yzww * vec4(1.0/255.0,1.0/255.0,1.0/255.0,0.0);\n\treturn enc;\n}\nvoid writeOutput() {\n\toutPos = outPos * outBoundsMul + outBoundsAdd;\n\toutAngle = fract(outAngle / PI2);\n\toutVel = (outVel / maxVel) + vec3(0.5);\n\tfloat maxNegLife = max(lifetime, (numParticles - 1.0) * (rate+rateDiv));\n\tfloat maxPosLife = lifetime+1.0;\n\toutLife = (outLife + maxNegLife) / (maxNegLife + maxPosLife);\n\tif (gl_FragCoord.y < 1.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.x), encodeFloatRG(outPos.y));\n\t} else if (gl_FragCoord.y < 2.0) {\n\t\tgl_FragColor = vec4(encodeFloatRG(outPos.z), encodeFloatRG(outAngle));\n\t} else if (gl_FragCoord.y < 3.0) {\n\t\tgl_FragColor = vec4(outVel, visMode*0.5+0.5);\n\t} else {\n\t\tgl_FragColor = encodeFloatRGBA(outLife);\n\t}\n}\n",particleUpdaterAABBPS:"uniform mat3 spawnBounds;\nuniform vec3 spawnPosInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tvec3 pos = inBounds - vec3(0.5);\n\tvec3 posAbs = abs(pos);\n\tvec3 maxPos = vec3(max(posAbs.x, max(posAbs.y, posAbs.z)));\n\tvec3 edge = maxPos + (vec3(0.5) - maxPos) * spawnPosInnerRatio;\n\tpos.x = edge.x * (maxPos.x == posAbs.x ? sign(pos.x) : 2.0 * pos.x);\n\tpos.y = edge.y * (maxPos.y == posAbs.y ? sign(pos.y) : 2.0 * pos.y);\n\tpos.z = edge.z * (maxPos.z == posAbs.z ? sign(pos.z) : 2.0 * pos.z);\n#ifndef LOCAL_SPACE\n\treturn emitterPos + spawnBounds * pos;\n#else\n\treturn spawnBounds * pos;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity -= vec3(0, 0, initialVelocity);\n}\n",particleUpdaterEndPS:"\twriteOutput();\n}\n",particleUpdaterInitPS:"varying vec2 vUv0;\nuniform highp sampler2D particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform highp sampler2D internalTex3;\nuniform mat3 emitterMatrix, emitterMatrixInv;\nuniform vec3 emitterScale;\nuniform vec3 emitterPos, frameRandom, localVelocityDivMult, velocityDivMult;\nuniform float delta, rate, rateDiv, lifetime, numParticles, rotSpeedDivMult, radialSpeedDivMult, seed;\nuniform float startAngle, startAngle2;\nuniform float initialVelocity;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\nfloat visMode;\nvec3 outPos;\nvec3 outVel;\nfloat outAngle;\nbool outShow;\nfloat outLife;\n",particleUpdaterNoRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = -1.0;\n\t}\n",particleUpdaterOnStopPS:"\tvisMode = outLife < 0.0? -1.0: visMode;\n",particleUpdaterRespawnPS:"\tif (outLife >= lifetime) {\n\t\toutLife -= max(lifetime, (numParticles - 1.0) * particleRate);\n\t\tvisMode = 1.0;\n\t}\n\tvisMode = outLife < 0.0? 1.0: visMode;\n",particleUpdaterSpherePS:"uniform float spawnBoundsSphere;\nuniform float spawnBoundsSphereInnerRatio;\nvec3 calcSpawnPosition(vec3 inBounds, float rndFactor) {\n\tfloat rnd4 = fract(rndFactor * 1000.0);\n\tvec3 norm = normalize(inBounds.xyz - vec3(0.5));\n\tfloat r = rnd4 * (1.0 - spawnBoundsSphereInnerRatio) + spawnBoundsSphereInnerRatio;\n#ifndef LOCAL_SPACE\n\treturn emitterPos + norm * r * spawnBoundsSphere;\n#else\n\treturn norm * r * spawnBoundsSphere;\n#endif\n}\nvoid addInitialVelocity(inout vec3 localVelocity, vec3 inBounds) {\n\tlocalVelocity += normalize(inBounds - vec3(0.5)) * initialVelocity;\n}\n",particleUpdaterStartPS:"float saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 unpack3NFloats(float src) {\n\tfloat r = fract(src);\n\tfloat g = fract(src * 256.0);\n\tfloat b = fract(src * 65536.0);\n\treturn vec3(r, g, b);\n}\nvec3 tex1Dlod_lerp(highp sampler2D tex, vec2 tc, out vec3 w) {\n\tvec4 a = texture2D(tex, tc);\n\tvec4 b = texture2D(tex, tc + graphSampleSize);\n\tfloat c = fract(tc.x * graphNumSamples);\n\tvec3 unpackedA = unpack3NFloats(a.w);\n\tvec3 unpackedB = unpack3NFloats(b.w);\n\tw = mix(unpackedA, unpackedB, c);\n\treturn mix(a.xyz, b.xyz, c);\n}\n#define HASHSCALE4 vec4(1031, .1030, .0973, .1099)\nvec4 hash41(float p) {\n\tvec4 p4 = fract(vec4(p) * HASHSCALE4);\n\tp4 += dot(p4, p4.wzxy+19.19);\n\treturn fract(vec4((p4.x + p4.y)*p4.z, (p4.x + p4.z)*p4.y, (p4.y + p4.z)*p4.w, (p4.z + p4.w)*p4.x));\n}\nvoid main(void) {\n\tif (gl_FragCoord.x > numParticles) discard;\n\treadInput(vUv0.x);\n\tvisMode = inShow? 1.0 : -1.0;\n\tvec4 rndFactor = hash41(gl_FragCoord.x + seed);\n\tfloat particleRate = rate + rateDiv * rndFactor.x;\n\toutLife = inLife + delta;\n\tfloat nlife = clamp(outLife / lifetime, 0.0, 1.0);\n\tvec3 localVelocityDiv;\n\tvec3 velocityDiv;\n\tvec3 paramDiv;\n\tvec3 localVelocity = tex1Dlod_lerp(internalTex0, vec2(nlife, 0), localVelocityDiv);\n\tvec3 velocity =\t  tex1Dlod_lerp(internalTex1, vec2(nlife, 0), velocityDiv);\n\tvec3 params =\t\ttex1Dlod_lerp(internalTex2, vec2(nlife, 0), paramDiv);\n\tfloat rotSpeed = params.x;\n\tfloat rotSpeedDiv = paramDiv.y;\n\tvec3 radialParams = tex1Dlod_lerp(internalTex3, vec2(nlife, 0), paramDiv);\n\tfloat radialSpeed = radialParams.x;\n\tfloat radialSpeedDiv = radialParams.y;\n\tbool respawn = inLife <= 0.0 || outLife >= lifetime;\n\tinPos = respawn ? calcSpawnPosition(rndFactor.xyz, rndFactor.x) : inPos;\n\tinAngle = respawn ? mix(startAngle, startAngle2, rndFactor.x) : inAngle;\n#ifndef LOCAL_SPACE\n\tvec3 radialVel = inPos - emitterPos;\n#else\n\tvec3 radialVel = inPos;\n#endif\n\tradialVel = (dot(radialVel, radialVel) > 1.0E-8) ? radialSpeed * normalize(radialVel) : vec3(0.0);\n\tradialVel += (radialSpeedDiv * vec3(2.0) - vec3(1.0)) * radialSpeedDivMult * rndFactor.xyz;\n\tlocalVelocity +=\t(localVelocityDiv * vec3(2.0) - vec3(1.0)) * localVelocityDivMult * rndFactor.xyz;\n\tvelocity +=\t\t (velocityDiv * vec3(2.0) - vec3(1.0)) * velocityDivMult * rndFactor.xyz;\n\trotSpeed +=\t\t (rotSpeedDiv * 2.0 - 1.0) * rotSpeedDivMult * rndFactor.y;\n\taddInitialVelocity(localVelocity, rndFactor.xyz);\n#ifndef LOCAL_SPACE\n\toutVel = emitterMatrix * localVelocity + (radialVel + velocity) * emitterScale;\n#else\n\toutVel = (localVelocity + radialVel) / emitterScale + emitterMatrixInv * velocity;\n#endif\n\toutPos = inPos + outVel * delta;\n\toutAngle = inAngle + rotSpeed * delta;\n",particle_billboardVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = billboard(particlePos, quadXY);\n",particle_blendAddPS:"\tdBlendModeFogFactor = 0.0;\n\trgb *= saturate(gammaCorrectInput(max(a, 0.0)));\n\tif ((rgb.r + rgb.g + rgb.b) < 0.000001) discard;\n",particle_blendMultiplyPS:"\trgb = mix(vec3(1.0), rgb, vec3(a));\n\tif (rgb.r + rgb.g + rgb.b > 2.99) discard;\n",particle_blendNormalPS:"\tif (a < 0.01) discard;\n",particle_cpuVS:"attribute vec4 particle_vertexData;\nattribute vec4 particle_vertexData2;\nattribute vec4 particle_vertexData3;\nattribute float particle_vertexData4;\n#ifndef USE_MESH\n#define VDATA5TYPE vec2\n#else\n#define VDATA5TYPE vec4\n#endif\nattribute VDATA5TYPE particle_vertexData5;\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\nuniform float numParticles;\nuniform float lifetime;\nuniform float stretch;\nuniform float seed;\nuniform vec3 wrapBounds, emitterScale, faceTangent, faceBinorm;\nuniform sampler2D texLifeAndSourcePosOUT;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\nuniform vec3 emitterPos;\nvarying vec4 texCoordsAlphaLife;\nvec2 rotate(vec2 quadXY, float pRotation, out mat2 rotMatrix)\n{\n\tfloat c = cos(pRotation);\n\tfloat s = sin(pRotation);\n\tmat2 m = mat2(c, -s, s, c);\n\trotMatrix = m;\n\treturn m * quadXY;\n}\nvec3 billboard(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = -matrix_viewInverse[0].xyz * quadXY.x + -matrix_viewInverse[1].xyz * quadXY.y;\n\treturn pos;\n}\nvec3 customFace(vec3 InstanceCoords, vec2 quadXY)\n{\n\tvec3 pos = faceTangent * quadXY.x + faceBinorm * quadXY.y;\n\treturn pos;\n}\nvoid main(void)\n{\n\tvec3 particlePos = particle_vertexData.xyz;\n\tvec3 inPos = particlePos;\n\tvec3 vertPos = particle_vertexData3.xyz;\n\tvec3 inVel = vec3(particle_vertexData2.w, particle_vertexData3.w, particle_vertexData5.x);\n\tfloat id = floor(particle_vertexData4);\n\tfloat rndFactor = fract(sin(id + 1.0 + seed));\n\tvec3 rndFactor3 = vec3(rndFactor, fract(rndFactor*10.0), fract(rndFactor*100.0));\n#ifdef LOCAL_SPACE\n\tinVel = mat3(matrix_model) * inVel;\n#endif\n\tvec2 velocityV = normalize((mat3(matrix_view) * inVel).xy);\n\tvec2 quadXY = vertPos.xy;\n#ifndef USE_MESH\n\ttexCoordsAlphaLife = vec4(quadXY * -0.5 + 0.5, particle_vertexData2.z, particle_vertexData.w);\n#else\n\ttexCoordsAlphaLife = vec4(particle_vertexData5.zw, particle_vertexData2.z, particle_vertexData.w);\n#endif\n\tmat2 rotMatrix;\n\tfloat inAngle = particle_vertexData2.x;\n\tvec3 particlePosMoved = vec3(0.0);\n\tvec3 meshLocalPos = particle_vertexData3.xyz;\n",particle_cpu_endVS:"\tlocalPos *= particle_vertexData2.y * emitterScale;\n\tlocalPos += particlePos;\n\tgl_Position = matrix_viewProjection * vec4(localPos, 1.0);\n",particle_customFaceVS:"\tquadXY = rotate(quadXY, inAngle, rotMatrix);\n\tvec3 localPos = customFace(particlePos, quadXY);\n",particle_endPS:"\trgb = addFog(rgb);\n\trgb = toneMap(rgb);\n\trgb = gammaCorrectOutput(rgb);\n\tgl_FragColor = vec4(rgb, a);\n}\n",particle_endVS:"\tlocalPos *= scale * emitterScale;\n\tlocalPos += particlePos;\n\t#ifdef SCREEN_SPACE\n\tgl_Position = vec4(localPos.x, localPos.y, 0.0, 1.0);\n\t#else\n\tgl_Position = matrix_viewProjection * vec4(localPos.xyz, 1.0);\n\t#endif\n",particle_halflambertPS:"\tvec3 negNormal = normal*0.5+0.5;\n\tvec3 posNormal = -normal*0.5+0.5;\n\tnegNormal *= negNormal;\n\tposNormal *= posNormal;\n",particle_initVS:"attribute vec4 particle_vertexData;\n#ifdef USE_MESH\nattribute vec2 particle_uv;\n#endif\nuniform mat4 matrix_viewProjection;\nuniform mat4 matrix_model;\nuniform mat3 matrix_normal;\nuniform mat4 matrix_viewInverse;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform float numParticles, numParticlesPot;\nuniform float graphSampleSize;\nuniform float graphNumSamples;\nuniform float stretch;\nuniform vec3 wrapBounds;\nuniform vec3 emitterScale, emitterPos, faceTangent, faceBinorm;\nuniform float rate, rateDiv, lifetime, deltaRandomnessStatic, scaleDivMult, alphaDivMult, seed, delta;\nuniform sampler2D particleTexOUT, particleTexIN;\nuniform highp sampler2D internalTex0;\nuniform highp sampler2D internalTex1;\nuniform highp sampler2D internalTex2;\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\nvarying vec4 texCoordsAlphaLife;\nvec3 inPos;\nvec3 inVel;\nfloat inAngle;\nbool inShow;\nfloat inLife;\n",particle_lambertPS:"\tvec3 negNormal = max(normal, vec3(0.0));\n\tvec3 posNormal = max(-normal, vec3(0.0));\n",particle_lightingPS:"\tvec3 light = negNormal.x*lightCube[0] + posNormal.x*lightCube[1] +\n\t\t\t\t\t\tnegNormal.y*lightCube[2] + posNormal.y*lightCube[3] +\n\t\t\t\t\t\tnegNormal.z*lightCube[4] + posNormal.z*lightCube[5];\n\trgb *= light;\n",particle_localShiftVS:"\tparticlePos = (matrix_model * vec4(particlePos, 1.0)).xyz;\n",particle_meshVS:"\tvec3 localPos = meshLocalPos;\n\tlocalPos.xy = rotate(localPos.xy, inAngle, rotMatrix);\n\tlocalPos.yz = rotate(localPos.yz, inAngle, rotMatrix);\n\tbillboard(particlePos, quadXY);\n",particle_normalVS:"\tNormal = normalize(localPos + matrix_viewInverse[2].xyz);\n",particle_normalMapPS:"\tvec3 normalMap = normalize(texture2D(normalMap, texCoordsAlphaLife.xy).xyz * 2.0 - 1.0);\n\tvec3 normal = ParticleMat * normalMap;\n",particle_pointAlongVS:"\tinAngle = atan(velocityV.x, velocityV.y);\n",particle_softPS:"\tfloat depth = getLinearScreenDepth();\n\tfloat particleDepth = vDepth;\n\tfloat depthDiff = saturate(abs(particleDepth - depth) * softening);\n\ta *= depthDiff;\n",particle_softVS:"\tvDepth = getLinearDepth(localPos);\n",particle_stretchVS:"\tvec3 moveDir = inVel * stretch;\n\tvec3 posPrev = particlePos - moveDir;\n\tposPrev += particlePosMoved;\n\tvec2 centerToVertexV = normalize((mat3(matrix_view) * localPos).xy);\n\tfloat interpolation = dot(-velocityV, centerToVertexV) * 0.5 + 0.5;\n\tparticlePos = mix(particlePos, posPrev, interpolation);\n",particle_TBNVS:"\tmat3 rot3 = mat3(rotMatrix[0][0], rotMatrix[0][1], 0.0, rotMatrix[1][0], rotMatrix[1][1], 0.0, 0.0, 0.0, 1.0);\n\tParticleMat = mat3(-matrix_viewInverse[0].xyz, -matrix_viewInverse[1].xyz, matrix_viewInverse[2].xyz) * rot3;\n",particle_wrapVS:"\tvec3 origParticlePos = particlePos;\n\tparticlePos -= matrix_model[3].xyz;\n\tparticlePos = mod(particlePos, wrapBounds) - wrapBounds * 0.5;\n\tparticlePos += matrix_model[3].xyz;\n\tparticlePosMoved = particlePos - origParticlePos;\n",precisionTestPS:"void main(void) {\n\tgl_FragColor = vec4(2147483648.0);\n}\n",precisionTest2PS:"uniform sampler2D source;\nvec4 packFloat(float depth) {\n\tconst vec4 bit_shift = vec4(256.0 * 256.0 * 256.0, 256.0 * 256.0, 256.0, 1.0);\n\tconst vec4 bit_mask  = vec4(0.0, 1.0 / 256.0, 1.0 / 256.0, 1.0 / 256.0);\n\tvec4 res = mod(depth * bit_shift * vec4(255), vec4(256) ) / vec4(255);\n\tres -= res.xxyz * bit_mask;\n\treturn res;\n}\nvoid main(void) {\n\tfloat c = texture2D(source, vec2(0.0)).r;\n\tfloat diff = abs(c - 2147483648.0) / 2147483648.0;\n\tgl_FragColor = packFloat(diff);\n}\n",prefilterCubemapPS:"varying vec2 vUv0;\nuniform samplerCube source;\nuniform vec4 params;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nfloat rnd(vec2 uv) {\n\treturn fract(sin(dot(uv, vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nconst float PI = 3.14159265358979;\nvec3 hemisphereSample_cos(vec2 uv, mat3 vecSpace, vec3 cubeDir, float gloss) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = sqrt(1.0 - uv.x);\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn normalize(mix(vecSpace * sampleDir, cubeDir, params.y));\n}\nvec3 hemisphereSample_phong(vec2 uv, mat3 vecSpace, vec3 cubeDir, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\tvec3 sampleDir = vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n\treturn vecSpace * sampleDir;\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nvec4 encodeRGBM(vec3 color) {\n\tvec4 encoded;\n\tencoded.rgb = pow(color.rgb, vec3(0.5));\n\tencoded.rgb *= 1.0 / 8.0;\n\tencoded.a = saturate( max( max( encoded.r, encoded.g ), max( encoded.b, 1.0 / 255.0 ) ) );\n\tencoded.a = ceil(encoded.a * 255.0) / 255.0;\n\tencoded.rgb /= encoded.a;\n\treturn encoded;\n}\nvoid main(void) {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tif (params.w==1.0 || params.w==3.0) {\n\t\tst = 2.0 * floor(gl_FragCoord.xy) / (params.z - 1.0) - 1.0;\n\t}\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\tmat3 vecSpace = matrixFromVector(normalize(vec));\n\tvec3 color = vec3(0.0);\n\tconst int samples = $NUMSAMPLES;\n\tvec3 vect;\n\tfor(int i=0; i<samples; i++) {\n\t\tfloat sini = sin(float(i));\n\t\tfloat cosi = cos(float(i));\n\t\tfloat rand = rnd(vec2(sini, cosi));\n\t\tvect = hemisphereSample_$METHOD(vec2(float(i) / float(samples), rand), vecSpace, vec, params.y);\n\t\tcolor += $textureCube(source, vect).rgb;\n\t}\n\tcolor /= float(samples);\n\tgl_FragColor = params.w < 2.0? vec4(color, 1.0) : encodeRGBM(color);\n}\n",reflDirPS:"void getReflDir() {\n\tdReflDirW = normalize(-reflect(dViewDirW, dNormalW));\n}\n",reflDirAnisoPS:"void getReflDir() {\n\tfloat roughness = sqrt(1.0 - min(dGlossiness, 1.0));\n\tfloat anisotropy = material_anisotropy * roughness;\n\tvec3 anisotropicDirection = anisotropy >= 0.0 ? dTBN[1] : dTBN[0];\n\tvec3 anisotropicTangent = cross(anisotropicDirection, dViewDirW);\n\tvec3 anisotropicNormal = cross(anisotropicTangent, anisotropicDirection);\n\tvec3 bentNormal = normalize(mix(normalize(dNormalW), normalize(anisotropicNormal), anisotropy));\n\tdReflDirW = reflect(-dViewDirW, bentNormal);\n}\n",reflectionCCPS:"#ifdef CLEARCOAT\nuniform float material_clearCoatReflectivity;\nvoid addReflectionCC() {\n\tccReflection += vec4(calcReflection(ccReflDirW, ccGlossiness), material_clearCoatReflectivity);\n}\n#endif\n",reflectionCubePS:"uniform samplerCube texture_cubeMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 lookupVec = fixSeams(cubeMapProject(tReflDirW));\n\tlookupVec.x *= -1.0;\n\treturn $textureCubeSAMPLE(texture_cubeMap, lookupVec).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionDpAtlasPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec2 getDpAtlasUv(vec2 uv, float mip) {\n\tvec4 rect;\n\tfloat sx = saturate(mip - 2.0);\n\trect.x = sx * 0.5;\n\tfloat t = mip - rect.x * 6.0;\n\tfloat i = 1.0 - rect.x;\n\trect.y = min(t * 0.5, 0.75) * i + rect.x;\n\tfloat st = saturate(t);\n\trect.z = (1.0 - st * 0.5) * i;\n\trect.w = rect.z * 0.5;\n\tfloat rcRectZ = 1.0 / rect.z;\n\tfloat scaleFactor = 0.00390625 * rcRectZ;\n\tvec2 scale = vec2(scaleFactor, scaleFactor * 2.0);\n\tuv = uv * (vec2(1.0) - scale) + scale * 0.5;\n\tuv = uv * rect.zw + rect.xy;\n\treturn uv;\n}\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDir = normalize(cubeMapProject(tReflDirW));\n\tbool up = reflDir.y > 0.0;\n\tfloat scale = 0.90909090909090909090909090909091;\n\tvec3 reflDirWarp = reflDir.xzx * vec3(-0.25, 0.5, 0.25);\n\tfloat reflDirVer = abs(reflDir.y) + 1.0;\n\treflDirWarp /= reflDirVer;\n\treflDirWarp *= scale;\n\treflDirWarp = vec3(0.75, 0.5, 0.25) - reflDirWarp;\n\tvec2 tc = up? reflDirWarp.xy : reflDirWarp.zy;\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tfloat mip = floor(bias);\n\tvec3 tex1 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\tmip = min(mip + 1.0, 5.0);\n\tvec3 tex2 = $texture2DSAMPLE(texture_sphereMap, getDpAtlasUv(tc, mip)).rgb;\n\ttex1 = mix(tex1, tex2, fract(bias));\n\ttex1 = processEnvironment(tex1);\n\treturn tex1;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubePS:"uniform samplerCube texture_prefilteredCubeMap128;\nuniform samplerCube texture_prefilteredCubeMap64;\nuniform samplerCube texture_prefilteredCubeMap32;\nuniform samplerCube texture_prefilteredCubeMap16;\nuniform samplerCube texture_prefilteredCubeMap8;\n#ifndef PMREM4\n#define PMREM4\nuniform samplerCube texture_prefilteredCubeMap4;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tint index1 = int(bias);\n\tint index2 = int(min(bias + 1.0, 7.0));\n\tvec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n\tfixedReflDir.x *= -1.0;\n\tvec4 cubes[6];\n\tcubes[0] = textureCube(texture_prefilteredCubeMap128, fixedReflDir);\n\tcubes[1] = textureCube(texture_prefilteredCubeMap64, fixedReflDir);\n\tcubes[2] = textureCube(texture_prefilteredCubeMap32, fixedReflDir);\n\tcubes[3] = textureCube(texture_prefilteredCubeMap16, fixedReflDir);\n\tcubes[4] = textureCube(texture_prefilteredCubeMap8, fixedReflDir);\n\tcubes[5] = textureCube(texture_prefilteredCubeMap4, fixedReflDir);\n\tvec4 cube[2];\n\tfor(int i = 0; i < 6; i++) {\n\t\tif (i == index1) {\n\t\t\tcube[0] = cubes[i];\n\t\t}\n\t\tif (i == index2) {\n\t\t\tcube[1] = cubes[i];\n\t\t}\n\t}\n\tvec4 cubeFinal = mix(cube[0], cube[1], fract(bias));\n\tvec3 refl = processEnvironment($DECODE(cubeFinal).rgb);\n\treturn refl;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionPrefilteredCubeLodPS:"#ifndef PMREM4\n#define PMREM4\n#extension GL_EXT_shader_texture_lod : enable\nuniform samplerCube texture_prefilteredCubeMap128;\n#endif\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tfloat bias = saturate(1.0 - tGlossiness) * 5.0;\n\tvec3 fixedReflDir = fixSeams(cubeMapProject(tReflDirW), bias);\n\tfixedReflDir.x *= -1.0;\n\tvec3 refl = processEnvironment($DECODE( textureCubeLodEXT(texture_prefilteredCubeMap128, fixedReflDir, bias) ).rgb);\n\treturn refl;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSpherePS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = (mat3(matrix_view) * tReflDirW).xyz;\n\tfloat m = 2.0 * sqrt( dot(reflDirV.xy, reflDirV.xy) + (reflDirV.z+1.0)*(reflDirV.z+1.0) );\n\tvec2 sphereMapUv = reflDirV.xy / m + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",reflectionSphereLowPS:"uniform sampler2D texture_sphereMap;\nuniform float material_reflectivity;\nvec3 calcReflection(vec3 tReflDirW, float tGlossiness) {\n\tvec3 reflDirV = vNormalV;\n\tvec2 sphereMapUv = reflDirV.xy * 0.5 + 0.5;\n\treturn $texture2DSAMPLE(texture_sphereMap, sphereMapUv).rgb;\n}\nvoid addReflection() {\n\tdReflection += vec4(calcReflection(dReflDirW, dGlossiness), material_reflectivity);\n}\n",refractionPS:"uniform float material_refraction, material_refractionIndex;\nvec3 refract2(vec3 viewVec, vec3 Normal, float IOR) {\n\tfloat vn = dot(viewVec, Normal);\n\tfloat k = 1.0 - IOR * IOR * (1.0 - vn * vn);\n\tvec3 refrVec = IOR * viewVec - (IOR * vn + sqrt(k)) * Normal;\n\treturn refrVec;\n}\nvoid addRefraction() {\n\tvec3 tmp = dReflDirW;\n\tvec4 tmp2 = dReflection;\n\tdReflection = vec4(0.0);\n\tdReflDirW = refract2(-dViewDirW, dNormalW, material_refractionIndex);\n\taddReflection();\n\tdDiffuseLight = mix(dDiffuseLight, dReflection.rgb * dAlbedo, material_refraction);\n\tdReflDirW = tmp;\n\tdReflection = tmp2;\n}\n",reprojectPS:"\nvarying vec2 vUv0;\nuniform sampler2D sourceTex;\nuniform samplerCube sourceCube;\nuniform vec4 params;\nfloat PI = 3.141592653589793;\nfloat saturate(float x) {\n\treturn clamp(x, 0.0, 1.0);\n}\nvec3 decodeLinear(vec4 source) {\n\treturn source.rgb;\n}\nvec4 encodeLinear(vec3 source) {\n\treturn vec4(source, 1.0);\n}\nvec3 decodeGamma(vec4 source) {\n\treturn pow(source.xyz, vec3(2.2));\n}\nvec4 encodeGamma(vec3 source) {\n\treturn vec4(pow(source + 0.0000001, vec3(1.0 / 2.2)), 1.0);\n}\nvec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec4 encodeRGBM(vec3 source) {\n\tvec4 result;\n\tresult.rgb = pow(source.rgb, vec3(0.5));\n\tresult.rgb *= 1.0 / 8.0;\n\tresult.a = saturate( max( max( result.r, result.g ), max( result.b, 1.0 / 255.0 ) ) );\n\tresult.a = ceil(result.a * 255.0) / 255.0;\n\tresult.rgb /= result.a;\n\treturn result;\n}\nvec3 decodeRGBE(vec4 source) {\n\tif (source.a == 0.0) {\n\t\treturn vec3(0.0, 0.0, 0.0);\n\t} else {\n\t\treturn source.xyz * pow(2.0, source.w * 255.0 - 128.0);\n\t}\n}\nvec4 encodeRGBE(vec3 source) {\n\tfloat maxVal = max(source.x, max(source.y, source.z));\n\tif (maxVal < 1e-32) {\n\t\treturn vec4(0, 0, 0, 0);\n\t} else {\n\t\tfloat e = ceil(log2(maxVal));\n\t\treturn vec4(source / pow(2.0, e), (e + 128.0) / 255.0);\n\t}\n}\nvec2 toSpherical(vec3 dir) {\n\treturn vec2(atan(dir.z, dir.x) * -1.0, asin(dir.y));\n}\nvec3 fromSpherical(vec2 uv) {\n\treturn vec3(cos(uv.y) * cos(-uv.x),\n\t\t\t\tsin(uv.y),\n\t\t\t\tcos(uv.y) * sin(-uv.x));\n}\nvec4 sampleEquirect(vec2 sph) {\n\treturn texture2D(sourceTex, sph / vec2(PI * 2.0, PI) + 0.5);\n}\nvec4 sampleEquirect(vec3 dir) {\n\treturn sampleEquirect(toSpherical(dir));\n}\nvec4 sampleCubemap(vec3 dir) {\n\treturn textureCube(sourceCube, dir);\n}\nvec4 sampleCubemap(vec2 sph) {\n\treturn sampleCubemap(fromSpherical(sph));\n}\nvec3 getDirectionEquirect() {\n\treturn fromSpherical((vUv0 * 2.0 - 1.0) * vec2(PI, PI * 0.5));\n}\nvec3 getDirectionCubemap() {\n\tvec2 st = vUv0 * 2.0 - 1.0;\n\tfloat face = params.x;\n\tvec3 vec;\n\tif (face==0.0) {\n\t\tvec = vec3(1, -st.y, -st.x);\n\t} else if (face==1.0) {\n\t\tvec = vec3(-1, -st.y, st.x);\n\t} else if (face==2.0) {\n\t\tvec = vec3(st.x, 1, st.y);\n\t} else if (face==3.0) {\n\t\tvec = vec3(st.x, -1, -st.y);\n\t} else if (face==4.0) {\n\t\tvec = vec3(st.x, -st.y, 1);\n\t} else {\n\t\tvec = vec3(-st.x, -st.y, -1);\n\t}\n\treturn normalize(vec);\n}\nmat3 matrixFromVector(vec3 n) {\n\tfloat a = 1.0 / (1.0 + n.z);\n\tfloat b = -n.x * n.y * a;\n\tvec3 b1 = vec3(1.0 - n.x * n.x * a, b, -n.x);\n\tvec3 b2 = vec3(b, 1.0 - n.y * n.y * a, -n.y);\n\treturn mat3(b1, b2, n);\n}\nfloat rnd(int i) {\n\tfloat sini = sin(float(i));\n\tfloat cosi = cos(float(i));\n\treturn fract(sin(dot(vec2(sini, cosi), vec2(12.9898, 78.233) * 2.0)) * 43758.5453);\n}\nvec3 hemisphereSamplePhong(vec2 uv, float specPow) {\n\tfloat phi = uv.y * 2.0 * PI;\n\tfloat cosTheta = pow(1.0 - uv.x, 1.0 / (specPow + 1.0));\n\tfloat sinTheta = sqrt(1.0 - cosTheta * cosTheta);\n\treturn vec3(cos(phi) * sinTheta, sin(phi) * sinTheta, cosTheta);\n}\nvec4 reproject() {\n\tif (NUM_SAMPLES <= 1) {\n\t\treturn ENCODE_FUNC(DECODE_FUNC(SOURCE_FUNC(TARGET_FUNC())));\n\t} else {\n\t\tvec2 sph = toSpherical(TARGET_FUNC());\n\t\tvec2 sphu = dFdx(sph);\n\t\tvec2 sphv = dFdy(sph);\n\t\tconst float num = sqrt(float(NUM_SAMPLES));\n\t\tvec3 result = vec3(0.0);\n\t\tfor (float u=0.0; u<num; ++u) {\n\t\t\tfor (float v=0.0; v<num; ++v) {\n\t\t\t\tresult += DECODE_FUNC(SOURCE_FUNC(sph +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphu * (u / num - 0.5) +\n\t\t\t\t\t\t\t\t\t\t\t\t  sphv * (v / num - 0.5)));\n\t\t\t}\n\t\t}\n\t\treturn ENCODE_FUNC(result / (num * num));\n\t}\n}\nvec4 prefilter() {\n\tvec3 vec = TARGET_FUNC();\n\tmat3 vecSpace = matrixFromVector(vec);\n\tvec3 result = vec3(0.0);\n\tfor (int i=0; i<NUM_SAMPLES; ++i) {\n\t\tvec2 uv = vec2(float(i) / float(NUM_SAMPLES), rnd(i));\n\t\tvec3 dir = vecSpace * hemisphereSamplePhong(uv, params.y);\n\t\tresult += DECODE_FUNC(SOURCE_FUNC(dir));\n\t}\n\treturn ENCODE_FUNC(result / float(NUM_SAMPLES));\n}\nvoid main(void) {\n\tgl_FragColor = (params.z == 0.0) ? reproject() : prefilter();\n}\n",rgbmPS:"vec3 decodeRGBM(vec4 rgbm) {\n\tvec3 color = (8.0 * rgbm.a) * rgbm.rgb;\n\treturn color * color;\n}\nvec3 texture2DRGBM(sampler2D tex, vec2 uv) {\n\treturn decodeRGBM(texture2D(tex, uv));\n}\nvec3 textureCubeRGBM(samplerCube tex, vec3 uvw) {\n\treturn decodeRGBM(textureCube(tex, uvw));\n}\n",screenDepthPS:"uniform sampler2D uDepthMap;\n#ifndef SCREENSIZE\n#define SCREENSIZE\nuniform vec4 uScreenSize;\n#endif\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n#endif\n#ifdef GL2\nfloat linearizeDepth(float z) {\n\tz = z * 2.0 - 1.0;\n\treturn 1.0 / (camera_params.z * z + camera_params.w);\n}\n#else\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#endif\nfloat getLinearScreenDepth(vec2 uv) {\n\t#ifdef GL2\n\treturn linearizeDepth(texture2D(uDepthMap, uv).r) * camera_params.y;\n\t#else\n\treturn unpackFloat(texture2D(uDepthMap, uv)) * camera_params.y;\n\t#endif\n}\n#ifndef VERTEXSHADER\nfloat getLinearScreenDepth() {\n\tvec2 uv = gl_FragCoord.xy * uScreenSize.zw;\n\treturn getLinearScreenDepth(uv);\n}\n#endif\nfloat getLinearDepth(vec3 pos) {\n\treturn -(matrix_view * vec4(pos, 1.0)).z;\n}\n",shadowCommonPS:"void normalOffsetPointShadow(vec4 shadowParams) {\n\tfloat distScale = length(dLightDirW);\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\tvec3 dir = wPos - dLightPosW;\n\tdLightDirW = dir;\n}\n",shadowCoordPS:"void _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tdShadowCoord = (shadowMatrix * vec4(wPos, 1.0)).xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xy /= projPos.w;\n\tdShadowCoord.xy = projPos.xy;\n\tdShadowCoord.z = length(dLightDirW) * shadowParams.w;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordVS:"void getLightDirPoint(vec3 lightPosW) {\n\tvec3 lightDirW = vPositionW - lightPosW;\n\tdLightDirNormW = normalize(lightDirW);\n\tdLightPosW = lightPosW;\n}\nvoid _getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid _getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tvMainShadowUv = projPos;\n}\nvoid getShadowCoordOrtho(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPersp(mat4 shadowMatrix, vec3 shadowParams) {\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, vPositionW);\n}\nvoid getShadowCoordPerspNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPersp(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordOrthoNormalOffset(mat4 shadowMatrix, vec3 shadowParams) {\n\tvec3 wPos = vPositionW + dNormalW * shadowParams.y * clamp(1.0 - dot(dNormalW, -dLightDirNormW), 0.0, 1.0);\n\t_getShadowCoordOrtho(shadowMatrix, shadowParams, wPos);\n}\n",shadowCoordPerspZbufferPS:"void _getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams, vec3 wPos) {\n\tvec4 projPos = shadowMatrix * vec4(wPos, 1.0);\n\tprojPos.xyz /= projPos.w;\n\tdShadowCoord = projPos.xyz;\n}\nvoid getShadowCoordPerspZbufferNormalOffset(mat4 shadowMatrix, vec4 shadowParams) {\n\tfloat distScale = abs(dot(vPositionW - dLightPosW, dLightDirNormW));\n\tvec3 wPos = vPositionW + dVertexNormalW * shadowParams.y * clamp(1.0 - dot(dVertexNormalW, -dLightDirNormW), 0.0, 1.0) * distScale;\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, wPos);\n}\nvoid getShadowCoordPerspZbuffer(mat4 shadowMatrix, vec4 shadowParams) {\n\t_getShadowCoordPerspZbuffer(shadowMatrix, shadowParams, vPositionW);\n}\n",shadowEVSMPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec3 moments = texture2D(tex, texCoords).xyz;\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowEVSMnPS:"float VSM$(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tfloat pixelSize = 1.0 / resolution;\n\ttexCoords -= vec2(pixelSize);\n\tvec3 s00 = texture2D(tex, texCoords).xyz;\n\tvec3 s10 = texture2D(tex, texCoords + vec2(pixelSize, 0)).xyz;\n\tvec3 s01 = texture2D(tex, texCoords + vec2(0, pixelSize)).xyz;\n\tvec3 s11 = texture2D(tex, texCoords + vec2(pixelSize)).xyz;\n\tvec2 fr = fract(texCoords * resolution);\n\tvec3 h0 = mix(s00, s10, fr.x);\n\tvec3 h1 = mix(s01, s11, fr.x);\n\tvec3 moments = mix(h0, h1, fr.y);\n\treturn calculateEVSM(moments, Z, vsmBias, exponent);\n}\nfloat getShadowVSM$(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\nfloat getShadowSpotVSM$(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM$(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, exponent);\n}\n",shadowStandardPS:"vec3 lessThan2(vec3 a, vec3 b) {\n\treturn clamp((b - a)*1000.0, 0.0, 1.0);\n}\n#ifndef UNPACKFLOAT\n#define UNPACKFLOAT\nfloat unpackFloat(vec4 rgbaDepth) {\n\tconst vec4 bitShift = vec4(1.0 / (256.0 * 256.0 * 256.0), 1.0 / (256.0 * 256.0), 1.0 / 256.0, 1.0);\n\treturn dot(rgbaDepth, bitShift);\n}\n#endif\n#ifdef GL2\nfloat _getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat sum = 0.0;\n\tfloat uw0 = (3.0 - 2.0 * s);\n\tfloat uw1 = (1.0 + 2.0 * s);\n\tfloat u0 = (2.0 - s) / uw0 - 1.0;\n\tfloat u1 = s / uw1 + 1.0;\n\tfloat vw0 = (3.0 - 2.0 * t);\n\tfloat vw1 = (1.0 + 2.0 * t);\n\tfloat v0 = (2.0 - t) / vw0 - 1.0;\n\tfloat v1 = t / vw1 + 1.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum *= 1.0f / 16.0;\n\treturn sum;\n}\nfloat getShadowPCF3x3(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#else\nfloat _xgetShadowPCF3x3(mat3 depthKernel, sampler2D shadowMap, vec3 shadowParams) {\n\tmat3 shadowKernel;\n\tvec3 shadowCoord = dShadowCoord;\n\tvec3 shadowZ = vec3(shadowCoord.z);\n\tshadowKernel[0] = vec3(greaterThan(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(greaterThan(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(greaterThan(depthKernel[2], shadowZ));\n\tvec2 fractionalCoord = fract( shadowCoord.xy * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat _getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\tvec3 shadowCoord = dShadowCoord;\n\tfloat xoffset = 1.0 / shadowParams.x;\n\tfloat dx0 = -xoffset;\n\tfloat dx1 = xoffset;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx0)));\n\tdepthKernel[0][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, 0.0)));\n\tdepthKernel[0][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx0, dx1)));\n\tdepthKernel[1][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx0)));\n\tdepthKernel[1][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy));\n\tdepthKernel[1][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(0.0, dx1)));\n\tdepthKernel[2][0] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx0)));\n\tdepthKernel[2][1] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, 0.0)));\n\tdepthKernel[2][2] = unpackFloat(texture2D(shadowMap, shadowCoord.xy + vec2(dx1, dx1)));\n\treturn _xgetShadowPCF3x3(depthKernel, shadowMap, shadowParams);\n}\nfloat getShadowPCF3x3(sampler2D shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF3x3(sampler2D shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF3x3(shadowMap, shadowParams.xyz);\n}\n#endif\nfloat _getShadowPoint(samplerCube shadowMap, vec4 shadowParams, vec3 dir) {\n\tvec3 tc = normalize(dir);\n\tvec3 tcAbs = abs(tc);\n\tvec4 dirX = vec4(1,0,0, tc.x);\n\tvec4 dirY = vec4(0,1,0, tc.y);\n\tfloat majorAxisLength = tc.z;\n\tif ((tcAbs.x > tcAbs.y) && (tcAbs.x > tcAbs.z)) {\n\t\tdirX = vec4(0,0,1, tc.z);\n\t\tdirY = vec4(0,1,0, tc.y);\n\t\tmajorAxisLength = tc.x;\n\t} else if ((tcAbs.y > tcAbs.x) && (tcAbs.y > tcAbs.z)) {\n\t\tdirX = vec4(1,0,0, tc.x);\n\t\tdirY = vec4(0,0,1, tc.z);\n\t\tmajorAxisLength = tc.y;\n\t}\n\tfloat shadowParamsInFaceSpace = ((1.0/shadowParams.x) * 2.0) * abs(majorAxisLength);\n\tvec3 xoffset = (dirX.xyz * shadowParamsInFaceSpace);\n\tvec3 yoffset = (dirY.xyz * shadowParamsInFaceSpace);\n\tvec3 dx0 = -xoffset;\n\tvec3 dy0 = -yoffset;\n\tvec3 dx1 = xoffset;\n\tvec3 dy1 = yoffset;\n\tmat3 shadowKernel;\n\tmat3 depthKernel;\n\tdepthKernel[0][0] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy0));\n\tdepthKernel[0][1] = unpackFloat(textureCube(shadowMap, tc + dx0));\n\tdepthKernel[0][2] = unpackFloat(textureCube(shadowMap, tc + dx0 + dy1));\n\tdepthKernel[1][0] = unpackFloat(textureCube(shadowMap, tc + dy0));\n\tdepthKernel[1][1] = unpackFloat(textureCube(shadowMap, tc));\n\tdepthKernel[1][2] = unpackFloat(textureCube(shadowMap, tc + dy1));\n\tdepthKernel[2][0] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy0));\n\tdepthKernel[2][1] = unpackFloat(textureCube(shadowMap, tc + dx1));\n\tdepthKernel[2][2] = unpackFloat(textureCube(shadowMap, tc + dx1 + dy1));\n\tvec3 shadowZ = vec3(length(dir) * shadowParams.w + shadowParams.z);\n\tshadowKernel[0] = vec3(lessThan2(depthKernel[0], shadowZ));\n\tshadowKernel[1] = vec3(lessThan2(depthKernel[1], shadowZ));\n\tshadowKernel[2] = vec3(lessThan2(depthKernel[2], shadowZ));\n\tvec2 uv = (vec2(dirX.w, dirY.w) / abs(majorAxisLength)) * 0.5;\n\tvec2 fractionalCoord = fract( uv * shadowParams.x );\n\tshadowKernel[0] = mix(shadowKernel[0], shadowKernel[1], fractionalCoord.x);\n\tshadowKernel[1] = mix(shadowKernel[1], shadowKernel[2], fractionalCoord.x);\n\tvec4 shadowValues;\n\tshadowValues.x = mix(shadowKernel[0][0], shadowKernel[0][1], fractionalCoord.y);\n\tshadowValues.y = mix(shadowKernel[0][1], shadowKernel[0][2], fractionalCoord.y);\n\tshadowValues.z = mix(shadowKernel[1][0], shadowKernel[1][1], fractionalCoord.y);\n\tshadowValues.w = mix(shadowKernel[1][1], shadowKernel[1][2], fractionalCoord.y);\n\treturn 1.0 - dot( shadowValues, vec4( 1.0 ) ) * 0.25;\n}\nfloat getShadowPointPCF3x3(samplerCube shadowMap, vec4 shadowParams) {\n\treturn _getShadowPoint(shadowMap, shadowParams, dLightDirW);\n}\n",shadowStandardGL2PS:"float _getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tfloat z = dShadowCoord.z;\n\tvec2 uv = dShadowCoord.xy * shadowParams.x;\n\tfloat shadowMapSizeInv = 1.0 / shadowParams.x;\n\tvec2 base_uv = floor(uv + 0.5);\n\tfloat s = (uv.x + 0.5 - base_uv.x);\n\tfloat t = (uv.y + 0.5 - base_uv.y);\n\tbase_uv -= vec2(0.5);\n\tbase_uv *= shadowMapSizeInv;\n\tfloat uw0 = (4.0 - 3.0 * s);\n\tfloat uw1 = 7.0;\n\tfloat uw2 = (1.0 + 3.0 * s);\n\tfloat u0 = (3.0 - 2.0 * s) / uw0 - 2.0;\n\tfloat u1 = (3.0 + s) / uw1;\n\tfloat u2 = s / uw2 + 2.0;\n\tfloat vw0 = (4.0 - 3.0 * t);\n\tfloat vw1 = 7.0;\n\tfloat vw2 = (1.0 + 3.0 * t);\n\tfloat v0 = (3.0 - 2.0 * t) / vw0 - 2.0;\n\tfloat v1 = (3.0 + t) / vw1;\n\tfloat v2 = t / vw2 + 2.0;\n\tfloat sum = 0.0;\n\tu0 = u0 * shadowMapSizeInv + base_uv.x;\n\tv0 = v0 * shadowMapSizeInv + base_uv.y;\n\tu1 = u1 * shadowMapSizeInv + base_uv.x;\n\tv1 = v1 * shadowMapSizeInv + base_uv.y;\n\tu2 = u2 * shadowMapSizeInv + base_uv.x;\n\tv2 = v2 * shadowMapSizeInv + base_uv.y;\n\tsum += uw0 * vw0 * texture(shadowMap, vec3(u0, v0, z));\n\tsum += uw1 * vw0 * texture(shadowMap, vec3(u1, v0, z));\n\tsum += uw2 * vw0 * texture(shadowMap, vec3(u2, v0, z));\n\tsum += uw0 * vw1 * texture(shadowMap, vec3(u0, v1, z));\n\tsum += uw1 * vw1 * texture(shadowMap, vec3(u1, v1, z));\n\tsum += uw2 * vw1 * texture(shadowMap, vec3(u2, v1, z));\n\tsum += uw0 * vw2 * texture(shadowMap, vec3(u0, v2, z));\n\tsum += uw1 * vw2 * texture(shadowMap, vec3(u1, v2, z));\n\tsum += uw2 * vw2 * texture(shadowMap, vec3(u2, v2, z));\n\tsum *= 1.0f / 144.0;\n\tsum = gammaCorrectInput(sum);\n\tsum = saturate(sum);\n\treturn sum;\n}\nfloat getShadowPCF5x5(sampler2DShadow shadowMap, vec3 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\nfloat getShadowSpotPCF5x5(sampler2DShadow shadowMap, vec4 shadowParams) {\n\treturn _getShadowPCF5x5(shadowMap, shadowParams.xyz);\n}\n",shadowStandardGL2VSPS:"float getShadowPCF5x5VS(sampler2DShadow shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\treturn _getShadowPCF5x5(shadowMap, shadowParams);\n}\n",shadowStandardVSPS:"#ifdef GL2\n#define SHADOW_SAMPLERVS sampler2DShadow\n#else\n#define SHADOW_SAMPLERVS sampler2D\n#endif\nfloat getShadowPCF3x3VS(SHADOW_SAMPLERVS shadowMap, vec3 shadowParams) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z = saturate(dShadowCoord.z) - 0.0001;\n\t#ifdef SHADOWBIAS\n\tdShadowCoord.z += getShadowBias(shadowParams.x, shadowParams.z);\n\t#endif\n\treturn _getShadowPCF3x3(shadowMap, shadowParams);\n}\n",shadowVSM8PS:"float calculateVSM8(vec3 moments, float Z, float vsmBias) {\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * Z;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, Z, minVariance1, 0.1);\n}\nfloat decodeFloatRG(vec2 rg) {\n\treturn rg.y*(1.0/255.0) + rg.x;\n}\nfloat VSM8(sampler2D tex, vec2 texCoords, float resolution, float Z, float vsmBias, float exponent) {\n\tvec4 c = texture2D(tex, texCoords);\n\tvec3 moments = vec3(decodeFloatRG(c.xy), decodeFloatRG(c.zw), 0.0);\n\treturn calculateVSM8(moments, Z, vsmBias);\n}\nfloat getShadowVSM8(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, 0.0);\n}\nfloat getShadowSpotVSM8(sampler2D shadowMap, vec4 shadowParams, float exponent) {\n\treturn VSM8(shadowMap, dShadowCoord.xy, shadowParams.x, length(dLightDirW) * shadowParams.w + shadowParams.z, shadowParams.y, 0.0);\n}\n",shadowVSMVSPS:"float getShadowVSM$VS(sampler2D shadowMap, vec3 shadowParams, float exponent) {\n\tdShadowCoord = vMainShadowUv.xyz;\n\tdShadowCoord.z += shadowParams.z;\n\tdShadowCoord.xyz /= vMainShadowUv.w;\n\tdShadowCoord.z = min(dShadowCoord.z, 1.0);\n\treturn $VSM(shadowMap, dShadowCoord.xy, shadowParams.x, dShadowCoord.z, shadowParams.y, exponent);\n}\n",shadowVSM_commonPS:"float linstep(float a, float b, float v) {\n\treturn saturate((v - a) / (b - a));\n}\nfloat reduceLightBleeding(float pMax, float amount) {\n   return linstep(amount, 1.0, pMax);\n}\nfloat chebyshevUpperBound(vec2 moments, float mean, float minVariance, float lightBleedingReduction) {\n\tfloat variance = moments.y - (moments.x * moments.x);\n\tvariance = max(variance, minVariance);\n\tfloat d = mean - moments.x;\n\tfloat pMax = variance / (variance + (d * d));\n\tpMax = reduceLightBleeding(pMax, lightBleedingReduction);\n\treturn (mean <= moments.x ? 1.0 : pMax);\n}\nfloat calculateEVSM(vec3 moments, float Z, float vsmBias, float exponent) {\n\tZ = 2.0 * Z - 1.0;\n\tfloat warpedDepth = exp(exponent * Z);\n\tmoments.xy += vec2(warpedDepth, warpedDepth*warpedDepth) * (1.0 - moments.z);\n\tfloat VSMBias = vsmBias;\n\tfloat depthScale = VSMBias * exponent * warpedDepth;\n\tfloat minVariance1 = depthScale * depthScale;\n\treturn chebyshevUpperBound(moments.xy, warpedDepth, minVariance1, 0.1);\n}\n",skinBatchConstVS:"attribute float vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nmat4 getBoneMatrix(const in float i) {\n\tvec4 v1 = matrix_pose[int(3.0 * i)];\n\tvec4 v2 = matrix_pose[int(3.0 * i + 1.0)];\n\tvec4 v3 = matrix_pose[int(3.0 * i + 2.0)];\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinBatchTexVS:"attribute float vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nmat4 getBoneMatrix(const in float i) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tvec4 v1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tvec4 v2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tvec4 v3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, 1\n\t);\n}\n",skinConstVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform vec4 matrix_pose[BONE_LIMIT * 3];\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tv1 = matrix_pose[int(3.0 * i)];\n\tv2 = matrix_pose[int(3.0 * i + 1.0)];\n\tv3 = matrix_pose[int(3.0 * i + 2.0)];\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skinTexVS:"attribute vec4 vertex_boneWeights;\nattribute vec4 vertex_boneIndices;\nuniform highp sampler2D texture_poseMap;\nuniform vec4 texture_poseMapSize;\nvoid getBoneMatrix(const in float i, out vec4 v1, out vec4 v2, out vec4 v3) {\n\tfloat j = i * 3.0;\n\tfloat dx = texture_poseMapSize.z;\n\tfloat dy = texture_poseMapSize.w;\n\tfloat y = floor(j * dx);\n\tfloat x = j - (y * texture_poseMapSize.x);\n\ty = dy * (y + 0.5);\n\tv1 = texture2D(texture_poseMap, vec2(dx * (x + 0.5), y));\n\tv2 = texture2D(texture_poseMap, vec2(dx * (x + 1.5), y));\n\tv3 = texture2D(texture_poseMap, vec2(dx * (x + 2.5), y));\n}\nmat4 getSkinMatrix(const in vec4 indices, const in vec4 weights) {\n\tvec4 a1, a2, a3;\n\tgetBoneMatrix(indices.x, a1, a2, a3);\n\tvec4 b1, b2, b3;\n\tgetBoneMatrix(indices.y, b1, b2, b3);\n\tvec4 c1, c2, c3;\n\tgetBoneMatrix(indices.z, c1, c2, c3);\n\tvec4 d1, d2, d3;\n\tgetBoneMatrix(indices.w, d1, d2, d3);\n\tvec4 v1 = a1 * weights.x + b1 * weights.y + c1 * weights.z + d1 * weights.w;\n\tvec4 v2 = a2 * weights.x + b2 * weights.y + c2 * weights.z + d2 * weights.w;\n\tvec4 v3 = a3 * weights.x + b3 * weights.y + c3 * weights.z + d3 * weights.w;\n\tfloat one = dot(weights, vec4(1.0));\n\treturn mat4(\n\t\tv1.x, v2.x, v3.x, 0,\n\t\tv1.y, v2.y, v3.y, 0,\n\t\tv1.z, v2.z, v3.z, 0,\n\t\tv1.w, v2.w, v3.w, one\n\t);\n}\n",skyboxPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tgl_FragColor = textureCube(texture_cubeMap, fixSeams(vViewDir));\n}\n",skyboxVS:"attribute vec3 aPosition;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nuniform mat4 matrix_projectionSkybox;\nvarying vec3 vViewDir;\nvoid main(void) {\n\tmat4 view = matrix_view;\n\tview[3][0] = view[3][1] = view[3][2] = 0.0;\n\tgl_Position = matrix_projectionSkybox * view * vec4(aPosition, 1.0);\n\tgl_Position.z = gl_Position.w - 0.00001;\n\tvViewDir = aPosition;\n\tvViewDir.x *= -1.0;\n}\n",skyboxHDRPS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvoid main(void) {\n\tvec3 color = processEnvironment($textureCubeSAMPLE(texture_cubeMap, fixSeamsStatic(vViewDir, $FIXCONST)).rgb);\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",skyboxPrefilteredCubePS:"varying vec3 vViewDir;\nuniform samplerCube texture_cubeMap;\nvec3 fixSeamsStretch(vec3 vec, float mipmapIndex, float cubemapSize) {\n\tfloat scale = 1.0 - exp2(mipmapIndex) / cubemapSize;\n\tfloat M = max(max(abs(vec.x), abs(vec.y)), abs(vec.z));\n\tif (abs(vec.x) != M) vec.x *= scale;\n\tif (abs(vec.y) != M) vec.y *= scale;\n\tif (abs(vec.z) != M) vec.z *= scale;\n\treturn vec;\n}\nvoid main(void) {\n\tvec3 color = textureCubeRGBM(texture_cubeMap, fixSeamsStretch(vViewDir, 0.0, 128.0));\n\tcolor = toneMap(color);\n\tcolor = gammaCorrectOutput(color);\n\tgl_FragColor = vec4(color, 1.0);\n}\n",specularPS:"#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\t#ifdef MAPCOLOR\n\tdSpecularity *= material_specular;\n\t#endif\n\t#ifdef MAPTEXTURE\n\tdSpecularity *= texture2D(texture_specularMap, $UV).$CH;\n\t#endif\n\t#ifdef MAPVERTEX\n\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}\n",specularAaNonePS:"float antiAliasGlossiness(float power) {\n\treturn power;\n}\n",specularAaToksvigPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * mix(1.0, toksvig, material_bumpiness);\n}\n",specularAaToksvigFastPS:"float antiAliasGlossiness(float power) {\n\tfloat rlen = 1.0 / saturate(length(dNormalMap));\n\tfloat toksvig = 1.0 / (1.0 + power * (rlen - 1.0));\n\treturn power * toksvig;\n}\n",spotPS:"float getSpotEffect(vec3 lightSpotDirW, float lightInnerConeAngle, float lightOuterConeAngle) {\n\tfloat cosAngle = dot(dLightDirNormW, lightSpotDirW);\n\treturn smoothstep(lightOuterConeAngle, lightInnerConeAngle, cosAngle);\n}\n",startPS:"void main(void) {\n\tdDiffuseLight = vec3(0);\n\tdSpecularLight = vec3(0);\n\tdReflection = vec4(0);\n\tdSpecularity = vec3(0);\n\t#ifdef CLEARCOAT\n\tccSpecularLight = vec3(0);\n\tccReflection = vec4(0);\n\t#endif\n",startVS:"void main(void) {\n\tgl_Position = getPosition();\n",startNineSlicedPS:"\tnineSlicedUv = vUv0;\n",startNineSlicedTiledPS:"\tvec2 tileMask = step(vMask, vec2(0.99999));\n\tvec2 clampedUv = mix(innerOffset.xy*0.5, vec2(1.0) - innerOffset.zw*0.5, fract(vTiledUv));\n\tclampedUv = clampedUv * atlasRect.zw + atlasRect.xy;\n\tnineSlicedUv = vUv0 * tileMask + clampedUv * (vec2(1.0) - tileMask);\n",storeEVSMPS:"float exponent = VSM_EXPONENT;\ndepth = 2.0 * depth - 1.0;\ndepth =  exp(exponent * depth);\ngl_FragColor = vec4(depth, depth*depth, 1.0, 1.0);\n",tangentBinormalVS:"vec3 getTangent() {\n\treturn normalize(dNormalMatrix * vertex_tangent.xyz);\n}\nvec3 getBinormal() {\n\treturn cross(vNormalW, vTangentW) * vertex_tangent.w;\n}\nvec3 getObjectSpaceUp() {\n\treturn normalize(dNormalMatrix * vec3(0, 1, 0));\n}\n",TBNPS:"void getTBN() {\n\tdTBN = mat3(normalize(dTangentW), normalize(dBinormalW), normalize(dVertexNormalW));\n}\n",TBNderivativePS:"\nvoid getTBN() {\n\tvec2 uv = $UV;\n\tvec3 dp1 = dFdx( vPositionW );\n\tvec3 dp2 = dFdy( vPositionW );\n\tvec2 duv1 = dFdx( uv );\n\tvec2 duv2 = dFdy( uv );\n\tvec3 dp2perp = cross( dp2, dVertexNormalW );\n\tvec3 dp1perp = cross( dVertexNormalW, dp1 );\n\tvec3 T = dp2perp * duv1.x + dp1perp * duv2.x;\n\tvec3 B = dp2perp * duv1.y + dp1perp * duv2.y;\n\tfloat invmax = 1.0 / sqrt( max( dot(T,T), dot(B,B) ) );\n\tdTBN = mat3( T * invmax, B * invmax, dVertexNormalW );\n}\n",TBNfastPS:"void getTBN() {\n\tdTBN = mat3(dTangentW, dBinormalW, dVertexNormalW);\n}\n",TBNObjectSpacePS:"void getTBN() {\n\tvec3 B = cross(dVertexNormalW, vObjectSpaceUpW);\n\tvec3 T = cross(dVertexNormalW, B);\n\tif (dot(B,B)==0.0)\n\t{\n\t\tfloat major=max(max(dVertexNormalW.x, dVertexNormalW.y),dVertexNormalW.z);\n\t\tif (dVertexNormalW.x==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,1,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.y==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(0,0,1));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t\telse if (dVertexNormalW.z==major)\n\t\t{\n\t\t\tB=cross(dVertexNormalW, vec3(1,0,0));\n\t\t\tT=cross(dVertexNormalW, B);\n\t\t}\n\t}\n\tdTBN = mat3(normalize(T), normalize(B), normalize(dVertexNormalW));\n}\n",tonemappingAcesPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tfloat tA = 2.51;\n\tfloat tB = 0.03;\n\tfloat tC = 2.43;\n\tfloat tD = 0.59;\n\tfloat tE = 0.14;\n\tvec3 x = color * exposure;\n\treturn (x*(tA*x+tB))/(x*(tC*x+tD)+tE);\n}\n",tonemappingAces2PS:"uniform float exposure;\nconst mat3 ACESInputMat = mat3(\n\t0.59719, 0.35458, 0.04823,\n\t0.07600, 0.90834, 0.01566,\n\t0.02840, 0.13383, 0.83777\n);\nconst mat3 ACESOutputMat = mat3(\n\t 1.60475, -0.53108, -0.07367,\n\t-0.10208,  1.10813, -0.00605,\n\t-0.00327, -0.07276,  1.07602\n);\nvec3 RRTAndODTFit(vec3 v) {\n\tvec3 a = v * (v + 0.0245786) - 0.000090537;\n\tvec3 b = v * (0.983729 * v + 0.4329510) + 0.238081;\n\treturn a / b;\n}\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tcolor = color * ACESInputMat;\n\tcolor = RRTAndODTFit(color);\n\tcolor = color * ACESOutputMat;\n\tcolor = clamp(color, 0.0, 1.0);\n\treturn color;\n}\n",tonemappingFilmicPS:"const float A =  0.15;\nconst float B =  0.50;\nconst float C =  0.10;\nconst float D =  0.20;\nconst float E =  0.02;\nconst float F =  0.30;\nconst float W =  11.2;\nuniform float exposure;\nvec3 uncharted2Tonemap(vec3 x) {\n   return ((x*(A*x+C*B)+D*E)/(x*(A*x+B)+D*F))-E/F;\n}\nvec3 toneMap(vec3 color) {\n\tcolor = uncharted2Tonemap(color * exposure);\n\tvec3 whiteScale = 1.0 / uncharted2Tonemap(vec3(W,W,W));\n\tcolor = color * whiteScale;\n\treturn color;\n}\n",tonemappingHejlPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\tcolor *= exposure;\n\tconst float  A = 0.22, B = 0.3, C = .1, D = 0.2, E = .01, F = 0.3;\n\tconst float Scl = 1.25;\n\tvec3 h = max( vec3(0.0), color - vec3(0.004) );\n\treturn (h*((Scl*A)*h+Scl*vec3(C*B,C*B,C*B))+Scl*vec3(D*E,D*E,D*E)) / (h*(A*h+vec3(B,B,B))+vec3(D*F,D*F,D*F)) - Scl*vec3(E/F,E/F,E/F);\n}\n",tonemappingLinearPS:"uniform float exposure;\nvec3 toneMap(vec3 color) {\n\treturn color * exposure;\n}\n",tonemappingNonePS:"vec3 toneMap(vec3 color) {\n\treturn color;\n}\n",transformVS:"#ifdef PIXELSNAP\nuniform vec4 uScreenSize;\n#endif\n#ifdef MORPHING\nuniform vec4 morph_weights_a;\nuniform vec4 morph_weights_b;\n#endif\n#ifdef MORPHING_TEXTURE_BASED\nuniform vec4 morph_tex_params;\nvec2 getTextureMorphCoords() {\n\tfloat vertexId = morph_vertex_id;\n\tvec2 textureSize = morph_tex_params.xy;\n\tvec2 invTextureSize = morph_tex_params.zw;\n\tfloat morphGridV = floor(vertexId * invTextureSize.x);\n\tfloat morphGridU = vertexId - (morphGridV * textureSize.x);\n\treturn (vec2(morphGridU, morphGridV) * invTextureSize) + (0.5 * invTextureSize);\n}\n#endif\n#ifdef MORPHING_TEXTURE_BASED_POSITION\nuniform highp sampler2D morphPositionTex;\n#endif\nmat4 getModelMatrix() {\n\t#ifdef DYNAMICBATCH\n\treturn getBoneMatrix(vertex_boneIndices);\n\t#elif defined(SKIN)\n\treturn matrix_model * getSkinMatrix(vertex_boneIndices, vertex_boneWeights);\n\t#elif defined(INSTANCING)\n\treturn mat4(instance_line1, instance_line2, instance_line3, instance_line4);\n\t#else\n\treturn matrix_model;\n\t#endif\n}\nvec4 getPosition() {\n\tdModelMatrix = getModelMatrix();\n\tvec3 localPos = vertex_position;\n\t#ifdef NINESLICED\n\tlocalPos.xz *= outerScale;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tlocalPos.xz += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tvTiledUv = (localPos.xz - outerScale + innerOffset.xy) * -0.5 + 1.0;\n\tlocalPos.xz *= -0.5;\n\tlocalPos = localPos.xzy;\n\t#endif\n\t#ifdef MORPHING\n\t#ifdef MORPHING_POS03\n\tlocalPos.xyz += morph_weights_a[0] * morph_pos0;\n\tlocalPos.xyz += morph_weights_a[1] * morph_pos1;\n\tlocalPos.xyz += morph_weights_a[2] * morph_pos2;\n\tlocalPos.xyz += morph_weights_a[3] * morph_pos3;\n\t#endif\n\t#ifdef MORPHING_POS47\n\tlocalPos.xyz += morph_weights_b[0] * morph_pos4;\n\tlocalPos.xyz += morph_weights_b[1] * morph_pos5;\n\tlocalPos.xyz += morph_weights_b[2] * morph_pos6;\n\tlocalPos.xyz += morph_weights_b[3] * morph_pos7;\n\t#endif\n\t#endif\n\t#ifdef MORPHING_TEXTURE_BASED_POSITION\n\tvec2 morphUV = getTextureMorphCoords();\n\tvec3 morphPos = texture2D(morphPositionTex, morphUV).xyz;\n\tlocalPos += morphPos;\n\t#endif\n\tvec4 posW = dModelMatrix * vec4(localPos, 1.0);\n\t#ifdef SCREENSPACE\n\tposW.zw = vec2(0.0, 1.0);\n\t#endif\n\tdPositionW = posW.xyz;\n\tvec4 screenPos;\n\t#ifdef UV1LAYOUT\n\tscreenPos = vec4(vertex_texCoord1.xy * 2.0 - 1.0, 0.5, 1);\n\t#else\n\t#ifdef SCREENSPACE\n\tscreenPos = posW;\n\t#else\n\tscreenPos = matrix_viewProjection * posW;\n\t#endif\n\t#ifdef PIXELSNAP\n\tscreenPos.xy = (screenPos.xy * 0.5) + 0.5;\n\tscreenPos.xy *= uScreenSize.xy;\n\tscreenPos.xy = floor(screenPos.xy);\n\tscreenPos.xy *= uScreenSize.zw;\n\tscreenPos.xy = (screenPos.xy * 2.0) - 1.0;\n\t#endif\n\t#endif\n\treturn screenPos;\n}\nvec3 getWorldPosition() {\n\treturn dPositionW;\n}\n",transformDeclVS:"attribute vec3 vertex_position;\nuniform mat4 matrix_model;\nuniform mat4 matrix_viewProjection;\nvec3 dPositionW;\nmat4 dModelMatrix;\n",uv0VS:"#ifdef NINESLICED\nvec2 getUv0() {\n\tvec2 uv = vertex_position.xz;\n\tvec2 positiveUnitOffset = clamp(vertex_position.xz, vec2(0.0), vec2(1.0));\n\tvec2 negativeUnitOffset = clamp(-vertex_position.xz, vec2(0.0), vec2(1.0));\n\tuv += (-positiveUnitOffset * innerOffset.xy + negativeUnitOffset * innerOffset.zw) * vertex_texCoord0.xy;\n\tuv = uv * -0.5 + 0.5;\n\tuv = uv * atlasRect.zw + atlasRect.xy;\n\tvMask = vertex_texCoord0.xy;\n\treturn uv;\n}\n#else\nvec2 getUv0() {\n\treturn vertex_texCoord0;\n}\n#endif\n",uv1VS:"vec2 getUv1() {\n\treturn vertex_texCoord1;\n}\n",viewDirPS:"void getViewDir() {\n\tdViewDirW = normalize(view_position - vPositionW);\n}\n",viewNormalVS:"#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\nvec3 getViewNormal() {\n\treturn mat3(matrix_view) * vNormalW;\n}\n"},Da={vertex_position:"POSITION",vertex_normal:"NORMAL",vertex_tangent:"TANGENT",vertex_texCoord0:"TEXCOORD0",vertex_texCoord1:"TEXCOORD1",vertex_texCoord2:"TEXCOORD2",vertex_texCoord3:"TEXCOORD3",vertex_texCoord4:"TEXCOORD4",vertex_texCoord5:"TEXCOORD5",vertex_texCoord6:"TEXCOORD6",vertex_texCoord7:"TEXCOORD7",vertex_color:"COLOR",vertex_boneIndices:"BLENDINDICES",vertex_boneWeights:"BLENDWEIGHT"};Ra.collectAttribs=it,Ra.createShader=function(t,e,i,s){e=Ra[e],i=Q(t)+"\n"+Ra[i];var n=it(e);return t.webgl2&&(e=J(t)+Ra.gles3VS+e,i=J(t)+Ra.gles3PS+i),new q(t,{attributes:n,vshader:e,fshader:i,useTransformFeedback:s})},Ra.createShaderFromCode=st;var La=function(t,e,i){return"\n#ifdef MAPFLOAT\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"},Fa=function(t,e,i){return"\n#ifdef MAPCOLOR\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"},Ba=function(t,e,i){return"\n#ifdef MAPTEXTURE\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"},Na=function(t,e,i){return"#undef MAPTEXTURECOLOR\n#ifdef MAPTEXTURE\n#ifdef MAPCOLOR\n#define MAPTEXTURECOLOR\n#endif\n#endif\n#ifdef MAPTEXTURECOLOR\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"},ka=function(t,e,i){return"#undef MAPTEXTUREFLOAT\n#ifdef MAPTEXTURE\n#ifdef MAPFLOAT\n#define MAPTEXTUREFLOAT\n#endif\n#endif\n#ifdef MAPTEXTUREFLOAT\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"},za=function(t,e,i){return"\n#ifdef MAPVERTEX\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"},Ua=function(t,e,i){return"#undef MAPVERTEXCOLOR\n#ifdef MAPVERTEX\n#ifdef MAPCOLOR\n#define MAPVERTEXCOLOR\n#endif\n#endif\n#ifdef MAPVERTEXCOLOR\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"},Va=function(t,e,i){return"#undef MAPVERTEXFLOAT\n#ifdef MAPVERTEX\n#ifdef MAPFLOAT\n#define MAPVERTEXFLOAT\n#endif\n#endif\n#ifdef MAPVERTEXFLOAT\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"},ja=[],Ga={_oldChunkToNew:{aoTexPS:{n:"aoPS",f:Ba},aoVertPS:{n:"aoPS",f:za},diffuseConstPS:{n:"diffusePS",f:Fa},diffuseTexPS:{n:"diffusePS",f:Ba},diffuseTexConstPS:{n:"diffusePS",f:Na},diffuseVertPS:{n:"diffusePS",f:za},diffuseVertConstPS:{n:"diffusePS",f:Ua},emissiveConstPS:{n:"emissivePS",f:Fa},emissiveTexPS:{n:"emissivePS",f:Ba},emissiveTexConstPS:{n:"emissivePS",f:Na},emissiveTexConstFloatPS:{n:"emissivePS",f:ka},emissiveVertPS:{n:"emissivePS",f:za},emissiveVertConstPS:{n:"emissivePS",f:Ua},emissiveVertConstFloatPS:{n:"emissivePS",f:Va},glossConstPS:{n:"glossPS",f:La},glossTexPS:{n:"glossPS",f:Ba},glossTexConstPS:{n:"glossPS",f:ka},glossVertPS:{n:"glossPS",f:za},glossVertConstPS:{n:"glossPS",f:Va},metalnessConstPS:{n:"metalnessPS",f:La},metalnessTexPS:{n:"metalnessPS",f:Ba},metalnessTexConstPS:{n:"metalnessPS",f:ka},metalnessVertPS:{n:"metalnessPS",f:za},metalnessVertConstPS:{n:"metalnessPS",f:Va},opacityConstPS:{n:"opacityPS",f:La},opacityTexPS:{n:"opacityPS",f:Ba},opacityTexConstPS:{n:"opacityPS",f:ka},opacityVertPS:{n:"opacityPS",f:za},opacityVertConstPS:{n:"opacityPS",f:Va},specularConstPS:{n:"specularPS",f:Fa},specularTexPS:{n:"specularPS",f:Ba},specularTexConstPS:{n:"specularPS",f:Na},specularVertPS:{n:"specularPS",f:za},specularVertConstPS:{n:"specularPS",f:Ua},transformBatchSkinnedVS:{n:"transformVS",f:function(t,e,i){return"\n#ifdef DYNAMICBATCH\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"}},transformInstancedVS:{n:"transformVS",f:function(t,e,i){return"\n#ifdef INSTANCING\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"}},transformPixelSnapVS:{n:"transformVS",f:function(t,e,i){return"\n#ifdef PIXELSNAP\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"}},transformScreenSpaceVS:{n:"transformVS",f:function(t,e,i){return"\n#ifdef SCREENSPACE\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"}},transformScreenSpaceBatchSkinned:{n:"transformVS",f:function(t,e,i){return"#undef SCREENSPACEBATCH\n#ifdef SCREENSPACE\n#ifdef BATCH\n#define SCREENSPACEBATCH\n#endif\n#endif\n#ifdef SCREENSPACEBATCH\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"}},transformSkinned:{n:"transformVS",f:function(t,e,i){return"\n#ifdef SKIN\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"}},transformUv1:{n:"transformVS",f:function(t,e,i){return"\n#ifdef UV1LAYOUT\n"+t+"\n#else\n"+Ra[e]+"\n#endif\n"}}},optionsContext:{},optionsContextMin:{},generateKey:function(t){var e,i=function(t){var e,i=[];for(e in t)t.hasOwnProperty(e)&&"chunks"!==e&&"lights"!==e&&i.push(e);return i.sort()};if(t===this.optionsContextMin){this.propsMin||(this.propsMin=i(t));var s=this.propsMin}else t===this.optionsContext?(this.props||(this.props=i(t)),s=this.props):s=i(t);for(i="standard",e=0;e<s.length;e++)t[s[e]]&&(i+=s[e]+t[s[e]]);if(t.chunks){for(var n in s=[],t.chunks)t.chunks.hasOwnProperty(n)&&s.push(n+t.chunks[n]);s.sort(),i+=s}if(t.lights)for(e=0;e<t.lights.length;e++)i+=t.lights[e].key;return I(i)},_correctChannel:function(t,e){if(0<ja[t]){if(ja[t]<e.length)return e.substring(0,ja[t]);if(ja[t]>e.length){var i=e.charAt(e.length-1);t=ja[t]-e.length;for(var s=0;s<t;s++)e+=i;return e}return e}},_setMapTransform:function(t,e,i,s){t[0]+="uniform vec4 texture_"+e+"MapTransform;\n";var n=i+100*s;return t[3][n]||(t[1]+="varying vec2 vUV"+s+"_"+i+";\n",t[2]+="   vUV"+s+"_"+i+" = uv"+s+" * texture_"+e+"MapTransform.xy + texture_"+e+"MapTransform.zw;\n",t[3][n]=!0),t},_getUvSourceExpression:function(t,e,i){var s=i[t];e=i[e];var n=0===i.pass||1===i.pass;return n&&1===i.nineSlicedMode?s="nineSlicedUv":n&&2===i.nineSlicedMode?s="nineSlicedUv, -1000.0":(s=0===s?"vUv"+e:"vUV"+e+"_"+s,i.heightMap&&"heightMapTransform"!==t&&(s+=" + dUvOffset")),s},_addMapDef:function(t,e){var i="\n#undef "+t+"\n";return e&&(i+=" #define "+t+"\n"),i},_addMapDefs:function(t,e,i,s){return t=""+this._addMapDef("MAPFLOAT",t),t+=this._addMapDef("MAPCOLOR",e),(t+=this._addMapDef("MAPVERTEX",i))+this._addMapDef("MAPTEXTURE",s)},_addMap:function(t,e,i,s,n){var r=t+"Map",a=r+"Uv",o=r+"Transform",h=r+"Channel",l=t+"VertexColorChannel",c=i[t+"Tint"],d=i[t+"VertexColor"];return r=i[r],t=i[t+"Mode"],e=s[e],r&&(a=this._getUvSourceExpression(o,a,i),e=e.replace(/\$UV/g,a).replace(/\$CH/g,i[h]),void 0!==n&&(e=e.replace(/\$texture2DSAMPLE/g,0===n?"texture2DSRGB":1===n?"texture2DRGBM":"texture2D"))),d&&(e=e.replace(/\$VC/g,i[l])),t&&(e=e.replace(/\$DETAILMODE/g,t)),(e=this._addMapDefs(1===c,3===c,d,r)+e).replace(/\$/g,"")},_nonPointShadowMapProjection:function(t,e,i){return!e._normalOffsetBias||e._isVsm?2===e._type?e._isPcf&&(t.webgl2||t.extStandardDerivatives)?"\t   getShadowCoordPerspZbuffer"+i:"\t   getShadowCoordPersp"+i:"\t   getShadowCoordOrtho"+i:2===e._type?e._isPcf&&(t.webgl2||t.extStandardDerivatives)?"\t   getShadowCoordPerspZbufferNormalOffset"+i:"\t   getShadowCoordPerspNormalOffset"+i:"\t   getShadowCoordOrthoNormalOffset"+i},_addVaryingIfNeeded:function(t,e,i){return 0<=t.indexOf(i)?"varying "+e+" "+i+";\n":""},_vsAddTransformCode:function(t,e,i,s){return t+i.transformVS},_vsAddBaseCode:function(t,e,i,s){return t+=i.baseVS,1!==s.nineSlicedMode&&2!==s.nineSlicedMode||(t+=i.baseNineSlicedVS),t},_fsAddBaseCode:function(t,e,i,s){return t+=i.basePS,1===s.nineSlicedMode?t+=i.baseNineSlicedPS:2===s.nineSlicedMode&&(t+=i.baseNineSlicedTiledPS),t},_fsAddStartCode:function(t,e,i,s){return t+=i.startPS,1===s.nineSlicedMode?t+=i.startNineSlicedPS:2===s.nineSlicedMode&&(t+=i.startNineSlicedTiledPS),t},createShaderDefinition:function(t,e){var i=0<e.lights.length;e.dirLightMap&&(i=!0,e.useSpecular=!0),0===e.shadingModel?(e.fresnelModel=0,e.specularAntialias=!1,e.prefilteredCubemap=!1,e.dpAtlas=!1,e.ambientSH=!1):e.fresnelModel=0===e.fresnelModel?2:e.fresnelModel;var s=(e.cubeMap||e.prefilteredCubemap&&e.useSpecular)&&!e.sphereMap&&!e.dpAtlas,n=e.sphereMap||s||e.dpAtlas,r=e.useTexCubeLod;e.cubeMap&&(e.sphereMap=null),e.dpAtlas&&(e.prefilteredCubemap=null),e.useSpecular||(e.specularMap=e.glossMap=null);var a=i||n||e.ambientSH||e.prefilteredCubemap||e.heightMap||e.enableGGXSpecular,o=3<=e.pass&&17>=e.pass;this.options=e;var h="",l="",c="",d=Ra,u={vertex_position:"POSITION"};if(e.chunks){var p={};for(b in d)if(d.hasOwnProperty(b))if(e.chunks[b]){var f=e.chunks[b];0<=f.indexOf("vertex_normal")&&(u.vertex_normal="NORMAL"),0<=f.indexOf("vertex_tangent")&&(u.vertex_tangent="TANGENT"),0<=f.indexOf("vertex_texCoord0")&&(u.vertex_texCoord0="TEXCOORD0"),0<=f.indexOf("vertex_texCoord1")&&(u.vertex_texCoord1="TEXCOORD1"),0<=f.indexOf("vertex_color")&&(u.vertex_color="COLOR"),0<=f.indexOf("vertex_boneWeights")&&(u.vertex_boneWeights="BLENDWEIGHT"),0<=f.indexOf("vertex_boneIndices")&&(u.vertex_boneIndices="BLENDINDICES"),p[b]=f}else p[b]=d[b];for(b in e.chunks)(d=this._oldChunkToNew[b])&&(p[d.n]=d.f(e.chunks[b],d.n,b));d=p}if(h=this._vsAddBaseCode(h,t,d,e),p=-1,!e.noShadow&&!e.twoSidedLighting){for(f=0;f<e.lights.length;f++){var m=e.lights[f]._type;if(e.lights[f].castShadows&&0===m){h+="uniform mat4 light"+f+"_shadowMatrixVS;\n",h+="uniform vec3 light"+f+"_shadowParamsVS;\n",h+="uniform vec3 light"+f+(0===m?"_directionVS":"_positionVS")+";\n",p=f;break}}0<=p&&(h+=d.shadowCoordVS)}l+="   vPositionW\t= getWorldPosition();\n",2===e.pass&&(h+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n",l+="\tvDepth = -(matrix_view * vec4(vPositionW,1.0)).z * camera_params.x;\n"),e.useInstancing&&(u.instance_line1="TEXCOORD2",u.instance_line2="TEXCOORD3",u.instance_line3="TEXCOORD4",u.instance_line4="TEXCOORD5",h+=d.instancingVS),a&&(u.vertex_normal="NORMAL",l+="   vNormalW\t= dNormalW = getNormal();\n",e.sphereMap&&16>=t.fragmentUniformsCount&&(h+=d.viewNormalVS,l+="   vNormalV\t= getViewNormal();\n"),(e.heightMap||e.normalMap||e.enableGGXSpecular)&&e.hasTangents?(u.vertex_tangent="TANGENT",h+=d.tangentBinormalVS,l+="   vTangentW   = getTangent();\n   vBinormalW  = getBinormal();\n"):e.enableGGXSpecular&&(h+=d.tangentBinormalVS,l+="   vObjectSpaceUpW  = getObjectSpaceUp();\n"),0<=p&&(l=(0===(m=e.lights[p]._type)?l+"   dLightDirNormW = light"+p+"_directionVS;\n":l+"   getLightDirPoint(light"+p+"_positionVS);\n")+this._nonPointShadowMapProjection(t,e.lights[p],"(light"+p+"_shadowMatrixVS, light"+p+"_shadowParamsVS);\n"))),m=[];var _=[];for(b in ja){if(f=b+"Map",e[b+"VertexColor"]){var g=b+"VertexColorChannel";e[g]=this._correctChannel(b,e[g])}if(e[f]){g=f+"Channel";var y=f+"Transform",v=f+"Uv";e[v]=Math.min(e[v],1),e[g]=this._correctChannel(b,e[g]),m[v=e[v]]=!0,_[v]=_[v]||e[f]&&!e[y]}}for(e.forceUv1&&(m[1]=!0),f=0;2>f;f++)m[f]&&(u["vertex_texCoord"+f]="TEXCOORD"+f,h+=d["uv"+f+"VS"],l+="   vec2 uv"+f+" = getUv"+f+"();\n"),_[f]&&(l+="   vUv"+f+" = uv"+f+";\n");for(b in m=[h,c,l,[]],ja)e[f=b+"Map"]&&(e[y=f+"Transform"]&&(v=f+"Uv",this._setMapTransform(m,b,e[y],e[v])));h=m[0],c=m[1],l=m[2],e.vertexColors&&(u.vertex_color="COLOR",l+="   vVertexColor = vertex_color;\n"),(e.useMorphPosition||e.useMorphNormal)&&(e.useMorphTextureBased?(h+="#define MORPHING_TEXTURE_BASED\n",e.useMorphPosition&&(h+="#define MORPHING_TEXTURE_BASED_POSITION\n"),e.useMorphNormal&&(h+="#define MORPHING_TEXTURE_BASED_NORMAL\n"),u.morph_vertex_id="ATTR15",h+="attribute float morph_vertex_id;\n"):(h+="#define MORPHING\n",e.useMorphPosition?(u.morph_pos0="ATTR8",u.morph_pos1="ATTR9",u.morph_pos2="ATTR10",u.morph_pos3="ATTR11",h+="#define MORPHING_POS03\nattribute vec3 morph_pos0;\nattribute vec3 morph_pos1;\nattribute vec3 morph_pos2;\nattribute vec3 morph_pos3;\n"):e.useMorphNormal&&(u.morph_nrm0="ATTR8",u.morph_nrm1="ATTR9",u.morph_nrm2="ATTR10",u.morph_nrm3="ATTR11",h+="#define MORPHING_NRM03\nattribute vec3 morph_nrm0;\nattribute vec3 morph_nrm1;\nattribute vec3 morph_nrm2;\nattribute vec3 morph_nrm3;\n"),e.useMorphNormal?(u.morph_nrm4="ATTR12",u.morph_nrm5="ATTR13",u.morph_nrm6="ATTR14",u.morph_nrm7="ATTR15",h+="#define MORPHING_NRM47\nattribute vec3 morph_nrm4;\nattribute vec3 morph_nrm5;\nattribute vec3 morph_nrm6;\nattribute vec3 morph_nrm7;\n"):(u.morph_pos4="ATTR12",u.morph_pos5="ATTR13",u.morph_pos6="ATTR14",u.morph_pos7="ATTR15",h+="#define MORPHING_POS47\nattribute vec3 morph_pos4;\nattribute vec3 morph_pos5;\nattribute vec3 morph_pos6;\nattribute vec3 morph_pos7;\n"))),e.skin?(u.vertex_boneWeights="BLENDWEIGHT",u.vertex_boneIndices="BLENDINDICES",h+=Z(t,d),h+="#define SKIN\n"):e.useInstancing&&(h+="#define INSTANCING\n"),e.screenSpace&&(h+="#define SCREENSPACE\n"),e.pixelSnap&&(h+="#define PIXELSNAP\n"),h=this._vsAddTransformCode(h,t,d,e),a&&(h+=d.normalVS);var b=h=(h=h+"\n"+d.startVS)+l+"}";if(f=c,c=""+this._addVaryingIfNeeded(h,"vec4","vMainShadowUv"),c+=this._addVaryingIfNeeded(h,"vec4","vVertexColor"),c+=this._addVaryingIfNeeded(h,"vec3","vPositionW"),c+=this._addVaryingIfNeeded(h,"vec3","vNormalV"),c+=this._addVaryingIfNeeded(h,"vec3","vNormalW"),c+=this._addVaryingIfNeeded(h,"vec3","vTangentW"),c+=this._addVaryingIfNeeded(h,"vec3","vBinormalW"),c+=this._addVaryingIfNeeded(h,"vec3","vObjectSpaceUpW"),c+=this._addVaryingIfNeeded(h,"vec2","vUv0"),c+=this._addVaryingIfNeeded(h,"vec2","vUv1"),b=(c+=f)+b,h="",t.webgl2?(h=J(t),d.extensionVS&&(h+=d.extensionVS+"\n"),b=h+d.gles3VS+b):(d.extensionVS&&(h=d.extensionVS+"\n"),b=h+b),e.forceFragmentPrecision&&"highp"!=e.forceFragmentPrecision&&"mediump"!==e.forceFragmentPrecision&&"lowp"!==e.forceFragmentPrecision&&(e.forceFragmentPrecision=null),e.forceFragmentPrecision&&("highp"===e.forceFragmentPrecision&&"highp"!==t.maxPrecision&&(e.forceFragmentPrecision="mediump"),"mediump"===e.forceFragmentPrecision&&"lowp"===t.maxPrecision&&(e.forceFragmentPrecision="lowp")),h="",t.webgl2&&(h+=J(t)),t.extStandardDerivatives&&!t.webgl2&&(h+="#extension GL_OES_standard_derivatives : enable\n\n"),d.extensionPS&&(h+=d.extensionPS+"\n"),t.webgl2&&(h+=d.gles3PS),h+=e.forceFragmentPrecision?"precision "+e.forceFragmentPrecision+" float;\n\n":Q(t),18===e.pass)return h=h+"uniform vec4 uColor;\n"+c,e.alphaTest&&(h=h+"float dAlpha;\n"+this._addMap("opacity","opacityPS",e,d),h+=d.alphaTestPS),h+="void main(void)\n{\n",e.alphaTest&&(h+="   getOpacity();\n   alphaTest(dAlpha);\n"),{attributes:u,vshader:b,fshader:h+"\tgl_FragColor = uColor;\n}\n"};if(2===e.pass)return h=h+"varying float vDepth;\n"+c+d.packDepthPS,e.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",e,d),h+=d.alphaTestPS),h+="void main(void)\n{\n",e.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),h+="\tgl_FragColor = packFloat(vDepth);\n",{attributes:u,vshader:b,fshader:h+="}\n"};if(o)return s=e.pass-3,s-=5*(m=Math.floor(s/5)),t.extStandardDerivatives&&!t.webgl2&&(h+="uniform vec2 polygonOffset;\n"),3===s?h=t.textureFloatHighPrecision?h+"#define VSM_EXPONENT 15.0\n\n":h+"#define VSM_EXPONENT 5.54\n\n":2===s&&(h+="#define VSM_EXPONENT 5.54\n\n"),0!==m&&(h+="uniform vec3 view_position;\n",h+="uniform float light_radius;\n"),h+=c,e.alphaTest&&(h+="float dAlpha;\n",h+=this._addMap("opacity","opacityPS",e,d),h+=d.alphaTestPS),0!==s||t.webgl2&&1!==m?1===s&&(h+="vec2 encodeFloatRG( float v ) {\n",h+="\tvec2 enc = vec2(1.0, 255.0) * v;\n",h+="\tenc = fract(enc);\n",h+="\tenc -= enc.yy * vec2(1.0/255.0, 1.0/255.0);\n",h+="\treturn enc;\n",h+="}\n\n"):h+=d.packDepthPS,h+="void main(void)\n{\n",e.alphaTest&&(h+="   getOpacity();\n",h+="   alphaTest(dAlpha);\n"),h=1===m||(1===s||2===s||3===s)&&0!==m?h+"   float depth = min(distance(view_position, vPositionW) / light_radius, 0.99999);\n":h+"   float depth = gl_FragCoord.z;\n",0!==s||t.webgl2&&1!==m?h=0===s||4===s?h+"   gl_FragColor = vec4(1.0);\n":1===s?h+"   gl_FragColor = vec4(encodeFloatRG(depth), encodeFloatRG(depth*depth));\n":h+d.storeEVSMPS:(t.extStandardDerivatives&&!t.webgl2&&(h+="   float minValue = 2.3374370500153186e-10; //(1.0 / 255.0) / (256.0 * 256.0 * 256.0);\n",h+="   depth += polygonOffset.x * max(abs(dFdx(depth)), abs(dFdy(depth))) + minValue * polygonOffset.y;\n"),h+="   gl_FragColor = packFloat(depth);\n"),{attributes:u,vshader:b,fshader:h+="}\n"};if(e.customFragmentShader)return{attributes:u,vshader:b,fshader:t=h+e.customFragmentShader,tag:1};for(h=this._fsAddBaseCode(h+c,t,d,e),e.detailModes&&(h+=d.detailModesPS),c=h,h="",0<e.clearCoat&&(h+="#define CLEARCOAT\n"),_=0,y=[],g=v=!1,f=0;f<e.lights.length;f++)h+="uniform vec3 light"+f+"_color;\n",0===(m=(l=e.lights[f])._type)?h+="uniform vec3 light"+f+"_direction;\n":(h+="uniform vec3 light"+f+"_position;\n",h+="uniform float light"+f+"_radius;\n",2===m&&(h+="uniform vec3 light"+f+"_direction;\n",h+="uniform float light"+f+"_innerConeAngle;\n",h+="uniform float light"+f+"_outerConeAngle;\n")),l.castShadows&&!e.noShadow&&(h+="uniform mat4 light"+f+"_shadowMatrix;\n",h=0!==m?h+"uniform vec4 light"+f+"_shadowParams;\n":h+"uniform vec3 light"+f+"_shadowParams;\n",h=1===m?h+"uniform samplerCube light"+f+"_shadowMap;\n":l._isPcf&&t.webgl2?h+"uniform sampler2DShadow light"+f+"_shadowMap;\n":h+"uniform sampler2D light"+f+"_shadowMap;\n",_++,y[l._shadowType]=!0,l._isVsm&&(v=!0),l._isPcf&&(t.webgl2||t.extStandardDerivatives)&&2===m&&(g=!0)),l._cookie&&(l._cookie._cubemap?1===m&&(h+="uniform samplerCube light"+f+"_cookie;\n",h+="uniform float light"+f+"_cookieIntensity;\n",!l.castShadows||e.noShadow)&&(h+="uniform mat4 light"+f+"_shadowMatrix;\n"):2===m&&(h+="uniform sampler2D light"+f+"_cookie;\n",h+="uniform float light"+f+"_cookieIntensity;\n",l.castShadows&&!e.noShadow||(h+="uniform mat4 light"+f+"_shadowMatrix;\n"),l._cookieTransform&&(h+="uniform vec4 light"+f+"_cookieMatrix;\n",h+="uniform vec2 light"+f+"_cookieOffset;\n")));h+="\n",o=!e.hasTangents&&t.extStandardDerivatives?d.TBNderivativePS:e.fastTbn?d.TBNfastPS:d.TBNPS,a&&(e.normalMap||e.clearCoatNormalMap)&&(h+=e.packedNormal?d.normalXYPS:d.normalXYZPS,e.hasTangents||(f=this._getUvSourceExpression("normalMapTransform","normalMapUv",e),o=o.replace(/\$UV/g,f)),h+=o),a&&(e.normalMap?(e.normalDetail&&(h+=this._addMap("normalDetail","normalDetailMapPS",e,d)),f=this._getUvSourceExpression("normalMapTransform","normalMapUv",e),h=e.normalizeNormalMap?h+d.normalMapPS.replace(/\$UV/g,f):h+d.normalMapFastPS.replace(/\$UV/g,f)):(h+=d.normalVertexPS,e.enableGGXSpecular&&(h+=d.TBNObjectSpacePS))),h+=Y(e.gamma,d),h+=K(e.toneMap,d),h+=$(e.fog,d),e.useRgbm&&(h+=d.rgbmPS),(s||e.prefilteredCubemap)&&(h+=e.fixSeams?d.fixCubemapSeamsStretchPS:d.fixCubemapSeamsNonePS),a&&(h+=0<e.cubeMapProjection?d.cubeMapProjectBoxPS:d.cubeMapProjectNonePS,h+=e.skyboxIntensity?d.envMultiplyPS:d.envConstPS),e.diffuseDetail&&(h+=this._addMap("diffuseDetail","diffuseDetailMapPS",e,d)),h+=this._addMap("diffuse","diffusePS",e,d),(3!==e.blendType||e.alphaTest||e.alphaToCoverage)&&(h+=this._addMap("opacity","opacityPS",e,d)),h+=this._addMap("emissive","emissivePS",e,d,e.emissiveFormat),e.useSpecular&&(i||n)&&(h=e.specularAntialias&&e.normalMap?e.normalizeNormalMap&&a?h+d.specularAaToksvigPS:h+d.specularAaToksvigFastPS:h+d.specularAaNonePS,f=e.useMetalness?"metalness":"specular",h+=this._addMap(f,f+"PS",e,d),h+=this._addMap("gloss","glossPS",e,d),2===e.fresnelModel&&(h+=d.fresnelSchlickPS)),0<e.clearCoat&&(h+=this._addMap("clearCoat","clearCoatPS",e,d),h+=this._addMap("clearCoatGloss","clearCoatGlossPS",e,d),h+=this._addMap("clearCoatNormal","clearCoatNormalPS",e,d)),e.heightMap&&(e.normalMap||(f=this._getUvSourceExpression("heightMapTransform","heightMapUv",e),e.hasTangents||(o=o.replace(/\$UV/g,f)),h+=o),h+=this._addMap("height","parallaxPS",e,d)),(o=e.aoMap||e.aoVertexColor)&&(h+=this._addMap("ao","aoPS",e,d),e.occludeSpecular&&(h=1===e.occludeSpecular?h+(e.occludeSpecularFloat?d.aoSpecOccSimplePS:d.aoSpecOccConstSimplePS):h+(e.occludeSpecularFloat?d.aoSpecOccPS:d.aoSpecOccConstPS))),f=e.rgbmReflection?"decodeRGBM":e.hdrReflection?"":"gammaCorrectInput",e.sphereMap?h+=f=(f=16<t.fragmentUniformsCount?d.reflectionSpherePS:d.reflectionSphereLowPS).replace(/\$texture2DSAMPLE/g,e.rgbmReflection?"texture2DRGBM":e.hdrReflection?"texture2D":"texture2DSRGB"):s?h=e.prefilteredCubemap?r?h+d.reflectionPrefilteredCubeLodPS.replace(/\$DECODE/g,f):h+d.reflectionPrefilteredCubePS.replace(/\$DECODE/g,f):h+d.reflectionCubePS.replace(/\$textureCubeSAMPLE/g,e.rgbmReflection?"textureCubeRGBM":e.hdrReflection?"textureCube":"textureCubeSRGB"):e.dpAtlas&&(h+=d.reflectionDpAtlasPS.replace(/\$texture2DSAMPLE/g,e.rgbmReflection?"texture2DRGBM":e.hdrReflection?"texture2D":"texture2DSRGB")),(s||e.sphereMap||e.dpAtlas)&&(0<e.clearCoat&&(h+=d.reflectionCCPS),e.refraction&&(h+=d.refractionPS)),0<_&&(y[0]&&(h+=d.shadowStandardPS),y[4]&&(h+=d.shadowStandardGL2PS),v&&(h+=d.shadowVSM_commonPS,y[1]&&(h+=d.shadowVSM8PS),y[2]&&(h+=t.extTextureHalfFloatLinear?d.shadowEVSMPS.replace(/\$/g,"16"):d.shadowEVSMnPS.replace(/\$/g,"16")),y[3]&&(h+=t.extTextureFloatLinear?d.shadowEVSMPS.replace(/\$/g,"32"):d.shadowEVSMnPS.replace(/\$/g,"32"))),t.webgl2||t.extStandardDerivatives||(h+=d.biasConstPS),h+=d.shadowCoordPS+d.shadowCommonPS,g&&(h+=d.shadowCoordPerspZbufferPS),0<=p&&(y[0]&&(h+=d.shadowStandardVSPS),y[4]&&(h+=d.shadowStandardGL2VSPS),v&&(y[1]&&(h+=d.shadowVSMVSPS.replace(/\$VSM/g,"VSM8").replace(/\$/g,"8")),y[2]&&(h+=d.shadowVSMVSPS.replace(/\$VSM/g,"VSM16").replace(/\$/g,"16")),y[3]&&(h+=d.shadowVSMVSPS.replace(/\$VSM/g,"VSM32").replace(/\$/g,"32"))))),e.enableGGXSpecular&&(h+="uniform float material_anisotropy;\n"),i&&(h+=d.lightDiffuseLambertPS),f=!1,e.useSpecular?(i&&(h+=0===e.shadingModel?d.lightSpecularPhongPS:e.enableGGXSpecular?d.lightSpecularAnisoGGXPS:d.lightSpecularBlinnPS),e.sphereMap||s||e.dpAtlas||0<e.fresnelModel?h=0<e.fresnelModel?e.conserveEnergy?h+d.combineDiffuseSpecularPS:h+d.combineDiffuseSpecularNoConservePS:h+d.combineDiffuseSpecularOldPS:e.diffuseMap?h+=d.combineDiffuseSpecularNoReflPS:(h+=d.combineDiffuseSpecularNoReflSeparateAmbientPS,f=!0)):h+=d.combineDiffusePS,0<e.clearCoat&&(h+=d.combineClearCoatPS),m=!0,(e.lightMap||e.lightVertexColor)&&(h+=this._addMap("light",e.dirLightMap?"lightmapDirPS":"lightmapSinglePS",e,d,e.lightMapFormat),m=e.lightMapWithoutAmbient),m&&(l=e.rgbmAmbient?"decodeRGBM":e.hdrAmbient?"":"gammaCorrectInput",h=e.ambientSH?h+d.ambientSHPS:e.prefilteredCubemap?r?h+d.ambientPrefilteredCubeLodPS.replace(/\$DECODE/g,l):h+d.ambientPrefilteredCubePS.replace(/\$DECODE/g,l):h+d.ambientConstantPS),e.ambientTint&&!f&&(h+="uniform vec3 material_ambient;\n"),e.alphaTest&&(h+=d.alphaTestPS),e.msdf&&(h+=d.msdfPS),a&&(h+=d.viewDirPS,e.useSpecular&&(h+=e.enableGGXSpecular?d.reflDirAnisoPS:d.reflDirPS)),g=v=y=_=r=!1,h=this._fsAddStartCode(h,t,d,e),a&&(h=e.twoSidedLighting?h+"   dVertexNormalW = gl_FrontFacing ? vNormalW : -vNormalW;\n":h+"   dVertexNormalW = vNormalW;\n",(e.heightMap||e.normalMap)&&e.hasTangents&&(e.twoSidedLighting?(h+="   dTangentW = gl_FrontFacing ? vTangentW : -vTangentW;\n",h+="   dBinormalW = gl_FrontFacing ? vBinormalW : -vBinormalW;\n"):(h+="   dTangentW = vTangentW;\n",h+="   dBinormalW = vBinormalW;\n"))),l=!1,3!==e.blendType||e.alphaTest||e.alphaToCoverage?e.heightMap&&e.opacityMap?l=!0:(h+="   getOpacity();\n",e.alphaTest&&(h+="   alphaTest(dAlpha);\n")):h+="   dAlpha = 1.0;\n";var x=!1;if(a&&(h+="   getViewDir();\n",(e.heightMap||e.normalMap||e.clearCoatNormalMap||e.enableGGXSpecular)&&(h+="   getTBN();\n"),e.heightMap&&(h+="   getParallax();\n"),l&&(h+="   getOpacity();\n",e.alphaTest&&(h+="   alphaTest(dAlpha);\n")),h+="   getNormal();\n",e.useSpecular&&(e.enableGGXSpecular&&(h+="   getGlossiness();\n",x=!0),h+="   getReflDir();\n")),h+="   getAlbedo();\n",0<e.clearCoat&&(h+="   getClearCoat();\n",h+="   getClearCoatGlossiness();\n",h+="   getClearCoatNormal();\n"),(i&&e.useSpecular||n)&&(h+="   getSpecularity();\n",x||(h+="   getGlossiness();\n"),0<e.fresnelModel&&(h+="   getFresnel();\n")),m&&(h+="   addAmbient();\n"),e.ambientTint&&!f&&(h+="   dDiffuseLight *= material_ambient;\n"),o&&!e.occludeDirect&&(h+="\tapplyAO();\n"),(e.lightMap||e.lightVertexColor)&&(h+="   addLightMap();\n"),i||n){for((s||e.sphereMap||e.dpAtlas)&&(0<e.clearCoat&&(h+="   addReflectionCC();\n"),h+="   addReflection();\n"),e.dirLightMap&&(h+="   addDirLightMap();\n"),f=0;f<e.lights.length;f++){if(n=!1,0===(m=(l=e.lights[f])._type)?(h+="   dLightDirNormW = light"+f+"_direction;\n",h+="   dAtten = 1.0;\n"):(l._cookie&&(2!==m||l._cookie._cubemap?1===m&&l._cookie._cubemap&&(n=g=!0):n=g=!0),h+="   getLightDirPoint(light"+f+"_position);\n",r=!0,n&&(h=2===m?h+"   dAtten3 = getCookie2D"+(l._cookieFalloff?"":"Clip")+(l._cookieTransform?"Xform":"")+"(light"+f+"_cookie, light"+f+"_shadowMatrix, light"+f+"_cookieIntensity"+(l._cookieTransform?", light"+f+"_cookieMatrix, light"+f+"_cookieOffset":"")+")."+l._cookieChannel+";\n":h+"   dAtten3 = getCookieCube(light"+f+"_cookie, light"+f+"_shadowMatrix, light"+f+"_cookieIntensity)."+l._cookieChannel+";\n"),0===l._falloffMode?(h+="   dAtten = getFalloffLinear(light"+f+"_radius);\n",_=!0):(h+="   dAtten = getFalloffInvSquared(light"+f+"_radius);\n",y=!0),h+="   if (dAtten > 0.00001) {\n",2!==m||n&&!l._cookieFalloff||(h+="\t   dAtten *= getSpotEffect(light"+f+"_direction, light"+f+"_innerConeAngle, light"+f+"_outerConeAngle);\n",v=!0)),h+="\t   dAtten *= getLightDiffuse();\n",l.castShadows&&!e.noShadow){if(1===l._shadowType){a="VSM8";var S="0.0"}else 2===l._shadowType?(a="VSM16",S="5.54"):3===l._shadowType?(a="VSM32",S=t.textureFloatHighPrecision?"15.0":"5.54"):a=4===l._shadowType?"PCF5x5":"PCF3x3";null!==a&&(1===m?(i="(light"+f+"_shadowMap, light"+f+"_shadowParams);\n",l._normalOffsetBias&&(h+="\t   normalOffsetPointShadow(light"+f+"_shadowParams);\n"),h+="\t   dAtten *= getShadowPoint"+a+i):(p===f?a+="VS":(i="(light"+f+"_shadowMatrix, light"+f+"_shadowParams);\n",h+=this._nonPointShadowMapProjection(t,e.lights[f],i)),2===m&&(a="Spot"+a),h+="\t   dAtten *= getShadow"+a+"(light"+f+"_shadowMap, light"+f+"_shadowParams"+(l._isVsm?", "+S:"")+");\n"))}h+="\t   dDiffuseLight += dAtten * light"+f+"_color"+(n?" * dAtten3":"")+";\n",0<e.clearCoat&&(h+="\t   ccSpecularLight += getLightSpecularCC() * dAtten * light"+f+"_color"+(n?" * dAtten3":"")+";\n"),e.useSpecular&&(h+="\t   dAtten *= getLightSpecular();\n",h+="\t   dSpecularLight += dAtten * light"+f+"_color"+(n?" * dAtten3":"")+";\n"),0!==m&&(h+="   }\n"),h+="\n"}(s||e.sphereMap||e.dpAtlas)&&e.refraction&&(h+="   addRefraction();\n")}return h+="\n",o&&(e.occludeDirect&&(h+="\tapplyAO();\n"),e.occludeSpecular&&(h+="\toccludeSpecular();\n")),h+=d.endPS,h=2===e.blendType||6===e.blendType||e.alphaToCoverage?h+d.outputAlphaPS:4===e.blendType?h+d.outputAlphaPremulPS:h+d.outputAlphaOpaquePS,e.msdf&&(h+="   gl_FragColor = applyMsdf(gl_FragColor);\n"),h+="\n",h+="}\n",r&&(h=d.lightDirPointPS+h),_&&(h=d.falloffLinearPS+h),y&&(h=d.falloffInvSquaredPS+h),v&&(h=d.spotPS+h),g&&(h=d.cookiePS+h),t="",h.includes("dReflection")&&(t+="vec4 dReflection;\n"),h.includes("dTBN")&&(t+="mat3 dTBN;\n"),h.includes("dAlbedo")&&(t+="vec3 dAlbedo;\n"),h.includes("dEmission")&&(t+="vec3 dEmission;\n"),h.includes("dNormalW")&&(t+="vec3 dNormalW;\n"),h.includes("dVertexNormalW")&&(t+="vec3 dVertexNormalW;\n"),h.includes("dTangentW")&&(t+="vec3 dTangentW;\n"),h.includes("dBinormalW")&&(t+="vec3 dBinormalW;\n"),h.includes("dViewDirW")&&(t+="vec3 dViewDirW;\n"),h.includes("dReflDirW")&&(t+="vec3 dReflDirW;\n"),h.includes("dDiffuseLight")&&(t+="vec3 dDiffuseLight;\n"),h.includes("dSpecularLight")&&(t+="vec3 dSpecularLight;\n"),h.includes("dLightDirNormW")&&(t+="vec3 dLightDirNormW;\n"),h.includes("dLightDirW")&&(t+="vec3 dLightDirW;\n"),h.includes("dLightPosW")&&(t+="vec3 dLightPosW;\n"),h.includes("dShadowCoord")&&(t+="vec3 dShadowCoord;\n"),h.includes("dNormalMap")&&(t+="vec3 dNormalMap;\n"),h.includes("dSpecularity")&&(t+="vec3 dSpecularity;\n"),h.includes("dUvOffset")&&(t+="vec2 dUvOffset;\n"),h.includes("dGlossiness")&&(t+="float dGlossiness;\n"),h.includes("dAlpha")&&(t+="float dAlpha;\n"),h.includes("dAtten")&&(t+="float dAtten;\n"),h.includes("dAtten3")&&(t+="vec3 dAtten3;\n"),h.includes("dAo")&&(t+="float dAo;\n"),h.includes("dMsdf")&&(t+="vec4 dMsdf;\n"),h.includes("ccReflection")&&(t+="vec4 ccReflection;\n"),h.includes("ccNormalW")&&(t+="vec3 ccNormalW;\n"),h.includes("ccReflDirW")&&(t+="vec3 ccReflDirW;\n"),h.includes("ccSpecularLight")&&(t+="vec3 ccSpecularLight;\n"),h.includes("ccSpecularity")&&(t+="float ccSpecularity;\n"),h.includes("ccGlossiness")&&(t+="float ccGlossiness;\n"),{attributes:u,vshader:b,fshader:t=h=c+t+h,tag:1}}},Ha={begin:et,dummyFragmentCode:tt,end:function(){return"}\n"},fogCode:$,gammaCode:Y,precisionCode:Q,skinCode:Z,tonemapCode:K,versionCode:J,basic:{generateKey:function(t){var e="basic";return t.fog&&(e+="_fog"),t.alphaTest&&(e+="_atst"),t.vertexColors&&(e+="_vcol"),t.diffuseMap&&(e+="_diff"),e+"_"+t.pass},createShaderDefinition:function(t,e){var i={vertex_position:"POSITION"};e.skin&&(i.vertex_boneWeights="BLENDWEIGHT",i.vertex_boneIndices="BLENDINDICES"),e.vertexColors&&(i.vertex_color="COLOR"),e.diffuseMap&&(i.vertex_texCoord0="TEXCOORD0");var s=""+Ra.transformDeclVS;e.skin?(s+=Z(t),s+=Ra.transformSkinnedVS):s+=Ra.transformVS,e.vertexColors&&(s+="attribute vec4 vertex_color;\nvarying vec4 vColor;\n"),e.diffuseMap&&(s+="attribute vec2 vertex_texCoord0;\nvarying vec2 vUv0;\n"),2===e.pass&&(s+="varying float vDepth;\n#ifndef VIEWMATRIX\n#define VIEWMATRIX\nuniform mat4 matrix_view;\n#endif\n#ifndef CAMERAPLANES\n#define CAMERAPLANES\nuniform vec4 camera_params;\n\n#endif\n"),s+="void main(void)\n{\n",s+="   gl_Position = getPosition();\n",2===e.pass&&(s+="\tvDepth = -(matrix_view * vec4(getWorldPosition(),1.0)).z * camera_params.x;\n"),e.vertexColors&&(s+="\tvColor = vertex_color;\n"),e.diffuseMap&&(s+="\tvUv0 = vertex_texCoord0;\n");var n=s+"}\n";return s=Q(t),s=e.vertexColors?s+"varying vec4 vColor;\n":s+"uniform vec4 uColor;\n",e.diffuseMap&&(s+="varying vec2 vUv0;\nuniform sampler2D texture_diffuseMap;\n"),e.fog&&(s+=$(e.fog)),e.alphatest&&(s+=Ra.alphaTestPS),2===e.pass&&(s=s+"varying float vDepth;\n"+Ra.packDepthPS),s+="void main(void)\n{\n",s=e.vertexColors?s+"\tgl_FragColor = vColor;\n":s+"\tgl_FragColor = uColor;\n",e.diffuseMap&&(s+="\tgl_FragColor *= texture2D(texture_diffuseMap, vUv0);\n"),e.alphatest&&(s+="   alphaTest(gl_FragColor.a);\n"),18!==e.pass&&(2===e.pass?s+="\tgl_FragColor = packFloat(vDepth);\n":e.fog&&(s+="   glFragColor.rgb = addFog(gl_FragColor.rgb);\n")),{attributes:i,vshader:n,fshader:s+"}\n"}}},particle:{generateKey:function(t){var e,i="particle";for(e in t)t.hasOwnProperty(e)&&(i+=t[e]);return i},_animTex:function(t){return(t=""+(t.animTexLoop?Ra.particleAnimFrameLoopVS:Ra.particleAnimFrameClampVS))+Ra.particleAnimTexVS},createShaderDefinition:function(t,e){var i="",s=Q(t)+"\n";return t.webgl2&&(i+="#define GL2\n",s+="#define GL2\n"),i+="#define VERTEXSHADER\n",e.mesh&&(i+="#define USE_MESH\n"),e.localSpace&&(i+="#define LOCAL_SPACE\n"),e.screenSpace&&(i+="#define SCREEN_SPACE\n"),e.animTex&&(i+="\nuniform vec2 animTexTilesParams;\n"),e.animTex&&(i+="\nuniform vec4 animTexParams;\n"),e.animTex&&(i+="\nuniform vec2 animTexIndexParams;\n"),2==e.normal&&(i+="\nvarying mat3 ParticleMat;\n"),1==e.normal&&(i+="\nvarying vec3 Normal;\n"),e.soft&&(i+="\nvarying float vDepth;\n"),t=e.customFace?Ra.particle_customFaceVS:Ra.particle_billboardVS,e.useCpu?(0<e.soft&&(i+=Ra.screenDepthPS),i+=Ra.particle_cpuVS,e.localSpace&&(i+=Ra.particle_localShiftVS),e.animTex&&(i+=this._animTex(e)),e.alignToMotion&&(i+=Ra.particle_pointAlongVS),i+=e.mesh?Ra.particle_meshVS:t,1==e.normal&&(i+=Ra.particle_normalVS),2==e.normal&&(i+=Ra.particle_TBNVS),0<e.stretch&&(i+=Ra.particle_stretchVS),i+=Ra.particle_cpu_endVS):(i+=Ra.particle_initVS,i+=e.pack8?Ra.particleInputRgba8PS:Ra.particleInputFloatPS,0<e.soft&&(i+=Ra.screenDepthPS),i+=Ra.particleVS,e.localSpace&&(i+=Ra.particle_localShiftVS),e.animTex&&(i+=this._animTex(e)),e.wrap&&(i+=Ra.particle_wrapVS),e.alignToMotion&&(i+=Ra.particle_pointAlongVS),i+=e.mesh?Ra.particle_meshVS:t,1==e.normal&&(i+=Ra.particle_normalVS),2==e.normal&&(i+=Ra.particle_TBNVS),0<e.stretch&&(i+=Ra.particle_stretchVS),i+=Ra.particle_endVS),0<e.soft&&(i+=Ra.particle_softVS),i+="}\n",0<e.normal&&(1==e.normal?s+="\nvarying vec3 Normal;\n":2==e.normal&&(s+="\nvarying mat3 ParticleMat;\n"),s+="\nuniform vec3 lightCube[6];\n"),e.soft&&(s+="\nvarying float vDepth;\n"),0===e.normal&&"none"===e.fog&&(e.srgb=!1),s+=Y(e.gamma),s+=K(e.toneMap),s="linear"===e.fog?s+Ra.fogLinearPS:"exp"===e.fog?s+Ra.fogExpPS:"exp2"===e.fog?s+Ra.fogExp2PS:s+Ra.fogNonePS,2==e.normal&&(s+="\nuniform sampler2D normalMap;\n"),0<e.soft&&(s+=Ra.screenDepthPS),s+=Ra.particlePS,0<e.soft&&(s+=Ra.particle_softPS),1==e.normal&&(s+="\nvec3 normal = Normal;\n"),2==e.normal&&(s+=Ra.particle_normalMapPS),0<e.normal&&(s+=e.halflambert?Ra.particle_halflambertPS:Ra.particle_lambertPS),0<e.normal&&(s+=Ra.particle_lightingPS),2==e.blend?s+=Ra.particle_blendNormalPS:1==e.blend?s+=Ra.particle_blendAddPS:5==e.blend&&(s+=Ra.particle_blendMultiplyPS),s+=Ra.particle_endPS,{attributes:it(i),vshader:i,fshader:s}}},skybox:{generateKey:function(t){return"skybox"+t.rgbm+" "+t.hdr+" "+t.fixSeams+t.toneMapping+t.gamma+t.useIntensity+t.mip},createShaderDefinition:function(t,e){return t=Q(t),t+=e.mip?Ra.fixCubemapSeamsStretchPS:Ra.fixCubemapSeamsNonePS,t+=e.useIntensity?Ra.envMultiplyPS:Ra.envConstPS,t+=Y(e.gamma),t+=K(e.toneMapping),t+=Ra.rgbmPS,t+=Ra.skyboxHDRPS.replace(/\$textureCubeSAMPLE/g,e.rgbm?"textureCubeRGBM":e.hdr?"textureCube":"textureCubeSRGB").replace(/\$FIXCONST/g,1-1/[128,64,32,16,8,4,2][e.mip]+""),{attributes:{aPosition:"POSITION"},vshader:Ra.skyboxVS,fshader:t}}},standard:Ga};Object.defineProperties(nt.prototype,{minFilter:{get:function(){return this._minFilter},set:function(t){this._minFilter!==t&&(this._minFilter=t,this._parameterFlags|=1)}},magFilter:{get:function(){return this._magFilter},set:function(t){this._magFilter!==t&&(this._magFilter=t,this._parameterFlags|=2)}},addressU:{get:function(){return this._addressU},set:function(t){this._addressU!==t&&(this._addressU=t,this._parameterFlags|=4)}},addressV:{get:function(){return this._addressV},set:function(t){this._addressV!==t&&(this._addressV=t,this._parameterFlags|=8)}},addressW:{get:function(){return this._addressW},set:function(t){this.device.webgl2&&this._volume&&t!==this._addressW&&(this._addressW=t,this._parameterFlags|=16)}},compareOnRead:{get:function(){return this._compareOnRead},set:function(t){this._compareOnRead!==t&&(this._compareOnRead=t,this._parameterFlags|=32)}},compareFunc:{get:function(){return this._compareFunc},set:function(t){this._compareFunc!==t&&(this._compareFunc=t,this._parameterFlags|=64)}},anisotropy:{get:function(){return this._anisotropy},set:function(t){this._anisotropy!==t&&(this._anisotropy=t,this._parameterFlags|=128)}},autoMipmap:{get:function(){return this._mipmaps},set:function(t){this._mipmaps=t}},mipmaps:{get:function(){return this._mipmaps},set:function(t){this._mipmaps!==t&&(this._mipmaps=t,this._minFilterDirty=!0,t&&(this._needsMipmapsUpload=!0))}},width:{get:function(){return this._width}},height:{get:function(){return this._height}},depth:{get:function(){return this._depth}},format:{get:function(){return this._format}},cubemap:{get:function(){return this._cubemap}},gpuSize:{get:function(){return nt.calcGpuSize(this._width,this._height,this._depth,this._format,this.pot&&this._mipmaps&&!(this._compressed&&1===this._levels.length),this._cubemap)}},volume:{get:function(){return this._volume}},flipY:{get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this._needsUpload=!0)}},premultiplyAlpha:{get:function(){return this._premultiplyAlpha},set:function(t){this._premultiplyAlpha!==t&&(this._premultiplyAlpha=t,this._needsUpload=!0)}},pot:{get:function(){return oa.powerOfTwo(this._width)&&oa.powerOfTwo(this._height)}}});var Wa=null,Xa=null;Object.assign(nt,{calcGpuSize:function(t,e,i,s,n,r){Wa||(Wa=[1,1,2,2,2,2,4,4,,,,8,8,16,16,4,4,4,4,4,4]),Xa||((Xa=[])[21]=8,Xa[22]=8,Xa[24]=8,Xa[25]=8,Xa[26]=8,Xa[27]=8,Xa[8]=8,Xa[29]=8,Xa[23]=16,Xa[9]=16,Xa[10]=16,Xa[28]=16,Xa[30]=16);for(var a=Wa.hasOwnProperty(s)?Wa[s]:0,o=Xa.hasOwnProperty(s)?Xa[s]:0,h=0;;){if(0<a)h+=t*e*i*a;else{var l=Math.floor((t+3)/4),c=Math.floor((e+3)/4),d=Math.floor((i+3)/4);24!==s&&25!==s||(l=Math.floor(l/2,1)),h+=l*c*d*o}if(!n||1===t&&1===e&&1===i)break;t=Math.max(Math.floor(t/2),1),e=Math.max(Math.floor(e/2),1),i=Math.max(Math.floor(i/2),1)}return h*(r?6:1)}}),Object.assign(nt.prototype,{destroy:function(){this.device&&this.device.destroyTexture(this),this._levels=this.device=null},dirtyAll:function(){this._levelsUpdated=this._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0],this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps,this._mipmapsUploaded=!1,this._parameterFlags=255},lock:function(t){if(void 0===(t=t||{level:0,face:0,mode:2}).level&&(t.level=0),void 0===t.face&&(t.face=0),void 0===t.mode&&(t.mode=2),this._lockedLevel=t.level,null===this._levels[t.level])switch(this._format){case 0:case 1:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth);break;case 2:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*2);break;case 3:case 4:case 5:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth);break;case 6:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*3);break;case 7:this._levels[t.level]=new Uint8Array(this._width*this._height*this._depth*4);break;case 8:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*8*this._depth);break;case 9:case 10:this._levels[t.level]=new Uint8Array(Math.floor((this._width+3)/4)*Math.floor((this._height+3)/4)*16*this._depth);break;case 11:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*3);break;case 13:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*3);break;case 12:this._levels[t.level]=new Uint16Array(this._width*this._height*this._depth*4);break;case 14:this._levels[t.level]=new Float32Array(this._width*this._height*this._depth*4)}return this._levels[t.level]},setSource:function(t,e){var i,s=!1;if(e=e||0,this._cubemap){if(t[0]){var n=t[0].width||0,r=t[0].height||0;for(i=0;6>i;i++){var a=t[i];if(!a||a.width!==n||a.height!==r||!this.device._isBrowserInterface(a)){s=!0;break}}}else s=!0;if(!s)for(i=0;6>i;i++)this._levels[e][i]!==t[i]&&(this._levelsUpdated[e][i]=!0)}else this.device._isBrowserInterface(t)||(s=!0),s||(t!==this._levels[e]&&(this._levelsUpdated[e]=!0),n=t.width,r=t.height);if(s)if(this._height=this._width=4,this._cubemap)for(i=0;6>i;i++)this._levels[e][i]=null,this._levelsUpdated[e][i]=!0;else this._levels[e]=null,this._levelsUpdated[e]=!0;else 0===e&&(this._width=n,this._height=r),this._levels[e]=t;this._invalid===s&&s||(this._invalid=s,this.upload())},getSource:function(t){return this._levels[t||0]},unlock:function(){this.upload(),this._lockedLevel=-1},upload:function(){this._needsUpload=!0,this._needsMipmapsUpload=this._mipmaps},getDds:function(){7!==this.format&&console.error("This format is not implemented yet");for(var t,e,i=128,s=0;this._levels[s];){if(this.cubemap)for(e=0;6>e;e++){if(!this._levels[s][e])return void console.error("No level data for mip "+s+", face "+e);if(!(t=this._levels[s][e].length))return void console.error("No byte array for mip "+s+", face "+e);i+=t}else{if(!(t=this._levels[s].length))return void console.error("No byte array for mip "+s);i+=t}i+=this._levels[s].length,s++}i=new ArrayBuffer(i),e=new Uint32Array(i,0,32),s=528391,1<this._levels.length&&(s|=131072),t=4096,1<this._levels.length&&(t|=4194304),(1<this._levels.length||this.cubemap)&&(t|=8);var n=this.cubemap?65024:0;for(e[0]=542327876,e[1]=124,e[2]=s,e[3]=this.height,e[4]=this.width,e[5]=this.width*this.height*4,e[6]=0,e[7]=this._levels.length,s=0;11>s;s++)e[8+s]=0;if(e[19]=32,e[20]=65,e[21]=0,e[22]=32,e[23]=16711680,e[24]=65280,e[25]=255,e[26]=4278190080,e[27]=t,e[28]=n,e[29]=0,e[30]=0,e[31]=0,n=128,this.cubemap)for(e=0;6>e;e++)for(s=0;s<this._levels.length;s++){var r=this._levels[s][e],a=new Uint8Array(i,n,r.length);for(t=0;t<r.length;t++)a[t]=r[t];n+=r.length}else for(s=0;s<this._levels.length;s++){for(r=this._levels[s],a=new Uint8Array(i,n,r.length),t=0;t<r.length;t++)a[t]=r[t];n+=r.length}return i}}),Object.assign(rt.prototype,{destroy:function(){var t=this.device,e=t.buffers.indexOf(this);-1!==e&&t.buffers.splice(e,1),this.bufferId&&(this.device.gl.deleteBuffer(this.bufferId),this.device._vram.ib-=this.storage.byteLength,this.bufferId=null,this.device.indexBuffer===this&&(this.device.indexBuffer=null))},getFormat:function(){return this.format},getNumIndices:function(){return this.numIndices},lock:function(){return this.storage},unlock:function(){var t=this.device.gl;switch(this.bufferId||(this.bufferId=t.createBuffer()),this.usage){case 0:var e=t.STATIC_DRAW;break;case 1:e=t.DYNAMIC_DRAW;break;case 2:e=t.STREAM_DRAW;break;case 3:e=this.device.webgl2?t.DYNAMIC_COPY:t.STATIC_DRAW}t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.bufferId),t.bufferData(t.ELEMENT_ARRAY_BUFFER,this.storage,e)},setData:function(t){return t.byteLength===this.numBytes&&(this.storage=t,this.unlock(),!0)},_lockTypedArray:function(){var t=this.lock();return 2===this.format?new Uint32Array(t):1===this.format?new Uint16Array(t):new Uint8Array(t)},writeData:function(t,e){var i=this._lockTypedArray();if(t.length>e)if(ArrayBuffer.isView(t))t=t.subarray(0,e),i.set(t);else{var s;for(s=0;s<e;s++)i[s]=t[s]}else i.set(t);this.unlock()},readData:function(t){var e,i=this._lockTypedArray(),s=this.numIndices;if(ArrayBuffer.isView(t))t.set(i);else for(t.length=0,e=0;e<s;e++)t[e]=i[e];return s}});var qa=0;Object.assign(at.prototype,{initDefaults:function(){this.recreate=!1,this.indexCount=this.vertexCount=this.maxIndices=this.maxVertices=this.indicesUsage=this.verticesUsage=0,this.indexStreamUpdated=this.vertexStreamsUpdated=!1,this.vertexStreamDictionary={},this.indices=null},_validateVertexCount:function(t,e){},_changeVertexCount:function(t,e){this.vertexCount?this._validateVertexCount(t,e):this.vertexCount=t}}),Object.defineProperties(at,{DEFAULT_COMPONENTS_POSITION:{value:3},DEFAULT_COMPONENTS_NORMAL:{value:3},DEFAULT_COMPONENTS_UV:{value:2},DEFAULT_COMPONENTS_COLORS:{value:4}}),Object.defineProperties(ht.prototype,{aabb:{get:function(){return this._aabb},set:function(t){this._aabb=t}},refCount:{get:function(){return this._refCount}}}),Object.assign(ht.prototype,{incReference:function(){this._refCount++},decReference:function(){this._refCount--},destroy:function(){var t,e;for(this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),t=0;t<this.indexBuffer.length;t++)(e=this.indexBuffer[t])&&e.destroy();this.indexBuffer.length=0,this._geometryData=null},_initBoneAabbs:function(t){this.boneAabb=[],this.boneUsed=[];var e,i,s,n,r,a=this.vertexBuffer.numVertices,o=[],h=[],l=this.boneUsed,c=this.skin.boneNames.length;for(e=0;e<c;e++)o[e]=new v(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),h[e]=new v(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);var d=new W(this.vertexBuffer),u=d.element.POSITION,p=d.element.BLENDWEIGHT,f=d.element.BLENDINDICES;for(e=0;e<a;e++){for(i=0;4>i;i++){var m=p.array[p.index+i];if(0<m){var _=f.array[f.index+i];l[_]=!0;var g=u.array[u.index],y=u.array[u.index+1],b=u.array[u.index+2];if(m=h[_],(_=o[_]).x>g&&(_.x=g),_.y>y&&(_.y=y),_.z>b&&(_.z=b),m.x<g&&(m.x=g),m.y<y&&(m.y=y),m.z<b&&(m.z=b),t){g=s=g,y=n=y;var x=r=b;for(b=0;b<t.length;b++){var S=t[b],w=S.deltaPositions[3*e],M=S.deltaPositions[3*e+1];0>w?g+=w:s+=w,0>M?y+=M:n+=M,0>(S=S.deltaPositions[3*e+2])?x+=S:r+=S}_.x>g&&(_.x=g),_.y>y&&(_.y=y),_.z>x&&(_.z=x),m.x<s&&(m.x=s),m.y<n&&(m.y=n),m.z<r&&(m.z=r)}}}d.next()}for(e=0;e<c;e++)(t=new T).setMinMax(o[e],h[e]),this.boneAabb.push(t)},_initGeometryData:function(){this._geometryData||(this._geometryData=new at,this.vertexBuffer&&(this._geometryData.vertexCount=this.vertexBuffer.numVertices,this._geometryData.maxVertices=this.vertexBuffer.numVertices),0<this.indexBuffer.length&&this.indexBuffer[0]&&(this._geometryData.indexCount=this.indexBuffer[0].numIndices,this._geometryData.maxIndices=this.indexBuffer[0].numIndices))},clear:function(t,e,i,s){this._initGeometryData(),this._geometryData.initDefaults(),this._geometryData.recreate=!0,this._geometryData.maxVertices=i||0,this._geometryData.maxIndices=s||0,this._geometryData.verticesUsage=t?0:1,this._geometryData.indicesUsage=e?0:1},setVertexStream:function(t,e,i,s,n,r){this._initGeometryData(),this._geometryData._changeVertexCount(s||e.length/i,t),this._geometryData.vertexStreamsUpdated=!0,this._geometryData.vertexStreamDictionary[t]=new ot(e,i,n||6,r||!1)},getVertexStream:function(t,e){var i=0,s=!1;if(this._geometryData){var n=this._geometryData.vertexStreamDictionary[t];n&&(s=!0,i=this._geometryData.vertexCount,ArrayBuffer.isView(e)?e.set(n.data):(e.length=0,e.push(n.data)))}return s||this.vertexBuffer&&(i=new W(this.vertexBuffer).readData(t,e)),i},setPositions:function(t,e,i){this.setVertexStream("POSITION",t,e||at.DEFAULT_COMPONENTS_POSITION,i,6,!1)},setNormals:function(t,e,i){this.setVertexStream("NORMAL",t,e||at.DEFAULT_COMPONENTS_NORMAL,i,6,!1)},setUvs:function(t,e,i,s){this.setVertexStream("TEXCOORD"+t,e,i||at.DEFAULT_COMPONENTS_UV,s,6,!1)},setColors:function(t,e,i){this.setVertexStream("COLOR",t,e||at.DEFAULT_COMPONENTS_COLORS,i,6,!1)},setColors32:function(t,e){this.setVertexStream("COLOR",t,at.DEFAULT_COMPONENTS_COLORS,e,1,!0)},setIndices:function(t,e){this._initGeometryData(),this._geometryData.indexStreamUpdated=!0,this._geometryData.indices=t,this._geometryData.indexCount=e||t.length},getPositions:function(t){return this.getVertexStream("POSITION",t)},getNormals:function(t){return this.getVertexStream("NORMAL",t)},getUvs:function(t,e){return this.getVertexStream("TEXCOORD"+t,e)},getColors:function(t){return this.getVertexStream("COLOR",t)},getIndices:function(t){var e=0;if(this._geometryData&&this._geometryData.indices){var i=this._geometryData.indices;e=this._geometryData.indexCount,ArrayBuffer.isView(t)?t.set(i):(t.length=0,t.push(i))}else 0<this.indexBuffer.length&&this.indexBuffer[0]&&(e=this.indexBuffer[0].readData(t));return e},update:function(t,e){this._geometryData&&((e||void 0===e)&&(e=this._geometryData.vertexStreamDictionary.POSITION)&&3==e.componentCount&&this._aabb.compute(e.data,this._geometryData.vertexCount),e=this._geometryData.recreate,this._geometryData.vertexCount>this._geometryData.maxVertices&&(e=!0,this._geometryData.maxVertices=this._geometryData.vertexCount),e&&this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=null),e=this._geometryData.recreate,this._geometryData.indexCount>this._geometryData.maxIndices&&(e=!0,this._geometryData.maxIndices=this._geometryData.indexCount),e&&0<this.indexBuffer.length&&this.indexBuffer[0]&&(this.indexBuffer[0].destroy(),this.indexBuffer[0]=null),this._geometryData.vertexStreamsUpdated&&this._updateVertexBuffer(),this._geometryData.indexStreamUpdated&&this._updateIndexBuffer(),this.primitive[0].type=void 0===t?4:t,0<this.indexBuffer.length&&this.indexBuffer[0]?this._geometryData.indexStreamUpdated&&(this.primitive[0].count=this._geometryData.indexCount,this.primitive[0].indexed=!0):this._geometryData.vertexStreamsUpdated&&(this.primitive[0].count=this._geometryData.vertexCount,this.primitive[0].indexed=!1),this._geometryData.vertexCount=0,this._geometryData.indexCount=0,this._geometryData.vertexStreamsUpdated=!1,this._geometryData.indexStreamUpdated=!1,this._geometryData.recreate=!1)},_buildVertexFormat:function(t){var e,i=[];for(e in this._geometryData.vertexStreamDictionary){var s=this._geometryData.vertexStreamDictionary[e];i.push({semantic:e,components:s.componentCount,type:s.dataType,normalize:s.dataTypeNormalize})}return new O(this.device,i,t)},_updateVertexBuffer:function(){if(!this.vertexBuffer){var t=this._geometryData.maxVertices,e=this._buildVertexFormat(t);this.vertexBuffer=new C(this.device,e,t,this._geometryData.verticesUsage)}for(var i in t=new W(this.vertexBuffer),e=this._geometryData.vertexCount,this._geometryData.vertexStreamDictionary)t.writeData(i,this._geometryData.vertexStreamDictionary[i].data,e),delete this._geometryData.vertexStreamDictionary[i];t.end()},_updateIndexBuffer:function(){(0>=this.indexBuffer.length||!this.indexBuffer[0])&&(this.indexBuffer[0]=new rt(this.device,65535<this._geometryData.maxVertices?2:1,this._geometryData.maxIndices,this._geometryData.indicesUsage));var t=this._geometryData.indices;t&&(this.indexBuffer[0].writeData(t,this._geometryData.indexCount),this._geometryData.indices=null)},generateWireframe:function(){var t=function(t){switch(t.format){case 0:return new Uint8Array(t.storage);case 1:return new Uint16Array(t.storage);case 2:return new Uint32Array(t.storage);default:return null}},e=[];if(0<this.indexBuffer.length&&this.indexBuffer[0]){for(var i=[[0,1],[1,2],[2,0]],s=this.primitive[0].base,n=this.primitive[0].count,r=this.indexBuffer[0],a=t(r),o={},h=s;h<s+n;h+=3)for(var l=0;3>l;l++){var c=a[h+i[l][0]],d=a[h+i[l][1]],u=c>d?d<<16|c:c<<16|d;void 0===o[u]&&(o[u]=0,e.push(c,d))}i=r.format}else{for(i=0;i<this.vertexBuffer.numVertices;i+=3)e.push(i,i+1,i+1,i+2,i+2,i);i=65535<e.length?2:1}t(i=new rt(this.vertexBuffer.device,i,e.length)).set(e),i.unlock(),this.primitive[1]={type:1,base:0,count:e.length,indexed:!0},this.indexBuffer[1]=i}});var Ya=new T,Ka=new T,$a=new w;Object.defineProperty(lt.prototype,"mesh",{get:function(){return this._mesh},set:function(t){this._mesh&&this._mesh.decReference(),(this._mesh=t)&&t.incReference()}}),Object.defineProperty(lt.prototype,"aabb",{get:function(){var t;if(!this._updateAabb)return this._aabb;if(this._updateAabbFunc)return this._updateAabbFunc(this._aabb);if(this.skinInstance){this.mesh.boneAabb||this.mesh._initBoneAabbs(this._morphInstance?this._morphInstance.morph._targets:null);var e=this.mesh.boneUsed,i=this.node.getWorldTransform(),s=!0;for(t=0;t<this.mesh.boneAabb.length;t++)e[t]&&(Ka.setFromTransformedAabb(this.mesh.boneAabb[t],this.skinInstance.matrices[t]),s?(s=!1,Ya.center.copy(Ka.center),Ya.halfExtents.copy(Ka.halfExtents)):Ya.add(Ka));this._aabb.setFromTransformedAabb(Ya,i)}else this.node._aabbVer!==this._aabbVer&&(this.mesh?(Ya.center.copy(this.mesh.aabb.center),Ya.halfExtents.copy(this.mesh.aabb.halfExtents)):(Ya.center.set(0,0,0),Ya.halfExtents.set(0,0,0)),this.mesh&&this.mesh.morph&&Ya._expand(this.mesh.morph.aabb.getMin(),this.mesh.morph.aabb.getMax()),this._aabb.setFromTransformedAabb(Ya,this.node.getWorldTransform()),this._aabbVer=this.node._aabbVer);return this._aabb},set:function(t){this._aabb=t}}),Object.defineProperty(lt.prototype,"material",{get:function(){return this._material},set:function(t){var e;for(e=0;e<this._shader.length;e++)this._shader[e]=null;if(this._material){var i=this._material.meshInstances;-1!==(e=i.indexOf(this))&&i.splice(e,1)}e=this._material,(this._material=t)&&(this._material.meshInstances.push(this),this.updateKey(),(e&&3!==e.blendType)!==(3!==this._material.blendType)&&(!(t=this._material._scene)&&e&&e._scene&&(t=e._scene),t?t.layers._dirtyBlend=!0:this._material._dirtyBlend=!0))}}),Object.defineProperty(lt.prototype,"layer",{get:function(){return this._layer},set:function(t){this._layer=t,this.updateKey()}}),Object.defineProperty(lt.prototype,"calculateSortDistance",{get:function(){return this._calculateSortDistance},set:function(t){this._calculateSortDistance=t}}),Object.defineProperty(lt.prototype,"receiveShadow",{get:function(){return this._receiveShadow},set:function(t){this._shaderDefs=(this._receiveShadow=t)?-2&this._shaderDefs:1|this._shaderDefs,this._shader[0]=null,this._shader[1]=null}}),Object.defineProperty(lt.prototype,"skinInstance",{get:function(){return this._skinInstance},set:function(t){for(this._shaderDefs=(this._skinInstance=t)?2|this._shaderDefs:-3&this._shaderDefs,t=0;t<this._shader.length;t++)this._shader[t]=null}}),Object.defineProperty(lt.prototype,"morphInstance",{get:function(){return this._morphInstance},set:function(t){for((this._morphInstance=t)&&(this._morphInstance.meshInstance=this),this._shaderDefs=t&&t.morph.useTextureMorph?4096|this._shaderDefs:-4097&this._shaderDefs,this._shaderDefs=t&&t.morph.morphPositions?1024|this._shaderDefs:-1025&this._shaderDefs,this._shaderDefs=t&&t.morph.morphNormals?2048|this._shaderDefs:-2049&this._shaderDefs,t=0;t<this._shader.length;t++)this._shader[t]=null}}),Object.defineProperty(lt.prototype,"screenSpace",{get:function(){return this._screenSpace},set:function(t){this._shaderDefs=(this._screenSpace=t)?256|this._shaderDefs:-257&this._shaderDefs,this._shader[0]=null}}),Object.defineProperty(lt.prototype,"key",{get:function(){return this._key[0]},set:function(t){this._key[0]=t}}),Object.defineProperty(lt.prototype,"mask",{get:function(){return this._shaderDefs>>16},set:function(t){this._shaderDefs=65535&this._shaderDefs|t<<16,this._shader[0]=null,this._shader[1]=null}}),Object.defineProperty(lt.prototype,"instancingCount",{get:function(){return this.instancingData?this.instancingData.count:0},set:function(t){this.instancingData&&(this.instancingData.count=t)}}),Object.assign(lt.prototype,{syncAabb:function(){},_isVisible:function(t){if(this.visible){if(this.isVisibleFunc)return this.isVisibleFunc(t);var e=this.aabb.center;return this._aabb._radiusVer!==this._aabbVer&&(this._aabb._radius=this._aabb.halfExtents.length(),this._aabb._radiusVer=this._aabbVer),$a.radius=this._aabb._radius,$a.center=e,t.frustum.containsSphere($a)}return!1},updateKey:function(){var t=this.material;this._key[0]=(15&this.layer)<<27|(3===(t.alphaToCoverage||t.alphaTest?2:t.blendType)?1:0)<<26|0|(33554431&t.id)<<0},setInstancing:function(t){t?(this.instancingData=new dt(t.numVertices),this.instancingData.vertexBuffer=t,t.instancing=!0,this.cull=!1):(this.instancingData=null,this.cull=!0)},clearParameters:function(){this.parameters={}},getParameters:function(){return this.parameters},getParameter:function(t){return this.parameters[t]},setParameter:function(t,e,i){if(void 0===i&&(i=-524285),void 0===e&&"object"==typeof t){if((e=t).length){for(t=0;t<e.length;t++)this.setParameter(e[t]);return}t=e.name,e=e.value}var s=this.parameters[t];s?(s.data=e,s.passFlags=i):this.parameters[t]={scopeId:null,data:e,passFlags:i}},deleteParameter:function(t){this.parameters[t]&&delete this.parameters[t]},setParameters:function(t,e){var i,s=this.parameters;for(i in s){var n=s[i];n.passFlags&e&&(n.scopeId||(n.scopeId=t.scope.resolve(i)),n.scopeId.setValue(n.data))}}}),Object.defineProperty(ct.prototype,"key",{get:function(){return this._key[0]},set:function(t){this._key[0]=t}}),Object.defineProperties(ut,{FORMAT_FLOAT:{value:0},FORMAT_HALF_FLOAT:{value:1}}),Object.defineProperties(ut.prototype,{morphPositions:{get:function(){return this._morphPositions}},morphNormals:{get:function(){return this._morphNormals}},maxActiveTargets:{get:function(){return this._useTextureMorph?this._targets.length:this._morphPositions&&this._morphNormals?4:8}},useTextureMorph:{get:function(){return this._useTextureMorph}}}),Object.assign(ut.prototype,{_init:function(){var t;if(this._useTextureMorph&&(this._useTextureMorph=this._initTextureBased()),!this._useTextureMorph)for(t=0;t<this._targets.length;t++)this._targets[t]._initVertexBuffers(this.device);for(t=0;t<this._targets.length;t++)this._targets[t]._postInit()},_initTextureBased:function(){var t,e=[],i=[];for(t=0;t<this._targets.length;t++){var s=this._targets[t];s.options.deltaPositions&&(e.push(s.options.deltaPositions),i.push({target:s,name:"texturePositions"})),s.options.deltaNormals&&(e.push(s.options.deltaNormals),i.push({target:s,name:"textureNormals"}))}var n=[],r=[],a=1,o=e[0].length;for(s=0;s<o;s+=3){var h=!1;for(t=0;t<e.length;t++){var l=e[t];if(0!==l[s]||0!==l[s+1]||0!==l[s+2]){h=!0;break}}h?(n.push(a),r.push(s/3),a++):n.push(0)}if(t=Math.min(this.device.maxTextureSize,4096),s=Math.ceil(Math.sqrt(a)),s=Math.min(s,t),(l=Math.ceil(a/s))>t)return!1;this.morphTextureWidth=s,this.morphTextureHeight=l,a=!1,h=3,o=oa.float2Half,this._textureFormat===ut.FORMAT_HALF_FLOAT&&(a=!0,h=4),t=this.morphTextureWidth*this.morphTextureHeight*h;var c=a?new Uint16Array(t):new Float32Array(t);for(t=0;t<e.length;t++){for(l=e[t],s=0;s<r.length;s++){var d=r[s];a?(c[s*h+h]=o(l[3*d]),c[s*h+h+1]=o(l[3*d+1]),c[s*h+h+2]=o(l[3*d+2])):(c[s*h+h]=l[3*d],c[s*h+h+1]=l[3*d+1],c[s*h+h+2]=l[3*d+2])}(s=i[t].target)._setTexture(i[t].name,this._createTexture("MorphTarget",this._textureFormat===ut.FORMAT_FLOAT?13:12,c))}return this.vertexBufferIds=new C(this.device,new O(this.device,[{semantic:"ATTR15",components:1,type:6}]),n.length,0,new Float32Array(n)),!0},destroy:function(){this.vertexBufferIds&&(this.vertexBufferIds.destroy(),this.vertexBufferIds=null);for(var t=0;t<this._targets.length;t++)this._targets[t].destroy();this._targets.length=0},getTarget:function(t){return this._targets[t]},_updateMorphFlags:function(){this._morphNormals=this._morphPositions=!1;for(var t,e=0;e<this._targets.length;e++)(t=this._targets[e]).morphPositions&&(this._morphPositions=!0),t.morphNormals&&(this._morphNormals=!0)},_calculateAabb:function(){this.aabb=new T(new v(0,0,0),new v(0,0,0));for(var t,e=0;e<this._targets.length;e++)t=this._targets[e],this.aabb._expand(t.aabb.getMin(),t.aabb.getMax())},_createTexture:function(t,e,i){return(e=new nt(this.device,{width:this.morphTextureWidth,height:this.morphTextureHeight,format:e,cubemap:!1,mipmaps:!1,minFilter:0,magFilter:0,addressU:1,addressV:1})).name=t,i&&(e.lock().set(i),e.unlock()),e}}),Object.assign(pt.prototype,{destroy:function(){this.shader=this.meshInstance=null,this.morph&&(this.morph.destroy(),this.morph=null),this.rtPositions&&(this.rtPositions.destroy(),this.rtPositions=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.rtNormals&&(this.rtNormals.destroy(),this.rtNormals=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)},getWeight:function(t){return this._weights[t]},setWeight:function(t,e){this._weights[t]=e,this._dirty=!0},_getFragmentShader:function(t){var e,i="";for(0<t&&(i+="varying vec2 uv0;\nuniform highp float morphFactor["+t+"];\n"),e=0;e<t;e++)i+="uniform highp sampler2D morphBlendTex"+e+";\n";for(i+="void main (void) {\n\thighp vec4 color = vec4(0, 0, 0, 1);\n",e=0;e<t;e++)i+="\tcolor.xyz += morphFactor["+e+"] * texture2D(morphBlendTex"+e+", uv0).xyz;\n";return i+"\tgl_FragColor = color;\n}\n"},_getShader:function(t){var e=this.shaderCache[t];return e||(e=this._getFragmentShader(t),e=st(this.device,"attribute vec2 vertex_position;\nvarying vec2 uv0;\nvoid main(void) {\n\tgl_Position = vec4(vertex_position, 0.5, 1.0);\n\tuv0 = vertex_position.xy * 0.5 + 0.5;\n}\n",e,"textureMorph"+t),this.shaderCache[t]=e),e},_updateTextureRenderTarget:function(t,e){for(var i=this.device,s=function(e,s){this.morphFactor.setValue(this._shaderMorphWeights),i.setBlending(s),s&&(i.setBlendFunction(1,1),i.setBlendEquation(0)),e=this._getShader(e),X(i,t,e,void 0,void 0,s)}.bind(this),n=0,r=!1,a=this._activeTargets.length,o=0;o<a;o++){var h=this._activeTargets[o],l=h.target[e];l&&(this["morphBlendTex"+n].setValue(l),this._shaderMorphWeights[n]=h.weight,++n>=this.maxSubmitCount&&(s(n,r),n=0,r=!0))}(0<n||0===a&&!this.zeroTextures)&&s(n,r)},_updateTextureMorph:function(){(0<this._activeTargets.length||!this.zeroTextures)&&(this._updateTextureRenderTarget(this.rtPositions,"texturePositions"),this._updateTextureRenderTarget(this.rtNormals,"textureNormals"),this.zeroTextures=0===this._activeTargets.length)},_updateVertexMorph:function(){var t,e=this.maxSubmitCount;for(t=0;t<e;t++)this._shaderMorphWeights[t]=0,this._activeVertexBuffers[t]=null;e=0;var i=this.morph.morphPositions?4:0;for(t=0;t<this._activeTargets.length;t++){var s=this._activeTargets[t].target;s._vertexBufferPositions&&(this._activeVertexBuffers[e]=s._vertexBufferPositions,this._shaderMorphWeights[e]=this._activeTargets[t].weight,e++),s._vertexBufferNormals&&(this._activeVertexBuffers[i]=s._vertexBufferNormals,this._shaderMorphWeights[i]=this._activeTargets[t].weight,i++)}},update:function(){this._dirty=!1;var t,e=this.morph._targets,i=0;for(t=0;t<e.length;t++){var s=Math.abs(this.getWeight(t));if(1e-5<s){this._activeTargets.length<=i&&(this._activeTargets[i]={});var n=this._activeTargets[i++];n.absWeight=s,n.weight=this.getWeight(t),n.target=e[t]}}this._activeTargets.length=i,e=this.morph.maxActiveTargets,this._activeTargets.length>e&&(this._activeTargets.sort(function(t,e){return t.absWeight<e.absWeight?1:e.absWeight<t.absWeight?-1:0}),this._activeTargets.length=e),this.morph.useTextureMorph?this._updateTextureMorph():this._updateVertexMorph()}});var Za=new x;Object.assign(ft.prototype,{init:function(t,e){if(t.supportsBoneTextures){e*=3;var i=Math.ceil(Math.sqrt(e));i=oa.roundUp(i,3),this.boneTexture=new nt(t,{width:i,height:Math.ceil(e/i),format:14,mipmaps:!1,minFilter:0,magFilter:0}),this.boneTexture.name="skin",this.matrixPalette=this.boneTexture.lock()}else this.matrixPalette=new Float32Array(12*e)},initSkin:function(t){this.skin=t,this.bones=[];var e=t.inverseBindPose.length;for(this.init(t.device,e),this.matrices=[],t=0;t<e;t++)this.matrices[t]=new x},uploadBones:function(t){t.supportsBoneTextures&&(this.boneTexture.lock(),this.boneTexture.unlock())},updateMatrices:function(t){for(Za.copy(t.getWorldTransform()).invert(),t=this.bones.length-1;0<=t;t--)this.matrices[t].mulAffine2(Za,this.bones[t].getWorldTransform()),this.matrices[t].mulAffine2(this.matrices[t],this.skin.inverseBindPose[t])},updateMatrixPalette:function(){for(var t,e,i=this.matrixPalette,s=this.bones.length,n=0;n<s;n++)t=this.matrices[n].data,i[e=12*n]=t[0],i[e+1]=t[4],i[e+2]=t[8],i[e+3]=t[12],i[e+4]=t[1],i[e+5]=t[5],i[e+6]=t[9],i[e+7]=t[13],i[e+8]=t[2],i[e+9]=t[6],i[e+10]=t[10],i[e+11]=t[14];this.uploadBones(this.skin.device)}}),Object.assign(mt.prototype,{getGraph:function(){return this.graph},setGraph:function(t){this.graph=t},getCameras:function(){return this.cameras},setCameras:function(t){this.cameras=t},getLights:function(){return this.lights},setLights:function(t){this.lights=t},getMaterials:function(){var t,e=[];for(t=0;t<this.meshInstances.length;t++){var i=this.meshInstances[t];-1===e.indexOf(i.material)&&e.push(i.material)}return e},clone:function(){var t,e,i=[],s=[],n=function(t){var e=t.clone();i.push(t),s.push(e);for(var r=0;r<t._children.length;r++)e.addChild(n(t._children[r]));return e},r=n(this.graph),a=[],o=[],h=[];for(t=0;t<this.skinInstances.length;t++){var l=this.skinInstances[t].skin,c=new ft(l),d=[];for(e=0;e<l.boneNames.length;e++){var u=r.findByName(l.boneNames[e]);d.push(u)}c.bones=d,o.push(c)}for(t=0;t<this.morphInstances.length;t++)e=new pt(this.morphInstances[t].morph),h.push(e);for(t=0;t<this.meshInstances.length;t++)e=this.meshInstances[t],l=i.indexOf(e.node),l=new lt(s[l],e.mesh,e.material),e.skinInstance&&(c=this.skinInstances.indexOf(e.skinInstance),l.skinInstance=o[c]),e.morphInstance&&(e=this.morphInstances.indexOf(e.morphInstance),l.morphInstance=h[e]),a.push(l);return(t=new mt).graph=r,t.meshInstances=a,t.skinInstances=o,t.morphInstances=h,t.getGraph().syncHierarchy(),t},destroy:function(){for(var t,e,i=this.meshInstances,s=0;s<i.length;s++)(e=(t=i[s]).mesh)&&(t.mesh=null,1>e.refCount&&e.destroy()),(e=t.skinInstance)&&(e=e.boneTexture)&&e.destroy(),t.skinInstance=null,(e=t.morphInstance)&&e.destroy(),t.morphInstance=null,t.material=null},generateWireframe:function(){var t,e=[];for(t=0;t<this.meshInstances.length;t++){var i=this.meshInstances[t].mesh;-1===e.indexOf(i)&&e.push(i)}for(t=0;t<e.length;++t)(i=e[t]).primitive[1]||i.generateWireframe()}}),gt.MODEL="model",gt.ELEMENT="element",gt.SPRITE="sprite",yt.prototype=Object.create(yt.prototype),yt.prototype.constructor=yt,Object.assign(yt.prototype,{updateMatrices:function(t){},updateMatrixPalette:function(){for(var t,e,i=this.matrixPalette,s=this.bones.length,n=0;n<s;n++)t=this.bones[n].getWorldTransform().data,i[e=12*n]=t[0],i[e+1]=t[4],i[e+2]=t[8],i[e+3]=t[12],i[e+4]=t[1],i[e+5]=t[5],i[e+6]=t[9],i[e+7]=t[13],i[e+8]=t[2],i[e+9]=t[6],i[e+10]=t[10],i[e+11]=t[14];ft.prototype.uploadBones.call(this,this.device)}}),vt.prototype.destroyManager=function(){this.scene=this.rootNode=this.device=null,this._batchGroups={},this._batchList=[],this._dirtyGroups=[]},vt.prototype.addGroup=function(t,e,i,s,n){if(void 0===s&&(s=this._batchGroupCounter,this._batchGroupCounter++),!this._batchGroups[s])return this._batchGroups[s]=new gt(s,t,e,i,n)},vt.prototype.removeGroup=function(t){if(this._batchGroups[t]){for(var e=[],i=0;i<this._batchList.length;i++)this._batchList[i].batchGroupId!==t?e.push(this._batchList[i]):this.destroy(this._batchList[i]);this._batchList=e,this._removeModelsFromBatchGroup(this.rootNode,t),delete this._batchGroups[t]}},vt.prototype.markGroupDirty=function(t){0>this._dirtyGroups.indexOf(t)&&this._dirtyGroups.push(t)},vt.prototype.getGroupByName=function(t){var e,i=this._batchGroups;for(e in i)if(i.hasOwnProperty(e)&&i[e].name===t)return i[e];return null},vt.prototype.getBatches=function(t){for(var e=[],i=this._batchList.length,s=0;s<i;s++){var n=this._batchList[s];n.batchGroupId===t&&e.push(n)}return e},vt.prototype._removeModelsFromBatchGroup=function(t,e){if(t.enabled){t.model&&t.model.batchGroupId===e&&(t.model.batchGroupId=-1),t.element&&t.element.batchGroupId===e&&(t.element.batchGroupId=-1),t.sprite&&t.sprite.batchGroupId===e&&(t.sprite.batchGroupId=-1);for(var i=0;i<t._children.length;i++)this._removeModelsFromBatchGroup(t._children[i],e)}},vt.prototype.insert=function(t,e,i){var s=this._batchGroups[e];s&&0>s._obj[t].indexOf(i)&&(s._obj[t].push(i),this.markGroupDirty(e))},vt.prototype.remove=function(t,e,i){var s=this._batchGroups[e];s&&(0<=(i=s._obj[t].indexOf(i))&&(s._obj[t].splice(i,1),this.markGroupDirty(e)))},vt.prototype._extractModel=function(t,e,i,s){if(!t.model||!t.model.model)return e;if(t.model.isStatic){s=this.scene.drawCalls;var n=t.model.meshInstances;for(i=0;i<s.length;i++)s[i]._staticSource&&(0>n.indexOf(s[i]._staticSource)||e.push(s[i]));for(i=0;i<n.length;i++)0<=s.indexOf(n[i])&&e.push(n[i])}else e=s[t.model.batchGroupId]=e.concat(t.model.meshInstances);return t.model.removeModelFromLayers(),e},vt.prototype._extractElement=function(t,e,i){if(t.element){var s=!1;t.element._text&&0<t.element._text._model.meshInstances.length?(e.push(t.element._text._model.meshInstances[0]),t.element.removeModelFromLayers(t.element._text._model),s=!0):t.element._image&&(e.push(t.element._image._renderable.meshInstance),t.element.removeModelFromLayers(t.element._image._renderable.model),t.element._image._renderable.unmaskMeshInstance&&(e.push(t.element._image._renderable.unmaskMeshInstance),t.element._image._renderable.unmaskMeshInstance.stencilFront&&t.element._image._renderable.unmaskMeshInstance.stencilBack||(t.element._dirtifyMask(),t.element._onPrerender())),s=!0),s&&(i._ui=!0)}},vt.prototype._collectAndRemoveModels=function(t,e){for(var i,s,n,r=0;r<e.length;r++)if(i=e[r],s=this._batchGroups[i]){for((n=t[i])||(n=t[i]=[]),i=0;i<s._obj.model.length;i++)n=this._extractModel(s._obj.model[i],n,s,t);for(i=0;i<s._obj.element.length;i++)this._extractElement(s._obj.element[i],n,s);for(var a=0;a<s._obj.sprite.length;a++)(i=s._obj.sprite[a]).sprite&&i.sprite._meshInstance&&(s.dynamic||0===i.sprite.sprite._renderMode)&&(n.push(i.sprite._meshInstance),i.sprite.removeModelFromLayers(),s._sprite=!0,i.sprite._batchGroup=s)}},vt.prototype.generate=function(t){var e,i={};t||(t=Object.keys(this._batchGroups));var s,n,r=[];for(e=0;e<this._batchList.length;e++)0>t.indexOf(this._batchList[e].batchGroupId)?r.push(this._batchList[e]):this.destroy(this._batchList[e]);if(this._batchList=r,this._collectAndRemoveModels(i,t),t===this._dirtyGroups)this._dirtyGroups.length=0;else{for(r=[],e=0;e<this._dirtyGroups.length;e++)0>t.indexOf(this._dirtyGroups[e])&&r.push(this._dirtyGroups[e]);this._dirtyGroups=r}for(n in i)if(i.hasOwnProperty(n)&&(e=i[n],t=this._batchGroups[n])){var a=this.prepare(e,t.dynamic,t.maxAabbSize,t._ui||t._sprite);for(e=0;e<a.length;e++)if(s=this.create(a[e],t.dynamic,parseInt(n,10)))for(r=0;r<t.layers.length;r++){var o=this.scene.layers.getLayerById(t.layers[r]);o&&o.addMeshInstances(s.model.meshInstances)}}};var Qa=new v,Ja=new v,to=new v;vt.prototype.prepare=function(t,e,i,s){if(0===t.length)return[];void 0===i&&(i=Number.POSITIVE_INFINITY),i*=.5;var n,r,a=this.device.supportsBoneTextures?1024:this.device.boneLimit,o=this.device.extUintElement?4294967295:65535,h=new T,l=new T,c=null,d=[],u=0;s&&t.sort(function(t,e){return t.drawOrder-e.drawOrder});for(var p,f=t,m=s?function(t){c?c.add(t.aabb):c=t.aabb.clone(),p.push(t)}:function(t){p.push(t)};0<f.length;){d[u]=[f[0]],p=[],t=f[0].material;var _=f[0].layer,g=f[0]._shaderDefs,y=f[0].parameters,v=f[0].stencilFront,b=f[0]._staticLightList,x=f[0].mesh.vertexBuffer.getNumVertices(),S=f[0].drawOrder;h.copy(f[0].aabb);var w=Tt(f[0]),M=f[0].mesh.vertexBuffer.format.batchingHash,P=f[0].mesh.primitive[0].indexed;for(c=null,r=1;r<f.length;r++){var A=f[r];if(e&&d[u].length>=a){p=p.concat(f.slice(r));break}if(t!==A.material||_!==A.layer||M!==A.mesh.vertexBuffer.format.batchingHash||P!==A.mesh.primitive[0].indexed||g!==A._shaderDefs||x+A.mesh.vertexBuffer.getNumVertices()>o)m(A);else if(l.copy(h),l.add(A.aabb),l.halfExtents.x>i||l.halfExtents.y>i||l.halfExtents.z>i)m(A);else if(!v||(n=A.stencilFront)&&v.func==n.func&&v.zpass==n.zpass)if(w!=Tt(A))m(A);else if(xt(y,A.parameters)){var E=A._staticLightList;if(b&&E){if(!St(b,E)){m(A);continue}}else if(b||E){m(A);continue}s&&c&&c.intersects(A.aabb)&&A.drawOrder!==S?m(A):(h.add(A.aabb),x+=A.mesh.vertexBuffer.getNumVertices(),d[u].push(A))}else m(A);else m(A)}u++,f=p}return d},vt.prototype.create=function(t,e,i){this._init||(this.transformVS="#define BONE_LIMIT "+this.device.getBoneLimit()+"\n#define DYNAMICBATCH\n"+Ra.transformVS,this.skinTexVS=Ra.skinBatchTexVS,this.skinConstVS=Ra.skinBatchConstVS,this.vertexFormats={},this._init=!0);var s,n,r=null,a=null,o=0,h=0,l=null;for(s=0;s<t.length;s++)if(t[s].visible){var c=t[s].mesh,d=c.vertexBuffer.numVertices;if(o+=d,h+=c.primitive[0].indexed?c.primitive[0].count:6==c.primitive[0].type&&4===c.primitive[0].count?6:0,!r){for(a=t[s].material,r={},d=c.vertexBuffer.format.elements,n=0;n<d.length;n++){var u=d[n].name;r[u]={numComponents:d[n].numComponents,dataType:d[n].dataType,normalize:d[n].normalize,count:0}}e&&(r.BLENDINDICES={numComponents:1,dataType:6,normalize:!1,count:0})}}if(r){l=new _t(t,e,i),this._batchList.push(l);var p,f=0,m=0,_=new v;for(u in h=new(65535>=o?Uint16Array:Uint32Array)(h),r){var g=r[u];g.typeArrayType=Ma[g.dataType],g.elementByteSize=Pa[g.dataType],g.buffer=new g.typeArrayType(o*g.numComponents)}for(s=0;s<t.length;s++)if(t[s].visible){for(u in d=(c=t[s].mesh).vertexBuffer.numVertices,e||(p=t[s].node.getWorldTransform()),r)if("BLENDINDICES"!==u){o=new(g=r[u]).typeArrayType(g.buffer.buffer,g.elementByteSize*g.count);var y=c.getVertexStream(u,o)*g.numComponents;if(g.count+=y,!e&&3<=g.numComponents&&("POSITION"==u||"NORMAL"==u||"TANGENT"==u))for(p.transformFunction="POSITION"==u?x.prototype.transformPoint:x.prototype.transformVector,n=0;n<y;n+=g.numComponents)_.set(o[n],o[n+1],o[n+2]),p.transformFunction(_,_),o[n]=_.x,o[n+1]=_.y,o[n+2]=_.z}if(e)for(g=r.BLENDINDICES,n=0;n<d;n++)g.buffer[g.count++]=s;if(c.primitive[0].indexed)g=c.primitive[0].base,o=c.primitive[0].count,n=c.indexBuffer[0].getFormat(),c=new Aa[n](c.indexBuffer[0].storage);else{if(6!=c.primitive[0].type||4!==c.primitive[0].count)continue;g=0,o=6,c=[0,1,3,2,3,1]}for(n=0;n<o;n++)h[n+m]=c[g+n]+f;m+=o,f+=d}for(u in c=new ht(this.device),r)g=r[u],c.setVertexStream(u,g.buffer,g.numComponents,void 0,g.dataType,g.normalize);if(0<h.length&&c.setIndices(h),c.update(4,!1),e&&((a=a.clone()).chunks.transformVS=this.transformVS,a.chunks.skinTexVS=this.skinTexVS,a.chunks.skinConstVS=this.skinConstVS,a.update()),(t=new lt(this.rootNode,c,a)).castShadow=l.origMeshInstances[0].castShadow,t.parameters=l.origMeshInstances[0].parameters,t.isStatic=l.origMeshInstances[0].isStatic,t.layer=l.origMeshInstances[0].layer,t._staticLightList=l.origMeshInstances[0]._staticLightList,t._shaderDefs=l.origMeshInstances[0]._shaderDefs,t.cull=l.origMeshInstances[0].cull,(s=this._batchGroups[i])&&s._ui&&(t.cull=!1),e){for(e=[],s=0;s<l.origMeshInstances.length;s++)e.push(l.origMeshInstances[s].node);t.skinInstance=new yt(this.device,e,this.rootNode)}t._updateAabb=!1,t.drawOrder=l.origMeshInstances[0].drawOrder,t.stencilFront=l.origMeshInstances[0].stencilFront,t.stencilBack=l.origMeshInstances[0].stencilBack,t.flipFaces=0>Tt(l.origMeshInstances[0]),l.meshInstance=t,this.update(l),(e=new mt).meshInstances=[l.meshInstance],e.castShadows=l.origMeshInstances[0].castShadows,l.model=e}return l},vt.prototype.update=function(t){t._aabb.copy(t.origMeshInstances[0].aabb);for(var e=1;e<t.origMeshInstances.length;e++)t._aabb.add(t.origMeshInstances[e].aabb);t.meshInstance.aabb=t._aabb,t._aabb._radiusVer=-1,t.meshInstance._aabbVer=0},vt.prototype.updateAll=function(){0<this._dirtyGroups.length&&this.generate(this._dirtyGroups);for(var t=0;t<this._batchList.length;t++)this._batchList[t].dynamic&&this.update(this._batchList[t])},vt.prototype.clone=function(t,e){var i=new _t(e,t.dynamic,t.batchGroupId);this._batchList.push(i);for(var s=[],n=0;n<e.length;n++)s.push(e[n].node);return i.meshInstance=new lt(t.meshInstance.node,t.meshInstance.mesh,t.meshInstance.material),i.meshInstance._updateAabb=!1,i.meshInstance.parameters=e[0].parameters,i.meshInstance.isStatic=e[0].isStatic,i.meshInstance.cull=e[0].cull,i.meshInstance.layer=e[0].layer,i.meshInstance._staticLightList=e[0]._staticLightList,t.dynamic&&(i.meshInstance.skinInstance=new yt(this.device,s,this.rootNode)),i.meshInstance.castShadow=t.meshInstance.castShadow,i.meshInstance._shader=t.meshInstance._shader,(e=new mt).meshInstances=[i.meshInstance],e.castShadows=t.origMeshInstances[0].castShadows,i.model=e,i},vt.prototype.destroy=function(t){if(t.refCounter=0,t.model){for(var e=this._batchGroups[t.batchGroupId].layers,i=0;i<e.length;i++){var s=this.scene.layers.getLayerById(e[i]);s&&s.removeMeshInstances(t.model.meshInstances)}t.model.destroy()}},vt.prototype.decrement=function(t){t.refCounter--,0===t.refCounter&&this.destroy(t)};var eo=new v,io=new v,so=new v,no=new x;Object.defineProperty(wt.prototype,"aspectRatio",{get:function(){return this._aspectRatio},set:function(t){this._aspectRatio!==t&&(this._aspectRatio=t,this._projMatDirty=!0)}}),Object.defineProperty(wt.prototype,"aspectRatioMode",{get:function(){return this._aspectRatioMode},set:function(t){this._aspectRatioMode!==t&&(this._aspectRatioMode=t,this._projMatDirty=!0)}}),Object.defineProperty(wt.prototype,"calculateProjection",{get:function(){return this._calculateProjection},set:function(t){this._calculateProjection=t,this._projMatDirty=!0}}),Object.defineProperty(wt.prototype,"calculateTransform",{get:function(){return this._calculateTransform},set:function(t){this._calculateTransform=t}}),Object.defineProperty(wt.prototype,"clearColor",{get:function(){return this._clearColor},set:function(t){this._clearColor.copy(t)}}),Object.defineProperty(wt.prototype,"clearColorBuffer",{get:function(){return this._clearColorBuffer},set:function(t){this._clearColorBuffer=t}}),Object.defineProperty(wt.prototype,"clearDepth",{get:function(){return this._clearDepth},set:function(t){this._clearDepth=t}}),Object.defineProperty(wt.prototype,"clearDepthBuffer",{get:function(){return this._clearDepthBuffer},set:function(t){this._clearDepthBuffer=t}}),Object.defineProperty(wt.prototype,"clearStencil",{get:function(){return this._clearStencil},set:function(t){this._clearStencil=t}}),Object.defineProperty(wt.prototype,"clearStencilBuffer",{get:function(){return this._clearStencilBuffer},set:function(t){this._clearStencilBuffer=t}}),Object.defineProperty(wt.prototype,"cullingMask",{get:function(){return this._cullingMask},set:function(t){this._cullingMask=t}}),Object.defineProperty(wt.prototype,"cullFaces",{get:function(){return this._cullFaces},set:function(t){this._cullFaces=t}}),Object.defineProperty(wt.prototype,"farClip",{get:function(){return this._farClip},set:function(t){this._farClip!==t&&(this._farClip=t,this._projMatDirty=!0)}}),Object.defineProperty(wt.prototype,"flipFaces",{get:function(){return this._flipFaces},set:function(t){this._flipFaces=t}}),Object.defineProperty(wt.prototype,"fov",{get:function(){return this._fov},set:function(t){this._fov!==t&&(this._fov=t,this._projMatDirty=!0)}}),Object.defineProperty(wt.prototype,"frustumCulling",{get:function(){return this._frustumCulling},set:function(t){this._frustumCulling=t}}),Object.defineProperty(wt.prototype,"horizontalFov",{get:function(){return this._horizontalFov},set:function(t){this._horizontalFov!==t&&(this._horizontalFov=t,this._projMatDirty=!0)}}),Object.defineProperty(wt.prototype,"layers",{get:function(){return this._layers},set:function(t){this._layers=t.slice(0)}}),Object.defineProperty(wt.prototype,"nearClip",{get:function(){return this._nearClip},set:function(t){this._nearClip!==t&&(this._nearClip=t,this._projMatDirty=!0)}}),Object.defineProperty(wt.prototype,"node",{get:function(){return this._node},set:function(t){this._node=t}}),Object.defineProperty(wt.prototype,"orthoHeight",{get:function(){return this._orthoHeight},set:function(t){this._orthoHeight!==t&&(this._orthoHeight=t,this._projMatDirty=!0)}}),Object.defineProperty(wt.prototype,"projection",{get:function(){return this._projection},set:function(t){this._projection!==t&&(this._projection=t,this._projMatDirty=!0)}}),Object.defineProperty(wt.prototype,"projectionMatrix",{get:function(){return this._evaluateProjectionMatrix(),this._projMat}}),Object.defineProperty(wt.prototype,"rect",{get:function(){return this._rect},set:function(t){this._rect.copy(t)}}),Object.defineProperty(wt.prototype,"renderTarget",{get:function(){return this._renderTarget},set:function(t){this._renderTarget=t}}),Object.defineProperty(wt.prototype,"scissorRect",{get:function(){return this._scissorRect},set:function(t){this._scissorRect.copy(t)}}),Object.defineProperty(wt.prototype,"viewMatrix",{get:function(){if(this._viewMatDirty){var t=this._node.getWorldTransform();this._viewMat.copy(t).invert(),this._viewMatDirty=!1}return this._viewMat}}),Object.defineProperty(wt.prototype,"vrDisplay",{get:function(){return this._vrDisplay},set:function(t){(this._vrDisplay=t)&&(t._camera=this)}}),Object.assign(wt.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(t){this.aspectRatio=t.aspectRatio,this.aspectRatioMode=t.aspectRatioMode,this.calculateProjection=t.calculateProjection,this.calculateTransform=t.calculateTransform,this.clearColor=t.clearColor,this.clearColorBuffer=t.clearColorBuffer,this.clearDepth=t.clearDepth,this.clearDepthBuffer=t.clearDepthBuffer,this.clearStencil=t.clearStencil,this.clearStencilBuffer=t.clearStencilBuffer,this.cullFaces=t.cullFaces,this.cullingMask=t.cullingMask,this.farClip=t.farClip,this.flipFaces=t.flipFaces,this.fov=t.fov,this.frustumCulling=t.frustumCulling,this.horizontalFov=t.horizontalFov,this.layers=t.layers,this.nearClip=t.nearClip,this.orthoHeight=t.orthoHeight,this.projection=t.projection,this.rect=t.rect,this.renderTarget=t.renderTarget,this.scissorRect=t.scissorRect,this.vrDisplay=t.vrDisplay},_updateViewProjMat:function(){(this._projMatDirty||this._viewMatDirty||this._viewProjMatDirty)&&(this._viewProjMat.mul2(this.projectionMatrix,this.viewMatrix),this._viewProjMatDirty=!1)},worldToScreen:function(t,e,i,s){void 0===s&&(s=new v),this._updateViewProjMat(),this._viewProjMat.transformPoint(t,s);var n=this._viewProjMat.data;return t=t.x*n[3]+t.y*n[7]+t.z*n[11]+1*n[15],s.x=.5*(s.x/t+1)*e,s.y=.5*(1-s.y/t)*i,s},screenToWorld:function(t,e,i,s,n,r){return void 0===r&&(r=new v),eo.set(t/s,(n-e)/n,i/(this._farClip-this._nearClip)),eo.scale(2),eo.sub(v.ONE),0===this._projection?(x._getPerspectiveHalfSize(io,this._fov,this._aspectRatio,this._nearClip,this._horizontalFov),io.x*=eo.x,io.y*=eo.y,t=this._node.getWorldTransform(),io.z=-this._nearClip,t.transformPoint(io,so),t=this._node.getPosition(),r.sub2(so,t),r.normalize(),r.scale(i),r.add(t)):(this._updateViewProjMat(),no.copy(this._viewProjMat).invert(),no.transformPoint(eo,r)),r},_evaluateProjectionMatrix:function(){if(this._projMatDirty){if(0===this._projection)this._projMat.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip,this._horizontalFov),this._projMatSkybox.copy(this._projMat);else{var t=this._orthoHeight,e=t*this._aspectRatio;this._projMat.setOrtho(-e,e,-t,t,this._nearClip,this._farClip),this._projMatSkybox.setPerspective(this._fov,this._aspectRatio,this._nearClip,this._farClip)}this._projMatDirty=!1}},getProjectionMatrixSkybox:function(){return this._evaluateProjectionMatrix(),this._projMatSkybox}});var ro=new x,ao=new v,oo=new S,ho=new S,lo=new v,co=new v,uo=new x,po=new S;Mt.prototype=Object.create(n.prototype),Mt.prototype.constructor=Mt,Object.defineProperty(Mt.prototype,"right",{get:function(){return this._right||(this._right=new v),this.getWorldTransform().getX(this._right).normalize()}}),Object.defineProperty(Mt.prototype,"up",{get:function(){return this._up||(this._up=new v),this.getWorldTransform().getY(this._up).normalize()}}),Object.defineProperty(Mt.prototype,"forward",{get:function(){return this._forward||(this._forward=new v),this.getWorldTransform().getZ(this._forward).normalize().scale(-1)}}),Object.defineProperty(Mt.prototype,"enabled",{get:function(){return this._enabled&&this._enabledInHierarchy},set:function(t){this._enabled!==t&&(this._enabled=t,this._parent&&!this._parent.enabled||this._notifyHierarchyStateChanged(this,t))}}),Object.defineProperty(Mt.prototype,"parent",{get:function(){return this._parent}}),Object.defineProperty(Mt.prototype,"path",{get:function(){var t=this._parent;if(t){for(var e=this.name;t&&t._parent;)e=t.name+"/"+e,t=t._parent;return e}return""}}),Object.defineProperty(Mt.prototype,"root",{get:function(){var t=this._parent;if(!t)return this;for(;t._parent;)t=t._parent;return t}}),Object.defineProperty(Mt.prototype,"children",{get:function(){return this._children}}),Object.defineProperty(Mt.prototype,"graphDepth",{get:function(){return this._graphDepth}}),Object.assign(Mt.prototype,{_notifyHierarchyStateChanged:function(t,e){t._onHierarchyStateChanged(e);for(var i=0,s=(t=t._children).length;i<s;i++)t[i]._enabled&&this._notifyHierarchyStateChanged(t[i],e)},_onHierarchyStateChanged:function(t){(this._enabledInHierarchy=t)&&!this._frozen&&this._unfreezeParentToRoot()},_cloneInternal:function(t){t.name=this.name;for(var e=this.tags._list,i=0;i<e.length;i++)t.tags.add(e[i]);t._labels=Object.assign({},this._labels),t.localPosition.copy(this.localPosition),t.localRotation.copy(this.localRotation),t.localScale.copy(this.localScale),t.localEulerAngles.copy(this.localEulerAngles),t.position.copy(this.position),t.rotation.copy(this.rotation),t.eulerAngles.copy(this.eulerAngles),t.localTransform.copy(this.localTransform),t._dirtyLocal=this._dirtyLocal,t.worldTransform.copy(this.worldTransform),t._dirtyWorld=this._dirtyWorld,t._dirtyNormal=this._dirtyNormal,t._aabbVer=this._aabbVer+1,t._enabled=this._enabled,t.scaleCompensation=this.scaleCompensation,t._enabledInHierarchy=!1},clone:function(){var t=new Mt;return this._cloneInternal(t),t},find:function(t,e){var i,s=[],n=this._children.length;if(t instanceof Function)for((e=t(this))&&s.push(this),i=0;i<n;i++){var r=this._children[i].find(t);r.length&&(s=s.concat(r))}else for(this[t]&&((i=this[t]instanceof Function?this[t]():this[t])===e&&s.push(this)),i=0;i<n;++i)(r=this._children[i].find(t,e)).length&&(s=s.concat(r));return s},findOne:function(t,e){var i,s,n=this._children.length;if(t instanceof Function){if(s=t(this))return this;for(i=0;i<n;i++)if(s=this._children[i].findOne(t))return s}else{if(this[t]&&(i=this[t]instanceof Function?this[t]():this[t])===e)return this;for(i=0;i<n;i++)if(null!==(s=this._children[i].findOne(t,e)))return s}return null},findByTag:function(){var t=this.tags._processArguments(arguments);return this._findByTag(t)},_findByTag:function(t){var e,i=[],s=this._children.length;for(e=0;e<s;e++){this._children[e].tags._has(t)&&i.push(this._children[e]);var n=this._children[e]._findByTag(t);n.length&&(i=i.concat(n))}return i},findByName:function(t){if(this.name===t)return this;for(var e=0;e<this._children.length;e++){var i=this._children[e].findByName(t);if(null!==i)return i}return null},findByPath:function(t){for(var e=this,i=null,s=0,n=(t=t.split("/")).length;s<n&&e;s++){var r=t[s];i=null;for(var a=0,o=(e=e._children).length;a<o;a++)if(e[a].name==r){i=e[a];break}e=i}return i},forEach:function(t,e){t.call(e,this);for(var i=this._children,s=0;s<i.length;s++)i[s].forEach(t,e)},isDescendantOf:function(t){for(var e=this._parent;e;){if(e===t)return!0;e=e._parent}return!1},isAncestorOf:function(t){return t.isDescendantOf(this)},getEulerAngles:function(){return this.getWorldTransform().getEulerAngles(this.eulerAngles),this.eulerAngles},getLocalEulerAngles:function(){return this.localRotation.getEulerAngles(this.localEulerAngles),this.localEulerAngles},getLocalPosition:function(){return this.localPosition},getLocalRotation:function(){return this.localRotation},getLocalScale:function(){return this.localScale},getLocalTransform:function(){return this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this.localTransform},getPosition:function(){return this.getWorldTransform().getTranslation(this.position),this.position},getRotation:function(){return this.rotation.setFromMat4(this.getWorldTransform()),this.rotation},getScale:function(){return this._scale||(this._scale=new v),this.getWorldTransform().getScale(this._scale)},getWorldTransform:function(){return this._dirtyLocal||this._dirtyWorld?(this._parent&&this._parent.getWorldTransform(),this._sync(),this.worldTransform):this.worldTransform},reparent:function(t,e){var i=this._parent;i&&i.removeChild(this),t&&(0<=e?t.insertChild(this,e):t.addChild(this))},setLocalEulerAngles:function(t,e,i){t instanceof v?this.localRotation.setFromEulerAngles(t.x,t.y,t.z):this.localRotation.setFromEulerAngles(t,e,i),this._dirtyLocal||this._dirtifyLocal()},setLocalPosition:function(t,e,i){t instanceof v?this.localPosition.copy(t):this.localPosition.set(t,e,i),this._dirtyLocal||this._dirtifyLocal()},setLocalRotation:function(t,e,i,s){t instanceof S?this.localRotation.copy(t):this.localRotation.set(t,e,i,s),this._dirtyLocal||this._dirtifyLocal()},setLocalScale:function(t,e,i){t instanceof v?this.localScale.copy(t):this.localScale.set(t,e,i),this._dirtyLocal||this._dirtifyLocal()},_dirtifyLocal:function(){this._dirtyLocal||(this._dirtyLocal=!0,this._dirtyWorld||this._dirtifyWorld())},_unfreezeParentToRoot:function(){for(var t=this._parent;t;)t._frozen=!1,t=t._parent},_dirtifyWorld:function(){this._dirtyWorld||this._unfreezeParentToRoot(),this._dirtifyWorldInternal()},_dirtifyWorldInternal:function(){if(!this._dirtyWorld){this._frozen=!1,this._dirtyWorld=!0;for(var t=0;t<this._children.length;t++)this._children[t]._dirtyWorld||this._children[t]._dirtifyWorldInternal()}this._dirtyNormal=!0,this._aabbVer++},setPosition:function(){var t=new v,e=new x;return function(i,s,n){i instanceof v?t.copy(i):t.set(i,s,n),null===this._parent?this.localPosition.copy(t):(e.copy(this._parent.getWorldTransform()).invert(),e.transformPoint(t,this.localPosition)),this._dirtyLocal||this._dirtifyLocal()}}(),setRotation:function(){var t=new S,e=new S;return function(i,s,n,r){i instanceof S?t.copy(i):t.set(i,s,n,r),null===this._parent?this.localRotation.copy(t):(i=this._parent.getRotation(),e.copy(i).invert(),this.localRotation.copy(e).mul(t)),this._dirtyLocal||this._dirtifyLocal()}}(),setEulerAngles:function(){var t=new S;return function(e,i,s){e instanceof v?this.localRotation.setFromEulerAngles(e.x,e.y,e.z):this.localRotation.setFromEulerAngles(e,i,s),null!==this._parent&&(e=this._parent.getRotation(),t.copy(e).invert(),this.localRotation.mul2(t,this.localRotation)),this._dirtyLocal||this._dirtifyLocal()}}(),addChild:function(t){if(null!==t._parent)throw Error("GraphNode is already parented");this._children.push(t),this._onInsertChild(t)},addChildAndSaveTransform:function(t){var e=t.getPosition(),i=t.getRotation(),s=t._parent;s&&s.removeChild(t),t.setPosition(uo.copy(this.worldTransform).invert().transformPoint(e)),t.setRotation(po.copy(this.getRotation()).invert().mul(i)),this._children.push(t),this._onInsertChild(t)},insertChild:function(t,e){if(null!==t._parent)throw Error("GraphNode is already parented");this._children.splice(e,0,t),this._onInsertChild(t)},_onInsertChild:function(t){t._parent=this;var e=t._enabled&&this.enabled;t._enabledInHierarchy!==e&&(t._enabledInHierarchy=e,t._notifyHierarchyStateChanged(t,e)),t._updateGraphDepth(),t._dirtifyWorld(),this._frozen&&t._unfreezeParentToRoot(),t.fire&&t.fire("insert",this),this.fire&&this.fire("childinsert",t)},_updateGraphDepth:function(){this._graphDepth=this._parent?this._parent._graphDepth+1:0;for(var t=0,e=this._children.length;t<e;t++)this._children[t]._updateGraphDepth()},removeChild:function(t){var e,i=this._children.length;for(e=0;e<i;++e)if(this._children[e]===t){this._children.splice(e,1),t._parent=null,t.fire&&t.fire("remove",this),this.fire&&this.fire("childremove",t);break}},_sync:function(){if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),this._dirtyLocal=!1),this._dirtyWorld){if(null===this._parent)this.worldTransform.copy(this.localTransform);else if(this.scaleCompensation){var t=this._parent,e=this.localScale,i=t;if(i){for(;i&&i.scaleCompensation;)i=i._parent;if(i&&(i=i._parent)){var s=i.worldTransform.getScale();lo.mul2(s,this.localScale),e=lo}}ho.setFromMat4(t.worldTransform),oo.mul2(ho,this.localRotation),i=t.worldTransform,t.scaleCompensation&&(co.mul2(s,t.getLocalScale()),ro.setTRS(t.worldTransform.getTranslation(ao),ho,co),i=ro),i.transformPoint(this.localPosition,ao),this.worldTransform.setTRS(ao,oo,e)}else this.worldTransform.mulAffine2(this._parent.worldTransform,this.localTransform);this._dirtyWorld=!1}},syncHierarchy:function(){if(this._enabled&&!this._frozen){this._frozen=!0,(this._dirtyLocal||this._dirtyWorld)&&this._sync();for(var t=this._children,e=0,i=t.length;e<i;e++)t[e].syncHierarchy()}},lookAt:function(){var t=new x,e=new v,i=new v,s=new S;return function(n,r,a,o,h,l){if(n instanceof v)e.copy(n),r instanceof v?i.copy(r):i.copy(v.UP);else{if(void 0===a)return;e.set(n,r,a),void 0!==o?i.set(o,h,l):i.copy(v.UP)}t.setLookAt(this.getPosition(),e,i),s.setFromMat4(t),this.setRotation(s)}}(),translate:function(){var t=new v;return function(e,i,s){e instanceof v?t.copy(e):t.set(e,i,s),t.add(this.getPosition()),this.setPosition(t)}}(),translateLocal:function(){var t=new v;return function(e,i,s){e instanceof v?t.copy(e):t.set(e,i,s),this.localRotation.transformVector(t,t),this.localPosition.add(t),this._dirtyLocal||this._dirtifyLocal()}}(),rotate:function(){var t=new S,e=new S;return function(i,s,n){i instanceof v?t.setFromEulerAngles(i.x,i.y,i.z):t.setFromEulerAngles(i,s,n),null===this._parent?this.localRotation.mul2(t,this.localRotation):(i=this.getRotation(),s=this._parent.getRotation(),e.copy(s).invert(),t.mul2(e,t),this.localRotation.mul2(t,i)),this._dirtyLocal||this._dirtifyLocal()}}(),rotateLocal:function(){var t=new S;return function(e,i,s){e instanceof v?t.setFromEulerAngles(e.x,e.y,e.z):t.setFromEulerAngles(e,i,s),this.localRotation.mul(t),this._dirtyLocal||this._dirtifyLocal()}}()});var fo,mo,_o,go,yo=[null,function(t,e){return t.drawOrder-e.drawOrder},function(t,e){return fo=t._key[0],mo=e._key[0],fo===mo&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:mo-fo},function(t,e){return e.zdist-t.zdist},function(t,e){return t.zdist-e.zdist}],vo=0;Ct.prototype.clearVisibleLists=function(t){this.visibleOpaque[t]&&(this.visibleOpaque[t].length=0,this.visibleOpaque[t].list.length=0),this.visibleTransparent[t]&&(this.visibleTransparent[t].length=0,this.visibleTransparent[t].list.length=0)},Object.defineProperty(It.prototype,"enabled",{get:function(){return this._enabled},set:function(t){t!==this._enabled&&((this._enabled=t)?(this.incrementCounter(),this.onEnable&&this.onEnable()):(this.decrementCounter(),this.onDisable&&this.onDisable()))}}),Object.defineProperty(It.prototype,"clearColor",{get:function(){return this._clearColor},set:function(t){this._clearColor.copy(t)}}),It.prototype._updateClearFlags=function(){var t=0;this._clearColorBuffer&&(t|=1),this._clearDepthBuffer&&(t|=2),this._clearStencilBuffer&&(t|=4),this._clearOptions.flags=t},Object.defineProperty(It.prototype,"clearColorBuffer",{get:function(){return this._clearColorBuffer},set:function(t){this._clearColorBuffer=t,this._updateClearFlags()}}),Object.defineProperty(It.prototype,"clearDepthBuffer",{get:function(){return this._clearDepthBuffer},set:function(t){this._clearDepthBuffer=t,this._updateClearFlags()}}),Object.defineProperty(It.prototype,"clearStencilBuffer",{get:function(){return this._clearStencilBuffer},set:function(t){this._clearStencilBuffer=t,this._updateClearFlags()}}),It.prototype.incrementCounter=function(){0===this._refCounter&&(this._enabled=!0,this.onEnable)&&this.onEnable(),this._refCounter++},It.prototype.decrementCounter=function(){if(1===this._refCounter)this._enabled=!1,this.onDisable&&this.onDisable();else if(0===this._refCounter)return;this._refCounter--},It.prototype.addMeshInstances=function(t,e){for(var i,s,n,r=this._shaderVersion,a=this.shadowCasters,o=0;o<t.length;o++)0>(s=3===(n=(i=t[o]).material).blendType?this.opaqueMeshInstances:this.transparentMeshInstances).indexOf(i)&&s.push(i),!e&&i.castShadow&&0>a.indexOf(i)&&a.push(i),!this.passThrough&&0<=r&&n._shaderVersion!==r&&(n.updateShader!==nr.prototype.updateShader&&(n.clearVariants(),n.shader=null),n._shaderVersion=r);this.passThrough||(this._dirty=!0)},It.prototype.removeMeshInstances=function(t,e){var i,s,n=this.opaqueMeshInstances,r=this.transparentMeshInstances,a=this.shadowCasters;for(i=0;i<t.length;i++){var o=t[i],h=-1,l=0,c=n.length;for(s=0;s<c;s++){var d=n[s];if(d===o){h=s,l=1;break}if(d._staticSource===o)0>h&&(h=s),l++;else if(0<=h)break}for(0<=h&&n.splice(h,l),h=-1,l=0,c=r.length,s=0;s<c;s++){if((d=r[s])===o){h=s,l=1;break}if(d._staticSource===o)0>h&&(h=s),l++;else if(0<=h)break}0<=h&&r.splice(h,l),e||0<=(s=a.indexOf(o))&&a.splice(s,1)}this._dirty=!0},It.prototype.clearMeshInstances=function(t){(0!==this.opaqueMeshInstances.length||0!==this.transparentMeshInstances.length||!t&&0!==this.shadowCasters.length)&&(this.opaqueMeshInstances.length=0,this.transparentMeshInstances.length=0,t||(this.shadowCasters.length=0),this.passThrough||(this._dirty=!0))},It.prototype.addLight=function(t){0<=this._lightComponents.indexOf(t)||(this._lightComponents.push(t),this._lights.push(t.light),this._dirtyLights=!0,this._generateLightHash())},It.prototype.removeLight=function(t){var e=this._lightComponents.indexOf(t);0>e||(this._lightComponents.splice(e,1),e=this._lights.indexOf(t.light),this._lights.splice(e,1),this._dirtyLights=!0,this._generateLightHash())},It.prototype.clearLights=function(){this._lightComponents.length=0,this._lights.length=0,this._dirtyLights=!0},It.prototype.addShadowCasters=function(t){for(var e,i=this.shadowCasters,s=0;s<t.length;s++)(e=t[s]).castShadow&&0>i.indexOf(e)&&i.push(e);this._dirtyLights=!0},It.prototype.removeShadowCasters=function(t){for(var e,i=this.shadowCasters,s=0;s<t.length;s++)0<=(e=i.indexOf(t[s]))&&i.splice(e,1);this._dirtyLights=!0},It.prototype._generateLightHash=function(){if(0<this._lights.length){this._lights.sort(At);for(var t="",e="",i=0;i<this._lights.length;i++)this._lights[i].isStatic?e+=this._lights[i].key:t+=this._lights[i].key;this._lightHash=0===t.length?0:I(t),this._staticLightHash=0===e.length?0:I(e)}else this._staticLightHash=this._lightHash=0},It.prototype._generateCameraHash=function(){if(1<this.cameras.length){this.cameras.sort(Pt);for(var t="",e=0;e<this.cameras.length;e++)t+=this.cameras[e].entity.getGuid();this._cameraHash=I(t)}else this._cameraHash=0;this._dirtyCameras=!0},It.prototype.addCamera=function(t){0<=this.cameras.indexOf(t)||(this.cameras.push(t),this._generateCameraHash())},It.prototype.removeCamera=function(t){0>(t=this.cameras.indexOf(t))||(this.cameras.splice(t,1),this._generateCameraHash(),this.instances.clearVisibleLists(t))},It.prototype.clearCameras=function(){this._cameraHash=this.cameras.length=0,this._dirtyCameras=!0},It.prototype._sortCameras=function(){this._generateCameraHash()},It.prototype._calculateSortDistances=function(t,e,i,s){var n;for(n=0;n<e;n++){var r=t[n];if(!(r.command||2>=r.layer))if(r.calculateSortDistance)r.zdist=r.calculateSortDistance(r,i,s);else{var a=r.aabb.center,o=a.x-i.x,h=a.y-i.y;a=a.z-i.z,r.zdist=o*s.x+h*s.y+a*s.z}}},It.prototype._sortVisible=function(t,e,i){var s=this.instances,n=t?this.transparentSortMode:this.opaqueSortMode;0!==n&&(t=t?s.visibleTransparent[i]:s.visibleOpaque[i],5===n?(_o=e.getPosition(),go=e.forward,this.customCalculateSortValues&&this.customCalculateSortValues(t.list,t.length,_o,go),t.list.length!==t.length&&(t.list.length=t.length),this.customSortCallback&&t.list.sort(this.customSortCallback)):(3!==n&&4!==n||(_o=e.getPosition(),go=e.forward,this._calculateSortDistances(t.list,t.length,_o,go)),t.list.length!==t.length&&(t.list.length=t.length),t.list.sort(yo[n])))};for(var bo,xo,So,To,wo,Mo,Po,Ao,Eo,Co=(new x).mul2((new x).setTranslate(.5,.5,.5),(new x).setScale(.5,.5,.5)),Io={r:1,g:2,b:3,a:4},Oo=[(new S).setFromEulerAngles(0,90,180),(new S).setFromEulerAngles(0,-90,180),(new S).setFromEulerAngles(90,0,0),(new S).setFromEulerAngles(-90,0,0),(new S).setFromEulerAngles(0,180,180),(new S).setFromEulerAngles(0,0,180)],Ro=[{},{},{},{},{}],Do=new Float32Array(2),Lo={x:1,y:1,z:0,w:0},Fo=new x,Bo=new x,No=new x,ko=new x,zo=new x,Uo=new g,Vo=new x,jo=new x,Go=new x,Ho=new x,Wo=new x,Xo=new v,qo=new v,Yo=new x,Ko=new x,$o=new x,Zo=new x,Qo=new v,Jo=new v,th=new v,eh=new v,ih={center:null,radius:0},sh=new T,nh=[0,0,0,0],rh={},ah=null,oh=[],hh=0;8>hh;hh++)oh.push(new v);var lh=[new v,new v,new v,new v,new v,new v,new v,new v];Object.assign(Ft.prototype,{sortCompare:function(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist;if(t.zdist2&&e.zdist2)return t.zdist2-e.zdist2}return e._key[0]-t._key[0]},sortCompareMesh:function(t,e){if(t.layer===e.layer){if(t.drawOrder&&e.drawOrder)return t.drawOrder-e.drawOrder;if(t.zdist&&e.zdist)return e.zdist-t.zdist}return Ao=t._key[0],Eo=e._key[0],Ao===Eo&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Eo-Ao},depthSortCompare:function(t,e){return Ao=t._key[1],Eo=e._key[1],Ao===Eo&&t.mesh&&e.mesh?e.mesh.id-t.mesh.id:Eo-Ao},lightCompare:function(t,e){return t.key-e.key},getShadowCamera:function(t,e){var i=e._shadowCamera;if(null===i){var s=4===(i=e._shadowType)||0===i&&t.webgl2;1===e._type&&(s=!1);var n=new wt;n.clearColor=1<=i&&3>=i?new o(0,0,0,0):new o(1,1,1,1),n.clearColorBuffer=!s,n.clearDepthBuffer=!0,n.clearStencilBuffer=!1,n.node=new Mt,i=e._shadowCamera=n,Lt(t,e)}else(s=i.renderTarget).width===e._shadowResolution&&s.height===e._shadowResolution||Lt(t,e);return i},updateCameraFrustum:function(t){if(t.vrDisplay&&t.vrDisplay.presenting){bo=t.vrDisplay.combinedProj;var e=t._node.parent;e?zo.copy(e.getWorldTransform()).mul(t.vrDisplay.combinedViewInv).invert():zo.copy(t.vrDisplay.combinedView),ko.copy(zo).invert(),this.viewInvId.setValue(ko.data),Vo.mul2(bo,zo),t.frustum.setFromMat4(Vo)}else if(t.xr&&t.xr.views.length)return e=t.xr.views[0],Vo.mul2(e.projMat,e.viewOffMat),void t.frustum.setFromMat4(Vo);if(bo=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(bo,0),t.calculateTransform)t.calculateTransform(ko,0);else{e=t._node.getPosition();var i=t._node.getRotation();ko.setTRS(e,i,v.ONE),this.viewInvId.setValue(ko.data)}zo.copy(ko).invert(),Vo.mul2(bo,zo),t.frustum.setFromMat4(Vo)},setCamera:function(t,e,i,s){var n,r=t.vrDisplay;if(r&&r.presenting){if(xo=r.leftProj,So=r.rightProj,bo=r.combinedProj,t.calculateProjection&&(t.calculateProjection(xo,1),t.calculateProjection(So,2),t.calculateProjection(bo,0)),t.calculateTransform)t.calculateTransform(jo,1),t.calculateTransform(Go,2),t.calculateTransform(ko,0),Ho.copy(jo).invert(),Wo.copy(Go).invert(),zo.copy(ko).invert();else if(n=t._node.parent){var a=n.getWorldTransform();jo.mul2(a,r.leftViewInv),Go.mul2(a,r.rightViewInv),Ho.copy(jo).invert(),Wo.copy(Go).invert(),zo.copy(n.getWorldTransform()).mul(r.combinedViewInv).invert()}else jo.copy(r.leftViewInv),Go.copy(r.rightViewInv),Ho.copy(r.leftView),Wo.copy(r.rightView),zo.copy(r.combinedView);Bt(Yo,Ho),Bt(Ko,Wo),$o.mul2(xo,Ho),Zo.mul2(So,Wo),Xo.x=jo.data[12],Xo.y=jo.data[13],Xo.z=jo.data[14],qo.x=Go.data[12],qo.y=Go.data[13],qo.z=Go.data[14],Vo.mul2(bo,zo),t.frustum.setFromMat4(Vo)}else if(t.xr&&t.xr.session){(n=t._node.parent)&&(a=n.getWorldTransform()),r=t.xr.views;for(var o=0;o<r.length;o++){var h=r[o];n?(h.viewInvOffMat.mul2(a,h.viewInvMat),h.viewOffMat.copy(h.viewInvOffMat).invert()):(h.viewInvOffMat.copy(h.viewInvMat),h.viewOffMat.copy(h.viewMat)),Bt(h.viewMat3,h.viewOffMat),h.projViewOffMat.mul2(h.projMat,h.viewOffMat),h.position[0]=h.viewInvOffMat.data[12],h.position[1]=h.viewInvOffMat.data[13],h.position[2]=h.viewInvOffMat.data[14],t.frustum.setFromMat4(h.projViewOffMat)}}else bo=t.projectionMatrix,t.calculateProjection&&t.calculateProjection(bo,0),this.projId.setValue(bo.data),this.projSkyboxId.setValue(t.getProjectionMatrixSkybox().data),t.calculateTransform?t.calculateTransform(ko,0):(n=t._node.getPosition(),a=t._node.getRotation(),ko.setTRS(n,a,v.ONE)),this.viewInvId.setValue(ko.data),zo.copy(ko).invert(),this.viewId.setValue(zo.data),Bt(Uo,zo),this.viewId3.setValue(Uo.data),Vo.mul2(bo,zo),this.viewProjId.setValue(Vo.data),n=t._node.getPosition(),this.viewPos[0]=n.x,this.viewPos[1]=n.y,this.viewPos[2]=n.z,this.viewPosId.setValue(this.viewPos),t.frustum.setFromMat4(Vo);this.nearClipId.setValue(t._nearClip),this.farClipId.setValue(t._farClip),n=t._nearClip,a=t._farClip,this.cameraParams[0]=1/a,this.cameraParams[1]=a,this.cameraParams[2]=.5*(1-a/n),this.cameraParams[3]=.5*(1+a/n),this.cameraParamsId.setValue(this.cameraParams),this.clearView(t,e,i,!1),i=this.device,n=e?e.width:i.width,e=e?e.height:i.height,t=t.scissorRect,i.setScissor(Math.floor(t.x*n),Math.floor(t.y*e),Math.floor(t.z*n),Math.floor(t.w*e)),s&&i.setScissor(1,1,n-2,e-2)},clearView:function(t,e,i,s,n){var r=this.device;r.setRenderTarget(e),r.updateBegin(),s&&(r.setColorWrite(!0,!0,!0,!0),r.setDepthWrite(!0)),s=t.rect;var a=e?e.width:r.width,o=e?e.height:r.height;e=Math.floor(s.x*a);var h=Math.floor(s.y*o);a=Math.floor(s.z*a),s=Math.floor(s.w*o),r.setViewport(e,h,a,s),r.setScissor(e,h,a,s),i&&r.clear(n||{color:[t._clearColor.r,t._clearColor.g,t._clearColor.b,t._clearColor.a],depth:t._clearDepth,flags:(t._clearColorBuffer?1:0)|(t._clearDepthBuffer?2:0)|(t._clearStencilBuffer?4:0),stencil:t._clearStencil})},dispatchGlobalLights:function(t){var e;if(this.mainLight=-1,this.ambientColor[0]=t.ambientLight.r,this.ambientColor[1]=t.ambientLight.g,this.ambientColor[2]=t.ambientLight.b,t.gammaCorrection)for(e=0;3>e;e++)this.ambientColor[e]=Math.pow(this.ambientColor[e],2.2);this.ambientId.setValue(this.ambientColor),this.exposureId.setValue(t.exposure),t.skyboxModel&&this.skyboxIntensityId.setValue(t.skyboxIntensity)},_resolveLight:function(t,e){var i="light"+e;this.lightColorId[e]=t.resolve(i+"_color"),this.lightDir[e]=new Float32Array(3),this.lightDirId[e]=t.resolve(i+"_direction"),this.lightShadowMapId[e]=t.resolve(i+"_shadowMap"),this.lightShadowMatrixId[e]=t.resolve(i+"_shadowMatrix"),this.lightShadowParamsId[e]=t.resolve(i+"_shadowParams"),this.lightShadowMatrixVsId[e]=t.resolve(i+"_shadowMatrixVS"),this.lightShadowParamsVsId[e]=t.resolve(i+"_shadowParamsVS"),this.lightDirVs[e]=new Float32Array(3),this.lightDirVsId[e]=t.resolve(i+"_directionVS"),this.lightRadiusId[e]=t.resolve(i+"_radius"),this.lightPos[e]=new Float32Array(3),this.lightPosId[e]=t.resolve(i+"_position"),this.lightInAngleId[e]=t.resolve(i+"_innerConeAngle"),this.lightOutAngleId[e]=t.resolve(i+"_outerConeAngle"),this.lightPosVsId[e]=t.resolve(i+"_positionVS"),this.lightCookieId[e]=t.resolve(i+"_cookie"),this.lightCookieIntId[e]=t.resolve(i+"_cookieIntensity"),this.lightCookieMatrixId[e]=t.resolve(i+"_cookieMatrix"),this.lightCookieOffsetId[e]=t.resolve(i+"_cookieOffset")},dispatchDirectLights:function(t,e,i){var s,n=t.length,r=0;this.mainLight=-1;var a=this.device.scope;for(s=0;s<n;s++)if(t[s].mask&i){var o=t[s],h=o._node.getWorldTransform();if(this.lightColorId[r]||this._resolveLight(a,r),this.lightColorId[r].setValue(e.gammaCorrection?o._linearFinalColor:o._finalColor),h.getY(o._direction).scale(-1),o._direction.normalize(),this.lightDir[r][0]=o._direction.x,this.lightDir[r][1]=o._direction.y,this.lightDir[r][2]=o._direction.z,this.lightDirId[r].setValue(this.lightDir[r]),o.castShadows){var l=o._isPcf&&this.device.webgl2?o._shadowCamera.renderTarget.depthBuffer:o._shadowCamera.renderTarget.colorBuffer;o._isVsm?h=-2e-4:(h=o.shadowBias/o._shadowCamera._farClip*100,!this.device.webgl2&&this.device.extStandardDerivatives&&(h*=-100));var c=o._isVsm?o.vsmBias/(o._shadowCamera._farClip/7):o._normalOffsetBias;this.lightShadowMapId[r].setValue(l),this.lightShadowMatrixId[r].setValue(o._shadowMatrix.data),3!==(l=o._rendererParams).length&&(l.length=3),l[0]=o._shadowResolution,l[1]=c,l[2]=h,this.lightShadowParamsId[r].setValue(l),0>this.mainLight&&(this.lightShadowMatrixVsId[r].setValue(o._shadowMatrix.data),this.lightShadowParamsVsId[r].setValue(l),o._direction.normalize(),this.lightDirVs[r][0]=o._direction.x,this.lightDirVs[r][1]=o._direction.y,this.lightDirVs[r][2]=o._direction.z,this.lightDirVsId[r].setValue(this.lightDirVs[r]),this.mainLight=s)}r++}return r},dispatchPointLight:function(t,e,i,s){var n=i._node.getWorldTransform();this.lightColorId[s]||this._resolveLight(e,s),this.lightRadiusId[s].setValue(i.attenuationEnd),this.lightColorId[s].setValue(t.gammaCorrection?i._linearFinalColor:i._finalColor),n.getTranslation(i._position),this.lightPos[s][0]=i._position.x,this.lightPos[s][1]=i._position.y,this.lightPos[s][2]=i._position.z,this.lightPosId[s].setValue(this.lightPos[s]),i.castShadows&&(this.lightShadowMapId[s].setValue(i._shadowCamera.renderTarget.colorBuffer),4!==(t=i._rendererParams).length&&(t.length=4),t[0]=i._shadowResolution,t[1]=i._normalOffsetBias,t[2]=i.shadowBias,t[3]=1/i.attenuationEnd,this.lightShadowParamsId[s].setValue(t)),i._cookie&&(this.lightCookieId[s].setValue(i._cookie),this.lightShadowMatrixId[s].setValue(n.data),this.lightCookieIntId[s].setValue(i.cookieIntensity))},dispatchSpotLight:function(t,e,i,s){var n=i._node.getWorldTransform();this.lightColorId[s]||this._resolveLight(e,s),this.lightInAngleId[s].setValue(i._innerConeAngleCos),this.lightOutAngleId[s].setValue(i._outerConeAngleCos),this.lightRadiusId[s].setValue(i.attenuationEnd),this.lightColorId[s].setValue(t.gammaCorrection?i._linearFinalColor:i._finalColor),n.getTranslation(i._position),this.lightPos[s][0]=i._position.x,this.lightPos[s][1]=i._position.y,this.lightPos[s][2]=i._position.z,this.lightPosId[s].setValue(this.lightPos[s]),n.getY(i._direction).scale(-1),i._direction.normalize(),this.lightDir[s][0]=i._direction.x,this.lightDir[s][1]=i._direction.y,this.lightDir[s][2]=i._direction.z,this.lightDirId[s].setValue(this.lightDir[s]),i.castShadows&&(i._isVsm?t=-2e-4:(t=20*i.shadowBias,!this.device.webgl2&&this.device.extStandardDerivatives&&(t*=-100)),e=i._isVsm?i.vsmBias/(i.attenuationEnd/7):i._normalOffsetBias,this.lightShadowMapId[s].setValue(i._isPcf&&this.device.webgl2?i._shadowCamera.renderTarget.depthBuffer:i._shadowCamera.renderTarget.colorBuffer),this.lightShadowMatrixId[s].setValue(i._shadowMatrix.data),4!==(n=i._rendererParams).length&&(n.length=4),n[0]=i._shadowResolution,n[1]=e,n[2]=t,n[3]=1/i.attenuationEnd,this.lightShadowParamsId[s].setValue(n)),i._cookie&&(this.lightCookieId[s].setValue(i._cookie),i.castShadows||((e=(t=this.getShadowCamera(this.device,i))._node).setPosition(i._node.getPosition()),e.setRotation(i._node.getRotation()),e.rotateLocal(-90,0,0),t.projection=0,t.aspectRatio=1,t.fov=2*i._outerConeAngle,Fo.setTRS(e.getPosition(),e.getRotation(),v.ONE).invert(),Bo.mul2(t.projectionMatrix,Fo),i._shadowMatrix.mul2(Co,Bo)),this.lightShadowMatrixId[s].setValue(i._shadowMatrix.data),this.lightCookieIntId[s].setValue(i.cookieIntensity),i._cookieTransform&&(i._cookieTransformUniform[0]=i._cookieTransform.x,i._cookieTransformUniform[1]=i._cookieTransform.y,i._cookieTransformUniform[2]=i._cookieTransform.z,i._cookieTransformUniform[3]=i._cookieTransform.w,this.lightCookieMatrixId[s].setValue(i._cookieTransformUniform),i._cookieOffsetUniform[0]=i._cookieOffset.x,i._cookieOffsetUniform[1]=i._cookieOffset.y,this.lightCookieOffsetId[s].setValue(i._cookieOffsetUniform)))},dispatchLocalLights:function(t,e,i,s,n){var r=t[1];t=t[2];var a=r.length,o=t.length,h=s,l=this.device.scope;for(s=0;s<a;s++){var c=r[s];c.mask&i&&!c.isStatic&&(this.dispatchPointLight(e,l,c,h),h++)}if(r=0,n)for(c=n[r];c&&1===c._type;)this.dispatchPointLight(e,l,c,h),h++,c=n[++r];for(s=0;s<o;s++)(c=t[s]).mask&i&&!c.isStatic&&(this.dispatchSpotLight(e,l,c,h),h++);if(n)for(c=n[r];c&&2===c._type;)this.dispatchSpotLight(e,l,c,h),h++,c=n[++r]},cull:function(t,e,i){var s,n=0,r=e.length,a=t.cullingMask||4294967295;if(!t.frustumCulling){for(s=0;s<r;s++){var o=e[s];(o.visible||o.command)&&(o.mask&&0==(o.mask&a)||(i[n]=o,n++,o.visibleThisFrame=!0))}return n}for(s=0;s<r;s++)if((o=e[s]).command)i[n]=o,n++,o.visibleThisFrame=!0;else if(o.visible){var h=!0;o.mask&&0==(o.mask&a)||(o.cull&&(h=o._isVisible(t)),h&&(i[n]=o,n++,o.visibleThisFrame=!0))}return n},cullLights:function(t,e){var i;for(i=0;i<e.length;i++){var s=e[i],n=s._type;s.castShadows&&s.enabled&&0!==s.shadowUpdateMode&&0!==n&&(s.getBoundingSphere(ih),t.frustum.containsSphere(ih)&&(s.visibleThisFrame=!0))}},updateCpuSkinMatrices:function(t){var e,i,s=t.length;if(0!==s)for(e=0;e<s;e++)(i=t[e].skinInstance)&&(i.updateMatrices(t[e].node),i._dirty=!0)},updateGpuSkinMatrices:function(t){var e,i,s=t.length;for(e=0;e<s;e++)t[e].visibleThisFrame&&(i=t[e].skinInstance)&&i._dirty&&(i.updateMatrixPalette(),i._dirty=!1)},updateMorphing:function(t){var e,i,s=t.length;for(e=0;e<s;e++)(i=t[e].morphInstance)&&i._dirty&&t[e].visibleThisFrame&&i.update()},setBaseConstants:function(t,e){t.setCullMode(e.cull),e.opacityMap&&(this.opacityMapId.setValue(e.opacityMap),this.alphaTestId.setValue(e.alphaTest))},setSkinning:function(t,e,i){e.skinInstance&&(this._skinDrawCalls++,t.supportsBoneTextures?(To=e.skinInstance.boneTexture,this.boneTextureId.setValue(To),nh[0]=To.width,nh[1]=To.height,nh[2]=1/To.width,nh[3]=1/To.height,this.boneTextureSizeId.setValue(nh)):this.poseMatrixId.setValue(e.skinInstance.matrixPalette))},drawInstance:function(t,e,i,s,n){if(wo=e.instancingData){if(0<wo.count&&(this._instancedDrawCalls++,t.setVertexBuffer(wo.vertexBuffer),t.draw(i.primitive[s],wo.count),wo.vertexBuffer===ah))return this._removedByInstancing+=wo.count,e.instancingData=null,wo.count-1}else Mo=e.node.worldTransform,this.modelMatrixId.setValue(Mo.data),n&&(Po=e.node.normalMatrix,e.node._dirtyNormal&&(Mo.invertTo3x3(Po),Po.transpose(),e.node._dirtyNormal=!1),this.normalMatrixId.setValue(Po.data)),t.draw(i.primitive[s]);return 0},drawInstance2:function(t,e,i,s){if(wo=e.instancingData){if(0<wo.count&&(this._instancedDrawCalls++,t.setVertexBuffer(wo.vertexBuffer),t.draw(i.primitive[s],wo.count),wo.vertexBuffer===ah))return this._removedByInstancing+=wo.count,e.instancingData=null,wo.count-1}else t.draw(i.primitive[s],void 0,!0);return 0},renderShadows:function(t,e){var i,s=this.device;for(i=0;i<t.length;i++){var n=t[i],r=n._type;if(n.castShadows&&n.enabled&&(n._shadowCamera||this.getShadowCamera(s,n),0!==n.shadowUpdateMode&&n.visibleThisFrame)){var a=this.getShadowCamera(s,n),o=a._node,h=0,l=1;if(0===r){if(0>n._visibleLength[e])continue;h=n._visibleCameraSettings[e],o.setPosition(h.x,h.y,h.z),a.orthoHeight=h.orthoHeight,a.farClip=h.farClip,h=e}else if(2===r){var c=o.getPosition();this.viewPos[0]=c.x,this.viewPos[1]=c.y,this.viewPos[2]=c.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(n.attenuationEnd)}else 1===r&&(c=o.getPosition(),this.viewPos[0]=c.x,this.viewPos[1]=c.y,this.viewPos[2]=c.z,this.viewPosId.setValue(this.viewPos),this.shadowMapLightRadiusId.setValue(n.attenuationEnd),l=6);for(1!==r&&(Fo.setTRS(o.getPosition(),o.getRotation(),v.ONE).invert(),Bo.mul2(a.projectionMatrix,Fo),n._shadowMatrix.mul2(Co,Bo)),s.webgl2?1===r?s.setDepthBias(!1):(s.setDepthBias(!0),s.setDepthBiasValues(-1e3*n.shadowBias,-1e3*n.shadowBias)):s.extStandardDerivatives&&(1===r?(this.polygonOffset[0]=0,this.polygonOffset[1]=0):(this.polygonOffset[0]=-1e3*n.shadowBias,this.polygonOffset[1]=-1e3*n.shadowBias),this.polygonOffsetId.setValue(this.polygonOffset)),1===n.shadowUpdateMode&&(n.shadowUpdateMode=0),this._shadowMapUpdates+=l,s.setBlending(!1),s.setDepthWrite(!0),s.setDepthTest(!0),n._isPcf&&s.webgl2&&1!==r?s.setColorWrite(!1,!1,!1,!1):s.setColorWrite(!0,!0,!0,!0),h?l=h+1:h=0;h<l;){1===r&&(o.setRotation(Oo[h]),a.renderTarget=n._shadowCubeMap[h]),this.setCamera(a,a.renderTarget,!0,1!==r),c=n._visibleList[h];var d=n._visibleLength[h],u=n._shadowType,p=u+5*r;for(u=0;u<d;u++){var f=c[u],m=f.mesh,_=f.material;if(this.setBaseConstants(s,_),this.setSkinning(s,f,_),_.dirty&&(_.updateUniforms(),_.dirty=!1),_.chunks&&(this.setCullMode(!0,!1,f),_.setParameters(s),f.setParameters(s,8)),!(_=f._shader[3+p])){this.updateShader(f,f._shaderDefs,null,3+p),_=f._shader[3+p];var g=f._key,y=f.material,b=f.skinInstance?10:0,x=0;y.opacityMap&&(y=y.opacityMapChannel)&&(x=Io[y]),g[1]=b+x}s.setShader(_),_=f.renderStyle,this.setVertexBuffers(s,m),this.setMorphing(s,f.morphInstance),s.setIndexBuffer(m.indexBuffer[_]),u+=this.drawInstance(s,f,m,_),this._shadowDrawCalls++}h++,0===r&&(n._visibleLength[e]=-1)}if(n._isVsm&&1<(r=n._vsmBlurSize)){if(a=a.renderTarget,o=Dt(s,n._shadowResolution,n._shadowType,1),l=1===n._shadowType,h=n.vsmBlurMode,!(c=(l?this.blurPackedVsmShader:this.blurVsmShader)[h][r])){for(c=this.blurVsmWeights,25<(_=u=r)&&(_=25),g=(_-1)/6,p=.5*(_-1),f=Array(_),m=d=0;m<_;++m)b=m-p,f[m]=Math.exp(-b*b/(2*g*g)),d+=f[m];for(m=0;m<_;++m)f[m]/=d;c[u]=f,c=Ra.fullscreenQuadVS,u="#define SAMPLES "+r+"\n",u=l?u+this.blurPackedVsmShaderCode[h]:u+this.blurVsmShaderCode[h],c=st(this.device,c,u,"blurVsm"+h+r+l),l?this.blurPackedVsmShader[h][r]=c:this.blurVsmShader[h][r]=c}Lo.z=n._shadowResolution-2,Lo.w=Lo.z,this.sourceId.setValue(a.colorBuffer),Do[0]=1/n._shadowResolution,Do[1]=0,this.pixelOffsetId.setValue(Do),1===h&&this.weightId.setValue(this.blurVsmWeights[r]),X(s,o,c,null,Lo),this.sourceId.setValue(o.colorBuffer),Do[1]=Do[0],Do[0]=0,this.pixelOffsetId.setValue(Do),X(s,a,c,null,Lo)}}}s.webgl2?s.setDepthBias(!1):s.extStandardDerivatives&&(this.polygonOffset[0]=0,this.polygonOffset[1]=0,this.polygonOffsetId.setValue(this.polygonOffset))},updateShader:function(t,e,i,s,n){t.material._scene=this.scene,t.material.updateShader(this.device,this.scene,e,i,s,n),t._shader[s]=t.material.shader},setCullMode:function(t,e,i){var s=i.material,n=0;t&&(t=1,0<s.cull&&3>s.cull&&(i.flipFaces&&(t*=-1),e&&(t*=-1),(e=i.node.worldTransform).getX(Qo),e.getY(Jo),e.getZ(th),Qo.cross(Qo,Jo),0>Qo.dot(th)&&(t*=-1)),n=0>t?2===s.cull?1:2:s.cull),this.device.setCullMode(n)},setVertexBuffers:function(t,e){t.setVertexBuffer(e.vertexBuffer)},setMorphing:function(t,e){if(e)if(e.morph.useTextureMorph)t.setVertexBuffer(e.morph.vertexBufferIds),this.morphPositionTex.setValue(e.texturePositions),this.morphNormalTex.setValue(e.textureNormals),this.morphTexParams.setValue(e._textureParams);else{for(var i,s,n=0;n<e._activeVertexBuffers.length;n++)(i=e._activeVertexBuffers[n])&&(s="ATTR"+(n+8),i.format.elements[0].name=s,i.format.elements[0].scopeId=t.scope.resolve(s),i.format.update(),t.setVertexBuffer(i));this.morphWeightsA.setValue(e._shaderMorphWeightsA),this.morphWeightsB.setValue(e._shaderMorphWeightsB)}},renderForward:function(t,e,i,s,n,r,a,o){var h=this.device,l=this.scene,c=t.vrDisplay;o=o?o._lightHash:0;var d,u=1<<n,p=null,f=.5*h.width;for(d=0;d<i;d++){var m=e[d];if(!r||!m.mask||r&m.mask)if(m.command)m.command();else{var _=m.mesh,g=m.material,y=m._shaderDefs,v=m.mask;if(this.setSkinning(h,m,g),g&&g===p&&y!==b&&(p=null),(m.isStatic||S)&&(p=null),g!==p){if(this._materialSwitches++,g.dirty&&(g.updateUniforms(),g.dirty=!1),!m._shader[n]||m._shaderDefs!==y||m._lightHash!==o){if(m.isStatic)this.updateShader(m,y,m._staticLightList,n,s);else{var b=n+"_"+y+"_"+o;m._shader[n]=g.variants[b],m._shader[n]||(this.updateShader(m,y,null,n,s),g.variants[b]=m._shader[n])}m._shaderDefs=y,m._lightHash=o}if(m._shader[n].failed||h.setShader(m._shader[n])||(m._shader[n].failed=!0),g.setParameters(h),!p||v!==x){var x=this.dispatchDirectLights(s[0],l,v);this.dispatchLocalLights(s,l,v,x,m._staticLightList)}this.alphaTestId.setValue(g.alphaTest),h.setBlending(g.blend),g.blend&&(g.separateAlphaBlend?(h.setBlendFunctionSeparate(g.blendSrc,g.blendDst,g.blendSrcAlpha,g.blendDstAlpha),h.setBlendEquationSeparate(g.blendEquation,g.blendAlphaEquation)):(h.setBlendFunction(g.blendSrc,g.blendDst),h.setBlendEquation(g.blendEquation))),h.setColorWrite(g.redWrite,g.greenWrite,g.blueWrite,g.alphaWrite),h.setDepthWrite(g.depthWrite),h.setDepthTest(g.depthTest),h.setAlphaToCoverage(g.alphaToCoverage),g.depthBias||g.slopeDepthBias?(h.setDepthBias(!0),h.setDepthBiasValues(g.depthBias,g.slopeDepthBias)):h.setDepthBias(!1)}if(this.setCullMode(t._cullFaces,t._flipFaces,m),x=m.stencilFront||g.stencilFront,p=m.stencilBack||g.stencilBack,x||p?(h.setStencilTest(!0),x===p?(h.setStencilFunc(x.func,x.ref,x.readMask),h.setStencilOperation(x.fail,x.zfail,x.zpass,x.writeMask)):(x?(h.setStencilFuncFront(x.func,x.ref,x.readMask),h.setStencilOperationFront(x.fail,x.zfail,x.zpass,x.writeMask)):(h.setStencilFuncFront(7,0,255),h.setStencilOperationFront(0,0,0,255)),p?(h.setStencilFuncBack(p.func,p.ref,p.readMask),h.setStencilOperationBack(p.fail,p.zfail,p.zpass,p.writeMask)):(h.setStencilFuncBack(7,0,255),h.setStencilOperationBack(0,0,0,255)))):h.setStencilTest(!1),m.setParameters(h,u),this.setVertexBuffers(h,_),this.setMorphing(h,m.morphInstance),x=m.renderStyle,h.setIndexBuffer(_.indexBuffer[x]),a&&a(m,d),c&&c.presenting)h.setViewport(0,0,f,h.height),this.projId.setValue(xo.data),this.projSkyboxId.setValue(xo.data),this.viewInvId.setValue(jo.data),this.viewId.setValue(Ho.data),this.viewId3.setValue(Yo.data),this.viewProjId.setValue($o.data),this.viewPos[0]=Xo.x,this.viewPos[1]=Xo.y,this.viewPos[2]=Xo.z,this.viewPosId.setValue(this.viewPos),d+=this.drawInstance(h,m,_,x,!0),this._forwardDrawCalls++,h.setViewport(f,0,f,h.height),this.projId.setValue(So.data),this.projSkyboxId.setValue(So.data),this.viewInvId.setValue(Go.data),this.viewId.setValue(Wo.data),this.viewId3.setValue(Ko.data),this.viewProjId.setValue(Zo.data),this.viewPos[0]=qo.x,this.viewPos[1]=qo.y,this.viewPos[2]=qo.z,this.viewPosId.setValue(this.viewPos),d+=this.drawInstance2(h,m,_,x),this._forwardDrawCalls++;else if(t.xr&&t.xr.session&&t.xr.views.length)for(p=t.xr.views,b=0;b<p.length;b++){var S=p[b];h.setViewport(S.viewport.x,S.viewport.y,S.viewport.z,S.viewport.w),this.projId.setValue(S.projMat.data),this.projSkyboxId.setValue(S.projMat.data),this.viewId.setValue(S.viewOffMat.data),this.viewInvId.setValue(S.viewInvOffMat.data),this.viewId3.setValue(S.viewMat3.data),this.viewProjId.setValue(S.projViewOffMat.data),this.viewPosId.setValue(S.position),d=0===b?d+this.drawInstance(h,m,_,x,!0):d+this.drawInstance2(h,m,_,x),this._forwardDrawCalls++}else d+=this.drawInstance(h,m,_,x,!0),this._forwardDrawCalls++;d<i-1&&e[d+1].material===g&&g.setParameters(h,m.parameters),p=g,b=y,x=v,S=m.isStatic}}h.updateEnd()},setupInstancing:function(t){t.enableAutoInstancing&&(ah||(ah=new C(t,O.defaultInstancingFormat,t.autoInstancingMaxObjects,1)))},revertStaticMeshes:function(t){var e,i=t.length,s=[];for(e=0;e<i;e++){var n=t[e];if(n._staticSource){if(n._staticSource!==r){s.push(n._staticSource);var r=n._staticSource}}else s.push(n)}for(t.length=s.length,e=0;e<s.length;e++)t[e]=s[e]},prepareStaticMeshes:function(t,e){var i,s,n,r,a,o,h,l,c=this.device,d=t.length,u=[],p=new v,f=new v,m=new T,_=new x,g=[],y=[],b=[],S=[];for(i=0;i<d;i++){var w=t[i];if(w.isStatic){var M=w.aabb;for(S.length=0,l=1;2>=l;l++)for(s=0;s<e.length;s++){var P=e[s];P._type===l&&P.enabled&&P.mask&w.mask&&P.isStatic&&(y[s]||(y[s]=new T,P._node.getWorldTransform(),P.getBoundingSphere(ih),y[s].center.copy(ih.center),y[s].halfExtents.x=ih.radius,y[s].halfExtents.y=ih.radius,y[s].halfExtents.z=ih.radius),y[s].intersects(M)&&S.push(s))}if(0===S.length)u.push(w);else{l=(M=w.mesh).vertexBuffer;var A=2===(P=M.indexBuffer[w.renderStyle]).bytesPerIndex?new Uint16Array(P.lock()):new Uint32Array(P.lock()),E=M.primitive[w.renderStyle].count/3,C=M.primitive[w.renderStyle].base,I=l.format.elements,O=l.format.size/4;for(M=new Float32Array(l.storage),n=0;n<I.length;n++)"POSITION"===I[n].name&&(a=I[n].offset/4);for(g.length=E,n=0;n<E;n++)g[n]=0;for(I=!1,b.length=6*E,n=0;n<E;n++){var R=h=o=Number.MAX_VALUE,D=-Number.MAX_VALUE,L=-Number.MAX_VALUE,F=-Number.MAX_VALUE;for(r=0;3>r;r++){var B=M[s=(s=A[3*n+r+C])*O+a],N=M[s+1];B<o&&(o=B),N<h&&(h=N),(s=M[s+2])<R&&(R=s),B>D&&(D=B),N>L&&(L=N),s>F&&(F=s)}b[s=6*n]=o,b[s+1]=h,b[s+2]=R,b[s+3]=D,b[s+4]=L,b[s+5]=F}for(B=0;B<S.length;B++)for(s=S[B],_.copy(w.node.worldTransform).invert(),m.setFromTransformedAabb(y[s],_),N=m.getMin(),o=m.getMax(),r=1<<B,n=0;n<E;n++)b[s=6*n]<=o.x&&b[s+3]>=N.x&&b[s+1]<=o.y&&b[s+4]>=N.y&&b[s+2]<=o.z&&b[s+5]>=N.z&&(g[n]|=r,I=!0);if(I){for(I={},n=0;n<E;n++){s=3*n+C;var k=g[n];I[k]||(I[k]=[]),(r=I[k]).push(A[s]),r.push(A[s+1]),r.push(A[s+2])}for(k in I){for(r=I[k],(2===(A=new rt(c,P.format,r.length,P.usage)).bytesPerIndex?new Uint16Array(A.lock()):new Uint32Array(A.lock())).set(r),A.unlock(),R=h=o=Number.MAX_VALUE,D=-Number.MAX_VALUE,L=-Number.MAX_VALUE,F=-Number.MAX_VALUE,n=0;n<r.length;n++)(B=M[(s=r[n])*O+a])<o&&(o=B),(N=M[s*O+a+1])<h&&(h=N),(s=M[s*O+a+2])<R&&(R=s),B>D&&(D=B),N>L&&(L=N),s>F&&(F=s);for(p.set(o,h,R),f.set(D,L,F),(n=new T).setMinMax(p,f),(E=new ht(c)).vertexBuffer=l,E.indexBuffer[0]=A,E.primitive[0].type=4,E.primitive[0].base=0,E.primitive[0].count=r.length,E.primitive[0].indexed=!0,E.aabb=n,(A=new lt(w.node,E,w.material)).isStatic=w.isStatic,A.visible=w.visible,A.layer=w.layer,A.castShadow=w.castShadow,A._receiveShadow=w._receiveShadow,A.cull=w.cull,A.pick=w.pick,A.mask=w.mask,A.parameters=w.parameters,A._shaderDefs=w._shaderDefs,A._staticSource=w,A._staticLightList=w._staticLightList?w._staticLightList:[],n=0;n<S.length;n++)k&(r=1<<n)&&(E=e[S[n]],0>A._staticLightList.indexOf(E)&&A._staticLightList.push(E));A._staticLightList.sort(this.lightCompare),u.push(A)}}else u.push(w)}}else u.push(w)}for(t.length=u.length,i=0;i<u.length;i++)t[i]=u[i]},updateShaders:function(t){var e,i=[];for(e=0;e<t.length;e++){var s=t[e];void 0!==s.material&&-1===i.indexOf(s.material)&&i.push(s.material)}for(e=0;e<i.length;e++)(t=i[e]).updateShader!==nr.prototype.updateShader&&(t.clearVariants(),t.shader=null)},updateLitShaders:function(t){for(var e=0;e<t.length;e++){var i=t[e];void 0!==i.material&&((i=i.material).updateShader===nr.prototype.updateShader||!1===i.useLighting||i.emitter&&!i.emitter.lighting||(i.clearVariants(),i.shader=null))}},beginFrame:function(t){var e=this.scene,i=t._meshInstances;t=t._lights,e.updateShaders?(this.updateShaders(i),e.updateShaders=!1,e.updateLitShaders=!1,e._shaderVersion++):e.updateLitShaders&&(this.updateLitShaders(i),e.updateLitShaders=!1,e._shaderVersion++),this.updateCpuSkinMatrices(i);var s=i.length;for(e=0;e<s;e++)i[e].visibleThisFrame=!1;for(s=t.length,e=0;e<s;e++)t[e].visibleThisFrame=0===t[e]._type},beginLayers:function(t){var e,i=this.scene,s=t.layerList.length,n=this.scene._shaderVersion;for(e=0;e<s;e++)t.layerList[e]._postRenderCounter=0;for(e=0;e<s;e++){var r=t.layerList[e];r._shaderVersion=n,r._preRenderCalledForCameras=0,r._postRenderCalledForCameras=0;var a=t.subLayerList[e];for(r._postRenderCounter=a?2|r._postRenderCounter:1|r._postRenderCounter,r._postRenderCounterMax=r._postRenderCounter,a=0;a<r.cameras.length;a++)r.instances.visibleOpaque[a]||(r.instances.visibleOpaque[a]=new Et),r.instances.visibleTransparent[a]||(r.instances.visibleTransparent[a]=new Et),r.instances.visibleOpaque[a].done=!1,r.instances.visibleTransparent[a].done=!1;r.cameras.length<r.instances.visibleOpaque.length&&r.instances.visibleOpaque.splice(r.cameras.length,1),r.cameras.length<r.instances.visibleTransparent.length&&r.instances.visibleTransparent.splice(r.cameras.length,1),r._needsStaticPrepare&&r._staticLightHash&&(r._staticPrepareDone&&(this.revertStaticMeshes(r.opaqueMeshInstances),this.revertStaticMeshes(r.transparentMeshInstances)),this.prepareStaticMeshes(r.opaqueMeshInstances,r._lights),this.prepareStaticMeshes(r.transparentMeshInstances,r._lights),t._dirty=!0,i.updateShaders=!0,r._needsStaticPrepare=!1,r._staticPrepareDone=!0)}},cullLocalShadowmap:function(t,e){var i,s,n,r,a=t._type;if(0!==a){t.visibleThisFrame=!0;var o=this.getShadowCamera(this.device,t);if(o.projection=0,o.nearClip=t.attenuationEnd/1e3,o.farClip=t.attenuationEnd,o.aspectRatio=1,2===a){o.fov=2*t._outerConeAngle;var h=1}else o.fov=90,h=6;var l=o._node,c=t._node;for(l.setPosition(c.getPosition()),2===a&&(l.setRotation(c.getRotation()),l.rotateLocal(-90,0,0)),i=0;i<h;i++){for(1===a&&(l.setRotation(Oo[i]),o.renderTarget=t._shadowCubeMap[i]),this.updateCameraFrustum(o),(n=t._visibleList[i])||(n=t._visibleList[i]=[]),c=r=t._visibleLength[i]=0,s=e.length;c<s;c++){var d=e[c],u=!0;d.cull&&(u=d._isVisible(o)),u&&(n[r]=d,r++,d.visibleThisFrame=!0)}t._visibleLength[i]=r,n.length!==r&&(n.length=r),n.sort(this.depthSortCompare)}}},cullDirectionalShadowmap:function(t,e,i,s){var n=this.device;t.visibleThisFrame=!0;var r=(n=this.getShadowCamera(n,t))._node,a=t._node;r.setPosition(a.getPosition()),r.setRotation(a.getRotation()),r.rotateLocal(-90,0,0);var o=t.shadowDistance||i._farClip,h=i._nearClip,l=i._fov*Math.PI/180,c=i._aspectRatio,d=i._projection,u=0===d?Math.tan(l/2)*h:i._orthoHeight,p=u*c;for(oh[0].x=p,oh[0].y=-u,oh[0].z=-h,oh[1].x=p,oh[1].y=u,oh[1].z=-h,oh[2].x=-p,oh[2].y=u,oh[2].z=-h,oh[3].x=-p,oh[3].y=-u,oh[3].z=-h,0===d&&(p=(u=Math.tan(l/2)*o)*c),oh[4].x=p,oh[4].y=-u,oh[4].z=-o,oh[5].x=p,oh[5].y=u,oh[5].z=-o,oh[6].x=-p,oh[6].y=u,oh[6].z=-o,oh[7].x=-p,oh[7].y=-u,oh[7].z=-o,c=eh.sub2(oh[0],oh[6]).length(),c=Math.max(c,eh.sub2(oh[4],oh[6]).length()),Fo.copy(r.getWorldTransform()).invert(),No.copy(Fo).mul(i._node.getWorldTransform()),l=0;8>l;l++)No.transformPoint(oh[l],oh[l]);for(o=h=i=1e6,p=u=d=-1e6,l=0;8>l;l++){var f=oh[l];f.x<o&&(o=f.x),f.x>p&&(p=f.x),f.y<h&&(h=f.y),f.y>u&&(u=f.y),f.z<i&&(i=f.z),f.z>d&&(d=f.z)}for(l=c/t._shadowResolution,o=.5*((o=Math.floor((o-.5*(c-(p-o)))/l)*l)+c+o),h=.5*((h=Math.floor((h-.5*(c-(u-h)))/l)*l)+c+h),r.translateLocal(o,h,1e5),n.projection=1,n.nearClip=0,n.farClip=2e5,n.aspectRatio=1,n.orthoHeight=.5*c,this.updateCameraFrustum(n),u=!0,(d=t._visibleList[s])||(d=t._visibleList[s]=[]),l=c=t._visibleLength[s]=0,p=e.length;l<p;l++){var m=e[l];f=!0,m.cull&&(f=m._isVisible(n)),f&&(d[c]=m,c++,m.visibleThisFrame=!0,f=m.aabb,u?(sh.copy(f),u=!1):sh.add(f))}for(t._visibleLength[s]=c,d.length!==c&&(d.length=c),d.sort(this.depthSortCompare),e=sh.getMin(),l=sh.getMax(),lh[0].x=lh[1].x=lh[2].x=lh[3].x=e.x,lh[1].y=lh[3].y=lh[7].y=lh[5].y=e.y,lh[2].z=lh[3].z=lh[6].z=lh[7].z=e.z,lh[4].x=lh[5].x=lh[6].x=lh[7].x=l.x,lh[0].y=lh[2].y=lh[4].y=lh[6].y=l.y,lh[0].z=lh[1].z=lh[4].z=lh[5].z=l.z,l=9999999999,e=-9999999999,d=0;8>d;++d)Fo.transformPoint(lh[d],lh[d]),(c=lh[d].z)<l&&(l=c),c>e&&(e=c);d=e,l>i&&(i=l),r.setPosition(a.getPosition()),r.translateLocal(o,h,d+.01),n.farClip=d-i,(a=t._visibleCameraSettings[s])||(a=t._visibleCameraSettings[s]={}),t=r.getPosition(),a.x=t.x,a.y=t.y,a.z=t.z,a.orthoHeight=n.orthoHeight,a.farClip=n.farClip},gpuUpdate:function(t){this.updateGpuSkinMatrices(t),this.updateMorphing(t)},setSceneConstants:function(){var t,e=this.device,i=this.scene;if(this.dispatchGlobalLights(i),"none"!==i.fog){if(this.fogColor[0]=i.fogColor.r,this.fogColor[1]=i.fogColor.g,this.fogColor[2]=i.fogColor.b,i.gammaCorrection)for(t=0;3>t;t++)this.fogColor[t]=Math.pow(this.fogColor[t],2.2);this.fogColorId.setValue(this.fogColor),"linear"===i.fog?(this.fogStartId.setValue(i.fogStart),this.fogEndId.setValue(i.fogEnd)):this.fogDensityId.setValue(i.fogDensity)}this._screenSize[0]=e.width,this._screenSize[1]=e.height,this._screenSize[2]=1/e.width,this._screenSize[3]=1/e.height,this.screenSizeId.setValue(this._screenSize)},renderComposition:function(t){var e,i,s,n,r,a=this.device,o=t._renderedRt,h=t._renderedByCam,l=t._renderedLayer;this.scene.updateSkybox&&(this.scene._updateSkybox(a),this.scene.updateSkybox=!1),this.beginLayers(t),2&t._update()&&(this.scene.updateLitShaders=!0),this.beginFrame(t),this.setSceneConstants();var c=0;for(i=0;i<t.layerList.length;i++){var d=t.layerList[i];if(d.enabled&&t.subLayerEnabled[i]){var u=t.subLayerList[i],p=d.instances,f=d.cameras;for(s=0;s<f.length;s++)if(e=f[s]){e.frameBegin(d.renderTarget);var m=u?d.transparentMeshInstances:d.opaqueMeshInstances,_=r=!1;for(n=0;n<c;n++)if(h[n]===e&&(r=!0,l[n]===d)){_=!0;break}r||(this.updateCameraFrustum(e.camera),this._camerasRendered++),_||this.cullLights(e.camera,d._lights),r&&_||(h[c]=e,l[c]=d,c++),(n=u?p.visibleTransparent[s]:p.visibleOpaque[s]).done||(d.onPreCull&&d.onPreCull(s),n.length=this.cull(e.camera,m,n.list),n.done=!0,d.onPostCull&&d.onPostCull(s)),e.frameEnd()}}}for(i=0;i<t._lights.length;i++)(e=t._lights[i]).visibleThisFrame&&0!==e._type&&e.castShadows&&e.enabled&&0!==e.shadowUpdateMode&&(d=t._lightShadowCasters[i],this.cullLocalShadowmap(e,d));for(u=-1,i=0;i<t._lights.length;i++)if(0===(e=t._lights[i])._type&&(u++,e.castShadows&&e.enabled&&0!==e.shadowUpdateMode))for(d=t._lightShadowCasters[i],f=t._globalLightCameras[u],s=0;s<f.length;s++)this.cullDirectionalShadowmap(e,d,f[s].camera,t._globalLightCameraIds[u][s]);for(this.gpuUpdate(t._meshInstances),this.renderShadows(t._sortedLights[2]),this.renderShadows(t._sortedLights[1]),i=c=0;i<t._renderList.length;i++)if((d=t.layerList[t._renderList[i]]).enabled&&t.subLayerEnabled[t._renderList[i]]){if(p=d.instances,u=t.subLayerList[t._renderList[i]],f=t._renderListCamera[i],(e=d.cameras[f])&&e.frameBegin(d.renderTarget),!u&&d.onPreRenderOpaque?d.onPreRenderOpaque(f):u&&d.onPreRenderTransparent&&d.onPreRenderTransparent(f),d._preRenderCalledForCameras&1<<f||(d.onPreRender&&d.onPreRender(f),d._preRenderCalledForCameras|=1<<f,d.overrideClear&&this.clearView(e.camera,d.renderTarget,!0,!0,d._clearOptions)),e){for(s=d.renderTarget,l=!1,n=0;n<c;n++)if(o[n]===s&&h[n]===e){l=!0;break}l||(d.overrideClear||this.clearView(e.camera,d.renderTarget,!0,!0),o[c]=s,h[c]=e,c++),this.renderShadows(d._sortedLights[0],f),d._sortVisible(u,e.camera.node,f),n=u?p.visibleTransparent[f]:p.visibleOpaque[f],this.scene._activeCamera=e.camera,this.setCamera(e.camera,d.renderTarget),this.renderForward(e.camera,n.list,n.length,d._sortedLights,d.shaderPass,d.cullingMask,d.onDrawCall,d),a.setColorWrite(!0,!0,!0,!0),a.setStencilTest(!1),a.setAlphaToCoverage(!1),a.setDepthBias(!1),e.frameEnd()}!u&&d.onPostRenderOpaque?d.onPostRenderOpaque(f):u&&d.onPostRenderTransparent&&d.onPostRenderTransparent(f),!d.onPostRender||d._postRenderCalledForCameras&1<<f||(d._postRenderCounter&=~(u?2:1),0===d._postRenderCounter&&(d.onPostRender(f),d._postRenderCalledForCameras|=1<<f,d._postRenderCounter=d._postRenderCounterMax))}}}),Nt.prototype=Object.create(nr.prototype),Nt.prototype.constructor=Nt,Object.assign(Nt.prototype,{clone:function(){var t=new Nt;return nr.prototype._cloneInternal.call(this,t),t.color.copy(this.color),t.colorMap=this.colorMap,t.vertexColors=this.vertexColors,t},updateUniforms:function(){this.clearParameters(),this.colorUniform[0]=this.color.r,this.colorUniform[1]=this.color.g,this.colorUniform[2]=this.color.b,this.colorUniform[3]=this.color.a,this.setParameter("uColor",this.colorUniform),this.colorMap&&this.setParameter("texture_diffuseMap",this.colorMap)},updateShader:function(t,e,i,s,n,r){e={skin:!!this.meshInstances[0].skinInstance,vertexColors:this.vertexColors,diffuseMap:!!this.colorMap,pass:n},this.shader=t.getProgramLibrary().getProgram("basic",e)}});var ch=new Mt;kt.prototype.addLayer=function(t){0>this.layers.indexOf(t)&&this.layers.push(t)},kt.prototype.getLayerIdx=function(t){return this.layerToBatch[t.id]},kt.prototype.addLayerIdx=function(t,e){this.layerToBatch[e.id]=t},Object.assign(zt.prototype,{init:function(t,e,i,s){for(this.mesh||(this.mesh=new ht(t),this.mesh.primitive[0].type=1,this.mesh.primitive[0].base=0,this.mesh.primitive[0].indexed=!1,this.material=new Nt,this.material.vertexColors=!0,this.material.blend=!0,this.material.blendType=2,this.material.update()),this.layer=i;this.linesUsed+s>this.numLinesAllocated;)this.vb&&(this.vb.destroy(),this.vb=null),this.numLinesAllocated*=2;this.vertexFormat=e,this.vb||(this.vb=new C(t,e,2*this.numLinesAllocated,1),this.mesh.vertexBuffer=this.vb,this.vbRam=new DataView(this.vb.lock()),this.meshInstance||(ch.worldTransform=x.IDENTITY,ch._dirtyWorld=ch._dirtyNormal=!1,this.meshInstance=new lt(ch,this.mesh,this.material),this.meshInstance.cull=!1))},addLines:function(t,e){for(var i,s=!!e.length,n=2*this.linesUsed*this.vertexFormat.size,r=0;r<t.length;r++)this.vbRam.setFloat32(n,t[r].x,!0),n+=4,this.vbRam.setFloat32(n,t[r].y,!0),n+=4,this.vbRam.setFloat32(n,t[r].z,!0),n+=4,i=s?e[r]:e,this.vbRam.setUint8(n,255*i.r),n+=1,this.vbRam.setUint8(n,255*i.g),n+=1,this.vbRam.setUint8(n,255*i.b),n+=1,this.vbRam.setUint8(n,255*i.a),n+=1;this.linesUsed+=t.length/2},finalize:function(t){0<this.linesUsed&&(this.vb.setData(this.vbRam.buffer),this.mesh.primitive[0].count=2*this.linesUsed,t[0]=this.meshInstance,this.layer.addMeshInstances(t,!0),this.linesUsed=0)}}),Ut.prototype=Object.create(n.prototype),Ut.prototype.constructor=Ut,Ut.prototype._sortLights=function(t){var e=t._lights;t._sortedLights[0].length=0,t._sortedLights[1].length=0;for(var i=t._sortedLights[2].length=0;i<e.length;i++){var s=e[i];s.enabled&&t._sortedLights[s._type].push(s)}},Ut.prototype._update=function(){var t,e,i=this.layerList.length,s=0;if(!this._dirty||!this._dirtyLights||!this._dirtyCameras)for(t=0;t<i;t++){var n=this.layerList[t];n._dirty&&(this._dirty=!0),n._dirtyLights&&(this._dirtyLights=!0),n._dirtyCameras&&(this._dirtyCameras=!0)}if(this._dirty){for(s|=1,t=this._meshInstances.length=0;t<i;t++)if(!(n=this.layerList[t]).passThrough){var r=n.opaqueMeshInstances;for(e=0;e<r.length;e++){var a=r[e];0>this._meshInstances.indexOf(a)&&(this._meshInstances.push(a),a.material&&a.material._dirtyBlend&&(this._dirtyBlend=!0,a.material._dirtyBlend=!1))}for(r=n.transparentMeshInstances,e=0;e<r.length;e++)a=r[e],0>this._meshInstances.indexOf(a)&&(this._meshInstances.push(a),a.material&&a.material._dirtyBlend&&(this._dirtyBlend=!0,a.material._dirtyBlend=!1))}for(t=0;t<i;t++)this.layerList[t]._dirty=!1,this.layerList[t]._version++;this._dirty=!1}if(this._dirtyBlend){for(s|=8,t=0;t<i;t++)if(!(n=this.layerList[t]).passThrough){r=n.opaqueMeshInstances,a=n.transparentMeshInstances;var o=[],h=[];for(e=0;e<r.length;e++)r[e].material&&3!==r[e].material.blendType?h.push(r[e]):o.push(r[e]);for(e=0;e<a.length;e++)a[e].material&&3!==a[e].material.blendType?h.push(a[e]):o.push(a[e]);for(n.opaqueMeshInstances.length=o.length,e=0;e<o.length;e++)n.opaqueMeshInstances[e]=o[e];for(n.transparentMeshInstances.length=h.length,e=0;e<h.length;e++)n.transparentMeshInstances[e]=h[e]}this._dirtyBlend=!1}if(this._dirtyLights){for(s|=2,this._lights.length=0,t=this._lightShadowCasters.length=0;t<i;t++)for(r=(n=this.layerList[t])._lights,e=0;e<r.length;e++)o=r[e],0>(a=this._lights.indexOf(o))&&(this._lights.push(o),a=this._lights.length-1),(o=this._lightShadowCasters[a])||(this._lightShadowCasters[a]=[]);for(this._sortLights(this),this._dirtyLights=!1,t=0;t<i;t++)n=this.layerList[t],this._sortLights(n),n._dirtyLights=!1}if(s)for(t=0;t<i;t++)for(r=(n=this.layerList[t])._lights,e=0;e<r.length;e++){for(o=r[e],a=this._lights.indexOf(o),o=this._lightShadowCasters[a],h=n.shadowCasters,a=0;a<o.length;)0>this._meshInstances.indexOf(o[a])?(o[a]=o[o.length-1],--o.length):a++;for(a=0;a<h.length;a++)0>o.indexOf(h[a])&&o.push(h[a])}if(2&s||this._dirtyCameras)for(this._globalLightCameras.length=0,r=this._sortedLights[0],e=0;e<r.length;e++)for(o=r[e],this._globalLightCameras[e]=[],t=0;t<i;t++)if(!(0>(n=this.layerList[t])._sortedLights[0].indexOf(o)))for(a=0;a<n.cameras.length;a++)0<=this._globalLightCameras[e].indexOf(n.cameras[a])||this._globalLightCameras[e].push(n.cameras[a]);if(this._dirtyCameras){for(s|=4,t=this.cameras.length=0;t<i;t++)for(n=this.layerList[t],e=0;e<n.cameras.length;e++)r=n.cameras[e],0>(a=this.cameras.indexOf(r))&&this.cameras.push(r);for(this._renderList.length=0,t=a=this._renderListCamera.length=0;t<i;t++)if(a)a--;else if(0!==(n=this.layerList[t]).cameras.length||n.isPostEffect)if(0===(o=n._cameraHash))this._renderList.push(t),this._renderListCamera.push(0);else{for(r=1,e=t+1;e<i;e++){if(o!==(h=this.layerList[e]._cameraHash)){r=e-t-1;break}e===i-1&&(r=e-t)}if(1===r)for(o=0;o<n.cameras.length;o++)this._renderList.push(t),this._renderListCamera.push(o);else{for(o=0;o<n.cameras.length;o++)for(e=0;e<=r;e++)this._renderList.push(t+e),this._renderListCamera.push(o);a=r}}for(this._dirtyCameras=!1,t=0;t<i;t++)this.layerList[t]._dirtyCameras=!1}if(2&s||4&s)for(e=this._globalLightCameraIds.length=0;e<this._globalLightCameras.length;e++){for(r=[],t=0;t<this._globalLightCameras[e].length;t++)0>(a=this.cameras.indexOf(this._globalLightCameras[e][t]))||r.push(a);this._globalLightCameraIds.push(r)}return s},Ut.prototype._isLayerAdded=function(t){return 0<=this.layerList.indexOf(t)},Ut.prototype._isSublayerAdded=function(t,e){for(var i=0;i<this.layerList.length;i++)if(this.layerList[i]===t&&this.subLayerList[i]===e)return!0;return!1},Ut.prototype.push=function(t){this._isLayerAdded(t)||(this.layerList.push(t),this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",t))},Ut.prototype.insert=function(t,e){if(!this._isLayerAdded(t)){this.layerList.splice(e,0,t,t),this.subLayerList.splice(e,0,!1,!0);var i=this.layerList.length;this._updateOpaqueOrder(e,i-1),this._updateTransparentOrder(e,i-1),this.subLayerEnabled.splice(e,0,!0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",t)}},Ut.prototype.remove=function(t){var e=this.layerList.indexOf(t);for(delete this._opaqueOrder[e],delete this._transparentOrder[e];0<=e;)this.layerList.splice(e,1),this.subLayerList.splice(e,1),this.subLayerEnabled.splice(e,1),e=this.layerList.indexOf(t),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("remove",t);t=this.layerList.length,this._updateOpaqueOrder(0,t-1),this._updateTransparentOrder(0,t-1)},Ut.prototype.pushOpaque=function(t){this._isSublayerAdded(t,!1)||(this.layerList.push(t),this._opaqueOrder[t.id]=this.subLayerList.push(!1)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",t))},Ut.prototype.insertOpaque=function(t,e){this._isSublayerAdded(t,!1)||(this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!1),this._updateOpaqueOrder(e,this.subLayerList.length-1),this.subLayerEnabled.splice(e,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",t))},Ut.prototype.removeOpaque=function(t){for(var e=0,i=this.layerList.length;e<i;e++)if(this.layerList[e]===t&&!this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),i--,this._updateOpaqueOrder(e,i-1),this.subLayerEnabled.splice(e,1),this._dirtyCameras=this._dirtyLights=this._dirty=!0,0>this.layerList.indexOf(t)&&this.fire("remove",t);break}},Ut.prototype.pushTransparent=function(t){this._isSublayerAdded(t,!0)||(this.layerList.push(t),this._transparentOrder[t.id]=this.subLayerList.push(!0)-1,this.subLayerEnabled.push(!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",t))},Ut.prototype.insertTransparent=function(t,e){this._isSublayerAdded(t,!0)||(this.layerList.splice(e,0,t),this.subLayerList.splice(e,0,!0),this._updateTransparentOrder(e,this.subLayerList.length-1),this.subLayerEnabled.splice(e,0,!0),this._dirtyCameras=this._dirtyLights=this._dirty=!0,this.fire("add",t))},Ut.prototype.removeTransparent=function(t){for(var e=0,i=this.layerList.length;e<i;e++)if(this.layerList[e]===t&&this.subLayerList[e]){this.layerList.splice(e,1),this.subLayerList.splice(e,1),i--,this._updateTransparentOrder(e,i-1),this.subLayerEnabled.splice(e,1),this._dirtyCameras=this._dirtyLights=this._dirty=!0,0>this.layerList.indexOf(t)&&this.fire("remove",t);break}},Ut.prototype._getSublayerIndex=function(t,e){var i=this.layerList.indexOf(t);return 0>i||this.subLayerList[i]!==e&&(0>(i=this.layerList.indexOf(t,i+1))||this.subLayerList[i]!==e)?-1:i},Ut.prototype.getOpaqueIndex=function(t){return this._getSublayerIndex(t,!1)},Ut.prototype.getTransparentIndex=function(t){return this._getSublayerIndex(t,!0)},Ut.prototype.getLayerById=function(t){for(var e=0;e<this.layerList.length;e++)if(this.layerList[e].id===t)return this.layerList[e];return null},Ut.prototype.getLayerByName=function(t){for(var e=0;e<this.layerList.length;e++)if(this.layerList[e].name===t)return this.layerList[e];return null},Ut.prototype._updateOpaqueOrder=function(t,e){for(;t<=e;t++)!1===this.subLayerList[t]&&(this._opaqueOrder[this.layerList[t].id]=t)},Ut.prototype._updateTransparentOrder=function(t,e){for(;t<=e;t++)!0===this.subLayerList[t]&&(this._transparentOrder[this.layerList[t].id]=t)},Ut.prototype._sortLayersDescending=function(t,e,i){var s,n=-1,r=-1,a=0;for(s=t.length;a<s;a++){var o=t[a];i.hasOwnProperty(o)&&(n=Math.max(n,i[o]))}for(a=0,s=e.length;a<s;a++)o=e[a],i.hasOwnProperty(o)&&(r=Math.max(r,i[o]));return-1===n&&-1!==r?1:-1===r&&-1!==n?-1:r-n},Ut.prototype.sortTransparentLayers=function(t,e){return this._sortLayersDescending(t,e,this._transparentOrder)},Ut.prototype.sortOpaqueLayers=function(t,e){return this._sortLayersDescending(t,e,this._opaqueOrder)};var dh,uh=[],ph=[],fh=new v,mh=new T,_h=new T,gh={},yh=["texture_lightMap","texture_dirLightMap"],vh=[];Object.assign(jt.prototype,{destroy:function(){this.assets=this.renderer=this.scene=this.root=this.device=null},calculateLightmapSize:function(t){var e=this.scene.lightmapSizeMultiplier||16,i=1,s=1,n=1,r=1;if(t.model.asset){var a=this.assets.get(t.model.asset).data;a.area&&(i=a.area.x,s=a.area.y,n=a.area.z,r=a.area.uv)}else t.model._area&&((a=t.model)._area&&(i=a._area.x,s=a._area.y,n=a._area.z,r=a._area.uv));for(i*=a=t.model.lightmapSizeMultiplier||1,s*=a,n*=a,fh.copy(t.localScale),t=t._parent;t;)fh.mul(t.localScale),t=t._parent;return fh.x=Math.abs(fh.x),fh.y=Math.abs(fh.y),fh.z=Math.abs(fh.z),i=i*fh.y*fh.z+s*fh.x*fh.z+n*fh.x*fh.y,i=Math.sqrt(i/r),Math.min(oa.nextPowerOfTwo(i*e),this.scene.lightmapMaxResolution||2048)},bake:function(t,e){var i,s,n,r=this.device,a=this.scene,h=1;void 0===e&&(e=1),1===e&&(h=2),e=[];var l=[];if(t){var c;for(i=ph.length-1;0<=i;i--)for(s=0;s<t.length;s++)if(ph[i]===t[s]){for(c=0;c<uh[i].length;c++)uh[i][c].destroy();uh.splice(i,1),ph.splice(i,1)}for(c=[],i=0;i<t.length;i++)Vt(t[i],c,l);t=c,Vt(this.root,null,null,e)}else{for(i=0;i<uh.length;i++)for(s=0;s<uh[i].length;s++)uh[i][s].destroy();uh=[],ph=[],t=[],Vt(this.root,t,l,e)}if(0===t.length)r.fire("lightmapper:end",{timestamp:ha(),target:this});else{c=!1,a._needsStaticPrepare&&(a._needsStaticPrepare=!1,c=!0);var d=[[],[]],u={};for((s=new nt(this.device,{width:4,height:4,format:7,type:"rgbm"})).name="lightmap",i=0;i<t.length;i++){var p=this.calculateLightmapSize(t[i]);for(n=0;n<h;n++){var f=new nt(r,{width:p,height:p,format:7,mipmaps:!1,type:0===n?"rgbm":"default",minFilter:0,magFilter:0});f.name="lightmap",d[n].push(f)}if(!u[p]){var m=new nt(r,{width:p,height:p,format:7,mipmaps:!1,type:"rgbm",minFilter:0,magFilter:0});m.name="lightmap",m=new gp(r,m,{depth:!1}),u[p]=m}}var _=a.layers;_._update(),p=[],m=[];var g=[],y=[],v=_._lights;for(i=0;i<v.length;i++)v[i].enabled&&(0!=(4&(f=v[i].mask))&&(m.push(f),g.push(v[i].shadowUpdateMode),v[i].mask=4294967295,v[i].shadowUpdateMode=0===v[i]._type?2:1,p.push(v[i]),v[i].isStatic=!1)),y.push(v[i].enabled),v[i].enabled=!1;var b="#define UV1LAYOUT\n"+Ra.transformVS,x=Ra.bakeLmEndPS;f=st(r,Ra.fullscreenQuadVS,Ra.dilatePS,"lmDilate");var S=r.scope.resolve("source"),w=r.scope.resolve("pixelOffset"),M=r.scope.resolve("bakeDir"),P=new Float32Array(2);for(_=_._meshInstances,i=0;i<_.length;i++)_[i].node&&_[i].node.getWorldTransform();_=a.fog;var A=a.ambientLight.r,E=a.ambientLight.g,C=a.ambientLight.b;a.fog="none",a.ambientLight.set(0,0,0),dh||((dh=new wt).clearColor=new o(0,0,0,0),dh.clearColorBuffer=!0,dh.clearDepthBuffer=!1,dh.clearStencilBuffer=!1,dh.frustumCulling=!1,dh.node=new Mt);var I,O=[];for(O.length=ph.length,I=0;I<e.length;I++){var R=e[I].model.model.meshInstances,D=[];for(i=0;i<R.length;i++)D.push(R[i]._shaderDefs),R[i]._shaderDefs&=-193;for(i=0;i<ph.length;i++)if(ph[i]===e[I]){O[i]=D;break}}D=[];var L=[];for(I=0;I<e.length;I++)if(D[I]=e[I].model.castShadows,e[I].model.castShadows=e[I].model.castShadowsLightmap,e[I].model.castShadowsLightmap){var F=e[I].model.meshInstances;for(i=0;i<F.length;i++)F[i].visibleThisFrame=!0,L.push(F[i])}this.renderer.updateCpuSkinMatrices(L),this.renderer.gpuUpdate(L);var B=[],N=[];F=[[],[]];var k=[];for(k.length=t.length,n=0;n<h;n++)vh[n]||((i=new ar).chunks.transformVS=b,0===n?(i.chunks.endPS=x,i.ambient=new o(0,0,0),i.ambientTint=!0,i.lightMap=s):(i.chunks.basePS=Ra.basePS+"\nuniform sampler2D texture_dirLightMap;\nuniform float bakeDir;\n",i.chunks.endPS=Ra.bakeDirLmEndPS),i.chunks.outputAlphaPS="\n",i.chunks.outputAlphaOpaquePS="\n",i.chunks.outputAlphaPremulPS="\n",i.cull=0,i.forceUv1=!0,i.update(),i.updateShader(r,a),i.name="lmMaterial"+n,vh[n]=i);for(I=0;I<t.length;I++){if(R=l[I],k[I]=0,0<R.length)for(mh.copy(R[0].aabb),i=0;i<R.length;i++)R[i].node.getWorldTransform(),mh.add(R[i].aabb);for((i=new T).copy(mh),N.push(i),i=0;i<R.length;i++){var z=R[i];z._shaderDefs&=-193,z.mask=4,z.deleteParameter("texture_lightMap"),z.deleteParameter("texture_dirLightMap"),z.setParameter("texture_lightMap",z.material.lightMap?z.material.lightMap:s),z.setParameter("texture_dirLightMap",s)}for(n=0;n<h;n++){var U=d[n][I],V=new gp(r,U,{depth:!1});F[n].push(V)}}for(s=0;s<p.length;s++)p[s].enabled=!1;for(b=[[],[],[]],x=!1,i=0;i<p.length;i++){p[i].enabled=!0;var j=!1;if(p[i]._cacheShadowMap=!0,0!==p[i]._type&&(p[i]._node.getWorldTransform(),p[i].getBoundingSphere(gh),_h.center=gh.center,_h.halfExtents.x=gh.radius,_h.halfExtents.y=gh.radius,_h.halfExtents.z=gh.radius),2===p[i]._type){I=p[i];var G=this.renderer.getShadowCamera(r,I);G._node.setPosition(I._node.getPosition()),G._node.setRotation(I._node.getRotation()),G._node.rotateLocal(-90,0,0),G.projection=0,G.nearClip=I.attenuationEnd/1e3,G.farClip=I.attenuationEnd,G.aspectRatio=1,G.fov=2*I._outerConeAngle,this.renderer.updateCameraFrustum(G)}for(0<l.length&&this.renderer.updateShaders(l[0]),I=0;I<t.length;I++){if(R=l[I],mh=N[I],0===p[i]._type)fh.copy(mh.center),fh.y+=mh.halfExtents.y,dh.node.setPosition(fh),dh.node.setEulerAngles(-90,0,0),s=Math.max(mh.halfExtents.x,mh.halfExtents.z),dh.projection=1,dh.nearClip=0,dh.farClip=2*mh.halfExtents.y,dh.aspectRatio=1,dh.orthoHeight=s;else if(!_h.intersects(mh))continue;if(2===p[i]._type){for(n=!1,s=0;s<R.length;s++)if(R[s]._isVisible(G)){n=!0;break}if(!n)continue}for(0===p[i]._type?(b[0][0]=p[i],b[1].length=0,b[2].length=0,!j&&p[i].castShadows&&(this.renderer.cullDirectionalShadowmap(p[i],L,dh,0),this.renderer.renderShadows(b[0],0),j=!0)):(b[0].length=0,1===p[i]._type?(b[1][0]=p[i],b[2].length=0,!j&&p[i].castShadows&&(this.renderer.cullLocalShadowmap(p[i],L),this.renderer.renderShadows(b[1]),j=!0)):(b[1].length=0,b[2][0]=p[i],!j&&p[i].castShadows&&(this.renderer.cullLocalShadowmap(p[i],L),this.renderer.renderShadows(b[2]),j=!0))),s=0;s<R.length;s++)B[s]=R[s].material;for(n=0;n<h;n++){U=d[n][I],V=F[n][I];var H=(z=u[U.width]).colorBuffer;for(0===n?x=a.updateShaders:x&&(a.updateShaders=!0),s=0;s<R.length;s++)R[s].material=vh[n];for(1<h&&this.renderer.updateShaders(R),this.renderer.setCamera(dh,z,!0),1===n&&M.setValue(p[i].bakeDir?1:0),this.renderer._forwardTime=0,this.renderer._shadowMapTime=0,this.renderer.renderForward(dh,R,R.length,b,1),d[n][I]=H,F[n][I]=z,u[U.width]=V,s=0;s<R.length;s++)(z=R[s]).setParameter(yh[n],H),z._shaderDefs|=64}for(k[I]++,s=0;s<R.length;s++)R[s].material=B[s]}p[i].enabled=!1,p[i]._cacheShadowMap=!1,p[i]._isCachedShadowMap&&p[i]._destroyShadowMap()}for(I=0;I<t.length;I++){for(R=l[I],G=[],n=0;n<h;n++){for(U=d[n][I],V=F[n][I],H=(z=u[U.width]).colorBuffer,P[0]=1/U.width,P[1]=1/U.height,w.setValue(P),i=0;4>i;i++)S.setValue(U),X(r,z,f),S.setValue(H),X(r,V,f);for(i=0;i<R.length;i++)(z=R[i]).mask=2,R[i].setParameter(yh[n],U),1===n&&(R[i]._shaderDefs|=128);G[n]=U,n===h-1&&V.destroy()}uh.push(G),ph.push(t[I])}for(var W in u)u.hasOwnProperty(W)&&(u[W].colorBuffer.destroy(),u[W].destroy());for(i=0;i<uh.length;i++)for(s=0;s<uh[i].length;s++)(f=uh[i][s]).minFilter=1,f.magFilter=1;for(I=0;I<e.length;I++)e[I].model.castShadows=D[I];for(i=0;i<O.length;i++)if(O[i])for(R=ph[i].model.model.meshInstances,s=0;s<R.length;s++)R[s]._shaderDefs|=192&O[i][s];for(i=0;i<p.length;i++)p[i].mask=m[i],p[i].shadowUpdateMode=g[i];for(i=0;i<v.length;i++)v[i].enabled=y[i];a.fog=_,a.ambientLight.set(A,E,C),c&&(a._needsStaticPrepare=!0)}}});var bh,xh=1,Sh=new x,Th=new x,wh=new v,Mh=new v,Ph=new v,Ah=new v,Eh=new v,Ch=new v,Ih=new v,Oh=new v,Rh=new v,Dh=new v,Lh=new v,Fh=new v,Bh=new v;Xt.prototype.calcSpawnPosition=function(t,e,i,s,n){var r=this._emitter,a=Math.random(),o=Math.random(),h=Math.random(),l=Math.random();r.useCpu&&(t[4*n+8*r.numParticlesPot]=a,t[4*n+1+8*r.numParticlesPot]=o,t[4*n+2+8*r.numParticlesPot]=h),Mh.x=a-.5,Mh.y=o-.5,Mh.z=h-.5,0===r.emitterShape?(o=(l=Math.max(Math.abs(Mh.x),Math.max(Math.abs(Mh.y),Math.abs(Mh.z))))+(.5-l)*i[1],h=l+(.5-l)*i[2],Mh.x=(l+(.5-l)*i[0])*(l==Math.abs(Mh.x)?Math.sign(Mh.x):2*Mh.x),Mh.y=o*(l==Math.abs(Mh.y)?Math.sign(Mh.y):2*Mh.y),Mh.z=h*(l==Math.abs(Mh.z)?Math.sign(Mh.z):2*Mh.z),r.localSpace?wh.copy(e.transformPoint(Mh)):wh.copy(s).add(e.transformPoint(Mh))):(Mh.normalize(),e=l*(1-(e=0===r.emitterRadius?0:r.emitterRadiusInner/r.emitterRadius))+e,r.localSpace?wh.copy(Mh.scale(e*r.emitterRadius)):wh.copy(s).add(Mh.scale(e*r.emitterRadius))),s=-oa.lerp(r.rate,r.rate2,a)*n,r.pack8?(l=(wh.x-r.worldBounds.center.x)/r.worldBoundsSize.x+.5,i=(wh.y-r.worldBounds.center.y)/r.worldBoundsSize.y+.5,e=(wh.z-r.worldBounds.center.z)/r.worldBoundsSize.z+.5,a=(a=oa.lerp(r.startAngle*oa.DEG_TO_RAD,r.startAngle2*oa.DEG_TO_RAD,a))%(2*Math.PI)/(2*Math.PI),l=Wt(l),t[4*n]=l[0],t[4*n+1]=l[1],i=Wt(i),t[4*n+2]=i[0],t[4*n+3]=i[1],e=Wt(e),t[4*n+4*r.numParticlesPot]=e[0],t[4*n+1+4*r.numParticlesPot]=e[1],a=Wt(a),t[4*n+2+4*r.numParticlesPot]=a[0],t[4*n+3+4*r.numParticlesPot]=a[1],t[4*n+3+8*r.numParticlesPot]=1,a=Gt(i=(s+(a=Math.max(r.lifetime,(r.numParticles-1)*Math.max(r.rate,r.rate2))))/(a+(r.lifetime+1))),a=[a-=(s=Gt(255*i))/255,s-=(e=Gt(65025*i))/255,e-(i=Gt(160581375*i))/255,i-i/255],t[4*n+12*r.numParticlesPot]=a[0],t[4*n+1+12*r.numParticlesPot]=a[1],t[4*n+2+12*r.numParticlesPot]=a[2],t[4*n+3+12*r.numParticlesPot]=a[3]):(t[4*n]=wh.x,t[4*n+1]=wh.y,t[4*n+2]=wh.z,t[4*n+3]=oa.lerp(r.startAngle*oa.DEG_TO_RAD,r.startAngle2*oa.DEG_TO_RAD,a),t[4*n+3+4*r.numParticlesPot]=s)},Xt.prototype.update=function(t,e,i,s,n,r,a,o){var h=this._emitter;if(h.meshInstance.node){var l=h.meshInstance.node.worldTransform;for(r=0;12>r;r++)Sh.data[r]=l.data[r];Th.copy(Sh),Th.invert(),bh=h.meshInstance.node.localScale,xh=Math.max(Math.max(bh.x,bh.y),bh.z)}r=null===h.meshInstance.node||h.localSpace?v.ZERO:h.meshInstance.node.getPosition();var c=h.camera?h.camera._node.getPosition():v.ZERO,d=h.useMesh?17:15,u=h.precision-1;for(l=0;l<h.numParticles;l++){var p=Math.floor(h.vbCPU[l*h.numParticleVerts*(h.useMesh?6:4)+3]),f=i[4*p+8*h.numParticlesPot];Ph.x=f,Ph.y=i[4*p+1+8*h.numParticlesPot],Ph.z=i[4*p+2+8*h.numParticlesPot];var m=h.rate+(h.rate2-h.rate)*f,_=h.lifetime,g=i[4*p+3+4*h.numParticlesPot]+a,y=Math.max(Math.min(g/_,1),0),b=0,x=0;(0>=g-a||g>=_)&&this.calcSpawnPosition(i,s,n,r,p);var S=0<g&&g<_;if(S){x=y*u;var T=Math.floor(x),w=Math.ceil(x);x%=1;var M=h.qRotSpeed[T],P=h.qRotSpeed[w],A=M+(P-M)*x,E=(M=h.qRotSpeed2[T])+((P=h.qRotSpeed2[w])-M)*x;b=(M=h.qScale[T])+((P=h.qScale[w])-M)*x;var C=(M=h.qScale2[T])+((P=h.qScale2[w])-M)*x,I=(M=h.qAlpha[T])+((P=h.qAlpha[w])-M)*x,O=(M=h.qAlpha2[T])+((P=h.qAlpha2[w])-M)*x,R=(M=h.qRadialSpeed[T])+((P=h.qRadialSpeed[w])-M)*x;M=h.qRadialSpeed2[T],R+=100*f%1*((M+=((P=h.qRadialSpeed2[w])-M)*x)-R),Ah.x=i[4*p],Ah.y=i[4*p+1],Ah.z=i[4*p+2],h.localSpace?Rh.copy(Ah):Rh.copy(Ah).sub(r),Rh.normalize().scale(R),T*=3,w*=3,M=h.qLocalVelocity[T],P=h.qLocalVelocity[w],Ch.x=M+(P-M)*x,M=h.qLocalVelocity[T+1],P=h.qLocalVelocity[w+1],Ch.y=M+(P-M)*x,M=h.qLocalVelocity[T+2],P=h.qLocalVelocity[w+2],Ch.z=M+(P-M)*x,M=h.qLocalVelocity2[T],P=h.qLocalVelocity2[w],Oh.x=M+(P-M)*x,M=h.qLocalVelocity2[T+1],P=h.qLocalVelocity2[w+1],Oh.y=M+(P-M)*x,M=h.qLocalVelocity2[T+2],P=h.qLocalVelocity2[w+2],Oh.z=M+(P-M)*x,M=h.qVelocity[T],P=h.qVelocity[w],Eh.x=M+(P-M)*x,M=h.qVelocity[T+1],P=h.qVelocity[w+1],Eh.y=M+(P-M)*x,M=h.qVelocity[T+2],P=h.qVelocity[w+2],Eh.z=M+(P-M)*x,M=h.qVelocity2[T],P=h.qVelocity2[w],Ih.x=M+(P-M)*x,M=h.qVelocity2[T+1],P=h.qVelocity2[w+1],Ih.y=M+(P-M)*x,M=h.qVelocity2[T+2],P=h.qVelocity2[w+2],Ih.z=M+(P-M)*x,Ch.x+=(Oh.x-Ch.x)*Ph.x,Ch.y+=(Oh.y-Ch.y)*Ph.y,Ch.z+=(Oh.z-Ch.z)*Ph.z,0<h.initialVelocity&&(1===h.emitterShape?(Mh.copy(Ph).scale(2).sub(v.ONE).normalize(),Ch.add(Mh.scale(h.initialVelocity))):Ch.add(v.FORWARD.scale(h.initialVelocity))),Eh.x+=(Ih.x-Eh.x)*Ph.x,Eh.y+=(Ih.y-Eh.y)*Ph.y,Eh.z+=(Ih.z-Eh.z)*Ph.z,A+=(E-A)*Ph.y,b=(b+1e4*f%1*(C-b))*xh,x=1e3*f%1*(O-I),h.meshInstance.node&&(h.localSpace?(Ch.x/=bh.x,Ch.y/=bh.y,Ch.z/=bh.z):Sh.transformPoint(Ch,Ch)),h.localSpace?(Th.transformPoint(Eh,Eh),Ch.add(Eh).add(Rh)):(Ch.add(Eh.mul(bh)),Ch.add(Rh.mul(bh))),Fh.copy(Ch),Dh.copy(Ah).add(Ch.scale(a)),Lh.copy(Dh),i[4*p]=Lh.x,i[4*p+1]=Lh.y,i[4*p+2]=Lh.z,i[4*p+3]+=A*a,h.wrap&&h.wrapBounds&&(h.localSpace||Lh.sub(r),Lh.x=Ht(Lh.x,h.wrapBounds.x)-.5*h.wrapBounds.x,Lh.y=Ht(Lh.y,h.wrapBounds.y)-.5*h.wrapBounds.y,Lh.z=Ht(Lh.z,h.wrapBounds.z)-.5*h.wrapBounds.z,h.localSpace||Lh.add(r)),0<h.sort&&(1===h.sort?(Bh.copy(Lh).sub(c),h.particleDistance[p]=-(Bh.x*Bh.x+Bh.y*Bh.y+Bh.z*Bh.z)):2===h.sort?h.particleDistance[p]=g:3===h.sort&&(h.particleDistance[p]=-g))}for(o?0>g&&(i[4*p+3+8*h.numParticlesPot]=-1):(g>=_&&(g-=Math.max(_,(h.numParticles-1)*m),i[4*p+3+8*h.numParticlesPot]=h.loop?1:-1),0>g&&h.loop&&(i[4*p+3+8*h.numParticlesPot]=1)),0>i[4*p+3+8*h.numParticlesPot]&&(S=!1),i[4*p+3+4*h.numParticlesPot]=g,A=0;A<h.numParticleVerts;A++)f=(l*h.numParticleVerts+A)*(h.useMesh?6:4),m=h.vbCPU[f],_=h.vbCPU[f+1],g=h.vbCPU[f+2],S||(m=_=g=0),t[T=l*h.numParticleVerts*d+A*d]=Lh.x,t[T+1]=Lh.y,t[T+2]=Lh.z,t[T+3]=y,t[T+4]=h.alignToMotion?0:i[4*p+3],t[T+5]=b,t[T+6]=x,t[T+7]=Fh.x,t[T+8]=m,t[T+9]=_,t[T+10]=g,t[T+11]=Fh.y,t[T+12]=p,t[T+13]=Fh.z,t[T+14]=h.vbCPU[f+3],h.useMesh&&(t[T+15]=h.vbCPU[f+4],t[T+16]=h.vbCPU[f+5])}if(0<h.sort&&h.camera){for(t=h.useMesh?6:4,i=h.particleDistance,l=0;l<h.numParticles;l++)e[l][0]=l,e[l][1]=i[Math.floor(h.vbCPU[l*h.numParticleVerts*t+3])];for(h.vbOld.set(h.vbCPU),e.sort(function(t,e){return t[1]-e[1]}),l=0;l<h.numParticles;l++)for(i=e[l][0]*h.numParticleVerts*t,s=l*h.numParticleVerts*t,r=0;r<h.numParticleVerts*t;r++)h.vbCPU[s+r]=h.vbOld[i+r]}};var Nh=new g,kh=new g,zh=new g;Yt.prototype._setInputBounds=function(){this.inBoundsSizeUniform[0]=this._emitter.prevWorldBoundsSize.x,this.inBoundsSizeUniform[1]=this._emitter.prevWorldBoundsSize.y,this.inBoundsSizeUniform[2]=this._emitter.prevWorldBoundsSize.z,this.constantInBoundsSize.setValue(this.inBoundsSizeUniform),this.inBoundsCenterUniform[0]=this._emitter.prevWorldBoundsCenter.x,this.inBoundsCenterUniform[1]=this._emitter.prevWorldBoundsCenter.y,this.inBoundsCenterUniform[2]=this._emitter.prevWorldBoundsCenter.z,this.constantInBoundsCenter.setValue(this.inBoundsCenterUniform)},Yt.prototype.randomize=function(){this.frameRandomUniform[0]=Math.random(),this.frameRandomUniform[1]=Math.random(),this.frameRandomUniform[2]=Math.random()},Yt.prototype.update=function(t,e,i,s,n){var r=this._emitter;t.setBlending(!1),t.setColorWrite(!0,!0,!0,!0),t.setCullMode(0),t.setDepthTest(!1),t.setDepthWrite(!1),this.randomize(),this.constantGraphSampleSize.setValue(1/r.precision),this.constantGraphNumSamples.setValue(r.precision),this.constantNumParticles.setValue(r.numParticles),this.constantNumParticlesPot.setValue(r.numParticlesPot),this.constantInternalTex0.setValue(r.internalTex0),this.constantInternalTex1.setValue(r.internalTex1),this.constantInternalTex2.setValue(r.internalTex2),this.constantInternalTex3.setValue(r.internalTex3);var a=r.meshInstance.node,o=null===a?v.ONE:a.localScale;if(r.pack8){this.worldBoundsMulUniform[0]=r.worldBoundsMul.x,this.worldBoundsMulUniform[1]=r.worldBoundsMul.y,this.worldBoundsMulUniform[2]=r.worldBoundsMul.z,this.constantOutBoundsMul.setValue(this.worldBoundsMulUniform),this.worldBoundsAddUniform[0]=r.worldBoundsAdd.x,this.worldBoundsAddUniform[1]=r.worldBoundsAdd.y,this.worldBoundsAddUniform[2]=r.worldBoundsAdd.z,this.constantOutBoundsAdd.setValue(this.worldBoundsAddUniform),this._setInputBounds();var h=r.maxVel*Math.max(Math.max(o.x,o.y),o.z);h=Math.max(h,1),this.constantMaxVel.setValue(h)}h=null===a||r.localSpace?v.ZERO:a.getPosition(),a=null===a?x.IDENTITY:a.getWorldTransform(),0===r.emitterShape?(qt(e,Nh),this.constantSpawnBounds.setValue(Nh.data),this.constantSpawnPosInnerRatio.setValue(i)):(this.constantSpawnBoundsSphere.setValue(r.emitterRadius),this.constantSpawnBoundsSphereInnerRatio.setValue(0===r.emitterRadius?0:r.emitterRadiusInner/r.emitterRadius)),this.constantInitialVelocity.setValue(r.initialVelocity),qt(a,kh),a.invertTo3x3(zh),this.emitterPosUniform[0]=h.x,this.emitterPosUniform[1]=h.y,this.emitterPosUniform[2]=h.z,this.constantEmitterPos.setValue(this.emitterPosUniform),this.constantFrameRandom.setValue(this.frameRandomUniform),this.constantDelta.setValue(s),this.constantRate.setValue(r.rate),this.constantRateDiv.setValue(r.rate2-r.rate),this.constantStartAngle.setValue(r.startAngle*oa.DEG_TO_RAD),this.constantStartAngle2.setValue(r.startAngle2*oa.DEG_TO_RAD),this.constantSeed.setValue(r.seed),this.constantLifetime.setValue(r.lifetime),this.emitterScaleUniform[0]=o.x,this.emitterScaleUniform[1]=o.y,this.emitterScaleUniform[2]=o.z,this.constantEmitterScale.setValue(this.emitterScaleUniform),this.constantEmitterMatrix.setValue(kh.data),this.constantEmitterMatrixInv.setValue(zh.data),this.constantLocalVelocityDivMult.setValue(r.localVelocityUMax),this.constantVelocityDivMult.setValue(r.velocityUMax),this.constantRotSpeedDivMult.setValue(r.rotSpeedUMax[0]),e=r.swapTex?r.particleTexOUT:r.particleTexIN,e=r.beenReset?r.particleTexStart:e,i=r.swapTex?r.particleTexIN:r.particleTexOUT,this.constantParticleTexIN.setValue(e),X(t,r.swapTex?r.rtParticleTexIN:r.rtParticleTexOUT,n?r.shaderParticleUpdateOnStop:r.loop?r.shaderParticleUpdateRespawn:r.shaderParticleUpdateNoRespawn),r.material.setParameter("particleTexOUT",e),r.material.setParameter("particleTexIN",i),r.beenReset=!1,r.swapTex=!r.swapTex,t.setDepthTest(!0),t.setDepthWrite(!0),r.prevWorldBoundsSize.copy(r.worldBoundsSize),r.prevWorldBoundsCenter.copy(r.worldBounds.center),r.pack8&&this._setInputBounds()};var Uh,Vh,jh=[[-1,-1],[1,-1],[1,1],[-1,1]],Gh=function(t,e,i,s,n,r,a){n||(n=14);var o=0;if(a&&7===n&&(o=1),(t=new nt(t,{width:e,height:i,format:n,cubemap:!1,mipmaps:!1,minFilter:o,magFilter:o,addressU:1,addressV:1})).name="PSTexture",e=t.lock(),7===n){for(n=new Uint8Array(s.length),i=0;i<s.length;i++)n[i]=s[i]*r*255;s=n}return e.set(s),t.unlock(),t},Hh=new m([0,0,1,0]),Wh=new m([0,1,1,1]),Xh=new _([0,0,1,0],[0,0,1,0],[0,0,1,0]),qh=new _([0,1,1,1],[0,1,1,1],[0,1,1,1]),Yh=2,Kh=new Float32Array(3),$h=new x,Zh=new v,Qh=new v,Jh=new v,tl=function(t,e){if(this.graphicsDevice=t,this.precision=32,this._addTimeTime=0,!tl.DEFAULT_PARAM_TEXTURE){var i,s,n=new Float32Array(1024);for(s=0;16>s;s++)for(i=0;16>i;i++){var r=i+1-8.5,a=s+1-8.5;a=Math.max(Math.min(1-Math.max(Math.min(Math.sqrt(r*r+a*a)/16,1),0)-.5,1),0),n[4*(r=16*s+i)]=1,n[4*r+1]=1,n[4*r+2]=1,n[4*r+3]=a}tl.DEFAULT_PARAM_TEXTURE=Gh(t,16,16,n,7,1,!0),tl.DEFAULT_PARAM_TEXTURE.minFilter=1,tl.DEFAULT_PARAM_TEXTURE.magFilter=1}Uh=this,Vh=e,Kt("numParticles",1),this.numParticles>t.maxTextureSize&&(console.warn("WARNING: can't create more than "+t.maxTextureSize+" particles on this device."),this.numParticles=t.maxTextureSize),Kt("rate",1),Kt("rate2",this.rate),Kt("lifetime",50),Kt("emitterExtents",new v(0,0,0)),Kt("emitterExtentsInner",new v(0,0,0)),Kt("emitterRadius",0),Kt("emitterRadiusInner",0),Kt("emitterShape",0),Kt("initialVelocity",1),Kt("wrap",!1),Kt("localSpace",!1),Kt("screenSpace",!1),Kt("wrapBounds",null),Kt("colorMap",tl.DEFAULT_PARAM_TEXTURE),Kt("normalMap",null),Kt("loop",!0),Kt("preWarm",!1),Kt("sort",0),Kt("mode",0),Kt("scene",null),Kt("lighting",!1),Kt("halfLambert",!1),Kt("intensity",1),Kt("stretch",0),Kt("alignToMotion",!1),Kt("depthSoftening",0),Kt("mesh",null),Kt("particleNormal",new v(0,1,0)),Kt("orientation",0),Kt("depthWrite",!1),Kt("noFog",!1),Kt("blendType",2),Kt("node",null),Kt("startAngle",0),Kt("startAngle2",this.startAngle),Kt("animTilesX",1),Kt("animTilesY",1),Kt("animStartFrame",0),Kt("animNumFrames",1),Kt("animNumAnimations",1),Kt("animIndex",0),Kt("randomizeAnimIndex",!1),Kt("animSpeed",1),Kt("animLoop",!0),this._gpuUpdater=new Yt(this,t),this._cpuUpdater=new Xt(this),this.constantLightCube=t.scope.resolve("lightCube[0]"),this.emitterPosUniform=new Float32Array(3),this.wrapBoundsUniform=new Float32Array(3),this.emitterScaleUniform=new Float32Array([1,1,1]),Kt("colorGraph",qh),Kt("colorGraph2",this.colorGraph),Kt("scaleGraph",Wh),Kt("scaleGraph2",this.scaleGraph),Kt("alphaGraph",Wh),Kt("alphaGraph2",this.alphaGraph),Kt("localVelocityGraph",Xh),Kt("localVelocityGraph2",this.localVelocityGraph),Kt("velocityGraph",Xh),Kt("velocityGraph2",this.velocityGraph),Kt("rotationSpeedGraph",Hh),Kt("rotationSpeedGraph2",this.rotationSpeedGraph),Kt("radialSpeedGraph",Hh),Kt("radialSpeedGraph2",this.radialSpeedGraph),this.lightCube=new Float32Array(18),this.lightCubeDir=Array(6),this.lightCubeDir[0]=new v(-1,0,0),this.lightCubeDir[1]=new v(1,0,0),this.lightCubeDir[2]=new v(0,-1,0),this.lightCubeDir[3]=new v(0,1,0),this.lightCubeDir[4]=new v(0,0,-1),this.lightCubeDir[5]=new v(0,0,1),this.animTilesParams=new Float32Array(2),this.animParams=new Float32Array(4),this.animIndexParams=new Float32Array(2),this.camera=this.particleDistance=this.vbOld=this.vbToSort=this.colorParam=this.internalTex2=this.internalTex1=this.internalTex0=null,this.swapTex=!1,this.useMesh=!0,this.useCpu=!1,this.pack8=!0,this.localBounds=new T,this.worldBoundsNoTrail=new T,this.worldBoundsTrail=[new T,new T],this.worldBounds=new T,this.worldBoundsSize=new v,this.prevWorldBoundsSize=new v,this.prevWorldBoundsCenter=new v,this.prevEmitterExtents=this.emitterExtents,this.prevEmitterRadius=this.emitterRadius,this.worldBoundsMul=new v,this.worldBoundsAdd=new v,this.timeToSwitchBounds=0,this.shaderParticleUpdateOnStop=this.shaderParticleUpdateNoRespawn=this.shaderParticleUpdateRespawn=null,this.numParticleIndices=this.numParticleVerts=0,this.meshInstance=this.material=null,this.drawOrder=0,this.seed=Math.random(),this.fixedTimeStep=1/60,this.maxSubSteps=10,this.simTimeTotal=this.simTime=0,this.beenReset=!1,this._layer=null,this.rebuild()};if(Object.assign(tl.prototype,{onChangeCamera:function(){this.regenShader(),this.resetMaterial()},calculateBoundsMad:function(){this.worldBoundsMul.x=1/this.worldBoundsSize.x,this.worldBoundsMul.y=1/this.worldBoundsSize.y,this.worldBoundsMul.z=1/this.worldBoundsSize.z,this.worldBoundsAdd.copy(this.worldBounds.center).mul(this.worldBoundsMul).scale(-1),this.worldBoundsAdd.x+=.5,this.worldBoundsAdd.y+=.5,this.worldBoundsAdd.z+=.5},calculateWorldBounds:function(){if(this.node){this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.useCpu||(0===this.emitterShape?!this.emitterExtents.equals(this.prevEmitterExtents):this.emitterRadius!==this.prevEmitterRadius)&&this.calculateLocalBounds();var t=this.node.getWorldTransform();this.localSpace?this.worldBoundsNoTrail.copy(this.localBounds):this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,t),this.worldBoundsTrail[0].add(this.worldBoundsNoTrail),this.worldBoundsTrail[1].add(this.worldBoundsNoTrail);var e=this.simTimeTotal;e>=this.timeToSwitchBounds&&(this.worldBoundsTrail[0].copy(this.worldBoundsTrail[1]),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.timeToSwitchBounds=e+this.lifetime),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.localSpace?(this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,t),this.meshInstance.mesh.aabb.setFromTransformedAabb(this.worldBounds,t)):(this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance.mesh.aabb.copy(this.worldBounds)),this.meshInstance._aabbVer=1-this.meshInstance._aabbVer,this.pack8&&this.calculateBoundsMad()}},resetWorldBounds:function(){this.node&&(this.worldBoundsNoTrail.setFromTransformedAabb(this.localBounds,this.localSpace?x.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBoundsNoTrail),this.worldBoundsTrail[1].copy(this.worldBoundsNoTrail),this.worldBounds.copy(this.worldBoundsTrail[0]),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.timeToSwitchBounds=this.simTimeTotal=0)},calculateLocalBounds:function(){var t,e,i=Number.MAX_VALUE,s=Number.MAX_VALUE,n=Number.MAX_VALUE,r=-Number.MAX_VALUE,a=-Number.MAX_VALUE,o=-Number.MAX_VALUE,h=0,l=0,c=this.lifetime/this.precision,d=[this.qVelocity,this.qVelocity2],u=[this.qLocalVelocity,this.qLocalVelocity2],p=[0,0],f=[0,0],m=[0,0],_=[0,0],g=[0,0];for(t=0;t<this.precision+1;t++){var y=Math.min(t,this.precision-1);for(e=0;2>e;e++){var v=u[e][3*y]*c+p[e],b=u[e][3*y+1]*c+f[e],x=u[e][3*y+2]*c+m[e];i=Math.min(v,i),s=Math.min(b,s),n=Math.min(x,n),r=Math.max(v,r),a=Math.max(b,a),o=Math.max(x,o),p[e]=v,f[e]=b,m[e]=x}for(e=0;2>e;e++)g[e]+=c*Math.sqrt(d[e][3*y]*d[e][3*y]+d[e][3*y+1]*d[e][3*y+1]+d[e][3*y+2]*d[e][3*y+2]);_[0]+=this.qRadialSpeed[y]*c,_[1]+=this.qRadialSpeed2[y]*c,h=Math.max(h,Math.max(Math.abs(_[0]),Math.abs(_[1]))),l=Math.max(l,this.qScale[y])}0===this.emitterShape?(v=.5*this.emitterExtents.x,b=.5*this.emitterExtents.y,x=.5*this.emitterExtents.z):x=b=v=this.emitterRadius,c=Math.max(g[0],g[1]),Qh.x=i-l-v-h-c,Qh.y=s-l-b-h-c,Qh.z=n-l-x-h-c,Jh.x=r+l+v+h+c,Jh.y=a+l+b+h+c,Jh.z=o+l+x+h+c,this.localBounds.setMinMax(Qh,Jh)},rebuild:function(){var t,e=this.graphicsDevice;for(null===this.colorMap&&(this.colorMap=tl.DEFAULT_PARAM_TEXTURE),this.spawnBounds=0===this.emitterShape?this.emitterExtents:this.emitterRadius,this.useCpu=this.useCpu||0<this.sort||1>=e.maxVertexTextures||64>e.fragmentUniformsCount||e.forceCpuParticles||!e.extTextureFloat,this._destroyResources(),this.pack8=(this.pack8||!e.textureFloatRenderable)&&!this.useCpu,Yh=this.useCpu||this.pack8?4:2,this.useMesh=!1,this.mesh&&(65535<this.numParticles*this.mesh.vertexBuffer.numVertices?console.warn("WARNING: particle system can't render mesh particles because numParticles * numVertices is more than 65k. Reverting to quad particles."):this.useMesh=!0),this.numParticlesPot=oa.nextPowerOfTwo(this.numParticles),this.rebuildGraphs(),this.calculateLocalBounds(),this.resetWorldBounds(),this.node&&(this.worldBounds.setFromTransformedAabb(this.localBounds,this.localSpace?x.IDENTITY:this.node.getWorldTransform()),this.worldBoundsTrail[0].copy(this.worldBounds),this.worldBoundsTrail[1].copy(this.worldBounds),this.worldBoundsSize.copy(this.worldBounds.halfExtents).scale(2),this.prevWorldBoundsSize.copy(this.worldBoundsSize),this.prevWorldBoundsCenter.copy(this.worldBounds.center),this.pack8&&this.calculateBoundsMad()),this.vbToSort=Array(this.numParticles),t=0;t<this.numParticles;t++)this.vbToSort[t]=[0,0];this.particleDistance=new Float32Array(this.numParticles),this._gpuUpdater.randomize(),this.particleTex=new Float32Array(this.numParticlesPot*Yh*4);var i=null===this.node||this.localSpace?v.ZERO:this.node.getPosition();for(0===this.emitterShape&&(null===this.node||this.localSpace?$h.setTRS(v.ZERO,S.IDENTITY,this.spawnBounds):$h.setTRS(v.ZERO,this.node.getRotation(),Zh.copy(this.spawnBounds).mul(this.node.localScale)),Kh[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Kh[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Kh[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0),t=0;t<this.numParticles;t++)this._cpuUpdater.calcSpawnPosition(this.particleTex,$h,Kh,i,t),this.useCpu&&(this.particleTex[4*t+3+8*this.numParticlesPot]=1);for(this.particleTexStart=new Float32Array(this.numParticlesPot*Yh*4),t=0;t<this.particleTexStart.length;t++)this.particleTexStart[t]=this.particleTex[t];this.useCpu||(this.pack8?(this.particleTexIN=Gh(e,this.numParticlesPot,Yh,this.particleTex,7,1,!1),this.particleTexOUT=Gh(e,this.numParticlesPot,Yh,this.particleTex,7,1,!1),this.particleTexStart=Gh(e,this.numParticlesPot,Yh,this.particleTexStart,7,1,!1)):(this.particleTexIN=Gh(e,this.numParticlesPot,Yh,this.particleTex),this.particleTexOUT=Gh(e,this.numParticlesPot,Yh,this.particleTex),this.particleTexStart=Gh(e,this.numParticlesPot,Yh,this.particleTexStart)),this.rtParticleTexIN=new gp(e,this.particleTexIN,{depth:!1}),this.rtParticleTexOUT=new gp(e,this.particleTexOUT,{depth:!1}),this.swapTex=!1),i=(t=(this.localSpace?"#define LOCAL_SPACE\n":"")+Ra.particleUpdaterInitPS+(this.pack8?Ra.particleInputRgba8PS+Ra.particleOutputRgba8PS:Ra.particleInputFloatPS+Ra.particleOutputFloatPS)+(0===this.emitterShape?Ra.particleUpdaterAABBPS:Ra.particleUpdaterSpherePS)+Ra.particleUpdaterStartPS)+Ra.particleUpdaterNoRespawnPS+Ra.particleUpdaterEndPS;var s=t+Ra.particleUpdaterOnStopPS+Ra.particleUpdaterEndPS,n=this.emitterShape+""+this.pack8+this.localSpace;this.shaderParticleUpdateRespawn=st(e,Ra.fullscreenQuadVS,t+Ra.particleUpdaterRespawnPS+Ra.particleUpdaterEndPS,"fsQuad0"+n),this.shaderParticleUpdateNoRespawn=st(e,Ra.fullscreenQuadVS,i,"fsQuad1"+n),this.shaderParticleUpdateOnStop=st(e,Ra.fullscreenQuadVS,s,"fsQuad2"+n),this.numParticleVerts=this.useMesh?this.mesh.vertexBuffer.numVertices:4,this.numParticleIndices=this.useMesh?this.mesh.indexBuffer[0].numIndices:6,this._allocate(this.numParticles),(e=new ht(e)).vertexBuffer=this.vertexBuffer,e.indexBuffer[0]=this.indexBuffer,e.primitive[0].type=4,e.primitive[0].base=0,e.primitive[0].count=this.numParticles*this.numParticleIndices,e.primitive[0].indexed=!0,this.material=new nr,this.material.name=this.node.name,this.material.cull=0,this.material.alphaWrite=!1,this.material.blend=!0,this.material.blendType=this.blendType,this.material.depthWrite=this.depthWrite,this.material.emitter=this,this.regenShader(),this.resetMaterial(),t=!this.meshInstance||this.meshInstance.visible,this.meshInstance=new lt(this.node,e,this.material),this.meshInstance.pick=!1,this.meshInstance.updateKey(),this.meshInstance.cull=!0,this.meshInstance._noDepthDrawGl1=!0,this.localSpace?this.meshInstance.aabb.setFromTransformedAabb(this.worldBounds,this.node.getWorldTransform()):this.meshInstance.aabb.copy(this.worldBounds),this.meshInstance._updateAabb=!1,this.meshInstance.visible=t,this._initializeTextures(),this.resetTime(),this.addTime(0,!1),this.preWarm&&this.prewarm(this.lifetime)},_isAnimated:function(){return 1<=this.animNumFrames&&(1<this.animTilesX||1<this.animTilesY)&&(this.colorMap&&this.colorMap!==tl.DEFAULT_PARAM_TEXTURE||this.normalMap)},rebuildGraphs:function(){var t,e=this.precision,i=this.graphicsDevice;for(this.qLocalVelocity=this.localVelocityGraph.quantize(e),this.qVelocity=this.velocityGraph.quantize(e),this.qColor=this.colorGraph.quantizeClamped(e,0,1),this.qRotSpeed=this.rotationSpeedGraph.quantize(e),this.qScale=this.scaleGraph.quantize(e),this.qAlpha=this.alphaGraph.quantize(e),this.qRadialSpeed=this.radialSpeedGraph.quantize(e),this.qLocalVelocity2=this.localVelocityGraph2.quantize(e),this.qVelocity2=this.velocityGraph2.quantize(e),this.qColor2=this.colorGraph2.quantizeClamped(e,0,1),this.qRotSpeed2=this.rotationSpeedGraph2.quantize(e),this.qScale2=this.scaleGraph2.quantize(e),this.qAlpha2=this.alphaGraph2.quantize(e),this.qRadialSpeed2=this.radialSpeedGraph2.quantize(e),t=0;t<e;t++)this.qRotSpeed[t]*=oa.DEG_TO_RAD,this.qRotSpeed2[t]*=oa.DEG_TO_RAD;if(this.localVelocityUMax=new Float32Array(3),this.velocityUMax=new Float32Array(3),this.colorUMax=new Float32Array(3),this.rotSpeedUMax=[0],this.scaleUMax=[0],this.alphaUMax=[0],this.radialSpeedUMax=[0],this.qLocalVelocityDiv=Qt(this.qLocalVelocity,this.qLocalVelocity2,this.localVelocityUMax),this.qVelocityDiv=Qt(this.qVelocity,this.qVelocity2,this.velocityUMax),this.qColorDiv=Qt(this.qColor,this.qColor2,this.colorUMax),this.qRotSpeedDiv=Qt(this.qRotSpeed,this.qRotSpeed2,this.rotSpeedUMax),this.qScaleDiv=Qt(this.qScale,this.qScale2,this.scaleUMax),this.qAlphaDiv=Qt(this.qAlpha,this.qAlpha2,this.alphaUMax),this.qRadialSpeedDiv=Qt(this.qRadialSpeed,this.qRadialSpeed2,this.radialSpeedUMax),this.pack8){var s=[0,0,0];Zt(this.qVelocity,s);var n=[0,0,0];Zt(this.qVelocity2,n),t=[0,0,0],Zt(this.qLocalVelocity,t);var r=[0,0,0];Zt(this.qLocalVelocity2,r);var a=[0];Zt(this.qRadialSpeed,a);var o=[0];Zt(this.qRadialSpeed2,o);var h=Math.max(s[0],n[0]);h=Math.max(h,s[1]),h=Math.max(h,n[1]),h=Math.max(h,s[2]),h=Math.max(h,n[2]),s=Math.max(t[0],r[0]),s=Math.max(s,t[1]),s=Math.max(s,r[1]),s=Math.max(s,t[2]),s=Math.max(s,r[2]),this.maxVel=h+s+Math.max(a[0],o[0])}if(!this.useCpu){for(this.internalTex0=Gh(i,e,1,$t(this.qLocalVelocity,this.qLocalVelocityDiv)),this.internalTex1=Gh(i,e,1,$t(this.qVelocity,this.qVelocityDiv)),t=this.qRotSpeed,r=this.qScale,a=this.qScaleDiv,o=this.qRotSpeedDiv,h=this.qAlphaDiv,s=Array(4*t.length),n=0;n<t.length;n++)s[4*n]=t[n],s[4*n+1]=r[n],s[4*n+2]=0,s[4*n+3]=(255*a[n]<<16|255*o[n]<<8|255*h[n])/16777216;for(this.internalTex2=Gh(i,e,1,s),t=this.qRadialSpeed,r=this.qRadialSpeedDiv,a=Array(4*t.length),o=0;o<t.length;o++)a[4*o]=t[o],a[4*o+1]=r[o],a[4*o+2]=0,a[4*o+3]=0;this.internalTex3=Gh(i,e,1,a)}for(t=this.qColor,r=this.qAlpha,a=Array(4*r.length),o=0;o<r.length;o++)a[4*o]=t[3*o],a[4*o+1]=t[3*o+1],a[4*o+2]=t[3*o+2],a[4*o+3]=r[o];this.colorParam=Gh(i,e,1,a,7,1,!0)},_initializeTextures:function(){this.colorMap&&(this.material.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&this.material.setParameter("normalMap",this.normalMap))},regenShader:function(){var t=this.graphicsDevice.getProgramLibrary(),e=null!==this.normalMap;this.normalOption=0,this.lighting&&(this.normalOption=e?2:1),this.material.updateShader=function(){this.emitter.scene&&this.emitter.camera!=this.emitter.scene._activeCamera&&(this.emitter.camera=this.emitter.scene._activeCamera,this.emitter.onChangeCamera()),this.shader=t.getProgram("particle",{useCpu:this.emitter.useCpu,normal:this.emitter.normalOption,halflambert:this.emitter.halfLambert,stretch:this.emitter.stretch,alignToMotion:this.emitter.alignToMotion,soft:this.emitter.depthSoftening,mesh:this.emitter.useMesh,gamma:this.emitter.scene?this.emitter.scene.gammaCorrection:0,toneMap:this.emitter.scene?this.emitter.scene.toneMapping:0,fog:this.emitter.scene&&!this.emitter.noFog?this.emitter.scene.fog:"none",wrap:this.emitter.wrap&&this.emitter.wrapBounds,localSpace:this.emitter.localSpace,screenSpace:!this.emitter.inTools&&this.emitter.screenSpace,blend:this.blendType,animTex:this.emitter._isAnimated(),animTexLoop:this.emitter.animLoop,pack8:this.emitter.pack8,customFace:0!=this.emitter.orientation})},this.material.updateShader()},resetMaterial:function(){var t=this.material;t.setParameter("stretch",this.stretch),this._isAnimated()&&(t.setParameter("animTexTilesParams",this.animTilesParams),t.setParameter("animTexParams",this.animParams),t.setParameter("animTexIndexParams",this.animIndexParams)),t.setParameter("colorMult",this.intensity),this.useCpu||(t.setParameter("internalTex0",this.internalTex0),t.setParameter("internalTex1",this.internalTex1),t.setParameter("internalTex2",this.internalTex2),t.setParameter("internalTex3",this.internalTex3)),t.setParameter("colorParam",this.colorParam),t.setParameter("numParticles",this.numParticles),t.setParameter("numParticlesPot",this.numParticlesPot),t.setParameter("lifetime",this.lifetime),t.setParameter("rate",this.rate),t.setParameter("rateDiv",this.rate2-this.rate),t.setParameter("seed",this.seed),t.setParameter("scaleDivMult",this.scaleUMax[0]),t.setParameter("alphaDivMult",this.alphaUMax[0]),t.setParameter("radialSpeedDivMult",this.radialSpeedUMax[0]),t.setParameter("graphNumSamples",this.precision),t.setParameter("graphSampleSize",1/this.precision),t.setParameter("emitterScale",new Float32Array([1,1,1])),this.pack8&&(this._gpuUpdater._setInputBounds(),t.setParameter("inBoundsSize",this._gpuUpdater.inBoundsSizeUniform),t.setParameter("inBoundsCenter",this._gpuUpdater.inBoundsCenterUniform),t.setParameter("maxVel",this.maxVel)),this.wrap&&this.wrapBounds&&(this.wrapBoundsUniform[0]=this.wrapBounds.x,this.wrapBoundsUniform[1]=this.wrapBounds.y,this.wrapBoundsUniform[2]=this.wrapBounds.z,t.setParameter("wrapBounds",this.wrapBoundsUniform)),this.colorMap&&t.setParameter("colorMap",this.colorMap),this.lighting&&this.normalMap&&t.setParameter("normalMap",this.normalMap),0<this.depthSoftening&&t.setParameter("softening",1/(this.depthSoftening*this.depthSoftening*100)),0<this.stretch&&(t.cull=0),this._compParticleFaceParams()},_compParticleFaceParams:function(){if(0==this.orientation)var t=new Float32Array([1,0,0]),e=new Float32Array([0,0,1]);else{t=1==this.orientation?this.particleNormal.normalize():(null===this.node?x.IDENTITY:this.node.getWorldTransform()).transformVector(this.particleNormal).normalize();var i=new v(1,0,0);1==Math.abs(i.dot(t))&&i.set(0,0,1),e=(new v).cross(t,i).normalize(),i.cross(e,t).normalize(),t=new Float32Array([i.x,i.y,i.z]),e=new Float32Array([e.x,e.y,e.z])}this.material.setParameter("faceTangent",t),this.material.setParameter("faceBinorm",e)},_allocate:function(t){var e=t*this.numParticleVerts,i=t*this.numParticleIndices;if(void 0===this.vertexBuffer||this.vertexBuffer.getNumVertices()!==e){if(this.useCpu)var s=[{semantic:"ATTR0",components:4,type:6},{semantic:"ATTR1",components:4,type:6},{semantic:"ATTR2",components:4,type:6},{semantic:"ATTR3",components:1,type:6},{semantic:"ATTR4",components:this.useMesh?4:2,type:6}];else s=[{semantic:"ATTR0",components:4,type:6}],this.useMesh&&s.push({semantic:"ATTR1",components:2,type:6});if(s=new O(this.graphicsDevice,s),this.vertexBuffer=new C(this.graphicsDevice,s,e,1),this.indexBuffer=new rt(this.graphicsDevice,1,i),s=new Float32Array(this.vertexBuffer.lock()),this.useMesh){var n=new Float32Array(this.mesh.vertexBuffer.lock()),r=n.length/this.mesh.vertexBuffer.numVertices;for(i=0;i<this.mesh.vertexBuffer.format.elements.length;i++)if("TEXCOORD0"===this.mesh.vertexBuffer.format.elements[i].name){var a=this.mesh.vertexBuffer.format.elements[i].offset/4;break}}for(i=0;i<e;i++){var o=Math.floor(i/this.numParticleVerts);if(this.useMesh){var h=i%this.numParticleVerts;s[6*i]=n[h*r],s[6*i+1]=n[h*r+1],s[6*i+2]=n[h*r+2],s[6*i+3]=o,s[6*i+4]=n[h*r+a+0],s[6*i+5]=n[h*r+a+1]}else h=i%4,s[4*i]=jh[h][0],s[4*i+1]=jh[h][1],s[4*i+2]=0,s[4*i+3]=o}for(this.useCpu&&(this.vbCPU=new Float32Array(s),this.vbOld=new Float32Array(this.vbCPU.length)),this.vertexBuffer.unlock(),this.useMesh&&this.mesh.vertexBuffer.unlock(),e=0,r=new Uint16Array(this.indexBuffer.lock()),this.useMesh&&(n=new Uint16Array(this.mesh.indexBuffer[0].lock())),i=0;i<t;i++)if(this.useMesh)for(a=0;a<this.numParticleIndices;a++)r[i*this.numParticleIndices+a]=n[a]+i*this.numParticleVerts;else a=4*i,r[e++]=a,r[e++]=a+1,r[e++]=a+2,r[e++]=a,r[e++]=a+2,r[e++]=a+3;this.indexBuffer.unlock(),this.useMesh&&this.mesh.indexBuffer[0].unlock()}},reset:function(){if(this.beenReset=!0,this.seed=Math.random(),this.material.setParameter("seed",this.seed),this.useCpu)for(var t=0;t<this.particleTexStart.length;t++)this.particleTex[t]=this.particleTexStart[t];else this._initializeTextures();this.resetWorldBounds(),this.resetTime(),t=this.loop,this.loop=!0,this.addTime(0,!1),this.loop=t,this.preWarm&&this.prewarm(this.lifetime)},prewarm:function(t){var e=Math.min(Math.floor(t/this.lifetime*this.precision),this.precision);t/=e;for(var i=0;i<e;i++)this.addTime(t,!1)},resetTime:function(){var t=Math.max(this.rate,this.rate2)*this.numParticles+this.lifetime;this.endTime=Date.now()+1e3*t},finishFrame:function(){this.useCpu&&this.vertexBuffer.unlock()},addTime:function(t,e){var i=this.graphicsDevice;if(this.simTimeTotal+=t,this.calculateWorldBounds(),this._isAnimated()){var s=this.animTilesParams;s[0]=1/this.animTilesX,s[1]=1/this.animTilesY,(s=this.animParams)[0]=this.animStartFrame,s[1]=this.animNumFrames*this.animSpeed,s[2]=this.animNumFrames-1,s[3]=this.animNumAnimations-1,(s=this.animIndexParams)[0]=this.animIndex,s[1]=this.randomizeAnimIndex}if(this.scene&&this.camera!=this.scene._activeCamera&&(this.camera=this.scene._activeCamera,this.onChangeCamera()),0===this.emitterShape&&(Kh[0]=0!=this.emitterExtents.x?this.emitterExtentsInner.x/this.emitterExtents.x:0,Kh[1]=0!=this.emitterExtents.y?this.emitterExtentsInner.y/this.emitterExtents.y:0,Kh[2]=0!=this.emitterExtents.z?this.emitterExtentsInner.z/this.emitterExtents.z:0,null===this.meshInstance.node?$h.setTRS(v.ZERO,S.IDENTITY,this.emitterExtents):$h.setTRS(v.ZERO,this.meshInstance.node.getRotation(),Zh.copy(this.emitterExtents).mul(this.meshInstance.node.localScale))),s=null===this.meshInstance.node?v.ONE:this.meshInstance.node.localScale,this.emitterScaleUniform[0]=s.x,this.emitterScaleUniform[1]=s.y,this.emitterScaleUniform[2]=s.z,this.material.setParameter("emitterScale",this.emitterScaleUniform),this.localSpace&&this.meshInstance.node){var n=this.meshInstance.node.getPosition();this.emitterPosUniform[0]=n.x,this.emitterPosUniform[1]=n.y,this.emitterPosUniform[2]=n.z,this.material.setParameter("emitterPos",this.emitterPosUniform)}this._compParticleFaceParams(),this.useCpu?(i=new Float32Array(this.vertexBuffer.lock()),this._cpuUpdater.update(i,this.vbToSort,this.particleTex,$h,Kh,n,t,e)):this._gpuUpdater.update(i,$h,Kh,t,e),!this.loop&&Date.now()>this.endTime&&(this.onFinished&&this.onFinished(),this.meshInstance.visible=!1),this.meshInstance&&(this.meshInstance.drawOrder=this.drawOrder)},_destroyResources:function(){this.particleTexIN&&(this.particleTexIN.destroy(),this.particleTexIN=null),this.particleTexOUT&&(this.particleTexOUT.destroy(),this.particleTexOUT=null),this.particleTexStart&&this.particleTexStart.destroy&&(this.particleTexStart.destroy(),this.particleTexStart=null),this.rtParticleTexIN&&(this.rtParticleTexIN.destroy(),this.rtParticleTexIN=null),this.rtParticleTexOUT&&(this.rtParticleTexOUT.destroy(),this.rtParticleTexOUT=null),this.internalTex0&&(this.internalTex0.destroy(),this.internalTex0=null),this.internalTex1&&(this.internalTex1.destroy(),this.internalTex1=null),this.internalTex2&&(this.internalTex2.destroy(),this.internalTex2=null),this.internalTex3&&(this.internalTex3.destroy(),this.internalTex3=null),this.colorParam&&(this.colorParam.destroy(),this.colorParam=null),this.vertexBuffer&&(this.vertexBuffer.destroy(),this.vertexBuffer=void 0),this.indexBuffer&&(this.indexBuffer.destroy(),this.indexBuffer=void 0),this.material&&(this.material.destroy(),this.material=null)},destroy:function(){this.camera=null,this._destroyResources()}}),ce.prototype=Object.create(n.prototype),ce.prototype.constructor=ce,ce.prototype.destroy=function(){this.root=null,this.defaultMaterial.destroy(),this.defaultMaterial=null,this.off()},Object.defineProperty(ce.prototype,"fog",{get:function(){return this._fog},set:function(t){t!==this._fog&&(this._fog=t,this.updateShaders=!0)}}),Object.defineProperty(ce.prototype,"gammaCorrection",{get:function(){return this._gammaCorrection},set:function(t){t!==this._gammaCorrection&&(this._gammaCorrection=t,this.updateShaders=!0)}}),Object.defineProperty(ce.prototype,"toneMapping",{get:function(){return this._toneMapping},set:function(t){t!==this._toneMapping&&(this._toneMapping=t,this.updateShaders=!0)}}),Object.defineProperty(ce.prototype,"skybox",{get:function(){return this._skyboxCubeMap},set:function(t){this._skyboxCubeMap=t,this._resetSkyboxModel(),this.updateShaders=!0}}),Object.defineProperty(ce.prototype,"skyboxIntensity",{get:function(){return this._skyboxIntensity},set:function(t){this._skyboxIntensity=t,this._resetSkyboxModel(),this.updateShaders=!0}}),Object.defineProperty(ce.prototype,"skyboxMip",{get:function(){return this._skyboxMip},set:function(t){this._skyboxMip=t,this._resetSkyboxModel(),this.updateShaders=!0}}),Object.defineProperty(ce.prototype,"skyboxPrefiltered128",{get:function(){return this._skyboxPrefiltered[0]},set:function(t){this._skyboxPrefiltered[0]!==t&&(this._skyboxPrefiltered[0]=t,this.updateShaders=!0)}}),Object.defineProperty(ce.prototype,"skyboxPrefiltered64",{get:function(){return this._skyboxPrefiltered[1]},set:function(t){this._skyboxPrefiltered[1]!==t&&(this._skyboxPrefiltered[1]=t,this.updateShaders=!0)}}),Object.defineProperty(ce.prototype,"skyboxPrefiltered32",{get:function(){return this._skyboxPrefiltered[2]},set:function(t){this._skyboxPrefiltered[2]!==t&&(this._skyboxPrefiltered[2]=t,this.updateShaders=!0)}}),Object.defineProperty(ce.prototype,"skyboxPrefiltered16",{get:function(){return this._skyboxPrefiltered[3]},set:function(t){this._skyboxPrefiltered[3]!==t&&(this._skyboxPrefiltered[3]=t,this.updateShaders=!0)}}),Object.defineProperty(ce.prototype,"skyboxPrefiltered8",{get:function(){return this._skyboxPrefiltered[4]},set:function(t){this._skyboxPrefiltered[4]!==t&&(this._skyboxPrefiltered[4]=t,this.updateShaders=!0)}}),Object.defineProperty(ce.prototype,"skyboxPrefiltered4",{get:function(){return this._skyboxPrefiltered[5]},set:function(t){this._skyboxPrefiltered[5]!==t&&(this._skyboxPrefiltered[5]=t,this.updateShaders=!0)}}),Object.defineProperty(ce.prototype,"drawCalls",{get:function(){var t=this.layers._meshInstances;return t.length||(this.layers._update(),t=this.layers._meshInstances),t},set:function(t){}}),Object.defineProperty(ce.prototype,"layers",{get:function(){return this._layers},set:function(t){var e=this._layers;this._layers=t,this.fire("set:layers",e,t)}}),ce.prototype.applySettings=function(t){this._gravity.set(t.physics.gravity[0],t.physics.gravity[1],t.physics.gravity[2]),this.ambientLight.set(t.render.global_ambient[0],t.render.global_ambient[1],t.render.global_ambient[2]),this._fog=t.render.fog,this.fogColor.set(t.render.fog_color[0],t.render.fog_color[1],t.render.fog_color[2]),this.fogStart=t.render.fog_start,this.fogEnd=t.render.fog_end,this.fogDensity=t.render.fog_density,this._gammaCorrection=t.render.gamma_correction,this._toneMapping=t.render.tonemapping,this.lightmapSizeMultiplier=t.render.lightmapSizeMultiplier,this.lightmapMaxResolution=t.render.lightmapMaxResolution,this.lightmapMode=t.render.lightmapMode,this.exposure=t.render.exposure,this._skyboxIntensity=void 0===t.render.skyboxIntensity?1:t.render.skyboxIntensity,this._skyboxMip=void 0===t.render.skyboxMip?0:t.render.skyboxMip,this._resetSkyboxModel(),this.updateShaders=!0},ce.prototype._updateSkybox=function(t){if(!this.skyboxModel){var e=[0,1,3,4,5,6],i=this._skyboxMip?this._skyboxPrefiltered[e[this._skyboxMip]]||this._skyboxPrefiltered[0]||this._skyboxCubeMap:this._skyboxCubeMap||this._skyboxPrefiltered[0];if(i){var s=new nr,n=this;if(s.updateShader=function(e,s,r,a,o){this.shader=t.getProgramLibrary().getProgram("skybox",{rgbm:"rgbm"===i.type,hdr:"rgbm"===i.type||14===i.format,useIntensity:1!==n.skyboxIntensity,mip:i.fixCubemapSeams?n.skyboxMip:0,fixSeams:i.fixCubemapSeams,gamma:1===o?n.gammaCorrection?3:0:n.gammaCorrection,toneMapping:1===o?0:n.toneMapping})},s.updateShader(),s.setParameter("texture_cubeMap",i),s.cull=2,s.depthWrite=!1,e=this.layers.getLayerById(2)){var r=new Mt,a=le(t);(s=new lt(r,a,s)).cull=!1,s._noDepthDrawGl1=!0,(a=new mt).graph=r,a.meshInstances=[s],this.skyboxModel=a,e.addMeshInstances(a.meshInstances),this.skyLayer=e,this._firstUpdateSkybox&&(e.enabled=!0,this._firstUpdateSkybox=!1),this.fire("set:skybox",i)}}}},ce.prototype._resetSkyboxModel=function(){this.skyboxModel&&(this.skyLayer.removeMeshInstances(this.skyboxModel.meshInstances),this.skyboxModel.destroy()),this.skyboxModel=null,this.updateSkybox=!0},ce.prototype.setSkybox=function(t){var e;t||(t=[null,null,null,null,null,null,null]);var i=!1;if(this._skyboxCubeMap!==t[0]&&(i=!0),!i)for(e=0;6>e&&!i;e++)this._skyboxPrefiltered[e]!==t[e+1]&&(i=!0);if(i){for(e=0;6>e;e++)this._skyboxPrefiltered[e]=t[e+1];this.skybox=t[0]}},ce.prototype.destroy=function(){this.skybox=null},ce.prototype.addModel=function(t){if(!this.containsModel(t)){var e=this.layers.getLayerById(0);e&&(e.addMeshInstances(t.meshInstances),this._models.push(t))}},ce.prototype.addShadowCaster=function(t){var e=this.layers.getLayerById(0);e&&e.addShadowCasters(t.meshInstances)},ce.prototype.removeModel=function(t){var e=this._models.indexOf(t);if(-1!==e){var i=this.layers.getLayerById(0);i&&(i.removeMeshInstances(t.meshInstances),this._models.splice(e,1))}},ce.prototype.removeShadowCasters=function(t){var e=this.layers.getLayerById(0);e&&e.removeShadowCasters(t.meshInstances)},ce.prototype.containsModel=function(t){return 0<=this._models.indexOf(t)},ce.prototype.getModels=function(t){return this._models},ue()){var el=function(t,e,i){i=i||{},this.volume=void 0===i.volume?1:i.volume,this.loop=void 0!==i.loop&&i.loop,this.pitch=void 0===i.pitch?1:i.pitch,this.sound=e,this.suspended=this.paused=!1,this.startOffset=this.startTime=0,this.manager=t,this.source=null,this.gain=t.context.createGain()};Object.assign(el.prototype,{play:function(){if(this.source)throw Error("Call stop() before calling play()");this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended)&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.startOffset+=this.manager.context.currentTime-this.startTime,this.source.stop(0),this.source=null)},unpause:function(){this.source||!this.paused?console.warn("Call pause() before unpausing."):(this._createSource(),this.source&&(this.startTime=this.manager.context.currentTime,this.source.start(0,this.startOffset%this.source.buffer.duration),this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.paused=!1))},stop:function(){this.source&&(this.source.stop(0),this.source=null),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setLoop:function(t){this.loop=t,this.source&&(this.source.loop=t)},setVolume:function(t){this.volume=t=oa.clamp(t,0,1),this.gain&&(this.gain.gain.value=t*this.manager.volume)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate.value=t)},isPlaying:function(){return!this.paused&&this.source.playbackState===this.source.PLAYING_STATE},getDuration:function(){return this.source?this.source.buffer.duration:0},_createSource:function(){var t=this.manager.context;this.sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this)))}})}else de()?(el=function(t,e,i){this.volume=i.volume||1,this.loop=i.loop||!1,this.sound=e,this.pitch=void 0!==i.pitch?i.pitch:1,this.suspended=this.paused=!1,this.manager=t,e.audio&&(this.source=e.audio.cloneNode(!1),this.source.pause())},Object.assign(el.prototype,{play:function(){this.source&&(this.paused=!1,this.setVolume(this.volume),this.setLoop(this.loop),this.setPitch(this.pitch),this.source.play()),this.manager.on("volumechange",this.onManagerVolumeChange,this),this.manager.on("suspend",this.onManagerSuspend,this),this.manager.on("resume",this.onManagerResume,this),this.manager.suspended&&this.onManagerSuspend()},pause:function(){this.source&&(this.paused=!0,this.source.pause())},unpause:function(){this.source&&(this.paused=!1,this.source.play())},stop:function(){this.source&&this.source.pause(),this.manager.off("volumechange",this.onManagerVolumeChange,this),this.manager.off("suspend",this.onManagerSuspend,this),this.manager.off("resume",this.onManagerResume,this)},setVolume:function(t){this.volume=t=oa.clamp(t,0,1),this.source&&(this.source.volume=t*this.manager.volume)},setLoop:function(t){this.loop=t,this.source&&(this.source.loop=t)},setPitch:function(t){this.pitch=t,this.source&&(this.source.playbackRate=t)},getDuration:function(){return this.source&&!isNaN(this.source.duration)?this.source.duration:0},isPlaying:function(){return!this.source.paused}})):el=function(){};Object.assign(el.prototype,{getVolume:function(){return this.volume},getLoop:function(){return this.loop},getPitch:function(){return this.pitch},onManagerVolumeChange:function(){this.setVolume(this.getVolume())},onManagerSuspend:function(){this.isPlaying()&&!this.suspended&&(this.suspended=!0,this.pause())},onManagerResume:function(){this.suspended&&(this.suspended=!1,this.unpause())}});var il="inverse";if(ue()){var sl=function(t,e,i){el.call(this,t,e,i),this.position=new v,this.velocity=new v,this.panner=t.context.createPanner()};sl.prototype=Object.create(el.prototype),sl.prototype.constructor=sl,Object.assign(sl.prototype,{getPosition:function(){return this.position},setPosition:function(t){this.position.copy(t),this.panner.setPosition(t.x,t.y,t.z)},getVelocity:function(){return this.velocity},setVelocity:function(t){this.velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(t){this.panner.maxDistance=t},getMinDistance:function(){return this.panner.refDistance},setMinDistance:function(t){this.panner.refDistance=t},getRollOffFactor:function(){return this.panner.rolloffFactor},setRollOffFactor:function(t){this.panner.rolloffFactor=t},getDistanceModel:function(){return this.pannel.distanceModel},setDistanceModel:function(t){this.panner.distanceModel=t},_createSource:function(){var t=this.manager.context;this.source=t.createBufferSource(),this.source.buffer=this.sound.buffer,this.source.connect(this.panner),this.panner.connect(this.gain),this.gain.connect(t.destination),this.loop||(this.source.onended=this.pause.bind(this))}})}else if(de()){var nl=new v;(sl=function(t,e){el.call(this,t,e),this.position=new v,this.velocity=new v,this.maxDistance=1e4,this.rollOffFactor=this.minDistance=1,this.distanceModel=il}).prototype=Object.create(el.prototype),sl.prototype.constructor=sl,Object.assign(sl.prototype,{getPosition:function(){return this.position},setPosition:function(t){if(this.position.copy(t),this.source){var e=this.manager.listener.getPosition();t=this.minDistance;var i=this.maxDistance,s=this.rollOffFactor,n=this.distanceModel;if((e=(nl=nl.sub2(e,this.position)).length())<t)t=1;else if(e>i)t=0;else{var r=0;"linear"===n?r=1-s*(e-t)/(i-t):n===il?r=t/(t+s*(e-t)):"exponential"===n&&(r=Math.pow(e/t,-s)),t=oa.clamp(r,0,1)}i=this.getVolume(),this.source.volume=i*t}},getVelocity:function(){return this.velocity},setVelocity:function(t){this.velocity.copy(t)},getMaxDistance:function(){return this.maxDistance},setMaxDistance:function(t){this.maxDistance=t},getMinDistance:function(){return this.minDistance},setMinDistance:function(t){this.minDistance=t},getRollOffFactor:function(){return this.rollOffFactor},setRollOffFactor:function(t){this.rollOffFactor=t},getDistanceModel:function(){return this.distanceModel},setDistanceModel:function(t){this.distanceModel=t}})}else sl=function(){};Object.assign(pe.prototype,{getPosition:function(){return this.position},setPosition:function(t){this.position.copy(t),this.listener&&this.listener.setPosition(t.x,t.y,t.z)},getVelocity:function(){return this.velocity},setVelocity:function(t){this.velocity.copy(t),this.listener&&this.listener.setPosition(t.x,t.y,t.z)},setOrientation:function(t){this.orientation.copy(t),this.listener&&this.listener.setOrientation(-t.data[8],-t.data[9],-t.data[10],t.data[4],t.data[5],t.data[6])},getOrientation:function(){return this.orientation}}),fe.prototype=Object.create(n.prototype),fe.prototype.constructor=fe,Object.assign(fe.prototype,{suspend:function(){this.suspended=!0,this.fire("suspend")},resume:function(){this.suspended=!1,this.fire("resume")},destroy:function(){window.removeEventListener("mousedown",this.resumeContext),window.removeEventListener("touchend",this.resumeContext),this.fire("destroy"),this.context&&this.context.close&&(this.context.close(),this.context=null)},playSound:function(t,e){e=e||{};var i=null;return el&&(i=new el(this,t,e)).play(),i},playSound3d:function(t,e,i){i=i||{};var s=null;return sl&&((s=new sl(this,t,i)).setPosition(e),i.volume&&s.setVolume(i.volume),i.loop&&s.setLoop(i.loop),i.maxDistance&&s.setMaxDistance(i.maxDistance),i.minDistance&&s.setMinDistance(i.minDistance),i.rollOffFactor&&s.setRollOffFactor(i.rollOffFactor),i.distanceModel&&s.setDistanceModel(i.distanceModel),s.play()),s}}),Object.defineProperty(fe.prototype,"volume",{get:function(){return this._volume},set:function(t){this._volume=t=oa.clamp(t,0,1),this.fire("volumechange",t)}}),ge.prototype.getDuration=function(){return this.duration},ge.prototype.getName=function(){return this.name},ge.prototype.getNode=function(t){return this._nodeDict[t]},Object.defineProperty(ge.prototype,"nodes",{get:function(){return this._nodes}}),ge.prototype.getNodes=function(){return this._nodes},ge.prototype.setDuration=function(t){this.duration=t},ge.prototype.setName=function(t){this.name=t},ge.prototype.addNode=function(t){this._nodes.push(t),this._nodeDict[t._name]=t},Object.defineProperties(ye.prototype,{morphPositions:{get:function(){return!!this._vertexBufferPositions||!!this.texturePositions}},morphNormals:{get:function(){return!!this._vertexBufferNormals||!!this.textureNormals}}}),Object.assign(ye.prototype,{_postInit:function(){this.options=null},_initVertexBuffers:function(t){var e=this.options;this._vertexBufferPositions=this._createVertexBuffer(t,e.deltaPositions,e.deltaPositionsType),this._vertexBufferNormals=this._createVertexBuffer(t,e.deltaNormals,e.deltaNormalsType),this._vertexBufferPositions&&(this.deltaPositions=this._vertexBufferPositions.lock())},_createVertexBuffer:function(t,e,i){return e?new C(t,new O(t,[{semantic:"ATTR0",components:3,type:i||6}]),e.length/3,0,e):null},_setTexture:function(t,e){this[t]=e},destroy:function(){this._vertexBufferPositions&&(this._vertexBufferPositions.destroy(),this._vertexBufferPositions=null),this._vertexBufferNormals&&(this._vertexBufferNormals.destroy(),this._vertexBufferNormals=null),this.texturePositions&&(this.texturePositions.destroy(),this.texturePositions=null),this.textureNormals&&(this.textureNormals.destroy(),this.textureNormals=null)}}),Object.assign(be.prototype,{encode:function(t){return Ce.joinPath([Ce.joinPath(t[0]),t[1],Ce.joinPath(t[2])],"/")},decode:function(t){return t=Ce.splitPath(t,"/"),[Ce.splitPath(t[0]),t[1],Ce.splitPath(t[2])]}}),xe.prototype=Object.create(Mt.prototype),xe.prototype.constructor=xe,xe.prototype.addComponent=function(t,e){var i=this._app.systems[t];return!i||this.c[t]?null:i.addComponent(this,e)},xe.prototype.removeComponent=function(t){var e=this._app.systems[t];e&&this.c[t]&&e.removeComponent(this)},xe.prototype.findComponent=function(t){var e=this.findOne(function(e){return e.c&&e.c[t]});return e&&e.c[t]},xe.prototype.findComponents=function(t){return this.find(function(e){return e.c&&e.c[t]}).map(function(e){return e.c[t]})},xe.prototype.getGuid=function(){return this._guid||this.setGuid(ea.create()),this._guid},xe.prototype.setGuid=function(t){var e=this._app._entityIndex;this._guid&&delete e[this._guid],this._guid=t,e[this._guid]=this},xe.prototype._notifyHierarchyStateChanged=function(t,e){var i=!1;t===this&&0===this._app._enableList.length&&(i=!0),t._beingEnabled=!0,t._onHierarchyStateChanged(e),t._onHierarchyStatePostChanged&&this._app._enableList.push(t);var s,n=t._children,r=0;for(s=n.length;r<s;r++)n[r]._enabled&&this._notifyHierarchyStateChanged(n[r],e);if(t._beingEnabled=!1,i){for(r=0;r<this._app._enableList.length;r++)this._app._enableList[r]._onHierarchyStatePostChanged();this._app._enableList.length=0}},xe.prototype._onHierarchyStateChanged=function(t){Mt.prototype._onHierarchyStateChanged.call(this,t);var e,i=this.c;for(e in i)if(i.hasOwnProperty(e)){var s=i[e];s.enabled&&(t?s.onEnable():s.onDisable())}},xe.prototype._onHierarchyStatePostChanged=function(){var t,e=this.c;for(t in e)e.hasOwnProperty(t)&&e[t].onPostStateChange()},xe.prototype.findByGuid=function(t){return this._guid===t?this:(t=this._app._entityIndex[t])&&(t===this||t.isDescendantOf(this))?t:null},xe.prototype.destroy=function(){for(t in this._destroying=!0,this.c)this.c[t].enabled=!1;for(t in this.c)this.c[t].system.removeComponent(this);this._parent&&this._parent.removeChild(this);for(var t=this._children,e=t.shift();e;)e instanceof xe&&e.destroy(),e._parent=null,e=t.shift();this.fire("destroy",this),this.off(),this._guid&&delete this._app._entityIndex[this._guid],this._destroying=!1},xe.prototype.clone=function(){var t={},e=this._cloneRecursively(t);return t[this.getGuid()]=e,function t(e,i,s,n){var r;if(i instanceof xe){var a,o=i.c;for(a in o){var h=o[a],l=h.system.getPropertiesOfType("entity"),c=0;for(r=l.length;c<r;c++){var d=l[c].name,u=h[d];e.findByGuid(u)&&((u=n[u].getGuid())?s.c[a][d]=u:console.warn("Could not find corresponding entity id when resolving duplicated entity references"))}}for(o.script&&!s._app.useLegacyScriptAttributeCloning&&s.script.resolveDuplicatedEntityReferenceProperties(o.script,n),i=i.children.filter(function(t){return t instanceof xe}),s=s.children.filter(function(t){return t instanceof xe}),c=0,r=i.length;c<r;c++)t(e,i[c],s[c],n)}}(this,this,e,t),e},xe.prototype._cloneRecursively=function(t){var e=new xe(this._app);for(var i in Mt.prototype._cloneInternal.call(this,e),this.c)this.c[i].system.cloneComponent(this,e);for(i=0;i<this._children.length;i++){var s=this._children[i];if(s instanceof xe){var n=s._cloneRecursively(t);e.addChild(n),t[s.getGuid()]=n}}return e},Object.defineProperties(Se.prototype,{components:{get:function(){return this._components}},data:{get:function(){return this._data}}}),Object.assign(Te.prototype,{update:function(t,e){if(t<this._left||t>=this._right){var i=e.length;i?t<e[0]?(this._left=-1/0,this._right=e[0],this._p0=this._p1=this._recip=this._len=0):t>=e[i-1]?(this._left=e[i-1],this._right=1/0,this._recip=this._len=0,this._p0=this._p1=i-1):(i=this._findKey(t,e),this._left=e[i],this._right=e[i+1],this._len=this._right-this._left,e=1/this._len,this._recip=isFinite(e)?e:0,this._p0=i,this._p1=i+1):(this._left=-1/0,this._right=1/0,this._p0=this._p1=this._recip=this._len=0)}this._t=0===this._recip?0:(t-this._left)*this._recip,this._hermite.valid=!1},_findKey:function(t,e){for(var i=0;t>=e[i+1];)i++;return i},eval:function(t,e,i){var s=i._data;i=i._components;var n,r=this._p0*i;if(0===e)for(n=0;n<i;++n)t[n]=s[r+n];else{var a=this._t,o=this._p1*i;switch(e){case 1:for(n=0;n<i;++n)t[n]=oa.lerp(s[r+n],s[o+n],a);break;case 2:(e=this._hermite).valid||(n=a*a,r=a+a,o=1-a,o*=o,e.valid=!0,e.p0=(1+r)*o,e.m0=a*o,e.p1=n*(3-r),e.m1=n*(a-1)),a=(3*this._p0+1)*i,r=(3*this._p0+2)*i,o=(3*this._p1+1)*i;var h=3*this._p1*i;for(n=0;n<i;++n)t[n]=e.p0*s[a+n]+e.m0*s[r+n]*this._len+e.p1*s[o+n]+e.m1*s[h+n]*this._len}}}}),Object.defineProperties(we.prototype,{paths:{get:function(){return this._paths}},input:{get:function(){return this._input}},output:{get:function(){return this._output}},interpolation:{get:function(){return this._interpolation}}}),Object.defineProperties(Me.prototype,{name:{get:function(){return this._name}},duration:{get:function(){return this._duration}},inputs:{get:function(){return this._inputs}},outputs:{get:function(){return this._outputs}},curves:{get:function(){return this._curves}}}),Object.assign(Me.prototype,{eval:function(t,e){e._time=t;var i,s=this._inputs,n=this._outputs,r=this._curves,a=e._cache;for(e=e._results,i=0;i<s.length;++i)a[i].update(t,s[i]._data);for(i=0;i<r.length;++i)a[(t=r[i])._input].eval(e[i],t._interpolation,n[t._output])}}),Object.defineProperties(Ae.prototype,{name:{get:function(){return this._name},set:function(t){this._name=t}},track:{get:function(){return this._track}},snapshot:{get:function(){return this._snapshot}},time:{get:function(){return this._time},set:function(t){this._time=t}},speed:{get:function(){return this._speed},set:function(t){this._speed=t}},loop:{get:function(){return this._loop},set:function(t){this._loop=t}},blendWeight:{get:function(){return this._blendWeight},set:function(t){this._blendWeight=t}},blendOrder:{get:function(){return this._blendOrder},set:function(t){this._blendOrder=t}}}),Object.assign(Ae.prototype,{_update:function(t){if(this._playing){var e=this._time,i=this._track.duration,s=this._speed,n=this._loop;e+=s*t,0<=s?e>i&&(n?e=e%i||0:(e=this._track.duration,this.pause())):0>e&&(n?e=i+(e%i||0):(e=0,this.pause())),this._time=e}this._time!=this._snapshot._time&&this._track.eval(this._time,this._snapshot)},play:function(){this._playing=!0,this._time=0},stop:function(){this._playing=!1,this._time=0},pause:function(){this._playing=!1},resume:function(){this._playing=!0},reset:function(){this._time=0}}),Object.defineProperties(Ee.prototype,{func:{get:function(){return this._func}},type:{get:function(){return this._type}},components:{get:function(){return this._components}}}),Ce.joinPath=function(t,e){return e=e||".",t.map(function(t){return t.replace(/\\/g,"\\\\").replace(new RegExp("\\"+e,"g"),"\\"+e)}).join(e)},Ce.splitPath=function(t,e){e=e||".";for(var i=[],s="",n=0;n<t.length;){var r=t[n++];"\\"===r&&n<t.length?s="\\"===(r=t[n++])||r===e?s+r:s+"\\"+r:r===e?(i.push(s),s=""):s+=r}return 0<s.length&&i.push(s),i},Object.assign(Ce.prototype,{resolve:function(t){return null},unresolve:function(t){},update:function(t){}}),Object.assign(Ie.prototype,{resolve:function(t){var e=this.propertyLocator.decode(t);return(t=this.nodes[e[0][0]||""])&&(e=this.handlers[e[2][0]])&&(e=e(t.node))?(0===t.count&&this.activeNodes.push(t.node),t.count++,e):null},unresolve:function(t){if("graph"===(t=this.propertyLocator.decode(t))[1]){var e=this.nodes[t[0][0]];if(e.count--,0===e.count){e=(t=this.activeNodes).indexOf(e.node);var i=t.length;e<i-1&&(t[e]=t[i-1]),t.pop()}}},update:function(t){t=this.activeNodes;for(var e=0;e<t.length;++e)t[e]._dirtifyLocal()}}),Object.defineProperties(Oe.prototype,{clips:{get:function(){return this._clips}}}),Oe._dot=function(t,e){for(var i=t.length,s=0,n=0;n<i;++n)s+=t[n]*e[n];return s},Oe._normalize=function(t){var e=Oe._dot(t,t);if(0<e){e=1/Math.sqrt(e);for(var i=t.length,s=0;s<i;++s)t[s]*=e}},Oe._set=function(t,e,i){var s=t.length;if("quaternion"===i){var n=Oe._dot(e,e);for(0<n&&(n=1/Math.sqrt(n)),i=0;i<s;++i)t[i]=e[i]*n}else for(i=0;i<s;++i)t[i]=e[i]},Oe._blendVec=function(t,e,i){for(var s=1-i,n=t.length,r=0;r<n;++r)t[r]=t[r]*s+e[r]*i},Oe._blendQuat=function(t,e,i){var s=t.length,n=1-i;0>Oe._dot(t,e)&&(i=-i);for(var r=0;r<s;++r)t[r]=t[r]*n+e[r]*i;Oe._normalize(t)},Oe._blend=function(t,e,i,s){"quaternion"===s?Oe._blendQuat(t,e,i):Oe._blendVec(t,e,i)},Oe._stableSort=function(t,e){for(var i=t.length,s=0;s<i-1;++s)for(var n=s+1;n<i;++n)if(e(t[n],t[s])){var r=t[s];t[s]=t[n],t[n]=r}},Object.assign(Oe.prototype,{addClip:function(t){for(var e=this._targets,i=t.track.curves,s=t.snapshot,n=[],r=[],a=0;a<i.length;++a)for(var o=i[a].paths,h=0;h<o.length;++h){var l=o[h],c=e[l];if(!c){var d=this._binder.resolve(l);if(d){for(c={target:d,value:[],curves:0,blendCounter:0},d=0;d<c.target.components;++d)c.value.push(0);e[l]=c}}c&&(c.curves++,n.push(s._results[a]),r.push(c))}this._clips.push(t),this._inputs.push(n),this._outputs.push(r)},removeClip:function(t){for(var e=this._targets,i=this._clips,s=i[t].track.curves,n=0;n<s.length;++n)for(var r=s[n].paths,a=0;a<r.length;++a){var o=r[a],h=e[o];h&&(h.curves--,0===h.curves&&(this._binder.unresolve(o),delete e[o]))}i.splice(t,1),this._inputs.splice(t,1),this._outputs.splice(t,1)},removeClips:function(){for(;0<this._clips.length;)this.removeClip(0)},findClip:function(t){for(var e=this._clips,i=0;i<e.length;++i){var s=e[i];if(s.name===t)return s}return null},update:function(t){var e,i=this._clips,s=i.map(function(t,e){return e});for(Oe._stableSort(s,function(t,e){return i[t].blendOrder<i[e].blendOrder}),e=0;e<i.length;++e){var n=s[e],r=i[n],a=this._inputs[n];n=this._outputs[n];var o=r.blendWeight;if(0<o&&r._update(t),1<=o)for(r=0;r<a.length;++r){var h=a[r],l=n[r],c=l.value;Oe._set(c,h,l.target.type),l.blendCounter++}else if(0<o)for(r=0;r<a.length;++r)h=a[r],c=(l=n[r]).value,0===l.blendCounter?Oe._set(c,h,l.target.type):Oe._blend(c,h,o,l.target.type),l.blendCounter++}for(var d in s=this._targets)s.hasOwnProperty(d)&&((e=s[d]).target.func(e.value),e.blendCounter=0);this._binder.update(t)}}),Re.prototype._validate=function(t){if(!t.header)throw Error('pc.I18n#addData: Missing "header" field');if(!t.header.version)throw Error('pc.I18n#addData: Missing "header.version" field');if(1!==t.header.version)throw Error('pc.I18n#addData: Invalid "header.version" field');if(!t.data)throw Error('pc.I18n#addData: Missing "data" field');if(!Array.isArray(t.data))throw Error('pc.I18n#addData: "data" field must be an array');for(var e=0,i=t.data.length;e<i;e++){var s=t.data[e];if(!s.info)throw Error('pc.I18n#addData: missing "data['+e+'].info" field');if(!s.info.locale)throw Error('pc.I18n#addData: missing "data['+e+'].info.locale" field');if("string"!=typeof s.info.locale)throw Error('pc.I18n#addData: "data['+e+'].info.locale" must be a string');if(!s.messages)throw Error('pc.I18n#addData: missing "data['+e+'].messages" field')}},Re.prototype.parse=function(t){return t.data};var rl={},al=function(t,e){for(var i=0,s=t.length;i<s;i++)rl[t[i]]=e},ol=function(t){var e=t.indexOf("-");return-1!==e?t.substring(0,e):t},hl="en-US",ll={en:"en-US",es:"en-ES",zh:"zh-CN","zh-HK":"zh-TW","zh-TW":"zh-HK","zh-MO":"zh-HK",fr:"fr-FR",de:"de-DE",it:"it-IT",ru:"ru-RU",ja:"ja-JP"};al("ja ko th vi zh id".split(" "),function(t){return 0}),al(["fa","hi"],function(t){return 0<=t&&1>=t?0:1}),al(["fr","pt"],function(t){return 0<=t&&2>t?0:1}),al(["da"],function(t){return 1===t||!Number.isInteger(t)&&0<=t&&1>=t?0:1}),al("de en it el es tr fi sv nb no ur".split(" "),function(t){return 1===t?0:1}),al(["ru","uk"],function(t){if(Number.isInteger(t)){var e=t%10;if(t%=100,1===e&&11!==t)return 0;if(2<=e&&4>=e&&(12>t||14<t))return 1;if(0===e||5<=e&&9>=e||11<=t&&14>=t)return 2}return 3}),al(["pl"],function(t){if(Number.isInteger(t)){if(1===t)return 0;var e=t%10;if(t%=100,2<=e&&4>=e&&(12>t||14<t))return 1;if(0<=e&&1>=e||5<=e&&9>=e||12<=t&&14>=t)return 2}return 3}),al(["ar"],function(t){if(0===t)return 0;if(1===t)return 1;if(2===t)return 2;if(Number.isInteger(t)){if(3<=(t%=100)&&10>=t)return 3;if(11<=t&&99>=t)return 4}return 5});var cl=rl[ol(hl)];De.prototype=Object.create(n.prototype),De.prototype.constructor=De,De.findAvailableLocale=function(t,e){if(e[t])return t;var i=ll[t];return i&&e[i]?i:(t=ol(t),e[i=ll[t]]?i:e[t]?t:hl)},De.prototype.getText=function(t,e){var i=t;if(!e){e=this._locale;var s=this._lang}var n=this._translations[e];return n||(s||(s=ol(e)),e=this._findFallbackLocale(e,s),n=this._translations[e]),n&&n.hasOwnProperty(t)&&(i=n[t],Array.isArray(i)&&(i=i[0]),null==i)&&(i=t),i},De.prototype.getPluralText=function(t,e,i){var s=t;if(i)var n=ol(i),r=rl[n]||cl;else i=this._locale,n=this._lang,r=this._pluralFn;var a=this._translations[i];return a||(i=this._findFallbackLocale(i,n),n=ol(i),r=rl[n]||cl,a=this._translations[i]),a&&a[t]&&r&&(e=r(e),null==(s=a[t][e]))&&(s=t),s},De.prototype.addData=function(t){try{var e=this._parser.parse(t)}catch(t){return void console.error(t)}t=0;for(var i=e.length;t<i;t++){var s=e[t],n=s.info.locale;if(s=s.messages,!this._translations[n]){this._translations[n]={};var r=ol(n);this._availableLangs[r]||(this._availableLangs[r]=n)}Object.assign(this._translations[n],s),this.fire("data:add",n,s)}},De.prototype.removeData=function(t){var e;try{var i=this._parser.parse(t)}catch(t){return void console.error(t)}t=0;for(var s=i.length;t<s;t++){var n=i[t],r=n.info.locale,a=this._translations[r];if(a){for(e in n=n.messages)delete a[e];var o=!1;for(e in a){o=!0;break}o||(delete this._translations[r],delete this._availableLangs[ol(r)]),this.fire("data:remove",r,n)}}},De.prototype.destroy=function(){this._parser=this._assets=this._availableLangs=this._translations=null,this.off()},Object.defineProperty(De.prototype,"locale",{get:function(){return this._locale},set:function(t){if(this._locale!==t){var e=ol(t);if("in"===e){var i=e="id",s=t.indexOf("-");if(t=-1!==s?i+t.substring(s):i,this._locale===t)return}i=this._locale,this._locale=t,this._lang=e,this._pluralFn=rl[this._lang]||cl,this.fire("set:locale",t,i)}}}),Object.defineProperty(De.prototype,"assets",{get:function(){return this._assets},set:function(t){var e,i={},s=0;for(e=t.length;s<e;s++){var n=t[s]instanceof Fe?t[s].id:t[s];i[n]=!0}for(s=this._assets.length;s--;)i[n=this._assets[s]]||(this._app.assets.off("add:"+n,this._onAssetAdd,this),(t=this._app.assets.get(n))&&this._onAssetRemove(t),this._assets.splice(s,1));for(n in i)n=parseInt(n,10),-1===this._assets.indexOf(n)&&(this._assets.push(n),(t=this._app.assets.get(n))?this._onAssetAdd(t):this._app.assets.once("add:"+n,this._onAssetAdd,this))}}),De.prototype._findFallbackLocale=function(t,e){return(t=ll[t])&&this._translations[t]||(t=ll[e])&&this._translations[t]?t:(t=this._availableLangs[e])&&this._translations[t]?t:hl},De.prototype._onAssetAdd=function(t){t.on("load",this._onAssetLoad,this),t.on("change",this._onAssetChange,this),t.on("remove",this._onAssetRemove,this),t.on("unload",this._onAssetUnload,this),t.resource&&this._onAssetLoad(t)},De.prototype._onAssetLoad=function(t){this.addData(t.resource)},De.prototype._onAssetChange=function(t){t.resource&&this.addData(t.resource)},De.prototype._onAssetRemove=function(t){t.off("load",this._onAssetLoad,this),t.off("change",this._onAssetChange,this),t.off("remove",this._onAssetRemove,this),t.off("unload",this._onAssetUnload,this),t.resource&&this.removeData(t.resource),this._app.assets.once("add:"+t.id,this._onAssetAdd,this)},De.prototype._onAssetUnload=function(t){t.resource&&this.removeData(t.resource)};var dl=/^\s*(?:(?:[a-z]+[a-z0-9\-\+\.]*:)?\/\/|data:|blob:)/i,ul=[],pl=function(t){var e="_"+t;ul.push(e),Object.defineProperty(Le.prototype,t,{get:function(){return this[e]||null},set:function(t){(!!this[e]!=!!t||this[e]&&t&&this[e].hash!==t.hash)&&(this[e]=t?{url:t.url,filename:t.filename,size:t.size,hash:t.hash,opt:t.opt||0}:null,this.asset.file&&(this.asset.fire("change",this.asset,"file",this.asset._file,this.asset._file),this.asset.reload()))}})};pl("dxt"),pl("pvr"),pl("etc1"),pl("etc2"),pl("basis"),Le.prototype.clear=function(){for(var t=0;t<ul.length;t++)this[ul[t]]=null};var fl=-1,ml={pvr:"extCompressedTexturePVRTC",dxt:"extCompressedTextureS3TC",etc2:"extCompressedTextureETC",etc1:"extCompressedTextureETC1",basis:"canvas"},_l=["pvr","dxt","etc2","etc1","basis"];Fe.prototype=Object.create(n.prototype),Fe.prototype.constructor=Fe,Object.assign(Fe.prototype,{getFileUrl:function(){var t=this.getPreferredFile();if(!t||!t.url)return null;var e=t.url;if(this.registry&&this.registry.prefix&&!dl.test(e)&&(e=this.registry.prefix+e),"script"!==this.type&&t.hash){var i=-1!==e.indexOf("?")?"&":"?";e+=i+"t="+t.hash}return e},getPreferredFile:function(){if(!this.file)return null;if("texture"===this.type||"textureatlas"===this.type||"bundle"===this.type)for(var t=this.registry._loader._app,e=t.graphicsDevice,i=0,s=_l.length;i<s;i++){var n=_l[i];if(e[ml[n]]){if(this.file.variants[n])return this.file.variants[n];if(t.enableBundles){var r=t.bundles.listBundlesForAsset(this);if(r)for(var a=0,o=r.length;a<o;a++)if(r[a].file&&r[a].file.variants&&r[a].file.variants[n])return this.file}}}return this.file},getAbsoluteUrl:function(t){var e=ia.getDirectory(this.file.url);return ia.join(e,t)},getLocalizedAssetId:function(t){return t=De.findAvailableLocale(t,this._i18n),this._i18n[t]||null},addLocalizedAssetId:function(t,e){this._i18n[t]=e,this.fire("add:localized",t,e)},removeLocalizedAssetId:function(t){var e=this._i18n[t];e&&(delete this._i18n[t],this.fire("remove:localized",t,e))},ready:function(t,e){e=e||this,this.resource?t.call(e,this):this.once("load",function(i){t.call(e,i)})},reload:function(){this.loaded&&(this.loaded=!1,this.registry.load(this))},unload:function(){if(this.loaded||0!==this._resources.length){this.fire("unload",this),this.registry.fire("unload:"+this.id,this);var t=this._resources;this.resources=[],this.loaded=!1,this.file&&this.registry._loader.clearCache(this.getFileUrl(),this.type);for(var e=0;e<t.length;++e){var i=t[e];i&&i.destroy&&i.destroy()}}}}),Object.defineProperty(Fe.prototype,"id",{get:function(){return this._id},set:function(t){this._id=t}}),Object.defineProperty(Fe.prototype,"file",{get:function(){return this._file},set:function(t){var e;if(!!t!=!!this._file||t&&this._file&&t.hash!==this._file)if(t){if(this._file||(this._file={}),this._file.url=t.url,this._file.filename=t.filename,this._file.hash=t.hash,this._file.size=t.size,this._file.variants=this.variants,this._file.contents=t.contents,t.hasOwnProperty("variants")&&(this.variants.clear(),t.variants))for(e in t.variants)t.variants[e]&&(this.variants[e]=t.variants[e]);this.fire("change",this,"file",this._file,this._file),this.reload()}else this._file=null,this.variants.clear();else if(t&&this._file&&t.hasOwnProperty("variants")&&(this.variants.clear(),t.variants))for(e in t.variants)t.variants[e]&&(this.variants[e]=t.variants[e])}}),Object.defineProperty(Fe.prototype,"data",{get:function(){return this._data},set:function(t){var e=this._data;this._data=t,t!==e&&(this.fire("change",this,"data",t,e),this.loaded&&this.registry._loader.patch(this,this.registry))}}),Object.defineProperty(Fe.prototype,"resource",{get:function(){return this._resources[0]},set:function(t){var e=this._resources[0];this._resources[0]=t,this.fire("change",this,"resource",t,e)}}),Object.defineProperty(Fe.prototype,"resources",{get:function(){return this._resources},set:function(t){var e=this._resources;this._resources=t,this.fire("change",this,"resources",t,e)}}),Object.defineProperty(Fe.prototype,"preload",{get:function(){return this._preload},set:function(t){t=!!t,this._preload!==t&&(this._preload=t)&&!this.loaded&&!this.loading&&this.registry&&this.registry.load(this)}}),Object.defineProperty(Fe.prototype,"loadFaces",{get:function(){return this._loadFaces},set:function(t){t=!!t,this.hasOwnProperty("_loadFaces")&&t===this._loadFaces||(this._loadFaces=t,this.loaded&&this.registry._loader.patch(this,this.registry))}});var gl=function(t){switch(t){case"SCALAR":return 1;case"VEC2":return 2;case"VEC3":return 3;case"VEC4":case"MAT2":return 4;case"MAT3":return 9;case"MAT4":return 16;default:return 3}},yl=function(t){switch(t){case 5120:return 0;case 5121:return 1;case 5122:return 2;case 5123:return 3;case 5124:return 4;case 5125:return 5;case 5126:return 6;default:return 0}},vl=function(t){switch(t){case 5120:case 5121:return 1;case 5122:case 5123:return 2;case 5124:case 5125:case 5126:return 4;default:return 0}},bl={POSITION:"POSITION",NORMAL:"NORMAL",TANGENT:"TANGENT",COLOR_0:"COLOR",JOINTS_0:"BLENDINDICES",WEIGHTS_0:"BLENDWEIGHT",TEXCOORD_0:"TEXCOORD0",TEXCOORD_1:"TEXCOORD1"},xl=function(t,e){var i=gl(t.type),s=function(t){switch(t){case 5120:return Int8Array;case 5121:return Uint8Array;case 5122:return Int16Array;case 5123:return Uint16Array;case 5124:return Int32Array;case 5125:return Uint32Array;case 5126:return Float32Array;default:return null}}(t.componentType);if(!s)return null;if(t.sparse){var n=t.sparse,r=xl(Object.assign({count:n.count,type:"SCALAR"},n.indices),e),a=xl(Object.assign({count:n.count,type:t.scalar,componentType:t.componentType},n.values),e);for(t=t.hasOwnProperty("bufferView")?xl({bufferView:t.bufferView,byteOffset:t.byteOffset,componentType:t.componentType,count:t.count,type:t.type},e).slice():new s(t.count*i),s=0;s<n.count;++s){e=r[s];for(var o=0;o<i;++o)t[e*i+o]=a[s*i+o]}}else t=new s((n=e[t.bufferView]).buffer,n.byteOffset+(t.hasOwnProperty("byteOffset")?t.byteOffset:0),t.count*i);return t},Sl=function(t,e){var i=t.POSITION;if(i&&3===i.components){if(i.size!==i.stride)for(var s=i.stride/Pa[i.type],n=new Ma[i.type](i.buffer,i.offset,i.count*s),r=new Ma[i.type](3*i.count),a=0;a<i.count;++a)r[3*a]=n[a*s],r[3*a+1]=n[a*s+1],r[3*a+2]=n[a*s+2];else r=new Ma[i.type](i.buffer,i.offset,3*i.count);if(i=i.count,!e)for(e=new Uint16Array(i),s=0;s<i;s++)e[s]=s;r=Jt(r,e),(e=new Float32Array(r.length)).set(r),t.NORMAL={buffer:e.buffer,size:12,offset:0,stride:12,count:i,components:3,type:6}}},Tl=function(t,e,i){var s=e.POSITION,n=s.count,r=[];for(d in e)e.hasOwnProperty(d)&&r.push({semantic:d,components:e[d].components,type:e[d].type,normalize:!!e[d].normalize});var a="POSITION NORMAL TANGENT COLOR BLENDINDICES BLENDWEIGHT TEXCOORD0 TEXCOORD1".split(" ");r.sort(function(t,e){return(t=a.indexOf(t.semantic))<(e=a.indexOf(e.semantic))?-1:e<t?1:0});var o,h=new O(t,r),l=!0;for(r=0;r<h.elements.length;++r){var c=h.elements[r],d=e[c.name],u=d.offset-s.offset;if(d.buffer!==s.buffer||d.stride!==c.stride||d.size!==c.size||u!==c.offset){l=!1;break}}if(r=(t=new C(t,h,n,0)).lock(),u=new Uint32Array(r),l)s=new Uint32Array(s.buffer,s.offset,n*t.format.size/4),u.set(s);else for(r=0;r<t.format.elements.length;++r){l=(c=t.format.elements[r]).stride/4,d=e[c.name],s=new Uint32Array(d.buffer,d.offset,d.count*d.stride/4),h=d.stride/4;var p=0;c=c.offset/4;var f=Math.floor((d.size+3)/4);for(d=0;d<n;++d){for(o=0;o<f;++o)u[c+o]=s[p+o];p+=h,c+=l}}return i||function(t){var e,i,s=[],n=[],r=[];for(e=0;e<t.format.elements.length;++e){var a=t.format.elements[e];if("TEXCOORD0"===a.name||"TEXCOORD1"===a.name)switch(a.dataType){case 6:s.push({offset:a.offset/4+1,stride:a.stride/4});break;case 3:n.push({offset:a.offset/2+1,stride:a.stride/2});break;case 1:r.push({offset:a.offset+1,stride:a.stride})}}a=function(s,n,r){for(n=new n(t.storage),e=0;e<s.length;++e){var a=s[e].offset,o=s[e].stride;for(i=0;i<t.numVertices;++i)n[a]=r-n[a],a+=o}},0<s.length&&a(s,Float32Array,1),0<n.length&&a(n,Uint16Array,65535),0<r.length&&a(r,Uint8Array,255)}(t),t.unlock(),t},wl=new x,Ml=new v,Pl=function(t,e,i,s,n,r){var a=[];return e.primitives.forEach(function(o){var h=null,l=new ht(t),c=!0;if(o.hasOwnProperty("extensions")){var d=o.extensions;if(d.hasOwnProperty("KHR_draco_mesh_compression")){var u=window.DracoDecoderModule;if(u&&(d=d.KHR_draco_mesh_compression).hasOwnProperty("attributes")){var p=s[d.bufferView];(c=new u.DecoderBuffer).Init(p,p.length);var f=(p=new u.Decoder).GetEncodedGeometryType(c);switch(f){case u.POINT_CLOUD:var m=0,_=new u.PointCloud,g=p.DecodeBufferToPointCloud(c,_);break;case u.TRIANGULAR_MESH:m=4,_=new u.Mesh,g=p.DecodeBufferToMesh(c,_)}if(!g||!g.ok()||0==_.ptr)return void n("Failed to decode draco compressed asset: "+(g?g.error_msg():"Mesh asset - invalid draco compressed geometry type: "+f));if(g=_.num_faces(),f==u.TRIANGULAR_MESH){var y=(f=3*g)*((h=65535<_.num_points())?4:2);g=u._malloc(y),h?(p.GetTrianglesUInt32Array(_,y,g),h=new Uint32Array(u.HEAPU32.buffer,g,f).slice()):(p.GetTrianglesUInt16Array(_,y,g),h=new Uint16Array(u.HEAPU16.buffer,g,f).slice()),u._free(g)}f=function(t,e,i,s,n,r,a){var o,h=e.num_points(),l={};for(var c in i=i.attributes)if(i.hasOwnProperty(c)&&bl.hasOwnProperty(c)){var d=bl[c],u=s.GetAttributeByUniqueId(e,i[c]),p=h*u.num_components();switch(u.data_type()){case n.DT_UINT8:var f=o=1,m=n._malloc(p*f);s.GetAttributeDataArrayForAllPoints(e,u,n.DT_UINT8,p*f,m),p=new Uint8Array(n.HEAPU8.buffer,m,p).slice();break;case n.DT_UINT16:o=3,f=2,m=n._malloc(p*f),s.GetAttributeDataArrayForAllPoints(e,u,n.DT_UINT16,p*f,m),p=new Uint16Array(n.HEAPU16.buffer,m,p).slice();break;default:o=6,f=4,m=n._malloc(p*f),s.GetAttributeDataArrayForAllPoints(e,u,n.DT_FLOAT32,p*f,m),p=new Float32Array(n.HEAPF32.buffer,m,p).slice()}n._free(m),m=p,p=u.num_components(),u=u.normalized(),f*=p,l[d]={values:m,buffer:m.buffer,size:f,offset:0,stride:f,count:h,components:p,type:o,normalize:u}}return l.hasOwnProperty("NORMAL")||Sl(l,r),Tl(t,l,a)}(t,_,d,p,u,h,r),u.destroy(_),u.destroy(p),u.destroy(c),c=!1}}}f||(h=o.hasOwnProperty("indices")?xl(i[o.indices],s):null,f=function(t,e,i,s,n,r){var a,o={};for(a in e)if(e.hasOwnProperty(a)&&bl.hasOwnProperty(a)){var h=s[e[a]],l=xl(h,n),c=n[h.bufferView],d=bl[a],u=gl(h.type)*vl(h.componentType);c=c.hasOwnProperty("byteStride")?c.byteStride:u,o[d]={buffer:l.buffer,size:u,offset:l.byteOffset,stride:c,count:h.count,components:gl(h.type),type:yl(h.componentType),normalize:h.normalized}}return o.hasOwnProperty("NORMAL")||Sl(o,i),Tl(t,o,r)}(t,o.attributes,h,i,s,r),m=function(t){if(!t.hasOwnProperty("mode"))return 4;switch(t.mode){case 0:return 0;case 1:return 1;case 2:return 2;case 3:return 3;case 4:return 4;case 5:return 5;case 6:return 6;default:return 4}}(o)),l.vertexBuffer=f,l.primitive[0].type=m,l.primitive[0].base=0,l.primitive[0].indexed=null!==h,null!==h?(2!==(m=h instanceof Uint8Array?0:h instanceof Uint16Array?1:2)||t.extUintElement||(m=1,h=new Uint16Array(h)),m=new rt(t,m,h.length,0,h),l.indexBuffer[0]=m,l.primitive[0].count=h.length):l.primitive[0].count=f.numVertices,l.materialIndex=o.material;var b=i[o.attributes.POSITION];if(m=b.min,m=new T(new v(((u=b.max)[0]+m[0])/2,(u[1]+m[1])/2,(u[2]+m[2])/2),new v((u[0]-m[0])/2,(u[1]-m[1])/2,(u[2]-m[2])/2)),l.aabb=m,c&&o.hasOwnProperty("targets")){var x=[];if(o.targets.forEach(function(n,r){var a={};n.hasOwnProperty("POSITION")&&(b=i[n.POSITION],a.deltaPositions=xl(b,s),a.deltaPositionsType=yl(b.componentType),b.hasOwnProperty("min")&&b.hasOwnProperty("max")&&(a.aabb=new T,a.aabb.setMinMax(new v(b.min),new v(b.max)))),n.hasOwnProperty("NORMAL")&&(b=i[n.NORMAL],a.deltaNormals=xl(b,s),a.deltaNormalsType=yl(b.componentType)),e.hasOwnProperty("extras")&&e.extras.hasOwnProperty("targetNames")?a.name=e.extras.targetNames[r]:a.name=x.length.toString(10),x.push(new ye(t,a))}),l.morph=new ut(x),e.hasOwnProperty("weights"))for(o=0;o<e.weights.length;++o)x[o].defaultWeight=e.weights[o]}a.push(l)}),a},Al=function(t,e,i){var s=[1,1],n=[0,0],r=function(t,e,r){var a,o=t.texCoord;if(o)for(a=0;a<r.length;++a)e[r[a]+"MapUv"]=o;o=s;var h=n;for((t=t.extensions)&&(t=t.KHR_texture_transform)&&(t.scale&&(o=t.scale),t.offset&&(h=t.offset)),a=0;a<r.length;++a)e[r[a]+"MapTiling"]=new y(o[0],o[1]),e[r[a]+"MapOffset"]=new y(h[0],i?h[1]:1-o[1]-h[1])},a=new ar;if(a.occludeSpecular=!0,a.diffuseTint=!0,a.diffuseVertexColor=!0,a.specularTint=!0,a.specularVertexColor=!0,t.hasOwnProperty("name")&&(a.name=t.name),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_pbrSpecularGlossiness")){var o=t.extensions.KHR_materials_pbrSpecularGlossiness;if(o.hasOwnProperty("diffuseFactor")){var h=o.diffuseFactor;a.diffuse.set(Math.pow(h[0],1/2.2),Math.pow(h[1],1/2.2),Math.pow(h[2],1/2.2)),a.opacity=null!=h[3]?h[3]:1}else a.diffuse.set(1,1,1),a.opacity=1;if(o.hasOwnProperty("diffuseTexture")){var l=o.diffuseTexture;h=e[l.index],a.diffuseMap=h,a.diffuseMapChannel="rgb",a.opacityMap=h,a.opacityMapChannel="a",r(l,a,["diffuse","opacity"])}a.useMetalness=!1,o.hasOwnProperty("specularFactor")?(h=o.specularFactor,a.specular.set(Math.pow(h[0],1/2.2),Math.pow(h[1],1/2.2),Math.pow(h[2],1/2.2))):a.specular.set(1,1,1),o.hasOwnProperty("glossinessFactor")?a.shininess=100*o.glossinessFactor:a.shininess=100,o.hasOwnProperty("specularGlossinessTexture")&&(h=o.specularGlossinessTexture,a.specularMap=a.glossMap=e[h.index],a.specularMapChannel="rgb",a.glossMapChannel="a",r(h,a,["gloss","metalness"])),a.chunks.specularPS="#ifdef MAPCOLOR\nuniform vec3 material_specular;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_specularMap;\n#endif\n\nvoid getSpecularity() {\n\tdSpecularity = vec3(1.0);\n\n\t#ifdef MAPCOLOR\n\t\tdSpecularity *= material_specular;\n\t#endif\n\n\t#ifdef MAPTEXTURE\n\t\tvec3 srgb = texture2D(texture_specularMap, $UV).$CH;\n\t\tdSpecularity *= vec3(pow(srgb.r, 2.2), pow(srgb.g, 2.2), pow(srgb.b, 2.2));\n\t#endif\n\n\t#ifdef MAPVERTEX\n\t\tdSpecularity *= saturate(vVertexColor.$VC);\n\t#endif\n}"}else t.hasOwnProperty("pbrMetallicRoughness")&&((o=t.pbrMetallicRoughness).hasOwnProperty("baseColorFactor")?(h=o.baseColorFactor,a.diffuse.set(Math.pow(h[0],1/2.2),Math.pow(h[1],1/2.2),Math.pow(h[2],1/2.2)),a.opacity=h[3]):(a.diffuse.set(1,1,1),a.opacity=1),o.hasOwnProperty("baseColorTexture")&&(h=e[(l=o.baseColorTexture).index],a.diffuseMap=h,a.diffuseMapChannel="rgb",a.opacityMap=h,a.opacityMapChannel="a",r(l,a,["diffuse","opacity"])),a.useMetalness=!0,o.hasOwnProperty("metallicFactor")?a.metalness=o.metallicFactor:a.metalness=1,o.hasOwnProperty("roughnessFactor")?a.shininess=100*o.roughnessFactor:a.shininess=100,o.hasOwnProperty("metallicRoughnessTexture")&&(h=o.metallicRoughnessTexture,a.metalnessMap=a.glossMap=e[h.index],a.metalnessMapChannel="b",a.glossMapChannel="g",r(h,a,["gloss","metalness"])),a.chunks.glossPS="#ifdef MAPFLOAT\nuniform float material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_glossMap;\n#endif\n\nvoid getGlossiness() {\n\tdGlossiness = 1.0;\n\n#ifdef MAPFLOAT\n\tdGlossiness *= material_shininess;\n#endif\n\n#ifdef MAPTEXTURE\n\tdGlossiness *= texture2D(texture_glossMap, $UV).$CH;\n#endif\n\n#ifdef MAPVERTEX\n\tdGlossiness *= saturate(vVertexColor.$VC);\n#endif\n\n\tdGlossiness = 1.0 - dGlossiness;\n\n\tdGlossiness += 0.0000001;\n}");if(t.hasOwnProperty("normalTexture")&&(h=t.normalTexture,a.normalMap=e[h.index],r(h,a,["normal"]),h.hasOwnProperty("scale")&&(a.bumpiness=h.scale)),t.hasOwnProperty("occlusionTexture")&&(h=t.occlusionTexture,a.aoMap=e[h.index],a.aoMapChannel="r",r(h,a,["ao"])),t.hasOwnProperty("emissiveFactor")?(h=t.emissiveFactor,a.emissive.set(Math.pow(h[0],1/2.2),Math.pow(h[1],1/2.2),Math.pow(h[2],1/2.2)),a.emissiveTint=!0):(a.emissive.set(0,0,0),a.emissiveTint=!1),t.hasOwnProperty("emissiveTexture")&&(h=t.emissiveTexture,a.emissiveMap=e[h.index],r(h,a,["emissive"])),t.hasOwnProperty("alphaMode"))switch(t.alphaMode){case"MASK":a.blendType=3,t.hasOwnProperty("alphaCutoff")?a.alphaTest=t.alphaCutoff:a.alphaTest=.5;break;case"BLEND":a.blendType=2;break;default:case"OPAQUE":a.blendType=3}else a.blendType=3;return t.hasOwnProperty("doubleSided")?(a.twoSidedLighting=t.doubleSided,a.cull=t.doubleSided?0:1):(a.twoSidedLighting=!1,a.cull=1),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_clearcoat")&&((h=t.extensions.KHR_materials_clearcoat).hasOwnProperty("clearcoatFactor")?a.clearCoat=.25*h.clearcoatFactor:a.clearCoat=0,h.hasOwnProperty("clearcoatTexture")&&(o=h.clearcoatTexture,a.clearCoatMap=e[o.index],a.clearCoatMapChannel="r",r(o,a,["clearCoat"])),h.hasOwnProperty("clearcoatRoughnessFactor")?a.clearCoatGlossiness=h.clearcoatRoughnessFactor:a.clearCoatGlossiness=0,h.hasOwnProperty("clearcoatRoughnessTexture")&&(o=h.clearcoatRoughnessTexture,a.clearCoatGlossMap=e[o.index],a.clearCoatGlossMapChannel="g",r(o,a,["clearCoatGloss"])),h.hasOwnProperty("clearcoatNormalTexture")&&(h=h.clearcoatNormalTexture,a.clearCoatNormalMap=e[h.index],r(h,a,["clearCoatNormal"]),h.hasOwnProperty("scale")&&(a.clearCoatBumpiness=h.scale)),a.chunks.clearCoatGlossPS="#ifdef MAPFLOAT\nuniform float material_clearCoatGlossiness;\n#endif\n\n#ifdef MAPTEXTURE\nuniform sampler2D texture_clearCoatGlossMap;\n#endif\n\nvoid getClearCoatGlossiness() {\n\tccGlossiness = 1.0;\n\n#ifdef MAPFLOAT\n\tccGlossiness *= material_clearCoatGlossiness;\n#endif\n\n#ifdef MAPTEXTURE\n\tccGlossiness *= texture2D(texture_clearCoatGlossMap, $UV).$CH;\n#endif\n\n#ifdef MAPVERTEX\n\tccGlossiness *= saturate(vVertexColor.$VC);\n#endif\n\n\tccGlossiness = 1.0 - ccGlossiness;\n\n\tccGlossiness += 0.0000001;\n}"),t.hasOwnProperty("extensions")&&t.extensions.hasOwnProperty("KHR_materials_unlit")&&(a.useLighting=!1,a.emissive.copy(a.diffuse),a.emissiveTint=a.diffuseTint,a.emissiveMap=a.diffuseMap,a.emissiveMapUv=a.diffuseMapUv,a.emissiveMapTiling.copy(a.diffuseMapTiling),a.emissiveMapOffset.copy(a.diffuseMapOffset),a.emissiveMapChannel=a.diffuseMapChannel,a.emissiveVertexColor=a.diffuseVertexColor,a.emissiveVertexColorChannel=a.diffuseVertexColorChannel,a.diffuse.set(0,0,0),a.diffuseTint=!1,a.diffuseMap=null,a.diffuseVertexColor=!1),a.update(),a},El=function(t,e){var i=new Mt;return t.hasOwnProperty("name")&&0<t.name.length?i.name=t.name:i.name="node_"+e,t.hasOwnProperty("matrix")&&(wl.data.set(t.matrix),wl.getTranslation(Ml),i.setLocalPosition(Ml),wl.getEulerAngles(Ml),i.setLocalEulerAngles(Ml),wl.getScale(Ml),i.setLocalScale(Ml)),t.hasOwnProperty("rotation")&&(e=t.rotation,i.setLocalRotation(e[0],e[1],e[2],e[3])),t.hasOwnProperty("translation")&&(e=t.translation,i.setLocalPosition(e[0],e[1],e[2])),t.hasOwnProperty("scale")&&(t=t.scale,i.setLocalScale(t[0],t[1],t[2])),i},Cl=function(t,e,i,s){if(!t.hasOwnProperty("animations")||0===t.animations.length)return[];var n=s&&s.animation&&s.animation.preprocess,r=s&&s.animation&&s.animation.postprocess;return t.animations.map(function(s,a){return n&&n(s),a=function(t,e,i,s,n){var r,a=function(t){var e=xl(t,s);return new Se(gl(t.type),new e.constructor(e))},o={STEP:0,LINEAR:1,CUBICSPLINE:2},h={},l=[],c={},d=[],u=[];for(r=0;r<t.samplers.length;++r){var p=t.samplers[r];h.hasOwnProperty(p.input)||(h[p.input]=l.length,l.push(a(i[p.input]))),c.hasOwnProperty(p.output)||(c[p.output]=d.length,d.push(a(i[p.output])));var f=p.hasOwnProperty("interpolation")&&o.hasOwnProperty(p.interpolation)?o[p.interpolation]:1;u.push(new we([],h[p.input],c[p.output],f))}for(i=[],a=new be,o={translation:"localPosition",rotation:"localRotation",scale:"localScale",weights:"weights"},r=0;r<t.channels.length;++r)h=(c=t.channels[r]).target,(c=u[c.sampler])._paths.push(a.encode([[n[h.node].name],"graph",[o[h.path]]])),h.path.startsWith("rotation")&&2!==c.interpolation?i.push(c.output):h.path.startsWith("weights")&&(d[c.output]._components=d[c.output].data.length/l[c.input].data.length);for(i.sort(),a=null,r=0;r<i.length;++r)if(n=i[r],0===r||n!==a){if(4===(a=d[n]).components)for(o=(a=a.data).length-4,h=0;h<o;h+=4)0>a[h+0]*a[h+4]+a[h+1]*a[h+5]+a[h+2]*a[h+6]+a[h+3]*a[h+7]&&(a[h+4]*=-1,a[h+5]*=-1,a[h+6]*=-1,a[h+7]*=-1);a=n}for(r=n=0;r<l.length;r++)a=l[r]._data,n=Math.max(n,0===a.length?0:a[a.length-1]);return new Me(t.hasOwnProperty("name")?t.name:"animation_"+e,n,l,d,u)}(s,a,t.accessors,i,e),r&&r(s,a),a})},Il=function(t,e,i,s,n,r){var a=n&&n.global&&n.global.preprocess,o=n&&n.global&&n.global.postprocess;a&&a(e);var h=e.asset&&"PlayCanvas"===e.asset.generator;a=function(t,e){if(!t.hasOwnProperty("nodes")||0===t.nodes.length)return[];var i=e&&e.node&&e.node.preprocess,s=e&&e.node&&e.node.process||El,n=e&&e.node&&e.node.postprocess;e=t.nodes.map(function(t,e){return i&&i(t),e=s(t,e),n&&n(t,e),e});for(var r=0;r<t.nodes.length;++r){var a=t.nodes[r];if(a.hasOwnProperty("children"))for(var o=0;o<a.children.length;++o){var h=e[r],l=e[a.children[o]];l.parent||h.addChild(l)}}return e}(e,n);var l=function(t,e){var i=[],s=t.scenes.length;if(1===s&&1===t.scenes[0].nodes.length)i.push(e[t.scenes[0].nodes[0]]);else for(var n=0;n<s;n++){for(var r=t.scenes[n],a=new Mt(r.name),o=0;o<r.nodes.length;o++)a.addChild(e[r.nodes[o]]);i.push(a)}return i}(e,a),c=Cl(e,a,i,n);n=function(t,e,i,s){if(!t.hasOwnProperty("materials")||0===t.materials.length)return[];var n=i&&i.material&&i.material.preprocess,r=i&&i.material&&i.material.process||Al,a=i&&i.material&&i.material.postprocess;return t.materials.map(function(t){n&&n(t);var i=r(t,e,s);return a&&a(t,i),i})}(e,s.map(function(t){return t.resource}),n,h),h=function(t,e,i,s,n){return e.hasOwnProperty("meshes")&&0!==e.meshes.length&&e.hasOwnProperty("accessors")&&0!==e.accessors.length&&e.hasOwnProperty("bufferViews")&&0!==e.bufferViews.length?e.meshes.map(function(r){return Pl(t,r,e.accessors,i,s,n)}):[]}(t,e,i,r,h),t=function(t,e,i,s){return e.hasOwnProperty("skins")&&0!==e.skins.length?e.skins.map(function(n){var r,a=e.accessors,o=n.joints,h=o.length,l=[];if(n.hasOwnProperty("inverseBindMatrices")){var c=xl(a[n.inverseBindMatrices],s),d=[];for(a=0;a<h;a++){for(r=0;16>r;r++)d[r]=c[16*a+r];(r=new x).set(d),l.push(r)}}else for(a=0;a<h;a++)r=new x,l.push(r);for(c=[],a=0;a<h;a++)c[a]=i[o[a]].name;for(n=n.skeleton,(l=new ve(t,l,c)).skeleton=i[n],l.bones=[],a=0;a<o.length;a++)l.bones[a]=i[o[a]];return l}):[]}(t,e,a,i),s={gltf:e,nodes:a,scenes:l,animations:c,textures:s,materials:n,meshes:h,skins:t},o&&o(e,s),r(null,s)},Ol=function(t,e,i,s,n,r,a){var o=r&&r.image&&r.image.preprocess,h=r&&r.image&&r.image.processAsync||function(t,e){e(null,null)},l=r&&r.image&&r.image.postprocess,c=function(i,s,r,o){var h={url:i};s&&(s={"image/png":"png","image/jpeg":"jpg","image/basis":"basis","image/ktx":"ktx","image/vnd-ms.dds":"dds"}[s])&&(h.filename="glb-texture-"+e+"."+s);var c=new Fe("texture_"+e,"texture",h,null,{crossOrigin:r});c.on("load",function(){o&&URL.revokeObjectURL(i),l&&l(t,c),a(null,c)}),c.on("error",function(t,e){a(t)}),n.add(c),n.load(c)};o&&o(t),h(t,function(n,r){n?a(n):r?(l&&l(t,r),a(null,r)):t.hasOwnProperty("uri")?/^data:.*,.*$/i.test(t.uri)?(r=(r=n=t.uri).substring(r.indexOf(":")+1,r.indexOf(";")),c(n,r)):c(ia.join(s,t.uri),null,"anonymous"):t.hasOwnProperty("bufferView")&&t.hasOwnProperty("mimeType")?(n=new Blob([i[t.bufferView]],{type:t.mimeType}),c(URL.createObjectURL(n),t.mimeType,null,!0)):a("Invalid image found in gltf (neither uri or bufferView found). index="+e)})},Rl=function(t,e){(t=JSON.parse(function(t){if("undefined"!=typeof TextDecoder)return(new TextDecoder).decode(t);for(var e="",i=0;i<t.length;i++)e+=String.fromCharCode(t[i]);return decodeURIComponent(escape(e))}(t))).asset&&t.asset.version&&2>parseFloat(t.asset.version)?e("Invalid gltf version. Expected version 2.0 or above but found version '"+t.asset.version+"'."):e(null,t)},Dl=function(t,e,i){if(t&&t.toLowerCase().endsWith(".glb")){var s=(t=new DataView(e)).getUint32(0,!0),n=t.getUint32(4,!0),r=t.getUint32(8,!0);if(1179937895!==s)i("Invalid magic number found in glb header. Expected 0x46546C67, found 0x"+s.toString(16));else if(2!==n)i("Invalid version number found in glb header. Expected 2, found "+n);else if(0>=r||r>e.byteLength)i("Invalid length found in glb header. Found "+r);else{for(s=[],n=12;n<r;){var a=t.getUint32(n,!0);if(n+a+8>e.byteLength)throw Error("Invalid chunk length found in glb. Found "+a);var o=t.getUint32(n+4,!0),h=new Uint8Array(e,n+8,a);s.push({length:a,type:o,data:h}),n+=a+8}1!==s.length&&2!==s.length?i("Invalid number of chunks found in glb file."):1313821514!==s[0].type?i("Invalid chunk type found in glb file. Expected 0x4E4F534A, found 0x"+s[0].type.toString(16)):1<s.length&&5130562!==s[1].type?i("Invalid chunk type found in glb file. Expected 0x004E4942, found 0x"+s[1].type.toString(16)):i(null,{gltfChunk:s[0].data,binaryChunk:2===s.length?s[1].data:null})}}else i(null,{gltfChunk:e,binaryChunk:null})},Ll=function(t,e,i,s){var n=[],r=i&&i.bufferView&&i.bufferView.preprocess,a=i&&i.bufferView&&i.bufferView.processAsync||function(t,e,i){i(null,null)},o=i&&i.bufferView&&i.bufferView.postprocess,h=t.bufferViews.length,l=function(e,i){var r=t.bufferViews[e];r.hasOwnProperty("byteStride")&&(i.byteStride=r.byteStride),n[e]=i,o&&o(r,i),0==--h&&s(null,n)};for(i=0;i<t.bufferViews.length;++i){var c=t.bufferViews[i];r&&r(c),a(c,e,function(t,i,n,r){n?s(n):r?l(t,r):(n=e[i.buffer],i=new Uint8Array(n.buffer,n.byteOffset+(i.hasOwnProperty("byteOffset")?i.byteOffset:0),i.byteLength),l(t,i))}.bind(null,i,c))}};Be.parseAsync=function(t,e,i,s,n,r,a){Dl(t,i,function(t,i){t?a(t):Rl(i.gltfChunk,function(t,o){t?a(t):function(t,e,i,s,n){var r=[];if(null===t.buffers||0===t.buffers.length)n(null,r);else{var a=s&&s.buffer&&s.buffer.preprocess,o=s&&s.buffer&&s.buffer.processAsync||function(t,e){e(null,null)},h=s&&s.buffer&&s.buffer.postprocess,l=t.buffers.length,c=function(e,i){r[e]=i,h&&h(t.buffers[e],i),0==--l&&n(null,r)};for(s=0;s<t.buffers.length;++s){var d=t.buffers[s];a&&a(d),o(d,function(t,s,r,a){if(r)n(r);else if(a)c(t,new Uint8Array(a));else if(s.hasOwnProperty("uri"))if(/^data:.*,.*$/i.test(s.uri)){for(s=atob(s.uri.split(",")[1]),r=new Uint8Array(s.length),a=0;a<s.length;a++)r[a]=s.charCodeAt(a);c(t,r)}else la.get(ia.join(i,s.uri),{cache:!0,responseType:"arraybuffer",retry:!1},function(t,e,i){e?n(e):c(t,new Uint8Array(i))}.bind(null,t));else c(t,e)}.bind(null,s,d))}}}(o,i.binaryChunk,e,r,function(t,i){t?a(t):Ll(o,i,r,function(t,i){t?a(t):function(t,e,i,s,n,r){if(t.hasOwnProperty("images")&&0!==t.images.length&&t.hasOwnProperty("textures")&&0!==t.textures.length)for(var a=n&&n.texture&&n.texture.preprocess,o=n&&n.texture&&n.texture.processAsync||function(t,e,i){i(null,null)},h=n&&n.texture&&n.texture.postprocess,l=[],c=[],d=t.textures.length,u=function(e,i){if(c[i]||(c[i]=[]),c[i].push(e),0==--d){var s=[];c.forEach(function(e,i){e.forEach(function(e,n){if(0===n)var r=l[i];else{r=l[i];var a=new pc.Asset(r.name+"_clone",r.type,r.file,r.data,r.options);a.loaded=!0;for(var o=r.resource,c=new pc.Texture(o.device,o),d=[],u=0;u<o._levels.length;++u){var p=[];if(o.cubemap)for(var f=0;6>f;++f)p.push(o._levels[u][f]);else p=o._levels[u];d.push(p)}c._levels=d,a.resource=c,r.registry.add(a),r=a}!function(t,e){var i=function(t){switch(t){case 9728:return 0;case 9729:return 1;case 9984:return 2;case 9985:return 4;case 9986:return 3;case 9987:return 5;default:return 1}},s=function(t){switch(t){case 33071:return 1;case 33648:return 2;case 10497:default:return 0}};t&&(e=e||{magFilter:9729,minFilter:9987,wrapS:10497,wrapT:10497},t.minFilter=i(e.minFilter),t.magFilter=i(e.magFilter),t.addressU=s(e.wrapS),t.addressV=s(e.wrapT))}(r.resource,(t.samplers||[])[t.textures[e].sampler]),s[e]=r,h&&h(t.textures[n],r)})}),r(null,s)}},p=0;p<t.textures.length;++p){var f=t.textures[p];a&&a(f),o(f,t.images,function(a,o,h,c){h?r(h):(null==c&&(c=o.source),l[c]?u(a,c):Ol(t.images[c],a,e,i,s,n,function(t,e){t?r(t):(l[c]=e,u(a,c))}))}.bind(null,p,f))}else r(null,[])}(o,i,e,n,r,function(t,e){t?a(t):Il(s,o,i,e,r,a)})})})})})},Be.parse=function(t,e,i,s){var n=null;return s=s||{},Dl(t,e,function(t,e){t?console.error(t):Rl(e.gltfChunk,function(t,r){t?console.error(t):Ll(r,[e.binaryChunk],s,function(t,e){t?console.error(t):Il(i,r,e,[],s,function(t,e){t?console.error(t):n=e})})})}),n},Be.createModel=function(t,e){var i,s=new mt,n=[];for(i=0;i<t.skins.length;i++){var r=new ft(t.skins[i]);r.bones=t.skins[i].bones,n.push(r)}if(1===t.scenes.length)s.graph=t.scenes[0];else for(s.graph=new Mt("SceneGroup"),i=0;i<t.scenes.length;i++)s.graph.addChild(t.scenes[i]);for(i=0;i<t.nodes.length;i++)if((r=t.nodes[i]).root===s.graph){var a=t.gltf.nodes[i];if(a.hasOwnProperty("mesh"))for(var o=t.meshes[a.mesh],h=0;h<o.length;h++){var l=s,c=o[h],d=t.skins,u=n,p=a,f=new lt(r,c,void 0===c.materialIndex?e:t.materials[c.materialIndex]);if(c.morph){var m=new pt(c.morph);if(c.weights)for(var _=0;_<c.weights.length;_++)m.setWeight(_,c.weights[_]);f.morphInstance=m,l.morphInstances.push(m)}p.hasOwnProperty("skin")&&(p=p.skin,c.skin=d[p],c=u[p],f.skinInstance=c,l.skinInstances.push(c)),l.meshInstances.push(f)}}return s},Object.assign(Ne.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i={retry:this.retryRequests};t.load.startsWith("blob:")&&(".glb"===ia.getExtension(t.original).toLowerCase()?i.responseType=p.ResponseType.ARRAY_BUFFER:i.responseType=p.ResponseType.JSON),la.get(t.load,i,function(i,s){i?e("Error loading animation resource: "+t.original+" ["+i+"]"):e(null,s)})},open:function(t,e){return".glb"===ia.getExtension(t).toLowerCase()?(t=Be.parse("filename.glb",e,null))?t.animations:null:this["_parseAnimationV"+e.animation.version](e)},_parseAnimationV3:function(t){t=t.animation;var e=new ge;e.setName(t.name),e.duration=t.duration;for(var i=0;i<t.nodes.length;i++){var s=new _e,n=t.nodes[i];s._name=n.name;for(var r=0;r<n.keys.length;r++){var a=n.keys[r],o=a.time,h=a.pos,l=a.rot;a=a.scale,o=new me(o,h=new v(h[0],h[1],h[2]),l=(new S).setFromEulerAngles(l[0],l[1],l[2]),a=new v(a[0],a[1],a[2])),s._keys.push(o)}e.addNode(s)}return e},_parseAnimationV4:function(t){t=t.animation;var e=new ge;e.setName(t.name),e.duration=t.duration;for(var i=0;i<t.nodes.length;i++){var s=new _e,n=t.nodes[i];s._name=n.name;for(var r=n.defaults.p,a=n.defaults.r,o=n.defaults.s,h=0;h<n.keys.length;h++){var l=n.keys[h],c=l.t,d=r||l.p,u=a||l.r;l=o||l.s,c=new me(c,d=new v(d[0],d[1],d[2]),u=(new S).setFromEulerAngles(u[0],u[1],u[2]),l=new v(l[0],l[1],l[2])),s._keys.push(c)}e.addNode(s)}return e}}),Object.assign(ke.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i={retry:this.retryRequests};t.load.startsWith("blob:")&&(i.responseType=p.ResponseType.JSON),la.get(t.load,i,function(i,s){i?e("Error loading animation clip resource: "+t.original+" ["+i+"]"):e(null,s)})},open:function(t,e){return new Me(e.name,e.duration,e.inputs.map(function(t){return new Se(1,t)}),e.outputs.map(function(t){return new Se(t.components,t.data)}),e=e.curves.map(function(t){return new we([t.path],t.inputIndex,t.outputIndex,t.interpolation)}))}}),Object.defineProperties(ze.prototype,{parameters:{get:function(){return Object.assign({},this._parameters)}},layers:{get:function(){return this._layers}}}),Object.assign(Ue.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i={retry:this.retryRequests};t.load.startsWith("blob:")&&(i.responseType=p.ResponseType.JSON),la.get(t.load,i,function(i,s){i?e("Error loading animation state graph resource: "+t.original+" ["+i+"]"):e(null,s)})},open:function(t,e){return new ze(e)}}),Object.defineProperty(Ve.prototype,"duration",{get:function(){var t=0;return this.buffer?t=this.buffer.duration:this.audio&&(t=this.audio.duration),t||0}});var Fl=function(){if("undefined"==typeof window)return!1;var t=window.navigator.userAgent,e=t.indexOf("MSIE ");return 0<e?parseInt(t.substring(e+5,t.indexOf(".",e)),10):0<t.indexOf("Trident/")&&(e=t.indexOf("rv:"),parseInt(t.substring(e+3,t.indexOf(".",e)),10))}();Object.assign(je.prototype,{_isSupported:function(t){return!!{".ogg":"audio/ogg",".mp3":"audio/mpeg",".wav":"audio/x-wav",".mp4a":"audio/mp4",".m4a":"audio/mp4",".mp4":"audio/mp4",".aac":"audio/aac"}[ia.getExtension(t)]},load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i=function(i){var s="Error loading audio url: "+t.original;i&&(s+=": "+(i.message||i)),console.warn(s),e(s)};this._createSound?this._isSupported(t.original)?this._createSound(t.load,function(t){e(null,new Ve(t))},i):i("Audio format for "+t.original+" not supported"):i(null)},open:function(t,e){return e}}),ue()?je.prototype._createSound=function(t,e,i){var s=this.manager;if(s.context){var n={retry:this.retryRequests};t.startsWith("blob:")&&(n.responseType=p.ResponseType.ARRAY_BUFFER),la.get(t,n,function(t,n){t?i(t):s.context.decodeAudioData(n,e,i)})}else i("Audio manager has no audio context")}:de()&&(je.prototype._createSound=function(t,e,i){var s=null;try{s=new Audio}catch(t){return void i("No support for Audio element")}Fl&&document.body.appendChild(s);var n=function(){s.removeEventListener("canplaythrough",n),Fl&&document.body.removeChild(s),e(s)};s.onerror=function(){s.onerror=null,Fl&&document.body.removeChild(s),i()},s.addEventListener("canplaythrough",n),s.src=t}),Object.assign(Ge.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t}),la.get(t.load,{responseType:p.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(i,s){i?e("Error loading binary resource: "+t.original+" ["+i+"]"):e(null,s)})},open:function(t,e){return e},patch:function(t,e){}}),He.prototype.hasBlobUrl=function(t){return!!this._blobUrls[t]},He.prototype.getBlobUrl=function(t){return this._blobUrls[t]},He.prototype.destroy=function(){for(var t in this._blobUrls)URL.revokeObjectURL(this._blobUrls[t]);this._blobUrls=null};var Bl,Nl=null;Xe.prototype._onMessage=function(t){var e=t.data.id;if(this._pendingRequests[e]){var i=this._pendingRequests[e];if(delete this._pendingRequests[e],t.data.error)i(t.data.error);else{e=t.data.arrayBuffer;for(var s=0,n=t.data.files.length;s<n;s++){var r=t.data.files[s],a=new Blob([e.slice(r.start,r.start+r.size)]);r.url=URL.createObjectURL(a)}i(null,t.data.files)}}},Xe.prototype.untar=function(t,e){var i=this._requestId++;this._pendingRequests[i]=e,this._worker.postMessage({id:i,prefix:this._filenamePrefix,arrayBuffer:t},[t])},Xe.prototype.hasPendingRequests=function(){for(var t in this._pendingRequests)return!0;return!1},Xe.prototype.destroy=function(){this._worker&&(this._worker.terminate(),this._pendingRequests=this._worker=null)},We(),Object.assign(qe.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i=this;la.get(t.load,{responseType:p.ResponseType.ARRAY_BUFFER,retry:this.retryRequests},function(s,n){if(s)e("Error loading bundle resource "+t.original+": "+s);else try{i._untar(n,e)}catch(i){e("Error loading bundle resource "+t.original+": "+i)}})},_untar:function(t,e){var i=this;sa.workers?(i._worker||(i._worker=new Xe(i._assets.prefix)),i._worker.untar(t,function(t,s){e(t,s),i._worker.hasPendingRequests()||(i._worker.destroy(),i._worker=null)})):(t=new Bl(t).untar(i._assets.prefix),e(null,t))},open:function(t,e){return new He(e)},patch:function(t,e){}}),Object.assign(Ye.prototype,{destroy:function(){var t=this.registry,e=function(e){t.remove(e),e.unload()},i=function(t){t.forEach(function(t){e(t)})};this.animations&&(i(this.animations),this.animations=null),this.textures&&(i(this.textures),this.textures=null),this.materials&&(i(this.materials),this.materials=null),this.model&&(e(this.model),this.model=null),this.assets=this.data=null}}),Object.assign(Ke.prototype,{_getUrlWithoutParams:function(t){return 0<=t.indexOf("?")?t.split("?")[0]:t},load:function(t,e,i){"string"==typeof t&&(t={load:t,original:t});var s={responseType:p.ResponseType.ARRAY_BUFFER,retry:!1},n=this,r=function(s){Be.parseAsync(n._getUrlWithoutParams(t.original),ia.extractPath(t.load),s,n._device,i.registry,i.options,function(t,i){t?e(t):e(null,new Ye(i))})};i&&i.file&&i.file.contents?r(i.file.contents):la.get(t.load,s,function(i,s){e&&(i?e("Error loading model: "+t.original+" ["+i+"]"):r(s))})},open:function(t,e,i){return e},patch:function(t,e){var i=t.resource,s=i&&i.data;if(s){var n,r=function(i,s,n){return(i=new Fe(t.name+"/"+i+"/"+n,i,{url:""})).resource=s,i.loaded=!0,e.add(i),i},a=r("model",Be.createModel(s,this._defaultMaterial),0),o=[];for(n=0;n<s.materials.length;++n)o.push(r("material",s.materials[n],n));var h=[];for(n=0;n<s.animations.length;++n)h.push(r("animation",s.animations[n],n));i.data=null,i.model=a,i.materials=o,i.textures=s.textures,i.animations=h,i.registry=e}}}),Object.assign($e.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t}),la.get(t.load,{retry:this.retryRequests},function(i,s){i?e("Error loading css resource: "+t.original+" ["+i+"]"):e(null,s)})},open:function(t,e){return e},patch:function(t,e){}}),Object.assign(Ze.prototype,{load:function(t,e,i){this.loadAssets(i,e)},open:function(t,e,i){return i?i.resource:null},patch:function(t,e){this.loadAssets(t,function(i,s){i&&(e.fire("error",t),e.fire("error:"+t.id,i,t),t.fire("error",t))})},getAssetIds:function(t){var e=[];if(e[0]=t.file,(t.loadFaces||!t.file)&&t.data&&t.data.textures)for(var i=0;6>i;++i)e[i+1]=t.data.textures[i];else e[1]=e[2]=e[3]=e[4]=e[5]=e[6]=null;return e},compareAssetIds:function(t,e){return t&&e?parseInt(t,10)===t||"string"==typeof t?t===e:t.url===e.url:null!==t==(null!==e)},update:function(t,e,i){var s,n,r=t.data||{},a=t._handlerState.assets,o=t._resources,h=[null,null,null,null,null,null,null],l=function(){return r.hasOwnProperty("type")?r.type:r.hasOwnProperty("rgbm")?r.rgbm?"rgbm":"default":null};if(t.loaded&&i[0]===a[0])h[1]=o[1]||null,h[2]=o[2]||null,h[3]=o[3]||null,h[4]=o[4]||null,h[5]=o[5]||null,h[6]=o[6]||null;else if(i[0]){var c=i[0].resource;for(n=0;6>n;++n){var d=[c._levels[n]];if(0===n&&this._device.useTexCubeLod)for(s=1;s<c._levels.length;++s)d[s]=c._levels[s];d=new nt(this._device,{name:t.name+"_prelitCubemap"+(c.width>>n),cubemap:!0,type:l()||c.type,width:c.width>>n,height:c.height>>n,format:c.format,levels:d,fixCubemapSeams:!0,addressU:1,addressV:1}),h[n+1]=d}}if(c=i.slice(1),t.loaded&&this.cmpArrays(c,a.slice(1)))h[0]=o[0]||null;else if(-1===c.indexOf(null)){for(c=c.map(function(t){return t.resource}),n=[],s=0;s<c[0]._levels.length;++s)n.push(c.map(function(t){return t._levels[s]}));l=new nt(this._device,{name:t.name+"_faces",cubemap:!0,type:l()||c[0].type,width:c[0].width,height:c[0].height,format:c[0].format,levels:n,minFilter:r.hasOwnProperty("minFilter")?r.minFilter:c[0].minFilter,magFilter:r.hasOwnProperty("magFilter")?r.magFilter:c[0].magFilter,anisotropy:r.hasOwnProperty("anisotropy")?r.anisotropy:1,addressU:1,addressV:1,fixCubemapSeams:!!i[0]}),h[0]=l}if(!this.cmpArrays(h,o))for(t.resources=h,t._handlerState.assetIds=e,t._handlerState.assets=i,n=0;n<o.length;++n)null!==o[n]&&-1===h.indexOf(o[n])&&o[n].destroy();for(n=0;n<a.length;++n)null!==a[n]&&-1===i.indexOf(a[n])&&a[n].unload()},cmpArrays:function(t,e){if(t.length!==e.length)return!1;for(var i=0;i<t.length;++i)if(t[i]!==e[i])return!1;return!0},loadAssets:function(t,e){t.hasOwnProperty("_handlerState")||(t._handlerState={assetIds:[null,null,null,null,null,null,null],assets:[null,null,null,null,null,null,null]});for(var i,s=this,n=s.getAssetIds(t),r=[null,null,null,null,null,null,null],a=t._handlerState.assetIds,o=t._handlerState.assets,h=s._registry,l=7,c=function(i,a){r[i]=a,0===--l&&(s.update(t,n,r),e(null,t.resources))},d=function(t,i){var s=i&&i.resource&&i.resource._levels[0];s&&"undefined"!=typeof ImageBitmap&&s instanceof ImageBitmap?createImageBitmap(s,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then(function(e){i.resource._levels[0]=e,c(t,i)}).catch(function(t){e(t)}):c(t,i)},u=function(t,i,s){e(i)},p=function(t,e){e.loaded?d(t,e):(h.once("load:"+e.id,d.bind(s,t)),h.once("error:"+e.id,u.bind(s,t)),e.loading||h.load(e))},f=0;7>f;++f){var m=n[f];m?s.compareAssetIds(m,a[f])?c(f,o[f]):parseInt(m,10)===m?(i=h.get(m))?p(f,i):setTimeout(function(t,i){var s=h.get(i);s?p(t,s):e("failed to find dependent cubemap asset="+i)}.bind(null,f,m)):(i=new Fe(t.name+"_part_"+f,"texture","string"==typeof m?{url:m,filename:m}:m),h.add(i),h.once("load:"+i.id,d.bind(s,f)),h.once("error:"+i.id,u.bind(s,f)),h.load(i)):c(f,null)}}}),Object.assign(Qe.prototype,{load:function(t,e){e(null,null)},open:function(t,e){return e}}),Object.defineProperty(Je.prototype,"data",{get:function(){return this._data},set:function(t){if((this._data=t)&&(void 0!==this._data.intensity&&(this.intensity=this._data.intensity),this._data.info||(this._data.info={}),(!this._data.version||2>this._data.version)&&(this._data.info.maps=[{width:this._data.info.width,height:this._data.info.height}],this._data.chars)))for(var e in this._data.chars)this._data.chars[e].map=0}}),Object.assign(ei.prototype,{load:function(t,e,i){"string"==typeof t&&(t={load:t,original:t});var s=this;".json"===ia.getExtension(t.original)?la.get(t.load,{retry:this.retryRequests},function(i,n){var r=ti(n);i?e("Error loading font resource: "+t.original+" ["+i+"]"):s._loadTextures(t.load.replace(".json",".png"),r,function(t,i){if(t)return e(t);e(null,{data:r,textures:i})})}):(i&&i.data&&(i.data=ti(i.data)),this._loadTextures(t.load,i&&i.data,e))},_loadTextures:function(t,e,i){var s=e.info.maps.length,n=0,r=null,a=Array(s),o=this._loader;e=function(e){var h=function(t,o){if(!r){if(t)return r=t,i(t);o.upload(),a[e]=o,++n===s&&i(null,a)}};0===e?o.load(t,"texture",h):o.load(t.replace(".png",e+".png"),"texture",h)};for(var h=0;h<s;h++)e(h)},open:function(t,e,i){return e.textures?new Je(e.textures,e.data):new Je(e,null)},patch:function(t,e){!(e=t.resource).data&&t.data?e.data=t.data:!t.data&&e.data&&(t.data=e.data),t.data&&(t.data=ti(t.data))}}),ii.prototype=Object.create(n.prototype),ii.prototype.constructor=ii,ii.prototype.destroy=function(){var t=this;this._registry.off("load",this._onLoad),this._registry.off("error",this._onError),this._waitingAssets.forEach(function(e){t._registry.off("add:"+e,this._onAddAsset)}),this.off("progress"),this.off("load")},ii.prototype.load=function(t,e){var i=this._assets.length;for(this._count=0,this._failed=[],this._callback=t,this._scope=e,this._registry.on("load",this._onLoad,this),this._registry.on("error",this._onError,this),t=0;t<i;t++)(e=this._assets[t]).loading||e.loaded||(this._registry.load(e),this._total++)},ii.prototype.ready=function(t,e){e=e||this,this._loaded?t.call(e,this._assets):this.once("load",function(i){t.call(e,i)})},ii.prototype._loadingComplete=function(){this._loaded=!0,this._registry.off("load",this._onLoad,this),this._registry.off("error",this._onError,this),this._failed&&this._failed.length?(this._callback&&this._callback.call(this._scope,"Failed to load some assets",this._failed),this.fire("error",this._failed)):(this._callback&&this._callback.call(this._scope),this.fire("load",this._assets))},ii.prototype._onLoad=function(t){var e=this;0<=this._assets.indexOf(t)&&(this._count++,this.fire("progress",t)),this._count===this._total&&setTimeout(function(){e._loadingComplete(e._failed)},0)},ii.prototype._onError=function(t,e){var i=this;0<=this._assets.indexOf(e)&&(this._count++,this._failed.push(e)),this._count===this._total&&setTimeout(function(){i._loadingComplete(i._failed)},0)},ii.prototype._onAddAsset=function(t){var e=this._waitingAssets.indexOf(t);0<=e&&this._waitingAssets.splice(e,1),this._assets.push(t);var i=this._assets.length;for(e=0;e<i;e++)(t=this._assets[e]).loading||t.loaded||this._registry.load(t)},ii.prototype._waitForAsset=function(t){this._waitingAssets.push(t),this._registry.once("add:"+t,this._onAddAsset,this)};var kl={waitForTemplatesInScene:function(t,e,i){if(t.collapsedInstances){var s=kl._getAllCollapsedEntities(t);kl.waitForTemplateAssets(s,e,i,t)}else i(null,t)},waitForTemplateAssets:function(t,e,i,s){new ii(t=kl._extractTemplateIds(t),e).load(function(t){i(t,s)})},_getAllCollapsedEntities:function(t){var e={};return t.collapsedInstances.forEach(function(t){Object.assign(e,t.instanceEntities)}),e},_extractTemplateIds:function(t){var e,i=[];for(e in t){var s=t[e].template_id;s&&i.push(s)}return i},expandTemplateEntities:function(t,e){var i,s={};for(i in e){var n=e[i];s[i]=n.collapsed_entity?kl.expandEntity(t,n):n}return s},expandEntity:function(t,e){}},zl=function(t,e,i){var s=i.singleVecs,n=e.___1;if(!n)var r=i.tripleVecs,a=e.___2;e=n?n[0]:r[a],t.setLocalPosition(s[e],s[e+1],s[e+2]),e=n?n[1]:r[a+1],t.setLocalEulerAngles(s[e],s[e+1],s[e+2]),e=n?n[2]:r[a+2],t.setLocalScale(s[e],s[e+1],s[e+2])},Ul=function(t,e){return t=t.charCodeAt(0)-e.fieldFirstCode,e.fieldArray[t]},Vl=function(t,e){for(var i=0,s=0;s<t.length;s++)i=i*e.fieldCodeBase+t.charCodeAt(s)-e.fieldFirstCode;return e.fieldArray[i]};Object.assign(si.prototype,{run:function(){var t=Object.prototype.toString.call(this._node);return"[object Object]"===t?this._handleMap():"[object Array]"===t?this._handleArray():this._result=this._node,this._result},_handleMap:function(){this._result={},Object.keys(this._node).forEach(this._handleKey,this)},_handleKey:function(t){var e=t,i=t.length;1===i?e=Ul(t,this._data):2===i&&(e=Vl(t,this._data)),this._result[e]=new si(this._node[t],this._data).run()},_handleArray:function(){this._result=[],this._node.forEach(this._handleArElt,this)},_handleArElt:function(t){t=new si(t,this._data).run(),this._result.push(t)}}),Object.assign(ni.prototype,{parse:function(t){var e,i,s={},n=null;for(e in(i=t.compressedFormat)&&(t.entities=new si(t.entities,i).run()),t.collapsedInstances&&this._addCollapsedToEntities(this._app,t),t.entities){var r=t.entities[e],a=this._createEntity(r,i);s[e]=a,null===r.parent&&(n=a)}for(e in t.entities){a=s[e];var o=(r=t.entities[e].children).length;for(i=0;i<o;i++){var h=s[r[i]];h&&a.addChild(h)}}return this._openComponentData(n,t.entities),delete t.compressedFormat,n},_createEntity:function(t,e){var i=new xe;if(i.name=t.name,i.setGuid(t.resource_id),this._setPosRotScale(i,t,e),i._enabled=void 0===t.enabled||t.enabled,this._isTemplate?i._template=!0:i._enabledInHierarchy=i._enabled,i.template=t.template,t.tags)for(e=0;e<t.tags.length;e++)i.tags.add(t.tags[e]);return t.labels&&t.labels.forEach(function(t){i.addLabel(t)}),i},_setPosRotScale:function(t,e,i){if(i)zl(t,e,i);else{i=e.position;var s=e.rotation;e=e.scale,t.setLocalPosition(i[0],i[1],i[2]),t.setLocalEulerAngles(s[0],s[1],s[2]),t.setLocalScale(e[0],e[1],e[2])}},_openComponentData:function(t,e){var i,s=this._app.systems.list,n=s.length,r=e[t.getGuid()];for(i=0;i<n;i++){var a=s[i],o=r.components[a.id];o&&a.addComponent(t,o)}for(n=r.children.length,s=t._children,i=0;i<n;i++)s[i]=this._openComponentData(s[i],e);return t},_addCollapsedToEntities:function(t,e){e.collapsedInstances.forEach(function(i){i=kl.expandTemplateEntities(t,i.instanceEntities),Object.assign(e.entities,i)})}}),Object.assign(ri.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i=this._app.assets;la.get(t.load,{retry:this.retryRequests},function(s,n){s?(n="Error while loading scene "+t.original,s.message?(n+=": "+s.message,s.stack&&(n+="\n"+s.stack)):n+=": "+s,e(n)):kl.waitForTemplatesInScene(n,i,e)})},open:function(t,e){return this._app.systems.script.preloading=!0,t=new ni(this._app,!1).parse(e),this._app.systems.script.preloading=!1,t}}),Object.assign(ai.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t}),la.get(t.load,{retry:this.retryRequests},function(i,s){i?e("Error loading html resource: "+t.original+" ["+i+"]"):e(null,s)})},open:function(t,e){return e},patch:function(t,e){}}),Object.assign(oi.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i={retry:this.retryRequests};t.load.startsWith("blob:")&&(i.responseType=p.ResponseType.JSON),la.get(t.load,i,function(i,s){i?e("Error loading JSON resource: "+t.original+" ["+i+"]"):e(null,s)})},open:function(t,e){return e},patch:function(t,e){}});var jl,Gl={name:"string",chunks:"chunks",mappingFormat:"string",_engine:"boolean",ambient:"rgb",ambientTint:"boolean",aoVertexColor:"boolean",aoVertexColorChannel:"string",aoMap:"texture",aoMapChannel:"string",aoMapUv:"number",aoMapTiling:"vec2",aoMapOffset:"vec2",diffuse:"rgb",diffuseTint:"boolean",diffuseVertexColor:"boolean",diffuseVertexColorChannel:"string",diffuseMap:"texture",diffuseMapChannel:"string",diffuseMapUv:"number",diffuseMapTiling:"vec2",diffuseMapOffset:"vec2",diffuseDetailMap:"texture",diffuseDetailMapChannel:"string",diffuseDetailMapUv:"number",diffuseDetailMapTiling:"vec2",diffuseDetailMapOffset:"vec2",diffuseDetailMode:"string",specular:"rgb",specularTint:"boolean",specularVertexColor:"boolean",specularVertexColorChannel:"string",specularMap:"texture",specularMapChannel:"string",specularMapUv:"number",specularMapTiling:"vec2",specularMapOffset:"vec2",specularAntialias:"boolean",occludeSpecular:"enum:occludeSpecular",useMetalness:"boolean",metalness:"number",enableGGXSpecular:"boolean",anisotropy:"number",metalnessTint:"boolean",metalnessVertexColor:"boolean",metalnessVertexColorChannel:"string",metalnessMap:"texture",metalnessMapChannel:"string",metalnessMapUv:"number",metalnessMapTiling:"vec2",metalnessMapOffset:"vec2",conserveEnergy:"boolean",shininess:"number",glossVertexColor:"boolean",glossVertexColorChannel:"string",glossMap:"texture",glossMapChannel:"string",glossMapUv:"number",glossMapTiling:"vec2",glossMapOffset:"vec2",clearCoat:"number",clearCoatVertexColor:"boolean",clearCoatVertexColorChannel:"string",clearCoatMap:"texture",clearCoatMapChannel:"string",clearCoatMapUv:"number",clearCoatMapTiling:"vec2",clearCoatMapOffset:"vec2",clearCoatGlossiness:"number",clearCoatGlossVertexColor:"boolean",clearCoatGlossVertexColorChannel:"string",clearCoatGlossMap:"texture",clearCoatGlossMapChannel:"string",clearCoatGlossMapUv:"number",clearCoatGlossMapTiling:"vec2",clearCoatGlossMapOffset:"vec2",clearCoatBumpiness:"number",clearCoatNormalMap:"texture",clearCoatNormalMapUv:"number",clearCoatNormalMapTiling:"vec2",clearCoatNormalMapOffset:"vec2",fresnelModel:"number",emissive:"rgb",emissiveTint:"boolean",emissiveVertexColor:"boolean",emissiveVertexColorChannel:"string",emissiveMap:"texture",emissiveMapChannel:"string",emissiveMapUv:"number",emissiveMapTiling:"vec2",emissiveMapOffset:"vec2",emissiveIntensity:"number",normalMap:"texture",normalMapTiling:"vec2",normalMapOffset:"vec2",normalMapUv:"number",bumpiness:"number",normalDetailMap:"texture",normalDetailMapTiling:"vec2",normalDetailMapOffset:"vec2",normalDetailMapUv:"number",normalDetailMapBumpiness:"number",heightMap:"texture",heightMapChannel:"string",heightMapUv:"number",heightMapTiling:"vec2",heightMapOffset:"vec2",heightMapFactor:"number",alphaToCoverage:"boolean",alphaTest:"number",opacity:"number",opacityVertexColor:"boolean",opacityVertexColorChannel:"string",opacityMap:"texture",opacityMapChannel:"string",opacityMapUv:"number",opacityMapTiling:"vec2",opacityMapOffset:"vec2",reflectivity:"number",refraction:"number",refractionIndex:"number",sphereMap:"texture",cubeMap:"cubemap",cubeMapProjection:"number",cubeMapProjectionBox:"boundingbox",lightVertexColor:"boolean",lightVertexColorChannel:"string",lightMap:"texture",lightMapChannel:"string",lightMapUv:"number",lightMapTiling:"vec2",lightMapOffset:"vec2",depthTest:"boolean",depthWrite:"boolean",depthBias:"number",slopeDepthBias:"number",cull:"enum:cull",blendType:"enum:blendType",shadingModel:"enum:shadingModel",useFog:"boolean",useLighting:"boolean",useSkybox:"boolean",useGammaTonemap:"boolean",prefilteredCubeMap128:"texture",prefilteredCubeMap64:"texture",prefilteredCubeMap32:"texture",prefilteredCubeMap16:"texture",prefilteredCubeMap8:"texture",prefilteredCubeMap4:"texture"},Hl=[];for(jl in Gl){var Wl=Gl[jl];"texture"===Wl&&Hl.push(jl)}var Xl=[];for(jl in Gl)"cubemap"===(Wl=Gl[jl])&&Xl.push(jl);hi.prototype._bind=function(){this.id&&(this._onAssetLoad&&this._registry.on("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:"+this.id,this._onRemove,this)),this.url&&(this._onAssetLoad&&this._registry.on("load:url:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.once("add:url:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.on("remove:url:"+this.url,this._onRemove,this))},hi.prototype._unbind=function(){this.id&&(this._onAssetLoad&&this._registry.off("load:"+this.id,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.id,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.id,this._onRemove,this)),this.url&&(this._onAssetLoad&&this._registry.off("load:"+this.url,this._onLoad,this),this._onAssetAdd&&this._registry.off("add:"+this.url,this._onAdd,this),this._onAssetRemove&&this._registry.off("remove:"+this.url,this._onRemove,this))},hi.prototype._onLoad=function(t){this._onAssetLoad.call(this._scope,this.propertyName,this.parent,t)},hi.prototype._onAdd=function(t){this._onAssetAdd.call(this._scope,this.propertyName,this.parent,t)},hi.prototype._onRemove=function(t){this._onAssetRemove.call(this._scope,this.propertyName,this.parent,t)},Object.defineProperty(hi.prototype,"id",{get:function(){return this._id},set:function(t){if(this.url)throw Error("Can't set id and url");this._unbind(),this._id=t,this.asset=this._registry.get(this._id),this._bind()}}),Object.defineProperty(hi.prototype,"url",{get:function(){return this._url},set:function(t){if(this.id)throw Error("Can't set id and url");this._unbind(),this._url=t,this.asset=this._registry.getByUrl(this._url),this._bind()}}),li.prototype.setInvalid=function(t,e){this.valid=!1,this.removeInvalid&&delete e[t]},li.prototype.validate=function(t){var e,i,s="path"===t.mappingFormat;for(i in t)if(e=Gl[i])if(e.startsWith("enum"))e=e.split(":")[1],this.enumValidators[e]&&(this.enumValidators[e](t[i])||this.setInvalid(i,t));else if("number"===e)"number"!=typeof t[i]&&this.setInvalid(i,t);else if("boolean"===e)"boolean"!=typeof t[i]&&this.setInvalid(i,t);else if("string"===e)"string"!=typeof t[i]&&this.setInvalid(i,t);else if("vec2"===e)t[i]instanceof Array&&2===t[i].length||this.setInvalid(i,t);else if("rgb"===e)t[i]instanceof Array&&3===t[i].length||this.setInvalid(i,t);else if("texture"===e)s?"string"==typeof t[i]||t[null===i]||t[i]instanceof nt||this.setInvalid(i,t):"number"!=typeof t[i]&&null!==t[i]&&(t[i]instanceof nt||this.setInvalid(i,t));else if("boundingbox"===e)t[i].center&&t[i].center instanceof Array&&3===t[i].center.length||this.setInvalid(i,t),t[i].halfExtents&&t[i].halfExtents instanceof Array&&3===t[i].halfExtents.length||this.setInvalid(i,t);else if("cubemap"===e)"number"!=typeof t[i]&&null!==t[i]&&void 0!==t[i]&&(t[i]instanceof nt&&t[i].cubemap||this.setInvalid(i,t));else if("chunks"===e){var n=Object.keys(t[i]);for(e=0;e<n.length;e++)"string"!=typeof t[i][n[e]]&&this.setInvalid(n[e],t[i])}else console.error("Unknown material type: "+e);else this.valid=!1;return t.validated=!0,this.valid},li.prototype._createEnumValidator=function(t){return function(e){return 0<=t.indexOf(e)}},ci.prototype.parse=function(t){t=this.migrate(t),t=this._validate(t);var e=new ar;return this.initialize(e,t),e},ci.prototype.initialize=function(t,e){for(var i in e.validated||(this._validator||(this._validator=new li),this._validator.validate(e)),e.chunks&&t.chunks.copy(e.chunks),e){var s=Gl[i],n=e[i];"vec2"===s?t[i]=new y(n[0],n[1]):"rgb"===s?t[i]=new o(n[0],n[1],n[2]):"texture"===s?n instanceof nt?t[i]=n:t[i]instanceof nt&&"number"==typeof n&&0<n||(t[i]=null):"cubemap"===s?n instanceof nt?t[i]=n:t[i]instanceof nt&&"number"==typeof n&&0<n||(t[i]=null):"boundingbox"===s?(s=new v(n.center[0],n.center[1],n.center[2]),n=new v(n.halfExtents[0],n.halfExtents[1],n.halfExtents[2]),t[i]=new T(s,n)):t[i]=e[i]}t.update()},ci.prototype.migrate=function(t){void 0===t.shadingModel&&(t.shadingModel="blinn"===t.shader?1:0),t.shader&&delete t.shader,t.mapping_format&&(t.mappingFormat=t.mapping_format,delete t.mapping_format);var e,i=[["bumpMapFactor","bumpiness"],["aoUvSet","aoMapUv"],["aoMapVertexColor","aoVertexColor"],["diffuseMapVertexColor","diffuseVertexColor"],["emissiveMapVertexColor","emissiveVertexColor"],["specularMapVertexColor","specularVertexColor"],["metalnessMapVertexColor","metalnessVertexColor"],["opacityMapVertexColor","opacityVertexColor"],["glossMapVertexColor","glossVertexColor"],["lightMapVertexColor","lightVertexColor"],["diffuseMapTint","diffuseTint"],["specularMapTint","specularTint"],["emissiveMapTint","emissiveTint"],["metalnessMapTint","metalnessTint"]];for(e=0;e<i.length;e++){var s=i[e][0],n=i[e][1];void 0!==t[s]&&void 0===t[n]&&(t[n]=t[s],delete t[s])}for(i=["fresnelFactor","shadowSampleType"],e=0;e<i.length;e++)s=i[e],t.hasOwnProperty(s)&&delete t[s];return t},ci.prototype._validate=function(t){return this._validator||(this._validator=new li),this._validator.validate(t),t};var ql={aoMap:"white",diffuseMap:"gray",specularMap:"gray",metalnessMap:"black",glossMap:"gray",emissiveMap:"gray",normalMap:"normal",heightMap:"gray",opacityMap:"gray",sphereMap:"gray",lightMap:"white"};Object.assign(di.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t}),la.get(t.load,{retry:this.retryRequests},function(i,s){i?e&&e("Error loading material: "+t.original+" ["+i+"]"):e&&(s._engine=!0,e(null,s))})},open:function(t,e){return t=this._parser.parse(e),e._engine&&(t._data=e,delete e._engine),t},_createPlaceholders:function(){this._placeholderTextures={};var t,e={white:[255,255,255,255],gray:[128,128,128,255],black:[0,0,0,255],normal:[128,128,255,255]};for(t in e)if(e.hasOwnProperty(t)){this._placeholderTextures[t]=new nt(this._device,{width:2,height:2,format:7}),this._placeholderTextures[t].name="placeholder";for(var i=this._placeholderTextures[t].lock(),s=0;4>s;s++)for(var n=0;4>n;n++)i[4*s+n]=e[t][n];this._placeholderTextures[t].unlock()}},patch:function(t,e){t.resource._data&&(t._data=t.resource._data,delete t.resource._data),t.data.name=t.name,t.resource.name=t.name,this._bindAndAssignAssets(t,e),t.off("unload",this._onAssetUnload,this),t.on("unload",this._onAssetUnload,this)},_onAssetUnload:function(t){delete t.data.parameters,delete t.data.chunks,delete t.data.name},_assignTexture:function(t,e,i){e.data[t]=i,e.resource[t]=i},_assignPlaceholderTexture:function(t,e){this._placeholderTextures||this._createPlaceholders(),e.resource[t]=this._placeholderTextures[ql[t]]},_onTextureLoad:function(t,e,i){this._assignTexture(t,e,i.resource),e.resource.update()},_onTextureAdd:function(t,e,i){this._assets.load(i)},_onTextureRemove:function(t,e,i){var s=e.resource;s[t]===i.resource&&(this._assignTexture(t,e,null),s.update())},_assignCubemap:function(t,e,i){e.data[t]=i[0],7===i.length&&(e.data.prefilteredCubeMap128=i[1],e.data.prefilteredCubeMap64=i[2],e.data.prefilteredCubeMap32=i[3],e.data.prefilteredCubeMap16=i[4],e.data.prefilteredCubeMap8=i[5],e.data.prefilteredCubeMap4=i[6])},_onCubemapLoad:function(t,e,i){this._assignCubemap(t,e,i.resources),this._parser.initialize(e.resource,e.data)},_onCubemapAdd:function(t,e,i){0===e.data.shadingModel&&(e.loadFaces=!0),this._assets.load(i)},_onCubemapRemove:function(t,e,i){var s=e.resource;s[t]===i.resource&&(this._assignCubemap(t,e,[null,null,null,null,null,null,null]),s.update())},_bindAndAssignAssets:function(t,e){var i,s=this._parser.migrate(t.data),n=t.resource,r="path"===s.mappingFormat;for(i=0;i<Hl.length;i++){var a=Hl[i],o=n._assetReferences[a];!s[a]||s[a]instanceof nt?o&&(r?o.url=null:o.id=null):(o||(o=new hi(a,t,e,{load:this._onTextureLoad,add:this._onTextureAdd,remove:this._onTextureRemove},this),n._assetReferences[a]=o),r?o.url=t.getAbsoluteUrl(s[a]):o.id=s[a],o.asset&&(o.asset.resource?this._assignTexture(a,t,o.asset.resource):this._assignPlaceholderTexture(a,t),e.load(o.asset)))}for(i=0;i<Xl.length;i++)a=Xl[i],o=n._assetReferences[a],!s[a]||s[a]instanceof nt||(o||(o=new hi(a,t,e,{load:this._onCubemapLoad,add:this._onCubemapAdd,remove:this._onCubemapRemove},this),n._assetReferences[a]=o),r?o.url=s[a]:o.id=s[a],o.asset&&(o.asset.loaded&&this._assignCubemap(a,t,o.asset.resources),e.load(o.asset)));this._parser.initialize(n,s)}}),Object.assign(ui.prototype,{parse:function(t){return(t=Be.parse("filename.glb",t,this._device))?Be.createModel(t,this._defaultMaterial):null}}),Object.assign(fi.prototype,{addVertex:function(t,e,i){if(void 0!==this.indexMap[e])i=this.indexMap[e],this.indices.push(i);else{for(var s=0;4>s;s++)0!==i.blendWeight.data[4*e+s]&&(t.boneIndices[s]=this.getBoneRemap(i.blendIndices.data[4*t.index+s]));i=this.vertices.length,this.indices.push(i),this.vertices.push(t),this.indexMap[e]=i}},addPrimitive:function(t,e,i,s){var n,r,a=[],o=0,h=t.length;for(n=0;n<h;n++)for(var l=t[n].index,c=0;4>c;c++)if(0<i.blendWeight.data[4*l+c]){var d=i.blendIndices.data[4*l+c],u=!0;for(r=0;r<o;r++)if(a[r]==d){u=!1;break}u&&(a[o]=d,o+=-1===(r=this.getBoneRemap(d))?1:0)}if(this.boneIndices.length+o>s)return!1;for(n=0;n<o;n++)this.boneIndices.push(a[n]);for(n=0;n<h;n++)this.addVertex(t[n],e[n],i);return!0},getBoneRemap:function(t){for(var e=0;e<this.boneIndices.length;e++)if(this.boneIndices[e]===t)return e;return-1}});var Yl={points:0,lines:1,lineloop:2,linestrip:3,triangles:4,trianglestrip:5,trianglefan:6},Kl={int8:0,uint8:1,int16:2,uint16:3,int32:4,uint32:5,float32:6};Object.assign(_i.prototype,{parse:function(t){var e=t.model;if(!e||1>=e.version)return null;e=this._parseNodes(t);var i=this._parseSkins(t,e),s=this._parseVertexBuffers(t),n=this._parseIndexBuffers(t,s),r=this._parseMorphs(t,e,s);return s=this._parseMeshes(t,i.skins,r.morphs,s,n.buffer,n.data),t=this._parseMeshInstances(t,e,s,i.skins,i.instances,r.morphs,r.instances),(s=new mt).graph=e[0],s.meshInstances=t,s.skinInstances=i.instances,s.morphInstances=r.instances,s.getGraph().syncHierarchy(),s},_parseNodes:function(t){t=t.model;var e,i=[];for(e=0;e<t.nodes.length;e++){var s=t.nodes[e],n=new Mt(s.name);n.setLocalPosition(s.position[0],s.position[1],s.position[2]),n.setLocalEulerAngles(s.rotation[0],s.rotation[1],s.rotation[2]),n.setLocalScale(s.scale[0],s.scale[1],s.scale[2]),n.scaleCompensation=!!s.scaleCompensation,i.push(n)}for(e=1;e<t.parents.length;e++)i[t.parents[e]].addChild(i[e]);return i},_parseSkins:function(t,e){t=t.model;var i,s=[],n=[];if(!this._device.supportsBoneTextures&&0<t.skins.length){var r=this._device.getBoneLimit();mi(t,null,r)}for(r=0;r<t.skins.length;r++){var a=t.skins[r],o=[];for(i=0;i<a.inverseBindMatrices.length;i++){var h=a.inverseBindMatrices[i];o[i]=(new x).set(h)}for(a=new ve(this._device,o,a.boneNames),s.push(a),o=new ft(a),h=[],i=0;i<a.boneNames.length;i++){var l=e[0].findByName(a.boneNames[i]);h.push(l)}o.bones=h,n.push(o)}return{skins:s,instances:n}},_getMorphVertexCount:function(t,e,i){for(var s=0;s<t.meshes.length;s++){var n=t.meshes[s];if(n.morph===e)return i[n.vertices].numVertices}},_parseMorphs:function(t,e,i){e=[];var s,n,r=[];if((t=t.model).morphs){var a=function(t,e,i){i=new Float32Array(3*i);for(var s=0;s<e.length;s++){var n=3*e[s];i[n]=t[3*s],i[n+1]=t[3*s+1],i[n+2]=t[3*s+2]}return i};for(s=0;s<t.morphs.length;s++){var o=t.morphs[s].targets,h=[],l=this._getMorphVertexCount(t,s,i);for(n=0;n<o.length;n++){var c=o[n].aabb,d=c.min;d=new T(new v(.5*((c=c.max)[0]+d[0]),.5*(c[1]+d[1]),.5*(c[2]+d[2])),new v(.5*(c[0]-d[0]),.5*(c[1]-d[1]),.5*(c[2]-d[2]))),c=o[n].indices;var u=o[n].deltaPositions,p=o[n].deltaNormals;c&&(u=a(u,c,l),p=a(p,c,l)),d=new ye({deltaPositions:u,deltaNormals:p,name:o[n].name,aabb:d}),h.push(d)}n=new ut(h,this._device),e.push(n),n=new pt(n),r.push(n)}}return{morphs:e,instances:r}},_parseVertexBuffers:function(t){t=t.model;var e,i,s,n=[],r={position:"POSITION",normal:"NORMAL",tangent:"TANGENT",blendWeight:"BLENDWEIGHT",blendIndices:"BLENDINDICES",color:"COLOR",texCoord0:"TEXCOORD0",texCoord1:"TEXCOORD1",texCoord2:"TEXCOORD2",texCoord3:"TEXCOORD3",texCoord4:"TEXCOORD4",texCoord5:"TEXCOORD5",texCoord6:"TEXCOORD6",texCoord7:"TEXCOORD7"};for(i=0;i<t.vertices.length;i++){var a=t.vertices[i],o=[];for(e in a){var h=a[e];o.push({semantic:r[e],components:h.components,type:Kl[h.type],normalize:"COLOR"===r[e]})}h=new O(this._device,o),o=a.position.data.length/a.position.components;var l=new C(this._device,h,o),c=new W(l);for(s=0;s<o;s++){for(e in a)switch(h=a[e],h.components){case 1:c.element[r[e]].set(h.data[s]);break;case 2:c.element[r[e]].set(h.data[2*s],h.data[2*s+1]);break;case 3:c.element[r[e]].set(h.data[3*s],h.data[3*s+1],h.data[3*s+2]);break;case 4:c.element[r[e]].set(h.data[4*s],h.data[4*s+1],h.data[4*s+2],h.data[4*s+3])}c.next()}c.end(),n.push(l)}return n},_parseIndexBuffers:function(t,e){var i,s=t.model,n=t=null,r=0;for(i=0;i<s.meshes.length;i++){var a=s.meshes[i];void 0!==a.indices&&(r+=a.indices.length)}for(i=s=0;i<e.length;i++)s=Math.max(s,e[i].numVertices);return 0<r&&(65535<s&&this._device.extUintElement?(t=new rt(this._device,2,r),n=new Uint32Array(t.lock())):(t=new rt(this._device,1,r),n=new Uint16Array(t.lock()))),{buffer:t,data:n}},_parseMeshes:function(t,e,i,s,n,r){t=t.model;var a,o=[],h=0;for(a=0;a<t.meshes.length;a++){var l=t.meshes[a],c=l.aabb,d=c.min;d=new T(new v(.5*((c=c.max)[0]+d[0]),.5*(c[1]+d[1]),.5*(c[2]+d[2])),new v(.5*(c[0]-d[0]),.5*(c[1]-d[1]),.5*(c[2]-d[2]))),c=void 0!==l.indices;var u=new ht(this._device);u.vertexBuffer=s[l.vertices],u.indexBuffer[0]=c?n:null,u.primitive[0].type=Yl[l.type],u.primitive[0].base=c?l.base+h:l.base,u.primitive[0].count=l.count,u.primitive[0].indexed=c,u.skin=void 0!==l.skin?e[l.skin]:null,u.morph=void 0!==l.morph?i[l.morph]:null,u.aabb=d,c&&(r.set(l.indices,h),h+=l.indices.length),o.push(u)}return null!==n&&n.unlock(),o},_parseMeshInstances:function(t,e,i,s,n,r,a){t=t.model;var o,h=[];for(o=0;o<t.meshInstances.length;o++){var l=t.meshInstances[o],c=i[l.mesh];if(l=new lt(e[l.node],c,this._defaultMaterial),c.skin){var d=s.indexOf(c.skin);l.skinInstance=n[d]}c.morph&&(c=r.indexOf(c.morph),l.morphInstance=a[c]),h.push(l)}return h}}),Object.assign(gi.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i={retry:this.retryRequests};t.load.startsWith("blob:")&&(".glb"===ia.getExtension(t.original).toLowerCase()?i.responseType=p.ResponseType.ARRAY_BUFFER:i.responseType=p.ResponseType.JSON),la.get(t.load,i,function(i,s){e&&(i?e("Error loading model: "+t.original+" ["+i+"]"):e(null,s))})},open:function(t,e){for(var i=0;i<this._parsers.length;i++){var s=this._parsers[i];if(s.decider(t,e))return s.parser.parse(e)}return null},patch:function(t,e){if(t.resource){var i=t.data,s=this;t.resource.meshInstances.forEach(function(n,r){if(i.mapping){var a=function(t){t.resource?n.material=t.resource:(t.once("load",a),e.load(t)),t.once("remove",function(t){n.material===t.resource&&(n.material=s._defaultMaterial)})};if(i.mapping[r]){var o=i.mapping[r].material,h=i.mapping[r].path;void 0!==o?o?(r=e.get(o))?a(r):e.once("add:"+o,a):n.material=s._defaultMaterial:h&&(o=t.getAbsoluteUrl(i.mapping[r].path),(r=e.getByUrl(o))?a(r):e.once("add:url:"+o,a))}else n.material=s._defaultMaterial}})}},addParser:function(t,e){this._parsers.push({parser:t,decider:e})}}),Object.assign(yi.prototype,{addHandler:function(t,e){this._handlers[t]=e,e._loader=this},removeHandler:function(t){delete this._handlers[t]},getHandler:function(t){return this._handlers[t]},load:function(t,e,i,s){var n=this._handlers[e];if(n)if(t){var r=t+e;if(void 0!==this._cache[r])i(null,this._cache[r]);else if(this._requests[r])this._requests[r].push(i);else{this._requests[r]=[i];var a=this,o=function(t,e){t?a._onFailure(r,t):n.load(e,function(t,i,o){if(a._requests[r])if(t)a._onFailure(r,t);else try{a._onSuccess(r,n.open(e.original,i,s),o)}catch(t){a._onFailure(r,t)}},s)},h=t.split("?")[0];this._app.enableBundles&&this._app.bundles.hasUrl(h)?this._app.bundles.canLoadUrl(h)?this._app.bundles.loadUrl(h,function(t,e){o(t,{load:e,original:h})}):o("Bundle for "+t+" not loaded yet"):o(null,{load:t,original:s&&s.getPreferredFile().filename||t})}}else this._loadNull(n,i,s);else i("No handler for asset type: "+e)},_loadNull:function(t,e,i){t.load(null,function(s,n,r){if(s)e(s);else try{e(null,t.open(null,n,i),r)}catch(t){e(t)}},i)},_onSuccess:function(t,e,i){this._cache[t]=e;for(var s=0;s<this._requests[t].length;s++)this._requests[t][s](null,e,i);delete this._requests[t]},_onFailure:function(t,e){if(console.error(e),this._requests[t]){for(var i=0;i<this._requests[t].length;i++)this._requests[t][i](e);delete this._requests[t]}},open:function(t,e){var i=this._handlers[t];return i?i.open(null,e):(console.warn("No resource handler found for: "+t),e)},patch:function(t,e){var i=this._handlers[t.type];i?i.patch&&i.patch(t,e):console.warn("No resource handler found for: "+t.type)},clearCache:function(t,e){delete this._cache[t+e]},getFromCache:function(t,e){if(this._cache[t+e])return this._cache[t+e]},enableRetry:function(){for(var t in this._handlers)this._handlers[t].retryRequests=!0},disableRetry:function(){for(var t in this._handlers)this._handlers[t].retryRequests=!1},destroy:function(){this._handlers={},this._requests={},this._cache={}}}),Object.assign(vi.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i=this._app.assets;la.get(t.load,{retry:this.retryRequests},function(s,n){s?(n="Error while loading scene "+t.original,s.message?(n+=": "+s.message,s.stack&&(n+="\n"+s.stack)):n+=": "+s,e(n)):kl.waitForTemplatesInScene(n,i,e)})},open:function(t,e){this._app.systems.script.preloading=!0,t=new ni(this._app,!1).parse(e);var i=this._app.scene;return i.root=t,this._app.applySceneSettings(e.settings),this._app.systems.script.preloading=!1,i},patch:function(t,e){}}),Object.assign(bi.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t}),la.get(t.load,{retry:this.retryRequests},function(i,s){i?(s="Error while loading scene settings "+t.original,i.message?(s+=": "+i.message,i.stack&&(s+="\n"+i.stack)):s+=": "+i,e(s)):e(null,s)})},open:function(t,e){return e.settings}});var $l=!1,Zl=!1,Ql={app:null,create:function(t,e){if($l){var i=e(Ql.app);i._pcScriptName=t,xi._push(i),this.fire("created",t,e)}},attribute:function(t,e,i,s){},createLoadingScreen:function(t){Zl||(Zl=!0,t(sr.getApplication()))}};Object.defineProperty(Ql,"legacy",{get:function(){return $l},set:function(t){$l=t}}),ta.attach(Ql),xi._types=[],xi._push=function(t){Ql.legacy&&0<xi._types.length?console.assert("Script Ordering Error. Contact support@playcanvas.com"):xi._types.push(t)},Object.assign(xi.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i=this;Ql.app=this._app,this._loadScript(t.load,function(t,s,n){if(t)e(t);else if(Ql.legacy)t=null,xi._types.length&&(t=xi._types.pop()),t?this._scripts[s]=t:t=null,e(null,t,n);else{t={};for(var r=0;r<xi._types.length;r++)t[xi._types[r].name]=xi._types[r];xi._types.length=0,e(null,t,n),delete i._loader._cache[s+"script"]}}.bind(this))},open:function(t,e){return e},patch:function(t,e){},_loadScript:function(t,e){var i=document.head,s=document.createElement("script");this._cache[t]=s,s.async=!1,s.addEventListener("error",function(t){e("Script: "+t.target.src+" failed to load")},!1);var n=!1;s.onload=s.onreadystatechange=function(){n||this.readyState&&"loaded"!=this.readyState&&"complete"!=this.readyState||(n=!0,e(null,t,s))},s.src=t,i.appendChild(s)}}),Object.assign(Si.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t}),la.get(t.load,{retry:this.retryRequests},function(i,s){i?e("Error loading shader resource: "+t.original+" ["+i+"]"):e(null,s)})},open:function(t,e){return e},patch:function(t,e){}});var Jl=[0,0,1,0,0,1,0,0,1,0,0,1],tc=[0,1,3,2,3,1];Ti.prototype=Object.create(n.prototype),Ti.prototype.constructor=Ti,Ti.prototype._createMeshes=function(){var t,e=0;for(t=this._meshes.length;e<t;e++){var i=this._meshes[e];if(i){i.vertexBuffer.destroy();for(var s=0,n=i.indexBuffer.length;s<n;s++)i.indexBuffer[s].destroy()}}for(t=this._frameKeys.length,this._meshes=Array(t),i=1===this.renderMode||2===this._renderMode?this._create9SliceMesh:this._createSimpleMesh,e=0;e<t;e++)s=this._atlas.frames[this._frameKeys[e]],this._meshes[e]=s?i.call(this,s):null;this.fire("set:meshes")},Ti.prototype._createSimpleMesh=function(t){var e=t.rect,i=this._atlas.texture.width,s=this._atlas.texture.height,n=e.z/this._pixelsPerUnit,r=e.w/this._pixelsPerUnit,a=t.pivot.x;t=t.pivot.y;var o=e.x/i,h=e.y/s;return i=(e.x+e.z)/i,e=(e.y+e.w)/s,ee(this._device,[-a*n,-t*r,0,(1-a)*n,-t*r,0,(1-a)*n,(1-t)*r,0,-a*n,(1-t)*r,0],{uvs:[o,h,i,h,i,e,o,e],normals:Jl,indices:tc})},Ti.prototype._create9SliceMesh=function(){var t,e,i=y.ONE,s=[],n=[],r=[],a=[],o=0;for(t=0;3>=t;t++){var h=0===t||3===t?0:1;for(e=0;3>=e;e++){var l=-i.x+2*i.x*(1>=t?0:3)/3,c=-(-i.y+2*i.y*(1>=e?0:3)/3),d=0===e||3===e?0:1;s.push(-l,0,c),n.push(0,1,0),r.push(h,d),3>t&&3>e&&(a.push(o+3+1,o+1,o),a.push(o+3+1,o+3+2,o+1)),o++}}return ee(this._device,s,{normals:n,uvs:r,indices:a})},Ti.prototype._onSetFrames=function(t){this._updatingProperties?this._meshesDirty=!0:this._createMeshes()},Ti.prototype._onFrameChanged=function(t,e){0>(t=this._frameKeys.indexOf(t))||(e?0===this.renderMode&&(this._meshes[t]=this._createSimpleMesh(e)):this._meshes[t]=null,this.fire("set:meshes"))},Ti.prototype._onFrameRemoved=function(t){0>(t=this._frameKeys.indexOf(t))||(this._meshes[t]=null,this.fire("set:meshes"))},Ti.prototype.startUpdate=function(){this._updatingProperties=!0,this._meshesDirty=!1},Ti.prototype.endUpdate=function(){this._updatingProperties=!1,this._meshesDirty&&this._atlas&&this._frameKeys&&this._createMeshes(),this._meshesDirty=!1},Ti.prototype.destroy=function(){var t,e=0;for(t=this._meshes.length;e<t;e++){var i=this._meshes[e];if(i){i.vertexBuffer.destroy();for(var s=0,n=i.indexBuffer.length;s<n;s++)i.indexBuffer[s].destroy()}}this._meshes.length=0},Object.defineProperty(Ti.prototype,"frameKeys",{get:function(){return this._frameKeys},set:function(t){this._frameKeys=t,this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:frameKeys",t)}}),Object.defineProperty(Ti.prototype,"atlas",{get:function(){return this._atlas},set:function(t){t!==this._atlas&&(this._atlas&&(this._atlas.off("set:frames",this._onSetFrames,this),this._atlas.off("set:frame",this._onFrameChanged,this),this._atlas.off("remove:frame",this._onFrameRemoved,this)),(this._atlas=t)&&this._frameKeys&&(this._atlas.on("set:frames",this._onSetFrames,this),this._atlas.on("set:frame",this._onFrameChanged,this),this._atlas.on("remove:frame",this._onFrameRemoved,this),this._updatingProperties?this._meshesDirty=!0:this._createMeshes()),this.fire("set:atlas",t))}}),Object.defineProperty(Ti.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,this.fire("set:pixelsPerUnit",t),this._atlas&&this._frameKeys&&0===this.renderMode&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes()))}}),Object.defineProperty(Ti.prototype,"renderMode",{get:function(){return this._renderMode},set:function(t){if(this._renderMode!==t){var e=this._renderMode;this._renderMode=t,this.fire("set:renderMode",t),(0===e||0===t)&&this._atlas&&this._frameKeys&&(this._updatingProperties?this._meshesDirty=!0:this._createMeshes())}}}),Object.defineProperty(Ti.prototype,"meshes",{get:function(){return this._meshes}}),Object.assign(wi.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t}),".json"===ia.getExtension(t.original)&&la.get(t.load,{retry:this.retryRequests},function(t,i){t?e(t):e(null,i)})},open:function(t,e){var i=new Ti(this._device);return t&&(i.__data=e),i},patch:function(t,e){var i=t.resource;i.__data&&(t.data.pixelsPerUnit=i.__data.pixelsPerUnit,t.data.renderMode=i.__data.renderMode,t.data.frameKeys=i.__data.frameKeys,i.__data.textureAtlasAsset&&((e=e.getByUrl(i.__data.textureAtlasAsset))?t.data.textureAtlasAsset=e.id:console.warn("Could not find textureatlas with url: "+i.__data.textureAtlasAsset))),i.startUpdate(),i.renderMode=t.data.renderMode,i.pixelsPerUnit=t.data.pixelsPerUnit,i.frameKeys=t.data.frameKeys,this._updateAtlas(t),i.endUpdate(),t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)},_updateAtlas:function(t){var e=t.resource;if(t.data.textureAtlasAsset){this._assets.off("load:"+t.data.textureAtlasAsset,Mi,t),this._assets.on("load:"+t.data.textureAtlasAsset,Mi,t);var i=this._assets.get(t.data.textureAtlasAsset);i&&i.resource?e.atlas=i.resource:i?this._assets.load(i):(this._assets.off("add:"+t.data.textureAtlasAsset,Pi,t),this._assets.on("add:"+t.data.textureAtlasAsset,Pi,t))}else e.atlas=null},_onAssetChange:function(t,e,i,s){"data"===e&&i&&i.textureAtlasAsset&&s&&i.textureAtlasAsset!==s.textureAtlasAsset&&(this._assets.off("load:"+s.textureAtlasAsset,Mi,t),this._assets.off("add:"+s.textureAtlasAsset,Pi,t))}}),Ai.prototype.instantiate=function(){return this._templateRoot||this._parseTemplate(),this._templateRoot.clone()},Ai.prototype._parseTemplate=function(){this._templateRoot=new ni(this._app,!0).parse(this._data)},Object.assign(Ei.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i=this._app.assets;la.get(t.load,function(s,n){s?e("Error requesting template: "+t.original):kl.waitForTemplateAssets(n.entities,i,e,n)})},open:function(t,e){return new Ai(this._app,e)}}),Object.assign(Ci.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t}),la.get(t.load,{retry:this.retryRequests},function(i,s){i?e("Error loading text resource: "+t.original+" ["+i+"]"):e(null,s)})},open:function(t,e){return e},patch:function(t,e){}}),Ii.prototype=Object.create(n.prototype),Ii.prototype.constructor=Ii,Ii.prototype.setFrame=function(t,e){var i=this._frames[t];i?(i.rect.copy(e.rect),i.pivot.copy(e.pivot),i.border.copy(e.border)):(i={rect:e.rect.clone(),pivot:e.pivot.clone(),border:e.border.clone()},this._frames[t]=i),this.fire("set:frame",t.toString(),i)},Ii.prototype.removeFrame=function(t){var e=this._frames[t];e&&(delete this._frames[t],this.fire("remove:frame",t.toString(),e))},Ii.prototype.destroy=function(){this._texture&&this._texture.destroy()},Object.defineProperty(Ii.prototype,"texture",{get:function(){return this._texture},set:function(t){this._texture=t,this.fire("set:texture",t)}}),Object.defineProperty(Ii.prototype,"frames",{get:function(){return this._frames},set:function(t){this._frames=t,this.fire("set:frames",t)}});var ec={repeat:0,clamp:1,mirror:2},ic={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},sc=/^data\.frames\.(\d+)$/;Object.assign(Oi.prototype,{load:function(t,e){"string"==typeof t&&(t={load:t,original:t});var i=this,s=this._loader.getHandler("texture");if(".json"!==ia.getExtension(t.original))return s.load(t,e);la.get(t.load,{retry:this.retryRequests},function(s,n){s?e(s):(s=t.original.replace(".json",".png"),i._loader.load(s,"texture",function(t,i){t?e(t):e(null,{data:n,texture:i})}))})},open:function(t,e){var i=new Ii;if(e.texture&&e.data)i.texture=e.texture,i.__data=e.data;else{if(!(t=this._loader.getHandler("texture").open(t,e)))return null;i.texture=t}return i},patch:function(t,e){if(t.resource.__data&&(void 0!==t.resource.__data.minfilter&&(t.data.minfilter=t.resource.__data.minfilter),void 0!==t.resource.__data.magfilter&&(t.data.magfilter=t.resource.__data.magfilter),void 0!==t.resource.__data.addressu&&(t.data.addressu=t.resource.__data.addressu),void 0!==t.resource.__data.addressv&&(t.data.addressv=t.resource.__data.addressv),void 0!==t.resource.__data.mipmaps&&(t.data.mipmaps=t.resource.__data.mipmaps),void 0!==t.resource.__data.anisotropy&&(t.data.anisotropy=t.resource.__data.anisotropy),void 0!==t.resource.__data.rgbm&&(t.data.rgbm=!!t.resource.__data.rgbm),t.data.frames=t.resource.__data.frames,delete t.resource.__data),(e=t.resource.texture)&&(e.name=t.name,t.data.hasOwnProperty("minfilter")&&e.minFilter!==ic[t.data.minfilter]&&(e.minFilter=ic[t.data.minfilter]),t.data.hasOwnProperty("magfilter")&&e.magFilter!==ic[t.data.magfilter]&&(e.magFilter=ic[t.data.magfilter]),t.data.hasOwnProperty("addressu")&&e.addressU!==ec[t.data.addressu]&&(e.addressU=ec[t.data.addressu]),t.data.hasOwnProperty("addressv")&&e.addressV!==ec[t.data.addressv]&&(e.addressV=ec[t.data.addressv]),t.data.hasOwnProperty("mipmaps")&&e.mipmaps!==t.data.mipmaps&&(e.mipmaps=t.data.mipmaps),t.data.hasOwnProperty("anisotropy")&&e.anisotropy!==t.data.anisotropy&&(e.anisotropy=t.data.anisotropy),t.data.hasOwnProperty("rgbm"))){var i=t.data.rgbm?"rgbm":"default";e.type!==i&&(e.type=i)}for(var s in t.resource.texture=e,e={},t.data.frames)i=t.data.frames[s],e[s]={rect:new b(i.rect),pivot:new y(i.pivot),border:new b(i.border)};t.resource.frames=e,t.off("change",this._onAssetChange,this),t.on("change",this._onAssetChange,this)},_onAssetChange:function(t,e,i){if("data"===e||"data.frames"===e){var s={};for(n in i.frames)e=i.frames[n],s[n]={rect:new b(e.rect),pivot:new y(e.pivot),border:new b(e.border)};t.resource.frames=s}else if(e=e.match(sc)){var n=e[1];i?(t.resource.frames[n]?((e=t.resource.frames[n]).rect.set(i.rect[0],i.rect[1],i.rect[2],i.rect[3]),e.pivot.set(i.pivot[0],i.pivot[1]),e.border.set(i.border[0],i.border[1],i.border[2],i.border[3])):t.resource.frames[n]={rect:new b(i.rect),pivot:new y(i.pivot),border:new b(i.border)},t.resource.fire("set:frame",n,t.resource.frames[n])):t.resource.frames[n]&&(delete t.resource.frames[n],t.resource.fire("remove:frame",n))}}});var nc=function(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){var t=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(t instanceof WebAssembly.Module)return new WebAssembly.Instance(t)instanceof WebAssembly.Instance}}catch(t){}return!1}(),rc=!1,ac=null,oc={},hc=null,lc=[],cc=null;Object.assign(Ui.prototype,{load:function(t,e,i){la.get(t.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},function(s,n){s?e(s,n):((s="pvr"===Di()&&i&&i.file&&i.file.variants&&i.file.variants.basis&&0!=(8&i.file.variants.basis.opt))&&(i.file.variants.basis.opt&=-9),zi(t.load,n,e,{unswizzleGGGR:s}))})},open:function(t,e,i){return(t=new nt(i,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels})).upload(),t}}),Object.assign(Vi.prototype,{load:function(t,e,i){if(i&&i.options&&i.options.hasOwnProperty("crossOrigin"))var s=i.options.crossOrigin;else dl.test(t.load)&&(s=this.crossOrigin);this.useImageBitmap?this._loadImageBitmap(t.load,t.original,s,e):this._loadImage(t.load,t.original,s,e)},open:function(t,e,i){var s=ia.getExtension(t).toLowerCase();return(t=new nt(i,{name:t,width:e.width,height:e.height,format:".jpg"===s||".jpeg"===s?6:7})).setSource(e),t},_loadImage:function(t,e,i,s){var n=new Image;i&&(n.crossOrigin=i);var r,a=0,o=this.retryRequests;n.onload=function(){s(null,n)},n.onerror=function(){if(!r)if(o&&5>=++a){var i=100*Math.pow(2,a);console.log("Error loading Texture from: '"+e+"' - Retrying in "+i+"ms...");var h=0<=t.indexOf("?")?"&":"?";r=setTimeout(function(){n.src=t+h+"retry="+Date.now(),r=null},i)}else s("Error loading Texture from: '"+e+"'")},n.src=t},_loadImageBitmap:function(t,e,i,s){la.get(t,{cache:!0,responseType:"blob",retry:this.retryRequests},function(t,e){t?s(t):createImageBitmap(e,{premultiplyAlpha:"none",imageOrientation:"flipY"}).then(function(t){s(null,t)}).catch(function(t){s(t)})})}});var dc=[1481919403,3140563232,169478669],uc={33776:8,33778:9,33779:10,36196:21,37492:22,37496:23,35840:26,35841:24,35842:27,35843:25};Object.assign(ji.prototype,{load:function(t,e,i){la.get(t.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},e)},open:function(t,e,i){return(e=this.parse(e))?((t=new nt(i,{name:t,addressU:e.cubemap?1:0,addressV:e.cubemap?1:0,width:e.width,height:e.height,format:e.format,cubemap:e.cubemap,levels:e.levels})).upload(),t):null},parse:function(t){var e=new Uint32Array(t,0,16);if(dc[0]!==e[0]||dc[1]!==e[1]||dc[2]!==e[2])return null;var i=e[6],s=e[7],n=e[9],r=e[10],a=e[12],o=e[13],h=e[14];if(1<e[11]||1<a||0!==i||!uc[s])return null;e=64+e[15],i=[],a=!1;for(var l=0;l<(h||1);l++){var c=new Uint32Array(t.slice(e,e+4))[0];e+=4,c/=o||1,1<o&&(a=!0,i.push([]));for(var d=0;d<o;d++){var u=new Uint8Array(t,e,c);1<o?i[l].push(u):i.push(u),e+=c}e+=3-(e+3)%4}return{format:uc[s],width:n,height:r,levels:i,cubemap:a}}}),Object.assign(Gi.prototype,{load:function(t,e,i){la.get(t.load,{cache:!0,responseType:"arraybuffer",retry:this.retryRequests},e)},open:function(t,e,i){var s=new Uint32Array(e,0,32),n=s[4],r=s[3],a=Math.max(s[7],1),o=s[21],h=s[22],l=65024===s[28],c=!1,d=!1,u=!1,p=!1,f=!1,m=null;if(4===s[20]?827611204===o?(m=8,c=!0):894720068===o?(m=10,c=!0):116===o?(m=14,d=!0):826496069===o?(m=21,u=c=!0):825438800===o||825504336===o?(m=825438800===o?24:25,p=c=!0):825439312!==o&&825504848!==o||(m=825439312===o?26:27,f=c=!0):32===h&&(m=7),!m)return(t=new nt(i,{width:4,height:4,format:6})).name="dds-legacy-empty",t;for(t=new nt(i,{name:t,addressU:l?1:0,addressV:l?1:0,width:n,height:r,format:m,cubemap:l}),i=128,s=l?6:1,o=827611204===o?8:16,h=0;h<s;h++){m=n;for(var _=r,g=0;g<a;g++){if(c)if(u)var y=Math.floor((m+3)/4)*Math.floor((_+3)/4)*8;else if(p)y=Math.max(m,16)*Math.max(_,8)/4;else if(f)y=Math.max(m,8)*Math.max(_,8)/2;else{y=Math.floor((m+4-1)/4);var v=Math.floor((_+4-1)/4);y*=v,y*=o}else y=m*_*4;v=d?new Float32Array(e,i,y):new Uint8Array(e,i,y),l?(t._levels[g]||(t._levels[g]=[]),t._levels[g][h]=v):t._levels[g]=v,i+=d?4*y:y,m=Math.max(.5*m,1),_=Math.max(.5*_,1)}}return t.upload(),t}});var fc={repeat:0,clamp:1,mirror:2},mc={nearest:0,linear:1,nearest_mip_nearest:2,linear_mip_nearest:4,nearest_mip_linear:3,linear_mip_linear:5},_c={default:"default",rgbm:"rgbm",rgbe:"rgbe",swizzleGGGR:"swizzleGGGR"};Object.assign(Hi.prototype,{load:function(t,e,i){throw Error("not implemented")},open:function(t,e,i){throw Error("not implemented")}});Object.defineProperties(Wi.prototype,{crossOrigin:{get:function(){return this.imgParser.crossOrigin},set:function(t){this.imgParser.crossOrigin=t}},retryRequests:{get:function(){return this.imgParser.retryRequests},set:function(t){for(var e in this.imgParser.retryRequests=t,this.parsers)this.parsers.hasOwnProperty(e)&&(this.parsers[e].retryRequests=t)}}}),Object.assign(Wi.prototype,{_getUrlWithoutParams:function(t){return 0<=t.indexOf("?")?t.split("?")[0]:t},_getParser:function(t){return t=ia.getExtension(this._getUrlWithoutParams(t)).toLowerCase().replace(".",""),this.parsers[t]||this.imgParser},load:function(t,e,i){"string"==typeof t&&(t={load:t,original:t}),this._getParser(t.original).load(t,e,i)},open:function(t,e,i){if(t)return null===(t=this._getParser(t).open(t,e,this._device))?t=new nt(this._device,{width:4,height:4,format:6}):function(t){var e=Math.log2(Math.max(t._width,t._height))+1,i=function(t){return t instanceof HTMLCanvasElement||t instanceof HTMLImageElement||t instanceof HTMLVideoElement};if(!(7!==t._format&&14!==t._format||t._volume||t._compressed||1===t._levels.length||t._levels.length===e||i(t._cubemap?t._levels[0][0]:t._levels[0]))){i=function(t,e,i){for(var s=Math.max(1,t>>1),n=Math.max(1,e>>1),r=new i.constructor(s*n*4),a=Math.floor(t/s),o=a*(e=Math.floor(e/n)),h=0;h<n;++h)for(var l=0;l<s;++l)for(var c=0;4>c;++c){for(var d=0,u=0;u<e;++u)for(var p=0;p<a;++p)d+=i[4*(l*a+p+(h*e+u)*t)+c];r[4*(l+h*s)+c]=d/o}return r};for(var s=t._levels.length;s<e;++s){var n=Math.max(1,t._width>>s-1),r=Math.max(1,t._height>>s-1);if(t._cubemap){for(var a=[],o=0;6>o;++o)a.push(i(n,r,t._levels[s-1][o]));t._levels.push(a)}else t._levels.push(i(n,r,t._levels[s-1]))}t._levelsUpdated=t._cubemap?[[!0,!0,!0,!0,!0,!0]]:[!0]}}(t),t},patch:function(t,e){if(e=t.resource){t.name&&0<t.name.length&&(e.name=t.name);var i=t.data;i.hasOwnProperty("minfilter")&&(e.minFilter=mc[i.minfilter]),i.hasOwnProperty("magfilter")&&(e.magFilter=mc[i.magfilter]),e.cubemap||(i.hasOwnProperty("addressu")&&(e.addressU=fc[i.addressu]),i.hasOwnProperty("addressv")&&(e.addressV=fc[i.addressv])),i.hasOwnProperty("mipmaps")&&(e.mipmaps=i.mipmaps),i.hasOwnProperty("anisotropy")&&(e.anisotropy=i.anisotropy),i.hasOwnProperty("flipY")&&(e.flipY=!!i.flipY),i.hasOwnProperty("type")?e.type=_c[i.type]:i.hasOwnProperty("rgbm")&&i.rgbm?e.type="rgbm":t.file&&t.getPreferredFile&&(t=t.getPreferredFile())&&t.opt&&0!=(8&t.opt)&&(e.type="swizzleGGGR")}}}),Xi.prototype=Object.create(n.prototype),Xi.prototype.constructor=Xi,Object.assign(Xi.prototype,{list:function(t){return t=t||{},this._assets.filter(function(e){var i=!0;return void 0!==t.preload&&(i=e.preload===t.preload),i})},add:function(t){var e=this._assets.push(t)-1;if(this._cache[t.id]=e,this._names[t.name]||(this._names[t.name]=[]),this._names[t.name].push(e),t.file){var i=t.file.url;this._urls[i]=e}t.registry=this,this._tags.addItem(t),t.tags.on("add",this._onTagAdd,this),t.tags.on("remove",this._onTagRemove,this),this.fire("add",t),this.fire("add:"+t.id,t),i&&this.fire("add:url:"+i,t),t.preload&&this.load(t)},remove:function(t){var e=this._cache[t.id],i=t.file?t.file.url:null;if(void 0!==e){this._assets.splice(e,1),delete this._cache[t.id],this._names={},this._urls=[],e=0;for(var s=this._assets.length;e<s;e++){var n=this._assets[e];this._cache[n.id]=e,this._names[n.name]||(this._names[n.name]=[]),this._names[n.name].push(e),n.file&&(this._urls[n.file.url]=e)}return this._tags.removeItem(t),t.tags.off("add",this._onTagAdd,this),t.tags.off("remove",this._onTagRemove,this),t.fire("remove",t),this.fire("remove",t),this.fire("remove:"+t.id,t),i&&this.fire("remove:url:"+i,t),!0}return!1},get:function(t){return this._assets[this._cache[t]]},getByUrl:function(t){return this._assets[this._urls[t]]},load:function(t){if(!t.loading&&!t.loaded){var e=this,i=t.getPreferredFile(),s=function(s){s instanceof Array?t.resources=s:t.resource=s,e._loader.patch(t,e),e.fire("load",t),e.fire("load:"+t.id,t),i&&i.url&&e.fire("load:url:"+i.url,t),t.fire("load",t)},n=function(i,n,r){t.loaded=!0,t.loading=!1,i?(e.fire("error",i,t),e.fire("error:"+t.id,i,t),t.fire("error",i,t)):(Ql.legacy||"script"!==t.type||((i=e._loader.getHandler("script"))._cache[t.id]&&i._cache[t.id].parentNode===document.head&&document.head.removeChild(i._cache[t.id]),i._cache[t.id]=r),s(n))};i||"cubemap"===t.type?(this.fire("load:start",t),this.fire("load:"+t.id+":start",t),t.loading=!0,e._loader.load(t.getFileUrl(),t.type,n,t)):(n=e._loader.open(t.type,t.data),t.loaded=!0,s(n))}},loadFromUrl:function(t,e,i){this.loadFromUrlAndFilename(t,null,e,i)},loadFromUrlAndFilename:function(t,e,i,s){var n=this,r=ia.getBasename(e||t);e={filename:e||r,url:t},(t=n.getByUrl(t))||(t=new Fe(r,i,e),n.add(t)),r=function(t){t.once("load",function(t){"material"===i?n._loadTextures(t,function(e,i){s(e,t)}):s(null,t)}),t.once("error",function(t){s(t)}),n.load(t)},t.resource?s(null,t):"model"===i?n._loadModel(t,r):r(t)},_loadModel:function(t,e){var i=this,s=t.getFileUrl(),n=ia.getExtension(s);if(".json"===n||".glb"===n){var r=ia.getDirectory(s);s=ia.getBasename(s),n=ia.join(r,s.replace(n,".mapping.json")),this._loader.load(n,"json",function(s,n){s?(t.data={mapping:[]},e(t)):i._loadMaterials(t,n,function(i,s){t.data=n,e(t)})})}else e(t)},_loadMaterials:function(t,e,i){for(var s=this,n=[],r=0,a=function(t,e){s._loadTextures(e,function(t,s){n.push(e),n.length===r&&i(null,n)})},o=0;o<e.mapping.length;o++){var h=e.mapping[o].path;h&&(r++,s.loadFromUrl(t.getAbsoluteUrl(h),"material",a))}0===r&&i(null,n)},_loadTextures:function(t,e){var i=[],s=0,n=t.data;if("path"!==n.mappingFormat)e(null,i);else{for(var r=function(t,n){t&&console.error(t),i.push(n),i.length===s&&e(null,i)},a=0;a<Hl.length;a++){var o=n[Hl[a]];o&&"string"==typeof o&&(s++,this.loadFromUrl(t.getAbsoluteUrl(o),"texture",r))}0===s&&e(null,i)}},findAll:function(t,e){var i=this;return(t=this._names[t])?(t=t.map(function(t){return i._assets[t]}),e?t.filter(function(t){return t.type===e}):t):[]},_onTagAdd:function(t,e){this._tags.add(t,e)},_onTagRemove:function(t,e){this._tags.remove(t,e)},findByTag:function(){return this._tags.find(arguments)},filter:function(t){for(var e=[],i=0,s=this._assets.length;i<s;i++)t(this._assets[i])&&e.push(this._assets[i]);return e},find:function(t,e){return(t=this.findAll(t,e))?t[0]:null}}),Object.assign(qi.prototype,{_onAssetAdded:function(t){if("bundle"===t.type){this._bundleAssets[t.id]=t,this._registerBundleEventListeners(t.id);for(var e=0,i=t.data.assets.length;e<i;e++)this._indexAssetInBundle(t.data.assets[e],t)}else this._assetsInBundles[t.id]&&this._indexAssetFileUrls(t)},_registerBundleEventListeners:function(t){this._assets.on("load:"+t,this._onBundleLoaded,this),this._assets.on("error:"+t,this._onBundleError,this)},_unregisterBundleEventListeners:function(t){this._assets.off("load:"+t,this._onBundleLoaded,this),this._assets.off("error:"+t,this._onBundleError,this)},_indexAssetInBundle:function(t,e){if(this._assetsInBundles[t]){var i=this._assetsInBundles[t];-1===i.indexOf(e)&&i.push(e)}else this._assetsInBundles[t]=[e];(t=this._assets.get(t))&&this._indexAssetFileUrls(t)},_indexAssetFileUrls:function(t){var e=this._getAssetFileUrls(t);if(e)for(var i=0,s=e.length;i<s;i++)this._urlsInBundles[e[i]]=this._assetsInBundles[t.id]},_getAssetFileUrls:function(t){var e=t.getFileUrl();if(!e)return null;var i=[e=this._normalizeUrl(e)];if("font"===t.type){t=t.data.info.maps.length;for(var s=1;s<t;s++)i.push(e.replace(".png",s+".png"))}return i},_normalizeUrl:function(t){return t&&t.split("?")[0]},_onAssetRemoved:function(t){if("bundle"===t.type){var e;for(e in delete this._bundleAssets[t.id],this._unregisterBundleEventListeners(t.id),this._assetsInBundles){var i=this._assetsInBundles[e],s=i.indexOf(t);if(-1!==s&&(i.splice(s,1),!i.length))for(var n in delete this._assetsInBundles[e],this._urlsInBundles)this._urlsInBundles[n]===i&&delete this._urlsInBundles[n]}this._onBundleError("Bundle "+t.id+" was removed",t)}else if(this._assetsInBundles[t.id])for(delete this._assetsInBundles[t.id],s=0,e=(t=this._getAssetFileUrls(t)).length;s<e;s++)delete this._urlsInBundles[t[s]]},_onBundleLoaded:function(t){t.resource?requestAnimationFrame(function(){if(this._fileRequests)for(var e in this._fileRequests){var i=this._urlsInBundles[e];if(i&&-1!==i.indexOf(t)){i=decodeURIComponent(e);var s=null;t.resource.hasBlobUrl(i)||(s="Bundle "+t.id+" does not contain URL "+e);for(var n=this._fileRequests[e],r=0,a=n.length;r<a;r++)s?n[r](s):n[r](null,t.resource.getBlobUrl(i));delete this._fileRequests[e]}}}.bind(this)):this._onBundleError("Bundle "+t.id+" failed to load",t)},_onBundleError:function(t,e){for(var i in this._fileRequests)if(!this._findLoadedOrLoadingBundleForUrl(i)){for(var s=0,n=(e=this._fileRequests[i]).length;s<n;s++)e[s](t);delete this._fileRequests[i]}},_findLoadedOrLoadingBundleForUrl:function(t){if(!(t=this._urlsInBundles[t]))return null;var e,i=t.length;for(e=0;e<i;e++)if(t[e].loaded&&t[e].resource)return t[e];for(e=0;e<i;e++)if(t[e].loading)return t[e];return null},listBundlesForAsset:function(t){return this._assetsInBundles[t.id]||null},list:function(){var t,e=[];for(t in this._bundleAssets)e.push(this._bundleAssets[t]);return e},hasUrl:function(t){return!!this._urlsInBundles[t]},canLoadUrl:function(t){return!!this._findLoadedOrLoadingBundleForUrl(t)},loadUrl:function(t,e){var i=this._findLoadedOrLoadingBundleForUrl(t);if(i)if(i.loaded){var s=decodeURIComponent(t);i.resource.hasBlobUrl(s)?e(null,i.resource.getBlobUrl(s)):e("Bundle "+i.id+" does not contain URL "+t)}else this._fileRequests.hasOwnProperty(t)?this._fileRequests[t].push(e):this._fileRequests[t]=[e];else e("URL "+t+" not found in any bundles")},destroy:function(){for(var t in this._assets.off("add",this._onAssetAdded,this),this._assets.off("remove",this._onAssetRemoved,this),this._bundleAssets)this._unregisterBundleEventListeners(t);this._fileRequests=this._urlsInBundles=this._assetsInBundles=this._bundleAssets=this._assets=null}}),Yi.prototype=Object.create(n.prototype),Yi.prototype.constructor=Yi,Yi.prototype.destroy=function(){this.app=null,this.off()},Yi.prototype.add=function(t){var e=this,i=t.__name;return this._scripts.hasOwnProperty(i)?(setTimeout(function(){if(t.prototype.swap){var s=e._list.indexOf(e._scripts[i]);e._list[s]=t,e._scripts[i]=t,e.fire("swap",i,t),e.fire("swap:"+i,t)}else console.warn("script registry already has '"+i+"' script, define 'swap' method for new script type to enable code hot swapping")}),!1):(this._scripts[i]=t,this._list.push(t),this.fire("add",i,t),this.fire("add:"+i,t),setTimeout(function(){if(e._scripts.hasOwnProperty(i)&&e.app&&e.app.systems&&e.app.systems.script){var t=e.app.systems.script._components,s=[],n=[];for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++){var r=t.items[t.loopIndex];if(r._scriptsIndex[i]&&r._scriptsIndex[i].awaiting){if(r._scriptsData&&r._scriptsData[i])var a=r._scriptsData[i].attributes;(r=r.create(i,{preloading:!0,ind:r._scriptsIndex[i].ind,attributes:a}))&&s.push(r)}}for(t=0;t<s.length;t++)s[t].__initializeAttributes();for(t=0;t<s.length;t++)s[t].enabled&&(s[t]._initialized=!0,n.push(s[t]),s[t].initialize&&s[t].initialize());for(t=0;t<n.length;t++)n[t].enabled&&!n[t]._postInitialized&&(n[t]._postInitialized=!0,n[t].postInitialize&&n[t].postInitialize())}}),!0)},Yi.prototype.remove=function(t){var e=t;if("string"!=typeof t?t=e.__name:e=this.get(t),this.get(t)!==e)return!1;delete this._scripts[t];var i=this._list.indexOf(e);return this._list.splice(i,1),this.fire("remove",t,e),this.fire("remove:"+t,e),!0},Yi.prototype.get=function(t){return this._scripts[t]||null},Yi.prototype.has=function(t){return"string"==typeof t?this._scripts.hasOwnProperty(t):!!t&&this._scripts[t.__name]===t},Yi.prototype.list=function(){return this._list};var gc="KEEP_ASPECT",yc="FIXED";Ki.prototype=Object.create(n.prototype),Ki.prototype.constructor=Ki,Object.assign(Ki.prototype,{destroy:function(){window.removeEventListener("vrdisplaypresentchange",self._presentChange),this._camera&&(this._camera.vrDisplay=null),this._camera=null},poll:function(){if(this.display){this.display.getFrameData(this._frameData),this.leftProj.data=this._frameData.leftProjectionMatrix,this.rightProj.data=this._frameData.rightProjectionMatrix;var t=this.display.stageParameters;t?(this.sitToStandInv.set(t.sittingToStandingTransform).invert(),this.combinedView.set(this._frameData.leftViewMatrix),this.leftView.mul2(this.combinedView,this.sitToStandInv),this.combinedView.set(this._frameData.rightViewMatrix),this.rightView.mul2(this.combinedView,this.sitToStandInv)):(this.leftView.set(this._frameData.leftViewMatrix),this.rightView.set(this._frameData.rightViewMatrix));var e=this.leftProj.data[3]+this.leftProj.data[0],i=this.leftProj.data[11]+this.leftProj.data[8],s=1/Math.sqrt(e*e+i*i);t=-Math.atan2(i*s,e*s),e=this.rightProj.data[3]+this.rightProj.data[0],i=this.rightProj.data[11]+this.rightProj.data[8],s=1/Math.sqrt(e*e+i*i),t=Math.max(t,-Math.atan2(i*s,e*s)),this.combinedFov=t*=2,this.combinedAspect=e=this.rightProj.data[5]/this.rightProj.data[0],(i=this.combinedView).copy(this.leftView),i.invert(),this.leftViewInv.copy(i),(s=this.combinedPos).x=this.leftPos.x=i.data[12],s.y=this.leftPos.y=i.data[13],s.z=this.leftPos.z=i.data[14],i.copy(this.rightView),i.invert(),this.rightViewInv.copy(i);var n=s.x-i.data[12],r=s.y-i.data[13],a=s.z-i.data[14];n=Math.sqrt(n*n+r*r+a*a),this.rightPos.x=i.data[12],this.rightPos.y=i.data[13],this.rightPos.z=i.data[14],s.x+=i.data[12],s.y+=i.data[13],s.z+=i.data[14],s.x*=.5,s.y*=.5,s.z*=.5,n=.5*n*Math.sin(Math.PI-(.5*Math.PI+.5*t)),r=i.data[9],a=i.data[10],i.data[12]=s.x+i.data[8]*n,i.data[13]=s.y+r*n,i.data[14]=s.z+a*n,this.combinedViewInv.copy(i),i.invert(),this.combinedProj.setPerspective(t*oa.RAD_TO_DEG,e,this.display.depthNear+n,this.display.depthFar+n,!0)}},requestPresent:function(t){this.display?this.presenting?t&&t(Error("VrDisplay already presenting")):this.display.requestPresent([{source:this._device.canvas}]).then(function(){t&&t()},function(e){t&&t(e)}):t&&t(Error("No VrDisplay to requestPresent"))},exitPresent:function(t){this.display||t&&t(Error("No VrDisplay to exitPresent")),this.presenting?this.display.exitPresent().then(function(){t&&t()},function(){t&&t(Error("exitPresent failed"))}):t&&t(Error("VrDisplay not presenting"))},requestAnimationFrame:function(t){this.display&&this.display.requestAnimationFrame(t)},submitFrame:function(){this.display&&this.display.submitFrame()},reset:function(){this.display&&this.display.resetPose()},setClipPlanes:function(t,e){this.display&&(this.display.depthNear=t,this.display.depthFar=e)},getFrameData:function(){if(this.display)return this._frameData}}),Object.defineProperty(Ki.prototype,"capabilities",{get:function(){return this.display?this.display.capabilities:{}}}),$i.prototype=Object.create(n.prototype),$i.prototype.constructor=$i,$i.isSupported="undefined"!=typeof navigator&&!!navigator.getVRDisplays,Object.assign($i.prototype,{_attach:function(){window.addEventListener("vrdisplayconnect",this._onDisplayConnect),window.addEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},_detach:function(){window.removeEventListener("vrdisplayconnect",this._onDisplayConnect),window.removeEventListener("vrdisplaydisconnect",this._onDisplayDisconnect)},destroy:function(){this._detach()},poll:function(){var t=this.displays.length;if(t)for(var e=0;e<t;e++)this.displays[e]._camera&&this.displays[e].poll()},_getDisplays:function(t){navigator.getVRDisplays?navigator.getVRDisplays().then(function(e){t&&t(null,e)}):t&&t(Error("WebVR not supported"))},_addDisplay:function(t){this._index[t.displayId]||(t=new Ki(this._app,t),this._index[t.id]=t,this.displays.push(t),this.display||(this.display=t),this.fire("displayconnect",t))},_onDisplayConnect:function(t){t.detail&&t.detail.display?this._addDisplay(t.detail.display):this._addDisplay(t.display)},_onDisplayDisconnect:function(t){if(t=this._index[t.detail&&t.detail.display?t.detail.display.displayId:t.display.displayId]){t.destroy(),delete this._index[t.id];var e=this.displays.indexOf(t);this.displays.splice(e,1),this.display===t&&(this.display=this.displays.length?this.displays[0]:null),this.fire("displaydisconnect",t)}}});var vc="inline",bc="immersive-vr",xc="immersive-ar",Sc=[],Tc=[];Zi.prototype=Object.create(n.prototype),Zi.prototype.constructor=Zi,Zi.prototype.remove=function(){if(this._xrHitTestSource){var t=this.manager.hitTest.sources,e=t.indexOf(this);-1!==e&&t.splice(e,1),this.onStop()}},Zi.prototype.onStop=function(){this._xrHitTestSource.cancel(),this._xrHitTestSource=null,this.fire("remove"),this.manager.hitTest.fire("remove",this)},Zi.prototype.update=function(t){if(this._transient){t=t.getHitTestResultsForTransientInput(this._xrHitTestSource);for(var e=0;e<t.length;e++){var i,s=t[e];s.inputSource&&(i=this.manager.input._getByInputSource(s.inputSource)),this.updateHitResults(s.results,i)}}else this.updateHitResults(t.getHitTestResults(this._xrHitTestSource))},Zi.prototype.updateHitResults=function(t,e){for(var i=0;i<t.length;i++){var s=t[i].getPose(this.manager._referenceSpace),n=Sc.pop();n||(n=new v),n.copy(s.transform.position);var r=Tc.pop();r||(r=new S),r.copy(s.transform.orientation),this.fire("result",n,r,e),this.manager.hitTest.fire("result",this,n,r,e),Sc.push(n),Tc.push(r)}},Qi.prototype=Object.create(n.prototype),Qi.prototype.constructor=Qi,Qi.prototype._onSessionStart=function(){this.manager.type===xc&&(this._session=this.manager.session)},Qi.prototype._onSessionEnd=function(){if(this._session){this._session=null;for(var t=0;t<this.sources.length;t++)this.sources[t].onStop();this.sources=[]}},Qi.prototype.isAvailable=function(t,e){var i;return this._supported||(i=Error("XR HitTest is not supported")),this._session||(i=Error("XR Session is not started (1)")),this.manager.type!==xc&&(i=Error("XR HitTest is available only for AR")),!i||(t&&t(i),e&&e.fire("error",i),!1)},Qi.prototype.start=function(t){var e=this;if(t=t||{},this.isAvailable(t.callback,this)){t.profile||t.spaceType||(t.spaceType="viewer");var i,s=t.offsetRay;s&&(i=new XRRay(new DOMPoint(s.origin.x,s.origin.y,s.origin.z),new DOMPoint(s.direction.x,s.direction.y,s.direction.z)));var n=t.callback;t.spaceType?this._session.requestReferenceSpace(t.spaceType).then(function(s){e._session?e._session.requestHitTestSource({space:s,entityTypes:t.entityTypes||void 0,offsetRay:i}).then(function(t){e._onHitTestSource(t,!1,n)}).catch(function(t){n&&n(t),e.fire("error",t)}):(s=Error("XR Session is not started (2)"),n&&n(s),e.fire("error",s))}).catch(function(t){n&&n(t),e.fire("error",t)}):this._session.requestHitTestSourceForTransientInput({profile:t.profile,entityTypes:t.entityTypes||void 0,offsetRay:i}).then(function(t){e._onHitTestSource(t,!0,n)}).catch(function(t){n&&n(t),e.fire("error",t)})}},Qi.prototype._onHitTestSource=function(t,e,i){this._session?(t=new Zi(this.manager,t,e),this.sources.push(t),i&&i(null,t),this.fire("add",t)):(t.cancel(),t=Error("XR Session is not started (3)"),i&&i(t),this.fire("error",t))},Qi.prototype.update=function(t){for(var e=0;e<this.sources.length;e++)this.sources[e].update(t)},Object.defineProperty(Qi.prototype,"supported",{get:function(){return this._supported}}),Object.defineProperty(Ji.prototype,"index",{get:function(){return this._index}}),Object.defineProperty(Ji.prototype,"hand",{get:function(){return this._hand}}),Object.defineProperty(Ji.prototype,"joints",{get:function(){return this._joints}}),Object.defineProperty(Ji.prototype,"tip",{get:function(){return this._tip}});for(var wc=window.XRHand?[XRHand.THUMB_PHALANX_TIP,XRHand.INDEX_PHALANX_TIP,XRHand.MIDDLE_PHALANX_TIP,XRHand.RING_PHALANX_TIP,XRHand.LITTLE_PHALANX_TIP]:[],Mc={},Pc=0;Pc<wc.length;Pc++)Mc[wc[Pc]]=!0;ts.prototype.update=function(t){this._dirtyLocal=!0,this._radius=t.radius,this._localPosition.copy(t.transform.position),this._localRotation.copy(t.transform.orientation)},ts.prototype._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,v.ONE));var t=this._hand._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)},ts.prototype.getPosition=function(){return this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position},ts.prototype.getRotation=function(){return this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation},Object.defineProperty(ts.prototype,"index",{get:function(){return this._index}}),Object.defineProperty(ts.prototype,"hand",{get:function(){return this._hand}}),Object.defineProperty(ts.prototype,"finger",{get:function(){return this._finger}}),Object.defineProperty(ts.prototype,"wrist",{get:function(){return this._wrist}}),Object.defineProperty(ts.prototype,"tip",{get:function(){return this._tip}}),Object.defineProperty(ts.prototype,"radius",{get:function(){return this._radius||.005}});var Ac=[],Ec=new v,Cc=new v,Ic=new v;window.XRHand&&(Ac=[[XRHand.THUMB_METACARPAL,XRHand.THUMB_PHALANX_PROXIMAL,XRHand.THUMB_PHALANX_DISTAL,XRHand.THUMB_PHALANX_TIP],[XRHand.INDEX_METACARPAL,XRHand.INDEX_PHALANX_PROXIMAL,XRHand.INDEX_PHALANX_INTERMEDIATE,XRHand.INDEX_PHALANX_DISTAL,XRHand.INDEX_PHALANX_TIP],[XRHand.MIDDLE_METACARPAL,XRHand.MIDDLE_PHALANX_PROXIMAL,XRHand.MIDDLE_PHALANX_INTERMEDIATE,XRHand.MIDDLE_PHALANX_DISTAL,XRHand.MIDDLE_PHALANX_TIP],[XRHand.RING_METACARPAL,XRHand.RING_PHALANX_PROXIMAL,XRHand.RING_PHALANX_INTERMEDIATE,XRHand.RING_PHALANX_DISTAL,XRHand.RING_PHALANX_TIP],[XRHand.LITTLE_METACARPAL,XRHand.LITTLE_PHALANX_PROXIMAL,XRHand.LITTLE_PHALANX_INTERMEDIATE,XRHand.LITTLE_PHALANX_DISTAL,XRHand.LITTLE_PHALANX_TIP]]),es.prototype=Object.create(n.prototype),es.prototype.constructor=es,es.prototype.update=function(t){for(var e=this._inputSource._xrInputSource,i=0;i<this._joints.length;i++){var s=this._joints[i],n=e.hand[s._id];if(n)if(n=t.getJointPose(n,this._manager._referenceSpace))s.update(n),s.wrist&&!this._tracking&&(this._tracking=!0,this.fire("tracking"));else if(s.wrist){this._tracking&&(this._tracking=!1,this.fire("trackinglost"));break}}n=this._jointsById[XRHand.THUMB_METACARPAL],t=this._jointsById[XRHand.THUMB_PHALANX_TIP],e=this._jointsById[XRHand.INDEX_PHALANX_PROXIMAL],i=this._jointsById[XRHand.INDEX_PHALANX_TIP],s=this._jointsById[XRHand.RING_PHALANX_PROXIMAL];var r=this._jointsById[XRHand.LITTLE_PHALANX_PROXIMAL];if(n&&t&&e&&i&&s&&r){if(this._inputSource._dirtyRay=!0,this._inputSource._rayLocal.origin.lerp(t._localPosition,i._localPosition,.5),"left"===this._inputSource.handedness){var a=n;n=r,r=a}Ec.sub2(n._localPosition,this._wrist._localPosition),Cc.sub2(r._localPosition,this._wrist._localPosition),Ic.cross(Ec,Cc).normalize(),Ec.lerp(e._localPosition,s._localPosition,.5),Ec.sub(this._wrist._localPosition).normalize(),this._inputSource._rayLocal.direction.lerp(Ic,Ec,.5).normalize()}t&&i&&(Ec.copy(t._localPosition),.015>Ec.distance(i._localPosition)?this._inputSource._selecting||(this._inputSource._selecting=!0,this._inputSource.fire("selectstart"),this._manager.input.fire("selectstart",this._inputSource)):this._inputSource._selecting&&(this._inputSource._selecting=!1,this._inputSource.fire("select"),this._manager.input.fire("select",this._inputSource),this._inputSource.fire("selectend"),this._manager.input.fire("selectend",this._inputSource)))},es.prototype.getJointById=function(t){return this._jointsById[t]||null},Object.defineProperty(es.prototype,"fingers",{get:function(){return this._fingers}}),Object.defineProperty(es.prototype,"joints",{get:function(){return this._joints}}),Object.defineProperty(es.prototype,"tips",{get:function(){return this._tips}}),Object.defineProperty(es.prototype,"wrist",{get:function(){return this._wrist}}),Object.defineProperty(es.prototype,"tracking",{get:function(){return this._tracking}});var Oc=new S,Rc=0;is.prototype=Object.create(n.prototype),is.prototype.constructor=is,is.prototype.update=function(t){if(this._hand)this._hand.update(t);else{if(this._xrInputSource.gripSpace){var e=t.getPose(this._xrInputSource.gripSpace,this._manager._referenceSpace);e&&(this._grip||(this._grip=!0,this._localTransform=new x,this._worldTransform=new x,this._localPosition=new v,this._localRotation=new S),this._dirtyLocal=!0,this._localPosition.copy(e.transform.position),this._localRotation.copy(e.transform.orientation))}(t=t.getPose(this._xrInputSource.targetRaySpace,this._manager._referenceSpace))&&(this._dirtyRay=!0,this._rayLocal.origin.copy(t.transform.position),this._rayLocal.direction.set(0,0,-1),Oc.copy(t.transform.orientation),Oc.transformVector(this._rayLocal.direction,this._rayLocal.direction))}},is.prototype._updateTransforms=function(){this._dirtyLocal&&(this._dirtyLocal=!1,this._localTransform.setTRS(this._localPosition,this._localRotation,v.ONE));var t=this._manager.camera.parent;t?this._worldTransform.mul2(t.getWorldTransform(),this._localTransform):this._worldTransform.copy(this._localTransform)},is.prototype._updateRayTransforms=function(){var t=this._dirtyRay;this._dirtyRay=!1,this._manager.camera.parent?((t=this._manager.camera.parent.getWorldTransform()).getTranslation(this._position),this._rotation.setFromMat4(t),this._rotation.transformVector(this._rayLocal.origin,this._ray.origin),this._ray.origin.add(this._position),this._rotation.transformVector(this._rayLocal.direction,this._ray.direction)):t&&(this._ray.origin.copy(this._rayLocal.origin),this._ray.direction.copy(this._rayLocal.direction))},is.prototype.getPosition=function(){return this._position?(this._updateTransforms(),this._worldTransform.getTranslation(this._position),this._position):null},is.prototype.getLocalPosition=function(){return this._localPosition},is.prototype.getRotation=function(){return this._rotation?(this._updateTransforms(),this._rotation.setFromMat4(this._worldTransform),this._rotation):null},is.prototype.getLocalRotation=function(){return this._localRotation},is.prototype.getOrigin=function(){return this._updateRayTransforms(),this._ray.origin},is.prototype.getDirection=function(){return this._updateRayTransforms(),this._ray.direction},is.prototype.hitTestStart=function(t){var e=this;(t=t||{}).profile=this._xrInputSource.profiles[0];var i=t.callback;t.callback=function(t,s){s&&e.onHitTestSourceAdd(s),i&&i(t,s)},this._manager.hitTest.start(t)},is.prototype.onHitTestSourceAdd=function(t){this._hitTestSources.push(t),this.fire("hittest:add",t),t.on("result",function(e,i,s){s===this&&this.fire("hittest:result",t,e,i)},this),t.once("remove",function(){this.onHitTestSourceRemove(t),this.fire("hittest:remove",t)},this)},is.prototype.onHitTestSourceRemove=function(t){-1!==(t=this._hitTestSources.indexOf(t))&&this._hitTestSources.splice(t,1)},Object.defineProperty(is.prototype,"id",{get:function(){return this._id}}),Object.defineProperty(is.prototype,"inputSource",{get:function(){return this._xrInputSource}}),Object.defineProperty(is.prototype,"targetRayMode",{get:function(){return this._xrInputSource.targetRayMode}}),Object.defineProperty(is.prototype,"handedness",{get:function(){return this._xrInputSource.handedness}}),Object.defineProperty(is.prototype,"profiles",{get:function(){return this._xrInputSource.profiles}}),Object.defineProperty(is.prototype,"grip",{get:function(){return this._grip}}),Object.defineProperty(is.prototype,"hand",{get:function(){return this._hand}}),Object.defineProperty(is.prototype,"gamepad",{get:function(){return this._xrInputSource.gamepad||null}}),Object.defineProperty(is.prototype,"selecting",{get:function(){return this._selecting}}),Object.defineProperty(is.prototype,"elementInput",{get:function(){return this._elementInput},set:function(t){this._elementInput!==t&&(this._elementInput=t,this._elementInput||(this._elementEntity=null))}}),Object.defineProperty(is.prototype,"elementEntity",{get:function(){return this._elementEntity}}),Object.defineProperty(is.prototype,"hitTestSources",{get:function(){return this._hitTestSources}}),ss.prototype=Object.create(n.prototype),ss.prototype.constructor=ss,ss.prototype._onSessionStart=function(){this._session=this.manager.session,this._session.addEventListener("inputsourceschange",this._onInputSourcesChangeEvt);var t=this;this._session.addEventListener("select",function(e){var i=t._getByInputSource(e.inputSource);i.update(e.frame),i.fire("select",e),t.fire("select",i,e)}),this._session.addEventListener("selectstart",function(e){var i=t._getByInputSource(e.inputSource);i.update(e.frame),i._selecting=!0,i.fire("selectstart",e),t.fire("selectstart",i,e)}),this._session.addEventListener("selectend",function(e){var i=t._getByInputSource(e.inputSource);i.update(e.frame),i._selecting=!1,i.fire("selectend",e),t.fire("selectend",i,e)});for(var e=this._session.inputSources,i=0;i<e.length;i++)this._addInputSource(e[i])},ss.prototype._onSessionEnd=function(){for(var t=this._inputSources.length;t--;){var e=this._inputSources[t];this._inputSources.splice(t,1),e.fire("remove"),this.fire("remove",e)}this._session.removeEventListener("inputsourceschange",this._onInputSourcesChangeEvt),this._session=null},ss.prototype._onInputSourcesChange=function(t){var e;for(e=0;e<t.removed.length;e++)this._removeInputSource(t.removed[e]);for(e=0;e<t.added.length;e++)this._addInputSource(t.added[e])},ss.prototype._getByInputSource=function(t){for(var e=0;e<this._inputSources.length;e++)if(this._inputSources[e].inputSource===t)return this._inputSources[e];return null},ss.prototype._addInputSource=function(t){this._getByInputSource(t)||(t=new is(this.manager,t),this._inputSources.push(t),this.fire("add",t))},ss.prototype._removeInputSource=function(t){for(var e=0;e<this._inputSources.length;e++)if(this._inputSources[e].inputSource===t){for(t=this._inputSources[e],this._inputSources.splice(e,1),e=t.hitTestSources.length;e--;)t.hitTestSources[e].remove();t.fire("remove"),this.fire("remove",t);break}},ss.prototype.update=function(t){for(var e=0;e<this._inputSources.length;e++)this._inputSources[e].update(t)},Object.defineProperty(ss.prototype,"inputSources",{get:function(){return this._inputSources}});var Dc=new v,Lc=new v,Fc=new x,Bc=new x;ns.prototype=Object.create(n.prototype),ns.prototype.constructor=ns,ns.prototype._onSessionStart=function(){this._manager.session.requestLightProbe&&(this._supported=!0)},ns.prototype._onSessionEnd=function(){this._lightProbeRequested=this._available=this._supported=!1,this._lightProbe=null},ns.prototype.start=function(){var t;if(this._manager.session||(t=Error("XR session is not running")),t||this._manager.type===xc||(t=Error("XR session type is not AR")),t||this._supported||(t=Error("light-estimation is not supported")),(!t&&this._lightProbe||this._lightProbeRequested)&&(t=Error("light estimation is already requested")),t)this.fire("error",t);else{var e=this;this._lightProbeRequested=!0,this._manager.session.requestLightProbe().then(function(t){var i=e._lightProbeRequested;e._lightProbeRequested=!1,e._manager.active?i&&(e._lightProbe=t):e.fire("error",Error("XR session is not active"))}).catch(function(t){e._lightProbeRequested=!1,e.fire("error",t)})}},ns.prototype.end=function(){this._lightProbeRequested=!1,this._lightProbe=null,this._available=!1},ns.prototype.update=function(t){if(this._lightProbe&&(t=t.getLightEstimate(this._lightProbe))){this._available||(this._available=!0,this.fire("available"));var e=t.primaryLightIntensity;this._intensity=Math.max(1,Math.max(e.x,Math.max(e.y,e.z))),Dc.copy(e).scale(1/this._intensity),this._color.set(Dc.x,Dc.y,Dc.z),Dc.set(0,0,0),Lc.copy(t.primaryLightDirection),Fc.setLookAt(Lc,Dc,v.UP),Bc.setFromAxisAngle(v.RIGHT,90),Fc.mul(Bc),this._rotation.setFromMat4(Fc),this._sphericalHarmonics.set(t.sphericalHarmonicsCoefficients)}},Object.defineProperty(ns.prototype,"supported",{get:function(){return this._supported}}),Object.defineProperty(ns.prototype,"available",{get:function(){return!!this._available}}),Object.defineProperty(ns.prototype,"intensity",{get:function(){return this._available?this._intensity:null}}),Object.defineProperty(ns.prototype,"color",{get:function(){return this._available?this._color:null}}),Object.defineProperty(ns.prototype,"rotation",{get:function(){return this._available?this._rotation:null}}),Object.defineProperty(ns.prototype,"sphericalHarmonics",{get:function(){return this._available?this._sphericalHarmonics:null}}),rs.prototype=Object.create(n.prototype),rs.prototype.constructor=rs,rs.prototype.start=function(t,e,i,s){if(this._available[e])if(this._session)s&&s(Error("XR session is already started"));else{var n=this;this._camera=t,this._camera.camera.xr=this,this._type=e,this._spaceType=i,this._setClipPlanes(t.nearClip,t.farClip),t=[],e===xc&&(t.push("light-estimation"),t.push("hit-test")),e===bc&&t.push("hand-tracking"),navigator.xr.requestSession(e,{requiredFeatures:[i],optionalFeatures:t}).then(function(t){n._onSessionStart(t,i,s)}).catch(function(t){n._camera.camera.xr=null,n._camera=null,n._type=null,n._spaceType=null,s&&s(t),n.fire("error",t)})}else s&&s(Error("XR is not available"))},rs.prototype.end=function(t){this._session?(t&&this.once("end",t),this._session.end()):t&&t(Error("XR Session is not initialized"))},rs.prototype.isAvailable=function(t){return this._available[t]},rs.prototype._deviceAvailabilityCheck=function(){for(var t in this._available)this._sessionSupportCheck(t)},rs.prototype._sessionSupportCheck=function(t){var e=this;navigator.xr.isSessionSupported(t).then(function(i){e._available[t]!==i&&(e._available[t]=i,e.fire("available",t,i),e.fire("available:"+t,i))}).catch(function(t){e.fire("error",t)})},rs.prototype._onSessionStart=function(t,e,i){var s=this,n=!1;this._session=t;var r=function(){s.fire("visibility:change",t.visibilityState)},a=function(){s._setClipPlanes(s._camera.nearClip,s._camera.farClip)},o=function(){s._session=null,s._referenceSpace=null,s.views=[],s._width=0,s._height=0,s._type=null,s._spaceType=null,s._camera&&(s._camera.off("set_nearClip",a),s._camera.off("set_farClip",a),s._camera.camera.xr=null,s._camera=null),t.removeEventListener("end",o),t.removeEventListener("visibilitychange",r),n||s.fire("end"),s.app.tick()};t.addEventListener("end",o),t.addEventListener("visibilitychange",r),this._camera.on("set_nearClip",a),this._camera.on("set_farClip",a),this._baseLayer=new XRWebGLLayer(t,this.app.graphicsDevice.gl),t.updateRenderState({baseLayer:this._baseLayer,depthNear:this._depthNear,depthFar:this._depthFar}),t.requestReferenceSpace(e).then(function(t){s._referenceSpace=t,s.app.tick(),i&&i(null),s.fire("start")}).catch(function(e){n=!0,t.end(),i&&i(e),s.fire("error",e)})},rs.prototype._setClipPlanes=function(t,e){this._depthNear===t&&this._depthFar===e||(this._depthNear=t,this._depthFar=e,this._session&&this._session.updateRenderState({depthNear:this._depthNear,depthFar:this._depthFar}))},rs.prototype.update=function(t){if(this._session){var e,i=t.session.renderState.baseLayer.framebufferWidth,s=t.session.renderState.baseLayer.framebufferHeight;this._width===i&&this._height===s||(this._width=i,this._height=s,this.app.graphicsDevice.setResolution(i,s));var n=(i=t.getViewerPose(this._referenceSpace))?i.views.length:0;if(n>this.views.length)for(s=0;s<=n-this.views.length;s++)(e=this.viewsPool.pop())||(e={viewport:new b,projMat:new x,viewMat:new x,viewOffMat:new x,viewInvMat:new x,viewInvOffMat:new x,projViewOffMat:new x,viewMat3:new g,position:new Float32Array(3),rotation:new S}),this.views.push(e);else if(n<=this.views.length)for(s=0;s<this.views.length-n;s++)this.viewsPool.push(this.views.pop());if(i){s=i.transform.position,e=i.transform.orientation,this._localPosition.set(s.x,s.y,s.z),this._localRotation.set(e.x,e.y,e.z,e.w);var r=t.session.renderState.baseLayer;for(s=0;s<i.views.length;s++){n=i.views[s],e=this.views[s];var a=r.getViewport(n);e.viewport.x=a.x,e.viewport.y=a.y,e.viewport.z=a.width,e.viewport.w=a.height,e.projMat.set(n.projectionMatrix),e.viewMat.set(n.transform.inverse.matrix),e.viewInvMat.set(n.transform.matrix)}}this._camera.camera._node.setLocalPosition(this._localPosition),this._camera.camera._node.setLocalRotation(this._localRotation),this.input.update(t),this._type===xc&&(this.hitTest.supported&&this.hitTest.update(t),this.lightEstimation.supported&&this.lightEstimation.update(t)),this.fire("update")}},Object.defineProperty(rs.prototype,"supported",{get:function(){return this._supported}}),Object.defineProperty(rs.prototype,"active",{get:function(){return!!this._session}}),Object.defineProperty(rs.prototype,"type",{get:function(){return this._type}}),Object.defineProperty(rs.prototype,"spaceType",{get:function(){return this._spaceType}}),Object.defineProperty(rs.prototype,"session",{get:function(){return this._session}}),Object.defineProperty(rs.prototype,"visibilityState",{get:function(){return this._session?this._session.visibilityState:null}}),Object.defineProperty(rs.prototype,"camera",{get:function(){return this._camera?this._camera.entity:null}}),as.prototype=Object.create(n.prototype),as.prototype.constructor=as,as._buildAccessors=function(t,e){e.forEach(function(e){var i="object"==typeof e?e.name:e;Object.defineProperty(t,i,{get:function(){return this.data[i]},set:function(t){var e=this.data,s=e[i];e[i]=t,this.fire("set",i,s,t)},configurable:!0})}),t._accessorsBuilt=!0},Object.assign(as.prototype,{buildAccessors:function(t){as._buildAccessors(this,t)},onSetEnabled:function(t,e,i){e!==i&&this.entity.enabled&&(i?this.onEnable():this.onDisable())},onEnable:function(){},onDisable:function(){},onPostStateChange:function(){}}),Object.defineProperty(as.prototype,"data",{get:function(){var t=this.system.store[this.entity.getGuid()];return t?t.data:null}}),os.prototype=Object.create(n.prototype),os.prototype.constructor=os,Object.assign(os,{_helper:function(t,e){for(var i=0,s=t.length;i<s;i++)t[i].f.call(t[i].s,e)},initialize:function(t){this._helper(this._init,t)},postInitialize:function(t){this._helper(this._postInit,t),this.fire("postinitialize",t)},update:function(t,e){this._helper(e?this._toolsUpdate:this._update,t)},animationUpdate:function(t,e){this._helper(this._animationUpdate,t)},fixedUpdate:function(t,e){this._helper(this._fixedUpdate,t)},postUpdate:function(t,e){this._helper(this._postUpdate,t)},_init:[],_postInit:[],_toolsUpdate:[],_update:[],_animationUpdate:[],_fixedUpdate:[],_postUpdate:[],bind:function(t,e,i){switch(t){case"initialize":this._init.push({f:e,s:i});break;case"postInitialize":this._postInit.push({f:e,s:i});break;case"update":this._update.push({f:e,s:i});break;case"animationUpdate":this._animationUpdate.push({f:e,s:i});break;case"postUpdate":this._postUpdate.push({f:e,s:i});break;case"fixedUpdate":this._fixedUpdate.push({f:e,s:i});break;case"toolsUpdate":this._toolsUpdate.push({f:e,s:i});break;default:console.error("Component System does not support event",t)}},_erase:function(t,e,i){for(var s=0;s<t.length;s++)t[s].f===e&&t[s].s===i&&t.splice(s--,1)},unbind:function(t,e,i){switch(t){case"initialize":this._erase(this._init,e,i);break;case"postInitialize":this._erase(this._postInit,e,i);break;case"update":this._erase(this._update,e,i);break;case"animationUpdate":this._erase(this._animationUpdate,e,i);break;case"postUpdate":this._erase(this._postUpdate,e,i);break;case"fixedUpdate":this._erase(this._fixedUpdate,e,i);break;case"toolsUpdate":this._erase(this._toolsUpdate,e,i);break;default:console.error("Component System does not support event",t)}}}),Object.assign(os.prototype,{addComponent:function(t,e){var i=new this.ComponentType(this,t),s=new this.DataType;return e=e||{},this.store[t.getGuid()]={entity:t,data:s},t[this.id]=i,t.c[this.id]=i,this.initializeComponentData(i,e,[]),this.fire("add",t,i),i},removeComponent:function(t){var e=this.store[t.getGuid()];this.fire("beforeremove",t,t.c[this.id]),delete this.store[t.getGuid()],delete t[this.id],delete t.c[this.id],this.fire("remove",t,e.data)},cloneComponent:function(t,e){return t=this.store[t.getGuid()],this.addComponent(e,t.data)},initializeComponentData:function(t,e,i){e=e||{};for(var s,n,r,a=0,o=i.length;a<o;a++)"object"==typeof(s=i[a])?(n=s.name,s=s.type):(n=s,s=void 0),void 0!==(r=e[n])?(void 0!==s&&(r=hs(r,s)),t[n]=r):t[n]=t.data[n];t.enabled&&t.entity.enabled&&t.onEnable()},getPropertiesOfType:function(t){var e=[];return(this.schema||[]).forEach(function(i){i&&"object"==typeof i&&i.type===t&&e.push(i)}),e},destroy:function(){this.off()}}),ta.attach(os),os.destroy=function(){os.off("initialize"),os.off("postInitialize"),os.off("toolsUpdate"),os.off("update"),os.off("animationUpdate"),os.off("fixedUpdate"),os.off("postUpdate")},Object.assign(ls.prototype,{getTarget:function(){return this._targetNode},setTarget:function(t){this._targetNode=t}}),cs.prototype.addTime=function(t){if(null!==this._animation){var e=this._animation._nodes,i=this._animation.duration;if(this._time!==i||this.looping){if(this._time+=t,this._time>i)for(this._time=this.looping?0:i,i=0;i<e.length;i++){var s=e[i],n=s._name;this._currKeyIndices[n]=0}else if(0>this._time)for(this._time=this.looping?i:0,i=0;i<e.length;i++)n=(s=e[i])._name,this._currKeyIndices[n]=s._keys.length-2;for(t=0<=t?1:-1,i=0;i<e.length;i++){n=(s=e[i])._name,s=s._keys;var r=this._interpolatedKeyDict[n];if(void 0!==r){var a=!1;if(1!==s.length)for(var o=this._currKeyIndices[n];o<s.length-1&&0<=o;o+=t){var h=s[o],l=s[o+1];if(h.time<=this._time&&l.time>=this._time){a=(this._time-h.time)/(l.time-h.time),r._pos.lerp(h.position,l.position,a),r._quat.slerp(h.rotation,l.rotation,a),r._scale.lerp(h.scale,l.scale,a),r._written=!0,this._currKeyIndices[n]=o,a=!0;break}}(1===s.length||!a&&0===this._time&&this.looping)&&(r._pos.copy(s[0].position),r._quat.copy(s[0].rotation),r._scale.copy(s[0].scale),r._written=!0)}}}}},cs.prototype.blend=function(t,e,i){for(var s=this._interpolatedKeys.length,n=0;n<s;n++){var r=t._interpolatedKeys[n],a=e._interpolatedKeys[n],o=this._interpolatedKeys[n];r._written&&a._written?(o._quat.slerp(r._quat,e._interpolatedKeys[n]._quat,i),o._pos.lerp(r._pos,e._interpolatedKeys[n]._pos,i),o._scale.lerp(r._scale,a._scale,i),o._written=!0):r._written?(o._quat.copy(r._quat),o._pos.copy(r._pos),o._scale.copy(r._scale),o._written=!0):a._written&&(o._quat.copy(a._quat),o._pos.copy(a._pos),o._scale.copy(a._scale),o._written=!0)}},Object.defineProperty(cs.prototype,"animation",{get:function(){return this._animation},set:function(t){this._animation=t,this.currentTime=0}}),cs.prototype.getAnimation=function(){return this._animation},Object.defineProperty(cs.prototype,"currentTime",{get:function(){return this._time},set:function(t){this._time=t,t=this._interpolatedKeys.length;for(var e=0;e<t;e++)this._currKeyIndices[this._interpolatedKeys[e]._name]=0;this.addTime(0),this.updateGraph()}}),cs.prototype.getCurrentTime=function(){return this._time},cs.prototype.setCurrentTime=function(t){this.currentTime=t},Object.defineProperty(cs.prototype,"numNodes",{get:function(){return this._interpolatedKeys.length}}),cs.prototype.getNumNodes=function(){return this._interpolatedKeys.length},cs.prototype.setAnimation=function(t){this.animation=t},cs.prototype.setGraph=function(t){var e;if(this.graph=t)for(e=0;e<this._interpolatedKeys.length;e++){var i=t.findByName(this._interpolatedKeys[e]._name);this._interpolatedKeys[e].setTarget(i)}else for(e=0;e<this._interpolatedKeys.length;e++)this._interpolatedKeys[e].setTarget(null)},cs.prototype.updateGraph=function(){if(this.graph)for(var t=0;t<this._interpolatedKeys.length;t++){var e=this._interpolatedKeys[t];if(e._written){var i=e.getTarget();i.localPosition.copy(e._pos),i.localRotation.copy(e._quat),i.localScale.copy(e._scale),i._dirtyLocal||i._dirtifyLocal(),e._written=!1}}},cs.prototype.setLooping=function(t){this.looping=t},cs.prototype.getLooping=function(){return this.looping},ds.prototype=Object.create(as.prototype),ds.prototype.constructor=ds,Object.assign(ds.prototype,{play:function(t,e){if(this.enabled&&this.entity.enabled){var i=this.data;if(i.animations[t]){if(e=e||0,i.prevAnim=i.currAnim,i.currAnim=t,i.model){i.skeleton||i.animEvaluator||this._createAnimationController(),t=i.animations[i.prevAnim];var s=i.animations[i.currAnim];if(i.blending=0<e&&i.prevAnim,i.blending&&(i.blend=0,i.blendSpeed=1/e),i.skeleton&&(i.blending?(i.fromSkel.animation=t,i.fromSkel.addTime(i.skeleton._time),i.toSkel.animation=s):i.skeleton.animation=s),i.animEvaluator){if(e=i.animEvaluator,i.blending)for(;1<e.clips.length;)e.removeClip(0);else i.animEvaluator.removeClips();(e=new Ae(i.animations[i.currAnim],0,1,!0,i.loop)).name=i.currAnim,e.blendWeight=i.blending?0:1,e.reset(),i.animEvaluator.addClip(e)}}i.playing=!0}}},getAnimation:function(t){return this.data.animations[t]},setModel:function(t){var e=this.data;t!==e.model&&(this._resetAnimationController(),e.model=t,e.animations&&e.currAnim&&e.animations[e.currAnim]&&this.play(e.currAnim))},_resetAnimationController:function(){var t=this.data;t.skeleton=null,t.fromSkel=null,t.toSkel=null,t.animEvaluator=null},_createAnimationController:function(){var t,e=this.data,i=e.model,s=e.animations,n=!1,r=!1;for(t in s)s.hasOwnProperty(t)&&(s[t].constructor===Me?r=!0:n=!0);i=i.getGraph(),n?(e.fromSkel=new cs(i),e.toSkel=new cs(i),e.skeleton=new cs(i),e.skeleton.looping=e.loop,e.skeleton.setGraph(i)):r&&(e.animEvaluator=new Oe(new Ie(i)))},loadAnimationAssets:function(t){if(t&&t.length){var e,i=this,s=this.system.app.assets,n=t.length,r=function(t){if(1<t.resources.length)for(var e=0;e<t.resources.length;e++)i.animations[t.resources[e].name]=t.resources[e],i.animationsIndex[t.id]=t.resources[e].name;else i.animations[t.name]=t.resource,i.animationsIndex[t.id]=t.name;i.animations=i.animations},a=function(t){t.off("change",i.onAssetChanged,i),t.on("change",i.onAssetChanged,i),t.off("remove",i.onAssetRemoved,i),t.on("remove",i.onAssetRemoved,i),t.resource?r(t):(t.once("load",r,i),i.enabled&&i.entity.enabled&&s.load(t))};for(e=0;e<n;e++){var o=s.get(t[e]);o?a(o):s.on("add:"+t[e],a)}}},onAssetChanged:function(t,e,i,s){if("resource"===e||"resources"===e)if(i){if(1<i.length){if(s&&1<s.length)for(e=0;e<s.length;e++)delete this.animations[s[e].name];else delete this.animations[t.name];for(s=!1,e=0;e<i.length;e++)this.animations[i[e].name]=i[e],!s&&this.data.currAnim===i[e].name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(s=!0,this.play(i[e].name,0))}else{if(s&&1<s.length)for(e=0;e<s.length;e++)delete this.animations[s[e].name];this.animations[t.name]=i[0]||i,s=!1,this.data.currAnim===t.name&&this.data.playing&&this.data.enabled&&this.entity.enabled&&(s=!0,this.play(t.name,0))}s||(this._stopCurrentAnimation(),this.onSetAnimations()),this.animationsIndex[t.id]=t.name}else{if(1<s.length)for(e=0;e<s.length;e++)delete this.animations[s[e].name];else delete this.animations[t.name];delete this.animationsIndex[t.id]}},onAssetRemoved:function(t){if(t.off("remove",this.onAssetRemoved,this),this.animations){if(1<t.resources.length)for(var e=0;e<t.resources.length;e++)delete this.animations[t.resources[e].name],this.data.currAnim===t.resources[e].name&&this._stopCurrentAnimation();else delete this.animations[t.name],this.data.currAnim===t.name&&this._stopCurrentAnimation();delete this.animationsIndex[t.id]}},_stopCurrentAnimation:function(){var t=this.data;t.currAnim=null,t.playing=!1,t.skeleton&&(t.skeleton.currentTime=0,t.skeleton.animation=null),t.animEvaluator&&t.animEvaluator.removeClips()},onSetAnimations:function(t,e,i){if(t=this.data,(e=this.entity.model)&&(e=e.model)&&e!==t.model&&this.setModel(e),!t.currAnim&&t.activate&&t.enabled&&this.entity.enabled)for(var s in t.animations){this.play(s,0);break}},onSetAssets:function(t,e,i){if(e&&e.length)for(t=0;t<e.length;t++)if(e[t]){var s=this.system.app.assets.get(e[t]);if(s){s.off("change",this.onAssetChanged,this),s.off("remove",this.onAssetRemoved,this);var n=this.animationsIndex[s.id];this.data.currAnim===n&&this._stopCurrentAnimation(),delete this.animations[n],delete this.animationsIndex[s.id]}}e=i.map(function(t){return t instanceof Fe?t.id:t}),this.loadAnimationAssets(e)},onSetLoop:function(t,e,i){if((t=this.data).skeleton&&(t.skeleton.looping=t.loop),t.animEvaluator)for(e=0;e<t.animEvaluator.clips.length;++e)t.animEvaluator.clips[e].loop=t.loop},onSetCurrentTime:function(t,e,i){if((t=this.data).skeleton&&((e=t.skeleton).currentTime=i,e.addTime(0),e.updateGraph()),t.animEvaluator)for(t=t.animEvaluator,e=0;e<t.clips.length;++e)t.clips[e].time=i},onEnable:function(){as.prototype.onEnable.call(this);var t=this.data,e=t.assets,i=this.system.app.assets;if(e)for(var s=0,n=e.length;s<n;s++){var r=e[s];r instanceof Fe||(r=i.get(r)),r&&!r.resource&&i.load(r)}if(t.activate&&!t.currAnim)for(var a in t.animations){this.play(a,0);break}},onBeforeRemove:function(){for(var t=0;t<this.assets.length;t++){var e=this.system.app.assets.get(this.assets[t]);e&&(e.off("change",this.onAssetChanged,this),e.off("remove",this.onAssetRemoved,this))}delete(t=this.data).animation,delete t.skeleton,delete t.fromSkel,delete t.toSkel,delete t.animEvaluator}}),Object.defineProperties(ds.prototype,{currentTime:{get:function(){var t=this.data;return t.skeleton?this.data.skeleton._time:t.animEvaluator&&0<(t=t.animEvaluator.clips).length?t[t.length-1].time:0},set:function(t){var e=this.data;if(e.skeleton){var i=e.skeleton;i.currentTime=t,i.addTime(0),i.updateGraph()}if(e.animEvaluator)for(e=e.animEvaluator,i=0;i<e.clips.length;++i)e.clips[i].time=t}},duration:{get:function(){return this.data.animations[this.data.currAnim].duration}}});var Nc="enabled assets speed loop activate animations skeleton model prevAnim currAnim fromSkel toSkel blending blendTimeRemaining playing".split(" ");ps.prototype=Object.create(os.prototype),ps.prototype.constructor=ps,as._buildAccessors(ds.prototype,Nc),Object.assign(ps.prototype,{initializeComponentData:function(t,e,i){i=["activate","enabled","loop","speed","assets"],os.prototype.initializeComponentData.call(this,t,e,i)},cloneComponent:function(t,e){var i;this.addComponent(e,{}),e.animation.assets=t.animation.assets.slice(),e.animation.data.speed=t.animation.speed,e.animation.data.loop=t.animation.loop,e.animation.data.activate=t.animation.activate,e.animation.data.enabled=t.animation.enabled;var s={},n=t.animation.animations;for(i in n)n.hasOwnProperty(i)&&(s[i]=n[i]);for(i in e.animation.animations=s,s={},t=t.animation.animationsIndex)t.hasOwnProperty(i)&&(s[i]=t[i]);e.animation.animationsIndex=s},onBeforeRemove:function(t,e){e.onBeforeRemove()},onUpdate:function(t){var e,i=this.store;for(e in i)if(i.hasOwnProperty(e)){var s=i[e],n=s.data;if(n.enabled&&s.entity.enabled){if(n.blending&&(n.blend+=t*n.blendSpeed,1<=n.blend&&(n.blend=1)),n.playing&&(null!==(s=n.skeleton)&&null!==n.model&&(n.blending?s.blend(n.fromSkel,n.toSkel,n.blend):(s.addTime(t*n.speed),0<n.speed&&s._time===s._animation.duration&&!n.loop?n.playing=!1:0>n.speed&&0===s._time&&!n.loop&&(n.playing=!1)),n.blending&&1===n.blend&&(s.animation=n.toSkel._animation),s.updateGraph())),s=n.animEvaluator){for(var r=0;r<s.clips.length;++r){var a=s.clips[r];a.speed=n.speed,n.playing?a.resume():a.pause()}n.blending&&(s.clips[1].blendWeight=n.blend),s.update(t)}n.blending&&1===n.blend&&(n.blending=!1)}}}}),fs.prototype=Object.create(Ie.prototype),fs.prototype.constructor=fs,fs._packFloat=function(t){return t[0]},fs._packBoolean=function(t){return!!t[0]},fs._packVec2=function(){var t=new y;return function(e){return t.x=e[0],t.y=e[1],t}}(),fs._packVec3=function(){var t=new v;return function(e){return t.x=e[0],t.y=e[1],t.z=e[2],t}}(),fs._packVec4=function(){var t=new b;return function(e){return t.x=e[0],t.y=e[1],t.z=e[2],t.w=e[3],t}}(),fs._packColor=function(){var t=new o;return function(e){return t.r=e[0],t.g=e[1],t.b=e[2],t.a=e[3],t}}(),fs._packQuat=function(){var t=new S;return function(e){return t.x=e[0],t.y=e[1],t.z=e[2],t.w=e[3],t}}(),Object.assign(fs.prototype,{resolve:function(t){var e=this.propertyLocator.decode(t);t=e[0];var i=e[1];e=e[2];var s=this._getEntityFromHierarchy(t);if(!s)return null;switch(i){case"entity":t=s;break;case"graph":if(!this.nodes||!this.nodes[t[0]])return null;t=this.nodes[t[0]].node;break;default:if(!(t=s.findComponent(i)))return null}return this._createAnimTargetForProperty(t,e)},update:function(t){if(t=this.activeNodes)for(var e=0;e<t.length;e++)t[e]._dirtifyLocal()},_getEntityFromHierarchy:function(t){if(!this.animComponent.entity.name===t[0])return null;var e=this.animComponent.entity;return 1===t.length?e:e._parent.findByPath(t.join("/"))},_resolvePath:function(t,e,i){i=e.length-(i?0:1);for(var s=0;s<i;s++)t=t[e[s]];return t},_setter:function(t,e,i){var s=this._resolvePath(t,e),n=e[e.length-1],r="set"+n.substring(0,1).toUpperCase()+n.substring(1);if(s[r]){var a=s[r].bind(s);return function(t){a(i(t))}}var h=s[n];if("object"==typeof h&&h.hasOwnProperty("copy"))return function(t){h.copy(i(t))};if(-1!==[y,v,b,o,S].indexOf(s.constructor)&&1<e.length){var l=2<e.length?this._resolvePath(t,e.slice(0,-1)):t,c=e[e.length-2];return function(t){s[n]=i(t),l[c]=s}}return function(t){s[n]=i(t)}},_createAnimTargetForProperty:function(t,e){if(this.handlers&&"weights"===e[0])return this.handlers.weights(t);if(this.handlers&&"material"===e[0]&&2===e.length){var i=e[1];if(i.indexOf("Map")===i.length-3)return this.handlers.materialTexture(t,i)}if(void 0===(i=this._resolvePath(t,e,!0)))return null;if("number"==typeof i)var s=this._setter(t,e,fs._packFloat),n="vector",r=1;else if("boolean"==typeof i)s=this._setter(t,e,fs._packBoolean),n="vector",r=1;else if("object"==typeof i)switch(i.constructor){case y:s=this._setter(t,e,fs._packVec2),n="vector",r=2;break;case v:s=this._setter(t,e,fs._packVec3),n="vector",r=3;break;case b:s=this._setter(t,e,fs._packVec4),n="vector",r=4;break;case o:s=this._setter(t,e,fs._packColor),n="vector",r=4;break;case S:s=this._setter(t,e,fs._packQuat),n="quaternion",r=4;break;default:return null}return-1!==e.indexOf("material")?new Ee(function(e){s(e),t.material.update()},n,r):new Ee(s,n,r)}}),Object.assign(ms.prototype,{play:function(t){this._controller.play(t)},pause:function(){this._controller.pause()},reset:function(){this._controller.reset()},update:function(t){this._controller.update(t)},assignAnimation:function(t,e){e.constructor===Me&&(this._controller.assignAnimation(t,e),this._component.activate&&this._component.playable&&(this._component.playing=!0))},removeNodeAnimations:function(t){this._controller.removeNodeAnimations(t),this._component.playing=!1}}),Object.defineProperties(ms.prototype,{name:{get:function(){return this._name}},playing:{get:function(){return this._controller.playing},set:function(t){this._controller.playing=t}},playable:{get:function(){return this._controller.playable}},activeState:{get:function(){return this._controller.activeStateName}},previousState:{get:function(){return this._controller.previousStateName}},activeStateProgress:{get:function(){return this._controller.activeStateProgress}},activeStateDuration:{get:function(){return this._controller.activeStateDuration}},activeStateCurrentTime:{get:function(){return this._controller.activeStateCurrentTime},set:function(t){this._controller.activeStateCurrentTime=t}},transitioning:{get:function(){return this._controller.transitioning}},transitionProgress:{get:function(){return this.transitioning?this._controller.transitionProgress:null}},states:{get:function(){return this._controller.states}}}),Object.defineProperties(_s.prototype,{name:{get:function(){return this._name}},animations:{get:function(){return this._animations},set:function(t){this._animations=t}},speed:{get:function(){return this._speed}},loop:{get:function(){return this._loop}},playable:{get:function(){return 0<this.animations.length||"START"===this.name||"END"===this.name}},looping:{get:function(){if(0<this.animations.length){var t=this._controller.animEvaluator.findClip(this.name+"."+this.animations[0].animTrack.name);if(t)return t.loop}return!1}},totalWeight:{get:function(){var t,e=0;for(t=0;t<this.animations.length;t++)e+=this.animations[t].weight;return e}},timelineDuration:{get:function(){var t,e=0;for(t=0;t<this.animations.length;t++){var i=this.animations[t];i.animTrack.duration>e&&(e=i.animTrack.duration>e)}return e}}}),Object.defineProperties(gs.prototype,{from:{get:function(){return this._from}},to:{get:function(){return this._to}},time:{get:function(){return this._time}},priority:{get:function(){return this._priority}},conditions:{get:function(){return this._conditions}},exitTime:{get:function(){return this._exitTime}},transitionOffset:{get:function(){return this._transitionOffset}},interruptionSource:{get:function(){return this._interruptionSource}},hasExitTime:{get:function(){return!!this.exitTime}},hasConditionsMet:{get:function(){var t,e=!0;for(t=0;t<this.conditions.length;t++){var i=this.conditions[t],s=this._controller.findParameter(i.parameterName);switch(i.predicate){case"GREATER_THAN":e=e&&s.value>i.value;break;case"LESS_THAN":e=e&&s.value<i.value;break;case"GREATER_THAN_EQUAL_TO":e=e&&s.value>=i.value;break;case"LESS_THAN_EQUAL_TO":e=e&&s.value<=i.value;break;case"EQUAL_TO":e=e&&s.value===i.value;break;case"NOT_EQUAL_TO":e=e&&s.value!==i.value}if(!e)break}return e}}}),Object.defineProperties(ys.prototype,{animEvaluator:{get:function(){return this._animEvaluator}},activeState:{get:function(){return this._findState(this._activeStateName)},set:function(t){this._activeStateName=t}},activeStateName:{get:function(){return this._activeStateName}},activeStateAnimations:{get:function(){return this.activeState.animations}},previousState:{get:function(){return this._findState(this._previousStateName)},set:function(t){this._previousStateName=t}},previousStateName:{get:function(){return this._previousStateName}},playable:{get:function(){var t,e=!0;for(t=0;t<this._stateNames.length;t++)this._states[this._stateNames[t]].playable||(e=!1);return e}},playing:{get:function(){return this._playing},set:function(t){this._playing=t}},activeStateProgress:{get:function(){return this._getActiveStateProgressForTime(this._timeInState)}},activeStateDuration:{get:function(){if("START"===this.activeStateName||"END"===this.activeStateName)return 0;for(var t=0,e=0;e<this.activeStateAnimations.length;e++){var i=this._animEvaluator.findClip(this.activeStateAnimations[e].name);t=Math.max(t,i.track.duration)}return t}},activeStateCurrentTime:{get:function(){return this._timeInState},set:function(t){this._timeInState=this._timeInStateBefore=t;for(var e=0;e<this.activeStateAnimations.length;e++){var i=this.animEvaluator.findClip(this.activeStateAnimations[e].name);i&&(i.time=t)}}},transitioning:{get:function(){return this._isTransitioning}},transitionProgress:{get:function(){return this._currTransitionTime/this._totalTransitionTime}},states:{get:function(){return this._stateNames}}}),Object.assign(ys.prototype,{_findState:function(t){return this._states[t]},_getActiveStateProgressForTime:function(t){if("START"===this.activeStateName||"END"===this.activeStateName)return 1;var e=this._animEvaluator.findClip(this.activeStateAnimations[0].name);return e?t/e.track.duration:null},_findTransitionsFromState:function(t){var e=this._findTransitionsFromStateCache[t];return e||((e=this._transitions.filter(function(e){return e.from===t})).sort(function(t,e){return t.priority<e.priority}),this._findTransitionsFromStateCache[t]=e),e},_findTransitionsBetweenStates:function(t,e){var i=this._findTransitionsBetweenStatesCache[t+"->"+e];return i||((i=this._transitions.filter(function(i){return i.from===t&&i.to===e})).sort(function(t,e){return t.priority<e.priority}),this._findTransitionsBetweenStatesCache[t+"->"+e]=i),i},_findTransition:function(t,e){var i=[];if(t&&e)i.concat(this._findTransitionsBetweenStates(t,e));else if(this._isTransitioning)switch(this._transitionInterruptionSource){case"PREV_STATE":i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"));break;case"NEXT_STATE":i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case"PREV_STATE_NEXT_STATE":i=(i=(i=i.concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));break;case"NEXT_STATE_PREV_STATE":i=(i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState(this._previousStateName))).concat(this._findTransitionsFromState("ANY"))}else i=(i=i.concat(this._findTransitionsFromState(this._activeStateName))).concat(this._findTransitionsFromState("ANY"));return 0<(i=i.filter(function(t){if(t.to===this.activeStateName)return!1;if(t.hasExitTime){var e=this._getActiveStateProgressForTime(this._timeInStateBefore),i=this._getActiveStateProgressForTime(this._timeInState);if(1>t.exitTime&&this.activeState.looping&&(e-=Math.floor(e),i-=Math.floor(i)),!(t.exitTime>e&&t.exitTime<=i))return null}return t.hasConditionsMet}.bind(this))).length?i[0]:null},_updateStateFromTransition:function(t){var e,i;for(this.previousState=t.from,this.activeState=t.to,e=0;e<t.conditions.length;e++){var s=this.findParameter(t.conditions[e].parameterName);"TRIGGER"===s.type&&(s.value=!1)}if(this.previousState){this._isTransitioning||(this._transitionPreviousStates=[]),this._transitionPreviousStates.push({name:this._previousStateName,weight:1});var n=this._currTransitionTime/this._totalTransitionTime;for(e=0;e<this._transitionPreviousStates.length;e++){this._transitionPreviousStates[e].weight=e!==this._transitionPreviousStates.length-1?this._transitionPreviousStates[e].weight*(1-n):n;var r=this._findState(this._transitionPreviousStates[e].name);for(i=0;i<r.animations.length;i++){var a=r.animations[i];(s=this._animEvaluator.findClip(a.name+".previous."+e))||((s=this._animEvaluator.findClip(a.name)).name=a.name+".previous."+e),s.pause()}}}for(0<t.time&&(this._isTransitioning=!0,this._totalTransitionTime=t.time,this._currTransitionTime=0,this._transitionInterruptionSource=t.interruptionSource),i=t.transitionOffset&&0<t.transitionOffset&&1>t.transitionOffset,r=this.activeState,e=0;e<r.animations.length;e++)(s=this._animEvaluator.findClip(r.animations[e].name))?s.reset():((s=new Ae(r.animations[e].animTrack,0,r.speed,!0,r.loop)).name=r.animations[e].name,this._animEvaluator.addClip(s)),s.blendWeight=0<t.time?0:1/r.totalWeight,s.play(),s.time=i?r.timelineDuration*t.transitionOffset:0<=r.speed?0:this.activeStateDuration;s=e=0,i&&(s=e=t=r.timelineDuration*t.transitionOffset),this._timeInState=e,this._timeInStateBefore=s},_transitionToState:function(t){if(t!==this._activeStateName&&this._findState(t)){var e=this._findTransition(this._activeStateName,t);e||(this._animEvaluator.removeClips(),e=new gs(this,null,t,0,0)),this._updateStateFromTransition(e)}},assignAnimation:function(t,e){var i=this._findState(t);i&&(t={name:t+"."+e.name,animTrack:e,weight:1},0<i.animations.length&&(i.animations=[],this.reset()),i.animations.push(t),!this._playing&&this._activate&&this.playable&&this.play())},removeNodeAnimations:function(t){(t=this._findState(t))&&(t.animations=[])},play:function(t){t&&this._transitionToState(t),this._playing=!0},pause:function(){this._playing=!1},reset:function(){this._previousStateName=null,this._activeStateName="START",this._playing=!1,this._totalTransitionTime=this._currTransitionTime=1,this._isTransitioning=!1,this._timeInStateBefore=this._timeInState=0,this._animEvaluator.removeClips()},update:function(t){if(this._playing){var e,i,s;if(this._timeInStateBefore=this._timeInState,this._timeInState+=t,(e=this._findTransition(this._activeStateName))&&this._updateStateFromTransition(e),this._isTransitioning){if(this._currTransitionTime<this._totalTransitionTime){var n=this._currTransitionTime/this._totalTransitionTime;for(e=0;e<this._transitionPreviousStates.length;e++){var r=this._findState(this._transitionPreviousStates[e].name),a=this._transitionPreviousStates[e].weight;for(i=0;i<r.animations.length;i++){var o=r.animations[i];(s=this._animEvaluator.findClip(o.name+".previous."+e))&&(s.blendWeight=(1-n)*o.weight/r.totalWeight*a)}}for(r=this.activeState,e=0;e<r.animations.length;e++)o=r.animations[e],this._animEvaluator.findClip(o.name).blendWeight=n*o.weight/r.totalWeight}else{for(this._isTransitioning=!1,i=this.activeStateAnimations.length,r=this._animEvaluator.clips.length,e=0;e<r-i;e++)this._animEvaluator.removeClip(0);for(this._transitionPreviousStates=[],r=this.activeState,e=0;e<r.animations.length;e++)o=r.animations[e],(s=this._animEvaluator.findClip(o.name))&&(s.blendWeight=o.weight/r.totalWeight)}this._currTransitionTime+=t}this._animEvaluator.update(t)}},findParameter:function(t){return this._parameters[t]}}),vs.prototype=Object.create(as.prototype),vs.prototype.constructor=vs,Object.assign(vs.prototype,{loadStateGraph:function(t){function e(t,e,n,r){var a=new fs(this,s);e=new ys(a=new Oe(a),e,n,i.parameters,i.activate),i.layers.push(new ms(t,e,this)),i.layerIndices[t]=r}var i=this.data;i.stateGraph=t,i.parameters=t.parameters,i.layers=[];var s,n=this.entity.model;for(n&&(n=n.model)&&(s=n.getGraph()),n=0;n<t.layers.length;n++){var r=t.layers[n];e.bind(this)(r.name,r.states,r.transitions,n)}this.setupAnimationAssets()},setupAnimationAssets:function(){for(var t=0;t<this.data.layers.length;t++)for(var e=this.data.layers[t],i=e.name,s=0;s<e.states.length;s++){var n=e.states[s];"START"!==n&&"END"!==n&&(n=i+":"+n,this.data.animationAssets[n]||(this.data.animationAssets[n]={asset:null}))}this.loadAnimationAssets()},loadAnimationAssets:function(){for(var t=0;t<this.data.layers.length;t++)for(var e=this.data.layers[t],i=0;i<e.states.length;i++){var s=e.states[i],n=this.data.animationAssets[e.name+":"+s];n&&n.asset?(n=this.system.app.assets.get(n.asset)).resource?this.assignAnimation(s,n.resource,e.name):(n.once("load",function(t,e){return function(i){this.assignAnimation(e,i.resource,t)}.bind(this)}.call(this,e.name,s)),this.system.app.assets.load(n)):this.removeNodeAnimations(s,e.name)}},removeStateGraph:function(){this.data.stateGraph=null,this.data.stateGraphAsset=null,this.data.animationAssets={},this.data.layers=[],this.data.layerIndices={},this.data.parameters={},this.data.playing=!1},resetStateGraph:function(){if(this.stateGraphAsset){var t=this.system.app.assets.get(this.stateGraphAsset).resource;this.loadStateGraph(t)}else this.removeStateGraph()},reset:function(){this.data.parameters=Object.assign({},this.data.stateGraph.parameters);for(var t=0;t<this.data.layers.length;t++){var e=this.data.layers[t].playing;this.data.layers[t].reset(),this.data.layers[t].playing=e}},findAnimationLayer:function(t){return this.data.layers[this.data.layerIndices[t]]||null},assignAnimation:function(t,e,i){this.data.stateGraph&&(i=i?this.findAnimationLayer(i):this.baseLayer)&&i.assignAnimation(t,e)},removeNodeAnimations:function(t,e){(e=e?this.findAnimationLayer(e):this.baseLayer)&&e.removeNodeAnimations(t)},getParameterValue:function(t,e){if((t=this.data.parameters[t])&&t.type===e)return t.value},setParameterValue:function(t,e,i){(t=this.data.parameters[t])&&t.type===e&&(t.value=i)},getFloat:function(t){return this.getParameterValue(t,"FLOAT")},setFloat:function(t,e){this.setParameterValue(t,"FLOAT",e)},getInteger:function(t){return this.getParameterValue(t,"INTEGER")},setInteger:function(t,e){"number"==typeof e&&0==e%1&&this.setParameterValue(t,"INTEGER",e)},getBoolean:function(t){return this.getParameterValue(t,"BOOLEAN")},setBoolean:function(t,e){this.setParameterValue(t,"BOOLEAN",!!e)},getTrigger:function(t){return this.getParameterValue(t,"TRIGGER")},setTrigger:function(t){this.setParameterValue(t,"TRIGGER",!0)},resetTrigger:function(t){this.setParameterValue(t,"TRIGGER",!1)}}),Object.defineProperties(vs.prototype,{stateGraphAsset:{get:function(){return this.data.stateGraphAsset},set:function(t){if(null===t)this.removeStateGraph();else{if(t instanceof Fe){var e=t.id,i=this.system.app.assets.get(e);i||(this.system.app.assets.add(t),i=this.system.app.assets.get(e))}else e=t,i=this.system.app.assets.get(e);i&&this.data.stateGraphAsset!==e&&(i.resource?(this.data.stateGraph=i.resource,this.loadStateGraph(this.data.stateGraph),i.on("change",function(t){this.data.stateGraph=new ze(t._data),this.loadStateGraph(this.data.stateGraph)}.bind(this))):(i.once("load",function(t){this.data.stateGraph=t.resource,this.loadStateGraph(this.data.stateGraph)}.bind(this)),i.on("change",function(t){this.data.stateGraph=new ze(t._data),this.loadStateGraph(this.data.stateGraph)}.bind(this)),this.system.app.assets.load(i)),this.data.stateGraphAsset=e)}}},animationAssets:{get:function(){return this.data.animationAssets},set:function(t){this.data.animationAssets=t,this.loadAnimationAssets()}},playable:{get:function(){for(var t=0;t<this.data.layers.length;t++)if(!this.data.layers[t].playable)return!1;return!0}},baseLayer:{get:function(){return 0<this.data.layers.length?this.data.layers[0]:null}}});var kc=["enabled","speed","activate","playing"];xs.prototype=Object.create(os.prototype),xs.prototype.constructor=xs,as._buildAccessors(vs.prototype,kc),Object.assign(xs.prototype,{initializeComponentData:function(t,e,i){i=["activate","enabled","speed","playing"],os.prototype.initializeComponentData.call(this,t,e,i),e.stateGraphAsset&&(t.stateGraphAsset=e.stateGraphAsset),e.animationAssets&&(t.animationAssets=Object.assign(t.data.animationAssets,e.animationAssets))},onAnimationUpdate:function(t){var e,i=this.store;for(e in i)if(i.hasOwnProperty(e)){var s=i[e],n=s.data;if(n.enabled&&s.entity.enabled&&n.playing)for(s=0;s<n.layers.length;s++)n.layers[s].update(t*n.speed)}}}),Ss.prototype=Object.create(as.prototype),Ss.prototype.constructor=Ss,Object.assign(Ss.prototype,{setCurrentListener:function(){if(this.enabled&&this.entity.audiolistener&&this.entity.enabled){this.system.current=this.entity;var t=this.system.current.getPosition();this.system.manager.listener.setPosition(t)}},onEnable:function(){this.setCurrentListener()},onDisable:function(){this.system.current===this.entity&&(this.system.current=null)}});var zc=["enabled"];ws.prototype=Object.create(os.prototype),ws.prototype.constructor=ws,as._buildAccessors(Ss.prototype,zc),Object.assign(ws.prototype,{initializeComponentData:function(t,e,i){i=["enabled"],os.prototype.initializeComponentData.call(this,t,e,i)},onUpdate:function(t){this.current&&(t=this.current.getPosition(),this.manager.listener.setPosition(t),t=this.current.getWorldTransform(),this.manager.listener.setOrientation(t))}}),Ms.prototype=Object.create(as.prototype),Ms.prototype.constructor=Ms,Object.assign(Ms.prototype,{play:function(t){if(this.enabled&&this.entity.enabled){this.channel&&this.stop();var e=this.data;if(e.sources[t]){if(e["3d"]){var i=this.entity.getPosition();i=this.system.manager.playSound3d(e.sources[t],i,e)}else i=this.system.manager.playSound(e.sources[t],e);e.currentSource=t,e.channel=i}}},pause:function(){this.channel&&this.channel.pause()},unpause:function(){this.channel&&this.channel.paused&&this.channel.unpause()},stop:function(){this.channel&&(this.channel.stop(),this.channel=null)},onSetAssets:function(t,e,i){t=[];var s,n=i.length;if(e&&e.length)for(s=0;s<e.length;s++)if(e[s]){var r=this.system.app.assets.get(e[s]);r&&(r.off("change",this.onAssetChanged,this),r.off("remove",this.onAssetRemoved,this),this.currentSource===r.name&&this.stop())}if(n)for(s=0;s<n;s++)0>e.indexOf(i[s])&&(i[s]instanceof Fe?t.push(i[s].id):t.push(i[s]));!this.system._inTools&&t.length&&this.loadAudioSourceAssets(t)},onAssetChanged:function(t,e,i,s){"resource"===e&&this.data.sources&&(this.data.sources[t.name]=i,this.data.currentSource===t.name&&this.channel&&(this.channel.paused?(this.play(t.name),this.pause()):this.play(t.name)))},onAssetRemoved:function(t){t.off("remove",this.onAssetRemoved,this),this.data.sources[t.name]&&(delete this.data.sources[t.name],this.data.currentSource===t.name&&(this.stop(),this.data.currentSource=null))},onSetLoop:function(t,e,i){e!=i&&this.channel&&this.channel.setLoop(i)},onSetVolume:function(t,e,i){e!=i&&this.channel&&this.channel.setVolume(i)},onSetPitch:function(t,e,i){e!=i&&this.channel&&this.channel.setPitch(i)},onSetMaxDistance:function(t,e,i){e!=i&&this.channel instanceof sl&&this.channel.setMaxDistance(i)},onSetMinDistance:function(t,e,i){e!=i&&this.channel instanceof sl&&this.channel.setMinDistance(i)},onSetRollOffFactor:function(t,e,i){e!=i&&this.channel instanceof sl&&this.channel.setRollOffFactor(i)},onSetDistanceModel:function(t,e,i){e!==i&&this.channel instanceof sl&&this.channel.setDistanceModel(i)},onSet3d:function(t,e,i){e!==i&&this.system.initialized&&this.currentSource&&(e=t=!1,this.channel&&(t=this.channel.paused,e=this.channel.suspended),this.play(this.currentSource),this.channel&&(this.channel.paused=t,this.channel.suspended=e))},onEnable:function(){var t=this.data.assets;if(t)for(var e=this.system.app.assets,i=0,s=t.length;i<s;i++){var n=t[i];n instanceof Fe||(n=e.get(n)),n&&!n.resource&&e.load(n)}this.system.initialized&&(this.data.activate&&!this.channel?this.play(this.currentSource):this.unpause())},onDisable:function(){this.pause()},loadAudioSourceAssets:function(t){var e=this,i=t.map(function(t){return this.system.app.assets.get(t)},this),s={},n=null,r=i.length,a=function(t){r--},o=function(){this.data.sources=s,this.data.currentSource=n,this.enabled&&this.activate&&n&&this.onEnable()}.bind(this);i.forEach(function(i,h){i?(n=n||i.name,i.off("change",this.onAssetChanged,this),i.on("change",this.onAssetChanged,this),i.off("remove",this.onAssetRemoved,this),i.on("remove",this.onAssetRemoved,this),i.off("error",a,this),i.on("error",a,this),i.ready(function(t){s[t.name]=t.resource,0===--r&&o()}),!i.resource&&e.enabled&&e.entity.enabled&&this.system.app.assets.load(i)):(0===--r&&o(),this.system.app.assets.on("add:"+t[h],function(t){t.ready(function(t){e.data.sources[t.name]=t.resource}),t.resource||e.system.app.assets.load(t)}))},this)}});var Uc="enabled assets volume pitch loop activate 3d minDistance maxDistance rollOffFactor distanceModel sources currentSource channel".split(" ");As.prototype=Object.create(os.prototype),As.prototype.constructor=As,as._buildAccessors(Ms.prototype,Uc),Object.assign(As.prototype,{initializeComponentData:function(t,e,i){i="activate volume pitch loop 3d minDistance maxDistance rollOffFactor distanceModel enabled assets".split(" "),os.prototype.initializeComponentData.call(this,t,e,i),t.paused=!(t.enabled&&t.activate)},onInitialize:function(t){t.audiosource&&t.enabled&&t.audiosource.enabled&&t.audiosource.activate&&t.audiosource.play(t.audiosource.currentSource);var e,i=(t=t._children).length;for(e=0;e<i;e++)t[e]instanceof xe&&this.onInitialize(t[e]);this.initialized=!0},onUpdate:function(t){for(var e in t=this.store)if(t.hasOwnProperty(e)){var i=t[e],s=i.entity;(i=i.data).enabled&&s.enabled&&i.channel instanceof sl&&(s=s.getPosition(),i.channel.setPosition(s))}},onRemove:function(t,e){e.channel&&(e.channel.stop(),e.channel=null)},setVolume:function(t){this.manager.setVolume(t)}}),Object.assign(Es.prototype,{_configureEventListeners:function(t,e){t=this._parseEventListenerConfig(t,"external",this._parentComponent),e=this._parseEventListenerConfig(e,"internal",this),this._eventListenerConfigs=t.concat(e),this._listenerStatusFlags={},this._gainListeners={},this._loseListeners={}},_parseEventListenerConfig:function(t,e,i){return Object.keys(t).map(function(s,n){var r=s.split("#"),a=r[0],o=r[1],h=t[s];if(2!==r.length||"string"!=typeof a||0===a.length||"string"!=typeof o||0===o.length)throw Error("Invalid event listener description: `"+s+"`");if("function"!=typeof h)throw Error("Invalid or missing callback for event listener `"+s+"`");return{id:e+"_"+n+"_"+s,sourceName:a,eventName:o,callback:h,scope:i}},this)},_toggleLifecycleListeners:function(t){this._parentComponent[t]("set_"+this._entityPropertyName,this._onSetEntity,this),this._parentComponent.system[t]("beforeremove",this._onParentComponentRemove,this),os[t]("postinitialize",this._onPostInitialize,this),this._app[t]("tools:sceneloaded",this._onSceneLoaded,this);for(var e=[],i=0;i<this._eventListenerConfigs.length;++i){var s=this._eventListenerConfigs[i],n=this._app.systems[s.sourceName];n&&(-1===e.indexOf(n)&&e.push(n),n&&"gain"===s.eventName&&(this._gainListeners[s.sourceName]=s),n&&"lose"===s.eventName&&(this._loseListeners[s.sourceName]=s))}for(i=0;i<e.length;++i)e[i][t]("add",this._onComponentAdd,this),e[i][t]("beforeremove",this._onComponentRemove,this)},_onSetEntity:function(t,e,i){i instanceof xe?this._updateEntityReference():null!=i&&"string"!=typeof i?console.warn("Entity field `"+this._entityPropertyName+"` was set to unexpected type '"+typeof i+"'"):e!==i&&this._updateEntityReference()},_onPostInitialize:function(){this._updateEntityReference()},onParentComponentEnable:function(){this._entity||this._updateEntityReference()},_onSceneLoaded:function(){this._updateEntityReference()},_updateEntityReference:function(){var t=this._parentComponent.data[this._entityPropertyName];if(t instanceof xe){var e=t;t=e.getGuid(),this._parentComponent.data[this._entityPropertyName]=t}else e=this._parentComponent.system.app.root,e=this._parentComponent.entity.isDescendantOf(e)&&t?e.findByGuid(t):null;this._entity!==e&&(this._entity&&this._onBeforeEntityChange(),(this._entity=e)&&this._onAfterEntityChange())},_onBeforeEntityChange:function(){this._toggleEntityListeners("off"),this._callAllGainOrLoseListeners(this._loseListeners)},_onAfterEntityChange:function(){this._toggleEntityListeners("on"),this._callAllGainOrLoseListeners(this._gainListeners)},_onComponentAdd:function(t,e){e=e.system.id,t===this._entity&&(this._callGainOrLoseListener(e,this._gainListeners),this._toggleComponentListeners("on",e))},_onComponentRemove:function(t,e){e=e.system.id,t===this._entity&&(this._callGainOrLoseListener(e,this._loseListeners),this._toggleComponentListeners("off",e,!0))},_callAllGainOrLoseListeners:function(t){for(var e in this._entity.c)this._callGainOrLoseListener(e,t)},_callGainOrLoseListener:function(t,e){this._entity.c.hasOwnProperty(t)&&e[t]&&(t=e[t]).callback.call(t.scope)},_toggleEntityListeners:function(t,e){if(this._entity)for(var i=0;i<this._eventListenerConfigs.length;++i)this._safeToggleListener(t,this._eventListenerConfigs[i],e)},_toggleComponentListeners:function(t,e,i){for(var s=0;s<this._eventListenerConfigs.length;++s){var n=this._eventListenerConfigs[s];n.sourceName===e&&this._safeToggleListener(t,n,i)}},_safeToggleListener:function(t,e,i){var s="on"===t;s&&this._listenerStatusFlags[e.id]||(i=this._getEventSource(e.sourceName,i))&&(i[t](e.eventName,e.callback,e.scope),this._listenerStatusFlags[e.id]=s)},_getEventSource:function(t,e){if("entity"===t)return this._entity;var i=this._entity[t];return i||(e||console.warn("Entity has no component with name "+t),null)},_onEntityDestroy:function(t){this._entity===t&&(this._toggleEntityListeners("off",!0),this._entity=null)},_onParentComponentRemove:function(t,e){e===this._parentComponent&&(this._toggleLifecycleListeners("off"),this._toggleEntityListeners("off",!0))},hasComponent:function(t){return!(!this._entity||!this._entity.c)&&!!this._entity.c[t]}}),Object.defineProperty(Es.prototype,"entity",{get:function(){return this._entity}});var Vc=0,jc={DEFAULT:"DEFAULT",HOVER:"HOVER",PRESSED:"PRESSED",INACTIVE:"INACTIVE"},Gc={};Gc[jc.DEFAULT]="_defaultTint",Gc[jc.HOVER]="hoverTint",Gc[jc.PRESSED]="pressedTint",Gc[jc.INACTIVE]="inactiveTint";var Hc={};Hc[jc.DEFAULT]="_defaultSpriteAsset",Hc[jc.HOVER]="hoverSpriteAsset",Hc[jc.PRESSED]="pressedSpriteAsset",Hc[jc.INACTIVE]="inactiveSpriteAsset";var Wc={};Wc[jc.DEFAULT]="_defaultSpriteFrame",Wc[jc.HOVER]="hoverSpriteFrame",Wc[jc.PRESSED]="pressedSpriteFrame",Wc[jc.INACTIVE]="inactiveSpriteFrame",Cs.prototype=Object.create(as.prototype),Cs.prototype.constructor=Cs,Object.assign(Cs.prototype,{_toggleLifecycleListeners:function(t,e){this[t]("set_active",this._onSetActive,this),this[t]("set_transitionMode",this._onSetTransitionMode,this),this[t]("set_hoverTint",this._onSetTransitionValue,this),this[t]("set_pressedTint",this._onSetTransitionValue,this),this[t]("set_inactiveTint",this._onSetTransitionValue,this),this[t]("set_hoverSpriteAsset",this._onSetTransitionValue,this),this[t]("set_hoverSpriteFrame",this._onSetTransitionValue,this),this[t]("set_pressedSpriteAsset",this._onSetTransitionValue,this),this[t]("set_pressedSpriteFrame",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteAsset",this._onSetTransitionValue,this),this[t]("set_inactiveSpriteFrame",this._onSetTransitionValue,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)},_onSetActive:function(t,e,i){e!==i&&this._updateVisualState()},_onSetTransitionMode:function(t,e,i){e!==i&&(this._cancelTween(),this._resetToDefaultVisualState(e),this._forceReapplyVisualState())},_onSetTransitionValue:function(t,e,i){e!==i&&this._forceReapplyVisualState()},_onElementComponentRemove:function(t){this.entity===t&&this._toggleHitElementListeners("off")},_onElementComponentAdd:function(t){this.entity===t&&this._toggleHitElementListeners("on")},_onImageElementLose:function(){this._cancelTween(),this._resetToDefaultVisualState(this.transitionMode)},_onImageElementGain:function(){this._storeDefaultVisualState(),this._forceReapplyVisualState()},_toggleHitElementListeners:function(t){if(this.entity.element){var e="on"===t;e&&this._hasHitElementListeners||(this.entity.element[t]("mouseenter",this._onMouseEnter,this),this.entity.element[t]("mouseleave",this._onMouseLeave,this),this.entity.element[t]("mousedown",this._onMouseDown,this),this.entity.element[t]("mouseup",this._onMouseUp,this),this.entity.element[t]("touchstart",this._onTouchStart,this),this.entity.element[t]("touchend",this._onTouchEnd,this),this.entity.element[t]("touchleave",this._onTouchLeave,this),this.entity.element[t]("touchcancel",this._onTouchCancel,this),this.entity.element[t]("selectstart",this._onSelectStart,this),this.entity.element[t]("selectend",this._onSelectEnd,this),this.entity.element[t]("selectenter",this._onSelectEnter,this),this.entity.element[t]("selectleave",this._onSelectLeave,this),this.entity.element[t]("click",this._onClick,this),this._hasHitElementListeners=e)}},_storeDefaultVisualState:function(){this._imageReference.hasComponent("element")&&(this._storeDefaultColor(this._imageReference.entity.element.color),this._storeDefaultOpacity(this._imageReference.entity.element.opacity),this._storeDefaultSpriteAsset(this._imageReference.entity.element.spriteAsset),this._storeDefaultSpriteFrame(this._imageReference.entity.element.spriteFrame))},_storeDefaultColor:function(t){this._defaultTint.r=t.r,this._defaultTint.g=t.g,this._defaultTint.b=t.b},_storeDefaultOpacity:function(t){this._defaultTint.a=t},_storeDefaultSpriteAsset:function(t){this._defaultSpriteAsset=t},_storeDefaultSpriteFrame:function(t){this._defaultSpriteFrame=t},_onSetColor:function(t){this._isApplyingTint||(this._storeDefaultColor(t),this._forceReapplyVisualState())},_onSetOpacity:function(t){this._isApplyingTint||(this._storeDefaultOpacity(t),this._forceReapplyVisualState())},_onSetSpriteAsset:function(t){this._isApplyingSprite||(this._storeDefaultSpriteAsset(t),this._forceReapplyVisualState())},_onSetSpriteFrame:function(t){this._isApplyingSprite||(this._storeDefaultSpriteFrame(t),this._forceReapplyVisualState())},_onMouseEnter:function(t){this._isHovering=!0,this._updateVisualState(),this._fireIfActive("mouseenter",t)},_onMouseLeave:function(t){this._isPressed=this._isHovering=!1,this._updateVisualState(),this._fireIfActive("mouseleave",t)},_onMouseDown:function(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("mousedown",t)},_onMouseUp:function(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("mouseup",t)},_onTouchStart:function(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("touchstart",t)},_onTouchEnd:function(t){t.event.preventDefault(),this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchend",t)},_onTouchLeave:function(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchleave",t)},_onTouchCancel:function(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("touchcancel",t)},_onSelectStart:function(t){this._isPressed=!0,this._updateVisualState(),this._fireIfActive("selectstart",t)},_onSelectEnd:function(t){this._isPressed=!1,this._updateVisualState(),this._fireIfActive("selectend",t)},_onSelectEnter:function(t){this._hoveringCounter++,1===this._hoveringCounter&&(this._isHovering=!0,this._updateVisualState()),this._fireIfActive("selectenter",t)},_onSelectLeave:function(t){this._hoveringCounter--,0===this._hoveringCounter&&(this._isPressed=this._isHovering=!1,this._updateVisualState()),this._fireIfActive("selectleave",t)},_onClick:function(t){this._fireIfActive("click",t)},_fireIfActive:function(t,e){this.data.active&&this.fire(t,e)},_updateVisualState:function(t){var e=this._visualState,i=this._determineVisualState();if((e!==i||t)&&this.enabled)switch(this._visualState=i,e===jc.HOVER&&this._fireIfActive("hoverend"),e===jc.PRESSED&&this._fireIfActive("pressedend"),i===jc.HOVER&&this._fireIfActive("hoverstart"),i===jc.PRESSED&&this._fireIfActive("pressedstart"),this.transitionMode){case Vc:this._applyTint(this[Gc[this._visualState]]);break;case 1:this._applySprite(this[Hc[this._visualState]],this[Wc[this._visualState]])}},_forceReapplyVisualState:function(){this._updateVisualState(!0)},_resetToDefaultVisualState:function(t){if(this._imageReference.hasComponent("element"))switch(t){case Vc:this._cancelTween(),this._applyTintImmediately(this._defaultTint);break;case 1:this._applySprite(this._defaultSpriteAsset,this._defaultSpriteFrame)}},_determineVisualState:function(){return this.active?this._isPressed?jc.PRESSED:this._isHovering?jc.HOVER:jc.DEFAULT:jc.INACTIVE},_applySprite:function(t,e){e=e||0,this._imageReference.hasComponent("element")&&(this._isApplyingSprite=!0,this._imageReference.entity.element.spriteAsset=t,this._imageReference.entity.element.spriteFrame=e,this._isApplyingSprite=!1)},_applyTint:function(t){this._cancelTween(),0===this.fadeDuration?this._applyTintImmediately(t):this._applyTintWithTween(t)},_applyTintImmediately:function(t){this._imageReference.hasComponent("element")&&t&&(this._isApplyingTint=!0,this._imageReference.entity.element.color=new o(t.r,t.g,t.b),this._imageReference.entity.element.opacity=t.a,this._isApplyingTint=!1)},_applyTintWithTween:function(t){if(this._imageReference.hasComponent("element")&&t){var e=this._imageReference.entity.element.color,i=this._imageReference.entity.element.opacity;this._tweenInfo={startTime:ha(),from:new o(e.r,e.g,e.b,i),to:t.clone(),lerpColor:new o}}},_updateTintTween:function(){var t=ha()-this._tweenInfo.startTime;if(t=0===this.fadeDuration?1:t/this.fadeDuration,t=oa.clamp(t,0,1),1e-5<Math.abs(t-1)){var e=this._tweenInfo.lerpColor;e.lerp(this._tweenInfo.from,this._tweenInfo.to,t),this._applyTintImmediately(new o(e.r,e.g,e.b,e.a))}else this._applyTintImmediately(this._tweenInfo.to),this._cancelTween()},_cancelTween:function(){delete this._tweenInfo},onUpdate:function(){this._tweenInfo&&this._updateTintTween()},onEnable:function(){this._isHovering=!1,this._hoveringCounter=0,this._isPressed=!1,this._imageReference.onParentComponentEnable(),this._toggleHitElementListeners("on"),this._forceReapplyVisualState()},onDisable:function(){this._toggleHitElementListeners("off"),this._resetToDefaultVisualState(this.transitionMode)},onRemove:function(){this._toggleLifecycleListeners("off",this.system),this.onDisable()}});var Xc,qc=["enabled","active",{name:"imageEntity",type:"entity"},{name:"hitPadding",type:"vec4"},"transitionMode",{name:"hoverTint",type:"rgba"},{name:"pressedTint",type:"rgba"},{name:"inactiveTint",type:"rgba"},"fadeDuration","hoverSpriteAsset","hoverSpriteFrame","pressedSpriteAsset","pressedSpriteFrame","inactiveSpriteAsset","inactiveSpriteFrame"];Os.prototype=Object.create(os.prototype),Os.prototype.constructor=Os,as._buildAccessors(Cs.prototype,qc),Object.assign(Os.prototype,{initializeComponentData:function(t,e,i){os.prototype.initializeComponentData.call(this,t,e,qc)},onUpdate:function(t){for(var e in t=this.store){var i=t[e].entity,s=i.button;s.enabled&&i.enabled&&s.onUpdate()}},_onRemoveComponent:function(t,e){e.onRemove()}}),Object.assign(Rs.prototype,{_createOffscreenTarget:function(t,e){var i=this.camera.rect,s=Math.floor(i.z*this.app.graphicsDevice.width*this.renderTargetScale);i=Math.floor(i.w*this.app.graphicsDevice.height*this.renderTargetScale);var n=this.app.graphicsDevice,r=e?n.getHdrFormat():7;e=this.app.graphicsDevice.supportsStencil;var a=t?n.samples:1;return(s=new nt(n,{format:r,width:s,height:i})).name="posteffect #"+this.effects.length,s.minFilter=0,s.magFilter=0,s.addressU=1,s.addressV=1,new gp(this.app.graphicsDevice,s,{depth:t,stencil:e,samples:a})},_resizeOffscreenTarget:function(t){var e=this.camera.rect,i=Math.floor(e.z*this.app.graphicsDevice.width*this.renderTargetScale);e=Math.floor(e.w*this.app.graphicsDevice.height*this.renderTargetScale);var s=this.app.graphicsDevice,n=t.colorBuffer.format;t._colorBuffer.destroy(),(i=new nt(s,{format:n,width:i,height:e})).name="posteffect",i.minFilter=0,i.magFilter=0,i.addressU=1,i.addressV=1,t._colorBuffer=i,t.destroy()},_destroyOffscreenTarget:function(t){t._colorBuffer&&t._colorBuffer.destroy(),t._depthBuffer&&t._depthBuffer.destroy(),t.destroy()},setRenderTargetScale:function(t){this.renderTargetScale=t,this.resizeRenderTargets()},addEffect:function(t){var e=this.effects,i={effect:t,inputTarget:this._createOffscreenTarget(0===this.effects.length,t.hdr),outputTarget:null};if(!this.layer){this.layer=new It({opaqueSortMode:0,transparentSortMode:0,passThrough:!0,name:"PostEffectQueue",renderTarget:this.camera.renderTarget,clear:!1,onPostRender:function(){for(var t=0;t<this._commandList.length;t++)this._commandList[t]()}});var s,n=this.app.scene.layers.layerList,r=0,a=n.length-1;for(s=a;0<=s;s--)if(4===n[s].id){a=s-1,this._origOverrideClear=n[s].overrideClear,this._origClearColorBuffer=n[s].clearColorBuffer,this._origDepthColorBuffer=n[s].clearDepthBuffer,this._origStencilColorBuffer=n[s].clearStencilBuffer,n[s].overrideClear=!0,n[s].clearColorBuffer=!1,n[s].clearDepthBuffer=this.camera.clearDepthBuffer,n[s].clearStencilBuffer=this.camera.clearStencilBuffer;break}for(this._sourceLayers=[],s=0;s<this.camera.layers.length;s++){n=this.camera.layers[s];var o=this.app.scene.layers.getLayerById(n),h=this.app.scene.layers.layerList.indexOf(o);h<=a&&(1!=n&&(o.renderTarget=i.inputTarget,this._sourceLayers.push(o)),h>r&&(r=h))}this.app.scene.layers.insertOpaque(this.layer,r+1),this._sourceTarget=i.inputTarget,this.layer._commandList=[],this.layer.isPostEffect=!0}e.push(i),1<(r=e.length)&&(e[r-2].outputTarget=i.inputTarget),this._newPostEffect=t,t.needsDepthBuffer&&this._requestDepthMap(),this.enable(),this._newPostEffect=void 0},removeEffect:function(t){var e,i=-1,s=0;for(e=this.effects.length;s<e;s++)if(this.effects[s].effect===t){i=s;break}if(0<=i){if(0<i)this.effects[i-1].outputTarget=i+1<this.effects.length?this.effects[i+1].inputTarget:null;else if(1<this.effects.length)for(this.effects[1].inputTarget._depth||(this._destroyOffscreenTarget(this.effects[1].inputTarget),this.effects[1].inputTarget=this._createOffscreenTarget(!0,this.effects[1].hdr),this._sourceTarget=this.effects[1].inputTarget),s=0;s<this._sourceLayers.length;s++)this._sourceLayers[s].renderTarget=this.effects[1].inputTarget;this._destroyOffscreenTarget(this.effects[i].inputTarget),this.effects.splice(i,1)}this.enabled&&t.needsDepthBuffer&&this._releaseDepthMap(),0===this.effects.length&&this.disable()},_requestDepthMaps:function(){for(var t=0,e=this.effects.length;t<e;t++){var i=this.effects[t].effect;this._newPostEffect!==i&&i.needsDepthBuffer&&this._requestDepthMap()}},_releaseDepthMaps:function(){for(var t=0,e=this.effects.length;t<e;t++)this.effects[t].effect.needsDepthBuffer&&this._releaseDepthMap()},_requestDepthMap:function(){Xc||(Xc=this.app.scene.layers.getLayerById(1)),Xc&&Xc.incrementCounter()},_releaseDepthMap:function(){Xc&&Xc.decrementCounter()},destroy:function(){for(var t=0,e=this.effects.length;t<e;t++)this.effects[t].inputTarget.destroy();this.effects.length=0,this.disable()},enable:function(){if(!this.enabled&&this.effects.length){this.enabled=!0;var t=this;this._requestDepthMaps(),this.app.graphicsDevice.on("resizecanvas",this._onCanvasResized,this),this.command=function(){if(t.enabled){var e=null,i=t.effects.length;if(i){t.layer.renderTarget=t.effects[0].inputTarget;for(var s=0;s<i;s++){var n=t.effects[s];s===i-1&&(e=t.camera.rect),n.effect.render(n.inputTarget,n.outputTarget,e)}}}},this.layer._commandList.push(this.command)}},disable:function(){if(this.enabled){this.enabled=!1,this.app.graphicsDevice.off("resizecanvas",this._onCanvasResized,this),this._releaseDepthMaps(),this._destroyOffscreenTarget(this._sourceTarget);var t=this.layer._commandList.indexOf(this.command);0<=t&&this.layer._commandList.splice(t,1);var e=this.app.scene.layers.layerList,i=e.length-1;for(t=0;t<=e.length;t++)if(4===e[t].id){i=t-1,e[t].overrideClear=this._origOverrideClear,e[t].clearColorBuffer=this._origClearColorBuffer,e[t].clearDepthBuffer=this._origDepthColorBuffer,e[t].clearStencilBuffer=this._origStencilColorBuffer;break}for(t=i;0<=t;t--)0<=e[t].cameras.indexOf(this.camera)&&(e[t].renderTarget=void 0);this.app.scene.layers.removeOpaque(this.layer),this.layer=null}},_onCanvasResized:function(t,e){t=this.camera.rect,e=this.app.graphicsDevice,this.camera.camera.aspectRatio=e.width*t.z/(e.height*t.w),this.resizeTimeout||(100<ha()-this.resizeLast?this.resizeRenderTargets():this.resizeTimeout=setTimeout(this._resizeTimeoutCallback,100))},resizeRenderTargets:function(){this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.resizeLast=ha();var t=this.camera.rect,e=Math.floor(t.z*this.app.graphicsDevice.width*this.renderTargetScale);t=Math.floor(t.w*this.app.graphicsDevice.height*this.renderTargetScale);for(var i=this.effects,s=0,n=i.length;s<n;s++){var r=i[s];r.inputTarget.width===e&&r.inputTarget.height===t||this._resizeOffscreenTarget(r.inputTarget)}},onCameraRectChanged:function(t,e,i){this.enabled&&this.resizeRenderTargets()}});var Yc=function(t,e){as.call(this,t,e),this._camera=new wt,this._camera.node=e,this._priority=0,this._postEffects=new Rs(t.app,this)};(Yc.prototype=Object.create(as.prototype)).constructor=Yc,[{name:"aspectRatio",readonly:!1},{name:"aspectRatioMode",readonly:!1},{name:"calculateProjection",readonly:!1},{name:"calculateTransform",readonly:!1},{name:"clearColor",readonly:!1},{name:"clearColorBuffer",readonly:!1},{name:"clearDepthBuffer",readonly:!1},{name:"clearStencilBuffer",readonly:!1},{name:"cullFaces",readonly:!1},{name:"farClip",readonly:!1},{name:"flipFaces",readonly:!1},{name:"fov",readonly:!1},{name:"frustum",readonly:!0},{name:"frustumCulling",readonly:!1},{name:"horizontalFov",readonly:!1},{name:"nearClip",readonly:!1},{name:"orthoHeight",readonly:!1},{name:"projection",readonly:!1},{name:"projectionMatrix",readonly:!0},{name:"rect",readonly:!1},{name:"renderTarget",readonly:!1},{name:"scissorRect",readonly:!1},{name:"viewMatrix",readonly:!0},{name:"vrDisplay",readonly:!1}].forEach(function(t){var e=t.name,i={get:function(){return this._camera[e]}};t.readonly||(i.set=function(t){this._camera[e]=t}),Object.defineProperty(Yc.prototype,e,i)}),Object.defineProperty(Yc.prototype,"camera",{get:function(){return this._camera}}),Object.defineProperty(Yc.prototype,"layers",{get:function(){return this._camera.layers},set:function(t){var e,i,s=this._camera.layers;for(e=0;e<s.length;e++)(i=this.system.app.scene.layers.getLayerById(s[e]))&&i.removeCamera(this);if(this._camera.layers=t,this.enabled&&this.entity.enabled)for(e=0;e<t.length;e++)(i=this.system.app.scene.layers.getLayerById(t[e]))&&i.addCamera(this)}}),Object.defineProperty(Yc.prototype,"postEffects",{get:function(){return this._postEffects}}),Object.defineProperty(Yc.prototype,"priority",{get:function(){return this._priority},set:function(t){this._priority=t,t=this.layers;for(var e=0;e<t.length;e++){var i=this.system.app.scene.layers.getLayerById(t[e]);i&&i._sortCameras()}}}),Object.assign(Yc.prototype,{screenToWorld:function(t,e,i,s){var n=this.system.app.graphicsDevice;return this._camera.screenToWorld(t,e,i,n.clientRect.width,n.clientRect.height,s)},worldToScreen:function(t,e){var i=this.system.app.graphicsDevice;return this._camera.worldToScreen(t,i.clientRect.width,i.clientRect.height,e)},onPrerender:function(){this._camera._viewMatDirty=!0,this._camera._viewProjMatDirty=!0},addCameraToLayers:function(){for(var t=this.layers,e=0;e<t.length;e++){var i=this.system.app.scene.layers.getLayerById(t[e]);i&&i.addCamera(this)}},removeCameraFromLayers:function(){for(var t=this.layers,e=0;e<t.length;e++){var i=this.system.app.scene.layers.getLayerById(t[e]);i&&i.removeCamera(this)}},onLayersChanged:function(t,e){this.addCameraToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(t){0>this.layers.indexOf(t.id)||t.addCamera(this)},onLayerRemoved:function(t){0>this.layers.indexOf(t.id)||t.removeCamera(this)},onEnable:function(){var t=this.system,e=t.app.scene,i=e.layers;t.addCamera(this),e.on("set:layers",this.onLayersChanged,this),i&&(i.on("add",this.onLayerAdded,this),i.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addCameraToLayers(),this.postEffects.enable()},onDisable:function(){var t=this.system,e=t.app.scene,i=e.layers;this.postEffects.disable(),this.removeCameraFromLayers(),e.off("set:layers",this.onLayersChanged,this),i&&(i.off("add",this.onLayerAdded,this),i.off("remove",this.onLayerRemoved,this)),t.removeCamera(this)},onRemove:function(){this.onDisable(),this.off()},calculateAspectRatio:function(t){t=t||this.system.app.graphicsDevice;var e=this.rect;return t.width*e.z/(t.height*e.w)},frameBegin:function(t){0===this.aspectRatioMode&&(this.aspectRatio=this.calculateAspectRatio(t))},frameEnd:function(){},enterVr:function(t,e){if(t instanceof Function&&!e&&(e=t,t=null),this.system.app.vr)if(t||(t=this.system.app.vr.display),t){var i=this;t.capabilities.canPresent?t.requestPresent(function(s){s||(i.vrDisplay=t,i.vrDisplay.once("beforepresentchange",function(t){t.presenting||(i.vrDisplay=null)})),e(s)}):(i.vrDisplay=t,e())}else e("No pc.VrDisplay to present");else e("VrManager not created. Enable VR in project settings.")},exitVr:function(t){if(this.vrDisplay)if(this.vrDisplay.capabilities.canPresent){var e=this.vrDisplay;this.vrDisplay=null,e.exitPresent(t)}else this.vrDisplay=null,t();else t("Not presenting VR")},startXr:function(t,e,i){this.system.app.xr.start(this,t,e,i)},endXr:function(t){this._camera.xr?this._camera.xr.end(t):t&&t(Error("Camera is not in XR"))}});var Kc=["enabled"],$c=function(t){os.call(this,t),this.id="camera",this.ComponentType=Yc,this.DataType=Ds,this.schema=Kc,this.cameras=[],this.on("beforeremove",this.onBeforeRemove,this),this.app.on("prerender",this.onPrerender,this),os.bind("update",this.onUpdate,this)};$c.prototype=Object.create(os.prototype),$c.prototype.constructor=$c,as._buildAccessors(Yc.prototype,Kc),Object.assign($c.prototype,{initializeComponentData:function(t,e,i){i="aspectRatio aspectRatioMode calculateProjection calculateTransform clearColor clearColorBuffer clearDepthBuffer clearStencilBuffer cullFaces farClip flipFaces fov frustumCulling horizontalFov layers renderTarget nearClip orthoHeight projection priority rect scissorRect".split(" ");for(var s=0;s<i.length;s++){var n=i[s];if(e.hasOwnProperty(n)){var r=e[n];switch(n){case"rect":case"scissorRect":Array.isArray(r)?t[n]=new b(r[0],r[1],r[2],r[3]):t[n]=r;break;case"clearColor":Array.isArray(r)?t[n]=new o(r[0],r[1],r[2],r[3]):t[n]=r;break;default:t[n]=r}}}os.prototype.initializeComponentData.call(this,t,e,["enabled"])},cloneComponent:function(t,e){t=t.camera,this.addComponent(e,{aspectRatio:t.aspectRatio,aspectRatioMode:t.aspectRatioMode,calculateProjection:t.calculateProjection,calculateTransform:t.calculateTransform,clearColor:t.clearColor,clearColorBuffer:t.clearColorBuffer,clearDepthBuffer:t.clearDepthBuffer,clearStencilBuffer:t.clearStencilBuffer,cullFaces:t.cullFaces,farClip:t.farClip,flipFaces:t.flipFaces,fov:t.fov,frustumCulling:t.frustumCulling,horizontalFov:t.horizontalFov,layers:t.layers,renderTarget:t.renderTarget,nearClip:t.nearClip,orthoHeight:t.orthoHeight,projection:t.projection,priority:t.priority,rect:t.rect,scissorRect:t.scissorRect})},onBeforeRemove:function(t,e){this.removeCamera(e)},onUpdate:function(t){if(this.app.vr)for(var e in t=this.store){var i=t[e];if(i.enabled&&i.entity.enabled){var s=i.vrDisplay;s&&(s.setClipPlanes(i.nearClip,i.farClip),i.entity&&(i.entity.localTransform.copy(s.combinedViewInv),i.entity._dirtyLocal=!1,i.entity._dirtifyWorld()))}}},onPrerender:function(){for(var t=0,e=this.cameras.length;t<e;t++)this.cameras[t].onPrerender()},addCamera:function(t){this.cameras.push(t),this.sortCamerasByPriority()},removeCamera:function(t){0<=(t=this.cameras.indexOf(t))&&(this.cameras.splice(t,1),this.sortCamerasByPriority())},sortCamerasByPriority:function(){this.cameras.sort(function(t,e){return t.priority-e.priority})}});var Zc=function(t,e){as.call(this,t,e),this._compoundParent=null,this.entity.on("insert",this._onInsert,this),this.on("set_type",this.onSetType,this),this.on("set_halfExtents",this.onSetHalfExtents,this),this.on("set_radius",this.onSetRadius,this),this.on("set_height",this.onSetHeight,this),this.on("set_axis",this.onSetAxis,this),this.on("set_asset",this.onSetAsset,this),this.on("set_model",this.onSetModel,this)};(Zc.prototype=Object.create(as.prototype)).constructor=Zc,Object.assign(Zc.prototype,{onSetType:function(t,e,i){e!==i&&this.system.changeType(this,e,i)},onSetHalfExtents:function(t,e,i){t=this.data.type,this.data.initialized&&"box"===t&&this.system.recreatePhysicalShapes(this)},onSetRadius:function(t,e,i){t=this.data.type,!this.data.initialized||"sphere"!==t&&"capsule"!==t&&"cylinder"!==t&&"cone"!==t||this.system.recreatePhysicalShapes(this)},onSetHeight:function(t,e,i){t=this.data.type,!this.data.initialized||"capsule"!==t&&"cylinder"!==t&&"cone"!==t||this.system.recreatePhysicalShapes(this)},onSetAxis:function(t,e,i){t=this.data.type,!this.data.initialized||"capsule"!==t&&"cylinder"!==t&&"cone"!==t||this.system.recreatePhysicalShapes(this)},onSetAsset:function(t,e,i){t=this.system.app.assets,e&&(e=t.get(e))&&e.off("remove",this.onAssetRemoved,this),i&&(i instanceof Fe&&(this.data.asset=i.id),e=t.get(this.data.asset))&&(e.off("remove",this.onAssetRemoved,this),e.on("remove",this.onAssetRemoved,this)),this.data.initialized&&"mesh"===this.data.type&&(i||(this.data.model=null),this.system.recreatePhysicalShapes(this))},onSetModel:function(t,e,i){this.data.initialized&&"mesh"===this.data.type&&this.system.implementations.mesh.doRecreatePhysicalShape(this)},onAssetRemoved:function(t){t.off("remove",this.onAssetRemoved,this),this.data.asset===t.id&&(this.asset=null)},_getCompoundChildShapeIndex:function(t){for(var e=this.data.shape,i=e.getNumChildShapes(),s=0;s<i;s++)if(e.getChildShape(s).ptr===t.ptr)return s;return null},_onInsert:function(t){if("undefined"!=typeof Ammo)if(this._compoundParent)this.system.recreatePhysicalShapes(this);else if(!this.entity.rigidbody)for(t=this.entity.parent;t;){if(t.collision&&"compound"===t.collision.type){0===t.collision.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t.collision):this.system.recreatePhysicalShapes(this);break}t=t.parent}},_updateCompound:function(){var t=this.entity;if(t._dirtyWorld){for(var e=t._dirtyLocal,i=t;i&&!e&&(!i.collision||i.collision!==this._compoundParent);)i._dirtyLocal&&(e=!0),i=i.parent;e&&(t.forEach(this.system.implementations.compound._updateEachDescendantTransform,t),(t=this._compoundParent.entity.rigidbody)&&t.activate())}},onEnable:function(){if("mesh"===this.data.type&&this.data.asset&&this.data.initialized){var t=this.system.app.assets.get(this.data.asset);if(t&&(!t.resource||!this.data.shape))return void this.system.recreatePhysicalShapes(this)}this.entity.rigidbody?this.entity.rigidbody.enabled&&this.entity.rigidbody.enableSimulation():this._compoundParent&&this!==this._compoundParent?0===this._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(this._compoundParent):(t=this.system._getNodeTransform(this.entity,this._compoundParent.entity),this._compoundParent.shape.addChildShape(t,this.data.shape),Ammo.destroy(t),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.enable()},onDisable:function(){this.entity.rigidbody?this.entity.rigidbody.disableSimulation():this._compoundParent&&this!==this._compoundParent?this._compoundParent.entity._destroying||(this.system._removeCompoundChild(this._compoundParent,this.data.shape),this._compoundParent.entity.rigidbody&&this._compoundParent.entity.rigidbody.activate()):this.entity.trigger&&this.entity.trigger.disable()},onBeforeRemove:function(){this.entity.off("insert",this._onInsert,this)}});var Qc,Jc,td,ed="static",id=2,sd=65533;Object.assign(Fs.prototype,{initialize:function(t){var e=this.entity;if((t=t.shape)&&"undefined"!=typeof Ammo){e.trigger&&e.trigger.destroy();var i=e.getPosition(),s=e.getRotation();Qc.setValue(i.x,i.y,i.z),Jc.setValue(s.x,s.y,s.z,s.w),td.setOrigin(Qc),td.setRotation(Jc),(t=this.app.systems.rigidbody.createBody(1,t,td)).setRestitution(0),t.setFriction(0),t.setDamping(0,0),Qc.setValue(0,0,0),t.setLinearFactor(Qc),t.setAngularFactor(Qc),t.setCollisionFlags(4|t.getCollisionFlags()),t.entity=e,this.body=t,this.component.enabled&&e.enabled&&this.enable()}},destroy:function(){var t=this.body;t&&(this.disable(),this.app.systems.rigidbody.destroyBody(t))},_getEntityTransform:function(t){var e=this.entity.getPosition(),i=this.entity.getRotation();Qc.setValue(e.x,e.y,e.z),Jc.setValue(i.x,i.y,i.z,i.w),t.setOrigin(Qc),t.setRotation(Jc)},updateTransform:function(){this._getEntityTransform(td);var t=this.body;t.setWorldTransform(td),t.activate()},enable:function(){var t=this.body;if(t){var e=this.app.systems;e.rigidbody.addBody(t,16,16^sd),e.rigidbody._triggers.push(this),t.forceActivationState(1),this.updateTransform()}},disable:function(){var t=this.body;if(t){var e=this.app.systems,i=e.rigidbody._triggers.indexOf(this);-1<i&&e.rigidbody._triggers.splice(i,1),e.rigidbody.removeBody(t),t.forceActivationState(5)}}});var nd=new x,rd=new v,ad=new S,od="enabled type halfExtents radius axis height asset shape model".split(" "),hd=function(t){this.system=t};Object.assign(hd.prototype,{beforeInitialize:function(t,e){e.shape=null,e.model=new mt,e.model.graph=new Mt},afterInitialize:function(t,e){this.recreatePhysicalShapes(t),t.data.initialized=!0},reset:function(t,e){this.beforeInitialize(t,e),this.afterInitialize(t,e)},recreatePhysicalShapes:function(t){var e=t.entity,i=t.data;if("undefined"!=typeof Ammo){e.trigger&&(e.trigger.destroy(),delete e.trigger),i.shape&&(t._compoundParent&&(this.system._removeCompoundChild(t._compoundParent,i.shape),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate()),Ammo.destroy(i.shape),i.shape=null),i.shape=this.createPhysicalShape(t.entity,i);var s=!t._compoundParent;if("compound"!==i.type||t._compoundParent&&t!==t._compoundParent){if("compound"!==i.type&&(t._compoundParent&&t===t._compoundParent&&e.forEach(this.system.implementations.compound._updateEachDescendant,t),!t.rigidbody)){t._compoundParent=null;for(var n=e.parent;n;){if(n.collision&&"compound"===n.collision.type){t._compoundParent=n.collision;break}n=n.parent}}}else t._compoundParent=t,e.forEach(this._addEachDescendant,t);t._compoundParent&&t!==t._compoundParent&&(s&&0===t._compoundParent.shape.getNumChildShapes()?this.system.recreatePhysicalShapes(t._compoundParent):(this.system.updateCompoundChildTransform(e),t._compoundParent.entity.rigidbody&&t._compoundParent.entity.rigidbody.activate())),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):t._compoundParent||(e.trigger?e.trigger.initialize(i):e.trigger=new Fs(this.system.app,t,i))}},createPhysicalShape:function(t,e){},updateTransform:function(t,e,i,s){t.entity.trigger&&t.entity.trigger.updateTransform()},beforeRemove:function(t,e){e.data.shape&&(e._compoundParent&&!e._compoundParent.entity._destroying&&(this.system._removeCompoundChild(e._compoundParent,e.data.shape),e._compoundParent.entity.rigidbody&&e._compoundParent.entity.rigidbody.activate()),e._compoundParent=null,Ammo.destroy(e.data.shape),e.data.shape=null)},remove:function(t,e){var i=this.system.app;t.rigidbody&&t.rigidbody.body&&(i.systems.rigidbody.removeBody(t.rigidbody.body),t.rigidbody.disableSimulation()),t.trigger&&(t.trigger.destroy(),delete t.trigger),i.scene.containsModel(e.model)&&(i.root.removeChild(e.model.graph),i.scene.removeModel(e.model))},clone:function(t,e){return t=this.system.store[t.getGuid()],this.system.addComponent(e,{enabled:t.data.enabled,type:t.data.type,halfExtents:[t.data.halfExtents.x,t.data.halfExtents.y,t.data.halfExtents.z],radius:t.data.radius,axis:t.data.axis,height:t.data.height,asset:t.data.asset,model:t.data.model})}});var ld=function(t){this.system=t};(ld.prototype=Object.create(hd.prototype)).constructor=ld,Object.assign(ld.prototype,{createPhysicalShape:function(t,e){if("undefined"!=typeof Ammo)return t=e.halfExtents,t=new Ammo.btVector3(t?t.x:.5,t?t.y:.5,t?t.z:.5),e=new Ammo.btBoxShape(t),Ammo.destroy(t),e}});var cd=function(t){this.system=t};(cd.prototype=Object.create(hd.prototype)).constructor=cd,Object.assign(cd.prototype,{createPhysicalShape:function(t,e){if("undefined"!=typeof Ammo)return new Ammo.btSphereShape(e.radius)}});var dd=function(t){this.system=t};(dd.prototype=Object.create(hd.prototype)).constructor=dd,Object.assign(dd.prototype,{createPhysicalShape:function(t,e){t=null;var i=void 0!==e.axis?e.axis:1,s=e.radius||.5;if(e=Math.max((e.height||2)-2*s,0),"undefined"!=typeof Ammo)switch(i){case 0:t=new Ammo.btCapsuleShapeX(s,e);break;case 1:t=new Ammo.btCapsuleShape(s,e);break;case 2:t=new Ammo.btCapsuleShapeZ(s,e)}return t}});var ud=function(t){this.system=t};(ud.prototype=Object.create(hd.prototype)).constructor=ud,Object.assign(ud.prototype,{createPhysicalShape:function(t,e){var i=t=null,s=void 0!==e.axis?e.axis:1,n=void 0!==e.radius?e.radius:.5;if(e=void 0!==e.height?e.height:1,"undefined"!=typeof Ammo)switch(s){case 0:t=new Ammo.btVector3(.5*e,n,n),i=new Ammo.btCylinderShapeX(t);break;case 1:t=new Ammo.btVector3(n,.5*e,n),i=new Ammo.btCylinderShape(t);break;case 2:t=new Ammo.btVector3(n,n,.5*e),i=new Ammo.btCylinderShapeZ(t)}return t&&Ammo.destroy(t),i}});var pd=function(t){this.system=t};(pd.prototype=Object.create(hd.prototype)).constructor=pd,Object.assign(pd.prototype,{createPhysicalShape:function(t,e){t=null;var i=void 0!==e.axis?e.axis:1,s=void 0!==e.radius?e.radius:.5;if(e=void 0!==e.height?e.height:1,"undefined"!=typeof Ammo)switch(i){case 0:t=new Ammo.btConeShapeX(s,e);break;case 1:t=new Ammo.btConeShape(s,e);break;case 2:t=new Ammo.btConeShapeZ(s,e)}return t}});var fd=function(t){this.system=t};(fd.prototype=Object.create(hd.prototype)).constructor=fd,Object.assign(fd.prototype,{beforeInitialize:function(t,e){},createPhysicalShape:function(t,e){if("undefined"!=typeof Ammo&&e.model){var i,s,n=e.model;for(e=new Ammo.btCompoundShape,i=0;i<n.meshInstances.length;i++){var r=n.meshInstances[i],a=r.mesh;if(this.system._triMeshCache[a.id])var o=this.system._triMeshCache[a.id];else{o=a.indexBuffer[0];var h,l=a.vertexBuffer,c=l.getFormat(),d=c.size/4;for(s=0;s<c.elements.length;s++){var u=c.elements[s];"POSITION"===u.name&&(h=new Float32Array(l.lock(),u.offset))}l=new Uint16Array(o.lock()),c=a.primitive[0].count/3,u=new Ammo.btVector3;var p=new Ammo.btVector3,f=new Ammo.btVector3,m=a.primitive[0].base;for(o=new Ammo.btTriangleMesh,this.system._triMeshCache[a.id]=o,s=0;s<c;s++){a=l[m+3*s]*d;var _=l[m+3*s+1]*d,g=l[m+3*s+2]*d;u.setValue(h[a],h[a+1],h[a+2]),p.setValue(h[_],h[_+1],h[_+2]),f.setValue(h[g],h[g+1],h[g+2]),o.addTriangle(u,p,f,!0)}Ammo.destroy(u),Ammo.destroy(p),Ammo.destroy(f)}s=new Ammo.btBvhTriangleMeshShape(o,!0),d=this.system._getNodeScaling(r.node),s.setLocalScaling(d),Ammo.destroy(d),r=this.system._getNodeTransform(r.node),e.addChildShape(r,s),Ammo.destroy(r)}return t=t.getWorldTransform().getScale(),t=new Ammo.btVector3(t.x,t.y,t.z),e.setLocalScaling(t),Ammo.destroy(t),e}},recreatePhysicalShapes:function(t){null!==t.data.asset&&t.enabled&&t.entity.enabled?this.loadModelAsset(t):this.doRecreatePhysicalShape(t)},loadModelAsset:function(t){var e=this,i=t.data.asset,s=t.data,n=this.system.app.assets,r=n.get(i);r?(r.ready(function(i){s.model=i.resource,e.doRecreatePhysicalShape(t)}),n.load(r)):n.once("add:"+i,function(i){i.ready(function(i){s.model=i.resource,e.doRecreatePhysicalShape(t)}),n.load(i)})},doRecreatePhysicalShape:function(t){var e=t.entity,i=t.data;i.model?(this.destroyShape(i),i.shape=this.createPhysicalShape(e,i),e.rigidbody?(e.rigidbody.disableSimulation(),e.rigidbody.createBody(),e.enabled&&e.rigidbody.enabled&&e.rigidbody.enableSimulation()):e.trigger?e.trigger.initialize(i):e.trigger=new Fs(this.system.app,t,i)):(this.beforeRemove(e,t),this.remove(e,i))},updateTransform:function(t,e,i,s){if(t.shape){var n=t.entity.getWorldTransform().getScale(),r=t.shape.getLocalScaling();n.x===r.x()&&n.y===r.y()&&n.z===r.z()||this.doRecreatePhysicalShape(t)}hd.prototype.updateTransform.call(this,t,e,i,s)},destroyShape:function(t){if(t.shape){for(var e=t.shape.getNumChildShapes(),i=0;i<e;i++){var s=t.shape.getChildShape(i);Ammo.destroy(s)}Ammo.destroy(t.shape),t.shape=null}},remove:function(t,e){this.destroyShape(e),hd.prototype.remove.call(this,t,e)}});var md=function(t){this.system=t};(md.prototype=Object.create(hd.prototype)).constructor=md,Object.assign(md.prototype,{createPhysicalShape:function(t,e){if("undefined"!=typeof Ammo)return new Ammo.btCompoundShape},_addEachDescendant:function(t){t.collision&&!t.rigidbody&&(t.collision._compoundParent=this,t!==this.entity&&t.collision.system.recreatePhysicalShapes(t.collision))},_updateEachDescendant:function(t){t.collision&&t.collision._compoundParent===this&&(t.collision._compoundParent=null,t===this.entity||t.rigidbody||t.collision.system.recreatePhysicalShapes(t.collision))},_updateEachDescendantTransform:function(t){t.collision&&t.collision._compoundParent===this.collision._compoundParent&&this.collision.system.updateCompoundChildTransform(t)}});var _d=function(t){os.call(this,t),this.id="collision",this.ComponentType=Zc,this.DataType=Ls,this.schema=od,this.implementations={},this._triMeshCache={},this.on("beforeremove",this.onBeforeRemove,this),this.on("remove",this.onRemove,this)};_d.prototype=Object.create(os.prototype),_d.prototype.constructor=_d,as._buildAccessors(Zc.prototype,od),Object.assign(_d.prototype,{initializeComponentData:function(t,e,i){for(var s={},n=0,r=(i="type halfExtents radius axis height shape model asset enabled".split(" ")).length;n<r;n++){var a=i[n];s[a]=e[a]}e.hasOwnProperty("asset")?-1!==(e=i.indexOf("model"))&&i.splice(e,1):e.hasOwnProperty("model")&&(-1!==(e=i.indexOf("asset"))&&i.splice(e,1)),s.type||(s.type=t.data.type),t.data.type=s.type,s.halfExtents&&Array.isArray(s.halfExtents)&&(s.halfExtents=new v(s.halfExtents[0],s.halfExtents[1],s.halfExtents[2])),(e=this._createImplementation(s.type)).beforeInitialize(t,s),os.prototype.initializeComponentData.call(this.system,t,s,i),e.afterInitialize(t,s)},_createImplementation:function(t){if(void 0===this.implementations[t]){switch(t){case"box":var e=new ld(this);break;case"sphere":e=new cd(this);break;case"capsule":e=new dd(this);break;case"cylinder":e=new ud(this);break;case"cone":e=new pd(this);break;case"mesh":e=new fd(this);break;case"compound":e=new md(this)}this.implementations[t]=e}return this.implementations[t]},_getImplementation:function(t){return this.implementations[t.collision.data.type]},cloneComponent:function(t,e){return this._getImplementation(t).clone(t,e)},onBeforeRemove:function(t,e){this.implementations[e.data.type].beforeRemove(t,e),e.onBeforeRemove()},onRemove:function(t,e){this.implementations[e.type].remove(t,e)},updateCompoundChildTransform:function(t){if(this._removeCompoundChild(t.collision._compoundParent,t.collision.data.shape),t.enabled&&t.collision.enabled){var e=this._getNodeTransform(t,t.collision._compoundParent.entity);t.collision._compoundParent.shape.addChildShape(e,t.collision.data.shape),Ammo.destroy(e)}},_removeCompoundChild:function(t,e){t.shape.removeChildShape?t.shape.removeChildShape(e):null!==(e=t._getCompoundChildShapeIndex(e))&&t.shape.removeChildShapeByIndex(e)},onTransformChanged:function(t,e,i,s){this.implementations[t.data.type].updateTransform(t,e,i,s)},changeType:function(t,e,i){this.implementations[e].beforeRemove(t.entity,t),this.implementations[e].remove(t.entity,t.data),this._createImplementation(i).reset(t,t.data)},recreatePhysicalShapes:function(t){this.implementations[t.data.type].recreatePhysicalShapes(t)},_calculateNodeRelativeTransform:function(t,e){t===e?(t=t.getWorldTransform().getScale(),nd.setScale(t.x,t.y,t.z)):(this._calculateNodeRelativeTransform(t.parent,e),nd.mul(t.getLocalTransform()))},_getNodeScaling:function(t){return t=t.getWorldTransform().getScale(),new Ammo.btVector3(t.x,t.y,t.z)},_getNodeTransform:function(t,e){e?(this._calculateNodeRelativeTransform(t,e),e=rd,t=ad,nd.getTranslation(e),t.setFromMat4(nd)):(e=t.getPosition(),t=t.getRotation());var i=new Ammo.btTransform;i.setIdentity();var s=i.getOrigin();return s.setValue(e.x,e.y,e.z),(e=new Ammo.btQuaternion).setValue(t.x,t.y,t.z,t.w),i.setRotation(e),Ammo.destroy(e),Ammo.destroy(s),i},destroy:function(){for(var t in this._triMeshCache)Ammo.destroy(this._triMeshCache[t]);this._triMeshCache=null,os.prototype.destroy.call(this)}}),Object.assign(Bs.prototype,{add:function(t){var e=t.id;if(this[e])throw Error("ComponentSystem name '"+e+"' already registered or not allowed");this[e]=t,this.list.push(t)},remove:function(t){if(!this[t=t.id])throw Error("No ComponentSystem named '"+t+"' registered");delete this[t],-1!==(t=this.list.indexOf(this[t]))&&this.list.splice(t,1)}});var gd="group";Ns.prototype.clone=function(){return new Ns({func:this.func,ref:this.ref,readMask:this.readMask,writeMask:this.writeMask,fail:this.fail,zfail:this.zfail,zpass:this.zpass})},ks.prototype.destroy=function(){this.setMaterial(null),this._element.removeModelFromLayers(this.model),this.model.destroy(),this._element=this._entity=this.meshInstance=this.mesh=this.node=this.model=null},ks.prototype.setMesh=function(t){this.meshInstance&&(this.mesh=t,this.meshInstance.mesh=t,this.meshInstance.visible=!!t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.mesh=t),this.forceUpdateAabb())},ks.prototype.setMask=function(t){if(this.meshInstance){if(t)for(var e in this.unmaskMeshInstance=new lt(this.node,this.mesh,this.meshInstance.material),this.unmaskMeshInstance.name="Unmask: "+this._entity.name,this.unmaskMeshInstance.castShadow=!1,this.unmaskMeshInstance.receiveShadow=!1,this.unmaskMeshInstance.pick=!1,this.model.meshInstances.push(this.unmaskMeshInstance),this.meshInstance.parameters)this.unmaskMeshInstance.setParameter(e,this.meshInstance.parameters[e].data);else 0<=(t=this.model.meshInstances.indexOf(this.unmaskMeshInstance))&&this.model.meshInstances.splice(t,1),this.unmaskMeshInstance=null;this._entity.enabled&&this._element.enabled&&(this._element.removeModelFromLayers(this.model),this._element.addModelToLayers(this.model))}},ks.prototype.setMaterial=function(t){this.meshInstance&&(this.meshInstance.material=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.material=t))},ks.prototype.setParameter=function(t,e){this.meshInstance&&(this.meshInstance.setParameter(t,e),this.unmaskMeshInstance&&this.unmaskMeshInstance.setParameter(t,e))},ks.prototype.deleteParameter=function(t){this.meshInstance&&(this.meshInstance.deleteParameter(t),this.unmaskMeshInstance&&this.unmaskMeshInstance.deleteParameter(t))},ks.prototype.setUnmaskDrawOrder=function(){if(this.meshInstance){var t=function(e){var i,s=(e=e.children).length;if(s){for(var n=0;n<s;n++)e[n].element&&(i=e[n]);return i?(e=t(i))?e:i:null}return null};if(this.unmaskMeshInstance){var e=t(this._entity);this.unmaskMeshInstance.drawOrder=e&&e.element?e.element.drawOrder+e.element.getMaskOffset():this.meshInstance.drawOrder+this._element.getMaskOffset()}}},ks.prototype.setDrawOrder=function(t){this.meshInstance&&(this.meshInstance.drawOrder=t)},ks.prototype.setCull=function(t){if(this.meshInstance){var e=this._element,i=null;t&&e._isScreenCulled()&&(i=function(t){return e.isVisibleForCamera(t)}),this.meshInstance.cull=t,this.meshInstance.isVisibleFunc=i,this.unmaskMeshInstance&&(this.unmaskMeshInstance.cull=t,this.unmaskMeshInstance.isVisibleFunc=i)}},ks.prototype.setScreenSpace=function(t){this.meshInstance&&(this.meshInstance.screenSpace=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.screenSpace=t))},ks.prototype.setLayer=function(t){this.meshInstance&&(this.meshInstance.layer=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance.layer=t))},ks.prototype.forceUpdateAabb=function(t){this.meshInstance&&(this.meshInstance._aabbVer=-1,this.unmaskMeshInstance&&(this.unmaskMeshInstance._aabbVer=-1))},ks.prototype.setAabbFunc=function(t){this.meshInstance&&(this.meshInstance._updateAabbFunc=t,this.unmaskMeshInstance&&(this.unmaskMeshInstance._updateAabbFunc=t))},Object.assign(zs.prototype,{destroy:function(){this.materialAsset=this.spriteAsset=this.textureAsset=null,this._renderable.setMesh(this._defaultMesh),this._renderable.destroy(),this._defaultMesh=null,this._element.off("resize",this._onParentResizeOrPivotChange,this),this._element.off("set:pivot",this._onParentResizeOrPivotChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("screen:set:resolution",this._onResolutionChange,this)},_onResolutionChange:function(t){},_onParentResizeOrPivotChange:function(){this._renderable.mesh&&this._updateMesh(this._renderable.mesh)},_onScreenSpaceChange:function(t){this._updateMaterial(t)},_onScreenChange:function(t,e){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)},_onDrawOrderChange:function(t){this._renderable.setDrawOrder(t),this.mask&&this._element.screen&&this._element.screen.screen.once("syncdraworder",function(){this._renderable.setUnmaskDrawOrder()},this)},_hasUserMaterial:function(){return!!this._materialAsset||!!this._material&&-1===this._system.defaultImageMaterials.indexOf(this._material)},_use9Slicing:function(){return this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)},_updateMaterial:function(t){var e=!!this._mask,i=!(!this.sprite||1!==this.sprite.renderMode),s=!(!this.sprite||2!==this.sprite.renderMode);this._hasUserMaterial()||(this._material=this._system.getImageElementMaterial(t,e,i,s)),this._renderable&&(this._renderable.setCull(!0),this._renderable.setMaterial(this._material),this._renderable.setScreenSpace(t),this._renderable.setLayer(t?0:15))},_createMesh:function(){var t=this._element,e=t.calculatedWidth;t=t.calculatedHeight;var i=this._rect,s=new ArrayBuffer(128),n=new Float32Array(s);return n[5]=1,n[6]=i.x,n[7]=i.y,n[8]=e,n[13]=1,n[14]=i.x+i.z,n[15]=i.y,n[16]=e,n[17]=t,n[21]=1,n[22]=i.x+i.z,n[23]=i.y+i.w,n[25]=t,n[29]=1,n[30]=i.x,n[31]=i.y+i.w,s=new C(i=this._system.app.graphicsDevice,n=new O(i,[{semantic:"POSITION",components:3,type:6},{semantic:"NORMAL",components:3,type:6},{semantic:"TEXCOORD0",components:2,type:6}]),4,0,s),(i=new ht(i)).vertexBuffer=s,i.primitive[0].type=6,i.primitive[0].base=0,i.primitive[0].count=4,i.primitive[0].indexed=!1,i.aabb.setMinMax(v.ZERO,new v(e,t,0)),this._updateMesh(i),i},_updateMesh:function(t){var e=this._element,i=e.calculatedWidth,s=e.calculatedHeight,n=e._isScreenSpace();if(this._updateMaterial(n),this._renderable&&this._renderable.forceUpdateAabb(),!this.sprite||1!==this.sprite.renderMode&&2!==this.sprite.renderMode){var r=t.vertexBuffer,a=new Float32Array(r.lock());n=e.pivot.x,e=e.pivot.y,a[0]=-n*i,a[1]=-e*s,a[8]=i-n*i,a[9]=-e*s,a[16]=i-n*i,a[17]=s-e*s,a[24]=-n*i,a[25]=s-e*s;var o=1,h=1,l=this._rect;if(this._sprite&&this._sprite.frameKeys[this._spriteFrame]&&this._sprite.atlas){var c=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]];c&&(l=c.rect,o=this._sprite.atlas.texture.width,h=this._sprite.atlas.texture.height)}a[6]=l.x/o,a[7]=l.y/h,a[14]=(l.x+l.z)/o,a[15]=l.y/h,a[22]=(l.x+l.z)/o,a[23]=(l.y+l.w)/h,a[30]=l.x/o,a[31]=(l.y+l.w)/h,r.unlock(),r=new v(-n*i,-e*s,0),i=new v(i-n*i,s-e*s,0),t.aabb.setMinMax(r,i),this._renderable&&(this._renderable.node.setLocalScale(1,1,1),this._renderable.node.setLocalPosition(0,0,0),this._renderable.setAabbFunc(null))}else n=2/(t=this._sprite.atlas.frames[this._sprite.frameKeys[this._spriteFrame]]).rect.z,r=2/t.rect.w,this._innerOffset.set(t.border.x*n,t.border.y*r,t.border.z*n,t.border.w*r),n=this.sprite.atlas.texture,this._atlasRect.set(t.rect.x/n.width,t.rect.y/n.height,t.rect.z/n.width,t.rect.w/n.height),r=null!==this._pixelsPerUnit?this._pixelsPerUnit:this.sprite.pixelsPerUnit,n=t.rect.z/r,t=t.rect.w/r,this._outerScale.set(Math.max(i,this._innerOffset.x*n),Math.max(s,this._innerOffset.y*t)),r=t,this._outerScale.x/=n,this._outerScale.y/=t,n*=oa.clamp(i/(this._innerOffset.x*n),1e-4,1),r*=oa.clamp(s/(this._innerOffset.y*t),1e-4,1),this._renderable&&(this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._renderable.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._renderable.setParameter("atlasRect",this._atlasRectUniform),this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._renderable.setParameter("outerScale",this._outerScaleUniform),this._renderable.setAabbFunc(this._updateAabbFunc),this._renderable.node.setLocalScale(n,r,1),this._renderable.node.setLocalPosition((.5-e.pivot.x)*i,(.5-e.pivot.y)*s,0));this._meshDirty=!1},_updateSprite:function(){var t=!1,e=null;this._sprite&&this._sprite.atlas&&(e=this._sprite.meshes[this.spriteFrame],t=1===this._sprite.renderMode||2===this._sprite.renderMode),(this.mesh=t?e:this._defaultMesh)&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this.mesh))},_updateAabb:function(t){return t.center.set(0,0,0),t.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),t.setFromTransformedAabb(t,this._renderable.node.getWorldTransform()),t},_toggleMask:function(){this._element._dirtifyMask();var t=this._element._isScreenSpace();this._updateMaterial(t),this._renderable.setMask(!!this._mask)},_onMaterialLoad:function(t){this.material=t.resource},_onMaterialAdded:function(t){this._system.app.assets.off("add:"+t.id,this._onMaterialAdded,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)},_bindMaterialAsset:function(t){this._entity.enabled&&(t.on("load",this._onMaterialLoad,this),t.on("change",this._onMaterialChange,this),t.on("remove",this._onMaterialRemove,this),t.resource?this._onMaterialLoad(t):this._system.app.assets.load(t))},_unbindMaterialAsset:function(t){t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this)},_onMaterialChange:function(){},_onMaterialRemove:function(){},_onTextureAdded:function(t){this._system.app.assets.off("add:"+t.id,this._onTextureAdded,this),this._textureAsset===t.id&&this._bindTextureAsset(t)},_bindTextureAsset:function(t){this._entity.enabled&&(t.on("load",this._onTextureLoad,this),t.on("change",this._onTextureChange,this),t.on("remove",this._onTextureRemove,this),t.resource?this._onTextureLoad(t):this._system.app.assets.load(t))},_unbindTextureAsset:function(t){t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this)},_onTextureLoad:function(t){this.texture=t.resource},_onTextureChange:function(t){},_onTextureRemove:function(t){},_onSpriteAssetAdded:function(t){this._system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)},_bindSpriteAsset:function(t){this._entity.enabled&&(t.on("load",this._onSpriteAssetLoad,this),t.on("change",this._onSpriteAssetChange,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._system.app.assets.load(t))},_unbindSpriteAsset:function(t){t.off("load",this._onSpriteAssetLoad,this),t.off("change",this._onSpriteAssetChange,this),t.off("remove",this._onSpriteAssetRemove,this),t.data.textureAtlasAsset&&this._system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(t){if(t&&t.resource){if(t.resource.atlas)this.sprite=t.resource;else if(t=t.data.textureAtlasAsset){var e=this._system.app.assets;e.off("load:"+t,this._onTextureAtlasLoad,this),e.once("load:"+t,this._onTextureAtlasLoad,this)}}else this.sprite=null},_onSpriteAssetChange:function(t){this._onSpriteAssetLoad(t)},_onSpriteAssetRemove:function(t){},_bindSprite:function(t){t.on("set:meshes",this._onSpriteMeshesChange,this),t.on("set:pixelsPerUnit",this._onSpritePpuChange,this),t.on("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.on("set:texture",this._onAtlasTextureChange,this)},_unbindSprite:function(t){t.off("set:meshes",this._onSpriteMeshesChange,this),t.off("set:pixelsPerUnit",this._onSpritePpuChange,this),t.off("set:atlas",this._onAtlasTextureChange,this),t.atlas&&t.atlas.off("set:texture",this._onAtlasTextureChange,this)},_onSpriteMeshesChange:function(){this._sprite&&(this._spriteFrame=oa.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()},_onSpritePpuChange:function(){0!==this.sprite.renderMode&&null===this._pixelsPerUnit&&this._updateSprite()},_onAtlasTextureChange:function(){this.sprite&&this.sprite.atlas&&this.sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))},_onTextureAtlasLoad:function(t){(t=this._spriteAsset)instanceof Fe?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._system.app.assets.get(t))},onEnable:function(){var t;this._materialAsset&&(t=this._system.app.assets.get(this._materialAsset))&&t.resource!==this._material&&this._bindMaterialAsset(t),this._textureAsset&&(t=this._system.app.assets.get(this._textureAsset))&&t.resource!==this._texture&&this._bindTextureAsset(t),this._spriteAsset&&(t=this._system.app.assets.get(this._spriteAsset))&&t.resource!==this._sprite&&this._bindSpriteAsset(t),this._element.addModelToLayers(this._renderable.model)},onDisable:function(){this._element.removeModelFromLayers(this._renderable.model)},_setStencil:function(t){this._renderable.meshInstance.stencilFront=t,this._renderable.meshInstance.stencilBack=t,t=0,this._element.maskedBy&&(t=this._element.maskedBy.element._image._maskRef),this._renderable.unmaskMeshInstance&&(t=new Ns({ref:t+1,func:2,zpass:5}),this._renderable.unmaskMeshInstance.stencilFront=t,this._renderable.unmaskMeshInstance.stencilBack=t)}}),Object.defineProperty(zs.prototype,"color",{get:function(){return this._color},set:function(t){var e=t.r,i=t.g;t=t.b,this._color.r===e&&this._color.g===i&&this._color.b===t||(this._color.r=e,this._color.g=i,this._color.b=t,this._colorUniform[0]=e,this._colorUniform[1]=i,this._colorUniform[2]=t,this._renderable.setParameter("material_emissive",this._colorUniform),this._element&&this._element.fire("set:color",this._color))}}),Object.defineProperty(zs.prototype,"opacity",{get:function(){return this._color.a},set:function(t){t!==this._color.a&&(this._color.a=t,this._renderable.setParameter("material_opacity",t),this._element&&this._element.fire("set:opacity",t))}}),Object.defineProperty(zs.prototype,"rect",{get:function(){return this._rect},set:function(t){if(t instanceof b){var e=t.x,i=t.y,s=t.z;t=t.w}else e=t[0],i=t[1],s=t[2],t=t[3];e===this._rect.x&&i===this._rect.y&&s===this._rect.z&&t===this._rect.w||(this._rect.set(e,i,s,t),this._renderable.mesh&&(this._element._beingInitialized?this._meshDirty=!0:this._updateMesh(this._renderable.mesh)))}}),Object.defineProperty(zs.prototype,"material",{get:function(){return this._material},set:function(t){this._material!==t&&(t||(t=this._element._isScreenSpace(),t=this.mask?t?this._system.defaultScreenSpaceImageMaskMaterial:this._system.defaultImageMaskMaterial:t?this._system.defaultScreenSpaceImageMaterial:this._system.defaultImageMaterial),this._material=t)&&(this._renderable.setMaterial(t),this._hasUserMaterial()?(this._renderable.deleteParameter("material_opacity"),this._renderable.deleteParameter("material_emissive")):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)))}}),Object.defineProperty(zs.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(t){var e=this._system.app.assets,i=t;t instanceof Fe&&(i=t.id),this._materialAsset!==i&&(this._materialAsset&&(e.off("add:"+this._materialAsset,this._onMaterialAdded,this),t=e.get(this._materialAsset))&&(t.off("load",this._onMaterialLoad,this),t.off("change",this._onMaterialChange,this),t.off("remove",this._onMaterialRemove,this)),(this._materialAsset=i)?(i=e.get(this._materialAsset))?this._bindMaterialAsset(i):(this.material=null,e.on("add:"+this._materialAsset,this._onMaterialAdded,this)):this.material=null)}}),Object.defineProperty(zs.prototype,"texture",{get:function(){return this._texture},set:function(t){if(this._texture!==t){if(this._textureAsset){var e=this._system.app.assets.get(this._textureAsset);e&&e.resource!==t&&(this.textureAsset=null)}(this._texture=t)?(this._spriteAsset&&(this.spriteAsset=null),this._renderable.setParameter("texture_emissiveMap",this._texture),this._renderable.setParameter("texture_opacityMap",this._texture),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._renderable.setParameter("material_emissive",this._colorUniform),this._renderable.setParameter("material_opacity",this._color.a)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap"))}}}),Object.defineProperty(zs.prototype,"textureAsset",{get:function(){return this._textureAsset},set:function(t){var e=this._system.app.assets,i=t;t instanceof Fe&&(i=t.id),this._textureAsset!==i&&(this._textureAsset&&(e.off("add:"+this._textureAsset,this._onTextureAdded,this),t=e.get(this._textureAsset))&&(t.off("load",this._onTextureLoad,this),t.off("change",this._onTextureChange,this),t.off("remove",this._onTextureRemove,this)),(this._textureAsset=i)?(i=e.get(this._textureAsset))?this._bindTextureAsset(i):(this.texture=null,e.on("add:"+this._textureAsset,this._onTextureAdded,this)):this.texture=null)}}),Object.defineProperty(zs.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(t){var e=this._system.app.assets,i=t;t instanceof Fe&&(i=t.id),this._spriteAsset!==i&&(this._spriteAsset&&(e.off("add:"+this._spriteAsset,this._onSpriteAssetAdded,this),(t=e.get(this._spriteAsset))&&this._unbindSpriteAsset(t)),(this._spriteAsset=i)?(t=e.get(this._spriteAsset))?this._bindSpriteAsset(t):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null,this._element&&this._element.fire("set:spriteAsset",i))}}),Object.defineProperty(zs.prototype,"sprite",{get:function(){return this._sprite},set:function(t){if(this._sprite!==t){if(this._sprite&&this._unbindSprite(this._sprite),this._spriteAsset){var e=this._system.app.assets.get(this._spriteAsset);e&&e.resource!==t&&(this.spriteAsset=null)}(this._sprite=t)&&(this._bindSprite(this._sprite),this._textureAsset&&(this.textureAsset=null)),this._sprite&&this._sprite.atlas&&this._sprite.atlas.texture?(this._renderable.setParameter("texture_emissiveMap",this._sprite.atlas.texture),this._renderable.setParameter("texture_opacityMap",this._sprite.atlas.texture)):(this._renderable.deleteParameter("texture_emissiveMap"),this._renderable.deleteParameter("texture_opacityMap")),this._sprite&&(this._spriteFrame=oa.clamp(this._spriteFrame,0,this._sprite.frameKeys.length-1)),this._updateSprite()}}}),Object.defineProperty(zs.prototype,"spriteFrame",{get:function(){return this._spriteFrame},set:function(t){var e=this._spriteFrame;this._spriteFrame=this._sprite?oa.clamp(t,0,this._sprite.frameKeys.length-1):t,this._spriteFrame!==e&&(this._updateSprite(),this._element&&this._element.fire("set:spriteFrame",t))}}),Object.defineProperty(zs.prototype,"mesh",{get:function(){return this._renderable.mesh},set:function(t){this._renderable.setMesh(t),this._defaultMesh===t?this._renderable.setAabbFunc(null):this._renderable.setAabbFunc(this._updateAabbFunc)}}),Object.defineProperty(zs.prototype,"mask",{get:function(){return this._mask},set:function(t){this._mask!==t&&(this._mask=t,this._toggleMask())}}),Object.defineProperty(zs.prototype,"pixelsPerUnit",{get:function(){return this._pixelsPerUnit},set:function(t){this._pixelsPerUnit!==t&&(this._pixelsPerUnit=t,!this._sprite||1!==this._sprite.renderMode&&2!==this._sprite.renderMode||this._updateSprite())}}),Object.defineProperty(zs.prototype,"aabb",{get:function(){return this._renderable.meshInstance?this._renderable.meshInstance.aabb:null}}),Us.prototype=Object.create(n.prototype),Us.prototype.constructor=Us,Us.prototype._bindDefaultAsset=function(){var t=this._app.assets.get(this._defaultAsset);t?this._onDefaultAssetAdd(t):this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this)},Us.prototype._unbindDefaultAsset=function(){if(this._defaultAsset){this._app.assets.off("add:"+this._defaultAsset,this._onDefaultAssetAdd,this);var t=this._app.assets.get(this._defaultAsset);t&&(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleRemove,this),t.off("remove",this._onDefaultAssetRemove,this))}},Us.prototype._onDefaultAssetAdd=function(t){this._defaultAsset===t.id&&(t.on("add:localized",this._onLocaleAdd,this),t.on("remove:localized",this._onLocaleRemove,this),t.once("remove",this._onDefaultAssetRemove,this))},Us.prototype._onDefaultAssetRemove=function(t){this._defaultAsset===t.id&&(t.off("add:localized",this._onLocaleAdd,this),t.off("remove:localized",this._onLocaleAdd,this),this._app.assets.once("add:"+this._defaultAsset,this._onDefaultAssetAdd,this))},Us.prototype._bindLocalizedAsset=function(){if(this._autoLoad){var t=this._app.assets.get(this._localizedAsset);t&&(t.on("load",this._onLocalizedAssetLoad,this),t.on("change",this._onLocalizedAssetChange,this),t.on("remove",this._onLocalizedAssetRemove,this),t.resource?this._onLocalizedAssetLoad(t):this._app.assets.load(t))}},Us.prototype._unbindLocalizedAsset=function(){var t=this._app.assets.get(this._localizedAsset);t&&(t.off("load",this._onLocalizedAssetLoad,this),t.off("change",this._onLocalizedAssetChange,this),t.off("remove",this._onLocalizedAssetRemove,this))},Us.prototype._onLocalizedAssetAdd=function(t){this._localizedAsset===t.id&&this._bindLocalizedAsset()},Us.prototype._onLocalizedAssetLoad=function(t){this.fire("load",t)},Us.prototype._onLocalizedAssetChange=function(t,e,i,s){this.fire("change",t,e,i,s)},Us.prototype._onLocalizedAssetRemove=function(t){this._localizedAsset===t.id&&(this.localizedAsset=this._defaultAsset),this.fire("remove",t)},Us.prototype._onLocaleAdd=function(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)},Us.prototype._onLocaleRemove=function(t,e){this._app.i18n.locale===t&&this._onSetLocale(t)},Us.prototype._onSetLocale=function(t){if(this._defaultAsset){var e=this._app.assets.get(this._defaultAsset);this.localizedAsset=!e||this._disableLocalization?this._defaultAsset:(t=e.getLocalizedAssetId(t))?t:this._defaultAsset}else this.localizedAsset=null},Us.prototype.destroy=function(){this.defaultAsset=null,this._app.i18n.off("set:locale",this._onSetLocale,this),this.off()},Object.defineProperty(Us.prototype,"defaultAsset",{get:function(){return this._defaultAsset},set:function(t){t=t instanceof Fe?t.id:t,this._defaultAsset!==t&&(this._defaultAsset&&this._unbindDefaultAsset(),(this._defaultAsset=t)&&this._bindDefaultAsset(),this._onSetLocale(this._app.i18n.locale))}}),Object.defineProperty(Us.prototype,"localizedAsset",{get:function(){return this._localizedAsset},set:function(t){t=t instanceof Fe?t.id:t,this._localizedAsset!==t&&(this._localizedAsset&&(this._app.assets.off("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this),this._unbindLocalizedAsset(),this._localizedAsset=null),this._localizedAsset=t)&&(this._app.assets.get(this._localizedAsset)?this._bindLocalizedAsset():this._app.assets.once("add:"+this._localizedAsset,this._onLocalizedAssetAdd,this))}}),Object.defineProperty(Us.prototype,"autoLoad",{get:function(){return this._autoLoad},set:function(t){this._autoLoad!==t&&(this._autoLoad=t)&&this._localizedAsset&&(this._unbindLocalizedAsset(),this._bindLocalizedAsset())}}),Object.defineProperty(Us.prototype,"disableLocalization",{get:function(){return this._disableLocalization},set:function(t){this._disableLocalization!==t&&(this._disableLocalization=t,this._onSetLocale(this._app.i18n.locale))}}),Object.assign(Vs.prototype,{EOF_TOKEN:0,ERROR_TOKEN:1,TEXT_TOKEN:2,OPEN_BRACKET_TOKEN:3,CLOSE_BRACKET_TOKEN:4,EQUALS_TOKEN:5,STRING_TOKEN:6,IDENTIFIER_TOKEN:7,WHITESPACE_TOKEN:8,WHITESPACE_CHARS:" \t\n\r\v\f",IDENTIFIER_REGEX:/[A-Z|a-z|0-9|_|-|/]/,read:function(){for(var t=this._read();t===this.WHITESPACE_TOKEN;)t=this._read();return t!==this.EOF_TOKEN&&t!==this.ERROR_TOKEN&&(this._last=this._index),t},buf:function(){return this._buf},last:function(){return this._last},error:function(){return this._error},debugPrint:function(){for(var t="EOF ERROR TEXT OPEN_BRACKET CLOSE_BRACKET EQUALS STRING IDENTIFIER WHITESPACE".split(" "),e=this.read(),i="";i+=(0<i.length?"\n":"")+t[e]+" '"+this.buf().join("")+"'",e!==this.EOF_TOKEN&&e!==this.ERROR_TOKEN;)e=this.read();return i},_read:function(){return this._buf=[],this._eof()?this.EOF_TOKEN:"text"===this._mode?this._text():this._tag()},_text:function(){for(;;)switch(this._cur){case null:return 0<this._buf.length?this.TEXT_TOKEN:this.EOF_TOKEN;case"[":return this._mode="tag",0<this._buf.length?this.TEXT_TOKEN:this._tag();case"\\":switch(this._next(),this._cur){case"[":this._store();break;default:this._output("\\")}break;default:this._store()}},_tag:function(){for(;;)switch(this._cur){case null:return this._error="unexpected end of input reading tag",this.ERROR_TOKEN;case"[":return this._store(),this.OPEN_BRACKET_TOKEN;case"]":return this._store(),this._mode="text",this.CLOSE_BRACKET_TOKEN;case"=":return this._store(),this.EQUALS_TOKEN;case" ":case"\t":case"\n":case"\r":case"\v":case"\f":return this._whitespace();case'"':return this._string();default:return this._isIdentifierSymbol(this._cur)?this._identifier():(this._error="unrecognized character",this.ERROR_TOKEN)}},_whitespace:function(){for(this._store();-1!==this.WHITESPACE_CHARS.indexOf(this._cur);)this._store();return this.WHITESPACE_TOKEN},_string:function(){for(this._next();;)switch(this._cur){case null:return this._error="unexpected end of input reading string",this.ERROR_TOKEN;case'"':return this._next(),this.STRING_TOKEN;default:this._store()}},_identifier:function(){for(this._store();null!==this._cur&&this._isIdentifierSymbol(this._cur);)this._store();return this.IDENTIFIER_TOKEN},_isIdentifierSymbol:function(t){return 1===t.length&&null!==t.match(this.IDENTIFIER_REGEX)},_eof:function(){return null===this._cur},_next:function(){return this._eof()||(this._index++,this._cur=this._index<this._symbols.length?this._symbols[this._index]:null),this._cur},_store:function(){return this._buf.push(this._cur),this._next()},_output:function(t){this._buf.push(t)}});var yd=function(t){this._scanner=new Vs(t),this._error=null};Object.assign(yd.prototype,{parse:function(t,e){for(;;)switch(this._scanner.read()){case this._scanner.EOF_TOKEN:return!0;case this._scanner.ERROR_TOKEN:return!1;case this._scanner.TEXT_TOKEN:Array.prototype.push.apply(t,this._scanner.buf());break;case this._scanner.OPEN_BRACKET_TOKEN:if(!this._parseTag(t,e))return!1;break;default:return!1}},error:function(){return"Error evaluating markup at #"+this._scanner.last().toString()+" ("+(this._scanner.error()||this._error)+")"},_parseTag:function(t,e){var i=this._scanner.read();if(i!==this._scanner.IDENTIFIER_TOKEN)return this._error="expected identifier",!1;if("/"===(i=this._scanner.buf().join(""))[0]){for(var s=e.length-1;0<=s;--s)if(i==="/"+e[s].name&&null===e[s].end)return e[s].end=t.length,(i=this._scanner.read())===this._scanner.CLOSE_BRACKET_TOKEN||(this._error="expected close bracket",!1);return this._error="failed to find matching tag",!1}if(t={name:i,value:null,attributes:{},start:t.length,end:null},(i=this._scanner.read())===this._scanner.EQUALS_TOKEN){if((i=this._scanner.read())!==this._scanner.STRING_TOKEN)return this._error="expected string",!1;t.value=this._scanner.buf().join(""),i=this._scanner.read()}for(;;){switch(i){case this._scanner.CLOSE_BRACKET_TOKEN:return e.push(t),!0;case this._scanner.IDENTIFIER_TOKEN:if(s=this._scanner.buf().join(""),(i=this._scanner.read())!==this._scanner.EQUALS_TOKEN)return this._error="expected equals",!1;if((i=this._scanner.read())!==this._scanner.STRING_TOKEN)return this._error="expected string",!1;i=this._scanner.buf().join(""),t.attributes[s]=i;break;default:return this._error="expected close bracket or identifier",!1}i=this._scanner.read()}}}),Ws.evaluate=function(t){return Hs(t)};var vd=/^[\r\n]$/,bd=/^[ \t]$/,xd=/^[ \t\-]$/;Object.assign(qs.prototype,{destroy:function(){this._setMaterial(null),this._model&&(this._element.removeModelFromLayers(this._model),this._model.destroy(),this._model=null),this._fontAsset.destroy(),this.font=null,this._element.off("resize",this._onParentResize,this),this._element.off("set:screen",this._onScreenChange,this),this._element.off("screen:set:screenspace",this._onScreenSpaceChange,this),this._element.off("set:draworder",this._onDrawOrderChange,this),this._element.off("set:pivot",this._onPivotChange,this),this._system.app.i18n.off("set:locale",this._onLocaleSet,this),this._system.app.i18n.off("data:add",this._onLocalizationData,this),this._system.app.i18n.off("data:remove",this._onLocalizationData,this)},_onParentResize:function(t,e){this._noResize||this._font&&this._updateText()},_onScreenChange:function(t){t?this._updateMaterial(t.screen.screenSpace):this._updateMaterial(!1)},_onScreenSpaceChange:function(t){this._updateMaterial(t)},_onDrawOrderChange:function(t){if(this._drawOrder=t,this._model){var e,i=0;for(e=this._model.meshInstances.length;i<e;i++)this._model.meshInstances[i].drawOrder=t}},_onPivotChange:function(t){this._font&&this._updateText()},_onLocaleSet:function(t){this._i18nKey&&(this.fontAsset&&((t=this._system.app.assets.get(this.fontAsset))&&t.resource&&t.resource===this._font||(this.font=null)),this._resetLocalizedText())},_onLocalizationData:function(t,e){this._i18nKey&&e[this._i18nKey]&&this._resetLocalizedText()},_resetLocalizedText:function(){this._setText(this._system.app.i18n.getText(this._i18nKey))},_setText:function(t){if(this.unicodeConverter){var e=this._system.getUnicodeConverter();e?t=e(t):console.warn("Element created with unicodeConverter option but no unicodeConverter function registered")}this._text!==t&&(this._font&&this._updateText(t),this._text=t)},_updateText:function(t){var e;if(void 0===t&&(t=this._text),this._symbols=aa.getSymbols(t),0===this._symbols.length&&(this._symbols=[" "]),this._enableMarkup){t=Ws.evaluate(this._symbols),this._symbols=t.symbols;var i=t.tags}if(this._rtlReorder?(t=this._system.app.systems.element.getRtlReorder())?(t=t(this._symbols),this._rtl=t.rtl,this._symbols=t.mapping.map(function(t){return this._symbols[t]},this),i&&(i=t.mapping.map(function(t){return i[t]}))):console.warn("Element created with rtlReorder option but no rtlReorder function registered"):this._rtl=!1,i){var s={};for(this._colorPalette=[Math.round(255*this._color.r),Math.round(255*this._color.g),Math.round(255*this._color.b)],this._symbolColors=[],t=s[this._color.toString(!1).toLowerCase()]=0,e=this._symbols.length;t<e;++t){var n=i[t],r=0;n&&n.color&&n.color.value&&(7===(n=n.color.value).length&&"#"===n[0]&&(n=n.substring(1).toLowerCase(),s.hasOwnProperty(n)?r=s[n]:/^([0-9a-f]{2}){3}$/.test(n)&&(r=this._colorPalette.length/3,s[n]=r,this._colorPalette.push(parseInt(n.substring(0,2),16)),this._colorPalette.push(parseInt(n.substring(2,4),16)),this._colorPalette.push(parseInt(n.substring(4,6),16))))),this._symbolColors.push(r)}}else this._colorPalette=[],this._symbolColors=null;s=this._calculateCharsPerTexture(),r=!1;var a=this._element;n=a._isScreenSpace();var o=a._isScreenCulled(),h=function(t){return a.isVisibleForCamera(t)};for(t=0,e=this._meshInfo.length;t<e;t++){var l=s[t]||0,c=this._meshInfo[t];if(c.count!==l)if(r||(a.removeModelFromLayers(this._model),r=!0),c.count=l,c.positions.length=c.normals.length=12*l,c.indices.length=6*l,c.uvs.length=8*l,c.colors.length=16*l,c.meshInstance&&this._removeMeshInstance(c.meshInstance),0===l)c.meshInstance=null;else{for(var d=0;d<l;d++)c.indices[6*d]=4*d,c.indices[6*d+1]=4*d+1,c.indices[6*d+2]=4*d+3,c.indices[6*d+3]=4*d+2,c.indices[6*d+4]=4*d+3,c.indices[6*d+5]=4*d+1,c.normals[12*d]=0,c.normals[12*d+1]=0,c.normals[12*d+2]=-1,c.normals[12*d+3]=0,c.normals[12*d+4]=0,c.normals[12*d+5]=-1,c.normals[12*d+6]=0,c.normals[12*d+7]=0,c.normals[12*d+8]=-1,c.normals[12*d+9]=0,c.normals[12*d+10]=0,c.normals[12*d+11]=-1;l=ee(this._system.app.graphicsDevice,c.positions,{uvs:c.uvs,normals:c.normals,colors:c.colors,indices:c.indices}),(l=new lt(this._node,l,this._material)).name="Text Element: "+this._entity.name,l.castShadow=!1,l.receiveShadow=!1,l.cull=!n,l.screenSpace=n,l.drawOrder=this._drawOrder,o&&(l.cull=!0,l.isVisibleFunc=h),this._setTextureParams(l,this._font.textures[t]),this._symbolColors?(this._colorUniform[0]=1,this._colorUniform[1]=1,this._colorUniform[2]=1):(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b),l.setParameter("material_emissive",this._colorUniform),l.setParameter("material_opacity",this._color.a),l.setParameter("font_sdfIntensity",this._font.intensity),l.setParameter("font_pxrange",this._getPxRange(this._font)),l.setParameter("font_textureWidth",this._font.data.info.maps[t].width),this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,l.setParameter("outline_color",this._outlineColorUniform),l.setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness),this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,l.setParameter("shadow_color",this._shadowColorUniform),d=this._font.data.info.maps[t].width/this._font.data.info.maps[t].height,this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=d*this._shadowOffsetScale*this._shadowOffset.y,l.setParameter("shadow_offset",this._shadowOffsetUniform),c.meshInstance=l,this._model.meshInstances.push(l)}}this._element.maskedBy&&this._element._setMaskedBy(this._element.maskedBy),r&&this._element.enabled&&this._entity.enabled&&this._element.addModelToLayers(this._model),this._updateMeshes(),this._rangeStart=0,this._rangeEnd=this._symbols.length,this._updateRenderRange()},_removeMeshInstance:function(t){t.material=null;var e=t.mesh;e&&e.destroy(),-1!==(t=this._model.meshInstances.indexOf(t))&&this._model.meshInstances.splice(t,1)},_setMaterial:function(t){var e;if(this._material=t,this._model){var i=0;for(e=this._model.meshInstances.length;i<e;i++)this._model.meshInstances[i].material=t}},_updateMaterial:function(t){var e=this._element,i=e._isScreenCulled(),s=function(t){return e.isVisibleForCamera(t)};if(this._material=this._system.getTextElementMaterial(t,this._font&&"msdf"===this._font.type),this._model)for(var n=0,r=this._model.meshInstances.length;n<r;n++){var a=this._model.meshInstances[n];a.cull=!t,a.material=this._material,a.screenSpace=t,i?(a.cull=!0,a.isVisibleFunc=s):a.isVisibleFunc=null}},_updateMeshes:function(){function t(t,e,s){if(i._lineWidths.push(Math.abs(s)),t=t.slice(f>e?e+1:f,f>e?f+1:e),g)for(s=t.length;s--&&0<g;)vd.test(t[s])&&(t.splice(s,1),g--);i._lineContents.push(t.join("")),o=0,h-=i._scaledLineHeight,d++,u=g=_=m=0,f=e}var e=this._font.data,i=this,s=Math.min(this._minFontSize,this._maxFontSize),n=this._maxFontSize,r=this._shouldAutoFit();r&&(this._fontSize=this._maxFontSize);var a=this._symbols.length,o=0,h=0,l=0,c=0,d=1,u=0,p=0,f=0,m=0,_=0,g=0,y=1e-4<=Math.abs(this._element.anchor.x-this._element.anchor.z),v=this._element.calculatedWidth;(this.autoWidth&&!y||!this._wrapLines)&&(v=Number.POSITIVE_INFINITY);var b=0;y=0;for(var x,S,T,w=1,M=!0;M;){for(M=!1,this._scaledLineHeight=r?this._lineHeight*this._fontSize/(this._maxFontSize||1e-4):this._lineHeight,this.height=this.width=0,this._lineWidths=[],this._lineContents=[],c=l=h=o=0,d=1,g=_=m=f=p=u=0,w=this._fontSize/32,b=this._fontMinY*w,y=this._fontMaxY*w,T=0;T<this._meshInfo.length;T++)this._meshInfo[T].quad=0,this._meshInfo[T].lines={};var P=255,A=255,E=255;for(T=0;T<a;T++){x=this._symbols[T];var C=0,I=0,O=0,R=1;if(!(S=e.chars[x]))if(e.chars[" "])S=e.chars[" "];else for(var D in e.chars){S=e.chars[D];break}if(S){var L=0;0<_&&(O=this._font.data.kerning)&&(O=O[aa.getCodePoint(this._symbols[T-1])||0])&&(L=O[aa.getCodePoint(this._symbols[T])||0]||0),O=S.scale||1;var F=(S.width+S.height)/2;R=w*F/O,O=(S.xadvance+L)*w,C=(S.xoffset-L)*w,I=S.yoffset*w}else console.error("Couldn't substitute missing character: '"+x+"'");if(F=vd.test(x))g++,(0>this._maxLines||d<this._maxLines)&&(t(this._symbols,T,c),p=T+1,f=T+1);else{var B=bd.test(x);L=this._meshInfo[S&&S.map||0];var N=o+this._spacing*O;if(N>v&&0<_&&!B&&(0>this._maxLines||d<this._maxLines)){if(0!==m){if(S=Math.max(T-p,0),1>=this._meshInfo.length)L.lines[d-1]-=S,L.quad-=S;else for(L=T,x=p;x<L;x++)O=e.chars[this._symbols[x]],--(O=this._meshInfo[O&&O.map||0]).lines[d-1],--O.quad;T-=S+1,t(this._symbols,p,u);continue}p=T,t(this._symbols,T,c)}S=L.quad,L.lines[d-1]=S;var k=o-C,z=k+R,U=(I=h-I)+R;if(this._rtl&&(k-=R=R-C-this._spacing*O-C,z-=R),L.positions[12*S]=k,L.positions[12*S+1]=I,L.positions[12*S+2]=l,L.positions[12*S+3]=z,L.positions[12*S+4]=I,L.positions[12*S+5]=l,L.positions[12*S+6]=z,L.positions[12*S+7]=U,L.positions[12*S+8]=l,L.positions[12*S+9]=k,L.positions[12*S+10]=U,L.positions[12*S+11]=l,this.width=Math.max(this.width,N),this._shouldAutoFitWidth()&&this.width>this._element.calculatedWidth&&(R=Math.floor(this._element.fontSize*this._element.calculatedWidth/(this.width||1e-4)),(R=oa.clamp(R,s,n))!==this._element.fontSize)){this._fontSize=R,M=!0;break}if(this.height=Math.max(this.height,y-(h+b)),this._shouldAutoFitHeight()&&this.height>this._element.calculatedHeight&&(R=oa.clamp(this._fontSize-1,s,n))!==this._element.fontSize){this._fontSize=R,M=!0;break}o+=this._spacing*O,B||F||(c=o),xd.test(x)&&(m++,u=c,p=T+1),_++,x=this._getUv(x),L.uvs[8*S]=x[0],L.uvs[8*S+1]=x[1],L.uvs[8*S+2]=x[2],L.uvs[8*S+3]=x[1],L.uvs[8*S+4]=x[2],L.uvs[8*S+5]=x[3],L.uvs[8*S+6]=x[0],L.uvs[8*S+7]=x[3],this._symbolColors&&(E=3*this._symbolColors[T],P=this._colorPalette[E],A=this._colorPalette[E+1],E=this._colorPalette[E+2]),L.colors[16*S]=P,L.colors[16*S+1]=A,L.colors[16*S+2]=E,L.colors[16*S+3]=255,L.colors[16*S+4]=P,L.colors[16*S+5]=A,L.colors[16*S+6]=E,L.colors[16*S+7]=255,L.colors[16*S+8]=P,L.colors[16*S+9]=A,L.colors[16*S+10]=E,L.colors[16*S+11]=255,L.colors[16*S+12]=P,L.colors[16*S+13]=A,L.colors[16*S+14]=E,L.colors[16*S+15]=255,L.quad++}}M||f<a&&t(this._symbols,a,o)}for(this._noResize=!0,this.autoWidth=this._autoWidth,this.autoHeight=this._autoHeight,this._noResize=!1,e=this._element.pivot.x,s=this._element.pivot.y,n=this._alignment.x,r=this._alignment.y,T=0;T<this._meshInfo.length;T++)if(0!==this._meshInfo[T].count){for(var V in D=0,this._meshInfo[T].lines){for(a=this._meshInfo[T].lines[V],v=this._lineWidths[parseInt(V,10)],v=-e*this._element.calculatedWidth+n*(this._element.calculatedWidth-v)*(this._rtl?-1:1),l=(1-s)*this._element.calculatedHeight-y-(1-r)*(this._element.calculatedHeight-this.height),S=D;S<=a;S++)this._meshInfo[T].positions[12*S]+=v,this._meshInfo[T].positions[12*S+3]+=v,this._meshInfo[T].positions[12*S+6]+=v,this._meshInfo[T].positions[12*S+9]+=v,this._meshInfo[T].positions[12*S+1]+=l,this._meshInfo[T].positions[12*S+4]+=l,this._meshInfo[T].positions[12*S+7]+=l,this._meshInfo[T].positions[12*S+10]+=l;if(this._rtl)for(S=D;S<=a;S++){for(D=12*S,l=0;4>l;++l)this._meshInfo[T].positions[D+3*l]=this._element.calculatedWidth-this._meshInfo[T].positions[D+3*l]+2*v;l=this._meshInfo[T].positions[D+3],c=this._meshInfo[T].positions[D+6],this._meshInfo[T].positions[D+3]=this._meshInfo[T].positions[D+0],this._meshInfo[T].positions[D+6]=this._meshInfo[T].positions[D+9],this._meshInfo[T].positions[D+0]=l,this._meshInfo[T].positions[D+9]=c}D=a+1}for(a=4*this._meshInfo[T].count,v=4*this._meshInfo[T].quad,S=new W(this._meshInfo[T].meshInstance.mesh.vertexBuffer),D=0;D<a;D++)D>=v?(S.element.POSITION.set(0,0,0),S.element.TEXCOORD0.set(0,0),S.element.COLOR.set(0,0,0,0)):(S.element.POSITION.set(this._meshInfo[T].positions[3*D],this._meshInfo[T].positions[3*D+1],this._meshInfo[T].positions[3*D+2]),S.element.TEXCOORD0.set(this._meshInfo[T].uvs[2*D],this._meshInfo[T].uvs[2*D+1]),S.element.COLOR.set(this._meshInfo[T].colors[4*D],this._meshInfo[T].colors[4*D+1],this._meshInfo[T].colors[4*D+2],this._meshInfo[T].colors[4*D+3])),S.next();S.end(),this._meshInfo[T].meshInstance.mesh.aabb.compute(this._meshInfo[T].positions),this._meshInfo[T].meshInstance._aabbVer=-1}this._aabbDirty=!0},_onFontRender:function(){this.font=this._font},_onFontLoad:function(t){this.font!==t.resource&&(this.font=t.resource)},_onFontChange:function(t,e,i,s){if("data"===e)for(this._font.data=i,t=this._font.data.info.maps.length,e=0;e<t;e++)this._meshInfo[e]&&(i=this._meshInfo[e].meshInstance)&&(i.setParameter("font_sdfIntensity",this._font.intensity),i.setParameter("font_pxrange",this._getPxRange(this._font)),i.setParameter("font_textureWidth",this._font.data.info.maps[e].width))},_onFontRemove:function(t){},_setTextureParams:function(t,e){this._font&&("msdf"===this._font.type?(t.deleteParameter("texture_emissiveMap"),t.deleteParameter("texture_opacityMap"),t.setParameter("texture_msdfMap",e)):"bitmap"===this._font.type&&(t.deleteParameter("texture_msdfMap"),t.setParameter("texture_emissiveMap",e),t.setParameter("texture_opacityMap",e)))},_getPxRange:function(t){t=Object.keys(this._font.data.chars);for(var e=0;e<t.length;e++){var i=this._font.data.chars[t[e]];if(i.range)return(i.scale||1)*i.range}return 2},_getUv:function(t){var e=this._font.data;if(!e.chars[t])return e.chars[" "]?this._getUv(" "):[0,0,0,0];var i=e.chars[t].map,s=e.info.maps[i].width;i=e.info.maps[i].height;var n=e.chars[t].x,r=e.chars[t].y,a=1-e.chars[t].height/i;return[n/s,a-r/i,(n+e.chars[t].width)/s,a-(r-e.chars[t].height)/i]},onEnable:function(){this._fontAsset.autoLoad=!0,this._model&&this._element.addModelToLayers(this._model)},onDisable:function(){this._fontAsset.autoLoad=!1,this._model&&this._element.removeModelFromLayers(this._model)},_setStencil:function(t){if(this._model)for(var e=this._model.meshInstances,i=0;i<e.length;i++)e[i].stencilFront=t,e[i].stencilBack=t},_shouldAutoFitWidth:function(){return this._autoFitWidth&&!this._autoWidth},_shouldAutoFitHeight:function(){return this._autoFitHeight&&!this._autoHeight},_shouldAutoFit:function(){return this._autoFitWidth&&!this._autoWidth||this._autoFitHeight&&!this._autoHeight},_calculateCharsPerTexture:function(t){var e,i={};for(void 0===t&&(t=this._symbols.length),e=0;e<t;e++){var s=this._symbols[e];(s=this._font.data.chars[s])||(s=this._font.data.chars[" "])||(s=this._font.data.chars[Object.keys(this._font.data.chars)[0]]),i[s=s.map]?i[s]++:i[s]=1}return i},_updateRenderRange:function(){var t,e=0===this._rangeStart?0:this._calculateCharsPerTexture(this._rangeStart),i=0===this._rangeEnd?0:this._calculateCharsPerTexture(this._rangeEnd),s=0;for(t=this._meshInfo.length;s<t;s++){var n=e[s]||0,r=i[s]||0,a=this._meshInfo[s].meshInstance;a&&(a=a.mesh)&&(a.primitive[0].base=6*n,a.primitive[0].count=6*(r-n))}}}),Object.defineProperty(qs.prototype,"text",{get:function(){return this._text},set:function(t){this._i18nKey=null,this._setText(null!=t&&t.toString()||"")}}),Object.defineProperty(qs.prototype,"key",{get:function(){return this._i18nKey},set:function(t){t=null!==t?t.toString():null,this._i18nKey!==t&&((this._i18nKey=t)?(this._fontAsset.disableLocalization=!1,this._resetLocalizedText()):this._fontAsset.disableLocalization=!0)}}),Object.defineProperty(qs.prototype,"color",{get:function(){return this._color},set:function(t){var e=t.r,i=t.g;if(t=t.b,this._color.r!==e||this._color.g!==i||this._color.b!==t)if(this._color.r=e,this._color.g=i,this._color.b=t,this._symbolColors)this._font&&this._updateText();else for(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,e=0,i=this._model.meshInstances.length;e<i;e++)this._model.meshInstances[e].setParameter("material_emissive",this._colorUniform)}}),Object.defineProperty(qs.prototype,"opacity",{get:function(){return this._color.a},set:function(t){if(this._color.a!==t&&(this._color.a=t,this._model))for(var e=0,i=this._model.meshInstances.length;e<i;e++)this._model.meshInstances[e].setParameter("material_opacity",t)}}),Object.defineProperty(qs.prototype,"lineHeight",{get:function(){return this._lineHeight},set:function(t){var e=this._lineHeight;this._scaledLineHeight=this._lineHeight=t,e!==t&&this._font&&this._updateText()}}),Object.defineProperty(qs.prototype,"wrapLines",{get:function(){return this._wrapLines},set:function(t){var e=this._wrapLines;this._wrapLines=t,e!==t&&this._font&&this._updateText()}}),Object.defineProperty(qs.prototype,"lines",{get:function(){return this._lineContents}}),Object.defineProperty(qs.prototype,"spacing",{get:function(){return this._spacing},set:function(t){var e=this._spacing;this._spacing=t,e!==t&&this._font&&this._updateText()}}),Object.defineProperty(qs.prototype,"fontSize",{get:function(){return this._fontSize},set:function(t){var e=this._fontSize;this._originalFontSize=this._fontSize=t,e!==t&&this._font&&this._updateText()}}),Object.defineProperty(qs.prototype,"fontAsset",{get:function(){return this._fontAsset.localizedAsset},set:function(t){this._fontAsset.defaultAsset=t}}),Object.defineProperty(qs.prototype,"font",{get:function(){return this._font},set:function(t){if(this._font){var e=this._font.type;this._font.off&&this._font.off("render",this._onFontRender,this)}if(this._font=t,this._fontMaxY=this._fontMinY=0,t){var i,s=this._font.data;for(i in s.chars){var n=s.chars[i];n.bounds&&(this._fontMinY=Math.min(this._fontMinY,n.bounds[1]),this._fontMaxY=Math.max(this._fontMaxY,n.bounds[3]))}for(this._font.on&&this._font.on("render",this._onFontRender,this),this._fontAsset.localizedAsset&&this._system.app.assets.get(this._fontAsset.localizedAsset).resource!==this._font&&(this._fontAsset.defaultAsset=null),t.type!==e&&(t=this._element._isScreenSpace(),this._updateMaterial(t)),t=0,e=this._font.textures.length;t<e;t++)this._meshInfo[t]?(s=this._meshInfo[t].meshInstance)&&(s.setParameter("font_sdfIntensity",this._font.intensity),s.setParameter("font_pxrange",this._getPxRange(this._font)),s.setParameter("font_textureWidth",this._font.data.info.maps[t].width),this._setTextureParams(s,this._font.textures[t])):this._meshInfo[t]=new Xs;for(e=!1,t=this._font.textures.length;t<this._meshInfo.length;t++)this._meshInfo[t].meshInstance&&(e||(this._element.removeModelFromLayers(this._model),e=!0),this._removeMeshInstance(this._meshInfo[t].meshInstance));this._meshInfo.length>this._font.textures.length&&(this._meshInfo.length=this._font.textures.length),this._updateText()}}}),Object.defineProperty(qs.prototype,"alignment",{get:function(){return this._alignment},set:function(t){t instanceof y?this._alignment.set(t.x,t.y):this._alignment.set(t[0],t[1]),this._font&&this._updateText()}}),Object.defineProperty(qs.prototype,"autoWidth",{get:function(){return this._autoWidth},set:function(t){var e=this._autoWidth;(this._autoWidth=t)&&1e-4>Math.abs(this._element.anchor.x-this._element.anchor.z)&&(this._element.width=this.width),e!==t&&((t=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize)!==this._fontSize&&(this._fontSize=t,this._font&&this._updateText()))}}),Object.defineProperty(qs.prototype,"autoHeight",{get:function(){return this._autoHeight},set:function(t){var e=this._autoHeight;(this._autoHeight=t)&&1e-4>Math.abs(this._element.anchor.y-this._element.anchor.w)&&(this._element.height=this.height),e!==t&&((t=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize)!==this._fontSize&&(this._fontSize=t,this._font&&this._updateText()))}}),Object.defineProperty(qs.prototype,"rtlReorder",{get:function(){return this._rtlReorder},set:function(t){this._rtlReorder!==t&&(this._rtlReorder=t,this._font&&this._updateText())}}),Object.defineProperty(qs.prototype,"unicodeConverter",{get:function(){return this._unicodeConverter},set:function(t){this._unicodeConverter!==t&&(this._unicodeConverter=t,this._setText(this._text))}}),Object.defineProperty(qs.prototype,"aabb",{get:function(){if(this._aabbDirty){for(var t=!1,e=0;e<this._meshInfo.length;e++)this._meshInfo[e].meshInstance&&(t?this._aabb.add(this._meshInfo[e].meshInstance.aabb):(this._aabb.copy(this._meshInfo[e].meshInstance.aabb),t=!0));this._aabbDirty=!1}return this._aabb}}),Object.defineProperty(qs.prototype,"outlineColor",{get:function(){return this._outlineColor},set:function(t){var e=t instanceof o?t.r:t[0],i=t instanceof o?t.g:t[1],s=t instanceof o?t.b:t[2];if(t=t instanceof o?t.a:t[3],(this._outlineColor.r!==e||this._outlineColor.g!==i||this._outlineColor.b!==s||this._outlineColor.a!==t)&&(this._outlineColor.r=e,this._outlineColor.g=i,this._outlineColor.b=s,this._outlineColor.a=t,this._model))for(this._outlineColorUniform[0]=this._outlineColor.r,this._outlineColorUniform[1]=this._outlineColor.g,this._outlineColorUniform[2]=this._outlineColor.b,this._outlineColorUniform[3]=this._outlineColor.a,e=0,i=this._model.meshInstances.length;e<i;e++)this._model.meshInstances[e].setParameter("outline_color",this._outlineColorUniform)}}),Object.defineProperty(qs.prototype,"outlineThickness",{get:function(){return this._outlineThickness},set:function(t){var e=this._outlineThickness;if(this._outlineThickness=t,e!==t&&this._font&&this._model)for(t=0,e=this._model.meshInstances.length;t<e;t++)this._model.meshInstances[t].setParameter("outline_thickness",this._outlineThicknessScale*this._outlineThickness)}}),Object.defineProperty(qs.prototype,"shadowColor",{get:function(){return this._shadowColor},set:function(t){var e=t instanceof o?t.r:t[0],i=t instanceof o?t.g:t[1],s=t instanceof o?t.b:t[2];if(t=t instanceof o?t.a:t[3],(this._shadowColor.r!==e||this._shadowColor.g!==i||this._shadowColor.b!==s||this._shadowColor.a!==t)&&(this._shadowColor.r=e,this._shadowColor.g=i,this._shadowColor.b=s,this._shadowColor.a=t,this._model))for(this._shadowColorUniform[0]=this._shadowColor.r,this._shadowColorUniform[1]=this._shadowColor.g,this._shadowColorUniform[2]=this._shadowColor.b,this._shadowColorUniform[3]=this._shadowColor.a,e=0,i=this._model.meshInstances.length;e<i;e++)this._model.meshInstances[e].setParameter("shadow_color",this._shadowColorUniform)}}),Object.defineProperty(qs.prototype,"shadowOffset",{get:function(){return this._shadowOffset},set:function(t){var e=t instanceof y?t.x:t[0];if(t=t instanceof y?t.y:t[1],(this._shadowOffset.x!==e||this._shadowOffset.y!==t)&&(this._shadowOffset.set(e,t),this._font&&this._model))for(e=0,t=this._model.meshInstances.length;e<t;e++){var i=this._font.data.info.maps[e].width/this._font.data.info.maps[e].height;this._shadowOffsetUniform[0]=this._shadowOffsetScale*this._shadowOffset.x,this._shadowOffsetUniform[1]=i*this._shadowOffsetScale*this._shadowOffset.y,this._model.meshInstances[e].setParameter("shadow_offset",this._shadowOffsetUniform)}}}),Object.defineProperty(qs.prototype,"minFontSize",{get:function(){return this._minFontSize},set:function(t){this._minFontSize!==t&&(this._minFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}}),Object.defineProperty(qs.prototype,"maxFontSize",{get:function(){return this._maxFontSize},set:function(t){this._maxFontSize!==t&&(this._maxFontSize=t,this.font&&this._shouldAutoFit()&&this._updateText())}}),Object.defineProperty(qs.prototype,"autoFitWidth",{get:function(){return this._autoFitWidth},set:function(t){this._autoFitWidth!==t&&(this._autoFitWidth=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}}),Object.defineProperty(qs.prototype,"autoFitHeight",{get:function(){return this._autoFitHeight},set:function(t){this._autoFitHeight!==t&&(this._autoFitHeight=t,this._fontSize=this._shouldAutoFit()?this._maxFontSize:this._originalFontSize,this.font&&this._updateText())}}),Object.defineProperty(qs.prototype,"maxLines",{get:function(){return this._maxLines},set:function(t){this._maxLines===t||null===t&&-1===this._maxLines||(this._maxLines=null===t?-1:t,this.font&&this._wrapLines&&this._updateText())}}),Object.defineProperty(qs.prototype,"enableMarkup",{get:function(){return this._enableMarkup},set:function(t){t=!!t,this._enableMarkup!==t&&(this._enableMarkup=t,this.font&&this._updateText())}}),Object.defineProperty(qs.prototype,"symbols",{get:function(){return this._symbols}}),Object.defineProperty(qs.prototype,"symbolColors",{get:function(){return null===this._symbolColors?null:this._symbolColors.map(function(t){return this._colorPalette.slice(3*t,3*t+3)},this)}}),Object.defineProperty(qs.prototype,"rtl",{get:function(){return this._rtl}}),Object.defineProperty(qs.prototype,"rangeStart",{get:function(){return this._rangeStart},set:function(t){(t=Math.max(0,Math.min(t,this._symbols.length)))!==this._rangeStart&&(this._rangeStart=t,this._updateRenderRange())}}),Object.defineProperty(qs.prototype,"rangeEnd",{get:function(){return this._rangeEnd},set:function(t){(t=Math.max(this._rangeStart,Math.min(t,this._symbols.length)))!==this._rangeEnd&&(this._rangeEnd=t,this._updateRenderRange())}});var Sd=new v,Td=new v,wd=new x,Md=new x,Pd=new x,Ad=new x;Ys.prototype=Object.create(as.prototype),Ys.prototype.constructor=Ys,Object.assign(Ys.prototype,{_patch:function(){this.entity._sync=this._sync,this.entity.setPosition=this._setPosition,this.entity.setLocalPosition=this._setLocalPosition},_unpatch:function(){this.entity._sync=xe.prototype._sync,this.entity.setPosition=xe.prototype.setPosition,this.entity.setLocalPosition=xe.prototype.setLocalPosition},_setPosition:function(){var t=new v,e=new x;return function(i,s,n){if(!this.element.screen)return xe.prototype.setPosition.call(this,i,s,n);i instanceof v?t.copy(i):t.set(i,s,n),this.getWorldTransform(),e.copy(this.element._screenToWorld).invert(),e.transformPoint(t,this.localPosition),this._dirtyLocal||this._dirtifyLocal()}}(),_setLocalPosition:function(t,e,i){t instanceof v?this.localPosition.copy(t):this.localPosition.set(t,e,i),t=this.element,e=this.localPosition,i=t._pivot,t._margin.x=e.x-t._calculatedWidth*i.x,t._margin.z=t._localAnchor.z-t._localAnchor.x-t._calculatedWidth-t._margin.x,t._margin.y=e.y-t._calculatedHeight*i.y,t._margin.w=t._localAnchor.w-t._localAnchor.y-t._calculatedHeight-t._margin.y,this._dirtyLocal||this._dirtifyLocal()},_sync:function(){var t=this.element,e=t.screen;if(e){if(t._anchorDirty){var i=0,s=1;if(this._parent&&this._parent.element){var n=this._parent.element.calculatedWidth,r=this._parent.element.calculatedHeight;i=this._parent.element.pivot.x,s=this._parent.element.pivot.y}else n=(r=e.screen.resolution).x/e.screen.scale,r=r.y/e.screen.scale;t._anchorTransform.setTranslate(n*(t.anchor.x-i),-r*(s-t.anchor.y),0),t._anchorDirty=!1,t._calculateLocalAnchors()}t._sizeDirty&&t._calculateSize(!1,!1)}if(this._dirtyLocal&&(this.localTransform.setTRS(this.localPosition,this.localRotation,this.localScale),n=this.localPosition,i=t._pivot,t._margin.x=n.x-t._calculatedWidth*i.x,t._margin.z=t._localAnchor.z-t._localAnchor.x-t._calculatedWidth-t._margin.x,t._margin.y=n.y-t._calculatedHeight*i.y,t._margin.w=t._localAnchor.w-t._localAnchor.y-t._calculatedHeight-t._margin.y,this._dirtyLocal=!1),!e)return this._dirtyWorld&&(t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0),xe.prototype._sync.call(this);this._dirtyWorld&&(null===this._parent?this.worldTransform.copy(this.localTransform):(this._parent.element?t._screenToWorld.mul2(this._parent.element._modelTransform,t._anchorTransform):t._screenToWorld.copy(t._anchorTransform),t._modelTransform.mul2(t._screenToWorld,this.localTransform),e?(t._screenToWorld.mul2(e.screen._screenMatrix,t._screenToWorld),e.screen.screenSpace||t._screenToWorld.mul2(e.worldTransform,t._screenToWorld),this.worldTransform.mul2(t._screenToWorld,this.localTransform),(n=t._parentWorldTransform).setIdentity(),(i=this._parent)&&i.element&&i!==e&&(wd.setTRS(v.ZERO,i.getLocalRotation(),i.getLocalScale()),n.mul2(i.element._parentWorldTransform,wd)),Sd.set(0,0,this.localPosition.z),Td.set(t._absLeft+t._pivot.x*t.calculatedWidth,t._absBottom+t._pivot.y*t.calculatedHeight,0),wd.setTranslate(-Td.x,-Td.y,-Td.z),Md.setTRS(Sd,this.getLocalRotation(),this.getLocalScale()),Pd.setTranslate(Td.x,Td.y,Td.z),t._screenTransform.mul2(t._parentWorldTransform,Pd).mul(Md).mul(wd),t._cornersDirty=!0,t._canvasCornersDirty=!0,t._worldCornersDirty=!0):this.worldTransform.copy(t._modelTransform)),this._dirtyWorld=!1)},_onInsert:function(t){t=this._parseUpToScreen(),this.entity._dirtifyWorld(),this._updateScreen(t.screen),this._dirtifyMask()},_dirtifyMask:function(){for(var t=this.entity;t;){var e=t.parent;if((null===e||e.screen)&&t.element){this.system._prerender&&this.system._prerender.length||(this.system._prerender=[],this.system.app.once("prerender",this._onPrerender,this));var i=this.system._prerender.indexOf(this.entity);0<=i&&this.system._prerender.splice(i,1),0>this.system._prerender.indexOf(t)&&this.system._prerender.push(t)}t=e}},_onPrerender:function(){for(var t=0;t<this.system._prerender.length;t++){var e=this.system._prerender[t];e.element&&e.element.syncMask(1)}this.system._prerender.length=0},_bindScreen:function(t){t.on("set:resolution",this._onScreenResize,this),t.on("set:referenceresolution",this._onScreenResize,this),t.on("set:scaleblend",this._onScreenResize,this),t.on("set:screenspace",this._onScreenSpaceChange,this),t.on("remove",this._onScreenRemove,this)},_unbindScreen:function(t){t.off("set:resolution",this._onScreenResize,this),t.off("set:referenceresolution",this._onScreenResize,this),t.off("set:scaleblend",this._onScreenResize,this),t.off("set:screenspace",this._onScreenSpaceChange,this),t.off("remove",this._onScreenRemove,this)},_updateScreen:function(t){this.screen&&this.screen!==t&&this._unbindScreen(this.screen.screen);var e=this.screen;(this.screen=t)&&this._bindScreen(this.screen.screen),this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("set:screen",this.screen,e),this._anchorDirty=!0;for(var i=0,s=(e=this.entity.children).length;i<s;i++)e[i].element&&e[i].element._updateScreen(t);this.screen&&this.screen.screen.syncDrawOrder()},syncMask:function(t){var e=this._parseUpToScreen();this._updateMask(e.mask,t)},_setMaskedBy:function(t){var e=this._image||this._text;if(t){var i=new Ns({ref:t.element._image._maskRef,func:2});e&&e._setStencil&&e._setStencil(i),this._maskedBy=t}else e&&e._setStencil&&e._setStencil(null),this._maskedBy=null},_updateMask:function(t,e){var i;t?(this._setMaskedBy(t),this.mask&&(t=new Ns({ref:t.element._image._maskRef,func:2,zpass:3}),this._image._setStencil(t),this._image._maskRef=e,e++,t=this.entity)):(this._setMaskedBy(null),this.mask&&(t=new Ns({ref:e,func:7,zpass:2}),this._image._setStencil(t),this._image._maskRef=e,e++,t=this.entity));var s=this.entity.children,n=0;for(i=s.length;n<i;n++)s[n].element&&s[n].element._updateMask(t,e)},_parseUpToScreen:function(){for(var t={screen:null,mask:null},e=this.entity._parent;e&&!e.screen;)e.element&&e.element.mask&&!t.mask&&(t.mask=e),e=e.parent;return e&&e.screen&&(t.screen=e),t},_onScreenResize:function(t){this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0,this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY),this.fire("screen:set:resolution",t)},_onScreenSpaceChange:function(){this.fire("screen:set:screenspace",this.screen.screen.screenSpace)},_onScreenRemove:function(){this.screen&&!this.screen._destroying&&this._updateScreen(null)},_calculateLocalAnchors:function(){var t=1e3,e=1e3,i=this.entity._parent;i&&i.element?(t=i.element.calculatedWidth,e=i.element.calculatedHeight):this.screen&&(e=this.screen.screen.resolution,i=this.screen.screen.scale,t=e.x/i,e=e.y/i),this._localAnchor.set(this._anchor.x*t,this._anchor.y*e,this._anchor.z*t,this._anchor.w*e)},getOffsetPosition:function(t,e){var i=this.entity.getLocalPosition().clone();return i.x+=t,i.y+=e,this._screenToWorld.transformPoint(i,i),i},onLayersChanged:function(t,e){this.addModelToLayers(this._image?this._image._model:this._text._model),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(t){0>this.layers.indexOf(t.id)||(this._image?t.addMeshInstances(this._image._model.meshInstances):this._text&&t.addMeshInstances(this._text._model.meshInstances))},onLayerRemoved:function(t){0>this.layers.indexOf(t.id)||(this._image?t.removeMeshInstances(this._image._model.meshInstances):this._text&&t.removeMeshInstances(this._text._model.meshInstances))},onEnable:function(){this._image&&this._image.onEnable(),this._text&&this._text.onEnable(),this._group&&this._group.onEnable(),this.useInput&&this.system.app.elementInput&&this.system.app.elementInput.addElement(this),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),0<=this._batchGroupId&&this.system.app.batcher.insert(gt.ELEMENT,this.batchGroupId,this.entity),this.fire("enableelement")},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this._image&&this._image.onDisable(),this._text&&this._text.onDisable(),this._group&&this._group.onDisable(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),0<=this._batchGroupId&&this.system.app.batcher.remove(gt.ELEMENT,this.batchGroupId,this.entity),this.fire("disableelement")},onRemove:function(){this.entity.off("insert",this._onInsert,this),this._unpatch(),this._image&&this._image.destroy(),this._text&&this._text.destroy(),this.system.app.elementInput&&this.useInput&&this.system.app.elementInput.removeElement(this),this.screen&&this.screen.screen&&(this._unbindScreen(this.screen.screen),this.screen.screen.syncDrawOrder()),this.off()},_calculateSize:function(t,e){if(this.entity._parent||this.screen){this._calculateLocalAnchors();var i=this._absRight-this._absLeft,s=this._absTop-this._absBottom;t?this._setWidth(i):this._setCalculatedWidth(i,!1),e?this._setHeight(s):this._setCalculatedHeight(s,!1),(t=this.entity.getLocalPosition()).x=this._margin.x+this._calculatedWidth*this._pivot.x,t.y=this._margin.y+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(t),this._sizeDirty=!1}},_setWidth:function(t){this._width=t,this._setCalculatedWidth(t,!1),this.fire("set:width",this._width)},_setHeight:function(t){this._height=t,this._setCalculatedHeight(t,!1),this.fire("set:height",this._height)},_setCalculatedWidth:function(t,e){1e-4>=Math.abs(t-this._calculatedWidth)||(this._calculatedWidth=t,this.entity._dirtifyLocal(),e&&(t=this.entity.getLocalPosition(),this._margin.x=t.x-this._calculatedWidth*this._pivot.x,this._margin.z=this._localAnchor.z-this._localAnchor.x-this._calculatedWidth-this._margin.x),this._flagChildrenAsDirty(),this.fire("set:calculatedWidth",this._calculatedWidth),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_setCalculatedHeight:function(t,e){1e-4>=Math.abs(t-this._calculatedHeight)||(this._calculatedHeight=t,this.entity._dirtifyLocal(),e&&(t=this.entity.getLocalPosition(),this._margin.y=t.y-this._calculatedHeight*this._pivot.y,this._margin.w=this._localAnchor.w-this._localAnchor.y-this._calculatedHeight-this._margin.y),this._flagChildrenAsDirty(),this.fire("set:calculatedHeight",this._calculatedHeight),this.fire("resize",this._calculatedWidth,this._calculatedHeight))},_flagChildrenAsDirty:function(){var t,e=this.entity._children,i=0;for(t=e.length;i<t;i++)e[i].element&&(e[i].element._anchorDirty=!0,e[i].element._sizeDirty=!0)},addModelToLayers:function(t){var e;this._addedModels.push(t);for(var i=0;i<this.layers.length;i++)(e=this.system.app.scene.layers.getLayerById(this.layers[i]))&&e.addMeshInstances(t.meshInstances)},removeModelFromLayers:function(t){var e=this._addedModels.indexOf(t);0<=e&&this._addedModels.splice(e,1);for(var i=0;i<this.layers.length;i++)(e=this.system.app.scene.layers.getLayerById(this.layers[i]))&&e.removeMeshInstances(t.meshInstances)},getMaskOffset:function(){var t=this.system.app.frame;return this._offsetReadAt!==t&&(this._maskOffset=.5,this._offsetReadAt=t),t=this._maskOffset,this._maskOffset-=.001,t},isVisibleForCamera:function(t){if(this.maskedBy){t=this.maskedBy.element.screenCorners;var e=Math.min(Math.min(t[0].x,t[1].x),Math.min(t[2].x,t[3].x)),i=Math.max(Math.max(t[0].x,t[1].x),Math.max(t[2].x,t[3].x)),s=Math.min(Math.min(t[0].y,t[1].y),Math.min(t[2].y,t[3].y));t=Math.max(Math.max(t[0].y,t[1].y),Math.max(t[2].y,t[3].y))}else{e=this.system.app.graphicsDevice.width;var n=this.system.app.graphicsDevice.height;i=t._rect.z*e,s=t._rect.w*n,i=(e*=t._rect.x)+i,s=(t=(1-t._rect.y)*n)-s}n=this.screenCorners;var r=Math.min(Math.min(n[0].x,n[1].x),Math.min(n[2].x,n[3].x)),a=Math.min(Math.min(n[0].y,n[1].y),Math.min(n[2].y,n[3].y)),o=Math.max(Math.max(n[0].y,n[1].y),Math.max(n[2].y,n[3].y));return!(Math.max(Math.max(n[0].x,n[1].x),Math.max(n[2].x,n[3].x))<e||r>i||a>t||o<s)},_isScreenSpace:function(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.screenSpace},_isScreenCulled:function(){return!(!this.screen||!this.screen.screen)&&this.screen.screen.cull}}),Object.defineProperty(Ys.prototype,"type",{get:function(){return this._type},set:function(t){t!==this._type&&(this._type=t,this._image&&(this._image.destroy(),this._image=null),this._text&&(this._text.destroy(),this._text=null),"image"===t?this._image=new zs(this):"text"===t&&(this._text=new qs(this)))}}),Object.defineProperty(Ys.prototype,"layers",{get:function(){return this._layers},set:function(t){var e,i,s;if(this._addedModels.length)for(e=0;e<this._layers.length;e++)if(s=this.system.app.scene.layers.getLayerById(this._layers[e]))for(i=0;i<this._addedModels.length;i++)s.removeMeshInstances(this._addedModels[i].meshInstances);if(this._layers=t,this.enabled&&this.entity.enabled&&this._addedModels.length)for(e=0;e<this._layers.length;e++)if(s=this.system.app.scene.layers.getLayerById(this._layers[e]))for(i=0;i<this._addedModels.length;i++)s.addMeshInstances(this._addedModels[i].meshInstances)}}),Object.defineProperty(Ys.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(t){var e=0;this.screen&&(e=this.screen.screen.priority),16777215<t&&(t=16777215),this._drawOrder=(e<<24)+t,this.fire("set:draworder",this._drawOrder)}}),Object.defineProperty(Ys.prototype,"_absLeft",{get:function(){return this._localAnchor.x+this._margin.x}}),Object.defineProperty(Ys.prototype,"_absRight",{get:function(){return this._localAnchor.z-this._margin.z}}),Object.defineProperty(Ys.prototype,"_absTop",{get:function(){return this._localAnchor.w-this._margin.w}}),Object.defineProperty(Ys.prototype,"_absBottom",{get:function(){return this._localAnchor.y+this._margin.y}}),Object.defineProperty(Ys.prototype,"margin",{get:function(){return this._margin},set:function(t){this._margin.copy(t),this._calculateSize(!0,!0),this.fire("set:margin",this._margin)}}),Object.defineProperty(Ys.prototype,"left",{get:function(){return this._margin.x},set:function(t){this._margin.x=t;var e=this.entity.getLocalPosition();this._setWidth(this._absRight-(this._localAnchor.x+t)),e.x=t+this._calculatedWidth*this._pivot.x,this.entity.setLocalPosition(e)}}),Object.defineProperty(Ys.prototype,"right",{get:function(){return this._margin.z},set:function(t){this._margin.z=t;var e=this.entity.getLocalPosition();this._setWidth(this._localAnchor.z-t-this._absLeft),e.x=this._localAnchor.z-this._localAnchor.x-t-this._calculatedWidth*(1-this._pivot.x),this.entity.setLocalPosition(e)}}),Object.defineProperty(Ys.prototype,"top",{get:function(){return this._margin.w},set:function(t){this._margin.w=t;var e=this.entity.getLocalPosition();this._setHeight(this._localAnchor.w-t-this._absBottom),e.y=this._localAnchor.w-this._localAnchor.y-t-this._calculatedHeight*(1-this._pivot.y),this.entity.setLocalPosition(e)}}),Object.defineProperty(Ys.prototype,"bottom",{get:function(){return this._margin.y},set:function(t){this._margin.y=t;var e=this.entity.getLocalPosition();this._setHeight(this._absTop-(this._localAnchor.y+t)),e.y=t+this._calculatedHeight*this._pivot.y,this.entity.setLocalPosition(e)}}),Object.defineProperty(Ys.prototype,"width",{get:function(){return this._width},set:function(t){this._width=t,this._hasSplitAnchorsX||this._setCalculatedWidth(t,!0),this.fire("set:width",this._width)}}),Object.defineProperty(Ys.prototype,"height",{get:function(){return this._height},set:function(t){this._height=t,this._hasSplitAnchorsY||this._setCalculatedHeight(t,!0),this.fire("set:height",this._height)}}),Object.defineProperty(Ys.prototype,"calculatedWidth",{get:function(){return this._calculatedWidth},set:function(t){this._setCalculatedWidth(t,!0)}}),Object.defineProperty(Ys.prototype,"calculatedHeight",{get:function(){return this._calculatedHeight},set:function(t){this._setCalculatedHeight(t,!0)}}),Object.defineProperty(Ys.prototype,"pivot",{get:function(){return this._pivot},set:function(t){var e=this._pivot.x,i=this._pivot.y;t instanceof y?this._pivot.set(t.x,t.y):this._pivot.set(t[0],t[1]),t=this._margin.x+this._margin.z,e=this._pivot.x-e,this._margin.x+=t*e,this._margin.z-=t*e,e=this._margin.y+this._margin.w,i=this._pivot.y-i,this._margin.y+=e*i,this._margin.w-=e*i,this._worldCornersDirty=this._cornersDirty=this._anchorDirty=!0,this._calculateSize(!1,!1),this._flagChildrenAsDirty(),this.fire("set:pivot",this._pivot)}}),Object.defineProperty(Ys.prototype,"anchor",{get:function(){return this._anchor},set:function(t){t instanceof b?this._anchor.set(t.x,t.y,t.z,t.w):this._anchor.set(t[0],t[1],t[2],t[3]),this.entity._parent||this.screen?this._calculateSize(this._hasSplitAnchorsX,this._hasSplitAnchorsY):this._calculateLocalAnchors(),this._anchorDirty=!0,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:anchor",this._anchor)}}),Object.defineProperty(Ys.prototype,"_hasSplitAnchorsX",{get:function(){return.001<Math.abs(this._anchor.x-this._anchor.z)}}),Object.defineProperty(Ys.prototype,"_hasSplitAnchorsY",{get:function(){return.001<Math.abs(this._anchor.y-this._anchor.w)}}),Object.defineProperty(Ys.prototype,"aabb",{get:function(){return this._image?this._image.aabb:this._text?this._text.aabb:null}}),Object.defineProperty(Ys.prototype,"screenCorners",{get:function(){if(!this._cornersDirty||!this.screen)return this._screenCorners;var t=this.entity.parent&&this.entity.parent.element&&this.entity.parent.element.screenCorners[0];this._screenCorners[0].set(this._absLeft,this._absBottom,0),this._screenCorners[1].set(this._absRight,this._absBottom,0),this._screenCorners[2].set(this._absRight,this._absTop,0),this._screenCorners[3].set(this._absLeft,this._absTop,0);for(var e=this.screen.screen.screenSpace,i=0;4>i;i++)this._screenTransform.transformPoint(this._screenCorners[i],this._screenCorners[i]),e&&this._screenCorners[i].scale(this.screen.screen.scale),t&&this._screenCorners[i].add(t);return this._cornersDirty=!1,this._worldCornersDirty=this._canvasCornersDirty=!0,this._screenCorners}}),Object.defineProperty(Ys.prototype,"canvasCorners",{get:function(){if(!this._canvasCornersDirty||!this.screen||!this.screen.screen.screenSpace)return this._canvasCorners;for(var t=this.system.app.graphicsDevice,e=this.screenCorners,i=t.canvas.clientWidth/t.width,s=t.canvas.clientHeight/t.height,n=0;4>n;n++)this._canvasCorners[n].set(e[n].x*i,(t.height-e[n].y)*s);return this._canvasCornersDirty=!1,this._canvasCorners}}),Object.defineProperty(Ys.prototype,"worldCorners",{get:function(){if(!this._worldCornersDirty)return this._worldCorners;if(this.screen){var t=this.screenCorners;if(!this.screen.screen.screenSpace){wd.copy(this.screen.screen._screenMatrix),wd.data[13]=-wd.data[13],wd.mul2(this.screen.getWorldTransform(),wd);for(var e=0;4>e;e++)wd.transformPoint(t[e],this._worldCorners[e])}}else t=this.entity.getLocalPosition(),wd.setTranslate(-t.x,-t.y,-t.z),Md.setTRS(v.ZERO,this.entity.getLocalRotation(),this.entity.getLocalScale()),Pd.setTranslate(t.x,t.y,t.z),Ad.copy(this.entity.parent.getWorldTransform()),Ad.mul(Pd).mul(Md).mul(wd),Sd.set(t.x-this.pivot.x*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),Ad.transformPoint(Sd,this._worldCorners[0]),Sd.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y-this.pivot.y*this.calculatedHeight,t.z),Ad.transformPoint(Sd,this._worldCorners[1]),Sd.set(t.x+(1-this.pivot.x)*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),Ad.transformPoint(Sd,this._worldCorners[2]),Sd.set(t.x-this.pivot.x*this.calculatedWidth,t.y+(1-this.pivot.y)*this.calculatedHeight,t.z),Ad.transformPoint(Sd,this._worldCorners[3]);return this._worldCornersDirty=!1,this._worldCorners}}),Object.defineProperty(Ys.prototype,"textWidth",{get:function(){return this._text?this._text.width:0}}),Object.defineProperty(Ys.prototype,"textHeight",{get:function(){return this._text?this._text.height:0}}),Object.defineProperty(Ys.prototype,"useInput",{get:function(){return this._useInput},set:function(t){this._useInput!==t&&(this._useInput=t,this.system.app.elementInput&&(t?this.enabled&&this.entity.enabled&&this.system.app.elementInput.addElement(this):this.system.app.elementInput.removeElement(this)),this.fire("set:useInput",t))}}),Object.defineProperty(Ys.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(t){this._batchGroupId!==t&&(this.entity.enabled&&0<=this._batchGroupId&&this.system.app.batcher.remove(gt.ELEMENT,this.batchGroupId,this.entity),this.entity.enabled&&0<=t&&this.system.app.batcher.insert(gt.ELEMENT,t,this.entity),0>t&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&(this._image&&this._image._renderable.model?this.addModelToLayers(this._image._renderable.model):this._text&&this._text._model&&this.addModelToLayers(this._text._model)),this._batchGroupId=t)}}),Object.defineProperty(Ys.prototype,"maskedBy",{get:function(){return this._maskedBy}});var Ed=function(t){Object.defineProperty(Ys.prototype,t,{get:function(){return this._text?this._text[t]:this._image?this._image[t]:null},set:function(e){this._text?this._text[t]=e:this._image&&(this._image[t]=e)}})};Ed("fontSize"),Ed("minFontSize"),Ed("maxFontSize"),Ed("maxLines"),Ed("autoFitWidth"),Ed("autoFitHeight"),Ed("color"),Ed("font"),Ed("fontAsset"),Ed("spacing"),Ed("lineHeight"),Ed("wrapLines"),Ed("lines"),Ed("alignment"),Ed("autoWidth"),Ed("autoHeight"),Ed("rtlReorder"),Ed("unicodeConverter"),Ed("text"),Ed("key"),Ed("texture"),Ed("textureAsset"),Ed("material"),Ed("materialAsset"),Ed("sprite"),Ed("spriteAsset"),Ed("spriteFrame"),Ed("pixelsPerUnit"),Ed("opacity"),Ed("rect"),Ed("mask"),Ed("outlineColor"),Ed("outlineThickness"),Ed("shadowColor"),Ed("shadowOffset"),Ed("enableMarkup"),Ed("rangeStart"),Ed("rangeEnd");var Cd=["enabled"];$s.prototype=Object.create(os.prototype),$s.prototype.constructor=$s,as._buildAccessors(Ys.prototype,Cd),Object.assign($s.prototype,{destroy:function(){this._defaultTexture.destroy()},initializeComponentData:function(t,e,i){t._beingInitialized=!0,void 0!==e.anchor&&(e.anchor instanceof b?t.anchor.copy(e.anchor):t.anchor.set(e.anchor[0],e.anchor[1],e.anchor[2],e.anchor[3])),void 0!==e.pivot&&(e.pivot instanceof y?t.pivot.copy(e.pivot):t.pivot.set(e.pivot[0],e.pivot[1]));var s=.001<Math.abs(t.anchor.x-t.anchor.z),n=.001<Math.abs(t.anchor.y-t.anchor.w),r=!1;void 0!==e.margin&&(e.margin instanceof b?t.margin.copy(e.margin):t._margin.set(e.margin[0],e.margin[1],e.margin[2],e.margin[3]),r=!0),void 0!==e.left&&(t._margin.x=e.left,r=!0),void 0!==e.bottom&&(t._margin.y=e.bottom,r=!0),void 0!==e.right&&(t._margin.z=e.right,r=!0),void 0!==e.top&&(t._margin.w=e.top,r=!0),r&&(t.margin=t._margin),r=!1,void 0===e.width||s?s&&(r=!0):t.width=e.width,void 0===e.height||n?n&&(r=!0):t.height=e.height,r&&(t.anchor=t.anchor),void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.useInput&&(t.useInput=e.useInput),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),t.type=e.type,"image"===t.type?(void 0!==e.rect&&(t.rect=e.rect),void 0!==e.color&&((s=e.color)instanceof o||(s=new o(e.color[0],e.color[1],e.color[2])),t.color=s),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.textureAsset&&(t.textureAsset=e.textureAsset),e.texture&&(t.texture=e.texture),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.spriteFrame&&(t.spriteFrame=e.spriteFrame),void 0!==e.pixelsPerUnit&&null!==e.pixelsPerUnit&&(t.pixelsPerUnit=e.pixelsPerUnit),void 0!==e.materialAsset&&(t.materialAsset=e.materialAsset),e.material&&(t.material=e.material),void 0!==e.mask&&(t.mask=e.mask)):"text"===t.type&&(void 0!==e.autoWidth&&(t.autoWidth=e.autoWidth),void 0!==e.autoHeight&&(t.autoHeight=e.autoHeight),void 0!==e.rtlReorder&&(t.rtlReorder=e.rtlReorder),void 0!==e.unicodeConverter&&(t.unicodeConverter=e.unicodeConverter),null!==e.text&&void 0!==e.text?t.text=e.text:null!==e.key&&void 0!==e.key&&(t.key=e.key),void 0!==e.color&&((s=e.color)instanceof o||(s=new o(s[0],s[1],s[2])),t.color=s),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.spacing&&(t.spacing=e.spacing),void 0!==e.fontSize&&(t.fontSize=e.fontSize,e.lineHeight||(t.lineHeight=e.fontSize)),void 0!==e.lineHeight&&(t.lineHeight=e.lineHeight),void 0!==e.maxLines&&(t.maxLines=e.maxLines),void 0!==e.wrapLines&&(t.wrapLines=e.wrapLines),void 0!==e.minFontSize&&(t.minFontSize=e.minFontSize),void 0!==e.maxFontSize&&(t.maxFontSize=e.maxFontSize),e.autoFitWidth&&(t.autoFitWidth=e.autoFitWidth),e.autoFitHeight&&(t.autoFitHeight=e.autoFitHeight),void 0!==e.fontAsset&&(t.fontAsset=e.fontAsset),void 0!==e.font&&(t.font=e.font),void 0!==e.alignment&&(t.alignment=e.alignment),void 0!==e.outlineColor&&(t.outlineColor=e.outlineColor),void 0!==e.outlineThickness&&(t.outlineThickness=e.outlineThickness),void 0!==e.shadowColor&&(t.shadowColor=e.shadowColor),void 0!==e.shadowOffset&&(t.shadowOffset=e.shadowOffset),void 0!==e.enableMarkup&&(t.enableMarkup=e.enableMarkup)),(s=t._parseUpToScreen()).screen&&t._updateScreen(s.screen),os.prototype.initializeComponentData.call(this,t,e,i),t._beingInitialized=!1,"image"===t.type&&t._image._meshDirty&&t._image._updateMesh(t._image.mesh)},onRemoveComponent:function(t,e){e.onRemove()},cloneComponent:function(t,e){var i={enabled:(t=t.element).enabled,width:t.width,height:t.height,anchor:t.anchor.clone(),pivot:t.pivot.clone(),margin:t.margin.clone(),alignment:t.alignment&&t.alignment.clone()||t.alignment,autoWidth:t.autoWidth,autoHeight:t.autoHeight,type:t.type,rect:t.rect&&t.rect.clone()||t.rect,rtlReorder:t.rtlReorder,unicodeConverter:t.unicodeConverter,materialAsset:t.materialAsset,material:t.material,color:t.color&&t.color.clone()||t.color,opacity:t.opacity,textureAsset:t.textureAsset,texture:t.texture,spriteAsset:t.spriteAsset,sprite:t.sprite,spriteFrame:t.spriteFrame,pixelsPerUnit:t.pixelsPerUnit,spacing:t.spacing,lineHeight:t.lineHeight,wrapLines:t.wrapLines,layers:t.layers,fontSize:t.fontSize,minFontSize:t.minFontSize,maxFontSize:t.maxFontSize,autoFitWidth:t.autoFitWidth,autoFitHeight:t.autoFitHeight,maxLines:t.maxLines,fontAsset:t.fontAsset,font:t.font,useInput:t.useInput,batchGroupId:t.batchGroupId,mask:t.mask,outlineColor:t.outlineColor&&t.outlineColor.clone()||t.outlineColor,outlineThickness:t.outlineThickness,shadowColor:t.shadowColor&&t.shadowColor.clone()||t.shadowColor,shadowOffset:t.shadowOffset&&t.shadowOffset.clone()||t.shadowOffset,enableMarkup:t.enableMarkup};return void 0!==t.key&&null!==t.key?i.key=t.key:i.text=t.text,this.addComponent(e,i)},getTextElementMaterial:function(t,e){return t?e?(this.defaultScreenSpaceTextMaterial||(this.defaultScreenSpaceTextMaterial=new ar,this.defaultScreenSpaceTextMaterial.name="defaultScreenSpaceTextMaterial",this.defaultScreenSpaceTextMaterial.msdfMap=this._defaultTexture,this.defaultScreenSpaceTextMaterial.useLighting=!1,this.defaultScreenSpaceTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceTextMaterial.useFog=!1,this.defaultScreenSpaceTextMaterial.useSkybox=!1,this.defaultScreenSpaceTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceTextMaterial.emissive.set(1,1,1),this.defaultScreenSpaceTextMaterial.opacity=.5,this.defaultScreenSpaceTextMaterial.blendType=4,this.defaultScreenSpaceTextMaterial.depthWrite=!1,this.defaultScreenSpaceTextMaterial.depthTest=!1,this.defaultScreenSpaceTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceTextMaterial.update()),this.defaultScreenSpaceTextMaterial):(this.defaultScreenSpaceBitmapTextMaterial||(this.defaultScreenSpaceBitmapTextMaterial=new ar,this.defaultScreenSpaceBitmapTextMaterial.name="defaultScreenSpaceBitmapTextMaterial",this.defaultScreenSpaceBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultScreenSpaceBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.emissiveTint=!0,this.defaultScreenSpaceBitmapTextMaterial.opacity=.5,this.defaultScreenSpaceBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultScreenSpaceBitmapTextMaterial.opacityMapChannel="a",this.defaultScreenSpaceBitmapTextMaterial.useLighting=!1,this.defaultScreenSpaceBitmapTextMaterial.useGammaTonemap=!1,this.defaultScreenSpaceBitmapTextMaterial.useFog=!1,this.defaultScreenSpaceBitmapTextMaterial.useSkybox=!1,this.defaultScreenSpaceBitmapTextMaterial.diffuse.set(0,0,0),this.defaultScreenSpaceBitmapTextMaterial.blendType=4,this.defaultScreenSpaceBitmapTextMaterial.depthWrite=!1,this.defaultScreenSpaceBitmapTextMaterial.depthTest=!1,this.defaultScreenSpaceBitmapTextMaterial.emissiveVertexColor=!0,this.defaultScreenSpaceBitmapTextMaterial.update()),this.defaultScreenSpaceBitmapTextMaterial):e?(this.defaultTextMaterial||(this.defaultTextMaterial=new ar,this.defaultTextMaterial.name="defaultTextMaterial",this.defaultTextMaterial.msdfMap=this._defaultTexture,this.defaultTextMaterial.useLighting=!1,this.defaultTextMaterial.useGammaTonemap=!1,this.defaultTextMaterial.useFog=!1,this.defaultTextMaterial.useSkybox=!1,this.defaultTextMaterial.diffuse.set(0,0,0),this.defaultTextMaterial.emissive.set(1,1,1),this.defaultTextMaterial.opacity=.5,this.defaultTextMaterial.blendType=4,this.defaultTextMaterial.depthWrite=!1,this.defaultTextMaterial.emissiveVertexColor=!0,this.defaultTextMaterial.update()),this.defaultTextMaterial):(this.defaultBitmapTextMaterial||(this.defaultBitmapTextMaterial=new ar,this.defaultBitmapTextMaterial.name="defaultBitmapTextMaterial",this.defaultBitmapTextMaterial.emissive.set(.5,.5,.5),this.defaultBitmapTextMaterial.emissiveTint=!0,this.defaultBitmapTextMaterial.emissiveMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacity=.5,this.defaultBitmapTextMaterial.opacityMap=this._defaultTexture,this.defaultBitmapTextMaterial.opacityMapChannel="a",this.defaultBitmapTextMaterial.useLighting=!1,this.defaultBitmapTextMaterial.useGammaTonemap=!1,this.defaultBitmapTextMaterial.useFog=!1,this.defaultBitmapTextMaterial.useSkybox=!1,this.defaultBitmapTextMaterial.diffuse.set(0,0,0),this.defaultBitmapTextMaterial.blendType=4,this.defaultBitmapTextMaterial.depthWrite=!1,this.defaultBitmapTextMaterial.emissiveVertexColor=!0,this.defaultBitmapTextMaterial.update()),this.defaultBitmapTextMaterial)},_createBaseImageMaterial:function(){var t=new ar;return t.diffuse.set(0,0,0),t.emissive.set(.5,.5,.5),t.emissiveMap=this._defaultTexture,t.emissiveTint=!0,t.opacityMap=this._defaultTexture,t.opacityMapChannel="a",t.opacityTint=!0,t.opacity=0,t.useLighting=!1,t.useGammaTonemap=!1,t.useFog=!1,t.useSkybox=!1,t.blendType=4,t.depthWrite=!1,t},getImageElementMaterial:function(t,e,i,s){return t?e?i?(this.defaultScreenSpaceImageMask9SlicedMaterial||(this.defaultScreenSpaceImageMask9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMask9SlicedMaterial.name="defaultScreenSpaceImageMask9SlicedMaterial",this.defaultScreenSpaceImageMask9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImageMask9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9SlicedMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9SlicedMaterial)),this.defaultScreenSpaceImageMask9SlicedMaterial):s?(this.defaultScreenSpaceImageMask9TiledMaterial||(this.defaultScreenSpaceImageMask9TiledMaterial=this.defaultScreenSpaceImage9TiledMaterial.clone(),this.defaultScreenSpaceImageMask9TiledMaterial.name="defaultScreenSpaceImageMask9TiledMaterial",this.defaultScreenSpaceImageMask9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImageMask9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaTest=1,this.defaultScreenSpaceImageMask9TiledMaterial.redWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.greenWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.blueWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMask9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMask9TiledMaterial)),this.defaultScreenSpaceImageMask9TiledMaterial):(this.defaultScreenSpaceImageMaskMaterial||(this.defaultScreenSpaceImageMaskMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaskMaterial.name="defaultScreenSpaceImageMaskMaterial",this.defaultScreenSpaceImageMaskMaterial.depthTest=!1,this.defaultScreenSpaceImageMaskMaterial.alphaTest=1,this.defaultScreenSpaceImageMaskMaterial.redWrite=!1,this.defaultScreenSpaceImageMaskMaterial.greenWrite=!1,this.defaultScreenSpaceImageMaskMaterial.blueWrite=!1,this.defaultScreenSpaceImageMaskMaterial.alphaWrite=!1,this.defaultScreenSpaceImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaskMaterial)),this.defaultScreenSpaceImageMaskMaterial):i?(this.defaultScreenSpaceImage9SlicedMaterial||(this.defaultScreenSpaceImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9SlicedMaterial.name="defaultScreenSpaceImage9SlicedMaterial",this.defaultScreenSpaceImage9SlicedMaterial.nineSlicedMode=1,this.defaultScreenSpaceImage9SlicedMaterial.depthTest=!1,this.defaultScreenSpaceImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9SlicedMaterial)),this.defaultScreenSpaceImage9SlicedMaterial):s?(this.defaultScreenSpaceImage9TiledMaterial||(this.defaultScreenSpaceImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImage9TiledMaterial.name="defaultScreenSpaceImage9TiledMaterial",this.defaultScreenSpaceImage9TiledMaterial.nineSlicedMode=2,this.defaultScreenSpaceImage9TiledMaterial.depthTest=!1,this.defaultScreenSpaceImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImage9TiledMaterial)),this.defaultScreenSpaceImage9TiledMaterial):(this.defaultScreenSpaceImageMaterial||(this.defaultScreenSpaceImageMaterial=this._createBaseImageMaterial(),this.defaultScreenSpaceImageMaterial.name="defaultScreenSpaceImageMaterial",this.defaultScreenSpaceImageMaterial.depthTest=!1,this.defaultScreenSpaceImageMaterial.update(),this.defaultImageMaterials.push(this.defaultScreenSpaceImageMaterial)),this.defaultScreenSpaceImageMaterial):e?i?(this.defaultImage9SlicedMaskMaterial||(this.defaultImage9SlicedMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaskMaterial.name="defaultImage9SlicedMaskMaterial",this.defaultImage9SlicedMaskMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaskMaterial.alphaTest=1,this.defaultImage9SlicedMaskMaterial.redWrite=!1,this.defaultImage9SlicedMaskMaterial.greenWrite=!1,this.defaultImage9SlicedMaskMaterial.blueWrite=!1,this.defaultImage9SlicedMaskMaterial.alphaWrite=!1,this.defaultImage9SlicedMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaskMaterial)),this.defaultImage9SlicedMaskMaterial):s?(this.defaultImage9TiledMaskMaterial||(this.defaultImage9TiledMaskMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaskMaterial.name="defaultImage9TiledMaskMaterial",this.defaultImage9TiledMaskMaterial.nineSlicedMode=2,this.defaultImage9TiledMaskMaterial.alphaTest=1,this.defaultImage9TiledMaskMaterial.redWrite=!1,this.defaultImage9TiledMaskMaterial.greenWrite=!1,this.defaultImage9TiledMaskMaterial.blueWrite=!1,this.defaultImage9TiledMaskMaterial.alphaWrite=!1,this.defaultImage9TiledMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaskMaterial)),this.defaultImage9TiledMaskMaterial):(this.defaultImageMaskMaterial||(this.defaultImageMaskMaterial=this._createBaseImageMaterial(),this.defaultImageMaskMaterial.name="defaultImageMaskMaterial",this.defaultImageMaskMaterial.alphaTest=1,this.defaultImageMaskMaterial.redWrite=!1,this.defaultImageMaskMaterial.greenWrite=!1,this.defaultImageMaskMaterial.blueWrite=!1,this.defaultImageMaskMaterial.alphaWrite=!1,this.defaultImageMaskMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaskMaterial)),this.defaultImageMaskMaterial):i?(this.defaultImage9SlicedMaterial||(this.defaultImage9SlicedMaterial=this._createBaseImageMaterial(),this.defaultImage9SlicedMaterial.name="defaultImage9SlicedMaterial",this.defaultImage9SlicedMaterial.nineSlicedMode=1,this.defaultImage9SlicedMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9SlicedMaterial)),this.defaultImage9SlicedMaterial):s?(this.defaultImage9TiledMaterial||(this.defaultImage9TiledMaterial=this._createBaseImageMaterial(),this.defaultImage9TiledMaterial.name="defaultImage9TiledMaterial",this.defaultImage9TiledMaterial.nineSlicedMode=2,this.defaultImage9TiledMaterial.update(),this.defaultImageMaterials.push(this.defaultImage9TiledMaterial)),this.defaultImage9TiledMaterial):(this.defaultImageMaterial||(this.defaultImageMaterial=this._createBaseImageMaterial(),this.defaultImageMaterial.name="defaultImageMaterial",this.defaultImageMaterial.update(),this.defaultImageMaterials.push(this.defaultImageMaterial)),this.defaultImageMaterial)},registerUnicodeConverter:function(t){this._unicodeConverter=t},registerRtlReorder:function(t){this._rtlReorder=t},getUnicodeConverter:function(){return this._unicodeConverter},getRtlReorder:function(){return this._rtlReorder}}),Zs.prototype=Object.create(as.prototype),Zs.prototype.constructor=Zs,Qs("minWidth"),Qs("minHeight"),Qs("maxWidth"),Qs("maxHeight"),Qs("fitWidthProportion"),Qs("fitHeightProportion"),Qs("excludeFromLayout");var Id=["enabled"],Od=function(t){os.call(this,t),this.id="layoutchild",this.ComponentType=Zs,this.DataType=Js,this.schema=Id};Od.prototype=Object.create(os.prototype),Od.prototype.constructor=Od,as._buildAccessors(Zs.prototype,Id),Object.assign(Od.prototype,{initializeComponentData:function(t,e,i){void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.minWidth&&(t.minWidth=e.minWidth),void 0!==e.minHeight&&(t.minHeight=e.minHeight),void 0!==e.maxWidth&&(t.maxWidth=e.maxWidth),void 0!==e.maxHeight&&(t.maxHeight=e.maxHeight),void 0!==e.fitWidthProportion&&(t.fitWidthProportion=e.fitWidthProportion),void 0!==e.fitHeightProportion&&(t.fitHeightProportion=e.fitHeightProportion),void 0!==e.excludeFromLayout&&(t.excludeFromLayout=e.excludeFromLayout),os.prototype.initializeComponentData.call(this,t,e,i)},cloneComponent:function(t,e){return t=t.layoutchild,this.addComponent(e,{enabled:t.enabled,minWidth:t.minWidth,minHeight:t.minHeight,maxWidth:t.maxWidth,maxHeight:t.maxHeight,fitWidthProportion:t.fitWidthProportion,fitHeightProportion:t.fitHeightProportion,excludeFromLayout:t.excludeFromLayout})}});var Rd=0,Dd={0:{axis:"x",size:"width",calculatedSize:"calculatedWidth",minSize:"minWidth",maxSize:"maxWidth",fitting:"widthFitting",fittingProportion:"fitWidthProportion"},1:{axis:"y",size:"height",calculatedSize:"calculatedHeight",minSize:"minHeight",maxSize:"maxHeight",fitting:"heightFitting",fittingProportion:"fitHeightProportion"}},Ld={0:1,1:0},Fd={minWidth:0,minHeight:0,maxWidth:Number.POSITIVE_INFINITY,maxHeight:Number.POSITIVE_INFINITY,width:null,height:null,fitWidthProportion:0,fitHeightProportion:0},Bd={NONE:"NONE",APPLY_STRETCHING:"APPLY_STRETCHING",APPLY_SHRINKING:"APPLY_SHRINKING"},Nd=new y,kd={};kd[0]=en(0),kd[1]=en(1),Object.assign(tn.prototype,{calculateLayout:function(t,e){var i=kd[e.orientation];if(i)return i(t,e);throw Error("Unrecognized orientation value: "+e.orientation)}}),sn.prototype=Object.create(as.prototype),sn.prototype.constructor=sn,Object.assign(sn.prototype,{_isSelfOrChild:function(t){return t===this.entity||-1!==this.entity.children.indexOf(t)},_listenForReflowEvents:function(t,e){t.element&&(t.element[e]("enableelement",this._scheduleReflow,this),t.element[e]("disableelement",this._scheduleReflow,this),t.element[e]("resize",this._scheduleReflow,this),t.element[e]("set:pivot",this._scheduleReflow,this)),t.layoutchild&&(t.layoutchild[e]("set_enabled",this._scheduleReflow,this),t.layoutchild[e]("resize",this._scheduleReflow,this))},_onElementOrLayoutComponentAdd:function(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"on"),this._scheduleReflow())},_onElementOrLayoutComponentRemove:function(t){this._isSelfOrChild(t)&&(this._listenForReflowEvents(t,"off"),this._scheduleReflow())},_onChildInsert:function(t){this._listenForReflowEvents(t,"on"),this._scheduleReflow()},_onChildRemove:function(t){this._listenForReflowEvents(t,"off"),this._scheduleReflow()},_scheduleReflow:function(){this.enabled&&this.entity&&this.entity.enabled&&!this._isPerformingReflow&&this.system.scheduleReflow(this)},reflow:function(){var t=this.entity.element,e=this.entity.children.filter(rn).map(nn);t&&0!==e.length&&(t={orientation:this._orientation,reverseX:this._reverseX,reverseY:this._reverseY,alignment:this._alignment,padding:this._padding,spacing:this._spacing,widthFitting:this._widthFitting,heightFitting:this._heightFitting,wrap:this._wrap,containerSize:new y(Math.max(t.calculatedWidth,0),Math.max(t.calculatedHeight,0))},this._isPerformingReflow=!0,e=this._layoutCalculator.calculateLayout(e,t),this._isPerformingReflow=!1,this.fire("reflow",e))},onEnable:function(){this._scheduleReflow()},onRemove:function(){this.entity.off("childinsert",this._onChildInsert,this),this.entity.off("childremove",this._onChildRemove,this),this._listenForReflowEvents(this.entity,"off"),this.entity.children.forEach(function(t){this._listenForReflowEvents(t,"off")}.bind(this)),this.system.app.systems.element.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.element.off("beforeremove",this._onElementOrLayoutComponentRemove,this),this.system.app.systems.layoutchild.off("add",this._onElementOrLayoutComponentAdd,this),this.system.app.systems.layoutchild.off("beforeremove",this._onElementOrLayoutComponentRemove,this)}}),an("orientation"),an("reverseX"),an("reverseY"),an("alignment"),an("padding"),an("spacing"),an("widthFitting"),an("heightFitting"),an("wrap");var zd=["enabled"];hn.prototype=Object.create(os.prototype),hn.prototype.constructor=hn,as._buildAccessors(sn.prototype,zd),Object.assign(hn.prototype,{initializeComponentData:function(t,e,i){void 0!==e.enabled&&(t.enabled=e.enabled),void 0!==e.orientation&&(t.orientation=e.orientation),void 0!==e.reverseX&&(t.reverseX=e.reverseX),void 0!==e.reverseY&&(t.reverseY=e.reverseY),void 0!==e.alignment&&(e.alignment instanceof y?t.alignment.copy(e.alignment):t.alignment.set(e.alignment[0],e.alignment[1]),t.alignment=t.alignment),void 0!==e.padding&&(e.padding instanceof b?t.padding.copy(e.padding):t.padding.set(e.padding[0],e.padding[1],e.padding[2],e.padding[3]),t.padding=t.padding),void 0!==e.spacing&&(e.spacing instanceof y?t.spacing.copy(e.spacing):t.spacing.set(e.spacing[0],e.spacing[1]),t.spacing=t.spacing),void 0!==e.widthFitting&&(t.widthFitting=e.widthFitting),void 0!==e.heightFitting&&(t.heightFitting=e.heightFitting),void 0!==e.wrap&&(t.wrap=e.wrap),os.prototype.initializeComponentData.call(this,t,e,i)},cloneComponent:function(t,e){return t=t.layoutgroup,this.addComponent(e,{enabled:t.enabled,orientation:t.orientation,reverseX:t.reverseX,reverseY:t.reverseY,alignment:t.alignment,padding:t.padding,spacing:t.spacing,widthFitting:t.widthFitting,heightFitting:t.heightFitting,wrap:t.wrap})},scheduleReflow:function(t){-1===this._reflowQueue.indexOf(t)&&this._reflowQueue.push(t)},_onPostUpdate:function(){this._processReflowQueue()},_processReflowQueue:function(){if(0!==this._reflowQueue.length)for(var t=0;0<this._reflowQueue.length;){var e=this._reflowQueue.slice();this._reflowQueue.length=0,e.sort(function(t,e){return t.entity.graphDepth-e.entity.graphDepth});for(var i=0;i<e.length;++i)e[i].reflow();if(100<=++t){console.warn("Max reflow iterations limit reached, bailing.");break}}},_onRemoveComponent:function(t,e){e.onRemove()}});var Ud=new v,Vd=new v,jd=new v,Gd={r:0,g:1,b:2,a:3},Hd=function(){this._type=0,this._color=new o(.8,.8,.8),this._intensity=1,this.enabled=this._castShadows=!1,this.mask=1,this.isStatic=!1,this.key=0,this.bakeDir=!0,this.attenuationEnd=this.attenuationStart=10,this._shadowType=this._falloffMode=0,this._vsmBlurSize=11,this.vsmBlurMode=1,this.vsmBias=.0025,this._cookie=null,this.cookieIntensity=1,this._cookieFalloff=!0,this._cookieChannel="rgb",this._cookieTransform=null,this._cookieTransformUniform=new Float32Array(4),this._cookieOffset=null,this._cookieOffsetUniform=new Float32Array(2),this._cookieOffsetSet=this._cookieTransformSet=!1,this._innerConeAngle=40,this._outerConeAngle=45,this._finalColor=new Float32Array([.8,.8,.8]);var t=Math.pow(this._finalColor[0],2.2);this._linearFinalColor=new Float32Array([t,t,t]),this._position=new v(0,0,0),this._direction=new v(0,0,0),this._innerConeAngleCos=Math.cos(this._innerConeAngle*Math.PI/180),this._outerConeAngleCos=Math.cos(this._outerConeAngle*Math.PI/180),this._shadowCamera=null,this._shadowMatrix=new x,this.shadowDistance=40,this._shadowResolution=1024,this.shadowBias=-5e-4,this._normalOffsetBias=0,this.shadowUpdateMode=2,this._node=this._scene=null,this._rendererParams=[],this._isVsm=!1,this._isPcf=!0,this._isCachedShadowMap=this._cacheShadowMap=!1,this._visibleLength=[0],this._visibleList=[[]],this._visibleCameraSettings=[]};Object.assign(Hd.prototype,{destroy:function(){this._destroyShadowMap()},clone:function(){var t=new Hd;return t.type=this._type,t.setColor(this._color),t.intensity=this._intensity,t.castShadows=this.castShadows,t.enabled=this.enabled,t.attenuationStart=this.attenuationStart,t.attenuationEnd=this.attenuationEnd,t.falloffMode=this._falloffMode,t.shadowType=this._shadowType,t.vsmBlurSize=this._vsmBlurSize,t.vsmBlurMode=this.vsmBlurMode,t.vsmBias=this.vsmBias,t.shadowUpdateMode=this.shadowUpdateMode,t.mask=this.mask,t.innerConeAngle=this._innerConeAngle,t.outerConeAngle=this._outerConeAngle,t.shadowBias=this.shadowBias,t.normalOffsetBias=this._normalOffsetBias,t.shadowResolution=this._shadowResolution,t.shadowDistance=this.shadowDistance,t},getColor:function(){return this._color},getBoundingSphere:function(t){if(2===this._type){var e=this.attenuationEnd,i=this._outerConeAngle,s=Math.cos(i*oa.DEG_TO_RAD),n=this._node;Ud.copy(n.up),Ud.scale(.5*-e*s),Ud.add(n.getPosition()),t.center=Ud,Vd.copy(n.up),Vd.scale(-e),jd.copy(n.right),jd.scale(Math.sin(i*oa.DEG_TO_RAD)*e),Vd.add(jd),t.radius=.5*Vd.length()}else 1===this._type&&(t.center=this._node.getPosition(),t.radius=this.attenuationEnd)},getBoundingBox:function(t){if(2===this._type){var e=this.attenuationEnd,i=this._node,s=Math.abs(Math.sin(this._outerConeAngle*oa.DEG_TO_RAD)*e);t.center.set(0,.5*-e,0),t.halfExtents.set(s,.5*e,s),t.setFromTransformedAabb(t,i.getWorldTransform())}else 1===this._type&&(t.center.copy(this._node.getPosition()),t.halfExtents.set(this.attenuationEnd,this.attenuationEnd,this.attenuationEnd))},_updateFinalColor:function(){var t=this._color,e=t.r,i=t.g;t=t.b;var s=this._intensity,n=this._finalColor,r=this._linearFinalColor;n[0]=e*s,n[1]=i*s,n[2]=t*s,1<=s?(r[0]=Math.pow(e,2.2)*s,r[1]=Math.pow(i,2.2)*s,r[2]=Math.pow(t,2.2)*s):(r[0]=Math.pow(n[0],2.2),r[1]=Math.pow(n[1],2.2),r[2]=Math.pow(n[2],2.2))},setColor:function(){if(1===arguments.length)var t=arguments[0].r,e=arguments[0].g,i=arguments[0].b;else 3===arguments.length&&(t=arguments[0],e=arguments[1],i=arguments[2]);this._color.set(t,e,i),this._updateFinalColor()},_destroyShadowMap:function(){if(this._shadowCamera){if(!this._isCachedShadowMap){var t,e=this._shadowCamera.renderTarget;if(e)if(e.length)for(t=0;t<e.length;t++)e[t].colorBuffer&&e[t].colorBuffer.destroy(),e[t].destroy();else e.colorBuffer&&e.colorBuffer.destroy(),e.depthBuffer&&e.depthBuffer.destroy(),e.destroy()}this._shadowCubeMap=this._shadowCamera=this._shadowCamera.renderTarget=null,0===this.shadowUpdateMode&&(this.shadowUpdateMode=1)}},updateShadow:function(){2!==this.shadowUpdateMode&&(this.shadowUpdateMode=1)},updateKey:function(){var t=this._type<<29|(this._castShadows?1:0)<<28|this._shadowType<<25|this._falloffMode<<23|(0!==this._normalOffsetBias?1:0)<<22|(this._cookie?1:0)<<21|(this._cookieFalloff?1:0)<<20|Gd[this._cookieChannel.charAt(0)]<<18|(this._cookieTransform?1:0)<<12;3===this._cookieChannel.length&&(t|=Gd[this._cookieChannel.charAt(1)]<<16,t|=Gd[this._cookieChannel.charAt(2)]<<14),t!==this.key&&null!==this._scene&&(this._scene.layers._dirtyLights=!0),this.key=t}}),Object.defineProperty(Hd.prototype,"type",{get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,this._destroyShadowMap(),this.updateKey(),t=this._shadowType,this._shadowType=null,this.shadowType=t)}}),Object.defineProperty(Hd.prototype,"shadowType",{get:function(){return this._shadowType},set:function(t){if(this._shadowType!==t){var e=sr.getApplication().graphicsDevice;1===this._type&&(t=0),4!==t||e.webgl2||(t=0),3!==t||e.textureFloatRenderable||(t=2),2!==t||e.textureHalfFloatRenderable||(t=1),this._isVsm=1<=t&&3>=t,this._isPcf=4===t||0===t,this._shadowType=t,this._destroyShadowMap(),this.updateKey()}}}),Object.defineProperty(Hd.prototype,"castShadows",{get:function(){return this._castShadows&&4!==this.mask&&0!==this.mask},set:function(t){this._castShadows!==t&&(this._castShadows=t,this.updateKey())}}),Object.defineProperty(Hd.prototype,"shadowResolution",{get:function(){return this._shadowResolution},set:function(t){if(this._shadowResolution!==t){var e=sr.getApplication().graphicsDevice;this._shadowResolution=t=1===this._type?Math.min(t,e.maxCubeMapSize):Math.min(t,e.maxTextureSize)}}}),Object.defineProperty(Hd.prototype,"vsmBlurSize",{get:function(){return this._vsmBlurSize},set:function(t){this._vsmBlurSize!==t&&(0==t%2&&t++,this._vsmBlurSize=t)}}),Object.defineProperty(Hd.prototype,"normalOffsetBias",{get:function(){return this._normalOffsetBias},set:function(t){this._normalOffsetBias!==t&&((!this._normalOffsetBias&&t||this._normalOffsetBias&&!t)&&this.updateKey(),this._normalOffsetBias=t)}}),Object.defineProperty(Hd.prototype,"falloffMode",{get:function(){return this._falloffMode},set:function(t){this._falloffMode!==t&&(this._falloffMode=t,this.updateKey())}}),Object.defineProperty(Hd.prototype,"innerConeAngle",{get:function(){return this._innerConeAngle},set:function(t){this._innerConeAngle!==t&&(this._innerConeAngle=t,this._innerConeAngleCos=Math.cos(t*Math.PI/180))}}),Object.defineProperty(Hd.prototype,"outerConeAngle",{get:function(){return this._outerConeAngle},set:function(t){this._outerConeAngle!==t&&(this._outerConeAngle=t,this._outerConeAngleCos=Math.cos(t*Math.PI/180))}}),Object.defineProperty(Hd.prototype,"intensity",{get:function(){return this._intensity},set:function(t){this._intensity!==t&&(this._intensity=t,this._updateFinalColor())}}),Object.defineProperty(Hd.prototype,"cookie",{get:function(){return this._cookie},set:function(t){this._cookie!==t&&(this._cookie=t,this.updateKey())}}),Object.defineProperty(Hd.prototype,"cookieFalloff",{get:function(){return this._cookieFalloff},set:function(t){this._cookieFalloff!==t&&(this._cookieFalloff=t,this.updateKey())}}),Object.defineProperty(Hd.prototype,"cookieChannel",{get:function(){return this._cookieChannel},set:function(t){if(this._cookieChannel!==t){if(3>t.length)for(var e=t.charAt(t.length-1),i=3-t.length,s=0;s<i;s++)t+=e;this._cookieChannel=t,this.updateKey()}}}),Object.defineProperty(Hd.prototype,"cookieTransform",{get:function(){return this._cookieTransform},set:function(t){this._cookieTransform!==t&&(this._cookieTransform=t,this._cookieTransformSet=!!t,t&&!this._cookieOffset&&(this.cookieOffset=new y,this._cookieOffsetSet=!1),this.updateKey())}}),Object.defineProperty(Hd.prototype,"cookieOffset",{get:function(){return this._cookieOffset},set:function(t){this._cookieOffset!==t&&((this._cookieTransformSet||t)&&!t&&this._cookieOffset?this._cookieOffset.set(0,0):this._cookieOffset=t,this._cookieOffsetSet=!!t,t&&!this._cookieTransform&&(this.cookieTransform=new b(1,1,0,0),this._cookieTransformSet=!1),this.updateKey())}}),ln.prototype=Object.create(as.prototype),ln.prototype.constructor=ln;var Wd=[],Xd=[],qd=function(t,e,i,s){var n=ln.prototype;Wd.push(t),Xd.push(e),Object.defineProperty(n,t,{get:function(){return this.data[t]},set:function(e){var n=this.data,r=n[t];(s||r!==e)&&(n[t]=e,i&&i.call(this,e,r))},configurable:!0})};qd("enabled",!0,function(t,e){this.onSetEnabled(null,e,t)}),qd("light",null),qd("type","directional",function(t,e){this.system.changeType(this,e,t),this.refreshProperties()}),qd("color",new o(1,1,1),function(t,e){this.light.setColor(t)},!0),qd("intensity",1,function(t,e){this.light.intensity=t}),qd("castShadows",!1,function(t,e){this.light.castShadows=t}),qd("shadowDistance",40,function(t,e){this.light.shadowDistance=t}),qd("shadowResolution",1024,function(t,e){this.light.shadowResolution=t}),qd("shadowBias",.05,function(t,e){this.light.shadowBias=-.01*t}),qd("normalOffsetBias",0,function(t,e){this.light.normalOffsetBias=t}),qd("range",10,function(t,e){this.light.attenuationEnd=t}),qd("innerConeAngle",40,function(t,e){this.light.innerConeAngle=t}),qd("outerConeAngle",45,function(t,e){this.light.outerConeAngle=t}),qd("falloffMode",0,function(t,e){this.light.falloffMode=t}),qd("shadowType",0,function(t,e){this.light.shadowType=t}),qd("vsmBlurSize",11,function(t,e){this.light.vsmBlurSize=t}),qd("vsmBlurMode",1,function(t,e){this.light.vsmBlurMode=t}),qd("vsmBias",.0025,function(t,e){this.light.vsmBias=t}),qd("cookieAsset",null,function(t,e){this._cookieAssetId&&(t instanceof Fe&&t.id===this._cookieAssetId||t===this._cookieAssetId)||(this.onCookieAssetRemove(),this._cookieAssetId=null,t instanceof Fe?(this._cookieAssetId=this.data.cookieAsset=t.id,this.onCookieAssetAdd(t)):"number"==typeof t&&(this._cookieAssetId=t,(t=this.system.app.assets.get(t))?this.onCookieAssetAdd(t):(this._cookieAssetAdd=!0,this.system.app.assets.on("add:"+this._cookieAssetId,this.onCookieAssetAdd,this))))}),qd("cookie",null,function(t,e){this.light.cookie=t}),qd("cookieIntensity",1,function(t,e){this.light.cookieIntensity=t}),qd("cookieFalloff",!0,function(t,e){this.light.cookieFalloff=t}),qd("cookieChannel","rgb",function(t,e){this.light.cookieChannel=t}),qd("cookieAngle",0,function(t,e){if(0!==t||null!==this.cookieScale){this._cookieMatrix||(this._cookieMatrix=new b);var i=e=1;this.cookieScale&&(e=this.cookieScale.x,i=this.cookieScale.y);var s=Math.cos(t*oa.DEG_TO_RAD);t=Math.sin(t*oa.DEG_TO_RAD),this._cookieMatrix.set(s/e,-t/e,t/i,s/i),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null}),qd("cookieScale",null,function(t,e){if(null!==t||0!==this.cookieAngle){this._cookieMatrix||(this._cookieMatrix=new b),e=t.x,t=t.y;var i=Math.cos(this.cookieAngle*oa.DEG_TO_RAD),s=Math.sin(this.cookieAngle*oa.DEG_TO_RAD);this._cookieMatrix.set(i/e,-s/e,s/t,i/t),this.light.cookieTransform=this._cookieMatrix}else this.light.cookieTransform=null},!0),qd("cookieOffset",null,function(t,e){this.light.cookieOffset=t},!0),qd("shadowUpdateMode",2,function(t,e){this.light.shadowUpdateMode=t}),qd("mask",1,function(t,e){this.light.mask=t}),qd("affectDynamic",!0,function(t,e){this.light.mask=t?1|this.light.mask:-2&this.light.mask}),qd("affectLightmapped",!1,function(t,e){t?(this.light.mask|=2,this.bake&&(this.light.mask&=-5)):(this.light.mask&=-3,this.bake&&(this.light.mask|=4))}),qd("bake",!1,function(t,e){t?(this.light.mask|=4,this.affectLightmapped&&(this.light.mask&=-3)):(this.light.mask&=-5,this.affectLightmapped&&(this.light.mask|=2))}),qd("bakeDir",!0,function(t,e){this.light.bakeDir=t}),qd("isStatic",!1,function(t,e){this.light.isStatic=t}),qd("layers",[0],function(t,e){var i,s;for(i=0;i<e.length;i++)(s=this.system.app.scene.layers.getLayerById(e[i]))&&s.removeLight(this);for(i=0;i<t.length;i++)(s=this.system.app.scene.layers.getLayerById(t[i]))&&this.enabled&&this.entity.enabled&&s.addLight(this)}),Object.assign(ln.prototype,{addLightToLayers:function(){for(var t,e=0;e<this.layers.length;e++)(t=this.system.app.scene.layers.getLayerById(this.layers[e]))&&t.addLight(this)},removeLightFromLayers:function(){for(var t,e=0;e<this.layers.length;e++)(t=this.system.app.scene.layers.getLayerById(this.layers[e]))&&t.removeLight(this)},onLayersChanged:function(t,e){this.enabled&&this.entity.enabled&&this.addLightToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(t){0>this.layers.indexOf(t.id)||this.enabled&&this.entity.enabled&&t.addLight(this)},onLayerRemoved:function(t){0>this.layers.indexOf(t.id)||t.removeLight(this)},refreshProperties:function(){for(var t,e=0;e<Wd.length;e++)this[t=Wd[e]]=this[t];this.enabled&&this.entity.enabled&&this.onEnable()},updateShadow:function(){this.light.updateShadow()},onCookieAssetSet:function(){var t=!1;"cubemap"!==this._cookieAsset.type||this._cookieAsset.loadFaces||(t=this._cookieAsset.loadFaces=!0),this._cookieAsset.resource&&!t||this.system.app.assets.load(this._cookieAsset),this._cookieAsset.resource&&this.onCookieAssetLoad()},onCookieAssetAdd:function(t){this._cookieAssetId===t.id&&(this._cookieAsset=t,this.light.enabled&&this.onCookieAssetSet(),this._cookieAsset.on("load",this.onCookieAssetLoad,this),this._cookieAsset.on("remove",this.onCookieAssetRemove,this))},onCookieAssetLoad:function(){this._cookieAsset&&this._cookieAsset.resource&&(this.cookie=this._cookieAsset.resource)},onCookieAssetRemove:function(){this._cookieAssetId&&(this._cookieAssetAdd&&(this.system.app.assets.off("add:"+this._cookieAssetId,this.onCookieAssetAdd,this),this._cookieAssetAdd=!1),this._cookieAsset&&(this._cookieAsset.off("load",this.onCookieAssetLoad,this),this._cookieAsset.off("remove",this.onCookieAssetRemove,this),this._cookieAsset=null),this.cookie=null)},onEnable:function(){this.light.enabled=!0,this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&this.addLightToLayers(),this._cookieAsset&&!this.cookie&&this.onCookieAssetSet()},onDisable:function(){this.light.enabled=!1,this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.removeLightFromLayers()},onRemove:function(){this.light.destroy(),this.cookieAsset=null}});var Yd=Wd,Kd=Xd,$d={directional:0,point:1,spot:2};dn.prototype=Object.create(os.prototype),dn.prototype.constructor=dn,Object.assign(dn.prototype,{initializeComponentData:function(t,e){for(var i=Yd,s={},n=0,r=i.length;n<r;n++){var a=i[n];s[a]=e[a]}s.type||(s.type=t.data.type),t.data.type=s.type,s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0)),s.color&&Array.isArray(s.color)&&(s.color=new o(s.color[0],s.color[1],s.color[2])),s.cookieOffset&&s.cookieOffset instanceof Array&&(s.cookieOffset=new y(s.cookieOffset[0],s.cookieOffset[1])),s.cookieScale&&s.cookieScale instanceof Array&&(s.cookieScale=new y(s.cookieScale[0],s.cookieScale[1])),s.enable&&(console.warn("WARNING: enable: Property is deprecated. Set enabled property instead."),s.enabled=s.enable),(e=new Hd).type=$d[s.type],e._node=t.entity,e._scene=this.app.scene,t.data.light=e,os.prototype.initializeComponentData.call(this,t,s,i)},_onRemoveComponent:function(t,e){e.onRemove()},cloneComponent:function(t,e){t=t.light;for(var i,s=[],n=Yd,r=0;r<n.length;r++)"light"!==(i=n[r])&&(s[i]=t[i]&&t[i].clone?t[i].clone():t[i]);this.addComponent(e,s)},changeType:function(t,e,i){e!==i&&(t.light.type=$d[i])}}),un.prototype=Object.create(as.prototype),un.prototype.constructor=un,Object.assign(un.prototype,{addModelToLayers:function(){for(var t,e=this.system.app.scene.layers,i=0;i<this._layers.length;i++)(t=e.getLayerById(this._layers[i]))&&t.addMeshInstances(this.meshInstances)},removeModelFromLayers:function(){for(var t,e=this.system.app.scene.layers,i=0;i<this._layers.length;i++)(t=e.getLayerById(this._layers[i]))&&t.removeMeshInstances(this.meshInstances)},onRemoveChild:function(){this._model&&this.removeModelFromLayers()},onInsertChild:function(){this._model&&this.enabled&&this.entity.enabled&&this.addModelToLayers()},onRemove:function(){"asset"===this.type?this.asset=null:this.model=null,this.materialAsset=null,this._unsetMaterialEvents(),this.entity.off("remove",this.onRemoveChild,this),this.entity.off("insert",this.onInsertChild,this)},onLayersChanged:function(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(t){0>this.layers.indexOf(t.id)||t.addMeshInstances(this.meshInstances)},onLayerRemoved:function(t){0>this.layers.indexOf(t.id)||t.removeMeshInstances(this.meshInstances)},_setMaterialEvent:function(t,e,i,s){e=e+":"+i,this.system.app.assets.on(e,s,this),this._materialEvents||(this._materialEvents=[]),this._materialEvents[t]||(this._materialEvents[t]={}),this._materialEvents[t][e]={id:i,handler:s}},_unsetMaterialEvents:function(){var t=this.system.app.assets,e=this._materialEvents;if(e){for(var i=0,s=e.length;i<s;i++)if(e[i]){var n,r=e[i];for(n in r)t.off(n,r[n].handler,this)}this._materialEvents=null}},_getAssetByIdOrPath:function(t){var e=null;return isNaN(parseInt(t,10))?this.asset&&(t=this._getMaterialAssetUrl(t))&&(e=this.system.app.assets.getByUrl(t)):e=this.system.app.assets.get(t),e},_getMaterialAssetUrl:function(t){if(!this.asset)return null;var e=this.system.app.assets.get(this.asset);return e?e.getAbsoluteUrl(t):null},_loadAndSetMeshInstanceMaterial:function(t,e,i){var s=this.system.app.assets;t&&(t.resource?(e.material=t.resource,this._setMaterialEvent(i,"remove",t.id,function(){e.material=this.system.defaultMaterial})):(this._setMaterialEvent(i,"load",t.id,function(s){e.material=s.resource,this._setMaterialEvent(i,"remove",t.id,function(){e.material=this.system.defaultMaterial})}),this.enabled&&this.entity.enabled&&s.load(t)))},onEnable:function(){var t,e=this.system.app,i=e.scene;if(i.on("set:layers",this.onLayersChanged,this),i.layers&&(i.layers.on("add",this.onLayerAdded,this),i.layers.on("remove",this.onLayerRemoved,this)),i="asset"===this._type,this._model?this.addModelToLayers():i&&this._asset&&(t=e.assets.get(this._asset))&&t.resource!==this._model&&this._bindModelAsset(t),this._materialAsset&&(t=e.assets.get(this._materialAsset))&&t.resource!==this._material&&this._bindMaterialAsset(t),i&&this._mapping)for(var s in this._mapping)this._mapping[s]&&(t=this._getAssetByIdOrPath(this._mapping[s]))&&!t.resource&&e.assets.load(t);0<=this._batchGroupId&&e.batcher.insert(gt.MODEL,this.batchGroupId,this.entity)},onDisable:function(){var t=this.system.app,e=t.scene;e.off("set:layers",this.onLayersChanged,this),e.layers&&(e.layers.off("add",this.onLayerAdded,this),e.layers.off("remove",this.onLayerRemoved,this)),0<=this._batchGroupId&&t.batcher.remove(gt.MODEL,this.batchGroupId,this.entity),this._model&&this.removeModelFromLayers()},hide:function(){if(this._model){var t,e=this._model.meshInstances,i=0;for(t=e.length;i<t;i++)e[i].visible=!1}},show:function(){if(this._model){var t,e=this._model.meshInstances,i=0;for(t=e.length;i<t;i++)e[i].visible=!0}},_bindMaterialAsset:function(t){t.on("load",this._onMaterialAssetLoad,this),t.on("unload",this._onMaterialAssetUnload,this),t.on("remove",this._onMaterialAssetRemove,this),t.on("change",this._onMaterialAssetChange,this),t.resource?this._onMaterialAssetLoad(t):this.enabled&&this.entity.enabled&&this.system.app.assets.load(t)},_unbindMaterialAsset:function(t){t.off("load",this._onMaterialAssetLoad,this),t.off("unload",this._onMaterialAssetUnload,this),t.off("remove",this._onMaterialAssetRemove,this),t.off("change",this._onMaterialAssetChange,this)},_onMaterialAssetAdd:function(t){this.system.app.assets.off("add:"+t.id,this._onMaterialAssetAdd,this),this._materialAsset===t.id&&this._bindMaterialAsset(t)},_onMaterialAssetLoad:function(t){this._setMaterial(t.resource)},_onMaterialAssetUnload:function(t){this._setMaterial(this.system.defaultMaterial)},_onMaterialAssetRemove:function(t){this._onMaterialAssetUnload(t)},_onMaterialAssetChange:function(t){},_bindModelAsset:function(t){this._unbindModelAsset(t),t.on("load",this._onModelAssetLoad,this),t.on("unload",this._onModelAssetUnload,this),t.on("change",this._onModelAssetChange,this),t.on("remove",this._onModelAssetRemove,this),t.resource?this._onModelAssetLoad(t):this.enabled&&this.entity.enabled&&this.system.app.assets.load(t)},_unbindModelAsset:function(t){t.off("load",this._onModelAssetLoad,this),t.off("unload",this._onModelAssetUnload,this),t.off("change",this._onModelAssetChange,this),t.off("remove",this._onModelAssetRemove,this)},_onModelAssetAdded:function(t){this.system.app.assets.off("add:"+t.id,this._onModelAssetAdd,this),t.id===this._asset&&this._bindModelAsset(t)},_onModelAssetLoad:function(t){this.model=t.resource.clone(),this._clonedModel=!0},_onModelAssetUnload:function(t){this.model=null},_onModelAssetChange:function(t,e,i,s){"data"===e&&(this.mapping=this._mapping)},_onModelAssetRemove:function(t){this.model=null},_setMaterial:function(t){if(this._material!==t){this._material=t;var e=this._model;if(e&&"asset"!==this._type)for(var i=0,s=(e=e.meshInstances).length;i<s;i++)e[i].material=t}}}),Object.defineProperty(un.prototype,"meshInstances",{get:function(){return this._model?this._model.meshInstances:null},set:function(t){this._model&&(this._model.meshInstances=t)}}),Object.defineProperty(un.prototype,"type",{get:function(){return this._type},set:function(t){if(this._type!==t)if(this._area=null,this._type=t,"asset"===t)null!==this._asset?this._bindModelAsset(this._asset):this.model=null;else{var e=this.system,i=e.app.graphicsDevice;switch(t){case"box":e.box||(e.box=le(i,{halfExtents:new v(.5,.5,.5)})),t=e.box,this._area={x:2,y:2,z:2,uv:2/3};break;case"capsule":e.capsule||(e.capsule=re(i,{radius:.5,height:2})),t=e.capsule,this._area={x:2*Math.PI,y:Math.PI,z:2*Math.PI,uv:1/3+1/3/3*2};break;case"cone":e.cone||(e.cone=ae(i,{baseRadius:.5,peakRadius:0,height:1})),t=e.cone,this._area={x:2.54,y:2.54,z:2.54,uv:1/3+1/3/3};break;case"cylinder":e.cylinder||(e.cylinder=ne(i,{radius:.5,height:1})),t=e.cylinder,this._area={x:Math.PI,y:1.58,z:Math.PI,uv:1/3+1/3/3*2};break;case"plane":e.plane||(e.plane=he(i,{halfExtents:new y(.5,.5),widthSegments:1,lengthSegments:1})),t=e.plane,this._area={x:0,y:1,z:0,uv:1};break;case"sphere":e.sphere||(e.sphere=oe(i,{radius:.5})),t=e.sphere,this._area={x:Math.PI,y:Math.PI,z:Math.PI,uv:1};break;default:throw Error("Invalid model type: "+t)}i=new Mt;var s=new mt;s.graph=i,s.meshInstances=[new lt(i,t,this._material)],e._inTools&&s.generateWireframe(),this.model=s,this._asset=null}}}),Object.defineProperty(un.prototype,"asset",{get:function(){return this._asset},set:function(t){var e=this.system.app.assets,i=t;t instanceof Fe&&(i=t.id),this._asset!==i&&(this._asset&&(e.off("add:"+this._asset,this._onModelAssetAdded,this),(t=e.get(this._asset))&&this._unbindModelAsset(t)),(this._asset=i)?(i=e.get(this._asset))?this._bindModelAsset(i):(this.model=null,e.on("add:"+this._asset,this._onModelAssetAdded,this)):this.model=null)}}),Object.defineProperty(un.prototype,"model",{get:function(){return this._model},set:function(t){if(!(this._model===t||t&&t._immutable)&&(this._model&&(this._model._immutable=!1,this.removeModelFromLayers(),this.entity.removeChild(this._model.getGraph()),delete this._model._entity,this._clonedModel&&(this._model.destroy(),this._clonedModel=!1)),this._model=t)){this._model._immutable=!0;var e=this._model.meshInstances;for(t=0;t<e.length;t++)e[t].castShadow=this._castShadows,e[t].receiveShadow=this._receiveShadows,e[t].isStatic=this._isStatic;this.lightmapped=this._lightmapped,this.entity.addChild(this._model.graph),this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._model._entity=this.entity,this.entity.animation&&this.entity.animation.setModel(this._model),this.entity.anim&&this.entity.anim.resetStateGraph(),"asset"===this.type?this.mapping=this._mapping:this._unsetMaterialEvents()}}}),Object.defineProperty(un.prototype,"lightmapped",{get:function(){return this._lightmapped},set:function(t){if(t!==this._lightmapped&&(this._lightmapped=t,this._model)){var e=this._model.meshInstances;if(t)for(t=0;t<e.length;t++){var i=e[t],s=i.mask;i.mask=-6&(2|s)}else for(t=0;t<e.length;t++)(i=e[t]).deleteParameter("texture_lightMap"),i.deleteParameter("texture_dirLightMap"),i._shaderDefs&=-65,s=i.mask,i.mask=-7&(1|s)}}}),Object.defineProperty(un.prototype,"castShadows",{get:function(){return this._castShadows},set:function(t){if(this._castShadows!==t){var e,i,s=this._model;if(s){var n=this.layers,r=this.system.app.scene;if(this._castShadows&&!t)for(i=0;i<n.length;i++)(e=this.system.app.scene.layers.getLayerById(this.layers[i]))&&e.removeShadowCasters(s.meshInstances);for(e=s.meshInstances,i=0;i<e.length;i++)e[i].castShadow=t;if(!this._castShadows&&t)for(i=0;i<n.length;i++)(e=r.layers.getLayerById(n[i]))&&e.addShadowCasters(s.meshInstances)}this._castShadows=t}}}),Object.defineProperty(un.prototype,"receiveShadows",{get:function(){return this._receiveShadows},set:function(t){if(this._receiveShadows!==t&&(this._receiveShadows=t,this._model))for(var e=this._model.meshInstances,i=0,s=e.length;i<s;i++)e[i].receiveShadow=t}}),Object.defineProperty(un.prototype,"castShadowsLightmap",{get:function(){return this._castShadowsLightmap},set:function(t){this._castShadowsLightmap=t}}),Object.defineProperty(un.prototype,"lightmapSizeMultiplier",{get:function(){return this._lightmapSizeMultiplier},set:function(t){this._lightmapSizeMultiplier=t}}),Object.defineProperty(un.prototype,"isStatic",{get:function(){return this._isStatic},set:function(t){var e;if(this._isStatic!==t&&(this._isStatic=t,this._model)){var i=this._model.meshInstances;for(e=0;e<i.length;e++){i[e].isStatic=t}}}}),Object.defineProperty(un.prototype,"layers",{get:function(){return this._layers},set:function(t){var e,i,s=this.system.app.scene.layers;if(this.meshInstances)for(e=0;e<this._layers.length;e++)(i=s.getLayerById(this._layers[e]))&&i.removeMeshInstances(this.meshInstances);for(e=this._layers.length=0;e<t.length;e++)this._layers[e]=t[e];if(this.enabled&&this.entity.enabled&&this.meshInstances)for(e=0;e<this._layers.length;e++)(i=s.getLayerById(this._layers[e]))&&i.addMeshInstances(this.meshInstances)}}),Object.defineProperty(un.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(t){if(this._batchGroupId!==t){var e=this.system.app.batcher;this.entity.enabled&&0<=this._batchGroupId&&e.remove(gt.MODEL,this.batchGroupId,this.entity),this.entity.enabled&&0<=t&&e.insert(gt.MODEL,t,this.entity),0>t&&0<=this._batchGroupId&&this.enabled&&this.entity.enabled&&this.addModelToLayers(),this._batchGroupId=t}}}),Object.defineProperty(un.prototype,"materialAsset",{get:function(){return this._materialAsset},set:function(t){var e=t;if(t instanceof Fe&&(e=t.id),t=this.system.app.assets,e!==this._materialAsset){if(this._materialAsset){t.off("add:"+this._materialAsset,this._onMaterialAssetAdd,this);var i=t.get(this._materialAsset);i&&this._unbindMaterialAsset(i)}(this._materialAsset=e)?(e=t.get(this._materialAsset))?this._bindMaterialAsset(e):(this._setMaterial(this.system.defaultMaterial),t.on("add:"+this._materialAsset,this._onMaterialAssetAdd,this)):this._setMaterial(this.system.defaultMaterial)}}}),Object.defineProperty(un.prototype,"material",{get:function(){return this._material},set:function(t){this._material!==t&&(this.materialAsset=null,this._setMaterial(t))}}),Object.defineProperty(un.prototype,"mapping",{get:function(){return this._mapping},set:function(t){if("asset"===this._type&&(this._unsetMaterialEvents(),t||(t={}),this._mapping=t,this._model)){var e=this._model.meshInstances,i=this.asset?this.system.app.assets.get(this.asset):null;i=i?i.data.mapping:null;for(var s=null,n=0,r=e.length;n<r;n++)if(void 0!==t[n])t[n]?(s=this.system.app.assets.get(t[n]),this._loadAndSetMeshInstanceMaterial(s,e[n],n)):e[n].material=this.system.defaultMaterial;else if(i)if(i[n]&&(i[n].material||i[n].path)){if(void 0!==i[n].material)s=this.system.app.assets.get(i[n].material);else if(void 0!==i[n].path){var a=this._getMaterialAssetUrl(i[n].path);a&&(s=this.system.app.assets.getByUrl(a))}this._loadAndSetMeshInstanceMaterial(s,e[n],n)}else e[n].material=this.system.defaultMaterial}}});var Zd=["enabled"];fn.prototype=Object.create(os.prototype),fn.prototype.constructor=fn,as._buildAccessors(un.prototype,Zd),Object.assign(fn.prototype,{initializeComponentData:function(t,e,i){i="material materialAsset asset castShadows receiveShadows castShadowsLightmap lightmapped lightmapSizeMultiplier type mapping layers isStatic batchGroupId".split(" "),null!==e.batchGroupId&&void 0!==e.batchGroupId||(e.batchGroupId=-1),e.layers&&e.layers.length&&(e.layers=e.layers.slice(0));for(var s=0;s<i.length;s++)e.hasOwnProperty(i[s])&&(t[i[s]]=e[i[s]]);os.prototype.initializeComponentData.call(this,t,e,["enabled"])},cloneComponent:function(t,e){var s={type:t.model.type,asset:t.model.asset,castShadows:t.model.castShadows,receiveShadows:t.model.receiveShadows,castShadowsLightmap:t.model.castShadowsLightmap,lightmapped:t.model.lightmapped,lightmapSizeMultiplier:t.model.lightmapSizeMultiplier,isStatic:t.model.isStatic,enabled:t.model.enabled,layers:t.model.layers,batchGroupId:t.model.batchGroupId,mapping:i({},t.model.mapping)},n=t.model.materialAsset;n instanceof Fe||null==n||(n=this.app.assets.get(n));var r=t.model.material;if(r&&r!==this.defaultMaterial&&n&&r!==n.resource||(s.materialAsset=n),e=this.addComponent(e,s),t.model.model&&"asset"===t.model.type&&!t.model.asset&&(e.model=t.model.model.clone(),e._clonedModel=!0),s.materialAsset||(e.material=r),t.model.model)for(t=t.model.model.meshInstances,s=e.model.meshInstances,r=0;r<t.length;r++)s[r].mask=t[r].mask,s[r].material=t[r].material,s[r].layer=t[r].layer,s[r].receiveShadow=t[r].receiveShadow},onRemove:function(t,e){e.onRemove()}});var Qd,Jd="emitterExtents emitterRadius emitterExtentsInner emitterRadiusInner loop initialVelocity animSpeed normalMap particleNormal".split(" "),tu="numParticles lifetime rate rate2 startAngle startAngle2 lighting halfLambert intensity wrap wrapBounds depthWrite noFog sort stretch alignToMotion preWarm emitterShape animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animLoop colorMap localSpace screenSpace orientation".split(" "),eu="scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 velocityGraph velocityGraph2 localVelocityGraph localVelocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2".split(" "),iu=["colorMapAsset","normalMapAsset","meshAsset"],su=function(t,e){as.call(this,t,e),this.on("set_colorMapAsset",this.onSetColorMapAsset,this),this.on("set_normalMapAsset",this.onSetNormalMapAsset,this),this.on("set_meshAsset",this.onSetMeshAsset,this),this.on("set_mesh",this.onSetMesh,this),this.on("set_loop",this.onSetLoop,this),this.on("set_blendType",this.onSetBlendType,this),this.on("set_depthSoftening",this.onSetDepthSoftening,this),this.on("set_layers",this.onSetLayers,this),Jd.forEach(function(t){this.on("set_"+t,this.onSetSimpleProperty,this)}.bind(this)),tu.forEach(function(t){this.on("set_"+t,this.onSetComplexProperty,this)}.bind(this)),eu.forEach(function(t){this.on("set_"+t,this.onSetGraphProperty,this)}.bind(this)),this._requestedDepth=!1,this._drawOrder=0};su.prototype=Object.create(as.prototype),su.prototype.constructor=su,Object.defineProperties(su.prototype,{drawOrder:{get:function(){return this._drawOrder},set:function(t){this._drawOrder=t,this.emitter&&(this.emitter.drawOrder=t)}}}),Object.assign(su.prototype,{addModelToLayers:function(){if(this.data.model)for(var t,e=0;e<this.layers.length;e++)(t=this.system.app.scene.layers.getLayerById(this.layers[e]))&&(t.addMeshInstances(this.data.model.meshInstances),this.emitter._layer=t)},removeModelFromLayers:function(t){if(this.data.model)for(var e=0;e<this.layers.length;e++)(t=this.system.app.scene.layers.getLayerById(this.layers[e]))&&t.removeMeshInstances(this.data.model.meshInstances)},onSetLayers:function(t,e,i){if(this.data.model){var s;for(t=0;t<e.length;t++)(s=this.system.app.scene.layers.getLayerById(e[t]))&&s.removeMeshInstances(this.data.model.meshInstances);if(this.enabled&&this.entity.enabled)for(t=0;t<i.length;t++)(s=this.system.app.scene.layers.getLayerById(i[t]))&&s.addMeshInstances(this.data.model.meshInstances)}},onLayersChanged:function(t,e){this.addModelToLayers(),t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this)},onLayerAdded:function(t){this.data.model&&(0>this.layers.indexOf(t.id)||t.addMeshInstances(this.data.model.meshInstances))},onLayerRemoved:function(t){this.data.model&&(0>this.layers.indexOf(t.id)||t.removeMeshInstances(this.data.model.meshInstances))},_bindColorMapAsset:function(t){t.on("load",this._onColorMapAssetLoad,this),t.on("unload",this._onColorMapAssetUnload,this),t.on("remove",this._onColorMapAssetRemove,this),t.on("change",this._onColorMapAssetChange,this),t.resource?this._onColorMapAssetLoad(t):this.enabled&&this.entity.enabled&&this.system.app.assets.load(t)},_unbindColorMapAsset:function(t){t.off("load",this._onColorMapAssetLoad,this),t.off("unload",this._onColorMapAssetUnload,this),t.off("remove",this._onColorMapAssetRemove,this),t.off("change",this._onColorMapAssetChange,this)},_onColorMapAssetLoad:function(t){this.colorMap=t.resource},_onColorMapAssetUnload:function(t){this.colorMap=null},_onColorMapAssetRemove:function(t){this._onColorMapAssetUnload(t)},_onColorMapAssetChange:function(t){},onSetColorMapAsset:function(t,e,i){var s=this;t=this.system.app.assets,e&&(e=t.get(e))&&this._unbindColorMapAsset(e),i?(i instanceof Fe&&(i=this.data.colorMapAsset=i.id),(e=t.get(i))?s._bindColorMapAsset(e):t.once("add:"+i,function(t){s._bindColorMapAsset(t)})):this.colorMap=null},_bindNormalMapAsset:function(t){t.on("load",this._onNormalMapAssetLoad,this),t.on("unload",this._onNormalMapAssetUnload,this),t.on("remove",this._onNormalMapAssetRemove,this),t.on("change",this._onNormalMapAssetChange,this),t.resource?this._onNormalMapAssetLoad(t):this.enabled&&this.entity.enabled&&this.system.app.assets.load(t)},_unbindNormalMapAsset:function(t){t.off("load",this._onNormalMapAssetLoad,this),t.off("unload",this._onNormalMapAssetUnload,this),t.off("remove",this._onNormalMapAssetRemove,this),t.off("change",this._onNormalMapAssetChange,this)},_onNormalMapAssetLoad:function(t){this.normalMap=t.resource},_onNormalMapAssetUnload:function(t){this.normalMap=null},_onNormalMapAssetRemove:function(t){this._onNormalMapAssetUnload(t)},_onNormalMapAssetChange:function(t){},onSetNormalMapAsset:function(t,e,i){var s=this;t=this.system.app.assets,e&&(e=t.get(e))&&this._unbindNormalMapAsset(e),i?(i instanceof Fe&&(i=this.data.normalMapAsset=i.id),(e=t.get(i))?s._bindNormalMapAsset(e):t.once("add:"+i,function(t){s._bindNormalMapAsset(t)})):this.normalMap=null},_bindMeshAsset:function(t){t.on("load",this._onMeshAssetLoad,this),t.on("unload",this._onMeshAssetUnload,this),t.on("remove",this._onMeshAssetRemove,this),t.on("change",this._onMeshAssetChange,this),t.resource?this._onMeshAssetLoad(t):this.enabled&&this.entity.enabled&&this.system.app.assets.load(t)},_unbindMeshAsset:function(t){t.off("load",this._onMeshAssetLoad,this),t.off("unload",this._onMeshAssetUnload,this),t.off("remove",this._onMeshAssetRemove,this),t.off("change",this._onMeshAssetChange,this)},_onMeshAssetLoad:function(t){this._onMeshChanged(t.resource)},_onMeshAssetUnload:function(t){this.mesh=null},_onMeshAssetRemove:function(t){this._onMeshAssetUnload(t)},_onMeshAssetChange:function(t){},onSetMeshAsset:function(t,e,i){t=this.system.app.assets,e&&(e=t.get(e))&&this._unbindMeshAsset(e),i?(i instanceof Fe&&(i=this.data.meshAsset=i.id),(e=t.get(i))&&(this._bindMeshAsset(e),e.resource?this._onMeshChanged(e.resource):t.load(e))):this._onMeshChanged(null)},onSetMesh:function(t,e,i){!i||i instanceof Fe||"number"==typeof i?this.meshAsset=i:this._onMeshChanged(i)},_onMeshChanged:function(t){!t||t instanceof ht||(t=t.meshInstances[0]?t.meshInstances[0].mesh:null),this.data.mesh=t,this.emitter&&(this.emitter.mesh=t,this.emitter.resetMaterial(),this.rebuild())},onSetLoop:function(t,e,i){this.emitter&&(this.emitter[t]=i,this.emitter.resetTime())},onSetBlendType:function(t,e,i){this.emitter&&(this.emitter[t]=i,this.emitter.material.blendType=i,this.emitter.resetMaterial(),this.rebuild())},_requestDepth:function(){this._requestedDepth||(Qd||(Qd=this.system.app.scene.layers.getLayerById(1)),Qd&&(Qd.incrementCounter(),this._requestedDepth=!0))},_releaseDepth:function(){this._requestedDepth&&Qd&&(Qd.decrementCounter(),this._requestedDepth=!1)},onSetDepthSoftening:function(t,e,i){e!==i&&(i?this.enabled&&this.entity.enabled&&this._requestDepth():this.enabled&&this.entity.enabled&&this._releaseDepth(),this.emitter&&(this.emitter[t]=i),this.emitter&&(this.reset(),this.emitter.resetMaterial(),this.rebuild()))},onSetSimpleProperty:function(t,e,i){this.emitter&&(this.emitter[t]=i,this.emitter.resetMaterial())},onSetComplexProperty:function(t,e,i){this.emitter&&(this.emitter[t]=i,this.emitter.resetMaterial(),this.rebuild(),this.reset())},onSetGraphProperty:function(t,e,i){this.emitter&&(this.emitter[t]=i,this.emitter.rebuildGraphs(),this.emitter.resetMaterial())},onEnable:function(){for(var t=this.data,e=0,i=iu.length;e<i;e++){var s=t[iu[e]];if(s){if(!(s instanceof Fe)){if(!(0<=parseInt(s,10)))continue;s=this.system.app.assets.get(s)}s&&!s.resource&&this.system.app.assets.load(s)}}this.emitter||((e=t.mesh)instanceof ht||(e=null),this.emitter=new tl(this.system.app.graphicsDevice,{numParticles:t.numParticles,emitterExtents:t.emitterExtents,emitterExtentsInner:t.emitterExtentsInner,emitterRadius:t.emitterRadius,emitterRadiusInner:t.emitterRadiusInner,emitterShape:t.emitterShape,initialVelocity:t.initialVelocity,wrap:t.wrap,localSpace:t.localSpace,screenSpace:t.screenSpace,wrapBounds:t.wrapBounds,lifetime:t.lifetime,rate:t.rate,rate2:t.rate2,orientation:t.orientation,particleNormal:t.particleNormal,animTilesX:t.animTilesX,animTilesY:t.animTilesY,animStartFrame:t.animStartFrame,animNumFrames:t.animNumFrames,animNumAnimations:t.animNumAnimations,animIndex:t.animIndex,randomizeAnimIndex:t.randomizeAnimIndex,animSpeed:t.animSpeed,animLoop:t.animLoop,startAngle:t.startAngle,startAngle2:t.startAngle2,scaleGraph:t.scaleGraph,scaleGraph2:t.scaleGraph2,colorGraph:t.colorGraph,colorGraph2:t.colorGraph2,alphaGraph:t.alphaGraph,alphaGraph2:t.alphaGraph2,localVelocityGraph:t.localVelocityGraph,localVelocityGraph2:t.localVelocityGraph2,velocityGraph:t.velocityGraph,velocityGraph2:t.velocityGraph2,rotationSpeedGraph:t.rotationSpeedGraph,rotationSpeedGraph2:t.rotationSpeedGraph2,radialSpeedGraph:t.radialSpeedGraph,radialSpeedGraph2:t.radialSpeedGraph2,colorMap:t.colorMap,normalMap:t.normalMap,loop:t.loop,preWarm:t.preWarm,sort:t.sort,stretch:t.stretch,alignToMotion:t.alignToMotion,lighting:t.lighting,halfLambert:t.halfLambert,intensity:t.intensity,depthSoftening:t.depthSoftening,scene:this.system.app.scene,mesh:e,depthWrite:t.depthWrite,noFog:t.noFog,node:this.entity,blendType:t.blendType}),this.emitter.meshInstance.node=this.entity,this.emitter.drawOrder=this.drawOrder,this.psys=new mt,this.psys.graph=this.entity,this.psys.emitter=this.emitter,this.psys.meshInstances=[this.emitter.meshInstance],t.model=this.psys,this.emitter.psys=this.psys,t.autoPlay||(this.pause(),this.emitter.meshInstance.visible=!1)),t.model&&this.emitter.colorMap&&this.addModelToLayers(),this.system.app.scene.on("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.on("add",this.onLayerAdded,this),this.system.app.scene.layers.on("remove",this.onLayerRemoved,this)),this.enabled&&this.entity.enabled&&t.depthSoftening&&this._requestDepth()},onDisable:function(){this.system.app.scene.off("set:layers",this.onLayersChanged,this),this.system.app.scene.layers&&(this.system.app.scene.layers.off("add",this.onLayerAdded,this),this.system.app.scene.layers.off("remove",this.onLayerRemoved,this)),this.data.model&&(this.removeModelFromLayers(),this.data.depthSoftening&&this._releaseDepth()),this.emitter&&(this.emitter.camera=null)},onBeforeRemove:function(){this.enabled&&(this.enabled=!1);var t=this.data;t.model&&(this.entity.removeChild(t.model.getGraph()),t.model.destroy(),t.model=null),this.emitter&&(this.emitter.destroy(),this.emitter=null);for(var e=0;e<iu.length;e++){var i=iu[e];t[i]&&(this[i]=null)}this.off()},reset:function(){this.emitter&&this.emitter.reset()},stop:function(){this.emitter&&(this.emitter.loop=!1,this.emitter.resetTime(),this.emitter.addTime(0,!0))},pause:function(){this.data.paused=!0},unpause:function(){this.data.paused=!1},play:function(){this.data.paused=!1,this.emitter&&(this.emitter.meshInstance.visible=!0,this.emitter.loop=this.data.loop,this.emitter.resetTime())},isPlaying:function(){return!this.data.paused&&(!(!this.emitter||!this.emitter.loop)||Date.now()<=this.emitter.endTime)},rebuild:function(){var t=this.enabled;this.enabled=!1,this.emitter&&(this.emitter.rebuild(),this.emitter.meshInstance.node=this.entity,this.data.model.meshInstances=[this.emitter.meshInstance]),this.enabled=t}});var nu,ru,au,ou,hu,lu="enabled autoPlay numParticles lifetime rate rate2 startAngle startAngle2 loop preWarm lighting halfLambert intensity depthWrite noFog depthSoftening sort blendType stretch alignToMotion emitterShape emitterExtents emitterExtentsInner emitterRadius emitterRadiusInner initialVelocity wrap wrapBounds localSpace screenSpace colorMapAsset normalMapAsset mesh meshAsset orientation particleNormal localVelocityGraph localVelocityGraph2 velocityGraph velocityGraph2 rotationSpeedGraph rotationSpeedGraph2 radialSpeedGraph radialSpeedGraph2 scaleGraph scaleGraph2 colorGraph colorGraph2 alphaGraph alphaGraph2 colorMap normalMap animTilesX animTilesY animStartFrame animNumFrames animNumAnimations animIndex randomizeAnimIndex animSpeed animLoop layers".split(" ");_n.prototype=Object.create(os.prototype),_n.prototype.constructor=_n,as._buildAccessors(su.prototype,lu),Object.assign(_n.prototype,{initializeComponentData:function(t,e,i){var s={};i=[];var n=this.propertyTypes;for(var r in(e.mesh instanceof Fe||"number"==typeof e.mesh)&&(e.meshAsset=e.mesh,delete e.mesh),e){if(e.hasOwnProperty(r)&&(i.push(r),s[r]=e[r]),"vec3"===n[r])Array.isArray(s[r])&&(s[r]=new v(s[r][0],s[r][1],s[r][2]));else if("curve"===n[r]){if(!(s[r]instanceof m)){var a=s[r].type;s[r]=new m(s[r].keys),s[r].type=a}}else"curveset"!==n[r]||s[r]instanceof _||(a=s[r].type,s[r]=new _(s[r].keys),s[r].type=a);s.layers&&Array.isArray(s.layers)&&(s.layers=s.layers.slice(0))}os.prototype.initializeComponentData.call(this,t,s,i)},cloneComponent:function(t,e){t=t.particlesystem.data;for(var i=this.schema,s={},n=0,r=i.length;n<r;n++){var a=i[n],o=t[a];o instanceof v||o instanceof m||o instanceof _?(o=o.clone(),s[a]=o):"layers"===a?s.layers=t.layers.slice(0):null!=o&&(s[a]=o)}return this.addComponent(e,s)},onUpdate:function(t){var e,i,s=this.store,n=this.app.stats.particles;for(i in s)if(s.hasOwnProperty(i)){var r=s[i],a=r.entity,o=r.data;if(o.enabled&&a.enabled){var h=o.model.emitter;if(h.meshInstance.visible){if(h.lighting){var l=o.layers;for(a=0;a<l.length;a++)if(r=this.app.scene.layers.getLayerById(l[a])){r._lightCube||(r._lightCube=new Float32Array(18));var c=r._lightCube;for(a=0;6>a;a++)c[3*a]=this.app.scene.ambientLight.r,c[3*a+1]=this.app.scene.ambientLight.g,c[3*a+2]=this.app.scene.ambientLight.b;var d=r._sortedLights[0];for(e=0;e<d.length;e++)for(r=0;6>r;r++){var u=Math.max(h.lightCubeDir[r].dot(d[e]._direction),0)*d[e]._intensity;c[3*r]+=d[e]._color.r*u,c[3*r+1]+=d[e]._color.g*u,c[3*r+2]+=d[e]._color.b*u}}h.constantLightCube.setValue(c)}if(!o.paused){if(h.simTime+=t,h.simTime>h.fixedTimeStep){var p=Math.floor(h.simTime/h.fixedTimeStep);h.simTime-=p*h.fixedTimeStep}if(p){for(p=Math.min(p,h.maxSubSteps),a=0;a<p;a++)h.addTime(h.fixedTimeStep,!1);n._updatesPerFrame+=p,n._frameTime+=h._addTimeTime,h._addTimeTime=0}h.finishFrame()}}}}},onBeforeRemove:function(t,e){e.onBeforeRemove()}}),Object.assign(gn.prototype,{_resize:function(t){if(t>this._pool.length)for(var e=this._pool.length;e<t;e++)this._pool[e]=new this._constructor},allocate:function(){return this._count>=this._pool.length&&this._resize(2*this._pool.length),this._pool[this._count++]},freeAll:function(){this._count=0}}),yn.prototype=Object.create(as.prototype),yn.prototype.constructor=yn,Object.defineProperty(yn.prototype,"linearVelocity",{get:function(){var t=this.body;return t&&"dynamic"===this.type&&(t=t.getLinearVelocity(),this._linearVelocity.set(t.x(),t.y(),t.z())),this._linearVelocity},set:function(t){var e=this.body;e&&"dynamic"===this.type&&(e.activate(),ru.setValue(t.x,t.y,t.z),e.setLinearVelocity(ru),this._linearVelocity.copy(t))}}),Object.defineProperty(yn.prototype,"angularVelocity",{get:function(){var t=this.body;return t&&"dynamic"===this.type&&(t=t.getAngularVelocity(),this._angularVelocity.set(t.x(),t.y(),t.z())),this._angularVelocity},set:function(t){var e=this.body;e&&"dynamic"===this.type&&(e.activate(),ru.setValue(t.x,t.y,t.z),e.setAngularVelocity(ru),this._angularVelocity.copy(t))}}),Object.assign(yn.prototype,{createBody:function(){var t=this.entity;if(t.collision){var e=t.collision.shape;t.trigger&&(t.trigger.destroy(),delete t.trigger)}if(e){this.body&&this.system.onRemove(this.entity,this);var i="dynamic"===this.type?this.mass:0;this._getEntityTransform(nu),(e=this.system.createBody(i,e,nu)).setRestitution(this.restitution),e.setFriction(this.friction),e.setDamping(this.linearDamping,this.angularDamping),"dynamic"===this.type?(i=this.linearFactor,ru.setValue(i.x,i.y,i.z),e.setLinearFactor(ru),i=this.angularFactor,ru.setValue(i.x,i.y,i.z),e.setAngularFactor(ru)):"kinematic"===this.type&&(e.setCollisionFlags(2|e.getCollisionFlags()),e.setActivationState(4)),e.entity=t,t.rigidbody.body=e,this.enabled&&this.entity.enabled&&this.enableSimulation()}},isActive:function(){var t=this.body;return!!t&&t.isActive()},activate:function(){var t=this.body;t&&t.activate()},enableSimulation:function(){if(this.entity.collision&&this.entity.collision.enabled&&!this.data.simulationEnabled){var t=this.body;if(t){switch(this.system.addBody(t,this.group,this.mask),this.type){case"dynamic":this.system._dynamic.push(this),t.forceActivationState(1),this.syncEntityToBody();break;case"kinematic":this.system._kinematic.push(this),t.forceActivationState(4);break;case ed:t.forceActivationState(1),this.syncEntityToBody()}"compound"===this.entity.collision.type&&this.system._compounds.push(this.entity.collision),t.activate(),this.data.simulationEnabled=!0}}},disableSimulation:function(){var t=this.body;if(t&&this.data.simulationEnabled){var e=this.system._compounds.indexOf(this.entity.collision);-1<e&&this.system._compounds.splice(e,1),-1<(e=this.system._dynamic.indexOf(this))&&this.system._dynamic.splice(e,1),-1<(e=this.system._kinematic.indexOf(this))&&this.system._kinematic.splice(e,1),this.system.removeBody(t),t.forceActivationState(5),this.data.simulationEnabled=!1}},applyForce:function(){switch(arguments.length){case 1:var t=arguments[0].x,e=arguments[0].y,i=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,i=arguments[0].z;var s=arguments[1].x,n=arguments[1].y,r=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],i=arguments[2];break;case 6:t=arguments[0],e=arguments[1],i=arguments[2],s=arguments[3],n=arguments[4],r=arguments[5]}var a=this.body;a&&(a.activate(),ru.setValue(t,e,i),void 0!==s?(au.setValue(s,n,r),a.applyForce(ru,au)):a.applyForce(ru,hu))},applyTorque:function(){switch(arguments.length){case 1:var t=arguments[0].x,e=arguments[0].y,i=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],i=arguments[2];break;default:return}var s=this.body;s&&(s.activate(),ru.setValue(t,e,i),s.applyTorque(ru))},applyImpulse:function(){switch(arguments.length){case 1:var t=arguments[0].x,e=arguments[0].y,i=arguments[0].z;break;case 2:t=arguments[0].x,e=arguments[0].y,i=arguments[0].z;var s=arguments[1].x,n=arguments[1].y,r=arguments[1].z;break;case 3:t=arguments[0],e=arguments[1],i=arguments[2];break;case 6:t=arguments[0],e=arguments[1],i=arguments[2],s=arguments[3],n=arguments[4],r=arguments[5];break;default:return}var a=this.body;a&&(a.activate(),ru.setValue(t,e,i),void 0!==s?(au.setValue(s,n,r),a.applyImpulse(ru,au)):a.applyImpulse(ru,hu))},applyTorqueImpulse:function(){switch(arguments.length){case 1:var t=arguments[0].x,e=arguments[0].y,i=arguments[0].z;break;case 3:t=arguments[0],e=arguments[1],i=arguments[2];break;default:return}var s=this.body;s&&(s.activate(),ru.setValue(t,e,i),s.applyTorqueImpulse(ru))},isStatic:function(){return this.type===ed},isStaticOrKinematic:function(){return this.type===ed||"kinematic"===this.type},isKinematic:function(){return"kinematic"===this.type},_getEntityTransform:function(t){var e=this.entity.getPosition(),i=this.entity.getRotation();ru.setValue(e.x,e.y,e.z),ou.setValue(i.x,i.y,i.z,i.w),t.setOrigin(ru),t.setRotation(ou)},syncEntityToBody:function(){var t=this.data.body;if(t){if(this._getEntityTransform(nu),t.setWorldTransform(nu),"kinematic"===this.type){var e=t.getMotionState();e&&e.setWorldTransform(nu)}t.activate()}},_updateDynamic:function(){var t=this.data.body;if(t.isActive()&&(t=t.getMotionState())){t.getWorldTransform(nu),t=nu.getOrigin();var e=nu.getRotation();this.entity.setPosition(t.x(),t.y(),t.z()),this.entity.setRotation(e.x(),e.y(),e.z(),e.w())}},_updateKinematic:function(){var t=this.data.body.getMotionState();t&&(this._getEntityTransform(nu),t.setWorldTransform(nu))},teleport:function(){3>arguments.length?(arguments[0]&&this.entity.setPosition(arguments[0]),arguments[1]&&(arguments[1]instanceof S?this.entity.setRotation(arguments[1]):this.entity.setEulerAngles(arguments[1]))):(6===arguments.length&&this.entity.setEulerAngles(arguments[3],arguments[4],arguments[5]),this.entity.setPosition(arguments[0],arguments[1],arguments[2])),this.syncEntityToBody()},onEnable:function(){this.body||this.createBody(),this.enableSimulation()},onDisable:function(){this.disableSimulation()},onSetMass:function(t,e,i){(t=this.data.body)&&"dynamic"===this.type&&((e=this.enabled&&this.entity.enabled)&&this.disableSimulation(),t.getCollisionShape().calculateLocalInertia(i,ru),t.setMassProps(i,ru),t.updateInertiaTensor(),e&&this.enableSimulation())},onSetLinearDamping:function(t,e,i){(t=this.data.body)&&t.setDamping(i,this.data.angularDamping)},onSetAngularDamping:function(t,e,i){(t=this.data.body)&&t.setDamping(this.data.linearDamping,i)},onSetLinearFactor:function(t,e,i){(t=this.data.body)&&"dynamic"===this.type&&(ru.setValue(i.x,i.y,i.z),t.setLinearFactor(ru))},onSetAngularFactor:function(t,e,i){(t=this.data.body)&&"dynamic"===this.type&&(ru.setValue(i.x,i.y,i.z),t.setAngularFactor(ru))},onSetFriction:function(t,e,i){(t=this.data.body)&&t.setFriction(i)},onSetRestitution:function(t,e,i){(t=this.data.body)&&t.setRestitution(i)},onSetType:function(t,e,i){i!==e&&(this.disableSimulation(),"dynamic"===i?(this.data.group=1,this.data.mask=65535):"kinematic"===i?(this.data.group=4,this.data.mask=65535):(this.data.group=id,this.data.mask=sd),this.createBody())},onSetGroupOrMask:function(t,e,i){i!==e&&this.enabled&&this.entity.enabled&&(this.disableSimulation(),this.enableSimulation())},onSetBody:function(t,e,i){this.body&&this.data.simulationEnabled&&this.body.activate()}});var cu,du,uu={},pu={},fu="enabled type mass linearDamping angularDamping linearFactor angularFactor friction restitution group mask body".split(" ");wn.prototype=Object.create(os.prototype),wn.prototype.constructor=wn,as._buildAccessors(yn.prototype,fu),Object.assign(wn.prototype,{onLibraryLoaded:function(){if("undefined"!=typeof Ammo){if(this.collisionConfiguration=new Ammo.btDefaultCollisionConfiguration,this.dispatcher=new Ammo.btCollisionDispatcher(this.collisionConfiguration),this.overlappingPairCache=new Ammo.btDbvtBroadphase,this.solver=new Ammo.btSequentialImpulseConstraintSolver,this.dynamicsWorld=new Ammo.btDiscreteDynamicsWorld(this.dispatcher,this.overlappingPairCache,this.solver,this.collisionConfiguration),this.dynamicsWorld.setInternalTickCallback){var t=Ammo.addFunction(this._checkForCollisions.bind(this),"vif");this.dynamicsWorld.setInternalTickCallback(t)}cu=new Ammo.btVector3,du=new Ammo.btVector3,this.contactPointPool=new gn(Sn,1),this.contactResultPool=new gn(Tn,1),this.singleContactResultPool=new gn(xn,1),os.bind("update",this.onUpdate,this)}else os.unbind("update",this.onUpdate,this)},initializeComponentData:function(t,e,i){for(var s={},n=0,r=(i="enabled mass linearDamping angularDamping linearFactor angularFactor friction restitution type group mask".split(" ")).length;n<r;n++){var a=i[n];s[a]=e[a]}e.bodyType&&(s.type=e.bodyType),s.linearFactor&&Array.isArray(s.linearFactor)&&(s.linearFactor=new v(s.linearFactor[0],s.linearFactor[1],s.linearFactor[2])),s.angularFactor&&Array.isArray(s.angularFactor)&&(s.angularFactor=new v(s.angularFactor[0],s.angularFactor[1],s.angularFactor[2])),os.prototype.initializeComponentData.call(this,t,s,i)},cloneComponent:function(t,e){this.addComponent(e,{enabled:t.rigidbody.enabled,mass:t.rigidbody.mass,linearDamping:t.rigidbody.linearDamping,angularDamping:t.rigidbody.angularDamping,linearFactor:[t.rigidbody.linearFactor.x,t.rigidbody.linearFactor.y,t.rigidbody.linearFactor.z],angularFactor:[t.rigidbody.angularFactor.x,t.rigidbody.angularFactor.y,t.rigidbody.angularFactor.z],friction:t.rigidbody.friction,restitution:t.rigidbody.restitution,type:t.rigidbody.type,group:t.rigidbody.group,mask:t.rigidbody.mask})},onBeforeRemove:function(t,e){e.enabled&&(e.enabled=!1)},onRemove:function(t,e){(t=e.body)&&(this.removeBody(t),this.destroyBody(t),e.body=null)},addBody:function(t,e,i){void 0!==e&&void 0!==i?this.dynamicsWorld.addRigidBody(t,e,i):this.dynamicsWorld.addRigidBody(t)},removeBody:function(t){this.dynamicsWorld.removeRigidBody(t)},createBody:function(t,e,i){var s=new Ammo.btVector3(0,0,0);return 0!==t&&e.calculateLocalInertia(t,s),i=new Ammo.btDefaultMotionState(i),t=new Ammo.btRigidBodyConstructionInfo(t,i,e,s),e=new Ammo.btRigidBody(t),Ammo.destroy(t),Ammo.destroy(s),e},destroyBody:function(t){var e=t.getMotionState();e&&Ammo.destroy(e),Ammo.destroy(t)},raycastFirst:function(t,e){var i=null;cu.setValue(t.x,t.y,t.z),du.setValue(e.x,e.y,e.z);var s=new Ammo.ClosestRayResultCallback(cu,du);if(this.dynamicsWorld.rayTest(cu,du,s),s.hasHit()){var n=s.get_m_collisionObject();if(n=Ammo.castObject(n,Ammo.btRigidBody)){i=s.get_m_hitPointWorld();var r=s.get_m_hitNormalWorld();i=new bn(n.entity,new v(i.x(),i.y(),i.z()),new v(r.x(),r.y(),r.z())),2<arguments.length&&(0,arguments[2])(i)}}return Ammo.destroy(s),i},raycastAll:function(t,e){var i=[];if(cu.setValue(t.x,t.y,t.z),du.setValue(e.x,e.y,e.z),t=new Ammo.AllHitsRayResultCallback(cu,du),this.dynamicsWorld.rayTest(cu,du,t),t.hasHit()){e=t.get_m_collisionObjects();for(var s=t.get_m_hitPointWorld(),n=t.get_m_hitNormalWorld(),r=e.size(),a=0;a<r;a++){var o=Ammo.castObject(e.at(a),Ammo.btRigidBody);if(o){var h=s.at(a),l=n.at(a);o=new bn(o.entity,new v(h.x(),h.y(),h.z()),new v(l.x(),l.y(),l.z())),i.push(o)}}}return Ammo.destroy(t),i},_storeCollision:function(t,e){var i=!1,s=t.getGuid();return uu[s]=uu[s]||{others:[],entity:t},0>uu[s].others.indexOf(e)&&(uu[s].others.push(e),i=!0),pu[s]=pu[s]||{others:[],entity:t},pu[s].others.push(e),i},_createContactPointFromAmmo:function(t){var e=t.get_m_localPointA(),i=t.get_m_localPointB(),s=t.getPositionWorldOnA(),n=t.getPositionWorldOnB();t=t.get_m_normalWorldOnB();var r=this.contactPointPool.allocate();return r.localPoint.set(e.x(),e.y(),e.z()),r.localPointOther.set(i.x(),i.y(),i.z()),r.point.set(s.x(),s.y(),s.z()),r.pointOther.set(n.x(),n.y(),n.z()),r.normal.set(t.x(),t.y(),t.z()),r},_createReverseContactPointFromAmmo:function(t){var e=t.get_m_localPointA(),i=t.get_m_localPointB(),s=t.getPositionWorldOnA(),n=t.getPositionWorldOnB();t=t.get_m_normalWorldOnB();var r=this.contactPointPool.allocate();return r.localPointOther.set(e.x(),e.y(),e.z()),r.localPoint.set(i.x(),i.y(),i.z()),r.pointOther.set(s.x(),s.y(),s.z()),r.point.set(n.x(),n.y(),n.z()),r.normal.set(t.x(),t.y(),t.z()),r},_createSingleContactResult:function(t,e,i){var s=this.singleContactResultPool.allocate();return s.a=t,s.b=e,s.localPointA=i.localPoint,s.localPointB=i.localPointOther,s.pointA=i.point,s.pointB=i.pointOther,s.normal=i.normal,s},_createContactResult:function(t,e){var i=this.contactResultPool.allocate();return i.other=t,i.contacts=e,i},_cleanOldCollisions:function(){for(var t in uu)if(uu.hasOwnProperty(t)){for(var e=pu[t],i=uu[t],s=i.entity,n=s.collision,r=s.rigidbody,a=(i=i.others).length;a--;){var o=i[a];(!e||0>e.others.indexOf(o))&&(i.splice(a,1),s.trigger?(n&&n.fire("triggerleave",o),o.rigidbody&&o.rigidbody.fire("triggerleave",s)):o.trigger||(r&&r.fire("collisionend",o),n&&n.fire("collisionend",o)))}0===i.length&&delete uu[t]}},_hasContactEvent:function(t){var e=t.collision;return!(!e||!(e.hasEvent("collisionstart")||e.hasEvent("collisionend")||e.hasEvent("contact")))||(t=t.rigidbody)&&(t.hasEvent("collisionstart")||t.hasEvent("collisionend")||t.hasEvent("contact"))},_checkForCollisions:function(t,e){e=(t=Ammo.wrapPointer(t,Ammo.btDynamicsWorld).getDispatcher()).getNumManifolds(),pu={};for(var i=0;i<e;i++){var s=t.getManifoldByIndexInternal(i),n=s.getBody0(),r=s.getBody1(),a=Ammo.castObject(n,Ammo.btRigidBody),o=Ammo.castObject(r,Ammo.btRigidBody);if(r=a.entity,n=o.entity,r&&n){var h=a.getCollisionFlags(),l=o.getCollisionFlags(),c=s.getNumContacts(),d=[],u=[];if(0<c)if(4&h||4&l){if(o=r.collision&&(r.collision.hasEvent("triggerenter")||r.collision.hasEvent("triggerleave")),a=n.collision&&(n.collision.hasEvent("triggerenter")||n.collision.hasEvent("triggerleave")),s=r.rigidbody&&(r.rigidbody.hasEvent("triggerenter")||r.rigidbody.hasEvent("triggerleave")),u=n.rigidbody&&(n.rigidbody.hasEvent("triggerenter")||n.rigidbody.hasEvent("triggerleave")),o){var p=this._storeCollision(r,n);!p||4&l||r.collision.fire("triggerenter",n)}a&&(!(p=this._storeCollision(n,r))||4&h||n.collision.fire("triggerenter",r)),s&&(p||(p=this._storeCollision(n,r)),p&&r.rigidbody.fire("triggerenter",n)),u&&(p||(p=this._storeCollision(r,n)),p&&n.rigidbody.fire("triggerenter",r))}else if(o=this._hasContactEvent(r),a=this._hasContactEvent(n),(h=this.hasEvent("contact"))||o||a){for(l=0;l<c;l++){var f=s.getContactPoint(l),m=this._createContactPointFromAmmo(f);(o||a)&&(f=this._createReverseContactPointFromAmmo(f),d.push(m),u.push(f)),h&&(m=this._createSingleContactResult(r,n,m),this.fire("contact",m))}o&&(s=this._createContactResult(n,d),p=this._storeCollision(r,n),r.collision&&(r.collision.fire("contact",s),p&&r.collision.fire("collisionstart",s)),r.rigidbody&&(r.rigidbody.fire("contact",s),p&&r.rigidbody.fire("collisionstart",s))),a&&(s=this._createContactResult(r,u),p=this._storeCollision(n,r),n.collision&&(n.collision.fire("contact",s),p&&n.collision.fire("collisionstart",s)),n.rigidbody&&(n.rigidbody.fire("contact",s),p&&n.rigidbody.fire("collisionstart",s)))}}}this._cleanOldCollisions(),this.contactPointPool.freeAll(),this.contactResultPool.freeAll(),this.singleContactResultPool.freeAll()},onUpdate:function(t){var e,i=this.dynamicsWorld.getGravity();i.x()===this.gravity.x&&i.y()===this.gravity.y&&i.z()===this.gravity.z||(i.setValue(this.gravity.x,this.gravity.y,this.gravity.z),this.dynamicsWorld.setGravity(i));var s=this._triggers;for(i=0,e=s.length;i<e;i++)s[i].updateTransform();for(i=0,e=(s=this._compounds).length;i<e;i++)s[i]._updateCompound();for(i=0,e=(s=this._kinematic).length;i<e;i++)s[i]._updateKinematic();for(this.dynamicsWorld.stepSimulation(t,this.maxSubSteps,this.fixedTimeStep),i=0,e=(s=this._dynamic).length;i<e;i++)s[i]._updateDynamic();this.dynamicsWorld.setInternalTickCallback||this._checkForCollisions(Ammo.getPointer(this.dynamicsWorld),t)},destroy:function(){"undefined"!=typeof Ammo&&(Ammo.destroy(this.dynamicsWorld),Ammo.destroy(this.solver),Ammo.destroy(this.overlappingPairCache),Ammo.destroy(this.dispatcher),Ammo.destroy(this.collisionConfiguration),this.collisionConfiguration=this.dispatcher=this.overlappingPairCache=this.solver=this.dynamicsWorld=null)}});var mu="none";Mn.prototype=Object.create(as.prototype),Mn.prototype.constructor=Mn;var _u=new x;Object.assign(Mn.prototype,{syncDrawOrder:function(){this.system.queueDrawOrderSync(this.entity.getGuid(),this._processDrawOrderSync,this)},_recurseDrawOrderSync:function(t,e){if(!(t instanceof xe))return e;if(t.element){var i=t.element.drawOrder;t.element.drawOrder=e++,0<=t.element._batchGroupId&&i!=t.element.drawOrder&&this.system.app.batcher.markGroupDirty(t.element._batchGroupId)}for(t.particlesystem&&(t.particlesystem.drawOrder=e++),t=t.children,i=0;i<t.length;i++)e=this._recurseDrawOrderSync(t[i],e);return e},_processDrawOrderSync:function(){this._recurseDrawOrderSync(this.entity,1),this.fire("syncdraworder")},_calcProjectionMatrix:function(){var t=this._resolution.x/this.scale,e=this._resolution.y/this.scale;this._screenMatrix.setOrtho(0,t,-e,0,1,-1),this._screenSpace||(_u.setScale(.5*t,.5*e,1),this._screenMatrix.mul2(_u,this._screenMatrix))},_updateScale:function(){this.scale=this._calcScale(this._resolution,this.referenceResolution)},_calcScale:function(t,e){return Math.pow(2,Math.log2(t.x/e.x)*(1-this._scaleBlend)+Math.log2(t.y/e.y)*this._scaleBlend)},_onResize:function(t,e){this._screenSpace&&(this._resolution.set(t,e),this.resolution=this._resolution)},onRemove:function(){this.system.app.graphicsDevice.off("resizecanvas",this._onResize,this),this.fire("remove"),this.off()}}),Object.defineProperty(Mn.prototype,"resolution",{set:function(t){this._screenSpace?this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height):this._resolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:resolution",this._resolution)},get:function(){return this._resolution}}),Object.defineProperty(Mn.prototype,"referenceResolution",{set:function(t){this._referenceResolution.set(t.x,t.y),this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:referenceresolution",this._resolution)},get:function(){return this._scaleMode===mu?this._resolution:this._referenceResolution}}),Object.defineProperty(Mn.prototype,"screenSpace",{set:function(t){(this._screenSpace=t)&&this._resolution.set(this.system.app.graphicsDevice.width,this.system.app.graphicsDevice.height),this.resolution=this._resolution,this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:screenspace",this._screenSpace)},get:function(){return this._screenSpace}}),Object.defineProperty(Mn.prototype,"scaleMode",{set:function(t){t!==mu&&"blend"!==t&&(t=mu),this._screenSpace||t===mu||(t=mu),this._scaleMode=t,this.resolution=this._resolution,this.fire("set:scalemode",this._scaleMode)},get:function(){return this._scaleMode}}),Object.defineProperty(Mn.prototype,"scaleBlend",{set:function(t){this._scaleBlend=t,this._updateScale(),this._calcProjectionMatrix(),this.entity._dirtyLocal||this.entity._dirtifyLocal(),this.fire("set:scaleblend",this._scaleBlend)},get:function(){return this._scaleBlend}}),Object.defineProperty(Mn.prototype,"priority",{get:function(){return this._priority},set:function(t){255<t&&(t=255),this._priority=t}});var gu=["enabled"];An.prototype=Object.create(os.prototype),An.prototype.constructor=An,as._buildAccessors(Mn.prototype,gu),Object.assign(An.prototype,{initializeComponentData:function(t,e,i){void 0!==e.priority&&(t.priority=e.priority),void 0!==e.screenSpace&&(t.screenSpace=e.screenSpace),t.cull=t.screenSpace,void 0!==e.scaleMode&&(t.scaleMode=e.scaleMode),void 0!==e.scaleBlend&&(t.scaleBlend=e.scaleBlend),void 0!==e.resolution&&(e.resolution instanceof y?t._resolution.copy(e.resolution):t._resolution.set(e.resolution[0],e.resolution[1]),t.resolution=t._resolution),void 0!==e.referenceResolution&&(e.referenceResolution instanceof y?t._referenceResolution.copy(e.referenceResolution):t._referenceResolution.set(e.referenceResolution[0],e.referenceResolution[1]),t.referenceResolution=t._referenceResolution),t.syncDrawOrder(),os.prototype.initializeComponentData.call(this,t,e,i)},destroy:function(){this.off(),this.app.graphicsDevice.off("resizecanvas",this._onResize,this)},_onUpdate:function(t){var e,i=this.store;for(e in i)i[e].entity.screen.update&&i[e].entity.screen.update(t)},_onResize:function(t,e){this.windowResolution.x=t,this.windowResolution.y=e},cloneComponent:function(t,e){return t=t.screen,this.addComponent(e,{enabled:t.enabled,screenSpace:t.screenSpace,scaleMode:t.scaleMode,resolution:t.resolution.clone(),referenceResolution:t.referenceResolution.clone()})},onRemoveComponent:function(t,e){e.onRemove()},processDrawOrderSyncQueue:function(){for(var t=this._drawOrderSyncQueue.list(),e=0;e<t.length;e++){var i=t[e];i.callback.call(i.scope)}this._drawOrderSyncQueue.clear()},queueDrawOrderSync:function(t,e,i){this._drawOrderSyncQueue.list().length||this.app.once("prerender",this.processDrawOrderSyncQueue,this),this._drawOrderSyncQueue.has(t)||this._drawOrderSyncQueue.push(t,{callback:e,scope:i})}});var yu=["x","y","z","w"],vu=[void 0,void 0,y,v,b],bu=function(t,e,i,s){var n;switch(e.type){case"boolean":return!!i;case"number":if("number"==typeof i)break;return"string"==typeof i?(i=parseInt(i,10),isNaN(i)?null:i):"boolean"==typeof i?0+i:null;case"json":var r={};if(Array.isArray(e.schema))for(i&&"object"==typeof i||(i={}),n=0;n<e.schema.length;n++){var a=e.schema[n];if(a.name)if(a.array){if(r[a.name]=[],Array.isArray(i[a.name]))for(s=0;s<i[a.name].length;s++)r[a.name].push(bu(t,a,i[a.name][s]))}else r[a.name]=bu(t,a,i[a.name])}return r;case"asset":if(i instanceof Fe)break;return"number"==typeof i?t.assets.get(i)||null:"string"==typeof i&&t.assets.get(parseInt(i,10))||null;case"entity":if(i instanceof Mt)break;return"string"==typeof i?t.getEntityFromIndex(i):null;case"rgb":case"rgba":if(i instanceof o)return s instanceof o?(s.copy(i),s):i.clone();if(i instanceof Array&&3<=i.length&&4>=i.length){for(n=0;n<i.length;n++)if("number"!=typeof i[n])return null;return s||(s=new o),s.r=i[0],s.g=i[1],s.b=i[2],s.a=3===i.length?1:i[3],s}return"string"==typeof i&&/#([0-9abcdef]{2}){3,4}/i.test(i)?(s||(s=new o),s.fromString(i),s):null;case"vec2":case"vec3":case"vec4":if(t=parseInt(e.type.slice(3),10),i instanceof(e=vu[t]))return s instanceof e?(s.copy(i),s):i.clone();if(i instanceof Array&&i.length===t){for(n=0;n<i.length;n++)if("number"!=typeof i[n])return null;for(s||(s=new e),n=0;n<t;n++)s[yu[n]]=i[n];return s}return null;case"curve":if(i)return i instanceof m||i instanceof _?n=i.clone():(n=new(i.keys[0]instanceof Array?_:m)(i.keys)).type=i.type,n}return i};En.prototype.add=function(t,e){this.index[t]||In.reservedAttributes[t]||(this.index[t]=e,Object.defineProperty(this.scriptType.prototype,t,{get:function(){return this.__attributes[t]},set:function(i){var s=this.__attributes[t];if(e.array){if(this.__attributes[t]=[],i){var n,r=0;for(n=i.length;r<n;r++)this.__attributes[t].push(bu(this.app,e,i[r],s?s[r]:null))}}else this.__attributes[t]=bu(this.app,e,i,s);this.fire("attr",t,this.__attributes[t],s),this.fire("attr:"+t,this.__attributes[t],s)}}))},En.prototype.remove=function(t){return!!this.index[t]&&(delete this.index[t],delete this.scriptType.prototype[t],!0)},En.prototype.has=function(t){return!!this.index[t]},En.prototype.get=function(t){return this.index[t]||null};var xu=/^\s*function(?:\s|\s*\/\*.*\*\/\s*)+([^\(\s\/]*)\s*/;Cn.prototype=Object.create(n.prototype),Cn.prototype.constructor=Cn,Cn.__name=null,Cn.__getScriptName=function(t){if("function"==typeof t)return"name"in Function.prototype?t.name:t===Function||t===Function.prototype.constructor?"Function":(t=(""+t).match(xu))?t[1]:void 0},Object.defineProperty(Cn,"scriptName",{get:function(){return this.__name}}),Object.defineProperty(Cn,"attributes",{get:function(){return this.hasOwnProperty("__attributes")||(this.__attributes=new En(this)),this.__attributes}}),Cn.prototype.__initializeAttributes=function(t){if(t||this.__attributesRaw){for(var e in this.__scriptType.attributes.index)this.__attributesRaw&&this.__attributesRaw.hasOwnProperty(e)?this[e]=this.__attributesRaw[e]:this.__attributes.hasOwnProperty(e)||(this.__scriptType.attributes.index[e].hasOwnProperty("default")?this[e]=this.__scriptType.attributes.index[e].default:this[e]=null);this.__attributesRaw=null}},Cn.extend=function(t){for(var e in t)t.hasOwnProperty(e)&&(this.prototype[e]=t[e])},Object.defineProperty(Cn.prototype,"enabled",{get:function(){return this._enabled&&!this._destroyed&&this.entity.script.enabled&&this.entity.enabled},set:function(t){this._enabled=!!t,this.enabled!==this._enabledOld&&(this._enabledOld=this.enabled,this.fire(this.enabled?"enable":"disable"),this.fire("state",this.enabled),!this._initialized&&this.enabled&&(this._initialized=!0,this.__initializeAttributes(!0),this.initialize&&this.entity.script._scriptMethod(this,Dn.scriptMethods.initialize)),this._initialized&&!this._postInitialized&&this.enabled&&!this.entity.script._beingEnabled&&(this._postInitialized=!0,this.postInitialize&&this.entity.script._scriptMethod(this,Dn.scriptMethods.postInitialize)))}}),In.reservedScripts="system entity create destroy swap move scripts _scripts _scriptsIndex _scriptsData enabled _oldState onEnable onDisable onPostStateChange _onSetEnabled _checkState _onBeforeRemove _onInitializeAttributes _onInitialize _onPostInitialize _onUpdate _onPostUpdate _callbacks has get on off fire once hasEvent".split(" ");var Su,Tu={};for(Su=0;Su<In.reservedScripts.length;Su++)Tu[In.reservedScripts[Su]]=1;In.reservedScripts=Tu,In.reservedAttributes="app entity enabled _enabled _enabledOld _destroyed __attributes __attributesRaw __scriptType __executionOrder _callbacks has get on off fire once hasEvent".split(" ");var wu={};for(Su=0;Su<In.reservedAttributes.length;Su++)wu[In.reservedAttributes[Su]]=1;In.reservedAttributes=wu,Rn.prototype._binarySearch=function(t){var e,i,s=0,n=this.items.length-1;for(t=t[this._sortBy];s<=n;)e=Math.floor((s+n)/2),(i=this.items[e][this._sortBy])<=t?s=e+1:i>t&&(n=e-1);return s},Rn.prototype._doSort=function(t,e){var i=this._sortBy;return t[i]-e[i]},Rn.prototype.insert=function(t){var e=this._binarySearch(t);this.items.splice(e,0,t),this.length++,this.loopIndex>=e&&this.loopIndex++},Rn.prototype.append=function(t){this.items.push(t),this.length++},Rn.prototype.remove=function(t){0>(t=this.items.indexOf(t))||(this.items.splice(t,1),this.length--,this.loopIndex>=t&&this.loopIndex--)},Rn.prototype.sort=function(){var t=0<=this.loopIndex?this.items[this.loopIndex]:null;this.items.sort(this._sortHandler),null!==t&&(this.loopIndex=this.items.indexOf(t))},Dn.prototype=Object.create(as.prototype),Dn.prototype.constructor=Dn,Dn.scriptMethods={initialize:"initialize",postInitialize:"postInitialize",update:"update",postUpdate:"postUpdate",swap:"swap"},Object.assign(Dn.prototype,{onEnable:function(){this._beingEnabled=!0,this._checkState(),this.entity._beingEnabled||this.onPostStateChange(),this._beingEnabled=!1},onDisable:function(){this._checkState()},onPostStateChange:function(){for(var t,e=this._beginLooping(),i=0,s=this.scripts.length;i<s;i++)(t=this.scripts[i])._initialized&&!t._postInitialized&&t.enabled&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,Dn.scriptMethods.postInitialize));this._endLooping(e)},_beginLooping:function(){var t=this._isLoopingThroughScripts;return this._isLoopingThroughScripts=!0,t},_endLooping:function(t){(this._isLoopingThroughScripts=t)||this._removeDestroyedScripts()},_onSetEnabled:function(t,e,i){this._beingEnabled=!0,this._checkState(),this._beingEnabled=!1},_checkState:function(){var t=this.enabled&&this.entity.enabled;if(t!==this._oldState){this._oldState=t,this.fire(t?"enable":"disable"),this.fire("state",t),t?this.system._addComponentToEnabled(this):this.system._removeComponentFromEnabled(this),t=this._beginLooping();for(var e,i=0,s=this.scripts.length;i<s;i++)(e=this.scripts[i]).enabled=e._enabled;this._endLooping(t)}},_onBeforeRemove:function(){this.fire("remove");for(var t=this._beginLooping(),e=0;e<this.scripts.length;e++){var i=this.scripts[e];i&&this.destroy(i.__scriptType.__name)}this._endLooping(t)},_removeDestroyedScripts:function(){var t=this._destroyedScripts.length;if(t){var e;for(e=0;e<t;e++)this._removeScriptInstance(this._destroyedScripts[e]);this._destroyedScripts.length=0,this._resetExecutionOrder(0,this._scripts.length)}},_onInitializeAttributes:function(){for(var t=0,e=this.scripts.length;t<e;t++)this.scripts[t].__initializeAttributes()},_scriptMethod:function(t,e,i){t[e](i)},_onInitialize:function(){for(var t,e=this._scripts,i=this._beginLooping(),s=0,n=e.length;s<n;s++)!(t=e[s])._initialized&&t.enabled&&(t._initialized=!0,t.initialize&&this._scriptMethod(t,Dn.scriptMethods.initialize));this._endLooping(i)},_onPostInitialize:function(){this.onPostStateChange()},_onUpdate:function(t){var e=this._updateList;if(e.length){var i=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){var s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,Dn.scriptMethods.update,t)}this._endLooping(i)}},_onPostUpdate:function(t){var e=this._postUpdateList;if(e.length){var i=this._beginLooping();for(e.loopIndex=0;e.loopIndex<e.length;e.loopIndex++){var s=e.items[e.loopIndex];s.enabled&&this._scriptMethod(s,Dn.scriptMethods.postUpdate,t)}this._endLooping(i)}},_insertScriptInstance:function(t,e,i){-1===e?(this._scripts.push(t),t.__executionOrder=i,t.update&&this._updateList.append(t),t.postUpdate&&this._postUpdateList.append(t)):(this._scripts.splice(e,0,t),t.__executionOrder=e,this._resetExecutionOrder(e+1,i+1),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t))},_removeScriptInstance:function(t){var e=this._scripts.indexOf(t);return-1===e?e:(this._scripts.splice(e,1),t.update&&this._updateList.remove(t),t.postUpdate&&this._postUpdateList.remove(t),e)},_resetExecutionOrder:function(t,e){for(;t<e;t++)this._scripts[t].__executionOrder=t},_resolveEntityScriptAttribute:function(t,e,i,s,n,r){if(t.array){if(t=i.length){i=i.slice();for(var a=0;a<t;a++){var o=i[a]instanceof xe?i[a].getGuid():i[a];r[o]&&(i[a]=s?r[o].getGuid():r[o])}n[e]=i}}else{if(i instanceof xe)i=i.getGuid();else if("string"!=typeof i)return;r[i]&&(n[e]=r[i])}},has:function(t){if("string"==typeof t)return!!this._scriptsIndex[t];if(!t)return!1;var e=this._scriptsIndex[t.__name];return(e&&e.instance)instanceof t},get:function(t){if("string"==typeof t)return(t=this._scriptsIndex[t])?t.instance:null;if(!t)return null;var e=this._scriptsIndex[t.__name];return(e=e&&e.instance)instanceof t?e:null},create:function(t,e){var i=this;e=e||{};var s=t,n=t;if("string"==typeof s?s=this.system.app.scripts.get(s):s&&(n=s.__name),s){if(!this._scriptsIndex[n]||!this._scriptsIndex[n].instance){t=new s({app:this.system.app,entity:this.entity,enabled:!e.hasOwnProperty("enabled")||e.enabled,attributes:e.attributes}),s=this._scripts.length;var r=-1;return"number"==typeof e.ind&&-1!==e.ind&&s>e.ind&&(r=e.ind),this._insertScriptInstance(t,r,s),this._scriptsIndex[n]={instance:t,onSwap:function(){i.swap(n)}},this[n]=t,e.preloading||t.__initializeAttributes(),this.fire("create",n,t),this.fire("create:"+n,t),this.system.app.scripts.on("swap:"+n,this._scriptsIndex[n].onSwap),e.preloading||(t.enabled&&!t._initialized&&(t._initialized=!0,t.initialize&&this._scriptMethod(t,Dn.scriptMethods.initialize)),t.enabled&&!t._postInitialized&&(t._postInitialized=!0,t.postInitialize&&this._scriptMethod(t,Dn.scriptMethods.postInitialize))),t}console.warn("script '"+n+"' is already added to entity '"+this.entity.name+"'")}else this._scriptsIndex[n]={awaiting:!0,ind:this._scripts.length},console.warn("script '"+n+"' is not found, awaiting it to be added to registry");return null},destroy:function(t){var e=t;if("string"==typeof t?this.system.app.scripts.get(t):t&&(e=t.__name),t=this._scriptsIndex[e],delete this._scriptsIndex[e],!t)return!1;var i=t.instance;if(i&&!i._destroyed)if(i.enabled=!1,i._destroyed=!0,this._isLoopingThroughScripts)this._destroyedScripts.push(i);else{var s=this._removeScriptInstance(i);0<=s&&this._resetExecutionOrder(s,this._scripts.length)}return this.system.app.scripts.off("swap:"+e,t.onSwap),delete this[e],this.fire("destroy",e,i||null),this.fire("destroy:"+e,i||null),i&&i.fire("destroy"),!0},swap:function(t){var e=t;"string"==typeof t?t=this.system.app.scripts.get(t):t&&(e=t.__name);var i=this._scriptsIndex[e];if(!i||!i.instance)return!1;i=i.instance;var s=this._scripts.indexOf(i);return!!(t=new t({app:this.system.app,entity:this.entity,enabled:i.enabled,attributes:i.__attributes})).swap&&(t.__initializeAttributes(),this._scripts[s]=t,this._scriptsIndex[e].instance=t,this[e]=t,t.__executionOrder=s,i.update&&this._updateList.remove(i),i.postUpdate&&this._postUpdateList.remove(i),t.update&&this._updateList.insert(t),t.postUpdate&&this._postUpdateList.insert(t),this._scriptMethod(t,Dn.scriptMethods.swap,i),this.fire("swap",e,t),this.fire("swap:"+e,t),!0)},resolveDuplicatedEntityReferenceProperties:function(t,e){var i,s,n,r=this.entity.script;for(n in t._scriptsIndex){var a=this.system.app.scripts.get(n);if(a&&(i=t._scriptsIndex[n])&&i.instance){var o=r[n].__attributesRaw,h=r[n].__attributes;if(o||h){var l,c=!!o,d=i.instance.__attributes;for(l in d)if(d[l]){var u=a.attributes.get(l);if(u)if("entity"===u.type)this._resolveEntityScriptAttribute(u,l,d[l],c,o||h,e);else if("json"===u.type&&Array.isArray(u.schema)){var p=d[l],f=o?o[l]:h[l];for(i=0;i<u.schema.length;i++){var m=u.schema[i];if("entity"===m.type)if(u.array)for(s=0;s<p.length;s++)this._resolveEntityScriptAttribute(m,m.name,p[s][m.name],c,f[s],e);else this._resolveEntityScriptAttribute(m,m.name,p[m.name],c,f,e)}}}}}}},move:function(t,e){var i=this._scripts.length;if(e>=i||0>e)return!1;var s=t,n=t;return"string"!=typeof n?n=t.__name:s=null,!(!(t=this._scriptsIndex[n])||!t.instance)&&(t=t.instance,(!s||t instanceof s)&&(-1!==(s=this._scripts.indexOf(t))&&s!==e&&(this._scripts.splice(e,0,this._scripts.splice(s,1)[0]),this._resetExecutionOrder(0,i),this._updateList.sort(),this._postUpdateList.sort(),this.fire("move",n,t,e,s),this.fire("move:"+n,t,e,s),!0)))}}),Object.defineProperty(Dn.prototype,"enabled",{get:function(){return this._enabled},set:function(t){var e=this._enabled;this._enabled=t,this.fire("set","enabled",e,t)}}),Object.defineProperty(Dn.prototype,"scripts",{get:function(){return this._scripts},set:function(t){for(var e in this._scriptsData=t,t)if(t.hasOwnProperty(e)){var i=this._scriptsIndex[e];if(i){if("boolean"==typeof t[e].enabled&&(i.enabled=!!t[e].enabled),"object"==typeof t[e].attributes)for(var s in t[e].attributes)if(!In.reservedAttributes[s]){if(!i.__attributes.hasOwnProperty(s)){var n=this.system.app.scripts.get(e);n&&n.attributes.add(s,{})}i[s]=t[e].attributes[s]}}else console.log(this.order)}}});var Mu=0;Fn.prototype=Object.create(os.prototype),Fn.prototype.constructor=Fn,Object.assign(Fn.prototype,{initializeComponentData:function(t,e){if(t._executionOrder=Mu++,this._components.append(t),Mu>Number.MAX_SAFE_INTEGER&&this._resetExecutionOrder(),t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,t.enabled&&t.entity.enabled&&this._enabledComponents.append(t),e.hasOwnProperty("order")&&e.hasOwnProperty("scripts")){t._scriptsData=e.scripts;for(var i=0;i<e.order.length;i++)t.create(e.order[i],{enabled:e.scripts[e.order[i]].enabled,attributes:e.scripts[e.order[i]].attributes,preloading:this.preloading})}},cloneComponent:function(t,e){var i,s,n=[],r={};for(i=0;i<t.script._scripts.length;i++){var a=t.script._scripts[i],o=a.__scriptType.__name;n.push(o);var h={};for(s in a.__attributes)h[s]=a.__attributes[s];r[o]={enabled:a._enabled,attributes:h}}for(s in t.script._scriptsIndex)s.awaiting&&n.splice(s.ind,0,s);return this.addComponent(e,{enabled:t.script.enabled,order:n,scripts:r})},_resetExecutionOrder:function(){for(var t=Mu=0,e=this._components.length;t<e;t++)this._components.items[t]._executionOrder=Mu++},_callComponentMethod:function(t,e,i){for(t.loopIndex=0;t.loopIndex<t.length;t.loopIndex++)t.items[t.loopIndex][e](i)},_onInitialize:function(){this.preloading=!1,this._callComponentMethod(this._components,"_onInitializeAttributes"),this._callComponentMethod(this._enabledComponents,"_onInitialize")},_onPostInitialize:function(){this._callComponentMethod(this._enabledComponents,"_onPostInitialize")},_onUpdate:function(t){this._callComponentMethod(this._enabledComponents,"_onUpdate",t)},_onPostUpdate:function(t){this._callComponentMethod(this._enabledComponents,"_onPostUpdate",t)},_addComponentToEnabled:function(t){this._enabledComponents.insert(t)},_removeComponentFromEnabled:function(t){this._enabledComponents.remove(t)},_onBeforeRemove:function(t,e){0<=this._components.items.indexOf(e)&&e._onBeforeRemove(),this._removeComponentFromEnabled(e),this._components.remove(e)}}),Bn.prototype=Object.create(as.prototype),Bn.prototype.constructor=Bn,Object.assign(Bn.prototype,{send:function(t,e){var i,s=Array.prototype.slice.call(arguments,2),n=this.entity.script.instances;if(n&&n[t]&&(i=n[t].instance[e]))return i.apply(n[t].instance,s)},onEnable:function(){this.data.areScriptsLoaded&&!this.system.preloading&&(this.data.initialized?this.system._enableScriptComponent(this):this.system._initializeScriptComponent(this),this.data.postInitialized||this.system._postInitializeScriptComponent(this))},onDisable:function(){this.system._disableScriptComponent(this)},onSetScripts:function(t,e,i){this.system._inTools&&!this.runInTools||this._updateScriptAttributes(e,i)||(this.enabled&&this.system._disableScriptComponent(this),this.system._destroyScriptComponent(this),this.data.areScriptsLoaded=!1,t=i.map(function(t){return t.url}),this._loadFromCache(t)||this._loadScripts(t))},_updateScriptAttributes:function(t,e){var i=!0;if(t.length!==e.length)i=!1;else{var s,n=e.length;for(s=0;s<n;s++)if(t[s].url!==e[s].url){i=!1;break}}if(i)for(var r in this.instances)this.instances.hasOwnProperty(r)&&this.system._updateAccessors(this.entity,this.instances[r]);return i},_loadFromCache:function(t){var e,i=[],s=this.system.app._scriptPrefix||"",n=/^http(s)?:\/\//i,r=0;for(e=t.length;r<e;r++){var a=t[r];if(n.test(a)||(a=ia.join(s,a)),!(a=this.system.app.loader.getFromCache(a,"script")))return!1;i.push(a)}for(r=0,e=i.length;r<e;r++)!0!==(s=i[r])&&s&&this.entity.script&&!this.entity.script.instances[s._pcScriptName]&&(n=new s(this.entity),this.system._preRegisterInstance(this.entity,t[r],s._pcScriptName,n));return this.data&&(this.data.areScriptsLoaded=!0),this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)),!0},_loadScripts:function(t){var e=t.length,i=this.system.app._scriptPrefix||"";t.forEach(function(t){var s=null,n=null;t.toLowerCase().startsWith("http://")||t.toLowerCase().startsWith("https://")?s=n=t:(n=t,s=ia.join(i,t)),this.system.app.loader.load(s,"script",function(t,i){e--,t?console.error(t):i&&this.entity.script&&!this.entity.script.instances[i._pcScriptName]&&(t=new i(this.entity),this.system._preRegisterInstance(this.entity,n,i._pcScriptName,t)),0===e&&(this.data.areScriptsLoaded=!0,this.system.preloading||(this.system.onInitialize(this.entity),this.system.onPostInitialize(this.entity)))}.bind(this))}.bind(this))}});var Pu=["enabled","scripts","instances","runInTools"],Au=function(t){os.call(this,t),this.id="script",this.ComponentType=Bn,this.DataType=Nn,this.schema=Pu,this.preloading=!1,this.instancesWithUpdate=[],this.instancesWithFixedUpdate=[],this.instancesWithPostUpdate=[],this.instancesWithToolsUpdate=[],this.on("beforeremove",this.onBeforeRemove,this),os.bind("initialize",this.onInitialize,this),os.bind("postInitialize",this.onPostInitialize,this),os.bind("update",this.onUpdate,this),os.bind("fixedUpdate",this.onFixedUpdate,this),os.bind("postUpdate",this.onPostUpdate,this),os.bind("toolsUpdate",this.onToolsUpdate,this)};Au.prototype=Object.create(os.prototype),Au.prototype.constructor=Au,as._buildAccessors(Bn.prototype,Pu),Object.assign(Au.prototype,{initializeComponentData:function(t,e,i){i=["runInTools","enabled","scripts"],e.scripts&&e.scripts.length&&e.scripts.forEach(function(t){if(t.attributes&&Array.isArray(t.attributes)){for(var e={},i=0;i<t.attributes.length;i++)e[t.attributes[i].name]=t.attributes[i];t.attributes=e}}),os.prototype.initializeComponentData.call(this,t,e,i)},cloneComponent:function(t,e){var s=this.store[t.getGuid()];t={runInTools:s.data.runInTools,scripts:[],enabled:s.data.enabled};for(var n=0,r=(s=s.data.scripts).length;n<r;n++){var a=s[n].attributes;a&&delete s[n].attributes,t.scripts.push(i({},s[n])),a&&(t.scripts[n].attributes=this._cloneAttributes(a),s[n].attributes=a)}return this.addComponent(e,t)},onBeforeRemove:function(t,e){e.enabled&&this._disableScriptComponent(e),this._destroyScriptComponent(e)},onInitialize:function(t){if(this._registerInstances(t),t.enabled){t.script&&t.script.enabled&&this._initializeScriptComponent(t.script);var e,i=(t=t._children).length;for(e=0;e<i;e++)t[e]instanceof xe&&this.onInitialize(t[e])}},onPostInitialize:function(t){if(t.enabled){t.script&&t.script.enabled&&this._postInitializeScriptComponent(t.script);var e,i=(t=t._children).length;for(e=0;e<i;e++)t[e]instanceof xe&&this.onPostInitialize(t[e])}},_callInstancesMethod:function(t,e){for(var i in t=t.data.instances)if(t.hasOwnProperty(i)){var s=t[i].instance;s[e]&&s[e]()}},_initializeScriptComponent:function(t){this._callInstancesMethod(t,"initialize"),t.data.initialized=!0,t.enabled&&t.entity.enabled&&this._enableScriptComponent(t)},_enableScriptComponent:function(t){this._callInstancesMethod(t,"onEnable")},_disableScriptComponent:function(t){this._callInstancesMethod(t,"onDisable")},_destroyScriptComponent:function(t){var e,i=t.data.instances;for(e in i)if(i.hasOwnProperty(e)){var s=i[e].instance;if(s.destroy&&s.destroy(),s.update){var n=this.instancesWithUpdate.indexOf(s);0<=n&&this.instancesWithUpdate.splice(n,1)}s.fixedUpdate&&(0<=(n=this.instancesWithFixedUpdate.indexOf(s))&&this.instancesWithFixedUpdate.splice(n,1)),s.postUpdate&&(0<=(n=this.instancesWithPostUpdate.indexOf(s))&&this.instancesWithPostUpdate.splice(n,1)),s.toolsUpdate&&(0<=(n=this.instancesWithToolsUpdate.indexOf(s))&&this.instancesWithToolsUpdate.splice(n,1)),t.instances[e].instance===t[e]&&delete t[e],delete t.instances[e]}},_postInitializeScriptComponent:function(t){this._callInstancesMethod(t,"postInitialize"),t.data.postInitialized=!0},_updateInstances:function(t,e,i){for(var s,n=0,r=e.length;n<r;n++)(s=e[n])&&s.entity&&s.entity.enabled&&s.entity.script.enabled&&s[t](i)},onUpdate:function(t){this._updateInstances("update",this.instancesWithUpdate,t)},onFixedUpdate:function(t){this._updateInstances("fixedUpdate",this.instancesWithFixedUpdate,t)},onPostUpdate:function(t){this._updateInstances("postUpdate",this.instancesWithPostUpdate,t)},onToolsUpdate:function(t){this._updateInstances("toolsUpdate",this.instancesWithToolsUpdate,t)},broadcast:function(t,e){var i,s,n=Array.prototype.slice.call(arguments,2),r=this.store;for(i in r)if(r.hasOwnProperty(i)){var a=r[i].data;a.instances[t]&&(s=a.instances[t].instance[e])&&s.apply(a.instances[t].instance,n)}},_preRegisterInstance:function(t,e,i,s){if(t.script){if(t.script.data._instances=t.script.data._instances||{},t.script.data._instances[i])throw Error("Script name collision '"+i+"'. Scripts from '"+e+"' and '"+t.script.data._instances[i].url+"' {"+t.getGuid()+"}");t.script.data._instances[i]={url:e,name:i,instance:s}}},_registerInstances:function(t){var e;if(t.script&&t.script.data._instances){for(e in t.script.instances=t.script.data._instances,t.script.instances){var i=t.script.instances[e],s=i.instance;if(ta.attach(s),s.update&&this.instancesWithUpdate.push(s),s.fixedUpdate&&this.instancesWithFixedUpdate.push(s),s.postUpdate&&this.instancesWithPostUpdate.push(s),s.toolsUpdate&&this.instancesWithToolsUpdate.push(s),t.script.scripts&&this._createAccessors(t,i),t.script[e])throw Error("Script with name '"+e+"' is already attached to Script Component");t.script[e]=s}delete t.script.data._instances}for(s=(t=t._children).length,i=0;i<s;i++)t[i]instanceof xe&&this._registerInstances(t[i])},_cloneAttributes:function(t){var e,s={};for(e in t)if(t.hasOwnProperty(e))if("entity"!==t[e].type)s[e]=i({},t[e]);else{var n=t[e].value;delete t[e].value,s[e]=i({},t[e]),s[e].value=n,t[e].value=n}return s},_createAccessors:function(t,e){var i,s=t.script.scripts.length,n=e.url;for(i=0;i<s;i++){var r=t.script.scripts[i];if(r.url===n){if(i=r.attributes,r.name&&i){for(var a in i)i.hasOwnProperty(a)&&this._createAccessor(i[a],e);t.script.data.attributes[r.name]=this._cloneAttributes(i)}break}}},_createAccessor:function(t,e){var i=this;t={name:t.name,value:t.value,type:t.type},i._convertAttributeValue(t),Object.defineProperty(e.instance,t.name,{get:function(){return t.value},set:function(s){var n=t.value;t.value=s,i._convertAttributeValue(t),e.instance.fire("set",t.name,n,t.value)},configurable:!0})},_updateAccessors:function(t,e){var i,s,n=t.script.scripts.length,r=e.url;for(i=0;i<n;i++){var a=t.script,o=a.scripts[i];if(o.url===r){if(t=o.name,o=o.attributes,t){if(o)for(s in o)o.hasOwnProperty(s)&&this._createAccessor(o[s],e);if(i=a.data.attributes[t])for(s in i)n=i[s],s in o?o[s].value!==n.value&&e.instance.onAttributeChanged&&e.instance.onAttributeChanged(n.name,n.value,o[s].value):delete e.instance[n.name];o?a.data.attributes[t]=this._cloneAttributes(o):delete a.data.attributes[t]}break}}},_convertAttributeValue:function(t){"rgb"===t.type||"rgba"===t.type?Array.isArray(t.value)&&(t.value=3===t.value.length?new o(t.value[0],t.value[1],t.value[2]):new o(t.value[0],t.value[1],t.value[2],t.value[3])):"vec2"===t.type?Array.isArray(t.value)&&(t.value=new y(t.value[0],t.value[1])):"vec3"===t.type||"vector"===t.type?Array.isArray(t.value)&&(t.value=new v(t.value[0],t.value[1],t.value[2])):"vec4"===t.type?Array.isArray(t.value)&&(t.value=new b(t.value[0],t.value[1],t.value[2],t.value[3])):"entity"===t.type?null!==t.value&&"string"==typeof t.value&&(t.value=this.app.root.findByGuid(t.value)):"curve"!==t.type&&"colorcurve"!==t.type||(t.value=new(t.value.keys[0]instanceof Array?_:m)(t.value.keys),t.value.type=t.value.type)}});var Eu=new y,Cu=new v,Iu=new v,Ou=new v,Ru=new v,Du=new v,Lu=new S,Fu={x:"y",y:"x"};kn.prototype=Object.create(n.prototype),kn.prototype.constructor=kn,Object.assign(kn.prototype,{_toggleLifecycleListeners:function(t){this._element[t]("mousedown",this._onMouseDownOrTouchStart,this),this._element[t]("touchstart",this._onMouseDownOrTouchStart,this)},_toggleDragListeners:function(t){var e="on"===t,i=e?"addEventListener":"removeEventListener";this._hasDragListeners&&e||(this._handleMouseUpOrTouchEnd||(this._handleMouseUpOrTouchEnd=this._onMouseUpOrTouchEnd.bind(this)),this._app.mouse&&(this._app.mouse[t]("mousemove",this._onMove,this),window[i]("mouseup",this._handleMouseUpOrTouchEnd,!1)),sa.touch&&(this._app.touch[t]("touchmove",this._onMove,this),window[i]("touchend",this._handleMouseUpOrTouchEnd,!1),window[i]("touchcancel",this._handleMouseUpOrTouchEnd,!1)),this._hasDragListeners=e)},_onMouseDownOrTouchStart:function(t){this._element&&!this._isDragging&&this.enabled&&(this._dragCamera=t.camera,this._calculateDragScale(),t=this._screenToLocal(t))&&(this._toggleDragListeners("on"),this._isDragging=!0,this._dragStartMousePosition.copy(t),this._dragStartHandlePosition.copy(this._element.entity.getLocalPosition()),this.fire("drag:start"))},_onMouseUpOrTouchEnd:function(){this._isDragging&&(this._isDragging=!1,this._toggleDragListeners("off"),this.fire("drag:end"))},_screenToLocal:function(t){return this._determineInputPosition(t),this._chooseRayOriginAndDirection(),Ru.copy(this._element.entity.getPosition()),Du.copy(this._element.entity.forward).scale(-1),t=Du.dot(Ou),0<Math.abs(t)?(t=Ru.sub(Iu).dot(Du)/t,t=Iu.add(Ou.scale(t)),Lu.copy(this._element.entity.getRotation()).invert().transformVector(t,t),t.mul(this._dragScale),t):null},_determineInputPosition:function(t){var e=this._app.graphicsDevice.maxPixelRatio;void 0!==t.x&&void 0!==t.y?(Eu.x=t.x*e,Eu.y=t.y*e):t.changedTouches?(Eu.x=t.changedTouches[0].x*e,Eu.y=t.changedTouches[0].y*e):console.warn("Could not determine position from input event")},_chooseRayOriginAndDirection:function(){this._element.screen&&this._element.screen.screen.screenSpace?(Iu.set(Eu.x,-Eu.y,0),Ou.set(0,0,-1)):(Cu.copy(this._dragCamera.screenToWorld(Eu.x,Eu.y,1)),Iu.copy(this._dragCamera.entity.getPosition()),Ou.copy(Cu).sub(Iu).normalize())},_calculateDragScale:function(){var t=this._element.entity.parent,e=this._element.screen&&this._element.screen.screen,i=e&&e.screenSpace;e=i?e.scale:1;var s=this._dragScale;for(s.set(e,e,e);t&&(s.mul(t.getLocalScale()),t=t.parent,!i||!t.screen););s.x=1/s.x,s.y=1/s.y,s.z=1/s.z},_onMove:function(t){if(this._element&&this._isDragging&&this.enabled&&this._element.enabled&&this._element.entity.enabled&&(t=this._screenToLocal(t),this._dragStartMousePosition&&t)){if(this._deltaMousePosition.copy(t).sub(this._dragStartMousePosition),this._deltaHandlePosition.copy(this._dragStartHandlePosition).add(this._deltaMousePosition),this._axis){t=this._element.entity.getLocalPosition();var e=Fu[this._axis];this._deltaHandlePosition[e]=t[e]}this._element.entity.setLocalPosition(this._deltaHandlePosition),this.fire("drag:move",this._deltaHandlePosition)}},destroy:function(){this._toggleLifecycleListeners("off"),this._toggleDragListeners("off")}}),Object.defineProperty(kn.prototype,"enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t}}),Object.defineProperty(kn.prototype,"isDragging",{get:function(){return this._isDragging}});var Bu=new y;zn.prototype=Object.create(as.prototype),zn.prototype.constructor=zn,Object.assign(zn.prototype,{_toggleLifecycleListeners:function(t,e){this[t]("set_horizontal",this._onSetHorizontalScrollingEnabled,this),this[t]("set_vertical",this._onSetVerticalScrollingEnabled,this),e.app.systems.element[t]("add",this._onElementComponentAdd,this),e.app.systems.element[t]("beforeremove",this._onElementComponentRemove,this)},_toggleElementListeners:function(t){!this.entity.element||"on"===t&&this._hasElementListeners||(this.entity.element[t]("resize",this._onSetContentOrViewportSize,this),this._hasElementListeners="on"===t)},_onElementComponentAdd:function(t){this.entity===t&&this._toggleElementListeners("on")},_onElementComponentRemove:function(t){this.entity===t&&this._toggleElementListeners("off")},_onViewportElementGain:function(){this._syncAll()},_onContentElementGain:function(){this._destroyDragHelper(),this._contentDragHelper=new kn(this._contentReference.entity.element),this._contentDragHelper.on("drag:start",this._onContentDragStart,this),this._contentDragHelper.on("drag:end",this._onContentDragEnd,this),this._contentDragHelper.on("drag:move",this._onContentDragMove,this),this._prevContentSizes[0]=null,this._prevContentSizes[1]=null,this._syncAll()},_onContentElementLose:function(){this._destroyDragHelper()},_onContentDragStart:function(){this._contentReference.entity&&this.enabled&&this.entity.enabled&&this._dragStartPosition.copy(this._contentReference.entity.getLocalPosition())},_onContentDragEnd:function(){this._prevContentDragPosition=null,this._enableContentInput()},_onContentDragMove:function(t){if(this._contentReference.entity&&this.enabled&&this.entity.enabled&&(this._wasDragged=!0,this._setScrollFromContentPosition(t),this._setVelocityFromContentPositionDelta(t),!this._disabledContentInput)){var e=t.y-this._dragStartPosition.y;(Math.abs(t.x-this._dragStartPosition.x)>this.dragThreshold||Math.abs(e)>this.dragThreshold)&&this._disableContentInput()}},_onSetContentOrViewportSize:function(){this._syncAll()},_onSetHorizontalScrollbarValue:function(t){!this._scrollbarUpdateFlags[0]&&this.enabled&&this.entity.enabled&&this._onSetScroll(t,null)},_onSetVerticalScrollbarValue:function(t){!this._scrollbarUpdateFlags[1]&&this.enabled&&this.entity.enabled&&this._onSetScroll(null,t)},_onSetHorizontalScrollingEnabled:function(){this._syncScrollbarEnabledState(0)},_onSetVerticalScrollingEnabled:function(){this._syncScrollbarEnabledState(1)},_onHorizontalScrollbarGain:function(){this._syncScrollbarEnabledState(0),this._syncScrollbarPosition(0)},_onVerticalScrollbarGain:function(){this._syncScrollbarEnabledState(1),this._syncScrollbarPosition(1)},_onSetScroll:function(t,e,i){!1!==i&&this._velocity.set(0,0,0),t=0|this._updateAxis(t,"x",0),(t|=this._updateAxis(e,"y",1))&&this.fire("set:scroll",this._scroll)},_updateAxis:function(t,e,i){var s=null!==t&&1e-5<Math.abs(t-this._scroll[e]);return(s||this._isDragging()||0===t)&&(this._scroll[e]=this._determineNewScrollValue(t,e,i),this._syncContentPosition(i),this._syncScrollbarPosition(i)),s},_determineNewScrollValue:function(t,e,i){if(!this._getScrollingEnabled(i))return this._scroll[e];switch(this.scrollMode){case 0:return oa.clamp(t,0,this._getMaxScrollValue(i));case 1:return this._setVelocityFromOvershoot(t,e,i),t;case 2:return t;default:return console.warn("Unhandled scroll mode:"+this.scrollMode),t}},_syncAll:function(){this._syncContentPosition(0),this._syncContentPosition(1),this._syncScrollbarPosition(0),this._syncScrollbarPosition(1),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1)},_syncContentPosition:function(t){var e=this._getAxis(t),i=this._getSign(t),s=this._contentReference.entity;if(s){var n=this._prevContentSizes[t],r=this._getContentSize(t);if(null!==n&&1e-4<Math.abs(n-r)){n=this._getMaxOffset(t,n);var a=this._getMaxOffset(t,r);this._scroll[e]=0===a?1:oa.clamp(this._scroll[e]*n/a,0,1)}n=this._scroll[e]*this._getMaxOffset(t),(a=s.getLocalPosition())[e]=n*i,s.setLocalPosition(a),this._prevContentSizes[t]=r}},_syncScrollbarPosition:function(t){var e=this._getAxis(t),i=this._scrollbarReferences[t].entity;i&&i.scrollbar&&(this._scrollbarUpdateFlags[t]=!0,i.scrollbar.value=this._scroll[e],i.scrollbar.handleSize=this._getScrollbarHandleSize(e,t),this._scrollbarUpdateFlags[t]=!1)},_syncScrollbarEnabledState:function(t){var e=this._scrollbarReferences[t].entity;if(e){var i=this._getScrollingEnabled(t),s=this._getScrollbarVisibility(t);switch(s){case 0:e.enabled=i;break;case 1:e.enabled=i&&this._contentIsLargerThanViewport(t);break;default:console.warn("Unhandled scrollbar visibility:"+s),e.enabled=i}}},_contentIsLargerThanViewport:function(t){return this._getContentSize(t)>this._getViewportSize(t)},_contentPositionToScrollValue:function(t){var e=this._getMaxOffset(0),i=this._getMaxOffset(1);return Bu.x=0===e?0:t.x/e,Bu.y=0===i?0:t.y/-i,Bu},_getMaxOffset:function(t,e){e=void 0===e?this._getContentSize(t):e;var i=this._getViewportSize(t);return e<i?-this._getViewportSize(t):i-e},_getMaxScrollValue:function(t){return this._contentIsLargerThanViewport(t)?1:0},_getScrollbarHandleSize:function(t,e){var i=this._getViewportSize(e),s=this._getContentSize(e);return.001>Math.abs(s)?1:(i=Math.min(i/s,1),0===(t=this._toOvershoot(this._scroll[t],e))?i:i/(1+Math.abs(t)))},_getViewportSize:function(t){return this._getSize(t,this._viewportReference)},_getContentSize:function(t){return this._getSize(t,this._contentReference)},_getSize:function(t,e){return e.entity&&e.entity.element?e.entity.element[this._getCalculatedDimension(t)]:0},_getScrollingEnabled:function(t){return 0===t?this.horizontal:1===t?this.vertical:void console.warn("Unrecognized orientation: "+t)},_getScrollbarVisibility:function(t){return 0===t?this.horizontalScrollbarVisibility:1===t?this.verticalScrollbarVisibility:void console.warn("Unrecognized orientation: "+t)},_getSign:function(t){return 0===t?1:-1},_getAxis:function(t){return 0===t?"x":"y"},_getCalculatedDimension:function(t){return 0===t?"calculatedWidth":"calculatedHeight"},_destroyDragHelper:function(){this._contentDragHelper&&this._contentDragHelper.destroy()},onUpdate:function(){this._contentReference.entity&&(this._updateVelocity(),this._syncScrollbarEnabledState(0),this._syncScrollbarEnabledState(1))},_updateVelocity:function(){if(!this._isDragging()&&(1===this.scrollMode&&(this._hasOvershoot("x",0)&&this._setVelocityFromOvershoot(this.scroll.x,"x",0),this._hasOvershoot("y",1)&&this._setVelocityFromOvershoot(this.scroll.y,"y",1)),this._velocity.x*=1-this.friction,this._velocity.y*=1-this.friction,1e-4<Math.abs(this._velocity.x)||1e-4<Math.abs(this._velocity.y))){var t=this._contentReference.entity.getLocalPosition();t.x+=this._velocity.x,t.y+=this._velocity.y,this._contentReference.entity.setLocalPosition(t),this._setScrollFromContentPosition(t)}},_hasOvershoot:function(t,e){return.001<Math.abs(this._toOvershoot(this.scroll[t],e))},_toOvershoot:function(t,e){return e=this._getMaxScrollValue(e),0>t?t:t>e?t-e:0},_setVelocityFromOvershoot:function(t,e,i){t=this._toOvershoot(t,i)*this._getMaxOffset(i)*this._getSign(i),0<Math.abs(t)&&(this._velocity[e]=-t/(50*this.bounceAmount+1))},_setVelocityFromContentPositionDelta:function(t){this._prevContentDragPosition?(this._velocity.sub2(t,this._prevContentDragPosition),this._prevContentDragPosition.copy(t)):(this._velocity.set(0,0,0),this._prevContentDragPosition=t.clone())},_setScrollFromContentPosition:function(t){t=this._contentPositionToScrollValue(t),this._isDragging()&&(t=this._applyScrollValueTension(t)),this._onSetScroll(t.x,t.y,!1)},_applyScrollValueTension:function(t){var e=this._getMaxScrollValue(0),i=this._toOvershoot(t.x,0);return 0<i?t.x=e+1*Math.log10(1+i):0>i&&(t.x=-1*Math.log10(1-i)),e=this._getMaxScrollValue(1),0<(i=this._toOvershoot(t.y,1))?t.y=e+1*Math.log10(1+i):0>i&&(t.y=-1*Math.log10(1-i)),t},_isDragging:function(){return this._contentDragHelper&&this._contentDragHelper.isDragging},_setScrollbarComponentsEnabled:function(t){this._scrollbarReferences[0].hasComponent("scrollbar")&&(this._scrollbarReferences[0].entity.scrollbar.enabled=t),this._scrollbarReferences[1].hasComponent("scrollbar")&&(this._scrollbarReferences[1].entity.scrollbar.enabled=t)},_setContentDraggingEnabled:function(t){this._contentDragHelper&&(this._contentDragHelper.enabled=t)},_enableContentInput:function(){for(;this._disabledContentInputEntities.length;){var t=this._disabledContentInputEntities.pop();t.element&&(t.element.useInput=!0)}this._disabledContentInput=!1},_disableContentInput:function(){var t=this,e=function(i){var s;i.element&&i.element.useInput&&(t._disabledContentInputEntities.push(i),i.element.useInput=!1);var n=0;for(s=(i=i.children).length;n<s;n++)e(i[n])},i=this._contentReference.entity;if(i){var s,n=(i=i.children).length;for(s=0;s<n;s++)e(i[s])}this._disabledContentInput=!0},onEnable:function(){this._viewportReference.onParentComponentEnable(),this._contentReference.onParentComponentEnable(),this._scrollbarReferences[0].onParentComponentEnable(),this._scrollbarReferences[1].onParentComponentEnable(),this._setScrollbarComponentsEnabled(!0),this._setContentDraggingEnabled(!0),this._syncAll()},onDisable:function(){this._setScrollbarComponentsEnabled(!1),this._setContentDraggingEnabled(!1)},onRemove:function(){this._toggleLifecycleListeners("off",this.system),this._toggleElementListeners("off"),this._destroyDragHelper()}}),Object.defineProperty(zn.prototype,"scroll",{get:function(){return this._scroll},set:function(t){this._onSetScroll(t.x,t.y)}});var Nu=[{name:"enabled",type:"boolean"},{name:"horizontal",type:"boolean"},{name:"vertical",type:"boolean"},{name:"scrollMode",type:"number"},{name:"bounceAmount",type:"number"},{name:"friction",type:"number"},{name:"dragThreshold",type:"number"},{name:"horizontalScrollbarVisibility",type:"number"},{name:"verticalScrollbarVisibility",type:"number"},{name:"viewportEntity",type:"entity"},{name:"contentEntity",type:"entity"},{name:"horizontalScrollbarEntity",type:"entity"},{name:"verticalScrollbarEntity",type:"entity"}],ku=function(t){os.call(this,t),this.id="scrollview",this.ComponentType=zn,this.DataType=Un,this.schema=Nu,this.on("beforeremove",this._onRemoveComponent,this),os.bind("update",this.onUpdate,this)};ku.prototype=Object.create(os.prototype),ku.prototype.constructor=ku,as._buildAccessors(zn.prototype,Nu),Object.assign(ku.prototype,{initializeComponentData:function(t,e,i){void 0===e.dragThreshold&&(e.dragThreshold=10),os.prototype.initializeComponentData.call(this,t,e,Nu)},onUpdate:function(t){for(var e in t=this.store){var i=t[e].entity,s=i.scrollview;s.enabled&&i.enabled&&s.onUpdate()}},_onRemoveComponent:function(t,e){e.onRemove()}}),Vn.prototype=Object.create(as.prototype),Vn.prototype.constructor=Vn,Object.assign(Vn.prototype,{_toggleLifecycleListeners:function(t){this[t]("set_value",this._onSetValue,this),this[t]("set_handleSize",this._onSetHandleSize,this),this[t]("set_orientation",this._onSetOrientation,this)},_onHandleElementGain:function(){this._destroyDragHelper(),this._handleDragHelper=new kn(this._handleReference.entity.element,this._getAxis()),this._handleDragHelper.on("drag:move",this._onHandleDrag,this),this._updateHandlePositionAndSize()},_onHandleElementLose:function(){this._destroyDragHelper()},_onHandleDrag:function(t){this._handleReference.entity&&this.enabled&&this.entity.enabled&&(this.value=this._handlePositionToScrollValue(t[this._getAxis()]))},_onSetValue:function(t,e,i){1e-5<Math.abs(i-e)&&(this.data.value=oa.clamp(i,0,1),this._updateHandlePositionAndSize(),this.fire("set:value",this.data.value))},_onSetHandleSize:function(t,e,i){1e-5<Math.abs(i-e)&&(this.data.handleSize=oa.clamp(i,0,1),this._updateHandlePositionAndSize())},_onSetHandleAlignment:function(){this._updateHandlePositionAndSize()},_onSetOrientation:function(t,e,i){i!==e&&this._handleReference.hasComponent("element")&&(this._handleReference.entity.element[this._getOppositeDimension()]=0)},_updateHandlePositionAndSize:function(){var t=this._handleReference.entity,e=t&&t.element;t&&((t=t.getLocalPosition())[this._getAxis()]=this._getHandlePosition(),this._handleReference.entity.setLocalPosition(t)),e&&(e[this._getDimension()]=this._getHandleLength())},_handlePositionToScrollValue:function(t){return t*this._getSign()/this._getUsableTrackLength()},_scrollValueToHandlePosition:function(t){return t*this._getSign()*this._getUsableTrackLength()},_getUsableTrackLength:function(){return Math.max(this._getTrackLength()-this._getHandleLength(),.001)},_getTrackLength:function(){return this.entity.element?0===this.orientation?this.entity.element.calculatedWidth:this.entity.element.calculatedHeight:0},_getHandleLength:function(){return this._getTrackLength()*this.handleSize},_getHandlePosition:function(){return this._scrollValueToHandlePosition(this.value)},_getSign:function(){return 0===this.orientation?1:-1},_getAxis:function(){return 0===this.orientation?"x":"y"},_getDimension:function(){return 0===this.orientation?"width":"height"},_getOppositeDimension:function(){return 0===this.orientation?"height":"width"},_destroyDragHelper:function(){this._handleDragHelper&&this._handleDragHelper.destroy()},_setHandleDraggingEnabled:function(t){this._handleDragHelper&&(this._handleDragHelper.enabled=t)},onEnable:function(){this._handleReference.onParentComponentEnable(),this._setHandleDraggingEnabled(!0)},onDisable:function(){this._setHandleDraggingEnabled(!1)},onRemove:function(){this._destroyDragHelper(),this._toggleLifecycleListeners("off")}});var zu=[{name:"enabled",type:"boolean"},{name:"orientation",type:"number"},{name:"value",type:"number"},{name:"handleSize",type:"number"},{name:"handleEntity",type:"entity"}];if(Gn.prototype=Object.create(os.prototype),Gn.prototype.constructor=Gn,as._buildAccessors(Vn.prototype,zu),Object.assign(Gn.prototype,{initializeComponentData:function(t,e,i){os.prototype.initializeComponentData.call(this,t,e,zu)},_onRemoveComponent:function(t,e){e.onRemove()}}),ue()?(t.SoundInstance=function(t,e,i){n.call(this),i=i||{},this._volume=void 0!==i.volume?oa.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=e,this._state=2,this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startedAt=0,this._startOffset=null,this._currentOffset=this._currentTime=0,this._playWhenLoaded=!0,this._manager=t,this._lastNode=this._firstNode=this._connectorNode=this._inputNode=null,this._initializeNodes(),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this._endedHandler=this._onEnded.bind(this),this.source=null},t.SoundInstance.prototype=Object.create(n.prototype),t.SoundInstance.prototype.constructor=t.SoundInstance,Object.assign(t.SoundInstance.prototype,{_initializeNodes:function(){this._connectorNode=this._inputNode=this.gain=this._manager.context.createGain(),this._connectorNode.connect(this._manager.context.destination)},play:function(){2!==this._state&&this.stop(),this.source||this._createSource();var t=this._startOffset%this.duration||0;return t=(this._startTime+t)%this._sound.duration||0,this._startOffset=null,this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._startedAt=this._manager.context.currentTime,this._currentTime=0,this._currentOffset=t,this._state=0,this._playWhenLoaded=!1,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0},pause:function(){return!(0!==this._state||!this.source)&&(this._updateCurrentTime(),this._state=1,this._suspendEndEvent=!0,this.source.stop(0),this.source=null,this._playWhenLoaded=!1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){if(1!==this._state)return!1;this.source||this._createSource();var t=this.currentTime;return null!==this._startOffset&&(t=this._startOffset%this.duration||0,t=(this._startTime+t)%this._sound.duration||0,this._startOffset=null),this._duration?this.source.start(0,t,this._duration):this.source.start(0,t),this._state=0,this._startedAt=this._manager.context.currentTime,this._currentOffset=t,this.volume=this._volume,this.loop=this._loop,this.pitch=this._pitch,this._playWhenLoaded=!1,this._suspendInstanceEvents||this._onResume(),!0},stop:function(){return!(2===this._state||!this.source)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._currentOffset=this._currentTime=this._startedAt=0,this._startOffset=null,this._playWhenLoaded=!1,this._suspendEndEvent=!0,0===this._state&&this.source.stop(0),this.source=null,this._state=2,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(t,e){if(t){e||(e=t);var i=this._manager.context.destination;this._firstNode!==t&&(this._firstNode?this._connectorNode.disconnect(this._firstNode):this._connectorNode.disconnect(i),this._firstNode=t,this._connectorNode.connect(t)),this._lastNode!==e&&(this._lastNode&&this._lastNode.disconnect(i),this._lastNode=e,this._lastNode.connect(i))}else console.error("The firstNode must be a valid Audio Node")},clearExternalNodes:function(){var t=this._manager.context.destination;this._firstNode&&(this._connectorNode.disconnect(this._firstNode),this._firstNode=null),this._lastNode&&(this._lastNode.disconnect(t),this._lastNode=null),this._connectorNode.connect(t)},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_createSource:function(){if(!this._sound)return null;var t=this._manager.context;return this._sound.buffer&&(this.source=t.createBufferSource(),this.source.buffer=this._sound.buffer,this.source.connect(this._inputNode),this.source.onended=this._endedHandler,this.source.loopStart=this._startTime%this.source.buffer.duration||0,this._duration&&(this.source.loopEnd=Math.max(this.source.loopStart,(this._startTime+this._duration)%this.source.buffer.duration||0))),this.source},_updateCurrentTime:function(){this._currentTime=((this._manager.context.currentTime-this._startedAt)*this._pitch+this._currentOffset)%this.duration||0},_onManagerDestroy:function(){this.source&&0===this._state&&(this.source.stop(0),this.source=null)}}),Object.defineProperty(t.SoundInstance.prototype,"volume",{get:function(){return this._volume},set:function(t){this._volume=t=oa.clamp(t,0,1),this.gain&&(this.gain.gain.value=t*this._manager.volume)}}),Object.defineProperty(t.SoundInstance.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._currentOffset=this.currentTime,this._startedAt=this._manager.context.currentTime,this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate.value=this._pitch)}}),Object.defineProperty(t.SoundInstance.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(t.SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(t){this._sound=t,2!==this._state?this.stop():this._createSource()}}),Object.defineProperty(t.SoundInstance.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:1===this._state?this._currentTime:2!==this._state&&this.source?(this._updateCurrentTime(),this._currentTime):0},set:function(t){if(!(0>t))if(0===this._state){this.stop();var e=this._suspendInstanceEvents;this._suspendInstanceEvents=!0,this._startOffset=t,this.play(),this._suspendInstanceEvents=e}else this._currentTime=this._startOffset=t}})):de()?(t.SoundInstance=function(t,e,i){n.call(this),i=i||{},this._volume=void 0!==i.volume?oa.clamp(Number(i.volume)||0,0,1):1,this._pitch=void 0!==i.pitch?Math.max(.01,Number(i.pitch)||0):1,this._loop=!(void 0===i.loop||!i.loop),this._sound=e,this._state=2,this._suspendInstanceEvents=this._suspendEndEvent=this._suspended=!1,this._playWhenLoaded=!0,this._startTime=Math.max(0,Number(i.startTime)||0),this._duration=Math.max(0,Number(i.duration)||0),this._startOffset=null,this._isReady=!1,this._manager=t,this._loadedMetadataHandler=this._onLoadedMetadata.bind(this),this._timeUpdateHandler=this._onTimeUpdate.bind(this),this._endedHandler=this._onEnded.bind(this),this._onPlayCallback=i.onPlay,this._onPauseCallback=i.onPause,this._onResumeCallback=i.onResume,this._onStopCallback=i.onStop,this._onEndCallback=i.onEnd,this.source=null,this._createSource()},t.SoundInstance.prototype=Object.create(n.prototype),t.SoundInstance.prototype.constructor=t.SoundInstance,Object.assign(t.SoundInstance.prototype,{play:function(){return 2!==this._state&&this.stop(),!(!this.source&&!this._createSource())&&(this.volume=this._volume,this.pitch=this._pitch,this.loop=this._loop,this.source.play(),this._state=0,this._playWhenLoaded=!1,this._manager.on("volumechange",this._onManagerVolumeChange,this),this._manager.on("suspend",this._onManagerSuspend,this),this._manager.on("resume",this._onManagerResume,this),this._manager.on("destroy",this._onManagerDestroy,this),this._manager.suspended&&this._onManagerSuspend(),this._suspendInstanceEvents||this._onPlay(),!0)},pause:function(){return!(!this.source||0!==this._state)&&(this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=1,this._startOffset=null,this._suspendInstanceEvents||this._onPause(),!0)},resume:function(){return!(!this.source||1!==this._state)&&(this._state=0,this._playWhenLoaded=!1,this.source.paused&&(this.source.play(),this._suspendInstanceEvents||this._onResume()),!0)},stop:function(){return!(!this.source||2===this._state)&&(this._manager.off("volumechange",this._onManagerVolumeChange,this),this._manager.off("suspend",this._onManagerSuspend,this),this._manager.off("resume",this._onManagerResume,this),this._manager.off("destroy",this._onManagerDestroy,this),this._suspendEndEvent=!0,this.source.pause(),this._playWhenLoaded=!1,this._state=2,this._startOffset=null,this._suspendInstanceEvents||this._onStop(),!0)},setExternalNodes:function(){},clearExternalNodes:function(){},getExternalNodes:function(){return[null,null]},_onLoadedMetadata:function(){this.source.removeEventListener("loadedmetadata",this._loadedMetadataHandler),this._isReady=!0;var t=this._startOffset%this.duration||0;t=(this._startTime+t)%this._sound.duration||0,this._startOffset=null,this.source.currentTime=t},_createSource:function(){return this._sound&&this._sound.audio&&(this._isReady=!1,this.source=this._sound.audio.cloneNode(!0),this.source.addEventListener("loadedmetadata",this._loadedMetadataHandler),this.source.addEventListener("timeupdate",this._timeUpdateHandler),this.source.onended=this._endedHandler),this.source},_onTimeUpdate:function(){this._duration&&this.source.currentTime>((this._startTime+this._duration)%this.source.duration||0)&&(this.loop?this.source.currentTime=this._startTime%this.source.duration||0:(this.source.removeEventListener("timeupdate",this._timeUpdateHandler),this.source.pause(),this._onEnded()))},_onManagerDestroy:function(){this.source&&this.source.pause()}}),Object.defineProperty(t.SoundInstance.prototype,"volume",{get:function(){return this._volume},set:function(t){this._volume=t=oa.clamp(t,0,1),this.source&&(this.source.volume=t*this._manager.volume)}}),Object.defineProperty(t.SoundInstance.prototype,"pitch",{get:function(){return this._pitch},set:function(t){this._pitch=Math.max(Number(t)||0,.01),this.source&&(this.source.playbackRate=this._pitch)}}),Object.defineProperty(t.SoundInstance.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=!!t,this.source&&(this.source.loop=this._loop)}}),Object.defineProperty(t.SoundInstance.prototype,"sound",{get:function(){return this._sound},set:function(t){this.stop(),this._sound=t}}),Object.defineProperty(t.SoundInstance.prototype,"currentTime",{get:function(){return null!==this._startOffset?this._startOffset:2!==this._state&&this.source?this.source.currentTime-this._startTime:0},set:function(t){0>t||(this._startOffset=t,this.source&&this._isReady&&(this.source.currentTime=(this._startTime+(t%this.duration||0))%this._sound.duration||0,this._startOffset=null))}})):t.SoundInstance=function(){},Object.assign(t.SoundInstance.prototype,{_onPlay:function(){this.fire("play"),this._onPlayCallback&&this._onPlayCallback(this)},_onPause:function(){this.fire("pause"),this._onPauseCallback&&this._onPauseCallback(this)},_onResume:function(){this.fire("resume"),this._onResumeCallback&&this._onResumeCallback(this)},_onStop:function(){this.fire("stop"),this._onStopCallback&&this._onStopCallback(this)},_onEnded:function(){this._suspendEndEvent?this._suspendEndEvent=!1:(this.fire("end"),this._onEndCallback&&this._onEndCallback(this),this.stop())},_onManagerVolumeChange:function(){this.volume=this._volume},_onManagerSuspend:function(){0!==this._state||this._suspended||(this._suspended=!0,this.pause())},_onManagerResume:function(){this._suspended&&(this._suspended=!1,this.resume())}}),Object.defineProperty(t.SoundInstance.prototype,"startTime",{get:function(){return this._startTime},set:function(t){this._startTime=Math.max(0,Number(t)||0),t=0===this._state,this.stop(),t&&this.play()}}),Object.defineProperty(t.SoundInstance.prototype,"duration",{get:function(){return this._sound?this._duration?this._duration%this._sound.duration||0:this._sound.duration:0},set:function(t){this._duration=Math.max(0,Number(t)||0),t=0===this._state,this.stop(),t&&this.play()}}),Object.defineProperty(t.SoundInstance.prototype,"isPlaying",{get:function(){return 0===this._state}}),Object.defineProperty(t.SoundInstance.prototype,"isPaused",{get:function(){return 1===this._state}}),Object.defineProperty(t.SoundInstance.prototype,"isStopped",{get:function(){return 2===this._state}}),Object.defineProperty(t.SoundInstance.prototype,"isSuspended",{get:function(){return this._suspended}}),ue())t.SoundInstance3d=function(e,i,s){t.SoundInstance.call(this,e,i,s),s=s||{},this._position=new v,s.position&&(this.position=s.position),this._velocity=new v,s.velocity&&(this.velocity=s.velocity),this.maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this.refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this.rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this.distanceModel=void 0!==s.distanceModel?s.distanceModel:"linear"},t.SoundInstance3d.prototype=Object.create(t.SoundInstance.prototype),t.SoundInstance3d.prototype.constructor=t.SoundInstance3d,Object.assign(t.SoundInstance3d.prototype,{_initializeNodes:function(){this.gain=this._manager.context.createGain(),this.panner=this._manager.context.createPanner(),this.panner.connect(this.gain),this._inputNode=this.panner,this._connectorNode=this.gain,this._connectorNode.connect(this._manager.context.destination)}}),Object.defineProperty(t.SoundInstance3d.prototype,"position",{get:function(){return this._position},set:function(t){this._position.copy(t),this.panner.setPosition(t.x,t.y,t.z)}}),Object.defineProperty(t.SoundInstance3d.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t),this.panner.setVelocity(t.x,t.y,t.z)}}),Object.defineProperty(t.SoundInstance3d.prototype,"maxDistance",{get:function(){return this.panner.maxDistance},set:function(t){this.panner.maxDistance=t}}),Object.defineProperty(t.SoundInstance3d.prototype,"refDistance",{get:function(){return this.panner.refDistance},set:function(t){this.panner.refDistance=t}}),Object.defineProperty(t.SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this.panner.rolloffFactor},set:function(t){this.panner.rolloffFactor=t}}),Object.defineProperty(t.SoundInstance3d.prototype,"distanceModel",{get:function(){return this.panner.distanceModel},set:function(t){this.panner.distanceModel=t}});else if(de()){var Uu=new v;t.SoundInstance3d=function(e,i,s){t.SoundInstance.call(this,e,i,s),s=s||{},this._position=new v,s.position&&(this.position=s.position),this._velocity=new v,s.velocity&&(this.velocity=s.velocity),this._maxDistance=void 0!==s.maxDistance?Number(s.maxDistance):1e4,this._refDistance=void 0!==s.refDistance?Number(s.refDistance):1,this._rollOffFactor=void 0!==s.rollOffFactor?Number(s.rollOffFactor):1,this._distanceModel=void 0!==s.distanceModel?s.distanceModel:"linear"},t.SoundInstance3d.prototype=Object.create(t.SoundInstance.prototype),t.SoundInstance3d.prototype.constructor=t.SoundInstance3d,Object.defineProperty(t.SoundInstance3d.prototype,"position",{get:function(){return this._position},set:function(t){if(this._position.copy(t),this.source){var e=this._manager.listener.getPosition();t=this.refDistance;var i=this.maxDistance,s=this.rollOffFactor,n=this.distanceModel;if((e=(Uu=Uu.sub2(e,this._position)).length())<t)t=1;else if(e>i)t=0;else{var r=0;"linear"===n?r=1-s*(e-t)/(i-t):n===il?r=t/(t+s*(e-t)):"exponential"===n&&(r=Math.pow(e/t,-s)),t=oa.clamp(r,0,1)}this.source.volume=this.volume*t*this._manager.volume}}}),Object.defineProperty(t.SoundInstance3d.prototype,"velocity",{get:function(){return this._velocity},set:function(t){this._velocity.copy(t)}}),Object.defineProperty(t.SoundInstance3d.prototype,"maxDistance",{get:function(){return this._maxDistance},set:function(t){this._maxDistance=t}}),Object.defineProperty(t.SoundInstance3d.prototype,"refDistance",{get:function(){return this._refDistance},set:function(t){this._refDistance=t}}),Object.defineProperty(t.SoundInstance3d.prototype,"rollOffFactor",{get:function(){return this._rollOffFactor},set:function(t){this._rollOffFactor=t}}),Object.defineProperty(t.SoundInstance3d.prototype,"distanceModel",{get:function(){return this._distanceModel},set:function(t){this._distanceModel=t}})}else t.SoundInstance3d=function(){};var Vu={volume:0,pitch:0,loop:!1,startTime:0,duration:0,position:new v,maxDistance:0,refDistance:0,rollOffFactor:0,distanceModel:0,onPlay:null,onPause:null,onResume:null,onStop:null,onEnd:null};Hn.prototype=Object.create(n.prototype),Hn.prototype.constructor=Hn,Object.assign(Hn.prototype,{play:function(){if(this.overlap||this.stop(),this.isLoaded||this._hasAsset()){var t=this._createInstance();if(this.instances.push(t),this.isLoaded)t.play();else{var e=function(e){var i=t._playWhenLoaded;t.sound=e,i&&t.play()};this.off("load",e),this.once("load",e),this.load()}return t}},pause:function(){for(var t=!1,e=this.instances,i=0,s=e.length;i<s;i++)e[i].pause()&&(t=!0);return t},resume:function(){for(var t=!1,e=this.instances,i=0,s=e.length;i<s;i++)e[i].resume()&&(t=!0);return t},stop:function(){for(var t=!1,e=this.instances,i=e.length;i--;)e[i].stop(),t=!0;return e.length=0,t},load:function(){if(this._hasAsset()){var t=this._assets.get(this._asset);t?(t.off("remove",this._onAssetRemoved,this),t.on("remove",this._onAssetRemoved,this),t.resource?this.fire("load",t.resource):(t.off("load",this._onAssetLoad,this),t.once("load",this._onAssetLoad,this),this._assets.load(t))):(this._assets.off("add:"+this._asset,this._onAssetAdd,this),this._assets.once("add:"+this._asset,this._onAssetAdd,this))}},setExternalNodes:function(t,e){if(t){if(e||(e=t),this._firstNode=t,this._lastNode=e,!this._overlap)for(var i=this.instances,s=0,n=i.length;s<n;s++)i[s].setExternalNodes(t,e)}else console.error("The firstNode must have a valid AudioNode")},clearExternalNodes:function(){if(this._lastNode=this._firstNode=null,!this._overlap)for(var t=this.instances,e=0,i=t.length;e<i;e++)t[e].clearExternalNodes()},getExternalNodes:function(){return[this._firstNode,this._lastNode]},_hasAsset:function(){return null!=this._asset},_createInstance:function(){var e=this._component,i=null;if(this._hasAsset()){var s=this._assets.get(this._asset);s&&(i=s.resource)}return Vu.volume=this._volume*e.volume,Vu.pitch=this._pitch*e.pitch,Vu.loop=this._loop,Vu.startTime=this._startTime,Vu.duration=this._duration,Vu.onPlay=this._onInstancePlayHandler,Vu.onPause=this._onInstancePauseHandler,Vu.onResume=this._onInstanceResumeHandler,Vu.onStop=this._onInstanceStopHandler,Vu.onEnd=this._onInstanceEndHandler,e.positional?(Vu.position.copy(e.entity.getPosition()),Vu.maxDistance=e.maxDistance,Vu.refDistance=e.refDistance,Vu.rollOffFactor=e.rollOffFactor,Vu.distanceModel=e.distanceModel,e=new t.SoundInstance3d(this._manager,i,Vu)):e=new t.SoundInstance(this._manager,i,Vu),this._firstNode&&e.setExternalNodes(this._firstNode,this._lastNode),e},_onInstancePlay:function(t){this.fire("play",t),this._component.fire("play",this,t)},_onInstancePause:function(t){this.fire("pause",t),this._component.fire("pause",this,t)},_onInstanceResume:function(t){this.fire("resume",t),this._component.fire("resume",this,t)},_onInstanceStop:function(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("stop",t),this._component.fire("stop",this,t)},_onInstanceEnd:function(t){var e=this.instances.indexOf(t);-1!==e&&this.instances.splice(e,1),this.fire("end",t),this._component.fire("end",this,t)},_onAssetAdd:function(t){this.load()},_onAssetLoad:function(t){this.load()},_onAssetRemoved:function(t){t.off("remove",this._onAssetRemoved,this),this._assets.off("add:"+t.id,this._onAssetAdd,this),this.stop()},updatePosition:function(t){for(var e=this.instances,i=0,s=e.length;i<s;i++)e[i].position=t}}),Object.defineProperty(Hn.prototype,"volume",{get:function(){return this._volume},set:function(t){if(this._volume=oa.clamp(Number(t)||0,0,1),!this._overlap)for(var e=0,i=(t=this.instances).length;e<i;e++)t[e].volume=this._volume*this._component.volume}}),Object.defineProperty(Hn.prototype,"pitch",{get:function(){return this._pitch},set:function(t){if(this._pitch=Math.max(Number(t)||0,.01),!this._overlap)for(var e=0,i=(t=this.instances).length;e<i;e++)t[e].pitch=this.pitch*this._component.pitch}}),Object.defineProperty(Hn.prototype,"loop",{get:function(){return this._loop},set:function(t){this._loop=!!t;for(var e=0,i=(t=this.instances).length;e<i;e++)t[e].loop=this._loop}}),Object.defineProperty(Hn.prototype,"autoPlay",{get:function(){return this._autoPlay},set:function(t){this._autoPlay=!!t}}),Object.defineProperty(Hn.prototype,"overlap",{get:function(){return this._overlap},set:function(t){this._overlap=!!t}}),Object.defineProperty(Hn.prototype,"startTime",{get:function(){return this._startTime},set:function(t){if(this._startTime=Math.max(0,Number(t)||0),!this._overlap)for(var e=0,i=(t=this.instances).length;e<i;e++)t[e].startTime=this._startTime}}),Object.defineProperty(Hn.prototype,"duration",{get:function(){var t=0;return this._hasAsset()&&(t=(t=this._assets.get(this._asset)).resource?t.resource.duration:0),null!=this._duration?this._duration%(t||1):t},set:function(t){if(this._duration=Math.max(0,Number(t)||0)||null,!this._overlap)for(var e=0,i=(t=this.instances).length;e<i;e++)t[e].duration=this._duration}}),Object.defineProperty(Hn.prototype,"asset",{get:function(){return this._asset},set:function(t){var e=this._asset;e&&(this._assets.off("add:"+e,this._onAssetAdd,this),(e=this._assets.get(e))&&e.off("remove",this._onAssetRemoved,this)),this._asset=t,this._asset instanceof Fe&&(this._asset=this._asset.id),this._hasAsset()&&this._component.enabled&&this._component.entity.enabled&&this.load()}}),Object.defineProperty(Hn.prototype,"isLoaded",{get:function(){if(this._hasAsset()){var t=this._assets.get(this._asset);if(t)return!!t.resource}return!1}}),Object.defineProperty(Hn.prototype,"isPlaying",{get:function(){for(var t=this.instances,e=0,i=t.length;e<i;e++)if(t[e].isPlaying)return!0;return!1}}),Object.defineProperty(Hn.prototype,"isPaused",{get:function(){var t=this.instances,e=t.length;if(0===e)return!1;for(var i=0;i<e;i++)if(!t[i].isPaused)return!1;return!0}}),Object.defineProperty(Hn.prototype,"isStopped",{get:function(){for(var t=this.instances,e=0,i=t.length;e<i;e++)if(!t[e].isStopped)return!1;return!0}}),Wn.prototype=Object.create(as.prototype),Wn.prototype.constructor=Wn,qn("pitch","_pitch"),qn("volume","_volume"),Xn("refDistance","_refDistance"),Xn("maxDistance","_maxDistance"),Xn("rollOffFactor","_rollOffFactor"),Xn("distanceModel","_distanceModel"),Object.defineProperty(Wn.prototype,"positional",{get:function(){return this._positional},set:function(t){for(var e in this._positional=t,t=this._slots){var i=t[e];if(!i.overlap)for(var s=i.instances,n=0,r=s.length;n<r;n++){var a=s[n].isPlaying||s[n].isSuspended,o=s[n].currentTime;a&&s[n].stop(),s[n]=i._createInstance(),a&&(s[n].play(),s[n].currentTime=o)}}}}),Object.defineProperty(Wn.prototype,"slots",{get:function(){return this._slots},set:function(t){var e,i=this._slots;if(i)for(e in i)i[e].stop();for(e in i={},t)t[e]instanceof Hn?i[t[e].name]=t[e]:t[e].name&&(i[t[e].name]=new Hn(this,t[e].name,t[e]));this._slots=i,this.enabled&&this.entity.enabled&&this.onEnable()}}),Object.assign(Wn.prototype,{onEnable:function(){if(!this.system._inTools){var t,e=this._slots,i=this._playingBeforeDisable;for(t in e){var s=e[t];s.autoPlay&&s.isStopped?s.play():i[t]?s.resume():s.isLoaded||s.load()}}},onDisable:function(){var t,e=this._slots,i={};for(t in e)!e[t].overlap&&e[t].isPlaying&&(e[t].pause(),i[t]=!0);this._playingBeforeDisable=i},onRemove:function(){this.off()},addSlot:function(t,e){var i=this._slots;return i[t]?null:(e=new Hn(this,t,e),i[t]=e,e.autoPlay&&this.enabled&&this.entity.enabled&&e.play(),e)},removeSlot:function(t){var e=this._slots;e[t]&&(e[t].stop(),delete e[t])},slot:function(t){return this._slots[t]},play:function(t){return this.enabled&&this.entity.enabled&&(t=this._slots[t])?t.play():null},pause:function(t){var e=this._slots;if(t)(t=e[t])&&t.pause();else for(var i in e)e[i].pause()},resume:function(t){var e=this._slots;if(t)(t=e[t])&&t.isPaused&&t.resume();else for(var i in e)e[i].resume()},stop:function(t){var e=this._slots;if(t)(t=e[t])&&t.stop();else for(var i in e)e[i].stop()}});var ju=["enabled"],Gu=function(t,e){os.call(this,t),this.id="sound",this.ComponentType=Wn,this.DataType=Yn,this.schema=ju,this.manager=e,os.bind("update",this.onUpdate,this),this.on("beforeremove",this.onBeforeRemove,this)};Gu.prototype=Object.create(os.prototype),Gu.prototype.constructor=Gu,as._buildAccessors(Wn.prototype,ju),Object.assign(Gu.prototype,{initializeComponentData:function(t,e,i){i="volume pitch positional refDistance maxDistance rollOffFactor distanceModel slots".split(" ");for(var s=0;s<i.length;s++)e.hasOwnProperty(i[s])&&(t[i[s]]=e[i[s]]);os.prototype.initializeComponentData.call(this,t,e,["enabled"])},cloneComponent:function(t,e){var i,s=(t=t.sound).slots,n={};for(i in s){var r=s[i];n[i]={name:r.name,volume:r.volume,pitch:r.pitch,loop:r.loop,duration:r.duration,startTime:r.startTime,overlap:r.overlap,autoPlay:r.autoPlay,asset:r.asset}}return this.addComponent(e,{distanceModel:t.distanceModel,enabled:t.enabled,maxDistance:t.maxDistance,pitch:t.pitch,positional:t.positional,refDistance:t.refDistance,rollOffFactor:t.rollOffFactor,slots:n,volume:t.volume})},onUpdate:function(t){for(var e in t=this.store)if(t.hasOwnProperty(e)){var i=t[e].entity;if(i.enabled){var s=i.sound;if(s.enabled&&s.positional)for(var n in i=i.getPosition(),s=s.slots)s[n].updatePosition(i)}}},onBeforeRemove:function(t,e){for(var i in t=e.slots)t[i].overlap||t[i].stop();e.onRemove()}}),Object.defineProperty(Gu.prototype,"volume",{get:function(){return this.manager.volume},set:function(t){this.manager.volume=t}}),Object.defineProperty(Gu.prototype,"context",{get:function(){return ue()?this.manager.context:null}}),Kn.prototype=Object.create(n.prototype),Kn.prototype.constructor=Kn,Object.assign(Kn.prototype,{_onSpriteAssetAdded:function(t){this._component.system.app.assets.off("add:"+t.id,this._onSpriteAssetAdded,this),this._spriteAsset===t.id&&this._bindSpriteAsset(t)},_bindSpriteAsset:function(t){t.on("load",this._onSpriteAssetLoad,this),t.on("remove",this._onSpriteAssetRemove,this),t.resource?this._onSpriteAssetLoad(t):this._component.system.app.assets.load(t)},_unbindSpriteAsset:function(t){t.off("load",this._onSpriteAssetLoad,this),t.off("remove",this._onSpriteAssetRemove,this),t.resource&&t.resource.atlas&&this._component.system.app.assets.off("load:"+t.data.textureAtlasAsset,this._onTextureAtlasLoad,this)},_onSpriteAssetLoad:function(t){if(t.resource)if(t.resource.atlas)this.sprite=t.resource;else{t=t.data.textureAtlasAsset;var e=this._component.system.app.assets;e.off("load:"+t,this._onTextureAtlasLoad,this),e.once("load:"+t,this._onTextureAtlasLoad,this)}else this.sprite=null},_onTextureAtlasLoad:function(t){(t=this._spriteAsset)instanceof Fe?this._onSpriteAssetLoad(t):this._onSpriteAssetLoad(this._component.system.app.assets.get(t))},_onSpriteAssetRemove:function(t){this.sprite=null},_onSpriteMeshesChange:function(){this._component.currentClip===this&&this._component._showFrame(this.frame)},_onSpritePpuChanged:function(){this._component.currentClip===this&&0!==this.sprite.renderMode&&this._component._showFrame(this.frame)},_update:function(t){if(0!==this.fps&&this._playing&&!this._paused&&this._sprite){var e=this._time+t*this._component.speed*(0>this.fps?-1:1),i=this.duration;t=e>i||0>e,this._setTime(e),(e=this._sprite?Math.floor(this._sprite.frameKeys.length*this._time/i):0)!==this._frame&&this._setFrame(e),t&&(this.loop?(this.fire("loop"),this._component.fire("loop",this)):(this._paused=this._playing=!1,this.fire("end"),this._component.fire("end",this)))}},_setTime:function(t){this._time=t,t=this.duration,0>this._time?this._time=this.loop?this._time%t+t:0:this._time>t&&(this._time=this.loop?this._time%t:t)},_setFrame:function(t){this._frame=this._sprite?oa.clamp(t,0,this._sprite.frameKeys.length-1):t,this._component.currentClip===this&&this._component._showFrame(this._frame)},_destroy:function(){this._sprite&&(this.sprite=null),this._spriteAsset&&(this.spriteAsset=null)},play:function(){this._playing||(this._playing=!0,this._paused=!1,this.frame=0,this.fire("play"),this._component.fire("play",this))},pause:function(){this._playing&&!this._paused&&(this._paused=!0,this.fire("pause"),this._component.fire("pause",this))},resume:function(){this._paused&&(this._paused=!1,this.fire("resume"),this._component.fire("resume",this))},stop:function(){this._playing&&(this._paused=this._playing=!1,this.frame=this._time=0,this.fire("stop"),this._component.fire("stop",this))}}),Object.defineProperty(Kn.prototype,"spriteAsset",{get:function(){return this._spriteAsset},set:function(t){var e=this._component.system.app.assets,i=t;t instanceof Fe&&(i=t.id),this._spriteAsset!==i&&(this._spriteAsset&&(t=e.get(this._spriteAsset))&&this._unbindSpriteAsset(t),(this._spriteAsset=i)?(i=e.get(this._spriteAsset))?this._bindSpriteAsset(i):(this.sprite=null,e.on("add:"+this._spriteAsset,this._onSpriteAssetAdded,this)):this.sprite=null)}}),Object.defineProperty(Kn.prototype,"sprite",{get:function(){return this._sprite},set:function(t){var e;(this._sprite&&(this._sprite.off("set:meshes",this._onSpriteMeshesChange,this),this._sprite.off("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.off("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.off("set:texture",this._onSpriteMeshesChange,this)),(this._sprite=t)&&(this._sprite.on("set:meshes",this._onSpriteMeshesChange,this),this._sprite.on("set:pixelsPerUnit",this._onSpritePpuChanged,this),this._sprite.on("set:atlas",this._onSpriteMeshesChange,this),this._sprite.atlas&&this._sprite.atlas.on("set:texture",this._onSpriteMeshesChange,this)),this._component.currentClip===this)&&(t&&t.atlas?(t.atlas.texture&&((e=this._component._meshInstance)&&(e.setParameter("texture_emissiveMap",t.atlas.texture),e.setParameter("texture_opacityMap",t.atlas.texture)),this._component.enabled&&this._component.entity.enabled&&this._component._showModel()),this.time&&this.fps?this.time=this.time:this.frame=this.frame):((e=this._component._meshInstance)&&(e.deleteParameter("texture_emissiveMap"),e.deleteParameter("texture_opacityMap")),this._component._hideModel()))}}),Object.defineProperty(Kn.prototype,"frame",{get:function(){return this._frame},set:function(t){this._setFrame(t),this._setTime(this._frame/(this.fps||Number.MIN_VALUE))}}),Object.defineProperty(Kn.prototype,"isPlaying",{get:function(){return this._playing}}),Object.defineProperty(Kn.prototype,"isPaused",{get:function(){return this._paused}}),Object.defineProperty(Kn.prototype,"duration",{get:function(){return this._sprite?this._sprite.frameKeys.length/Math.abs(this.fps||Number.MIN_VALUE):0}}),Object.defineProperty(Kn.prototype,"time",{get:function(){return this._time},set:function(t){this._setTime(t),this.frame=this._sprite?Math.min(this._sprite.frameKeys.length-1,Math.floor(this._time*Math.abs(this.fps))):0}});var Hu=function(t,e){as.call(this,t,e),this._type="simple",this._material=t.defaultMaterial,this._color=new o(1,1,1,1),this._colorUniform=new Float32Array(3),this._speed=1,this._flipY=this._flipX=!1,this._height=this._width=1,this._drawOrder=0,this._layers=[0],this._outerScale=new y(1,1),this._outerScaleUniform=new Float32Array(2),this._innerOffset=new b,this._innerOffsetUniform=new Float32Array(4),this._atlasRect=new b,this._atlasRectUniform=new Float32Array(4),this._batchGroupId=-1,this._batchGroup=null,this._node=new Mt,this._model=new mt,this._model.graph=this._node,this._meshInstance=null,e.addChild(this._model.graph),this._model._entity=e,this._updateAabbFunc=this._updateAabb.bind(this),this._addedModel=!1,this._autoPlayClip=null,this._clips={},this._currentClip=this._defaultClip=new Kn(this,{name:this.entity.name,fps:0,loop:!1,spriteAsset:null})};Hu.prototype=Object.create(as.prototype),Hu.prototype.constructor=Hu,Object.assign(Hu.prototype,{onEnable:function(){var t=this.system.app,e=t.scene;e.on("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.on("add",this._onLayerAdded,this),e.layers.on("remove",this._onLayerRemoved,this)),this._showModel(),this._autoPlayClip&&this._tryAutoPlay(),0<=this._batchGroupId&&t.batcher.insert(gt.SPRITE,this._batchGroupId,this.entity)},onDisable:function(){var t=this.system.app,e=t.scene;e.off("set:layers",this._onLayersChanged,this),e.layers&&(e.layers.off("add",this._onLayerAdded,this),e.layers.off("remove",this._onLayerRemoved,this)),this.stop(),this._hideModel(),0<=this._batchGroupId&&t.batcher.remove(gt.SPRITE,this._batchGroupId,this.entity)},onDestroy:function(){for(var t in this._currentClip=null,this._defaultClip&&(this._defaultClip._destroy(),this._defaultClip=null),this._clips)this._clips[t]._destroy();this._clips=null,this._hideModel(),this._model=null,this._node&&(this._node.parent&&this._node.parent.removeChild(this._node),this._node=null),this._meshInstance&&(this._meshInstance.material=null,this._meshInstance=this._meshInstance.mesh=null)},_showModel:function(){if(!this._addedModel&&this._meshInstance){var t,e=[this._meshInstance],i=0;for(t=this._layers.length;i<t;i++){var s=this.system.app.scene.layers.getLayerById(this._layers[i]);s&&s.addMeshInstances(e)}this._addedModel=!0}},_hideModel:function(){if(this._addedModel&&this._meshInstance){var t,e=[this._meshInstance],i=0;for(t=this._layers.length;i<t;i++){var s=this.system.app.scene.layers.getLayerById(this._layers[i]);s&&s.removeMeshInstances(e)}this._addedModel=!1}},_showFrame:function(t){if(this.sprite){var e=this.sprite.meshes[t];if(e){var i=1===this.sprite.renderMode?this.system.default9SlicedMaterialSlicedMode:2===this.sprite.renderMode?this.system.default9SlicedMaterialTiledMode:this.system.defaultMaterial;this._meshInstance||(this._meshInstance=new lt(this._node,e,this._material),this._meshInstance.castShadow=!1,this._meshInstance.receiveShadow=!1,this._meshInstance.drawOrder=this._drawOrder,this._model.meshInstances.push(this._meshInstance),this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform),this._meshInstance.setParameter("material_opacity",this._color.a),this.enabled&&this.entity.enabled&&this._showModel()),this._meshInstance.material!==i&&(this._meshInstance.material=i),this._meshInstance.mesh!==e&&(this._meshInstance.mesh=e,this._meshInstance.visible=!0,this._meshInstance._aabbVer=-1),this.sprite.atlas&&this.sprite.atlas.texture?(this._meshInstance.setParameter("texture_emissiveMap",this.sprite.atlas.texture),this._meshInstance.setParameter("texture_opacityMap",this.sprite.atlas.texture)):(this._meshInstance.deleteParameter("texture_emissiveMap"),this._meshInstance.deleteParameter("texture_opacityMap")),!this.sprite.atlas||1!==this.sprite.renderMode&&2!==this.sprite.renderMode?this._meshInstance._updateAabbFunc=null:(this._meshInstance._updateAabbFunc=this._updateAabbFunc,(t=this.sprite.atlas.frames[this.sprite.frameKeys[t]])?(e=2/t.rect.z,i=2/t.rect.w,this._innerOffset.set(t.border.x*e,t.border.y*i,t.border.z*e,t.border.w*i),e=this.sprite.atlas.texture,this._atlasRect.set(t.rect.x/e.width,t.rect.y/e.height,t.rect.z/e.width,t.rect.w/e.height)):this._innerOffset.set(0,0,0,0),this._innerOffsetUniform[0]=this._innerOffset.x,this._innerOffsetUniform[1]=this._innerOffset.y,this._innerOffsetUniform[2]=this._innerOffset.z,this._innerOffsetUniform[3]=this._innerOffset.w,this._meshInstance.setParameter("innerOffset",this._innerOffsetUniform),this._atlasRectUniform[0]=this._atlasRect.x,this._atlasRectUniform[1]=this._atlasRect.y,this._atlasRectUniform[2]=this._atlasRect.z,this._atlasRectUniform[3]=this._atlasRect.w,this._meshInstance.setParameter("atlasRect",this._atlasRectUniform)),this._updateTransform()}else this._meshInstance&&(this._meshInstance.mesh=null,this._meshInstance.visible=!1)}},_updateTransform:function(){var t=this.flipX?-1:1,e=this.flipY?-1:1,i=0,s=0;if(this.sprite&&(1===this.sprite.renderMode||2===this.sprite.renderMode)){var n=1,r=1;if(this.sprite.atlas){var a=this.sprite.atlas.frames[this.sprite.frameKeys[this.frame]];a&&(n=a.rect.z,r=a.rect.w,i=(.5-a.pivot.x)*this._width,s=(.5-a.pivot.y)*this._height)}n/=this.sprite.pixelsPerUnit,r/=this.sprite.pixelsPerUnit,this._outerScale.set(Math.max(this._width,this._innerOffset.x*n),Math.max(this._height,this._innerOffset.y*r)),e*=r,this._outerScale.x/=n,this._outerScale.y/=r,t=t*n*oa.clamp(this._width/(this._innerOffset.x*n),1e-4,1),e*=oa.clamp(this._height/(this._innerOffset.y*r),1e-4,1),this._meshInstance&&(this._outerScaleUniform[0]=this._outerScale.x,this._outerScaleUniform[1]=this._outerScale.y,this._meshInstance.setParameter("outerScale",this._outerScaleUniform))}this._node.setLocalScale(t,e,1),this._node.setLocalPosition(i,s,0)},_updateAabb:function(t){return t.center.set(0,0,0),t.halfExtents.set(.5*this._outerScale.x,.5*this._outerScale.y,.001),t.setFromTransformedAabb(t,this._node.getWorldTransform()),t},_tryAutoPlay:function(){if(this._autoPlayClip&&"animated"===this.type){var t=this._clips[this._autoPlayClip];!t||t.isPlaying||this._currentClip&&this._currentClip.isPlaying||this.enabled&&this.entity.enabled&&this.play(t.name)}},_onLayersChanged:function(t,e){t.off("add",this.onLayerAdded,this),t.off("remove",this.onLayerRemoved,this),e.on("add",this.onLayerAdded,this),e.on("remove",this.onLayerRemoved,this),this.enabled&&this.entity.enabled&&this._showModel()},_onLayerAdded:function(t){0>this.layers.indexOf(t.id)||this._addedModel&&this.enabled&&this.entity.enabled&&this._meshInstance&&t.addMeshInstances([this._meshInstance])},_onLayerRemoved:function(t){this._meshInstance&&(0>this.layers.indexOf(t.id)||t.removeMeshInstances([this._meshInstance]))},removeModelFromLayers:function(){for(var t,e=0;e<this.layers.length;e++)(t=this.system.app.scene.layers.getLayerById(this.layers[e]))&&t.removeMeshInstances([this._meshInstance])},addClip:function(t){var e=new Kn(this,{name:t.name,fps:t.fps,loop:t.loop,spriteAsset:t.spriteAsset});return this._clips[t.name]=e,e.name&&e.name===this._autoPlayClip&&this._tryAutoPlay(),e},removeClip:function(t){delete this._clips[t]},clip:function(t){return this._clips[t]},play:function(t){t=this._clips[t];var e=this._currentClip;return e&&e!==t&&(e._playing=!1),(this._currentClip=t)&&(this._currentClip=t,this._currentClip.play()),t},pause:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPlaying&&this._currentClip.pause()},resume:function(){this._currentClip!==this._defaultClip&&this._currentClip.isPaused&&this._currentClip.resume()},stop:function(){this._currentClip!==this._defaultClip&&this._currentClip.stop()}}),Object.defineProperty(Hu.prototype,"type",{get:function(){return this._type},set:function(t){this._type!==t&&(this._type=t,"simple"===this._type?(this.stop(),this._currentClip=this._defaultClip,this.enabled&&this.entity.enabled&&(this._currentClip.frame=this.frame,this._currentClip.sprite?this._showModel():this._hideModel())):"animated"===this._type&&(this.stop(),this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.isPlaying&&this.enabled&&this.entity.enabled?this._showModel():this._hideModel()))}}),Object.defineProperty(Hu.prototype,"frame",{get:function(){return this._currentClip.frame},set:function(t){this._currentClip.frame=t}}),Object.defineProperty(Hu.prototype,"spriteAsset",{get:function(){return this._defaultClip._spriteAsset},set:function(t){this._defaultClip.spriteAsset=t}}),Object.defineProperty(Hu.prototype,"sprite",{get:function(){return this._currentClip.sprite},set:function(t){this._currentClip.sprite=t}}),Object.defineProperty(Hu.prototype,"material",{get:function(){return this._material},set:function(t){this._material=t,this._meshInstance&&(this._meshInstance.material=t)}}),Object.defineProperty(Hu.prototype,"color",{get:function(){return this._color},set:function(t){this._color.r=t.r,this._color.g=t.g,this._color.b=t.b,this._meshInstance&&(this._colorUniform[0]=this._color.r,this._colorUniform[1]=this._color.g,this._colorUniform[2]=this._color.b,this._meshInstance.setParameter("material_emissive",this._colorUniform))}}),Object.defineProperty(Hu.prototype,"opacity",{get:function(){return this._color.a},set:function(t){this._color.a=t,this._meshInstance&&this._meshInstance.setParameter("material_opacity",t)}}),Object.defineProperty(Hu.prototype,"clips",{get:function(){return this._clips},set:function(t){var e,i;if(t){for(e in this._clips){var s=!1;for(i in t)if(t[i].name===e){s=!0,this._clips[e].fps=t[i].fps,this._clips[e].loop=t[i].loop,t[i].hasOwnProperty("sprite")?this._clips[e].sprite=t[i].sprite:t[i].hasOwnProperty("spriteAsset")&&(this._clips[e].spriteAsset=t[i].spriteAsset);break}s||this.removeClip(e)}for(i in t)this._clips[t[i].name]||this.addClip(t[i]);this._autoPlayClip&&this._tryAutoPlay(),this._currentClip&&this._currentClip.sprite||this._hideModel()}else for(e in this._clips)this.removeClip(e)}}),Object.defineProperty(Hu.prototype,"currentClip",{get:function(){return this._currentClip}}),Object.defineProperty(Hu.prototype,"speed",{get:function(){return this._speed},set:function(t){this._speed=t}}),Object.defineProperty(Hu.prototype,"flipX",{get:function(){return this._flipX},set:function(t){this._flipX!==t&&(this._flipX=t,this._updateTransform())}}),Object.defineProperty(Hu.prototype,"flipY",{get:function(){return this._flipY},set:function(t){this._flipY!==t&&(this._flipY=t,this._updateTransform())}}),Object.defineProperty(Hu.prototype,"width",{get:function(){return this._width},set:function(t){t!==this._width&&(this._width=t,this._outerScale.x=this._width,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}}),Object.defineProperty(Hu.prototype,"height",{get:function(){return this._height},set:function(t){t!==this._height&&(this._height=t,this._outerScale.y=this.height,!this.sprite||2!==this.sprite.renderMode&&1!==this.sprite.renderMode||this._updateTransform())}}),Object.defineProperty(Hu.prototype,"batchGroupId",{get:function(){return this._batchGroupId},set:function(t){if(this._batchGroupId!==t){var e=this._batchGroupId;this._batchGroupId=t,this.entity.enabled&&0<=e&&this.system.app.batcher.remove(gt.SPRITE,e,this.entity),this.entity.enabled&&0<=t?this.system.app.batcher.insert(gt.SPRITE,t,this.entity):0<=e&&this._currentClip&&this._currentClip.sprite&&this.enabled&&this.entity.enabled&&this._showModel()}}}),Object.defineProperty(Hu.prototype,"autoPlayClip",{get:function(){return this._autoPlayClip},set:function(t){this._autoPlayClip=t instanceof Kn?t.name:t,this._tryAutoPlay()}}),Object.defineProperty(Hu.prototype,"drawOrder",{get:function(){return this._drawOrder},set:function(t){this._drawOrder=t,this._meshInstance&&(this._meshInstance.drawOrder=t)}}),Object.defineProperty(Hu.prototype,"layers",{get:function(){return this._layers},set:function(t){this._addedModel&&this._hideModel(),this._layers=t,this._meshInstance&&this.enabled&&this.entity.enabled&&this._showModel()}}),Object.defineProperty(Hu.prototype,"aabb",{get:function(){return this._meshInstance?this._meshInstance.aabb:null}});var Wu=["enabled"];Zn.prototype=Object.create(os.prototype),Zn.prototype.constructor=Zn,as._buildAccessors(Hu.prototype,Wu),Object.defineProperties(Zn.prototype,{defaultMaterial:{get:function(){if(!this._defaultMaterial){var t=new nt(this.app.graphicsDevice,{width:1,height:1,format:7}),e=new Uint8Array(t.lock());e[0]=e[1]=e[2]=e[3]=255,t.name="sprite",t.unlock(),(e=new ar).diffuse.set(0,0,0),e.emissive.set(.5,.5,.5),e.emissiveMap=t,e.emissiveMapTint=!0,e.opacityMap=t,e.opacityMapChannel="a",e.opacityTint=!0,e.opacity=0,e.useLighting=!1,e.useGammaTonemap=!1,e.useFog=!1,e.useSkybox=!1,e.blendType=4,e.depthWrite=!1,e.pixelSnap=!1,e.cull=0,e.update(),this._defaultTexture=t,this._defaultMaterial=e}return this._defaultMaterial},set:function(t){this._defaultMaterial=t}},default9SlicedMaterialSlicedMode:{get:function(){if(!this._default9SlicedMaterialSlicedMode){var t=this.defaultMaterial.clone();t.nineSlicedMode=1,t.update(),this._default9SlicedMaterialSlicedMode=t}return this._default9SlicedMaterialSlicedMode},set:function(t){this._default9SlicedMaterialSlicedMode=t}},default9SlicedMaterialTiledMode:{get:function(){if(!this._default9SlicedMaterialTiledMode){var t=this.defaultMaterial.clone();t.nineSlicedMode=2,t.update(),this._default9SlicedMaterialTiledMode=t}return this._default9SlicedMaterialTiledMode},set:function(t){this._default9SlicedMaterialTiledMode=t}}}),Object.assign(Zn.prototype,{destroy:function(){this._defaultTexture&&(this._defaultTexture.destroy(),this._defaultTexture=null)},initializeComponentData:function(t,e,i){if(void 0!==e.enabled&&(t.enabled=e.enabled),t.type=e.type,e.layers&&Array.isArray(e.layers)&&(t.layers=e.layers.slice(0)),void 0!==e.drawOrder&&(t.drawOrder=e.drawOrder),void 0!==e.color&&(e.color instanceof o?t.color.set(e.color.r,e.color.g,e.color.b,void 0!==e.opacity?e.opacity:1):t.color.set(e.color[0],e.color[1],e.color[2],void 0!==e.opacity?e.opacity:1),t.color=t.color),void 0!==e.opacity&&(t.opacity=e.opacity),void 0!==e.flipX&&(t.flipX=e.flipX),void 0!==e.flipY&&(t.flipY=e.flipY),void 0!==e.width&&(t.width=e.width),void 0!==e.height&&(t.height=e.height),void 0!==e.spriteAsset&&(t.spriteAsset=e.spriteAsset),e.sprite&&(t.sprite=e.sprite),void 0!==e.frame&&(t.frame=e.frame),e.clips)for(var s in e.clips)t.addClip(e.clips[s]);void 0!==e.speed&&(t.speed=e.speed),e.autoPlayClip&&(t.autoPlayClip=e.autoPlayClip),t.batchGroupId=void 0===e.batchGroupId||null===e.batchGroupId?-1:e.batchGroupId,os.prototype.initializeComponentData.call(this,t,e,i)},cloneComponent:function(t,e){return t=t.sprite,this.addComponent(e,{enabled:t.enabled,type:t.type,spriteAsset:t.spriteAsset,sprite:t.sprite,frame:t.frame,color:t.color.clone(),opacity:t.opacity,flipX:t.flipX,flipY:t.flipY,speed:t.speed,clips:t.clips,autoPlayClip:t.autoPlayClip,batchGroupId:t.batchGroupId,drawOrder:t.drawOrder,layers:t.layers.slice(0)})},onUpdate:function(t){var e,i=this.store;for(e in i)if(i.hasOwnProperty(e)){var s=i[e];s.data.enabled&&s.entity.enabled&&((s=s.entity.sprite)._currentClip&&s._currentClip._update(t))}},onBeforeRemove:function(t,e){e.onDestroy()}}),Qn.prototype=Object.create(as.prototype),Qn.prototype.constructor=Qn,Object.assign(Qn.prototype,{onEnable:function(){this._checkState()},onDisable:function(){this._checkState()},_onSetEnabled:function(t,e,i){this._checkState()},_checkState:function(){var t=this.enabled&&this.entity.enabled;t!==this._oldState&&(this._oldState=t,this.fire("enable"),this.fire("state",this.enabled))},_onBeforeRemove:function(){this.fire("remove")}}),Object.defineProperty(Qn.prototype,"size",{set:function(t){t instanceof v?this._size.copy(t):t instanceof Array&&3<=t.length&&this.size.set(t[0],t[1],t[2])},get:function(){return this._size}});var Xu=["enabled"],qu=function(t){os.call(this,t),this.id="zone",this.ComponentType=Qn,this.DataType=Jn,this.schema=Xu,this.on("beforeremove",this._onBeforeRemove,this)};qu.prototype=Object.create(os.prototype),qu.prototype.constructor=qu,as._buildAccessors(Qn.prototype,Xu),Object.assign(qu.prototype,{initializeComponentData:function(t,e,i){t.enabled=!e.hasOwnProperty("enabled")||!!e.enabled,e.size&&(e.size instanceof v?t.size.copy(e.size):e.size instanceof Array&&3<=e.size.length&&t.size.set(e.size[0],e.size[1],e.size[2]))},cloneComponent:function(t,e){return this.addComponent(e,{size:t.zone.size})},_onBeforeRemove:function(t,e){e._onBeforeRemove()}}),ir.prototype.destroy=function(){this._app=null},ir.prototype.list=function(){return this._list},ir.prototype.add=function(t,e){return!this._index.hasOwnProperty(t)&&(t=new er(t,e),e=this._list.push(t),this._index[t.name]=e-1,this._urlIndex[t.url]=e-1,!0)},ir.prototype.find=function(t){return this._index.hasOwnProperty(t)?this._list[this._index[t]]:null},ir.prototype.findByUrl=function(t){return this._urlIndex.hasOwnProperty(t)?this._list[this._urlIndex[t]]:null},ir.prototype.remove=function(t){if(this._index.hasOwnProperty(t)){var e=this._index[t],i=this._list[e];for(delete this._urlIndex[i.url],delete this._index[t],this._list.splice(e,1),e=0;e<this._list.length;e++)i=this._list[e],this._index[i.name]=e,this._urlIndex[i.url]=e}},ir.prototype.loadSceneHierarchy=function(t,e){var i=this,s=this._app.loader.getHandler("hierarchy");this._app.assets&&this._app.assets.prefix&&!dl.test(t)&&(t=ia.join(this._app.assets.prefix,t)),s.load(t,function(n,r){n?e&&e(n):i._app._preloadScripts(r,function(){i._app.systems.script.preloading=!0;var a=s.open(t,r);i._app.systems.script.preloading=!1,i._app.loader.clearCache(t,"hierarchy"),i._app.root.addChild(a),os.initialize(a),os.postInitialize(a),e&&e(n,a)})})},ir.prototype.loadSceneSettings=function(t,e){var i=this;this._app.assets&&this._app.assets.prefix&&!dl.test(t)&&(t=ia.join(this._app.assets.prefix,t)),this._app.loader.load(t,"scenesettings",function(t,s){t?e&&e(t):(i._app.applySceneSettings(s),e&&e(null))})},ir.prototype.loadScene=function(t,e){var i=this,s=this._app.loader.getHandler("scene");this._app.assets&&this._app.assets.prefix&&!dl.test(t)&&(t=ia.join(this._app.assets.prefix,t)),s.load(t,function(n,r){n?e&&e(n):i._app._preloadScripts(r,function(){i._app.systems.script.preloading=!0;var n=s.open(t,r);i._app.systems.script.preloading=!1,i._app.loader.clearCache(t,"scene"),i._app.loader.patch({resource:n,type:"scene"},i._app.assets),i._app.root.addChild(n.root),i._app.systems.rigidbody&&"undefined"!=typeof Ammo&&i._app.systems.rigidbody.gravity.set(n._gravity.x,n._gravity.y,n._gravity.z),e&&e(null,n)})})};var Yu=!1,Ku=new Mt;t.app=null,sr.prototype=Object.create(n.prototype),sr.prototype.constructor=sr,sr._currentApplication=null,sr._applications={},sr.getApplication=function(t){return t?sr._applications[t]:sr._currentApplication};var $u=function(t){this.length=t,this.count=0,this.inc=function(){this.count++},this.done=function(){return this.count===this.length}};Object.defineProperty(sr.prototype,"fillMode",{get:function(){return this._fillMode}}),Object.defineProperty(sr.prototype,"resolutionMode",{get:function(){return this._resolutionMode}}),Object.assign(sr.prototype,{configure:function(t,e){var i=this;la.get(t,function(t,s){if(t)e(t);else{var n=s.scenes,r=s.assets;i._parseApplicationProperties(s.application_properties,function(t){i._parseScenes(n),i._parseAssets(r),e(t||null)})}})},preload:function(t){var e,i=this;i.fire("preload:start");var s=this.assets.list({preload:!0}),n=new $u(s.length),r=!1,a=function(){i.graphicsDevice&&!r&&n.done()&&(r=!0,i.fire("preload:end"),t())},o=s.length;if(n.length){var h=function(t){n.inc(),i.fire("preload:progress",n.count/o),n.done()&&a()},l=function(t,e){n.inc(),i.fire("preload:progress",n.count/o),n.done()&&a()};for(e=0;e<s.length;e++)s[e].loaded?(n.inc(),i.fire("preload:progress",n.count/o),n.done()&&a()):(s[e].once("load",h),s[e].once("error",l),this.assets.load(s[e]))}else a()},getSceneUrl:function(t){return(t=this.scenes.find(t))?t.url:null},loadSceneHierarchy:function(t,e){this.scenes.loadSceneHierarchy(t,e)},loadSceneSettings:function(t,e){this.scenes.loadSceneSettings(t,e)},loadScene:function(t,e){this.scenes.loadScene(t,e)},_preloadScripts:function(t,e){if(Ql.legacy){var i=this;i.systems.script.preloading=!0;var s=0,n=(t=this._getScriptReferences(t)).length,r=new $u(n),a=/^http(s)?:\/\//;if(n){var o=function(t,s){t&&console.error(t),r.inc(),r.done()&&(i.systems.script.preloading=!1,e())};for(s=0;s<n;s++){var h=t[s];!a.test(h.toLowerCase())&&i._scriptPrefix&&(h=ia.join(i._scriptPrefix,t[s])),this.loader.load(h,"script",o)}}else i.systems.script.preloading=!1,e()}else e()},_parseApplicationProperties:function(t,e){if(t.useDevicePixelRatio||(t.useDevicePixelRatio=t.use_device_pixel_ratio),t.resolutionMode||(t.resolutionMode=t.resolution_mode),t.fillMode||(t.fillMode=t.fill_mode),this._width=t.width,this._height=t.height,t.useDevicePixelRatio&&(this.graphicsDevice.maxPixelRatio=window.devicePixelRatio),this.setCanvasResolution(t.resolutionMode,this._width,this._height),this.setCanvasFillMode(t.fillMode,this._width,this._height),t.layers&&t.layerOrder){var i=new Ut,s={};for(r in t.layers){var n=t.layers[r];n.id=parseInt(r,10),n.enabled=1!==n.id,s[r]=new It(n)}var r=0;for(n=t.layerOrder.length;r<n;r++){var a=t.layerOrder[r],o=s[a.layer];o&&(a.transparent?i.pushTransparent(o):i.pushOpaque(o),i.subLayerEnabled[r]=a.enabled)}this.scene.layers=i}if(t.batchGroups)for(r=0,n=t.batchGroups.length;r<n;r++)i=t.batchGroups[r],this.batcher.addGroup(i.name,i.dynamic,i.maxAabbSize,i.id,i.layers);t.i18nAssets&&(this.i18n.assets=t.i18nAssets),this._loadLibraries(t.libraries,e)},_loadLibraries:function(t,e){var i=t.length,s=i,n=this,r=/^http(s)?:\/\//;if(i)for(var a=function(t,i){s--,t?e(t):0===s&&(n.onLibrariesLoaded(),e(null))},o=0;o<i;++o){var h=t[o];!r.test(h.toLowerCase())&&n._scriptPrefix&&(h=ia.join(n._scriptPrefix,h)),this.loader.load(h,"script",a)}else n.onLibrariesLoaded(),e(null)},_parseScenes:function(t){if(t)for(var e=0;e<t.length;e++)this.scenes.add(t[e].name,t[e].url)},_parseAssets:function(t){var e,i=[],s={},n={};if(Ql.legacy){if(this.enableBundles)for(r in t)"bundle"===t[r].type&&(n[r]=!0,i.push(t[r]));for(r in t)n[r]||i.push(t[r])}else{for(e=0;e<this.scriptsOrder.length;e++){var r=this.scriptsOrder[e];t[r]&&(s[r]=!0,i.push(t[r]))}if(this.enableBundles)for(r in t)"bundle"===t[r].type&&(n[r]=!0,i.push(t[r]));for(r in t)s[r]||n[r]||i.push(t[r])}for(e=0;e<i.length;e++){if((r=new Fe((t=i[e]).name,t.type,t.file,t.data)).id=parseInt(t.id,10),r.preload=!!t.preload&&t.preload,r.loaded="script"===t.type&&t.data&&0<t.data.loadingType,r.tags.add(t.tags),t.i18n)for(var a in t.i18n)r.addLocalizedAssetId(a,t.i18n[a]);this.assets.add(r)}},_getScriptReferences:function(t){var e,i,s=[];t.settings.priority_scripts&&(s=t.settings.priority_scripts);var n=[],r={};for(e=0;e<s.length;e++)n.push(s[e]),r[s[e]]=!0;for(i in t=t.entities)if(t[i].components.script)for(s=t[i].components.script.scripts,e=0;e<s.length;e++)r[s[e].url]||(n.push(s[e].url),r[s[e].url]=!0);return n},start:function(){this.frame=0,this.fire("start",{timestamp:ha(),target:this}),this._librariesLoaded||this.onLibrariesLoaded(),os.initialize(this.root),this.fire("initialize"),os.postInitialize(this.root),this.fire("postinitialize"),this.tick()},update:function(t){this.frame++,this.graphicsDevice.updateClientRect(),this.vr&&this.vr.poll(),Ql.legacy&&os.fixedUpdate(1/60,this._inTools),os.update(t,this._inTools),os.animationUpdate(t,this._inTools),os.postUpdate(t,this._inTools),this.fire("update",t),this.controller&&this.controller.update(t),this.mouse&&this.mouse.update(t),this.keyboard&&this.keyboard.update(t),this.gamepads&&this.gamepads.update(t)},render:function(){this.fire("prerender"),this.root.syncHierarchy(),this.batcher.updateAll(),this.renderer.renderComposition(this.scene.layers),this.fire("postrender")},_fillFrameStats:function(t,e,i){var s=this.stats.frame;for(s.dt=e,s.ms=i,t>s._timeToCountFrames?(s.fps=s._fpsAccum,s._fpsAccum=0,s._timeToCountFrames=t+1e3):s._fpsAccum++,s.cameras=this.renderer._camerasRendered,s.materials=this.renderer._materialSwitches,s.shaders=this.graphicsDevice._shaderSwitchesPerFrame,s.shadowMapUpdates=this.renderer._shadowMapUpdates,s.shadowMapTime=this.renderer._shadowMapTime,s.depthMapTime=this.renderer._depthMapTime,s.forwardTime=this.renderer._forwardTime,t=this.graphicsDevice._primsPerFrame,s.triangles=t[4]/3+Math.max(t[5]-2,0)+Math.max(t[6]-2,0),s.cullTime=this.renderer._cullTime,s.sortTime=this.renderer._sortTime,s.skinTime=this.renderer._skinTime,s.morphTime=this.renderer._morphTime,s.instancingTime=this.renderer._instancingTime,e=s.otherPrimitives=0;e<t.length;e++)4>e&&(s.otherPrimitives+=t[e]),t[e]=0;this.renderer._camerasRendered=0,this.renderer._materialSwitches=0,this.renderer._shadowMapUpdates=0,this.graphicsDevice._shaderSwitchesPerFrame=0,this.renderer._cullTime=0,this.renderer._sortTime=0,this.renderer._skinTime=0,this.renderer._morphTime=0,this.renderer._instancingTime=0,this.renderer._shadowMapTime=0,this.renderer._depthMapTime=0,this.renderer._forwardTime=0,(s=this.stats.drawCalls).forward=this.renderer._forwardDrawCalls,s.culled=this.renderer._numDrawCallsCulled,s.depth=0,s.shadow=this.renderer._shadowDrawCalls,s.skinned=this.renderer._skinDrawCalls,s.immediate=0,s.instanced=0,s.removedByInstancing=0,s.total=this.graphicsDevice._drawCallsPerFrame,s.misc=s.total-(s.forward+s.shadow),this.renderer._depthDrawCalls=0,this.renderer._shadowDrawCalls=0,this.renderer._forwardDrawCalls=0,this.renderer._numDrawCallsCulled=0,this.renderer._skinDrawCalls=0,this.renderer._immediateRendered=0,this.renderer._instancedDrawCalls=0,this.renderer._removedByInstancing=0,this.graphicsDevice._drawCallsPerFrame=0,this.stats.misc.renderTargetCreationTime=this.graphicsDevice.renderTargetCreationTime,(s=this.stats.particles).updatesPerFrame=s._updatesPerFrame,s.frameTime=s._frameTime,s._updatesPerFrame=0,s._frameTime=0},setCanvasFillMode:function(t,e,i){this._fillMode=t,this.resizeCanvas(e,i)},setCanvasResolution:function(t,e,i){this._resolutionMode=t,"AUTO"===t&&void 0===e&&(e=this.graphicsDevice.canvas.clientWidth,i=this.graphicsDevice.canvas.clientHeight),this.graphicsDevice.resizeCanvas(e,i)},isHidden:function(){return document[this._hiddenAttr]},onVisibilityChange:function(){this.isHidden()?this._soundManager.suspend():this._soundManager.resume()},resizeCanvas:function(t,e){if(this._allowResize&&(!this.xr||!this.xr.session)){var i=window.innerWidth,s=window.innerHeight;if(this._fillMode===gc){var n=this.graphicsDevice.canvas.width/this.graphicsDevice.canvas.height;n>i/s?e=(t=i)/n:t=(e=s)*n}else"FILL_WINDOW"===this._fillMode&&(t=i,e=s);return this.graphicsDevice.canvas.style.width=t+"px",this.graphicsDevice.canvas.style.height=e+"px","AUTO"===this._resolutionMode&&this.setCanvasResolution("AUTO"),{width:t,height:e}}},onLibrariesLoaded:function(){this._librariesLoaded=!0,this.systems.rigidbody.onLibraryLoaded()},applySceneSettings:function(t){if(this.systems.rigidbody&&"undefined"!=typeof Ammo){var e=t.physics.gravity;this.systems.rigidbody.gravity.set(e[0],e[1],e[2])}this.scene.applySettings(t),t.render.hasOwnProperty("skybox")&&(t.render.skybox?(e=this.assets.get(t.render.skybox))?this.setSkybox(e):this.assets.once("add:"+t.render.skybox,this.setSkybox,this):this.setSkybox(null))},setSkybox:function(t){t?this._skyboxLast===t.id?0!==this.scene.skyboxMip||t.loadFaces?this._onSkyboxChange(t):this._skyboxLoad(t):(this._skyboxLast&&(this.assets.off("add:"+this._skyboxLast,this.setSkybox,this),this.assets.off("load:"+this._skyboxLast,this._onSkyboxChange,this),this.assets.off("remove:"+this._skyboxLast,this._skyboxRemove,this)),this._skyboxLast=t.id,this.assets.on("load:"+t.id,this._onSkyboxChange,this),this.assets.once("remove:"+t.id,this._skyboxRemove,this),t.resource&&this.scene.setSkybox(t.resources),this._skyboxLoad(t)):this._skyboxLast&&this._skyboxRemove({id:this._skyboxLast})},enableVr:function(){this.vr||(this.vr=new $i(this))},disableVr:function(){this.vr&&(this.vr.destroy(),this.vr=null)},_onSkyboxChange:function(t){this.scene.setSkybox(t.resources)},_skyboxLoad:function(t){0===this.scene.skyboxMip&&(t.loadFaces=!0),this.assets.load(t),this._onSkyboxChange(t)},_skyboxRemove:function(t){this._skyboxLast&&(this.assets.off("add:"+t.id,this.setSkybox,this),this.assets.off("load:"+t.id,this._onSkyboxChange,this),this.assets.off("remove:"+t.id,this._skyboxRemove,this),this.scene.setSkybox(null),this._skyboxLast=null)},_firstBake:function(){this.lightmapper.bake(null,this.scene.lightmapMode)},_firstBatch:function(){this.scene._needsStaticPrepare&&(this.renderer.prepareStaticMeshes(this.graphicsDevice,this.scene),this.scene._needsStaticPrepare=!1),this.batcher.generate()},_processTimestamp:function(t){return t},_preRenderImmediate:function(){for(var t=0;t<this._immediateData.lineBatches.length;t++)this._immediateData.lineBatches[t]&&this._immediateData.lineBatches[t].finalize(this.meshInstanceArray)},_postRenderImmediate:function(){for(var t=0;t<this._immediateData.layers.length;t++)this._immediateData.layers[t].clearMeshInstances(!0);this._immediateData.layers.length=0},_initImmediate:function(){this._immediateData||(this._immediateData=new kt(this.graphicsDevice),this.on("prerender",this._preRenderImmediate,this),this.on("postrender",this._postRenderImmediate,this))},_addLines:function(t,e,i){var s=i&&i.layer?i.layer:this.scene.layers.getLayerById(3),n=!i||void 0===i.depthTest||i.depthTest;i=i&&i.mask?i.mask:void 0,this._initImmediate(),this._immediateData.addLayer(s);var r=this._immediateData.getLayerIdx(s);void 0===r?((r=new zt).init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,t.length/2),r.material.depthTest=n,i&&(r.meshInstance.mask=i),r=this._immediateData.lineBatches.push(r)-1,this._immediateData.addLayerIdx(r,s)):(this._immediateData.lineBatches[r].init(this.graphicsDevice,this._immediateData.lineVertexFormat,s,t.length/2),this._immediateData.lineBatches[r].material.depthTest=n,i&&(this._immediateData.lineBatches[r].meshInstance.mask=i)),this._immediateData.lineBatches[r].addLines(t,e)},renderLine:function(t,e,i,s,n){var r=i;if(s instanceof o)if(r=s,"number"==typeof n){Yu||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),Yu=!0);var a=1===n?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}}else a=n;else"number"==typeof s?(Yu||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),Yu=!0),r=i,a=1===s?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):s&&(a=s);this._addLines([t,e],[i,r],a)},renderLines:function(t,e,i){i?"number"==typeof i&&(Yu||(console.warn("lineBatch argument is deprecated for renderLine. Use options.layer instead"),Yu=!0),i=1===i?{layer:this.scene.layers.getLayerById(3),depthTest:!1}:{layer:this.scene.layers.getLayerById(3),depthTest:!0}):i={layer:this.scene.layers.getLayerById(3),depthTest:!0},e.length&&t.length!==e.length?console.error("renderLines: position/color arrays have different lengths"):0!=t.length%2?console.error("renderLines: array length is not divisible by 2"):this._addLines(t,e,i)},renderWireCube:function(t,e,i){var s;this._initImmediate(),this._immediateData.cubeLocalPos||(this._immediateData.cubeLocalPos=[new v(-.5,-.5,-.5),new v(-.5,.5,-.5),new v(.5,.5,-.5),new v(.5,-.5,-.5),new v(-.5,-.5,.5),new v(-.5,.5,.5),new v(.5,.5,.5),new v(.5,-.5,.5)],this._immediateData.cubeWorldPos=[new v,new v,new v,new v,new v,new v,new v,new v]);var n=this._immediateData.cubeLocalPos,r=this._immediateData.cubeWorldPos;for(s=0;8>s;s++)t.transformPoint(n[s],r[s]);this.renderLines([r[0],r[1],r[1],r[2],r[2],r[3],r[3],r[0],r[4],r[5],r[5],r[6],r[6],r[7],r[7],r[4],r[0],r[4],r[1],r[5],r[2],r[6],r[3],r[7]],e,i)},renderMeshInstance:function(t,e){e||(e={layer:this.scene.layers.getLayerById(3)}),this._initImmediate(),this._immediateData.addLayer(e.layer),this.meshInstanceArray[0]=t,e.layer.addMeshInstances(this.meshInstanceArray,!0)},renderMesh:function(t,e,i,s){s||(s={layer:this.scene.layers.getLayerById(3)}),this._initImmediate(),Ku.worldTransform=i,Ku._dirtyWorld=Ku._dirtyNormal=!1,(t=new lt(Ku,t,e)).cull=!1,s.mask&&(t.mask=s.mask),this._immediateData.addLayer(s.layer),this.meshInstanceArray[0]=t,s.layer.addMeshInstances(this.meshInstanceArray,!0)},renderQuad:function(t,e,i){if(i||(i={layer:this.scene.layers.getLayerById(3)}),this._initImmediate(),!this._immediateData.quadMesh){var s=new O(this.graphicsDevice,[{semantic:"POSITION",components:3,type:6}]),n=new W(s=new C(this.graphicsDevice,s,4));n.element.POSITION.set(-.5,-.5,0),n.next(),n.element.POSITION.set(.5,-.5,0),n.next(),n.element.POSITION.set(-.5,.5,0),n.next(),n.element.POSITION.set(.5,.5,0),n.end(),this._immediateData.quadMesh=new ht(this.graphicsDevice),this._immediateData.quadMesh.vertexBuffer=s,this._immediateData.quadMesh.primitive[0].type=5,this._immediateData.quadMesh.primitive[0].base=0,this._immediateData.quadMesh.primitive[0].count=4,this._immediateData.quadMesh.primitive[0].indexed=!1}Ku.worldTransform=t,Ku._dirtyWorld=Ku._dirtyNormal=!1,(t=new lt(Ku,this._immediateData.quadMesh,e)).cull=!1,this.meshInstanceArray[0]=t,this._immediateData.addLayer(i.layer),i.layer.addMeshInstances(this.meshInstanceArray,!0)},destroy:function(){var t,e=this.graphicsDevice.canvas.id;this.off("librariesloaded"),document.removeEventListener("visibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("mozvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("msvisibilitychange",this._visibilityChangeHandler,!1),document.removeEventListener("webkitvisibilitychange",this._visibilityChangeHandler,!1),this.onVisibilityChange=this._visibilityChangeHandler=null,this.root.destroy(),this.root=null,this.mouse&&(this.mouse.off(),this.mouse.detach(),this.mouse=null),this.keyboard&&(this.keyboard.off(),this.keyboard.detach(),this.keyboard=null),this.touch&&(this.touch.off(),this.touch.detach(),this.touch=null),this.elementInput&&(this.elementInput.detach(),this.elementInput=null),this.controller&&(this.controller=null);var i=this.systems.list,s=0;for(t=i.length;s<t;s++)i[s].destroy();for(os.destroy(),t=this.assets.list(),s=0;s<t.length;s++)t[s].unload(),t[s].off();for(var n in this.assets.off(),this.bundles.destroy(),this.bundles=null,this.i18n.destroy(),this.i18n=null,this.loader.getHandler("script")._cache)(t=(s=this.loader.getHandler("script")._cache[n]).parentNode)&&t.removeChild(s);this.loader.getHandler("script")._cache={},this.loader.destroy(),this.loader=null,this.scene.destroy(),this.scene=null,this.systems=[],this.context=null,this.scripts.destroy(),this.scripts=null,this.scenes.destroy(),this.scenes=null,this.lightmapper.destroy(),this.lightmapper=null,this.batcher.destroyManager(),this.batcher=null,this._entityIndex={},this.defaultLayerDepth.onPreRenderOpaque=null,this.defaultLayerDepth.onPostRenderOpaque=null,this.defaultLayerDepth.onDisable=null,this.defaultLayerWorld=this.defaultLayerDepth=this.defaultLayerDepth.onEnable=null,Ia&&(Ia.destroy(),Ia=null),this.vr&&(this.vr.destroy(),this.vr=null),this.xr.end(),this.graphicsDevice.destroy(),this.tick=this.renderer=this.graphicsDevice=null,this.off(),this._soundManager&&(this._soundManager.destroy(),this._soundManager=null),Ql.app=null,tl.DEFAULT_PARAM_TEXTURE=null,sr._applications[e]=null,sr._currentApplication===this&&(sr._currentApplication=null)},getEntityFromIndex:function(t){return this._entityIndex[t]}});var Zu={},Qu=function(e){var i;return function(s,n){if(e.graphicsDevice){sr._currentApplication=e,i&&(window.cancelAnimationFrame(i),i=null),t.app=e;var r=(s=e._processTimestamp(s)||ha())-(e._time||s),a=oa.clamp(r/1e3,0,e.maxDeltaTime);a*=e.timeScale,e._time=s,i=e.vr&&e.vr.display?e.vr.display.requestAnimationFrame(e.tick):e.xr.session?e.xr.session.requestAnimationFrame(e.tick):window.requestAnimationFrame(e.tick),e.graphicsDevice.contextLost||(e.fire("frameupdate",r),n?(e.xr.update(n),e.graphicsDevice.defaultFramebuffer=n.session.renderState.baseLayer.framebuffer):e.graphicsDevice.defaultFramebuffer=null,e.update(a),e.fire("framerender"),(e.autoRender||e.renderNextFrame)&&(e.render(),e.renderNextFrame=!1),Zu.timestamp=ha(),Zu.target=e,e.fire("frameend",Zu),e.fire("frameEnd",Zu),e.vr&&e.vr.display&&e.vr.display.presenting&&e.vr.display.submitFrame())}}},Ju=0;Object.defineProperty(nr.prototype,"shader",{get:function(){return this._shader},set:function(t){this._shader=t}}),Object.defineProperty(nr.prototype,"blendType",{get:function(){if(!this.blend&&1===this.blendSrc&&0===this.blendDst&&0===this.blendEquation)return 3;if(!this.blend||6!==this.blendSrc||8!==this.blendDst||0!==this.blendEquation){if(this.blend&&1===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 1;if(this.blend&&6===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 6;if(this.blend&&4===this.blendSrc&&2===this.blendDst&&0===this.blendEquation)return 7;if(this.blend&&5===this.blendSrc&&1===this.blendDst&&0===this.blendEquation)return 8;if(this.blend&&1===this.blendSrc&&1===this.blendDst&&3===this.blendEquation)return 9;if(this.blend&&1===this.blendSrc&&1===this.blendDst&&4===this.blendEquation)return 10;if(this.blend&&4===this.blendSrc&&0===this.blendDst&&0===this.blendEquation)return 5;if(this.blend&&1===this.blendSrc&&8===this.blendDst&&0===this.blendEquation)return 4}return 2},set:function(t){var e=this.blend;switch(t){case 3:this.blend=!1,this.blendSrc=1,this.blendEquation=this.blendDst=0;break;case 2:this.blend=!0,this.blendSrc=6,this.blendDst=8,this.blendEquation=0;break;case 4:this.blend=!0,this.blendSrc=1,this.blendDst=8,this.blendEquation=0;break;case 1:this.blend=!0,this.blendDst=this.blendSrc=1,this.blendEquation=0;break;case 6:this.blend=!0,this.blendSrc=6,this.blendDst=1,this.blendEquation=0;break;case 7:this.blend=!0,this.blendSrc=4,this.blendDst=2,this.blendEquation=0;break;case 8:this.blend=!0,this.blendSrc=5,this.blendDst=1,this.blendEquation=0;break;case 5:this.blend=!0,this.blendSrc=4,this.blendEquation=this.blendDst=0;break;case 9:this.blend=!0,this.blendDst=this.blendSrc=1,this.blendEquation=3;break;case 10:this.blend=!0,this.blendDst=this.blendSrc=1,this.blendEquation=4}e!==this.blend&&(this._scene?this._scene.layers._dirtyBlend=!0:this._dirtyBlend=!0),this._updateMeshInstanceKeys()}}),nr.prototype._cloneInternal=function(t){t.name=this.name,t.shader=this.shader,t.alphaTest=this.alphaTest,t.alphaToCoverage=this.alphaToCoverage,t.blend=this.blend,t.blendSrc=this.blendSrc,t.blendDst=this.blendDst,t.blendEquation=this.blendEquation,t.separateAlphaBlend=this.separateAlphaBlend,t.blendSrcAlpha=this.blendSrcAlpha,t.blendDstAlpha=this.blendDstAlpha,t.blendAlphaEquation=this.blendAlphaEquation,t.cull=this.cull,t.depthTest=this.depthTest,t.depthWrite=this.depthWrite,t.depthBias=this.depthBias,t.slopeDepthBias=this.slopeDepthBias,this.stencilFront&&(t.stencilFront=this.stencilFront.clone()),this.stencilBack&&(t.stencilBack=this.stencilFront===this.stencilBack?t.stencilFront:this.stencilBack.clone()),t.redWrite=this.redWrite,t.greenWrite=this.greenWrite,t.blueWrite=this.blueWrite,t.alphaWrite=this.alphaWrite},nr.prototype.clone=function(){var t=new nr;return this._cloneInternal(t),t},nr.prototype._updateMeshInstanceKeys=function(){var t,e=this.meshInstances;for(t=0;t<e.length;t++)e[t].updateKey()},nr.prototype.updateUniforms=function(){},nr.prototype.updateShader=function(t,e,i){},nr.prototype.update=function(){this.dirty=!0,this._shader&&(this._shader.failed=!1)},nr.prototype.clearParameters=function(){this.parameters={}},nr.prototype.getParameters=function(){return this.parameters},nr.prototype.clearVariants=function(){this.variants={};for(var t,e=0;e<this.meshInstances.length;e++){var i=this.meshInstances[e];for(t=0;t<i._shader.length;t++)i._shader[t]=null}},nr.prototype.getParameter=function(t){return this.parameters[t]},nr.prototype.setParameter=function(t,e){if(void 0===e&&"object"==typeof t){if((e=t).length){for(t=0;t<e.length;t++)this.setParameter(e[t]);return}t=e.name,e=e.value}var i=this.parameters[t];i?i.data=e:this.parameters[t]={scopeId:null,data:e}},nr.prototype.deleteParameter=function(t){this.parameters[t]&&delete this.parameters[t]},nr.prototype.setParameters=function(t,e){var i=this.parameters;for(var s in void 0===e&&(e=i),e)(e=i[s])&&(e.scopeId||(e.scopeId=t.scope.resolve(s)),e.scopeId.setValue(e.data))},nr.prototype.destroy=function(){this.variants={},this.shader=null;for(var t,e,i=0;i<this.meshInstances.length;i++){for(t=this.meshInstances[i],e=0;e<t._shader.length;e++)t._shader[e]=null;t._material=null,this!==(e=sr.getApplication().scene.defaultMaterial)&&(t.material=e)}},rr.prototype.updateMinRef=function(t,e,i,s,n,r,a,o,h){this._updateSharedOptions(t,s,n,a),this._updateMinOptions(t,s),this._updateUVOptions(t,s,n,!0)},rr.prototype.updateRef=function(t,e,i,s,n,r,a,o,h){this._updateSharedOptions(t,s,n,a),t.useTexCubeLod=e.useTexCubeLod,this._updateEnvOptions(t,s,i,h),this._updateMaterialOptions(t,s),1===a&&(t.gamma&&(t.gamma=3),t.toneMap=0),t.hasTangents=n&&s.normalMap&&0!=(512&n),this._updateLightOptions(t,s,n,o,r),this._updateUVOptions(t,s,n,!1),t.clearCoat=s.clearCoat,t.clearCoatGlossiness=s.clearCoatGlossiness},rr.prototype._updateSharedOptions=function(t,e,i,s){t.pass=s,t.alphaTest=0<e.alphaTest,t.forceFragmentPrecision=e.forceFragmentPrecision||"",t.chunks=e.chunks||"",t.blendType=e.blendType,t.forceUv1=e.forceUv1,t.screenSpace=i&&0!=(256&i),t.skin=i&&0!=(2&i),t.useInstancing=i&&0!=(32&i),t.useMorphPosition=i&&0!=(1024&i),t.useMorphNormal=i&&0!=(2048&i),t.useMorphTextureBased=i&&0!=(4096&i),t.nineSlicedMode=e.nineSlicedMode||0},rr.prototype._updateUVOptions=function(t,e,i,s){var n=!1,r=!1,a=!1;for(var o in i&&(n=0!=(4&i),r=0!=(8&i),a=0!=(16&i)),t.vertexColors=!1,this._mapXForms=[],ja)this._updateTexOptions(t,e,o,n,r,a,s);this._mapXForms=null},rr.prototype._updateMinOptions=function(t,e){t.opacityTint=1!==e.opacity&&3!==e.blendType,t.lights=[]},rr.prototype._updateMaterialOptions=function(t,e){var i=1===e.diffuse.r&&1===e.diffuse.g&&1===e.diffuse.b||!e.diffuseTint&&(e.diffuseMap||e.diffuseVertexColor)?0:3,s=!1,n=!!(e.useMetalness||e.specularMap||e.sphereMap||e.cubeMap||e.dpAtlas);(n=(n=(n=n||!!e.useMetalness||!(0===e.specular.r&&0===e.specular.g&&0===e.specular.b))||e.enableGGXSpecular)||0<e.clearCoat)&&(!e.specularTint&&(e.specularMap||e.specularVertexColor)||e.useMetalness||(s=1!==e.specular.r||1!==e.specular.g||1!==e.specular.b));var r=e.emissiveMap?0:3;r||(r=(r=(1!==e.emissive.r||1!==e.emissive.g||1!==e.emissive.b||1!==e.emissiveIntensity)&&e.emissiveTint)?3:1!==e.emissiveIntensity?1:0);var a=!!e.normalMap&&(10===e.normalMap.format||"swizzleGGGR"===e.normalMap.type);t.opacityTint=1!==e.opacity&&3!==e.blendType?1:0,t.blendMapsWithColors=!0,t.ambientTint=e.ambientTint,t.diffuseTint=i,t.specularTint=s?3:0,t.metalnessTint=e.useMetalness&&1>e.metalness?1:0,t.glossTint=1,t.emissiveTint=r,t.alphaToCoverage=e.alphaToCoverage,t.normalizeNormalMap=e.normalizeNormalMap,t.sphereMap=!!e.sphereMap,t.cubeMap=!!e.cubeMap,t.dpAtlas=!!e.dpAtlas,t.ambientSH=!!e.ambientSH,t.useSpecular=n,t.emissiveFormat=e.emissiveMap?"rgbm"===e.emissiveMap.type?1:14===e.emissiveMap.format?2:0:null,t.lightMapFormat=e.lightMap?"rgbm"===e.lightMap.type?1:14===e.lightMap.format?2:0:null,t.specularAntialias=e.specularAntialias&&!!e.normalMap&&!!e.normalMap.mipmaps&&!a,t.conserveEnergy=e.conserveEnergy,t.occludeSpecular=e.occludeSpecular,t.occludeSpecularFloat=1!==e.occludeSpecularIntensity,t.occludeDirect=e.occludeDirect,t.shadingModel=e.shadingModel,t.fresnelModel=e.fresnelModel,t.packedNormal=a,t.fastTbn=e.fastTbn,t.cubeMapProjection=e.cubeMapProjection,t.customFragmentShader=e.customFragmentShader,t.refraction=!!e.refraction,t.useMetalness=e.useMetalness,t.enableGGXSpecular=e.enableGGXSpecular,t.msdf=!!e.msdfMap,t.twoSidedLighting=e.twoSidedLighting,t.pixelSnap=e.pixelSnap,t.aoMapUv=e.aoUvSet,t.diffuseDetail=!!e.diffuseMap,t.normalDetail=!!e.normalMap,t.diffuseDetailMode=e.diffuseDetailMode,t.detailModes=!!t.diffuseDetail,t.clearCoatTint=1!==e.clearCoat?1:0,t.clearCoatGlossTint=1!==e.clearCoatGlossiness?1:0},rr.prototype._updateEnvOptions=function(t,e,i,s){var n,r=s&&"rgbm"===s.type||e.cubeMap&&"rgbm"===e.cubeMap.type||e.dpAtlas&&"rgbm"===e.dpAtlas.type,a=s&&("rgbm"===s.type||14===s.format)||e.cubeMap&&("rgbm"===e.cubeMap.type||14===e.cubeMap.format)||e.dpAtlas&&("rgbm"===e.dpAtlas.type||14===e.dpAtlas.format),o=s&&!e.cubeMap&&!e.sphereMap&&!e.dpAtlas&&"rgbm"===s.type||e.cubeMap&&"rgbm"===e.cubeMap.type||e.sphereMap&&"rgbm"===e.sphereMap.type||e.dpAtlas&&"rgbm"===e.dpAtlas.type,h=!(!s||e.cubeMap||e.sphereMap||e.dpAtlas)&&("rgbm"===s.type||14===s.format)||e.cubeMap&&("rgbm"===e.cubeMap.type||14===e.cubeMap.format)||e.sphereMap&&("rgbm"===e.sphereMap.type||14===e.sphereMap.format)||e.dpAtlas&&("rgbm"===e.dpAtlas.type||14===e.dpAtlas.format);e.useSkybox&&i._skyboxPrefiltered&&(n=i._skyboxPrefiltered[0]),t.fog=e.useFog?i.fog:"none",t.gamma=e.useGammaTonemap?i.gammaCorrection:0,t.toneMap=e.useGammaTonemap?i.toneMapping:-1,t.rgbmAmbient=r,t.hdrAmbient=a,t.rgbmReflection=o,t.hdrReflection=h,t.useRgbm=o||r||e.emissiveMap&&"rgbm"===e.emissiveMap.type||e.lightMap&&"rgbm"===e.lightMap.type,t.fixSeams=s?s.fixCubemapSeams:!!e.cubeMap&&e.cubeMap.fixCubemapSeams,t.prefilteredCubemap=!!s,t.skyboxIntensity=s&&n&&s===n&&1!==i.skyboxIntensity},rr.prototype._updateLightOptions=function(t,e,i,s,n){t.lightMap=!1,t.lightMapChannel="",t.lightMapUv=0,t.lightMapTransform=0,t.lightMapWithoutAmbient=!1,t.dirLightMap=!1,i&&(t.noShadow=0!=(1&i),0!=(64&i)&&(t.lightMapFormat=1,t.lightMap=!0,t.lightMapChannel="rgb",t.lightMapUv=1,t.lightMapTransform=0,t.lightMapWithoutAmbient=!e.lightMap,t.useRgbm=!0,0!=(128&i)&&(t.dirLightMap=!0))),e.useLighting?(e=[],i=i?i>>16:1,s&&(this._collectLights(0,s[0],e,i),this._collectLights(1,s[1],e,i,n),this._collectLights(2,s[2],e,i,n)),t.lights=e):t.lights=[],0===t.lights.length&&(t.noShadow=!0)},rr.prototype._updateTexOptions=function(t,e,i,s,n,r,a){var o=i+"Map",h=i+"VertexColor",l=i+"VertexColorChannel",c=o+"Channel",d=o+"Transform",u=o+"Uv";"light"!==i&&(t[o]=!1,t[c]="",t[d]=0,t[u]=0),t[h]=!1,t[l]="";var p="opacity"===i;if(p&&3===e.blendType&&0===e.alphaTest&&!e.alphaToCoverage)return t;a&&!p||("height"!==i&&e[h]&&r&&(t[h]=e[h],t[l]=e[l],t.vertexColors=!0),e[o]&&(i=!0,0!==e[u]||s||(i=!1),1!==e[u]||n||(i=!1),i&&(t[o]=!!e[o],t[d]=this._getMapTransformID(e[d],e[u]),t[c]=e[c],t[u]=e[u])))},rr.prototype._collectLights=function(t,e,i,s,n){var r;for(r=0;r<e.length;r++){var a=e[r];a.enabled&&a.mask&s&&(0===t||!a.isStatic)&&i.push(a)}if(n)for(r=0;r<n.length;r++)(a=n[r])._type===t&&i.push(a)},rr.prototype._getMapTransformID=function(t,e){if(!t)return 0;var i;for(this._mapXForms[e]||(this._mapXForms[e]=[]),i=0;i<this._mapXForms[e].length&&this._mapXForms[e][i][0]==t.x&&this._mapXForms[e][i][1]==t.y&&this._mapXForms[e][i][2]==t.z&&this._mapXForms[e][i][3]==t.w;)return i+1;return i=this._mapXForms[e].length,this._mapXForms[e][i]=[],this._mapXForms[e][i][0]=t.x,this._mapXForms[e][i][1]=t.y,this._mapXForms[e][i][2]=t.z,this._mapXForms[e][i][3]=t.w,i+1},ar.prototype=Object.create(nr.prototype),ar.prototype.constructor=ar,ar.TEXTURE_PARAMETERS=Hl,ar.CUBEMAP_PARAMETERS=Xl;var tp=[],ep=[],ip=[],sp=[],np={},rp=function(t,e,i,s,n,r,a){var o="_"+e+"Map",h=o+"Tiling",l=o+"Offset",c=o.substring(1)+"Transform",d=c+"Uniform",u=o+"Uv",p=o+"Channel",f="_"+e+"VertexColor",m="_"+e+"VertexColorChannel",_="_"+e+"Mode";t[o]=null,t[h]=new y(1,1),t[l]=new y(0,0),t[c]=null,t[d]=null,t[u]=i,0<s&&(i=n||(1<s?"rgb":"g"),t[p]=i,r&&(t[m]=i)),r&&(t[f]=!1),a&&(t[_]="mul"),ja[e]=s,Object.defineProperty(ar.prototype,o.substring(1),{get:function(){return this[o]},set:function(t){var e=this[o];!!e^!!t&&(this.dirtyShader=!0),e&&t&&(e.type!==t.type||e.fixCubemapSeams!==t.fixCubemapSeams||e.format!==t.format)&&(this.dirtyShader=!0),this[o]=t}}),t=h.substring(1),e=l.substring(1),Object.defineProperty(ar.prototype,t,{get:function(){return this[h]},set:function(t){this.dirtyShader=!0,this[h]=t}}),np[t]=function(t,e,i){return t=t._updateMapTransform(i?t[c]:null,e,t[l]),{name:"texture_"+c,value:t.data}},Object.defineProperty(ar.prototype,e,{get:function(){return this[l]},set:function(t){this.dirtyShader=!0,this[l]=t}}),np[e]=function(t,e,i){return t=t._updateMapTransform(i?t[c]:null,t[h],e),{name:"texture_"+c,value:t.data}},Object.defineProperty(ar.prototype,u.substring(1),{get:function(){return this[u]},set:function(t){this[u]!==t&&(this.dirtyShader=!0),this[u]=t}}),Object.defineProperty(ar.prototype,p.substring(1),{get:function(){return this[p]},set:function(t){this[p]!==t&&(this.dirtyShader=!0),this[p]=t}}),r&&(Object.defineProperty(ar.prototype,f.substring(1),{get:function(){return this[f]},set:function(t){this.dirtyShader=!0,this[f]=t}}),Object.defineProperty(ar.prototype,m.substring(1),{get:function(){return this[m]},set:function(t){this[m]!==t&&(this.dirtyShader=!0),this[m]=t}})),a&&Object.defineProperty(ar.prototype,_.substring(1),{get:function(){return this[_]},set:function(t){this.dirtyShader=!0,this[_]=t}}),tp.push(o.substring(1)),tp.push(h.substring(1)),tp.push(l.substring(1)),tp.push(u.substring(1)),tp.push(p.substring(1)),r&&(tp.push(f.substring(1)),tp.push(m.substring(1))),a&&tp.push(_.substring(1)),ip.push(c)},ap=[],op=function(t,e,i,s){var n="_"+e,r=e+"Uniform",a=e+"Intensity",o="_"+a;t[n]=i,t[r]=new Float32Array(3),Object.defineProperty(ar.prototype,e,{get:function(){return this.dirtyShader=this.dirtyColor=!0,this[n]},set:function(t){var e=this[n];(0===e.r&&0===e.g&&0===e.b||1===e.r&&1===e.g&&1===e.b)^(0===t.r&&0===t.g&&0===t.b||1===t.r&&1===t.g&&1===t.b)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[n]=t}}),tp.push(e),sp.push(r),ap.push(e),np[e]=function(t,i,n){n=n?t[r]:new Float32Array(3);var a=!1;t.useGammaTonemap&&(a=(t._scene||sr.getApplication().scene).gammaCorrection);for(var h=0;3>h;h++)n[h]=a?Math.pow(i.data[h],2.2):i.data[h],s&&(n[h]*=t[o]);return{name:"material_"+e,value:n}},s&&(t[o]=1,Object.defineProperty(ar.prototype,a,{get:function(){return this[o]},set:function(t){var e=this[o];(0===e||1===e)^(0===t||1===t)&&(this.dirtyShader=!0),this.dirtyColor=!0,this[o]=t}}),tp.push(a),np[a]=function(t,i,s){i=s?t[r]:new Float32Array(3),s=!1,t.useGammaTonemap&&(s=(t._scene||sr.getApplication().scene).gammaCorrection);for(var a=0;3>a;a++)i[a]=s?Math.pow(t[n].data[a],2.2):t[n].data[a],i[a]*=t[o];return{name:"material_"+e,value:i}})},hp=function(t,e,i,s){var n="_"+e;t[n]=i,Object.defineProperty(ar.prototype,e,{get:function(){return this[n]},set:function(t){var e=this[n];e!==t&&(this[n]=t,0===e||1===e||0===t||1===t)&&(this.dirtyShader=!0)}}),tp.push(e),np[e]=void 0!==s?s:function(t,i,s){return{name:"material_"+e,value:i}}},lp=function(t,e,i){var s="_"+e;t[s]=null,Object.defineProperty(ar.prototype,e,{get:function(){return this[s]},set:function(t){!!this[s]^!!t&&(this.dirtyShader=!0),this[s]=t}}),tp.push(e),np[e]=i},cp=function(t,e,i){Object.defineProperty(ar.prototype,i,{get:function(){return this[e]},set:function(t){this[e]=t}})},dp=function(t,e,i){var s="_"+e;t[s]=i,Object.defineProperty(ar.prototype,e,{get:function(){return this[s]},set:function(t){this[s]!==t&&(this.dirtyShader=!0),this[s]=t}}),tp.push(e)},up=function(){};up.prototype.copy=function(t){for(var e in t)t.hasOwnProperty(e)&&"copy"!==e&&(this[e]=t[e])},Object.assign(ar.prototype,{reset:function(){var t;for(t=0;t<tp.length;t++){var e=ep[t];this[tp[t]]=e&&e.clone?e.clone():e}for(t=0;t<ip.length;t++)this[ip[t]]=null;for(t=0;t<sp.length;t++)this[sp[t]]=new Float32Array(3);this._chunks=new up,this.cubeMapMinUniform=new Float32Array(3),this.cubeMapMaxUniform=new Float32Array(3)},clone:function(){var t=new ar;nr.prototype._cloneInternal.call(this,t);for(var e,i=0;i<tp.length;i++)void 0!==this[e=tp[i]]&&(this[e]&&this[e].copy?t[e]?t[e].copy(this[e]):t[e]=this[e].clone():t[e]=this[e]);return t},_updateMapTransform:function(t,e,i){return 1===e.x&&1===e.y&&0===i.x&&0===i.y?null:((t=t||new b).set(e.x,e.y,i.x,i.y),t)},_setParameter:function(t,e){this.parameters[t]||this._propsSet.push(t),this.setParameter(t,e)},_clearParameters:function(){for(var t=this._propsSet,e=0;e<t.length;e++)delete this.parameters[t[e]];this._propsSet=[]},_updateMap:function(t){var e=t+"Map";if(t=this[e]){this._setParameter("texture_"+e,t),this[t=e+"Transform"]=this._updateMapTransform(this[t],this[e+"Tiling"],this[e+"Offset"]);var i=this[t];if(i){var s=this[e+="TransformUniform"];s||(s=new Float32Array(4),this[e]=s),s[0]=i.x,s[1]=i.y,s[2]=i.z,s[3]=i.w,this._setParameter("texture_"+t,s)}}},getUniform:function(t,e,i){return(t=np[t])?t(this,e,i):null},updateUniforms:function(){this._clearParameters(),this._setParameter("material_ambient",this.ambientUniform),this.diffuseMap&&!this.diffuseTint||this._setParameter("material_diffuse",this.diffuseUniform),this.useMetalness?((!this.metalnessMap||1>this.metalness)&&this._setParameter("material_metalness",this.metalness),this.enableGGXSpecular&&this._setParameter("material_anisotropy",this.anisotropy)):this.specularMap&&!this.specularTint||this._setParameter("material_specular",this.specularUniform),0<this.clearCoat&&(this._setParameter("material_clearCoat",this.clearCoat),this._setParameter("material_clearCoatGlossiness",this.clearCoatGlossiness),this._setParameter("material_clearCoatReflectivity",this.clearCoat),this._setParameter("material_clearCoatBumpiness",this.clearCoatBumpiness));var t=this.getUniform("shininess",this.shininess,!0);for(var e in this._setParameter(t.name,t.value),this.emissiveMap&&!this.emissiveTint||this._setParameter("material_emissive",this.emissiveUniform),this.emissiveMap&&this._setParameter("material_emissiveIntensity",this.emissiveIntensity),0<this.refraction&&(this._setParameter("material_refraction",this.refraction),this._setParameter("material_refractionIndex",this.refractionIndex)),this._setParameter("material_opacity",this.opacity),this.occludeSpecular&&this._setParameter("material_occludeSpecularIntensity",this.occludeSpecularIntensity),1===this.cubeMapProjection&&this._setParameter(this.getUniform("cubeMapProjectionBox",this.cubeMapProjectionBox,!0)),ja)this._updateMap(e);this.ambientSH&&this._setParameter("ambientSH[0]",this.ambientSH),this.normalMap&&this._setParameter("material_bumpiness",this.bumpiness),this.normalMap&&this.normalDetailMap&&this._setParameter("material_normalDetailMapBumpiness",this.normalDetailMapBumpiness),this.heightMap&&(t=this.getUniform("heightMapFactor",this.heightMapFactor,!0),this._setParameter(t.name,t.value)),this.cubeMap&&this._setParameter("texture_cubeMap",this.cubeMap),this.prefilteredCubeMap128?this._setParameter("texture_prefilteredCubeMap128",this.prefilteredCubeMap128):this._scene&&this._scene._skyboxPrefiltered[0]&&this._setParameter("texture_prefilteredCubeMap128",this._scene._skyboxPrefiltered[0]),this.prefilteredCubeMap64?this._setParameter("texture_prefilteredCubeMap64",this.prefilteredCubeMap64):this._scene&&this._scene._skyboxPrefiltered[1]&&this._setParameter("texture_prefilteredCubeMap64",this._scene._skyboxPrefiltered[1]),this.prefilteredCubeMap32?this._setParameter("texture_prefilteredCubeMap32",this.prefilteredCubeMap32):this._scene&&this._scene._skyboxPrefiltered[2]&&this._setParameter("texture_prefilteredCubeMap32",this._scene._skyboxPrefiltered[2]),this.prefilteredCubeMap16?this._setParameter("texture_prefilteredCubeMap16",this.prefilteredCubeMap16):this._scene&&this._scene._skyboxPrefiltered[3]&&this._setParameter("texture_prefilteredCubeMap16",this._scene._skyboxPrefiltered[3]),this.prefilteredCubeMap8?this._setParameter("texture_prefilteredCubeMap8",this.prefilteredCubeMap8):this._scene&&this._scene._skyboxPrefiltered[4]&&this._setParameter("texture_prefilteredCubeMap8",this._scene._skyboxPrefiltered[4]),this.prefilteredCubeMap4?this._setParameter("texture_prefilteredCubeMap4",this.prefilteredCubeMap4):this._scene&&this._scene._skyboxPrefiltered[5]&&this._setParameter("texture_prefilteredCubeMap4",this._scene._skyboxPrefiltered[5]),this.sphereMap&&this._setParameter("texture_sphereMap",this.sphereMap),this.dpAtlas&&this._setParameter("texture_sphereMap",this.dpAtlas),this._setParameter("material_reflectivity",this.reflectivity),!this.dirtyShader&&this._scene||(this.shader=null,this.clearVariants()),this._processColor()},_processColor:function(){var t;if(this.dirtyColor&&(this._scene||!this.useGammaTonemap)){var e=!1;for(this.useGammaTonemap&&(e=this._scene.gammaCorrection),t=0;t<ap.length;t++){var i=this["_"+ap[t]],s=this[ap[t]+"Uniform"];e?(s[0]=Math.pow(i.r,2.2),s[1]=Math.pow(i.g,2.2),s[2]=Math.pow(i.b,2.2)):(s[0]=i.r,s[1]=i.g,s[2]=i.b)}for(t=0;3>t;t++)this.emissiveUniform[t]*=this.emissiveIntensity;this.dirtyColor=!1}},updateShader:function(t,e,i,s,n,r){!this._colorProcessed&&this._scene&&(this._colorProcessed=!0,this._processColor());var a=t.useTexCubeLod,o=!t.extTextureLod;if(this.useSkybox)var h=e._skyboxPrefiltered[0],l=e._skyboxPrefiltered[1],c=e._skyboxPrefiltered[2],d=e._skyboxPrefiltered[3],u=e._skyboxPrefiltered[4],p=e._skyboxPrefiltered[5];if(h=this.prefilteredCubeMap128||h,l=this.prefilteredCubeMap64||l,c=this.prefilteredCubeMap32||c,d=this.prefilteredCubeMap16||d,u=this.prefilteredCubeMap8||u,p=this.prefilteredCubeMap4||p,h){var f=h&&l&&c&&d&&u&&p;if(o&&f){if(!h.dpAtlas){a=[h,l,c,d,u,p],o=new b,p=new b,l=4*a[0].width,u=st(t,Ra.fullscreenQuadVS,Ra.dpAtlasQuadPS,"dpAtlasQuad"),c=t.scope.resolve("source"),f=t.scope.resolve("params");var m=new nt(t,{type:a[0].type,format:a[0].format,width:l,height:l,mipmaps:!1});m.name="paraboloid";for(var _=new gp(t,m,{depth:!1}),g=(l+2)/l-1,y=0;6>y;y++){var v=t,x=a[y],S=y,T=st(v,Ra.fullscreenQuadVS,(x.fixCubemapSeams?Ra.fixCubemapSeamsStretchPS:Ra.fixCubemapSeamsNonePS)+Ra.genParaboloidPS,"genParaboloid"),w=v.scope.resolve("source"),M=v.scope.resolve("params"),P=new b,A=x.width,E=x.format;A=2*Math.max(A,8),(A=new nt(v,{type:x.type,format:E,width:2*A,height:A,mipmaps:!1})).name="paraboloid",E=new gp(v,A,{depth:!1}),P.x=S,P.y=1,w.setValue(x),M.setValue(P.data),X(v,E,T),v=A,c.setValue(v),x=y,(v=o).x=.5*oa.clamp(x-2,0,1),x-=6*v.x,S=1-v.x,v.y=Math.min(.5*x,.75)*S+v.x,v.z=(1-.5*oa.clamp(x,0,1))*S,v.w=.5*v.z,v=1/v.z,p.x=v*g,p.y=2*p.x,p.x+=1,p.y+=1,f.setValue(p.data),o.x*=l,o.y*=l,o.z*=l,o.w*=l,X(t,_,u,o)}h.dpAtlas=m,h.sh=_r(d)}this.dpAtlas=h.dpAtlas,this.ambientSH=h.sh,this._setParameter("ambientSH[0]",this.ambientSH),this._setParameter("texture_sphereMap",this.dpAtlas)}else a?6>h._levels.length?f?this._setParameter("texture_prefilteredCubeMap128",h):console.log("Can't use prefiltered cubemap: "+f+", "+a+", "+h._levels):this._setParameter("texture_prefilteredCubeMap128",h):f?(this._setParameter("texture_prefilteredCubeMap128",h),this._setParameter("texture_prefilteredCubeMap64",l),this._setParameter("texture_prefilteredCubeMap32",c),this._setParameter("texture_prefilteredCubeMap16",d),this._setParameter("texture_prefilteredCubeMap8",u),this._setParameter("texture_prefilteredCubeMap4",p)):console.log("Can't use prefiltered cubemap: "+f+", "+a+", "+h._levels)}a=(d=1<n&&18>=n)?Ga.optionsContextMin:Ga.optionsContext,d?this.shaderOptBuilder.updateMinRef(a,t,e,this,i,s,n,r,h):this.shaderOptBuilder.updateRef(a,t,e,this,i,s,n,r,h),this.onUpdateShader&&(a=this.onUpdateShader(a)),this.shader=t.getProgramLibrary().getProgram("standard",a),i||(this.clearVariants(),this.variants[0]=this.shader),this.dirtyShader=!1}}),function(t){t.dirtyShader=!0,t.dirtyColor=!0,t._scene=null,t._colorProcessed=!1,op(t,"ambient",new o(.7,.7,.7)),op(t,"diffuse",new o(1,1,1)),op(t,"specular",new o(0,0,0)),op(t,"emissive",new o(0,0,0),!0),hp(t,"shininess",25,function(t,e){return{name:"material_shininess",value:0===t.shadingModel?Math.pow(2,.11*e):.01*e}}),hp(t,"heightMapFactor",1,function(t,e){return{name:"material_heightMapFactor",value:.025*e}}),hp(t,"opacity",1),hp(t,"alphaTest",0),hp(t,"bumpiness",1),hp(t,"normalDetailMapBumpiness",1),hp(t,"reflectivity",1),hp(t,"occludeSpecularIntensity",1),hp(t,"refraction",0),hp(t,"refractionIndex",1/1.5),hp(t,"metalness",1),hp(t,"anisotropy",0),hp(t,"clearCoat",0),hp(t,"clearCoatGlossiness",1),hp(t,"clearCoatBumpiness",1),hp(t,"aoUvSet",0,null),lp(t,"ambientSH",function(t,e,i){return{name:"ambientSH[0]",value:e}}),lp(t,"cubeMapProjectionBox",function(t,e,i){var s=i?t.cubeMapMinUniform:new Float32Array(3);return t=i?t.cubeMapMaxUniform:new Float32Array(3),s[0]=e.center.x-e.halfExtents.x,s[1]=e.center.y-e.halfExtents.y,s[2]=e.center.z-e.halfExtents.z,t[0]=e.center.x+e.halfExtents.x,t[1]=e.center.y+e.halfExtents.y,t[2]=e.center.z+e.halfExtents.z,[{name:"envBoxMin",value:s},{name:"envBoxMax",value:t}]}),Object.defineProperty(ar.prototype,"chunks",{get:function(){return this.dirtyShader=!0,this._chunks},set:function(t){this.dirtyShader=!0,this._chunks=t}}),tp.push("chunks"),dp(t,"ambientTint",!1),dp(t,"diffuseTint",!1),dp(t,"specularTint",!1),dp(t,"emissiveTint",!1),dp(t,"fastTbn",!1),dp(t,"specularAntialias",!1),dp(t,"useMetalness",!1),dp(t,"enableGGXSpecular",!1),dp(t,"occludeDirect",!1),dp(t,"normalizeNormalMap",!0),dp(t,"conserveEnergy",!0),dp(t,"occludeSpecular",1),dp(t,"shadingModel",1),dp(t,"fresnelModel",0),dp(t,"cubeMapProjection",0),dp(t,"customFragmentShader",null),dp(t,"forceFragmentPrecision",null),dp(t,"useFog",!0),dp(t,"useLighting",!0),dp(t,"useGammaTonemap",!0),dp(t,"useSkybox",!0),dp(t,"forceUv1",!1),dp(t,"pixelSnap",!1),dp(t,"twoSidedLighting",!1),dp(t,"nineSlicedMode",void 0),rp(t,"diffuse",0,3,"",!0),rp(t,"specular",0,3,"",!0),rp(t,"emissive",0,3,"",!0),rp(t,"normal",0,-1,"",!1),rp(t,"metalness",0,1,"",!0),rp(t,"gloss",0,1,"",!0),rp(t,"opacity",0,1,"a",!0),rp(t,"height",0,1,"",!1),rp(t,"ao",0,1,"",!0),rp(t,"light",1,3,"",!0),rp(t,"msdf",0,3,"",!1),rp(t,"diffuseDetail",0,3,"",!1,!0),rp(t,"normalDetail",0,-1,"",!1),rp(t,"clearCoat",0,1,"",!0),rp(t,"clearCoatGloss",0,1,"",!0),rp(t,"clearCoatNormal",0,-1,"",!1),lp(t,"cubeMap"),lp(t,"sphereMap"),lp(t,"dpAtlas"),lp(t,"prefilteredCubeMap128"),lp(t,"prefilteredCubeMap64"),lp(t,"prefilteredCubeMap32"),lp(t,"prefilteredCubeMap16"),lp(t,"prefilteredCubeMap8"),lp(t,"prefilteredCubeMap4"),cp(0,"diffuseTint","diffuseMapTint"),cp(0,"specularTint","specularMapTint"),cp(0,"emissiveTint","emissiveMapTint"),cp(0,"aoVertexColor","aoMapVertexColor"),cp(0,"diffuseVertexColor","diffuseMapVertexColor"),cp(0,"specularVertexColor","specularMapVertexColor"),cp(0,"emissiveVertexColor","emissiveMapVertexColor"),cp(0,"metalnessVertexColor","metalnessMapVertexColor"),cp(0,"glossVertexColor","glossMapVertexColor"),cp(0,"opacityVertexColor","opacityMapVertexColor"),cp(0,"lightVertexColor","lightMapVertexColor");for(var e=0;e<tp.length;e++)ep[e]=t[tp[e]];t._propsSet=[]}(ar.prototype),or.prototype.register=function(t,e){this.isRegistered(t)||(this._generators[t]=e)},or.prototype.unregister=function(t){this.isRegistered(t)&&delete this._generators[t]},or.prototype.isRegistered=function(t){return void 0!==this._generators[t]},or.prototype.getProgram=function(t,e){var i=this._generators[t];if(void 0===i)return null;var s=this._device,n=i.generateKey(e),r=this._cache[n];if(!r){if(e.lights){var a=e.lights;e.lights=a.map(function(t){var e=t.clone?t.clone():t;return e.key=t.key,e})}this.storeNewProgram(t,e),e.lights&&(e.lights=a),this._precached&&console.warn("ProgramLibrary#getProgram: Cache miss for shader",t,"key",n,"after shaders precaching"),t=i.createShaderDefinition(s,e),r=this._cache[n]=new q(s,t)}return r},or.prototype.storeNewProgram=function(t,e){var i={};if("standard"===t){var s,n=this._getDefaultStdMatOptions(e.pass);for(s in e)(e.hasOwnProperty(s)&&n[s]!==e[s]||"pass"===s)&&(i[s]=e[s])}else i=e;this._programsCollection.push(JSON.stringify({name:t,options:i}))},or.prototype.dumpPrograms=function(){var t="var device = pc.app ? pc.app.graphicsDevice : pc.Application.getApplication().graphicsDevice;\nvar shaders = [";this._programsCollection[0]&&(t+="\n\t"+this._programsCollection[0]);for(var e=1;e<this._programsCollection.length;++e)t+=",\n\t"+this._programsCollection[e];t+='\n];\ndevice.programLib.precompile(shaders);\nif (pc.version != "1.35.0" || pc.revision != "100604b")\n\tconsole.warn("precompile-shaders.js: engine version mismatch, rebuild shaders lib with current engine");',(e=document.createElement("a")).setAttribute("href","data:text/plain;charset=utf-8,"+encodeURIComponent(t)),e.setAttribute("download","precompile-shaders.js"),e.style.display="none",document.body.appendChild(e),e.click(),document.body.removeChild(e)},or.prototype.clearCache=function(){var t=this._cache;for(var e in this._isClearingCache=!0,t)t.hasOwnProperty(e)&&t[e].destroy();this._cache={},this._isClearingCache=!1},or.prototype.removeFromCache=function(t){if(!this._isClearingCache){var e,i=this._cache;for(e in i)if(i.hasOwnProperty(e)&&i[e]===t){delete i[e];break}}},or.prototype._getDefaultStdMatOptions=function(t){return 1<t&&18>=t?this._defaultStdMatOptionMin:this._defaultStdMatOption},or.prototype.precompile=function(t){if(t)for(var e=Array(t.length),i=0;i<t.length;i++){if("standard"===t[i].name){var s,n=t[i].options,r=this._getDefaultStdMatOptions(n.pass);for(s in r)r.hasOwnProperty(s)&&void 0===n[s]&&(n[s]=r[s]);n.useTexCubeLod=this._device.useTexCubeLod}e[i]=this.getProgram(t[i].name,t[i].options)}this._precached=!0},Object.assign(hr.prototype,{equals:function(t){return this.globalId===t.globalId&&this.revision===t.revision},notequals:function(t){return this.globalId!==t.globalId||this.revision!==t.revision},copy:function(t){this.globalId=t.globalId,this.revision=t.revision},reset:function(){this.revision=this.globalId=0}});var pp=0;Object.assign(lr.prototype,{increment:function(){this.version.revision++}}),Object.assign(cr.prototype,{setValue:function(t){this.value=t,this.versionObject.increment()},getValue:function(){return this.value}}),Object.assign(dr.prototype,{resolve:function(t){return this.variables.hasOwnProperty(t)||(this.variables[t]=new cr(t)),this.variables[t]},getSubSpace:function(t){return this.namespaces.hasOwnProperty(t)||(this.namespaces[t]=new dr(t)),this.namespaces[t]}});var fp=function(t,e){var i=t.width,s=t.height;if(i>e||s>e){var n=e/Math.max(i,s),r=Math.floor(i*n);return n=Math.floor(s*n),console.warn("Image dimensions larger than max supported texture size of "+e+". Resizing from "+i+", "+s+" to "+r+", "+n+"."),(e=document.createElement("canvas")).width=r,e.height=n,e.getContext("2d").drawImage(t,0,0,i,s,0,0,r,n),e}return t},mp=function(t,e){var i;n.call(this),this.canvas=t,this.indexBuffer=this.shader=null,this.vertexBuffers=[],this._enableAutoInstancing=!1,this.autoInstancingMaxObjects=16384,this.activeFramebuffer=this.transformFeedbackBuffer=this.boundVao=this.defaultFramebuffer=null,this.textureUnit=0,this.textureUnits=[],this._maxPixelRatio=1,this.feedback=this.renderTarget=null,this._tempEnableSafariTextureUnitWorkaround=!!window.safari,this._height=this._width=0,this.updateClientRect(),this.vertexShaderCache={},this.fragmentShaderCache={},this.shaders=[],this.buffers=[],this.textures=[],this.targets=[],this._vaoMap=new Map,this.contextLost=!1,this._contextLostHandler=function(t){t.preventDefault(),this.contextLost=!0,this.fire("devicelost")}.bind(this),this._contextRestoredHandler=function(){this.initializeContext(),this.contextLost=!1,this.fire("devicerestored")}.bind(this);var s,r,a,o,h,l=!e||void 0===e.preferWebGl2||e.preferWebGl2,c=l?["webgl2","experimental-webgl2","webgl","experimental-webgl"]:["webgl","experimental-webgl"],d=null;for((e=e||{}).stencil=!0,i=0;i<c.length;i++){try{d=t.getContext(c[i],e)}catch(t){}if(d){this.webgl2=l&&2>i;break}}if(!d)throw Error("WebGL not supported");for(this.gl=d,window.setupVertexArrayObject(d),t.addEventListener("webglcontextlost",this._contextLostHandler,!1),t.addEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState(),i=0;i<this.maxCombinedTextures;i++)this.textureUnits.push([null,null,null]);for(var u in this.defaultClearOptions={color:[0,0,0,1],depth:1,stencil:0,flags:3},this.glAddress=[d.REPEAT,d.CLAMP_TO_EDGE,d.MIRRORED_REPEAT],this.glBlendEquation=[d.FUNC_ADD,d.FUNC_SUBTRACT,d.FUNC_REVERSE_SUBTRACT,this.webgl2?d.MIN:this.extBlendMinmax?this.extBlendMinmax.MIN_EXT:d.FUNC_ADD,this.webgl2?d.MAX:this.extBlendMinmax?this.extBlendMinmax.MAX_EXT:d.FUNC_ADD],this.glBlendFunction=[d.ZERO,d.ONE,d.SRC_COLOR,d.ONE_MINUS_SRC_COLOR,d.DST_COLOR,d.ONE_MINUS_DST_COLOR,d.SRC_ALPHA,d.SRC_ALPHA_SATURATE,d.ONE_MINUS_SRC_ALPHA,d.DST_ALPHA,d.ONE_MINUS_DST_ALPHA],this.glComparison=[d.NEVER,d.LESS,d.EQUAL,d.LEQUAL,d.GREATER,d.NOTEQUAL,d.GEQUAL,d.ALWAYS],this.glStencilOp=[d.KEEP,d.ZERO,d.REPLACE,d.INCR,d.INCR_WRAP,d.DECR,d.DECR_WRAP,d.INVERT],this.glClearFlag=[0,d.COLOR_BUFFER_BIT,d.DEPTH_BUFFER_BIT,d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT,d.STENCIL_BUFFER_BIT,d.STENCIL_BUFFER_BIT|d.COLOR_BUFFER_BIT,d.STENCIL_BUFFER_BIT|d.DEPTH_BUFFER_BIT,d.STENCIL_BUFFER_BIT|d.COLOR_BUFFER_BIT|d.DEPTH_BUFFER_BIT],this.glCull=[0,d.BACK,d.FRONT,d.FRONT_AND_BACK],this.glFilter=[d.NEAREST,d.LINEAR,d.NEAREST_MIPMAP_NEAREST,d.NEAREST_MIPMAP_LINEAR,d.LINEAR_MIPMAP_NEAREST,d.LINEAR_MIPMAP_LINEAR],this.glPrimitive=[d.POINTS,d.LINES,d.LINE_LOOP,d.LINE_STRIP,d.TRIANGLES,d.TRIANGLE_STRIP,d.TRIANGLE_FAN],this.glType=[d.BYTE,d.UNSIGNED_BYTE,d.SHORT,d.UNSIGNED_SHORT,d.INT,d.UNSIGNED_INT,d.FLOAT],this.pcUniformType={},this.pcUniformType[d.BOOL]=0,this.pcUniformType[d.INT]=1,this.pcUniformType[d.FLOAT]=2,this.pcUniformType[d.FLOAT_VEC2]=3,this.pcUniformType[d.FLOAT_VEC3]=4,this.pcUniformType[d.FLOAT_VEC4]=5,this.pcUniformType[d.INT_VEC2]=6,this.pcUniformType[d.INT_VEC3]=7,this.pcUniformType[d.INT_VEC4]=8,this.pcUniformType[d.BOOL_VEC2]=9,this.pcUniformType[d.BOOL_VEC3]=10,this.pcUniformType[d.BOOL_VEC4]=11,this.pcUniformType[d.FLOAT_MAT2]=12,this.pcUniformType[d.FLOAT_MAT3]=13,this.pcUniformType[d.FLOAT_MAT4]=14,this.pcUniformType[d.SAMPLER_2D]=15,this.pcUniformType[d.SAMPLER_CUBE]=16,this.webgl2&&(this.pcUniformType[d.SAMPLER_2D_SHADOW]=18,this.pcUniformType[d.SAMPLER_CUBE_SHADOW]=19,this.pcUniformType[d.SAMPLER_3D]=20),this.targetToSlot={},this.targetToSlot[d.TEXTURE_2D]=0,this.targetToSlot[d.TEXTURE_CUBE_MAP]=1,this.targetToSlot[d.TEXTURE_3D]=2,this.commitFunction=[],this.commitFunction[0]=function(t,e){t.value!==e&&(d.uniform1i(t.locationId,e),t.value=e)},this.commitFunction[1]=this.commitFunction[0],this.commitFunction[2]=function(t,e){t.value!==e&&(d.uniform1f(t.locationId,e),t.value=e)},this.commitFunction[3]=function(t,e){h=t.value,s=e[0],r=e[1],h[0]===s&&h[1]===r||(d.uniform2fv(t.locationId,e),h[0]=s,h[1]=r)},this.commitFunction[4]=function(t,e){h=t.value,s=e[0],r=e[1],a=e[2],h[0]===s&&h[1]===r&&h[2]===a||(d.uniform3fv(t.locationId,e),h[0]=s,h[1]=r,h[2]=a)},this.commitFunction[5]=function(t,e){h=t.value,s=e[0],r=e[1],a=e[2],o=e[3],h[0]===s&&h[1]===r&&h[2]===a&&h[3]===o||(d.uniform4fv(t.locationId,e),h[0]=s,h[1]=r,h[2]=a,h[3]=o)},this.commitFunction[6]=function(t,e){h=t.value,s=e[0],r=e[1],h[0]===s&&h[1]===r||(d.uniform2iv(t.locationId,e),h[0]=s,h[1]=r)},this.commitFunction[9]=this.commitFunction[6],this.commitFunction[7]=function(t,e){h=t.value,s=e[0],r=e[1],a=e[2],h[0]===s&&h[1]===r&&h[2]===a||(d.uniform3iv(t.locationId,e),h[0]=s,h[1]=r,h[2]=a)},this.commitFunction[10]=this.commitFunction[7],this.commitFunction[8]=function(t,e){h=t.value,s=e[0],r=e[1],a=e[2],o=e[3],h[0]===s&&h[1]===r&&h[2]===a&&h[3]===o||(d.uniform4iv(t.locationId,e),h[0]=s,h[1]=r,h[2]=a,h[3]=o)},this.commitFunction[11]=this.commitFunction[8],this.commitFunction[12]=function(t,e){d.uniformMatrix2fv(t.locationId,!1,e)},this.commitFunction[13]=function(t,e){d.uniformMatrix3fv(t.locationId,!1,e)},this.commitFunction[14]=function(t,e){d.uniformMatrix4fv(t.locationId,!1,e)},this.commitFunction[17]=function(t,e){d.uniform1fv(t.locationId,e)},this.commitFunction[21]=function(t,e){d.uniform2fv(t.locationId,e)},this.commitFunction[22]=function(t,e){d.uniform3fv(t.locationId,e)},this.commitFunction[23]=function(t,e){d.uniform4fv(t.locationId,e)},this.scope=new dr("Device"),this.programLib=new or(this),Ha)this.programLib.register(u,Ha[u]);for(this.supportsBoneTextures=this.extTextureFloat&&0<this.maxVertexTextures,this.useTexCubeLod=this.extTextureLod&&16>this.maxTextures,this.boneLimit=Math.floor((this.vertexUniformsCount-16-8-1-16)/3),this.boneLimit=Math.min(this.boneLimit,128),"Mali-450 MP"===this.unmaskedRenderer&&(this.boneLimit=34),this._shaderSwitchesPerFrame=this._drawCallsPerFrame=0,this._primsPerFrame=[],i=0;6>=i;i++)this._primsPerFrame[i]=0;this._renderTargetCreationTime=0,this._vram={tex:0,vb:0,ib:0},this._shaderStats={vsCompiled:0,fsCompiled:0,linked:0,materialShaders:0,compileTime:0},this.constantTexSource=this.scope.resolve("source"),this.textureFloatRenderable=!!this.extTextureFloat&&(this.webgl2?!!this.extColorBufferFloat:pr(d,d.FLOAT)),this.textureHalfFloatRenderable=!!this.extTextureHalfFloat&&(this.webgl2?!!this.extColorBufferFloat:pr(d,this.extTextureHalfFloat.HALF_FLOAT_OES)),this.supportsMorphTargetTexturesCore="highp"===this.maxPrecision&&2<=this.maxVertexTextures,this._textureHalfFloatUpdatable=this._textureFloatHighPrecision=void 0,this.createGrabPass(e.alpha),O.init(this)};mp.prototype=Object.create(n.prototype),mp.prototype.constructor=mp,Object.assign(mp.prototype,{getPrecision:function(){var t=this.gl,e="highp";if(t.getShaderPrecisionFormat){var i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),s=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),n=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT);t=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),s=0<s.precision&&0<t.precision,0<i.precision&&0<n.precision||(e=s?"mediump":"lowp")}return e},initializeExtensions:function(){var t=this.gl,e=t.getSupportedExtensions(),i=function(){for(var i=0;i<arguments.length;i++)if(-1!==e.indexOf(arguments[i]))return t.getExtension(arguments[i]);return null};if(this.webgl2)this.extVertexArrayObject=this.extUintElement=this.extTextureLod=this.extTextureHalfFloatLinear=this.extTextureHalfFloat=this.extTextureFloat=this.extStandardDerivatives=this.extInstancing=this.extDrawBuffers=this.extBlendMinmax=!0,this.extColorBufferFloat=i("EXT_color_buffer_float"),this.extDisjointTimerQuery=i("EXT_disjoint_timer_query_webgl2","EXT_disjoint_timer_query");else{if(this.extBlendMinmax=i("EXT_blend_minmax"),this.extDrawBuffers=i("EXT_draw_buffers"),this.extInstancing=i("ANGLE_instanced_arrays")){var s=this.extInstancing;t.drawArraysInstanced=s.drawArraysInstancedANGLE.bind(s),t.drawElementsInstanced=s.drawElementsInstancedANGLE.bind(s),t.vertexAttribDivisor=s.vertexAttribDivisorANGLE.bind(s)}this.extStandardDerivatives=i("OES_standard_derivatives"),this.extTextureFloat=i("OES_texture_float"),this.extTextureHalfFloat=i("OES_texture_half_float"),this.extTextureHalfFloatLinear=i("OES_texture_half_float_linear"),this.extTextureLod=i("EXT_shader_texture_lod"),this.extUintElement=i("OES_element_index_uint"),(this.extVertexArrayObject=i("OES_vertex_array_object"))&&(s=this.extVertexArrayObject,t.createVertexArray=s.createVertexArrayOES.bind(s),t.deleteVertexArray=s.deleteVertexArrayOES.bind(s),t.isVertexArray=s.isVertexArrayOES.bind(s),t.bindVertexArray=s.bindVertexArrayOES.bind(s)),this.extDisjointTimerQuery=this.extColorBufferFloat=null}this.extDebugRendererInfo=i("WEBGL_debug_renderer_info"),this.extTextureFloatLinear=i("OES_texture_float_linear"),this.extFloatBlend=i("EXT_float_blend"),this.extTextureFilterAnisotropic=i("EXT_texture_filter_anisotropic","WEBKIT_EXT_texture_filter_anisotropic"),this.extCompressedTextureETC1=i("WEBGL_compressed_texture_etc1"),this.extCompressedTextureETC=i("WEBGL_compressed_texture_etc"),this.extCompressedTexturePVRTC=i("WEBGL_compressed_texture_pvrtc","WEBKIT_WEBGL_compressed_texture_pvrtc"),this.extCompressedTextureS3TC=i("WEBGL_compressed_texture_s3tc","WEBKIT_WEBGL_compressed_texture_s3tc"),this.extCompressedTextureATC=i("WEBGL_compressed_texture_atc"),this.extCompressedTextureASTC=i("WEBGL_compressed_texture_astc"),this.extParallelShaderCompile=i("KHR_parallel_shader_compile"),this.supportsInstancing=!!this.extInstancing},initializeCapabilities:function(){var t=this.gl;this.maxPrecision=this.precision=this.getPrecision();var e=t.getContextAttributes();this.supportsMsaa=e.antialias,this.supportsStencil=e.stencil,this.maxTextureSize=t.getParameter(t.MAX_TEXTURE_SIZE),this.maxCubeMapSize=t.getParameter(t.MAX_CUBE_MAP_TEXTURE_SIZE),this.maxRenderBufferSize=t.getParameter(t.MAX_RENDERBUFFER_SIZE),this.maxTextures=t.getParameter(t.MAX_TEXTURE_IMAGE_UNITS),this.maxCombinedTextures=t.getParameter(t.MAX_COMBINED_TEXTURE_IMAGE_UNITS),this.maxVertexTextures=t.getParameter(t.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.vertexUniformsCount=t.getParameter(t.MAX_VERTEX_UNIFORM_VECTORS),this.fragmentUniformsCount=t.getParameter(t.MAX_FRAGMENT_UNIFORM_VECTORS),this.webgl2?(this.maxDrawBuffers=t.getParameter(t.MAX_DRAW_BUFFERS),this.maxColorAttachments=t.getParameter(t.MAX_COLOR_ATTACHMENTS),this.maxVolumeSize=t.getParameter(t.MAX_3D_TEXTURE_SIZE)):(this.maxDrawBuffers=(e=this.extDrawBuffers)?t.getParameter(e.MAX_DRAW_BUFFERS_EXT):1,this.maxColorAttachments=e?t.getParameter(e.MAX_COLOR_ATTACHMENTS_EXT):1,this.maxVolumeSize=1),this.unmaskedRenderer=(e=this.extDebugRendererInfo)?t.getParameter(e.UNMASKED_RENDERER_WEBGL):"",this.unmaskedVendor=e?t.getParameter(e.UNMASKED_VENDOR_WEBGL):"",this.maxAnisotropy=(e=this.extTextureFilterAnisotropic)?t.getParameter(e.MAX_TEXTURE_MAX_ANISOTROPY_EXT):1,this.samples=t.getParameter(t.SAMPLES)},initializeRenderState:function(){var t=this.gl;this.blending=!1,t.disable(t.BLEND),this.blendSrc=1,this.blendDst=0,this.blendSrcAlpha=1,this.blendDstAlpha=0,this.separateAlphaBlend=!1,this.blendAlphaEquation=this.blendEquation=0,this.separateAlphaEquation=!1,t.blendFunc(t.ONE,t.ZERO),t.blendEquation(t.FUNC_ADD),this.writeAlpha=this.writeBlue=this.writeGreen=this.writeRed=!0,t.colorMask(!0,!0,!0,!0),this.cullMode=1,t.enable(t.CULL_FACE),t.cullFace(t.BACK),this.depthTest=!0,t.enable(t.DEPTH_TEST),this.depthFunc=3,t.depthFunc(t.LEQUAL),this.depthWrite=!0,t.depthMask(!0),this.stencil=!1,t.disable(t.STENCIL_TEST),this.stencilFuncFront=this.stencilFuncBack=7,this.stencilRefFront=this.stencilRefBack=0,this.stencilMaskFront=this.stencilMaskBack=255,t.stencilFunc(t.ALWAYS,0,255),this.stencilZpassFront=this.stencilZpassBack=this.stencilZfailFront=this.stencilZfailBack=this.stencilFailFront=this.stencilFailBack=0,this.stencilWriteMaskBack=this.stencilWriteMaskFront=255,t.stencilOp(t.KEEP,t.KEEP,t.KEEP),t.stencilMask(255),this.alphaToCoverage=!1,this.raster=!0,this.webgl2&&(t.disable(t.SAMPLE_ALPHA_TO_COVERAGE),t.disable(t.RASTERIZER_DISCARD)),this.depthBiasEnabled=!1,t.disable(t.POLYGON_OFFSET_FILL),this.clearDepth=1,t.clearDepth(1),this.clearAlpha=this.clearGreen=this.clearBlue=this.clearRed=0,t.clearColor(0,0,0,0),this.clearStencil=0,t.clearStencil(0),this.sx=this.sy=this.sw=this.sh=this.vx=this.vy=this.vw=this.vh=0,this.webgl2?t.hint(t.FRAGMENT_SHADER_DERIVATIVE_HINT,t.NICEST):this.extStandardDerivatives&&t.hint(this.extStandardDerivatives.FRAGMENT_SHADER_DERIVATIVE_HINT_OES,t.NICEST),t.enable(t.SCISSOR_TEST),t.pixelStorei(t.UNPACK_COLORSPACE_CONVERSION_WEBGL,t.NONE),this.unpackFlipY=!1,t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,!1),this.unpackPremultiplyAlpha=!1,t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)},initializeContext:function(){var t;this.initializeExtensions(),this.initializeCapabilities(),this.initializeRenderState();var e=0;for(t=this.shaders.length;e<t;e++)this.compileAndLinkShader(this.shaders[e]);for(this.shader=null,e=0,t=this.buffers.length;e<t;e++)this.buffers[e].bufferId=void 0,this.buffers[e].unlock();for(this.indexBuffer=this.boundVao=null,this.vertexBuffers=[],e=0,t=this.textures.length;e<t;e++){var i=this.textures[e];this.destroyTexture(i),i.dirtyAll()}for(this.textureUnit=0,e=this.textureUnits.length=0;e<this.maxCombinedTextures;e++)this.textureUnits.push([null,null,null]);for(e=0,t=this.targets.length;e<t;e++)this.targets[e]._glFrameBuffer=void 0,this.targets[e]._glDepthBuffer=void 0,this.targets[e]._glResolveFrameBuffer=void 0,this.targets[e]._glMsaaColorBuffer=void 0,this.targets[e]._glMsaaDepthBuffer=void 0;this.transformFeedbackBuffer=this.feedback=this.activeFramebuffer=this.renderTarget=null},createGrabPass:function(t){if(!this.grabPassTexture){(t=new nt(this,{format:t?7:6,minFilter:1,magFilter:1,addressU:1,addressV:1,mipmaps:!1})).name="texture_grabPass";var e=this.scope.resolve(t.name);e.setValue(t),this.grabPassRenderTarget=new gp({colorBuffer:t,depth:!1}),this.grabPassTextureId=e,this.grabPassTexture=t}},updateGrabPass:function(){var t=this.gl,e=this.renderTarget,i=e&&e._glResolveFrameBuffer,s=this.grabPassTexture,n=this.width,r=this.height;this.webgl2&&n===s._width&&r===s._height?(i&&e.resolve(!0),i=e?e._glFrameBuffer:null,e=e?e._glResolveFrameBuffer||e._glFrameBuffer:null,this.initRenderTarget(this.grabPassRenderTarget),s=this.grabPassRenderTarget._glFrameBuffer,t.bindFramebuffer(t.READ_FRAMEBUFFER,e),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,s),t.blitFramebuffer(0,0,n,r,0,0,n,r,t.COLOR_BUFFER_BIT,t.NEAREST),t.bindFramebuffer(t.DRAW_FRAMEBUFFER,i)):(i&&(e.resolve(!0),t.bindFramebuffer(t.FRAMEBUFFER,e._glResolveFrameBuffer)),t.copyTexImage2D(t.TEXTURE_2D,0,s._glFormat,0,0,n,r,0),s._width=n,s._height=r,i&&t.bindFramebuffer(t.FRAMEBUFFER,e._glFrameBuffer))},destroyGrabPass:function(){this.grabPassRenderTarget.destroy(),this.grabPassTextureId=this.grabPassRenderTarget=null,this.grabPassTexture.destroy(),this.grabPassTexture=null},updateClientRect:function(){this.clientRect=this.canvas.getBoundingClientRect()},setViewport:function(t,e,i,s){this.vx===t&&this.vy===e&&this.vw===i&&this.vh===s||(this.gl.viewport(t,e,i,s),this.vx=t,this.vy=e,this.vw=i,this.vh=s)},setScissor:function(t,e,i,s){this.sx===t&&this.sy===e&&this.sw===i&&this.sh===s||(this.gl.scissor(t,e,i,s),this.sx=t,this.sy=e,this.sw=i,this.sh=s)},getProgramLibrary:function(){return this.programLib},setProgramLibrary:function(t){this.programLib=t},setFramebuffer:function(t){this.activeFramebuffer!==t&&(this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.activeFramebuffer=t)},_checkFbo:function(){var t=this.gl;switch(t.checkFramebufferStatus(t.FRAMEBUFFER)){case t.FRAMEBUFFER_INCOMPLETE_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT");break;case t.FRAMEBUFFER_INCOMPLETE_DIMENSIONS:console.error("ERROR: FRAMEBUFFER_INCOMPLETE_DIMENSIONS");break;case t.FRAMEBUFFER_UNSUPPORTED:console.error("ERROR: FRAMEBUFFER_UNSUPPORTED")}},copyRenderTarget:function(t,e,i,s){var n=this.gl;if(!this.webgl2&&s)return!1;if(i)if(e){if(!t._colorBuffer||!e._colorBuffer||t._colorBuffer._format!==e._colorBuffer._format)return!1}else if(!t._colorBuffer)return!1;if(s&&(!t._depthBuffer||!e._depthBuffer||t._depthBuffer._format!==e._depthBuffer._format))return!1;if(this.webgl2&&e){var r=this.renderTarget;this.renderTarget=e,this.updateBegin(),n.bindFramebuffer(n.READ_FRAMEBUFFER,t?t._glFrameBuffer:null),n.bindFramebuffer(n.DRAW_FRAMEBUFFER,e._glFrameBuffer);var a=t?t.width:e.width;t=t?t.height:e.height,n.blitFramebuffer(0,0,a,t,0,0,a,t,(i?n.COLOR_BUFFER_BIT:0)|(s?n.DEPTH_BUFFER_BIT:0),n.NEAREST),this.renderTarget=r,n.bindFramebuffer(n.FRAMEBUFFER,r?r._glFrameBuffer:null)}else i=this.getCopyShader(),this.constantTexSource.setValue(t._colorBuffer),X(this,e,i);return!0},initRenderTarget:function(t){if(!t._glFrameBuffer){t._device=this;var e=this.gl;t._glFrameBuffer=e.createFramebuffer(),this.setFramebuffer(t._glFrameBuffer);var i=t._colorBuffer;i&&(i._glTexture||(i._width=Math.min(i.width,this.maxRenderBufferSize),i._height=Math.min(i.height,this.maxRenderBufferSize),this.setTexture(i,0)),e.framebufferTexture2D(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,i._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,i._glTexture,0));var s=t._depthBuffer;s&&this.webgl2?(s._glTexture||(s._width=Math.min(s.width,this.maxRenderBufferSize),s._height=Math.min(s.height,this.maxRenderBufferSize),this.setTexture(s,0)),t._stencil?e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,s._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,t._depthBuffer._glTexture,0):e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,s._cubemap?e.TEXTURE_CUBE_MAP_POSITIVE_X+t._face:e.TEXTURE_2D,t._depthBuffer._glTexture,0)):!t._depth||1<t._samples&&this.webgl2||(t._glDepthBuffer||(t._glDepthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glDepthBuffer),t._stencil?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t._glDepthBuffer)):(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t._glDepthBuffer)),e.bindRenderbuffer(e.RENDERBUFFER,null)),this.webgl2&&1<t._samples&&(t._glResolveFrameBuffer=t._glFrameBuffer,t._glFrameBuffer=e.createFramebuffer(),this.setFramebuffer(t._glFrameBuffer),i&&(t._glMsaaColorBuffer||(t._glMsaaColorBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glMsaaColorBuffer),e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,i._glInternalFormat,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.RENDERBUFFER,t._glMsaaColorBuffer)),t._depth&&(t._glMsaaDepthBuffer||(t._glMsaaDepthBuffer=e.createRenderbuffer()),e.bindRenderbuffer(e.RENDERBUFFER,t._glMsaaDepthBuffer),t._stencil?(e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,e.DEPTH24_STENCIL8,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t._glMsaaDepthBuffer)):(e.renderbufferStorageMultisample(e.RENDERBUFFER,t._samples,e.DEPTH_COMPONENT32F,t.width,t.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t._glMsaaDepthBuffer)))),this.targets.push(t)}},getCopyShader:function(){return this._copyShader||(this._copyShader=st(this,Ra.fullscreenQuadVS,Ra.outputTex2DPS,"outputTex2D")),this._copyShader},updateBegin:function(){if(this.boundVao=null,this._tempEnableSafariTextureUnitWorkaround)for(var t=0;t<this.textureUnits.length;++t)for(var e=0;3>e;++e)this.textureUnits[t][e]=null;(t=this.renderTarget)?t._glFrameBuffer?this.setFramebuffer(t._glFrameBuffer):this.initRenderTarget(t):this.setFramebuffer(this.defaultFramebuffer)},updateEnd:function(){var t=this.gl;this.boundVao=null,this.gl.bindVertexArray(null);var e=this.renderTarget;if(e){var i=e._colorBuffer;i&&i._glTexture&&i.mipmaps&&i.pot&&(this.activeTexture(this.maxCombinedTextures-1),this.bindTexture(i),t.generateMipmap(i._glTarget)),this.webgl2&&1<e._samples&&e.autoResolve&&e.resolve()}},initializeTexture:function(t){var e=this.gl;switch(t._glTexture=e.createTexture(),t._glTarget=t._cubemap?e.TEXTURE_CUBE_MAP:t._volume?e.TEXTURE_3D:e.TEXTURE_2D,t._format){case 0:t._glFormat=e.ALPHA,t._glInternalFormat=e.ALPHA,t._glPixelType=e.UNSIGNED_BYTE;break;case 1:t._glFormat=e.LUMINANCE,t._glInternalFormat=e.LUMINANCE,t._glPixelType=e.UNSIGNED_BYTE;break;case 2:t._glFormat=e.LUMINANCE_ALPHA,t._glInternalFormat=e.LUMINANCE_ALPHA,t._glPixelType=e.UNSIGNED_BYTE;break;case 3:t._glFormat=e.RGB,t._glInternalFormat=e.RGB,t._glPixelType=e.UNSIGNED_SHORT_5_6_5;break;case 4:t._glFormat=e.RGBA,t._glInternalFormat=e.RGBA,t._glPixelType=e.UNSIGNED_SHORT_5_5_5_1;break;case 5:t._glFormat=e.RGBA,t._glInternalFormat=e.RGBA,t._glPixelType=e.UNSIGNED_SHORT_4_4_4_4;break;case 6:t._glFormat=e.RGB,t._glInternalFormat=this.webgl2?e.RGB8:e.RGB,t._glPixelType=e.UNSIGNED_BYTE;break;case 7:t._glFormat=e.RGBA,t._glInternalFormat=this.webgl2?e.RGBA8:e.RGBA,t._glPixelType=e.UNSIGNED_BYTE;break;case 8:var i=this.extCompressedTextureS3TC;t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case 9:i=this.extCompressedTextureS3TC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case 10:i=this.extCompressedTextureS3TC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;case 21:i=this.extCompressedTextureETC1,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB_ETC1_WEBGL;break;case 24:i=this.extCompressedTexturePVRTC,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;break;case 25:i=this.extCompressedTexturePVRTC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG;break;case 26:i=this.extCompressedTexturePVRTC,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;break;case 27:i=this.extCompressedTexturePVRTC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;break;case 22:i=this.extCompressedTextureETC,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB8_ETC2;break;case 23:i=this.extCompressedTextureETC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA8_ETC2_EAC;break;case 28:i=this.extCompressedTextureASTC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_ASTC_4x4_KHR;break;case 29:i=this.extCompressedTextureATC,t._glFormat=e.RGB,t._glInternalFormat=i.COMPRESSED_RGB_ATC_WEBGL;break;case 30:i=this.extCompressedTextureATC,t._glFormat=e.RGBA,t._glInternalFormat=i.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL;break;case 11:i=this.extTextureHalfFloat,t._glFormat=e.RGB,this.webgl2?(t._glInternalFormat=e.RGB16F,t._glPixelType=e.HALF_FLOAT):(t._glInternalFormat=e.RGB,t._glPixelType=i.HALF_FLOAT_OES);break;case 12:i=this.extTextureHalfFloat,t._glFormat=e.RGBA,this.webgl2?(t._glInternalFormat=e.RGBA16F,t._glPixelType=e.HALF_FLOAT):(t._glInternalFormat=e.RGBA,t._glPixelType=i.HALF_FLOAT_OES);break;case 13:t._glFormat=e.RGB,t._glInternalFormat=this.webgl2?e.RGB32F:e.RGB,t._glPixelType=e.FLOAT;break;case 14:t._glFormat=e.RGBA,t._glInternalFormat=this.webgl2?e.RGBA32F:e.RGBA,t._glPixelType=e.FLOAT;break;case 15:t._glFormat=e.RED,t._glInternalFormat=e.R32F,t._glPixelType=e.FLOAT;break;case 16:this.webgl2?(t._glFormat=e.DEPTH_COMPONENT,t._glInternalFormat=e.DEPTH_COMPONENT32F,t._glPixelType=e.FLOAT):(t._glFormat=e.DEPTH_COMPONENT,t._glInternalFormat=e.DEPTH_COMPONENT,t._glPixelType=e.UNSIGNED_SHORT);break;case 17:t._glFormat=e.DEPTH_STENCIL,t._glInternalFormat=e.DEPTH24_STENCIL8,t._glPixelType=e.UNSIGNED_INT_24_8;break;case 18:t._glFormat=e.RGB,t._glInternalFormat=e.R11F_G11F_B10F,t._glPixelType=e.FLOAT;break;case 19:t._glFormat=e.RGB,t._glInternalFormat=e.SRGB8,t._glPixelType=e.UNSIGNED_BYTE;break;case 20:t._glFormat=e.RGBA,t._glInternalFormat=e.SRGB8_ALPHA8,t._glPixelType=e.UNSIGNED_BYTE}this.textures.push(t)},destroyTexture:function(t){if(t._glTexture){var e=this.textures.indexOf(t);for(var i in-1!==e&&this.textures.splice(e,1),this.scope.variables)(e=this.scope.variables[i]).value===t&&(e.value=null);for(i=0;i<this.textureUnits.length;i++){e=this.textureUnits[i];for(var s=0;s<e.length;s++)e[s]===t._glTexture&&(e[s]=null)}this.gl.deleteTexture(t._glTexture),delete t._glTexture,delete t._glTarget,delete t._glFormat,delete t._glInternalFormat,delete t._glPixelType,this._vram.tex-=t._gpuSize}},setUnpackFlipY:function(t){if(this.unpackFlipY!==t){this.unpackFlipY=t;var e=this.gl;e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t)}},setUnpackPremultiplyAlpha:function(t){if(this.unpackPremultiplyAlpha!==t){this.unpackPremultiplyAlpha=t;var e=this.gl;e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,t)}},_isBrowserInterface:function(t){return"undefined"!=typeof HTMLCanvasElement&&t instanceof HTMLCanvasElement||"undefined"!=typeof HTMLImageElement&&t instanceof HTMLImageElement||"undefined"!=typeof HTMLVideoElement&&t instanceof HTMLVideoElement||"undefined"!=typeof ImageBitmap&&t instanceof ImageBitmap},uploadTexture:function(t){var e=this.gl;if(t._needsUpload||!(t._needsMipmapsUpload&&t._mipmapsUploaded||!t.pot)){for(var i,s,n=0,r=Math.log2(Math.max(t._width,t._height))+1;t._levels[n]||0===n;){if(t._needsUpload||0!==n){if(n&&(!t._needsMipmapsUpload||!t._mipmaps))break;var a;if(i=t._levels[n],1==n&&!t._compressed&&t._levels.length<r&&(e.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._cubemap){if(this._isBrowserInterface(i[0]))for(a=0;6>a;a++)t._levelsUpdated[0][a]&&((s=i[a])instanceof HTMLImageElement&&(s.width>this.maxCubeMapSize||s.height>this.maxCubeMapSize)&&(s=fp(s,this.maxCubeMapSize),0===n&&(t._width=s.width,t._height=s.height)),this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,t._glInternalFormat,t._glFormat,t._glPixelType,s));else for(s=1/Math.pow(2,n),a=0;6>a;a++)if(t._levelsUpdated[0][a]){var o=i[a];t._compressed?e.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,o):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+a,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,t._glFormat,t._glPixelType,o))}}else t._volume?(s=1/Math.pow(2,n),t._compressed?e.compressedTexImage3D(e.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage3D(e.TEXTURE_3D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),Math.max(t._depth*s,1),0,t._glFormat,t._glPixelType,i))):(this._isBrowserInterface(i)?(i instanceof HTMLImageElement&&(i.width>this.maxTextureSize||i.height>this.maxTextureSize)&&(i=fp(i,this.maxTextureSize),0===n&&(t._width=i.width,t._height=i.height)),this.setUnpackFlipY(t._flipY),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,n,t._glInternalFormat,t._glFormat,t._glPixelType,i)):(s=1/Math.pow(2,n),t._compressed?e.compressedTexImage2D(e.TEXTURE_2D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,i):(this.setUnpackFlipY(!1),this.setUnpackPremultiplyAlpha(t._premultiplyAlpha),e.texImage2D(e.TEXTURE_2D,n,t._glInternalFormat,Math.max(t._width*s,1),Math.max(t._height*s,1),0,t._glFormat,t._glPixelType,i))),t._mipmapsUploaded=0!==n)}n++}if(t._needsUpload)if(t._cubemap)for(n=0;6>n;n++)t._levelsUpdated[0][n]=!1;else t._levelsUpdated[0]=!1;!t._compressed&&t._mipmaps&&t._needsMipmapsUpload&&t.pot&&1===t._levels.length&&(e.generateMipmap(t._glTarget),t._mipmapsUploaded=!0),t._gpuSize&&(this._vram.tex-=t._gpuSize),t._gpuSize=t.gpuSize,this._vram.tex+=t._gpuSize}},activeTexture:function(t){this.textureUnit!==t&&(this.gl.activeTexture(this.gl.TEXTURE0+t),this.textureUnit=t)},bindTexture:function(t){var e=t._glTarget;t=t._glTexture;var i=this.textureUnit,s=this.targetToSlot[e];this.textureUnits[i][s]!==t&&(this.gl.bindTexture(e,t),this.textureUnits[i][s]=t)},bindTextureOnUnit:function(t,e){var i=t._glTarget;t=t._glTexture;var s=this.targetToSlot[i];this.textureUnits[e][s]!==t&&(this.activeTexture(e),this.gl.bindTexture(i,t),this.textureUnits[e][s]=t)},setTextureParameters:function(t){var e=this.gl,i=t._parameterFlags,s=t._glTarget;if(1&i){var n=t._minFilter;(!t.pot||!t._mipmaps||t._compressed&&1===t._levels.length)&&(2===n||3===n?n=0:4!==n&&5!==n||(n=1)),e.texParameteri(s,e.TEXTURE_MIN_FILTER,this.glFilter[n])}2&i&&e.texParameteri(s,e.TEXTURE_MAG_FILTER,this.glFilter[t._magFilter]),4&i&&(this.webgl2?e.texParameteri(s,e.TEXTURE_WRAP_S,this.glAddress[t._addressU]):e.texParameteri(s,e.TEXTURE_WRAP_S,this.glAddress[t.pot?t._addressU:1])),8&i&&(this.webgl2?e.texParameteri(s,e.TEXTURE_WRAP_T,this.glAddress[t._addressV]):e.texParameteri(s,e.TEXTURE_WRAP_T,this.glAddress[t.pot?t._addressV:1])),16&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_WRAP_R,this.glAddress[t._addressW]),32&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_COMPARE_MODE,t._compareOnRead?e.COMPARE_REF_TO_TEXTURE:e.NONE),64&i&&this.webgl2&&e.texParameteri(s,e.TEXTURE_COMPARE_FUNC,this.glComparison[t._compareFunc]),128&i&&(i=this.extTextureFilterAnisotropic)&&e.texParameterf(s,i.TEXTURE_MAX_ANISOTROPY_EXT,Math.max(1,Math.min(Math.round(t._anisotropy),this.maxAnisotropy)))},setTexture:function(t,e){t._glTexture||this.initializeTexture(t),0<t._parameterFlags||t._needsUpload||t._needsMipmapsUpload||t===this.grabPassTexture?(this.activeTexture(e),this.bindTexture(t),t._parameterFlags&&(this.setTextureParameters(t),t._parameterFlags=0),t===this.grabPassTexture?this.updateGrabPass():(t._needsUpload||t._needsMipmapsUpload)&&(this.uploadTexture(t),t._needsUpload=!1,t._needsMipmapsUpload=!1)):this.bindTextureOnUnit(t,e)},createVertexArray:function(t){var e,i=1<t.length;if(i){var s="";for(e=0;e<t.length;e++){var n=t[e];s+=n.id+n.format.renderingingHash}var r=this._vaoMap.get(s)}if(!r){var a=this.gl;for(r=a.createVertexArray(),a.bindVertexArray(r),a.bindBuffer(a.ELEMENT_ARRAY_BUFFER,null),e=0;e<t.length;e++){n=t[e],a.bindBuffer(a.ARRAY_BUFFER,n.bufferId);for(var o=n.format.elements,h=0;h<o.length;h++){var l=o[h],c=Ea[l.name];a.vertexAttribPointer(c,l.numComponents,this.glType[l.dataType],l.normalize,l.stride,l.offset),a.enableVertexAttribArray(c),n.instancing&&a.vertexAttribDivisor(c,1)}}a.bindVertexArray(null),a.bindBuffer(a.ARRAY_BUFFER,null),i&&this._vaoMap.set(s,r)}return r},setBuffers:function(){var t=this.gl;if(1===this.vertexBuffers.length){var e=this.vertexBuffers[0];e._vao||(e._vao=this.createVertexArray(this.vertexBuffers)),e=e._vao}else e=this.createVertexArray(this.vertexBuffers);this.boundVao!==e&&(this.boundVao=e,t.bindVertexArray(e)),this.vertexBuffers.length=0,t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,this.indexBuffer?this.indexBuffer.bufferId:null)},draw:function(t,e,i){var s,n,r,a=this.gl,o=this.shader,h=o.samplers;o=o.uniforms,i||this.setBuffers();var l=0;for(i=0,n=h.length;i<n;i++){var c=h[i];if(r=c.scopeId.value)if(r instanceof nt){var d=r;this.setTexture(d,l),c.slot!==l&&(a.uniform1i(c.locationId,l),c.slot=l),l++}else{c.array.length=0;var u=r.length;for(s=0;s<u;s++)d=r[s],this.setTexture(d,l),c.array[s]=l,l++;a.uniform1iv(c.locationId,c.array)}}for(i=0,n=o.length;i<n;i++)s=(h=o[i]).scopeId,c=h.version,r=s.versionObject.version,(c.globalId!==r.globalId||c.revision!==r.revision)&&(c.globalId=r.globalId,c.revision=r.revision,null!==s.value&&this.commitFunction[h.dataType](h,s.value));this.webgl2&&this.transformFeedbackBuffer&&(a.bindBufferBase(a.TRANSFORM_FEEDBACK_BUFFER,0,this.transformFeedbackBuffer.bufferId),a.beginTransformFeedback(a.POINTS)),o=this.glPrimitive[t.type],i=t.count,t.indexed?(n=(h=this.indexBuffer).glFormat,t=t.base*h.bytesPerIndex,0<e?a.drawElementsInstanced(o,i,n,t,e):a.drawElements(o,i,n,t)):(t=t.base,0<e?a.drawArraysInstanced(o,t,i,e):a.drawArrays(o,t,i)),this.webgl2&&this.transformFeedbackBuffer&&(a.endTransformFeedback(),a.bindBufferBase(a.TRANSFORM_FEEDBACK_BUFFER,0,null))},clear:function(t){var e=this.defaultClearOptions,i=null==(t=t||e).flags?e.flags:t.flags;if(0!==i){var s=this.gl;if(1&i){var n=null==t.color?e.color:t.color;this.setClearColor(n[0],n[1],n[2],n[3])}2&i&&(this.setClearDepth(null==t.depth?e.depth:t.depth),this.depthWrite||s.depthMask(!0)),4&i&&this.setClearStencil(null==t.stencil?e.stencil:t.stencil),s.clear(this.glClearFlag[i]),2&i&&(this.depthWrite||s.depthMask(!1))}},readPixels:function(t,e,i,s,n){var r=this.gl;r.readPixels(t,e,i,s,r.RGBA,r.UNSIGNED_BYTE,n)},setClearDepth:function(t){t!==this.clearDepth&&(this.gl.clearDepth(t),this.clearDepth=t)},setClearColor:function(t,e,i,s){t===this.clearRed&&e===this.clearGreen&&i===this.clearBlue&&s===this.clearAlpha||(this.gl.clearColor(t,e,i,s),this.clearRed=t,this.clearGreen=e,this.clearBlue=i,this.clearAlpha=s)},setClearStencil:function(t){t!==this.clearStencil&&(this.gl.clearStencil(t),this.clearStencil=t)},setRenderTarget:function(t){this.renderTarget=t},getRenderTarget:function(){return this.renderTarget},getDepthTest:function(){return this.depthTest},setDepthTest:function(t){if(this.depthTest!==t){var e=this.gl;t?e.enable(e.DEPTH_TEST):e.disable(e.DEPTH_TEST),this.depthTest=t}},setDepthFunc:function(t){this.depthFunc!==t&&(this.gl.depthFunc(this.glComparison[t]),this.depthFunc=t)},getDepthWrite:function(){return this.depthWrite},setDepthWrite:function(t){this.depthWrite!==t&&(this.gl.depthMask(t),this.depthWrite=t)},setColorWrite:function(t,e,i,s){this.writeRed===t&&this.writeGreen===e&&this.writeBlue===i&&this.writeAlpha===s||(this.gl.colorMask(t,e,i,s),this.writeRed=t,this.writeGreen=e,this.writeBlue=i,this.writeAlpha=s)},setAlphaToCoverage:function(t){this.webgl2&&this.alphaToCoverage!==t&&((this.alphaToCoverage=t)?this.gl.enable(this.gl.SAMPLE_ALPHA_TO_COVERAGE):this.gl.disable(this.gl.SAMPLE_ALPHA_TO_COVERAGE))},setTransformFeedbackBuffer:function(t){if(this.transformFeedbackBuffer!==t&&(this.transformFeedbackBuffer=t,this.webgl2)){var e=this.gl;t?(this.feedback||(this.feedback=e.createTransformFeedback()),e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,this.feedback)):e.bindTransformFeedback(e.TRANSFORM_FEEDBACK,null)}},setRaster:function(t){this.raster!==t&&(this.raster=t,this.webgl2&&(t?this.gl.disable(this.gl.RASTERIZER_DISCARD):this.gl.enable(this.gl.RASTERIZER_DISCARD)))},setDepthBias:function(t){this.depthBiasEnabled!==t&&((this.depthBiasEnabled=t)?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL))},setDepthBiasValues:function(t,e){this.gl.polygonOffset(e,t)},getBlending:function(){return this.blending},setBlending:function(t){if(this.blending!==t){var e=this.gl;t?e.enable(e.BLEND):e.disable(e.BLEND),this.blending=t}},setStencilTest:function(t){if(this.stencil!==t){var e=this.gl;t?e.enable(e.STENCIL_TEST):e.disable(e.STENCIL_TEST),this.stencil=t}},setStencilFunc:function(t,e,i){this.stencilFuncFront===t&&this.stencilRefFront===e&&this.stencilMaskFront===i&&this.stencilFuncBack===t&&this.stencilRefBack===e&&this.stencilMaskBack===i||(this.gl.stencilFunc(this.glComparison[t],e,i),this.stencilFuncFront=this.stencilFuncBack=t,this.stencilRefFront=this.stencilRefBack=e,this.stencilMaskFront=this.stencilMaskBack=i)},setStencilFuncFront:function(t,e,i){if(this.stencilFuncFront!==t||this.stencilRefFront!==e||this.stencilMaskFront!==i){var s=this.gl;s.stencilFuncSeparate(s.FRONT,this.glComparison[t],e,i),this.stencilFuncFront=t,this.stencilRefFront=e,this.stencilMaskFront=i}},setStencilFuncBack:function(t,e,i){if(this.stencilFuncBack!==t||this.stencilRefBack!==e||this.stencilMaskBack!==i){var s=this.gl;s.stencilFuncSeparate(s.BACK,this.glComparison[t],e,i),this.stencilFuncBack=t,this.stencilRefBack=e,this.stencilMaskBack=i}},setStencilOperation:function(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i&&this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOp(this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=this.stencilFailBack=t,this.stencilZfailFront=this.stencilZfailBack=e,this.stencilZpassFront=this.stencilZpassBack=i),this.stencilWriteMaskFront===s&&this.stencilWriteMaskBack===s||(this.gl.stencilMask(s),this.stencilWriteMaskBack=this.stencilWriteMaskFront=s)},setStencilOperationFront:function(t,e,i,s){this.stencilFailFront===t&&this.stencilZfailFront===e&&this.stencilZpassFront===i||(this.gl.stencilOpSeparate(this.gl.FRONT,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailFront=t,this.stencilZfailFront=e,this.stencilZpassFront=i),this.stencilWriteMaskFront!==s&&(this.gl.stencilMaskSeparate(this.gl.FRONT,s),this.stencilWriteMaskFront=s)},setStencilOperationBack:function(t,e,i,s){this.stencilFailBack===t&&this.stencilZfailBack===e&&this.stencilZpassBack===i||(this.gl.stencilOpSeparate(this.gl.BACK,this.glStencilOp[t],this.glStencilOp[e],this.glStencilOp[i]),this.stencilFailBack=t,this.stencilZfailBack=e,this.stencilZpassBack=i),this.stencilWriteMaskBack!==s&&(this.gl.stencilMaskSeparate(this.gl.BACK,s),this.stencilWriteMaskBack=s)},setBlendFunction:function(t,e){(this.blendSrc!==t||this.blendDst!==e||this.separateAlphaBlend)&&(this.gl.blendFunc(this.glBlendFunction[t],this.glBlendFunction[e]),this.blendSrc=t,this.blendDst=e,this.separateAlphaBlend=!1)},setBlendFunctionSeparate:function(t,e,i,s){this.blendSrc===t&&this.blendDst===e&&this.blendSrcAlpha===i&&this.blendDstAlpha===s&&this.separateAlphaBlend||(this.gl.blendFuncSeparate(this.glBlendFunction[t],this.glBlendFunction[e],this.glBlendFunction[i],this.glBlendFunction[s]),this.blendSrc=t,this.blendDst=e,this.blendSrcAlpha=i,this.blendDstAlpha=s,this.separateAlphaBlend=!0)},setBlendEquation:function(t){(this.blendEquation!==t||this.separateAlphaEquation)&&(this.gl.blendEquation(this.glBlendEquation[t]),this.blendEquation=t,this.separateAlphaEquation=!1)},setBlendEquationSeparate:function(t,e){this.blendEquation===t&&this.blendAlphaEquation===e&&this.separateAlphaEquation||(this.gl.blendEquationSeparate(this.glBlendEquation[t],this.glBlendEquation[e]),this.blendEquation=t,this.blendAlphaEquation=e,this.separateAlphaEquation=!0)},setCullMode:function(t){if(this.cullMode!==t){if(0===t)this.gl.disable(this.gl.CULL_FACE);else{0===this.cullMode&&this.gl.enable(this.gl.CULL_FACE);var e=this.glCull[t];this.cullFace!==e&&(this.gl.cullFace(e),this.cullFace=e)}this.cullMode=t}},getCullMode:function(){return this.cullMode},setIndexBuffer:function(t){this.indexBuffer=t},setVertexBuffer:function(t){t&&this.vertexBuffers.push(t)},compileShaderSource:function(t,e){var i=this.gl,s=e?this.vertexShaderCache[t]:this.fragmentShaderCache[t];return s||(s=i.createShader(e?i.VERTEX_SHADER:i.FRAGMENT_SHADER),i.shaderSource(s,t),i.compileShader(s),e?this.vertexShaderCache[t]=s:this.fragmentShaderCache[t]=s),s},compileAndLinkShader:function(t){var e,i=this.gl,s=t.definition,n=s.attributes,r=this.compileShaderSource(s.vshader,!0),a=this.compileShaderSource(s.fshader,!1),o=i.createProgram();if(i.attachShader(o,r),i.attachShader(o,a),this.webgl2&&s.useTransformFeedback){for(e in s=[],n)n.hasOwnProperty(e)&&s.push("out_"+e);i.transformFeedbackVaryings(o,s,i.INTERLEAVED_ATTRIBS)}for(e in s={},n)if(n.hasOwnProperty(e)){var h=Ea[n[e]];s.hasOwnProperty(h),s[h]=e,i.bindAttribLocation(o,h,e)}i.linkProgram(o),t._glVertexShader=r,t._glFragmentShader=a,t._glProgram=o},createShader:function(t){this.compileAndLinkShader(t),this.shaders.push(t)},destroyShader:function(t){var e=this.shaders.indexOf(t);-1!==e&&this.shaders.splice(e,1),t._glProgram&&(this.gl.deleteProgram(t._glProgram),t._glProgram=null,this.removeShaderFromCache(t))},_addLineNumbers:function(t){for(var e=0,i=(t=t.split("\n")).length;e<i;e++)t[e]=e+1+":\t"+t[e];return t.join("\n")},postLink:function(t){var e=this.gl,i=t._glVertexShader,s=t._glFragmentShader,n=t._glProgram,r=t.definition;if(!e.getShaderParameter(i,e.COMPILE_STATUS))return console.error("Failed to compile vertex shader:\n\n"+this._addLineNumbers(r.vshader)+"\n\n"+e.getShaderInfoLog(i)),!1;if(!e.getShaderParameter(s,e.COMPILE_STATUS))return console.error("Failed to compile fragment shader:\n\n"+this._addLineNumbers(r.fshader)+"\n\n"+e.getShaderInfoLog(s)),!1;if(!e.getProgramParameter(n,e.LINK_STATUS))return console.error("Failed to link shader program. Error: "+e.getProgramInfoLog(n)),!1;i=0;for(var a=e.getProgramParameter(n,e.ACTIVE_ATTRIBUTES);i<a;){s=e.getActiveAttrib(n,i++);var o=e.getAttribLocation(n,s.name);void 0===r.attributes[s.name]&&console.error('Vertex shader attribute "'+s.name+'" is not mapped to a semantic in shader definition.'),o=new ur(this,r.attributes[s.name],this.pcUniformType[s.type],o),t.attributes.push(o)}for(i=0,r=e.getProgramParameter(n,e.ACTIVE_UNIFORMS);i<r;)s=e.getActiveUniform(n,i++),o=e.getUniformLocation(n,s.name),o=new ur(this,s.name,this.pcUniformType[s.type],o),s.type===e.SAMPLER_2D||s.type===e.SAMPLER_CUBE||this.webgl2&&(s.type===e.SAMPLER_2D_SHADOW||s.type===e.SAMPLER_CUBE_SHADOW||s.type===e.SAMPLER_3D)?t.samplers.push(o):t.uniforms.push(o);return t.ready=!0},setShader:function(t){if(t!==this.shader){if(!t.ready&&!this.postLink(t))return!1;this.shader=t,this.gl.useProgram(t._glProgram),this.attributesInvalidated=!0}return!0},getHdrFormat:function(){return this.textureHalfFloatRenderable?11:this.textureFloatRenderable?13:7},getBoneLimit:function(){return this.boneLimit},setBoneLimit:function(t){this.boneLimit=t},resizeCanvas:function(t,e){this._width=t,this._height=e;var i=Math.min(this._maxPixelRatio,window.devicePixelRatio);t*=i,e*=i,this.canvas.width===t&&this.canvas.height===e||(this.canvas.width=t,this.canvas.height=e,this.fire("resizecanvas",t,e))},setResolution:function(t,e){this._width=t,this._height=e,this.canvas.width=t,this.canvas.height=e,this.fire("resizecanvas",t,e)},clearShaderCache:function(){var t,e=this.gl;for(t in this.fragmentShaderCache)e.deleteShader(this.fragmentShaderCache[t]),delete this.fragmentShaderCache[t];for(t in this.vertexShaderCache)e.deleteShader(this.vertexShaderCache[t]),delete this.vertexShaderCache[t];this.programLib.clearCache()},clearVertexArrayObjectCache:function(){var t=this.gl;this._vaoMap.forEach(function(e,i,s){t.deleteVertexArray(e)}),this._vaoMap.clear()},removeShaderFromCache:function(t){this.programLib.removeFromCache(t)},destroy:function(){var t=this.gl;this.destroyGrabPass(),this.webgl2&&this.feedback&&t.deleteTransformFeedback(this.feedback),this.clearShaderCache(),this.clearVertexArrayObjectCache(),this.canvas.removeEventListener("webglcontextlost",this._contextLostHandler,!1),this.canvas.removeEventListener("webglcontextrestored",this._contextRestoredHandler,!1),this.gl=this.canvas=this._contextRestoredHandler=this._contextLostHandler=null}}),Object.defineProperty(mp.prototype,"width",{get:function(){return this.gl.drawingBufferWidth||this.canvas.width}}),Object.defineProperty(mp.prototype,"height",{get:function(){return this.gl.drawingBufferHeight||this.canvas.height}}),Object.defineProperty(mp.prototype,"fullscreen",{get:function(){return!!document.fullscreenElement},set:function(t){t?this.gl.canvas.requestFullscreen():document.exitFullscreen()}}),Object.defineProperty(mp.prototype,"enableAutoInstancing",{get:function(){return this._enableAutoInstancing},set:function(t){this._enableAutoInstancing=t&&this.extInstancing}}),Object.defineProperty(mp.prototype,"maxPixelRatio",{get:function(){return this._maxPixelRatio},set:function(t){this._maxPixelRatio=t,this.resizeCanvas(this._width,this._height)}}),Object.defineProperty(mp.prototype,"textureFloatHighPrecision",{get:function(){if(void 0===this._textureFloatHighPrecision){if(this.textureFloatRenderable){var t=st(this,Ra.fullscreenQuadVS,Ra.precisionTestPS,"ptest1"),e=st(this,Ra.fullscreenQuadVS,Ra.precisionTest2PS,"ptest2"),i={format:14,width:1,height:1,mipmaps:!1,minFilter:0,magFilter:0},s=new nt(this,i);s.name="testFHP";var n=new gp(this,s,{depth:!1});X(this,n,t),i.format=7,(t=new nt(this,i)).name="testFHP",i=new gp(this,t,{depth:!1}),this.constantTexSource.setValue(s),X(this,i,e),e=this.activeFramebuffer,this.setFramebuffer(i._glFrameBuffer);var r=new Uint8Array(4);this.readPixels(0,0,1,1,r),this.setFramebuffer(e),e=r[0]/255/16777216+r[1]/255/65536+r[2]/255/256+r[3]/255,s.destroy(),n.destroy(),t.destroy(),i.destroy(),s=0===e}else s=!1;this._textureFloatHighPrecision=s}return this._textureFloatHighPrecision}}),Object.defineProperties(mp.prototype,{textureHalfFloatUpdatable:{get:function(){if(void 0===this._textureHalfFloatUpdatable)if(this.webgl2)this._textureHalfFloatUpdatable=!0;else{var t=this.gl,e=this.extTextureHalfFloat.HALF_FLOAT_OES,i=!0,s=t.createTexture();t.bindTexture(t.TEXTURE_2D,s),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.NEAREST),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE);var n=new Uint16Array(16);t.texImage2D(t.TEXTURE_2D,0,t.RGBA,2,2,0,t.RGBA,e,n),t.getError()!==t.NO_ERROR&&(i=!1,console.log("Above error related to HALF_FLOAT_OES can be ignored, it was triggered by testing half float texture support")),t.bindTexture(t.TEXTURE_2D,null),t.deleteTexture(s),this._textureHalfFloatUpdatable=i}return this._textureHalfFloatUpdatable}}});var _p={depth:!0,face:0},gp=function(t,e,i){t instanceof mp?(this._colorBuffer=e,t=i):this._colorBuffer=t.colorBuffer,this._glDepthBuffer=this._glFrameBuffer=null,t=void 0!==t?t:_p,this._depthBuffer=t.depthBuffer,this._face=void 0!==t.face?t.face:0,this._depthBuffer?16===(e=this._depthBuffer._format)?(this._depth=!0,this._stencil=!1):this._stencil=this._depth=17===e:(this._depth=void 0===t.depth||t.depth,this._stencil=void 0!==t.stencil&&t.stencil),this._samples=void 0!==t.samples?t.samples:1,this.autoResolve=void 0===t.autoResolve||t.autoResolve,this._glMsaaDepthBuffer=this._glMsaaColorBuffer=this._glResolveFrameBuffer=null};Object.assign(gp.prototype,{destroy:function(){if(this._device){var t=this._device,e=t.targets.indexOf(this);-1!==e&&t.targets.splice(e,1),t=t.gl,this._glFrameBuffer&&(t.deleteFramebuffer(this._glFrameBuffer),this._glFrameBuffer=null),this._glDepthBuffer&&(t.deleteRenderbuffer(this._glDepthBuffer),this._glDepthBuffer=null),this._glResolveFrameBuffer&&(t.deleteFramebuffer(this._glResolveFrameBuffer),this._glResolveFrameBuffer=null),this._glMsaaColorBuffer&&(t.deleteRenderbuffer(this._glMsaaColorBuffer),this._glMsaaColorBuffer=null),this._glMsaaDepthBuffer&&(t.deleteRenderbuffer(this._glMsaaDepthBuffer),this._glMsaaDepthBuffer=null)}},resolve:function(t,e){if(this._device&&this._device.webgl2){var i=this._device.gl;void 0===t&&(t=!0),void 0===e&&this._depthBuffer&&(e=!0),i.bindFramebuffer(i.READ_FRAMEBUFFER,this._glFrameBuffer),i.bindFramebuffer(i.DRAW_FRAMEBUFFER,this._glResolveFrameBuffer),i.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,(t?i.COLOR_BUFFER_BIT:0)|(e?i.DEPTH_BUFFER_BIT:0),i.NEAREST),i.bindFramebuffer(i.FRAMEBUFFER,this._glFrameBuffer)}},copy:function(t,e,i){if(!this._device){if(!t._device)return!1;this._device=t._device}return this._device.copyRenderTarget(t,this,e,i)}}),Object.defineProperty(gp.prototype,"colorBuffer",{get:function(){return this._colorBuffer}}),Object.defineProperty(gp.prototype,"depthBuffer",{get:function(){return this._depthBuffer}}),Object.defineProperty(gp.prototype,"face",{get:function(){return this._face}}),Object.defineProperty(gp.prototype,"width",{get:function(){return this._colorBuffer?this._colorBuffer.width:this._depthBuffer.width}}),Object.defineProperty(gp.prototype,"height",{get:function(){return this._colorBuffer?this._colorBuffer.height:this._depthBuffer.height}});var yp=function(t){switch(t.type){case"rgbm":return"RGBM";case"rgbe":return"RGBE";default:switch(t.format){case 11:case 13:case 12:case 14:return"Linear";default:return"Gamma"}}},vp={type:5,base:0,count:4,indexed:!1};Object.assign(gr.prototype,{render:function(t,e,i){}}),br.createShader=function(t,e,i){return st(t,e,null,i,!0)},Object.assign(br.prototype,{destroy:function(){this._outputBuffer.destroy()},process:function(t,e){void 0===e&&(e=!0);var i=this.device;i.setRenderTarget(null),i.updateBegin(),i.setVertexBuffer(this._inputBuffer,0),i.setRaster(!1),i.setTransformFeedbackBuffer(this._outputBuffer),i.setShader(t),i.draw({type:0,base:0,count:this._inputBuffer.numVertices,indexed:!1}),i.setTransformFeedbackBuffer(null),i.setRaster(!0),i.updateEnd(),e&&(t=this._inputBuffer.bufferId,this._inputBuffer.bufferId=this._outputBuffer.bufferId,this._outputBuffer.bufferId=t,t=this._inputBuffer._vao,this._inputBuffer._vao=this._outputBuffer._vao,this._outputBuffer._vao=t)}}),Object.defineProperty(br.prototype,"inputBuffer",{get:function(){return this._inputBuffer}}),Object.defineProperty(br.prototype,"outputBuffer",{get:function(){return this._outputBuffer}}),xr.prototype=Object.create(nr.prototype),xr.prototype.constructor=xr,Object.assign(xr.prototype,{clone:function(){var t=new xr;return nr.prototype._cloneInternal.call(this,t),t},updateShader:function(t){var e={skin:!!this.meshInstances[0].skinInstance};this.shader=t.getProgramLibrary().getProgram("depth",e)}}),Sr.prototype.getSelection=function(t,e,i,s){var n=this.device;"object"==typeof t?(t=(s=t).x,e=s.y,i=s.width,s=s.height):e=this.layer.renderTarget.height-(e+(s||1)),i=i||1,s=s||1;var r=n.renderTarget;n.setRenderTarget(this.layer.renderTarget),n.updateBegin();var a=new Uint8Array(4*i*s);for(n.readPixels(t,e,i,s,a),n.updateEnd(),n.setRenderTarget(r),t=[],e=this.layer.instances.visibleOpaque[0].list,n=0;n<i*s;n++){16777215!==(r=(r=a[4*n])<<16|a[4*n+1]<<8|a[4*n+2])&&(r=e[r],-1===t.indexOf(r)&&t.push(r))}return t},Sr.prototype.prepare=function(t,e,i){var s=this.device,n=this;t instanceof wt&&(t=t.node.camera),this.scene=e;var r=null,a=null;if(i instanceof It?r=i:a=i,!this.layer){var o=s.scope.resolve("uColor");this.layer=new It({name:"Picker",shaderPass:18,opaqueSortMode:0,onEnable:function(){if(!this.renderTarget){var t=new nt(s,{format:7,width:n.width,height:n.height});t.name="pick",t.minFilter=0,t.magFilter=0,t.addressU=1,t.addressV=1,this.renderTarget=new gp(s,t,{depth:!0})}},onDisable:function(){this.renderTarget&&(this.renderTarget._colorBuffer.destroy(),this.renderTarget.destroy(),this.renderTarget=null)},onDrawCall:function(t,e){n.pickColor[0]=(e>>16&255)/255,n.pickColor[1]=(e>>8&255)/255,n.pickColor[2]=(255&e)/255,o.setValue(n.pickColor),s.setBlending(!1)}}),this.layerComp=new Ut,this.layerComp.pushOpaque(this.layer),this.meshInstances=this.layer.opaqueMeshInstances,this._instancesVersion=-1}if(r){if(this._instancesVersion!==r._version){for(this.layer.clearMeshInstances(),u=(d=r.instances.opaqueMeshInstances).length,c=0;c<u;c++)(p=d[c]).pick&&this.meshInstances.push(p);for(u=(d=r.instances.transparentMeshInstances).length,c=0;c<u;c++)(p=d[c]).pick&&this.meshInstances.push(p);this._instancesVersion=r._version}}else{this.layer.clearMeshInstances(),i=e.layers.layerList;var h=e.layers.subLayerEnabled,l=e.layers.subLayerList;for(e=0;e<i.length;e++)i[e].overrideClear&&i[e]._clearDepthBuffer&&(i[e]._pickerCleared=!1);for(e=0;e<i.length;e++){var c=i[e];if(c.renderTarget===a&&c.enabled&&h[e]){var d=c.cameras.indexOf(t);if(!(0>d)){c.overrideClear&&c._clearDepthBuffer&&!c._pickerCleared&&(this.meshInstances.push(this.clearDepthCommand),c._pickerCleared=!0);var u=(d=(d=l[e])?c.instances.transparentMeshInstances:c.instances.opaqueMeshInstances).length;for(c=0;c<u;c++){var p=d[c];p.pick&&this.meshInstances.push(p)}}}}}this.layer.cameras[0]!==t&&(this.layer.clearCameras(),this.layer.addCamera(t)),this.onLayerPreRender(this.layer,r,a),this.app.renderer.renderComposition(this.layerComp),this.onLayerPostRender(this.layer)},Sr.prototype.onLayerPreRender=function(t,e,i){this.width===t.renderTarget.width&&this.height===t.renderTarget.height||(t.onDisable(),t.onEnable()),t.oldClear=t.cameras[0].camera._clearOptions,t.oldAspectMode=t.cameras[0].aspectRatioMode,t.oldAspect=t.cameras[0].aspectRatio,t.cameras[0].camera._clearOptions=this.clearOptions,t.cameras[0].aspectRatioMode=1,t.cameras[0].aspectRatio=t.cameras[0].calculateAspectRatio(i||(e?e.renderTarget:null)),this.app.renderer.updateCameraFrustum(t.cameras[0].camera)},Sr.prototype.onLayerPostRender=function(t){t.cameras[0].camera._clearOptions=t.oldClear,t.cameras[0].aspectRatioMode=t.oldAspectMode,t.cameras[0].aspectRatio=t.oldAspect},Sr.prototype.resize=function(t,e){this.width=t,this.height=e},Object.defineProperty(Sr.prototype,"renderTarget",{get:function(){return this.layer.renderTarget}}),Object.assign(Tr.prototype,{load:function(t,e,i){throw Error("not implemented")},open:function(t,e,i){throw Error("not implemented")},patch:function(t,e){}});var bp=new wr,xp={9:"Tab",13:"Enter",16:"Shift",17:"Control",18:"Alt",27:"Escape",37:"Left",38:"Up",39:"Right",40:"Down",46:"Delete",91:"Win"};Ar.prototype=Object.create(n.prototype),Ar.prototype.constructor=Ar,Ar.prototype.attach=function(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("keydown",this._keyDownHandler,!1),this._element.addEventListener("keypress",this._keyPressHandler,!1),this._element.addEventListener("keyup",this._keyUpHandler,!1)},Ar.prototype.detach=function(){this._element.removeEventListener("keydown",this._keyDownHandler),this._element.removeEventListener("keypress",this._keyPressHandler),this._element.removeEventListener("keyup",this._keyUpHandler),this._element=null},Ar.prototype.toKeyIdentifier=function(t){var e;if(t=Pr(t),e=xp[t.toString()])return e;var i=(e=t.toString(16).toUpperCase()).length;for(t=0;t<4-i;t++)e="0"+e;return"U+"+e},Ar.prototype._handleKeyDown=function(t){var e=t.keyCode||t.charCode;void 0!==e&&(e=this.toKeyIdentifier(e),this._keymap[e]=!0,this.fire("keydown",Mr(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation())},Ar.prototype._handleKeyUp=function(t){var e=t.keyCode||t.charCode;void 0!==e&&(e=this.toKeyIdentifier(e),delete this._keymap[e],this.fire("keyup",Mr(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation())},Ar.prototype._handleKeyPress=function(t){this.fire("keypress",Mr(t)),this.preventDefault&&t.preventDefault(),this.stopPropagation&&t.stopPropagation()},Ar.prototype.update=function(){for(var t in this._lastmap)delete this._lastmap[t];for(t in this._keymap)this._keymap.hasOwnProperty(t)&&(this._lastmap[t]=this._keymap[t])},Ar.prototype.isPressed=function(t){return t=Pr(t),t=this.toKeyIdentifier(t),!!this._keymap[t]},Ar.prototype.wasPressed=function(t){return t=Pr(t),t=this.toKeyIdentifier(t),!!this._keymap[t]&&!this._lastmap[t]},Ar.prototype.wasReleased=function(t){return t=Pr(t),t=this.toKeyIdentifier(t),!this._keymap[t]&&!!this._lastmap[t]},Cr.prototype=Object.create(n.prototype),Cr.prototype.constructor=Cr,Cr.isPointerLocked=function(){return!!(document.pointerLockElement||document.mozPointerLockElement||document.webkitPointerLockElement)},Object.assign(Cr.prototype,{attach:function(t){this._target=t,this._attached||(this._attached=!0,t=!!sa.passiveEvents&&{passive:!1},window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t))},detach:function(){if(this._attached){this._attached=!1,this._target=null;var t=!!sa.passiveEvents&&{passive:!1};window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)}},disableContextMenu:function(){this._target&&this._target.addEventListener("contextmenu",this._contextMenuHandler)},enableContextMenu:function(){this._target&&this._target.removeEventListener("contextmenu",this._contextMenuHandler)},enablePointerLock:function(t,e){if(document.body.requestPointerLock){var i=function(){t(),document.removeEventListener("pointerlockchange",i)},s=function(){e(),document.removeEventListener("pointerlockerror",s)};t&&document.addEventListener("pointerlockchange",i,!1),e&&document.addEventListener("pointerlockerror",s,!1),document.body.requestPointerLock()}else e&&e()},disablePointerLock:function(t){if(document.exitPointerLock){var e=function(){t(),document.removeEventListener("pointerlockchange",e)};t&&document.addEventListener("pointerlockchange",e,!1),document.exitPointerLock()}},update:function(){this._lastbuttons[0]=this._buttons[0],this._lastbuttons[1]=this._buttons[1],this._lastbuttons[2]=this._buttons[2]},isPressed:function(t){return this._buttons[t]},wasPressed:function(t){return this._buttons[t]&&!this._lastbuttons[t]},wasReleased:function(t){return!this._buttons[t]&&this._lastbuttons[t]},_handleUp:function(t){this._buttons[t.button]=!1,(t=new Er(this,t)).event&&this.fire("mouseup",t)},_handleDown:function(t){this._buttons[t.button]=!0,(t=new Er(this,t)).event&&this.fire("mousedown",t)},_handleMove:function(t){(t=new Er(this,t)).event&&(this.fire("mousemove",t),this._lastX=t.x,this._lastY=t.y)},_handleWheel:function(t){(t=new Er(this,t)).event&&this.fire("mousewheel",t)},_getTargetCoords:function(t){var e=this._target.getBoundingClientRect(),i=Math.floor(e.left);return e=Math.floor(e.top),t.clientX<i||t.clientX>=i+this._target.clientWidth||t.clientY<e||t.clientY>=e+this._target.clientHeight?null:{x:t.clientX-i,y:t.clientY-e}}}),Ir.prototype.attach=function(t){this._element=t,this._keyboard&&this._keyboard.attach(t),this._mouse&&this._mouse.attach(t)},Ir.prototype.detach=function(){this._keyboard&&this._keyboard.detach(),this._mouse&&this._mouse.detach(),this._element=null},Ir.prototype.disableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.disableContextMenu()},Ir.prototype.enableContextMenu=function(){this._mouse||this._enableMouse(),this._mouse.enableContextMenu()},Ir.prototype.update=function(t){for(var e in this._keyboard&&this._keyboard.update(t),this._mouse&&this._mouse.update(t),this._gamepads&&this._gamepads.update(t),this._axesValues={},this._axes)this._axesValues[e]=[]},Ir.prototype.registerKeys=function(t,e){if(this._keyboard||this._enableKeyboard(),this._actions[t])throw Error("Action: "+t+" already registered");if(void 0===e)throw Error("Invalid button");e.length||(e=[e]),this._actions[t]?this._actions[t].push({type:"keyboard",keys:e}):this._actions[t]=[{type:"keyboard",keys:e}]},Ir.prototype.registerMouse=function(t,e){if(this._mouse||this._enableMouse(),void 0===e)throw Error("Invalid button");this._actions[t]?this._actions[t].push({type:"mouse",button:e}):this._actions[t]=[{type:"mouse",button:-e}]},Ir.prototype.registerPadButton=function(t,e,i){if(void 0===i)throw Error("Invalid button");this._actions[t]?this._actions[t].push({type:"gamepad",button:i,pad:e}):this._actions[t]=[{type:"gamepad",button:i,pad:e}]},Ir.prototype.registerAxis=function(t){var e=t.name;this._axes[e]||(this._axes[e]=[]);var i=this._axes[e].push(e);(t=t||{}).pad=t.pad||0;var s=function(s,n,r,a){switch(n){case"mousex":s._mouse.on("mousemove",function(t){s._axesValues[e][i]=t.dx/10});break;case"mousey":s._mouse.on("mousemove",function(t){s._axesValues[e][i]=t.dy/10});break;case"key":s._axes[e].push(function(){return s._keyboard.isPressed(a)?r:0});break;case"padrx":s._axes[e].push(function(){return s._gamepads.getAxis(t.pad,2)});break;case"padry":s._axes[e].push(function(){return s._gamepads.getAxis(t.pad,3)});break;case"padlx":s._axes[e].push(function(){return s._gamepads.getAxis(t.pad,0)});break;case"padly":s._axes[e].push(function(){return s._gamepads.getAxis(t.pad,1)});break;default:throw Error("Unknown axis")}};s(this,t.positive,1,t.positiveKey),(t.negativeKey||t.negative!==t.positive)&&s(this,t.negative,-1,t.negativeKey)},Ir.prototype.isPressed=function(t){if(!this._actions[t])return!1;var e,i=this._actions[t].length;for(e=0;e<i;++e){var s=this._actions[t][e];switch(s.type){case"keyboard":if(this._keyboard){var n,r=s.keys.length;for(n=0;n<r;n++)if(this._keyboard.isPressed(s.keys[n]))return!0}break;case"mouse":if(this._mouse&&this._mouse.isPressed(s.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.isPressed(s.pad,s.button))return!0}}return!1},Ir.prototype.wasPressed=function(t){if(!this._actions[t])return!1;var e,i=this._actions[t].length;for(e=0;e<i;++e){var s=this._actions[t][e];switch(s.type){case"keyboard":if(this._keyboard){var n,r=s.keys.length;for(n=0;n<r;n++)if(this._keyboard.wasPressed(s.keys[n]))return!0}break;case"mouse":if(this._mouse&&this._mouse.wasPressed(s.button))return!0;break;case"gamepad":if(this._gamepads&&this._gamepads.wasPressed(s.pad,s.button))return!0}}return!1},Ir.prototype.getAxis=function(t){var i=0;if(this._axes[t]){var s,n=this._axes[t].length;for(s=0;s<n;s++)if("function"===e(this._axes[t][s])){var r=this._axes[t][s]();Math.abs(r)>Math.abs(i)&&(i=r)}else this._axesValues[t]&&Math.abs(this._axesValues[t][s])>Math.abs(i)&&(i=this._axesValues[t][s])}return i},Ir.prototype._enableMouse=function(){if(this._mouse=new Cr,!this._element)throw Error("Controller must be attached to an Element");this._mouse.attach(this._element)},Ir.prototype._enableKeyboard=function(){if(this._keyboard=new Ar,!this._element)throw Error("Controller must be attached to an Element");this._keyboard.attach(this._element)};var Sp,Tp,wp=new v,Mp=new v,Pp=new P,Ap=new P,Ep=new P;Pp.end=new v,Ap.end=new v,Ep.end=new v;var Cp=new v,Ip=new v,Op=new v,Rp=new v,Dp=new v,Lp=new v,Fp=new v,Bp=new y,Np=new v,kp=new v,zp=new v,Up=new v,Vp=new v,jp=new v,Gp=new v,Hp=new v,Wp=new b;Object.assign(Or.prototype,{stopPropagation:function(){this._stopPropagation=!0,this.event&&(this.event.stopImmediatePropagation(),this.event.stopPropagation())}}),Rr.prototype=Object.create(Or.prototype),Rr.prototype.constructor=Rr,Dr.prototype=Object.create(Or.prototype),Dr.prototype.constructor=Dr,Lr.prototype=Object.create(Or.prototype),Lr.prototype.constructor=Lr,Object.assign(Fr.prototype,{attach:function(t){this._attached&&(this._attached=!1,this.detach()),this._target=t,this._attached=!0,t=!!sa.passiveEvents&&{passive:!0},this._useMouse&&(window.addEventListener("mouseup",this._upHandler,t),window.addEventListener("mousedown",this._downHandler,t),window.addEventListener("mousemove",this._moveHandler,t),window.addEventListener("wheel",this._wheelHandler,t)),this._useTouch&&sa.touch&&(this._target.addEventListener("touchstart",this._touchstartHandler,t),this._target.addEventListener("touchend",this._touchendHandler,!1),this._target.addEventListener("touchmove",this._touchmoveHandler,!1),this._target.addEventListener("touchcancel",this._touchcancelHandler,!1)),this.attachSelectEvents()},attachSelectEvents:function(){!this._selectEventsAttached&&this._useXr&&this.app&&this.app.xr&&this.app.xr.supported&&(this._clickedEntities||(this._clickedEntities={}),this._selectEventsAttached=!0,this.app.xr.on("start",this._onXrStart,this))},detach:function(){if(this._attached){this._attached=!1;var t=!!sa.passiveEvents&&{passive:!0};this._useMouse&&(window.removeEventListener("mouseup",this._upHandler,t),window.removeEventListener("mousedown",this._downHandler,t),window.removeEventListener("mousemove",this._moveHandler,t),window.removeEventListener("wheel",this._wheelHandler,t)),this._useTouch&&(this._target.removeEventListener("touchstart",this._touchstartHandler,t),this._target.removeEventListener("touchend",this._touchendHandler,!1),this._target.removeEventListener("touchmove",this._touchmoveHandler,!1),this._target.removeEventListener("touchcancel",this._touchcancelHandler,!1)),this._selectEventsAttached&&(this._selectEventsAttached=!1,this.app.xr.off("start",this._onXrStart,this),this.app.xr.off("end",this._onXrEnd,this),this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)),this._target=null}},addElement:function(t){-1===this._elements.indexOf(t)&&this._elements.push(t)},removeElement:function(t){-1!==(t=this._elements.indexOf(t))&&this._elements.splice(t,1)},_handleUp:function(t){this._enabled&&!Cr.isPointerLocked()&&(this._calcMouseCoords(t),null!==Sp&&this._onElementMouseEvent("mouseup",t))},_handleDown:function(t){this._enabled&&!Cr.isPointerLocked()&&(this._calcMouseCoords(t),null!==Sp&&this._onElementMouseEvent("mousedown",t))},_handleMove:function(t){this._enabled&&(this._calcMouseCoords(t),null!==Sp&&(this._onElementMouseEvent("mousemove",t),this._lastX=Sp,this._lastY=Tp))},_handleWheel:function(t){this._enabled&&(this._calcMouseCoords(t),null!==Sp&&this._onElementMouseEvent("mousewheel",t))},_determineTouchedElements:function(t){var e,i,s={},n=this.app.systems.camera.cameras;for(e=n.length-1;0<=e;e--){var r=n[e],a=0,o=0;for(i=t.changedTouches.length;o<i;o++)if(s[t.changedTouches[o].identifier])a++;else{var h=this._calcTouchCoords(t.changedTouches[o]),l=this._getTargetElement(r,h.x,h.y);l&&(a++,s[t.changedTouches[o].identifier]={element:l,camera:r,x:h.x,y:h.y})}if(a===i)break}return s},_handleTouchStart:function(t){if(this._enabled){for(var e=this._determineTouchedElements(t),i=0,s=t.changedTouches.length;i<s;i++){var n=t.changedTouches[i],r=e[n.identifier],a=this._touchedElements[n.identifier];!r||a&&r.element===a.element||(this._fireEvent(t.type,new Dr(t,r.element,r.camera,r.x,r.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!1)}for(var o in e)this._touchedElements[o]=e[o]}},_handleTouchEnd:function(t){if(this._enabled){var e=this.app.systems.camera.cameras;for(i in this._clickedEntities)delete this._clickedEntities[i];for(var i=0,s=t.changedTouches.length;i<s;i++){var n=t.changedTouches[i],r=this._touchedElements[n.identifier];if(r){var a=r.element,o=r.camera,h=r.x;if(r=r.y,delete this._touchedElements[n.identifier],delete this._touchesForWhichTouchLeaveHasFired[n.identifier],this._fireEvent(t.type,new Dr(t,a,o,h,r,n)),0===t.touches.length)for(var l=this._calcTouchCoords(n),c=e.length-1;0<=c;c--)this._getTargetElement(e[c],l.x,l.y)!==a||this._clickedEntities[a.entity.getGuid()]||(this._fireEvent("click",new Dr(t,a,o,h,r,n)),this._clickedEntities[a.entity.getGuid()]=!0)}}}},_handleTouchMove:function(t){if(t.preventDefault(),this._enabled)for(var e=this._determineTouchedElements(t),i=0,s=t.changedTouches.length;i<s;i++){var n=t.changedTouches[i],r=e[n.identifier],a=this._touchedElements[n.identifier];if(a){var o=this._calcTouchCoords(n);r&&r.element===a.element||this._touchesForWhichTouchLeaveHasFired[n.identifier]||(this._fireEvent("touchleave",new Dr(t,a.element,a.camera,o.x,o.y,n)),this._touchesForWhichTouchLeaveHasFired[n.identifier]=!0),this._fireEvent("touchmove",new Dr(t,a.element,a.camera,o.x,o.y,n))}}},_onElementMouseEvent:function(t,e){var i,s=this._hoveredElement;this._hoveredElement=null;for(var n,r=this.app.systems.camera.cameras,a=r.length-1;0<=a&&(n=r[a],!(i=this._getTargetElement(n,Sp,Tp)));a--);i&&(this._fireEvent(t,new Rr(e,i,n,Sp,Tp,this._lastX,this._lastY)),this._hoveredElement=i,"mousedown"===t&&(this._pressedElement=i)),s!==this._hoveredElement&&(s&&this._fireEvent("mouseleave",new Rr(e,s,n,Sp,Tp,this._lastX,this._lastY)),this._hoveredElement&&this._fireEvent("mouseenter",new Rr(e,this._hoveredElement,n,Sp,Tp,this._lastX,this._lastY))),"mouseup"===t&&this._pressedElement&&(this._pressedElement===this._hoveredElement?(this._pressedElement=null,this._clickedEntities&&this._clickedEntities[this._hoveredElement.entity.getGuid()]||this._fireEvent("click",new Rr(e,this._hoveredElement,n,Sp,Tp,this._lastX,this._lastY))):this._pressedElement=null)},_onXrStart:function(){this.app.xr.on("end",this._onXrEnd,this),this.app.xr.on("update",this._onXrUpdate,this),this.app.xr.input.on("selectstart",this._onSelectStart,this),this.app.xr.input.on("selectend",this._onSelectEnd,this),this.app.xr.input.on("remove",this._onXrInputRemove,this)},_onXrEnd:function(){this.app.xr.off("update",this._onXrUpdate,this),this.app.xr.input.off("selectstart",this._onSelectStart,this),this.app.xr.input.off("selectend",this._onSelectEnd,this),this.app.xr.input.off("remove",this._onXrInputRemove,this)},_onXrUpdate:function(){if(this._enabled)for(var t=this.app.xr.input.inputSources,e=0;e<t.length;e++)this._onElementSelectEvent("selectmove",t[e],null)},_onXrInputRemove:function(t){var e=this._selectedElements[t.id];e&&(t._elementEntity=null,this._fireEvent("selectleave",new Lr(null,e,null,t))),delete this._selectedElements[t.id],delete this._selectedPressedElements[t.id]},_onSelectStart:function(t,e){this._enabled&&this._onElementSelectEvent("selectstart",t,e)},_onSelectEnd:function(t,e){this._enabled&&this._onElementSelectEvent("selectend",t,e)},_onElementSelectEvent:function(t,e,i){var s,n=this._selectedElements[e.id],r=this.app.systems.camera.cameras;if(e.elementInput){Ep.set(e.getOrigin(),e.getDirection());for(var a=r.length-1;0<=a;a--){var o=r[a];if(s=this._getTargetElementByRay(Ep,o))break}}if(e._elementEntity=s||null,s)var h=this._selectedElements[e.id]=s;else delete this._selectedElements[e.id];n!==h&&(n&&this._fireEvent("selectleave",new Lr(i,n,o,e)),h&&this._fireEvent("selectenter",new Lr(i,h,o,e))),"selectstart"===t&&(this._selectedPressedElements[e.id]=h)&&this._fireEvent("selectstart",new Lr(i,h,o,e)),s=this._selectedPressedElements[e.id],!e.elementInput&&s&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new Lr(i,n,o,e))),"selectend"===t&&e.elementInput&&(delete this._selectedPressedElements[e.id],n&&this._fireEvent("selectend",new Lr(i,n,o,e)),s&&s===n&&this._fireEvent("click",new Lr(i,s,o,e)))},_fireEvent:function(t,e){for(var i=e.element;(i.fire(t,e),!e._stopPropagation)&&i.entity.parent&&(i=i.entity.parent.element););},_calcMouseCoords:function(t){var e=this._target.getBoundingClientRect(),i=Math.floor(e.left);e=Math.floor(e.top),t.clientX<i||t.clientX>=i+this._target.clientWidth||t.clientY<e||t.clientY>=e+this._target.clientHeight?Tp=Sp=null:(Sp=t.clientX-i,Tp=t.clientY-e)},_calcTouchCoords:function(t){for(var e=0,i=0,s=t.target;!(s instanceof HTMLElement);)s=s.parentNode;do{e+=s.offsetLeft-s.scrollLeft,i+=s.offsetTop-s.scrollTop,s=s.offsetParent}while(s);return{x:t.pageX-e,y:t.pageY-i}},_sortElements:function(t,e){var i=this.app.scene.layers.sortTransparentLayers(t.layers,e.layers);return 0!==i?i:t.screen&&!e.screen?-1:!t.screen&&e.screen?1:t.screen||e.screen?t.screen.screen.screenSpace&&!e.screen.screen.screenSpace?-1:e.screen.screen.screenSpace&&!t.screen.screen.screenSpace?1:e.drawOrder-t.drawOrder:0},_getTargetElement:function(t,e,i){var s=null;this._elements.sort(this._sortHandler);for(var n,r,a=0,o=this._elements.length;a<o;a++){var h=this._elements[a],l=!1;if(h.screen&&h.screen.screen.screenSpace){void 0===n&&(n=Pp,!1===this._calculateRayScreen(e,i,t,n)&&(n=null));var c=n;l=!0}else void 0===r&&(r=Ap,!1===this._calculateRay3d(e,i,t,r)&&(r=null)),c=r;if(c&&this._checkElement(c,h,l)){s=h;break}}return s},_getTargetElementByRay:function(t,e){var i=null;for(Pp.origin.copy(t.origin),Pp.direction.copy(t.direction),Pp.end.copy(Pp.direction).scale(2*e.farClip).add(Pp.origin),this._elements.sort(this._sortHandler),t=0,e=this._elements.length;t<e;t++){var s=this._elements[t];if((!s.screen||!s.screen.screen.screenSpace)&&this._checkElement(Pp,s,!1)){i=s;break}}return i},_buildHitCorners:function(t,e,i,s){if(t.entity&&t.entity.button){var n=t.entity.button.hitPadding||Wp;Np.copy(t.entity.up),kp.copy(Np).scale(-1),Up.copy(t.entity.right),zp.copy(Up).scale(-1),Np.scale(n.w*s),kp.scale(n.y*s),Up.scale(n.z*i),zp.scale(n.x*i),Vp.copy(e[0]).add(kp).add(zp),jp.copy(e[1]).add(kp).add(Up),Gp.copy(e[2]).add(Np).add(Up),Hp.copy(e[3]).add(Np).add(zp),e=[Vp,jp,Gp,Hp]}return e},_calculateScaleToScreen:function(t){var e=t.entity;for(t=t.screen.screen.scale,Bp.set(t,t);e&&!e.screen;)Bp.mul(e.getLocalScale()),e=e.parent;return Bp},_calculateRayScreen:function(t,e,i,s){var n=this.app.graphicsDevice.width,r=this.app.graphicsDevice.height,a=i.rect.z*n,o=i.rect.w*r,h=i.rect.x*n,l=(i=(1-i.rect.y)*r)-o;return t=t*n/this._target.clientWidth,e=e*r/this._target.clientHeight,t>=h&&t<=h+a&&e<=i&&e>=l&&(s.origin.set(n*(t-h)/a,r-r*(e-l)/o,1),s.direction.set(0,0,-1),s.end.copy(s.direction).scale(2).add(s.origin),!0)},_calculateRay3d:function(t,e,i,s){var n=this._target.clientWidth,r=this._target.clientHeight,a=i.rect.z*n,o=i.rect.w*r,h=i.rect.x*n,l=(1-i.rect.y)*r,c=l-o,d=e;return t>=h&&t<=h+a&&e<=l&&d>=c&&(t=n*(t-h)/a,d=r*(d-c)/o,i.screenToWorld(t,d,i.nearClip,wp),i.screenToWorld(t,d,i.farClip,Mp),s.origin.copy(wp),s.direction.set(0,0,-1),s.end.copy(Mp),!0)},_checkElement:function(t,e,i){if(e.maskedBy&&!this._checkElement(t,e.maskedBy.element,i))return!1;var s=i?this._calculateScaleToScreen(e):e.entity.getWorldTransform().getScale();return e=this._buildHitCorners(e,i?e.screenCorners:e.worldCorners,s.x,s.y),!!function(t,e,i){if(Cp.sub2(e,t),Ip.sub2(i[0],t),Op.sub2(i[1],t),Rp.sub2(i[2],t),Lp.cross(Rp,Cp),0<=Ip.dot(Lp)){if(0>-Op.dot(Lp))return!1;if(t=Ip,0>Fp.cross(Cp,Op).dot(t))return!1}else{if(Dp.sub2(i[3],t),0>Dp.dot(Lp))return!1;if(t=Dp,0>Fp.cross(Cp,Ip).dot(t))return!1}return!(1e-8>Cp.sub2(i[0],i[2]).lengthSq()||1e-8>Cp.sub2(i[1],i[3]).lengthSq())}(t.origin,t.end,e)}}),Object.defineProperty(Fr.prototype,"enabled",{get:function(){return this._enabled},set:function(t){this._enabled=t}}),Object.defineProperty(Fr.prototype,"app",{get:function(){return this._app||sr.getApplication()},set:function(t){this._app=t}});var Xp={DEFAULT:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_3 PAD_FACE_4 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]},PS3:{buttons:"PAD_FACE_1 PAD_FACE_2 PAD_FACE_4 PAD_FACE_3 PAD_L_SHOULDER_1 PAD_R_SHOULDER_1 PAD_L_SHOULDER_2 PAD_R_SHOULDER_2 PAD_SELECT PAD_START PAD_L_STICK_BUTTON PAD_R_STICK_BUTTON PAD_UP PAD_DOWN PAD_LEFT PAD_RIGHT PAD_VENDOR".split(" "),axes:["PAD_L_STICK_X","PAD_L_STICK_Y","PAD_R_STICK_X","PAD_R_STICK_Y"]}},qp={"Product: 0268":"PS3"};Object.assign(Br.prototype,{update:function(){var t,e,i=0;for(e=this.current.length;i<e;i++){var s=this.current[i].pad.buttons,n=s.length;for(t=0;t<n;t++)void 0===this.previous[i]&&(this.previous[i]=[]),this.previous[i][t]=s[t].pressed}for(i=0,e=(t=this.poll()).length;i<e;i++)this.current[i]=t[i]},poll:function(){var t=[];if(this.gamepadsSupported){var e,i=navigator.getGamepads?navigator.getGamepads():navigator.webkitGetGamepads(),s=i.length;for(e=0;e<s;e++)i[e]&&t.push({map:this.getMap(i[e]),pad:i[e]})}return t},getMap:function(t){for(var e in qp)if(0<=t.id.indexOf(e))return Xp[qp[e]];return Xp.DEFAULT},isPressed:function(t,e){return!!this.current[t]&&this.current[t].pad.buttons[pc[this.current[t].map.buttons[e]]].pressed},wasPressed:function(t,e){return!!this.current[t]&&(e=pc[this.current[t].map.buttons[e]],this.current[t].pad.buttons[e].pressed&&!this.previous[t][e])},getAxis:function(t,e){return!!this.current[t]&&(t=this.current[t].pad.axes[pc[this.current[t].map.axes[e]]],Math.abs(t)<this.deadZone&&(t=0),t)}}),Object.assign(kr.prototype,{getTouchById:function(t,e){var i,s=e.length;for(i=0;i<s;i++)if(e[i].id===t)return e[i];return null}}),zr.prototype=Object.create(n.prototype),zr.prototype.constructor=zr,Object.assign(zr.prototype,{attach:function(t){this._element&&this.detach(),this._element=t,this._element.addEventListener("touchstart",this._startHandler,!1),this._element.addEventListener("touchend",this._endHandler,!1),this._element.addEventListener("touchmove",this._moveHandler,!1),this._element.addEventListener("touchcancel",this._cancelHandler,!1)},detach:function(){this._element&&(this._element.removeEventListener("touchstart",this._startHandler,!1),this._element.removeEventListener("touchend",this._endHandler,!1),this._element.removeEventListener("touchmove",this._moveHandler,!1),this._element.removeEventListener("touchcancel",this._cancelHandler,!1)),this._element=null},_handleTouchStart:function(t){this.fire("touchstart",new kr(this,t))},_handleTouchEnd:function(t){this.fire("touchend",new kr(this,t))},_handleTouchMove:function(t){t.preventDefault(),this.fire("touchmove",new kr(this,t))},_handleTouchCancel:function(t){this.fire("touchcancel",new kr(this,t))}}),Vr.prototype=Object.create(n.prototype),Vr.prototype.constructor=Vr,Vr.prototype.createTextures=function(t){if((t=this._normalizeCharsSet(t)).length!==this.chars.length)this._renderAtlas(t);else for(var e=0;e<t.length;e++)if(t[e]!==this.chars[e]){this._renderAtlas(t);break}},Vr.prototype.updateTextures=function(t){t=this._normalizeCharsSet(t);for(var e=[],i=0;i<t.length;i++){var s=t[i];this.data.chars[s]||e.push(s)}0<e.length&&this._renderAtlas(this.chars.concat(e))},Vr.prototype.destroy=function(){for(var t=0;t<this.textures.length;t++)this.textures[t].destroy();this.fontWeight=this.type=this.textures=this.intensity=this.glyphSize=this.fontSize=this.fontName=this.data=this.color=this.chars=null},Vr.prototype._getAndClearContext=function(t,e){var i=t.width,s=t.height;return(t=t.getContext("2d",{alpha:!0})).clearRect(0,0,i,s),t.fillStyle=e,t.fillRect(0,0,i,s),t},Vr.prototype._colorToRgbString=function(t,e){var i=Math.round(255*t.r),s=Math.round(255*t.g),n=Math.round(255*t.b);return e?"rgba("+i+", "+s+", "+n+", "+t.a+")":"rgb("+i+", "+s+", "+n+")"},Vr.prototype.renderCharacter=function(t,e,i,s,n){t.fillStyle=n,t.fillText(e,i,s)},Vr.prototype._renderAtlas=function(t){this.chars=t,t=1;var e=this.textures[t-1].getSource(),i=e.width,s=e.height,n=this._colorToRgbString(this.color,!1),r=this.color.a;this.color.a=1/255;var a=this._colorToRgbString(this.color,!0);this.color.a=r,(r=this._getAndClearContext(e,a)).font=this.fontWeight+" "+this.fontSize.toString()+"px "+this.fontName,r.textAlign="center",r.textBaseline="alphabetic",this.data=this._createJson(this.chars,this.fontName,i,s);var o,h=aa.getSymbols(this.chars.join("")),l=this.textures.length,c=0,d=0,u={};for(o=0;o<h.length;o++)u[e=h[o]]=this._getTextMetrics(e),c=Math.max(c,u[e].height),d=Math.max(d,u[e].descent);this.glyphSize=Math.max(this.glyphSize,c),c=this.glyphSize+2*this.padding;var p=this.glyphSize+2*this.padding,f=this.glyphSize/2+this.padding,m=p-d-this.padding,_=0,g=0;for(o=0;o<h.length;o++){e=h[o];var y=aa.getCodePoint(h[o]),v=this.fontSize;r.font=this.fontWeight+" "+v.toString()+"px "+this.fontName,r.textAlign="center",r.textBaseline="alphabetic";var b=r.measureText(e).width;b>v&&(v=this.fontSize*this.fontSize/b,r.font=this.fontWeight+" "+v.toString()+"px "+this.fontName,b=this.fontSize),this.renderCharacter(r,e,_+f,g+m,n),this._addChar(this.data,e,y,_,g,c,p,this.padding+(this.glyphSize-b)/2,-this.padding+u[e].descent-d,b,t-1,i,s),(_+=c)+c>i&&(_=0,(g+=p)+p>s&&(this.textures[t-1].upload(),g=0,++t>l?((e=document.createElement("canvas")).height=s,e.width=i,r=this._getAndClearContext(e,a),(y=new nt(this.app.graphicsDevice,{format:7,autoMipmap:!0})).name="font-atlas",y.setSource(e),y.minFilter=5,y.magFilter=1,y.addressU=1,y.addressV=1,this.textures.push(y)):(e=this.textures[t-1].getSource(),r=this._getAndClearContext(e,a))))}if(this.textures[t-1].upload(),t<l){for(o=t;o<l;o++)this.textures[o].destroy();this.textures.splice(t)}this.fire("render")},Vr.prototype._createJson=function(t,e,i,s){return{version:3,intensity:this.intensity,info:{face:e,width:i,height:s,maps:[{width:i,height:s}]},chars:{}}},Vr.prototype._addChar=function(t,e,i,s,n,r,a,o,h,l,c,d,u){t.info.maps.length<c+1&&t.info.maps.push({width:d,height:u}),d=this.fontSize/32,t.chars[e]={id:i,letter:e,x:s,y:n,width:r,height:a,xadvance:l/d,xoffset:o/d,yoffset:(h+this.padding)/d,scale:d,range:1,map:c,bounds:[0,0,r/d,a/d]}},Vr.prototype._normalizeCharsSet=function(t){var e,i=this.app.systems.element.getUnicodeConverter();for(i&&(t=i(t)),i={},t=aa.getSymbols(t),e=0;e<t.length;e++){var s=t[e];i[s]||(i[s]=s)}return Object.keys(i).sort()},Vr.prototype._getTextMetrics=function(t){var e=document.createElement("span");e.id="content-span",e.innerHTML=t,(t=document.createElement("div")).id="content-block",t.style.display="inline-block",t.style.width="1px",t.style.height="0px";var i=document.createElement("div");i.appendChild(e),i.appendChild(t),i.style.font=this.fontName,i.style.fontSize=this.fontSize+"px",document.body.appendChild(i);var s=-1,n=-1,r=-1;try{t.style["vertical-align"]="baseline",s=t.offsetTop-e.offsetTop,t.style["vertical-align"]="bottom",n=(r=t.offsetTop-e.offsetTop)-s}finally{document.body.removeChild(i)}return{ascent:s,descent:n,height:r}};var Yp,Kp=[null,null],$p=null,Zp=new b,Qp=new Float32Array(4),Jp=[],tf=!1,ef=!1,sf=!1,nf=/uniform[ \t\n\r]+\S+[ \t\n\r]+\S+[ \t\n\r]*;/g,rf=/\S+[ \t\n\r]*;/,af=/[ \t\n\r]*;/,of=/(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,hf=/(float|int|bool|vec2|vec3|vec4|struct|,|;|\{|\})/g,lf=/(uniform|varying|in|out)[ \t\n\r]+(float|int|bool|vec2|vec3|vec4|struct)([ \t\n\r]+[^;]+[ \t\n\r]*,*)+;/g,cf=/(float|int|bool|vec2|vec3|vec4|struct|uniform|varying|in|out|,|;|\{|\})/g,df=/#version/g,uf=/out highp vec4 pc_fragColor;/g,pf=/#define gl_FragColor/g,ff=/gl_FragColor/g,mf=/uniform[ \t\n\r]+sampler2D[ \t\n\r]+uColorBuffer;/g,_f=/(varying|in)[ \t\n\r]+vec2[ \t\n\r]+vUv0;/g,gf=/(texture2D|texture)[ \t\n\r]*\([ \t\n\r]*uColorBuffer/g,yf=/void[ \t\n\r]+main/g;Wr.prototype.addToComposition=function(t){this.app.scene.layers.insertTransparent(this.layer,t)};var vf={write:function(t){console.log(t)},open:function(){vf.write("Powered by PlayCanvas 1.35.0 100604b")},info:function(t){console.info("INFO:\t"+t)},debug:function(t){console.debug("DEBUG:   "+t)},error:function(t){console.error("ERROR:   "+t)},warning:function(t){console.warn("WARNING: "+t)},alert:function(t){vf.write("ALERT:   "+t),alert(t)},assert:function(t,e){!1===t&&vf.write("ASSERT:  "+e)}};aa.endsWith=function(t,e){return t.endsWith(e)},aa.startsWith=function(t,e){return t.startsWith(e)};var bf={now:ha,Timer:d};Object.defineProperty(o.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.r,this._data[1]=this.g,this._data[2]=this.b,this._data[3]=this.a,this._data}}),Object.defineProperty(o.prototype,"data3",{get:function(){return this._data3||(this._data3=new Float32Array(3)),this._data3[0]=this.r,this._data3[1]=this.g,this._data3[2]=this.b,this._data3}}),oa.INV_LOG2=Math.LOG2E,oa.intToBytes=oa.intToBytes32,oa.bytesToInt=oa.bytesToInt32,Object.defineProperty(y.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(2)),this._data[0]=this.x,this._data[1]=this.y,this._data}}),Object.defineProperty(v.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(3)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data}}),Object.defineProperty(b.prototype,"data",{get:function(){return this._data||(this._data=new Float32Array(4)),this._data[0]=this.x,this._data[1]=this.y,this._data[2]=this.z,this._data[3]=this.w,this._data}});var xf={Aabb:T,Sphere:w,Plane:E};w.prototype.intersectRay=w.prototype.intersectsRay,M.prototype.update=function(t,e){var i=new x;i.mul2(t,e),this.setFromMat4(i)},Xr.prototype=Error.prototype,qr.prototype=Error.prototype;var Sf={ADDRESS_CLAMP_TO_EDGE:1,ADDRESS_MIRRORED_REPEAT:2,ADDRESS_REPEAT:0,BLENDMODE_ZERO:0,BLENDMODE_ONE:1,BLENDMODE_SRC_COLOR:2,BLENDMODE_ONE_MINUS_SRC_COLOR:3,BLENDMODE_DST_COLOR:4,BLENDMODE_ONE_MINUS_DST_COLOR:5,BLENDMODE_SRC_ALPHA:6,BLENDMODE_SRC_ALPHA_SATURATE:7,BLENDMODE_ONE_MINUS_SRC_ALPHA:8,BLENDMODE_DST_ALPHA:9,BLENDMODE_ONE_MINUS_DST_ALPHA:10,BUFFER_STATIC:0,BUFFER_DYNAMIC:1,BUFFER_STREAM:2,CULLFACE_NONE:0,CULLFACE_BACK:1,CULLFACE_FRONT:2,CULLFACE_FRONTANDBACK:3,ELEMENTTYPE_INT8:0,ELEMENTTYPE_UINT8:1,ELEMENTTYPE_INT16:2,ELEMENTTYPE_UINT16:3,ELEMENTTYPE_INT32:4,ELEMENTTYPE_UINT32:5,ELEMENTTYPE_FLOAT32:6,FILTER_NEAREST:0,FILTER_LINEAR:1,FILTER_NEAREST_MIPMAP_NEAREST:2,FILTER_NEAREST_MIPMAP_LINEAR:3,FILTER_LINEAR_MIPMAP_NEAREST:4,FILTER_LINEAR_MIPMAP_LINEAR:5,INDEXFORMAT_UINT8:0,INDEXFORMAT_UINT16:1,INDEXFORMAT_UINT32:2,PIXELFORMAT_R5_G6_B5:3,PIXELFORMAT_R8_G8_B8:6,PIXELFORMAT_R8_G8_B8_A8:7,PRIMITIVE_POINTS:0,PRIMITIVE_LINES:1,PRIMITIVE_LINELOOP:2,PRIMITIVE_LINESTRIP:3,PRIMITIVE_TRIANGLES:4,PRIMITIVE_TRISTRIP:5,PRIMITIVE_TRIFAN:6,SEMANTIC_POSITION:"POSITION",SEMANTIC_NORMAL:"NORMAL",SEMANTIC_COLOR:"COLOR",SEMANTIC_TEXCOORD:"TEXCOORD",SEMANTIC_TEXCOORD0:"TEXCOORD0",SEMANTIC_TEXCOORD1:"TEXCOORD1",SEMANTIC_ATTR0:"ATTR0",SEMANTIC_ATTR1:"ATTR1",SEMANTIC_ATTR2:"ATTR2",SEMANTIC_ATTR3:"ATTR3",TEXTURELOCK_READ:1,TEXTURELOCK_WRITE:2,drawQuadWithShader:X,programlib:Ha,shaderChunks:Ra,ContextCreationError:qr,Device:mp,IndexBuffer:rt,ProgramLibrary:or,RenderTarget:gp,ScopeId:cr,Shader:q,ShaderInput:ur,Texture:nt,UnsupportedBrowserError:Xr,VertexBuffer:C,VertexFormat:O,VertexIterator:W},Tf={createFullscreenQuad:yr,drawFullscreenQuad:vr,PostEffect:gr,PostEffectQueue:Rs};Object.defineProperty(Ra,"transformSkinnedVS",{get:function(){return"#define SKIN\n"+Ra.transformVS}}),Object.defineProperties(nt.prototype,{rgbm:{get:function(){return"rgbm"===this.type},set:function(t){this.type=t?"rgbm":"default"}},swizzleGGGR:{get:function(){return"swizzleGGGR"===this.type},set:function(t){this.type=t?"swizzleGGGR":"default"}}});var wf=ar,Mf={partitionSkin:mi,procedural:{calculateTangents:te,createMesh:ee,createTorus:ie,createCylinder:ne,createCapsule:re,createCone:ae,createSphere:oe,createPlane:he,createBox:le},BasicMaterial:Nt,Command:ct,DepthMaterial:xr,ForwardRenderer:Ft,GraphNode:Mt,Material:nr,Mesh:ht,MeshInstance:lt,Model:mt,ParticleEmitter:tl,PhongMaterial:ar,Picker:Sr,Projection:{ORTHOGRAPHIC:1,PERSPECTIVE:0},Scene:ce,Skin:ve,SkinInstance:ft};Mt.prototype._dirtify=function(t){t?this._dirtifyLocal():this._dirtifyWorld()},Mt.prototype.addLabel=function(t){this._labels[t]=!0},Mt.prototype.getLabels=function(){return Object.keys(this._labels)},Mt.prototype.hasLabel=function(t){return!!this._labels[t]},Mt.prototype.removeLabel=function(t){delete this._labels[t]},Mt.prototype.findByLabel=function(t,e){var i,s=this._children.length;for(e=e||[],this.hasLabel(t)&&e.push(this),i=0;i<s;++i)e=this._children[i].findByLabel(t,e);return e},Mt.prototype.getChildren=function(){return this.children},Mt.prototype.getName=function(){return this.name},Mt.prototype.getPath=function(){return this.path},Mt.prototype.getRoot=function(){return this.root},Mt.prototype.getParent=function(){return this.parent},Mt.prototype.setName=function(t){this.name=t},nr.prototype.getName=function(){return this.name},nr.prototype.setName=function(t){this.name=t},nr.prototype.getShader=function(){return this.shader},nr.prototype.setShader=function(t){this.shader=t};var Pf={Animation:ge,Key:me,Node:_e,Skeleton:cs},Af={AudioManager:fe,Channel:el,Channel3d:sl,Listener:pe,Sound:Ve};fe.prototype.getListener=function(){return this.listener},fe.prototype.getVolume=function(){return this.volume},fe.prototype.setVolume=function(t){this.volume=t},Xi.prototype.getAssetById=function(t){return this.get(t)},Object.defineProperty(is.prototype,"ray",{get:function(){return this._rayLocal}}),Object.defineProperty(is.prototype,"position",{get:function(){return this._localPosition}}),Object.defineProperty(is.prototype,"rotation",{get:function(){return this._localRotation}});var Ef={getTouchTargetCoords:Ur,Controller:Ir,GamePads:Br,Keyboard:Ar,KeyboardEvent:wr,Mouse:Cr,MouseEvent:Er,Touch:Nr,TouchDevice:zr,TouchEvent:kr};Object.defineProperty(Fr.prototype,"wheel",{get:function(){return-2*this.wheelDelta}}),Object.defineProperty(Er.prototype,"wheel",{get:function(){return-2*this.wheelDelta}});var Cf=ed,If={Application:sr,Component:as,ComponentData:jr,ComponentSystem:os,Entity:xe,FillMode:{NONE:"NONE",FILL_WINDOW:"FILL_WINDOW",KEEP_ASPECT:gc},ResolutionMode:{AUTO:"AUTO",FIXED:yc}};sr.prototype.isFullscreen=function(){return!!document.fullscreenElement},sr.prototype.enableFullscreen=function(t,e,i){t=t||this.graphicsDevice.canvas;var s=function(){e(),document.removeEventListener("fullscreenchange",s)},n=function(){i(),document.removeEventListener("fullscreenerror",n)};e&&document.addEventListener("fullscreenchange",s,!1),i&&document.addEventListener("fullscreenerror",n,!1),t.requestFullscreen?t.requestFullscreen(Element.ALLOW_KEYBOARD_INPUT):i()},sr.prototype.disableFullscreen=function(t){var e=function(){t(),document.removeEventListener("fullscreenchange",e)};t&&document.addEventListener("fullscreenchange",e,!1),document.exitFullscreen()},Object.defineProperty(Yc.prototype,"node",{get:function(){return this.entity}}),Object.defineProperty(ln.prototype,"enable",{get:function(){return this.enabled},set:function(t){this.enabled=t}}),un.prototype.setVisible=function(t){this.enabled=t},Object.defineProperty(yn.prototype,"bodyType",{get:function(){return this.type},set:function(t){this.type=t}}),yn.prototype.syncBodyToEntity=function(){this._updateDynamic()},wn.prototype.setGravity=function(){1===arguments.length?this.gravity.copy(arguments[0]):this.gravity.set(arguments[0],arguments[1],arguments[2])},t.ABSOLUTE_URL=dl,t.ACTION_GAMEPAD="gamepad",t.ACTION_KEYBOARD="keyboard",t.ACTION_MOUSE="mouse",t.ADDRESS_CLAMP_TO_EDGE=1,t.ADDRESS_MIRRORED_REPEAT=2,t.ADDRESS_REPEAT=0,t.ANIM_EQUAL_TO="EQUAL_TO",t.ANIM_GREATER_THAN="GREATER_THAN",t.ANIM_GREATER_THAN_EQUAL_TO="GREATER_THAN_EQUAL_TO",t.ANIM_INTERRUPTION_NEXT="NEXT_STATE",t.ANIM_INTERRUPTION_NEXT_PREV="NEXT_STATE_PREV_STATE",t.ANIM_INTERRUPTION_NONE="NONE",t.ANIM_INTERRUPTION_PREV="PREV_STATE",t.ANIM_INTERRUPTION_PREV_NEXT="PREV_STATE_NEXT_STATE",t.ANIM_LESS_THAN="LESS_THAN",t.ANIM_LESS_THAN_EQUAL_TO="LESS_THAN_EQUAL_TO",t.ANIM_NOT_EQUAL_TO="NOT_EQUAL_TO",t.ANIM_PARAMETER_BOOLEAN="BOOLEAN",t.ANIM_PARAMETER_FLOAT="FLOAT",t.ANIM_PARAMETER_INTEGER="INTEGER",t.ANIM_PARAMETER_TRIGGER="TRIGGER",t.ANIM_STATE_ANY="ANY",t.ANIM_STATE_END="END",t.ANIM_STATE_START="START",t.ASPECT_AUTO=0,t.ASPECT_MANUAL=1,t.ASSET_ANIMATION="animation",t.ASSET_AUDIO="audio",t.ASSET_CONTAINER="container",t.ASSET_CSS="css",t.ASSET_CUBEMAP="cubemap",t.ASSET_HTML="html",t.ASSET_IMAGE="image",t.ASSET_JSON="json",t.ASSET_MATERIAL="material",t.ASSET_MODEL="model",t.ASSET_SCRIPT="script",t.ASSET_SHADER="shader",t.ASSET_TEXT="text",t.ASSET_TEXTURE="texture",t.AXIS_KEY="key",t.AXIS_MOUSE_X="mousex",t.AXIS_MOUSE_Y="mousey",t.AXIS_PAD_L_X="padlx",t.AXIS_PAD_L_Y="padly",t.AXIS_PAD_R_X="padrx",t.AXIS_PAD_R_Y="padry",t.AnimBinder=Ce,t.AnimClip=Ae,t.AnimClipHandler=ke,t.AnimComponent=vs,t.AnimComponentLayer=ms,t.AnimComponentSystem=xs,t.AnimController=ys,t.AnimCurve=we,t.AnimData=Se,t.AnimEvaluator=Oe,t.AnimPropertyLocator=be,t.AnimSnapshot=Pe,t.AnimStateGraph=ze,t.AnimStateGraphHandler=Ue,t.AnimTarget=Ee,t.AnimTrack=Me,t.Animation=ge,t.AnimationComponent=ds,t.AnimationComponentSystem=ps,t.AnimationHandler=Ne,t.Application=sr,t.Asset=Fe,t.AssetListLoader=ii,t.AssetReference=hi,t.AssetRegistry=Xi,t.AudioHandler=je,t.AudioListenerComponent=Ss,t.AudioListenerComponentSystem=ws,t.AudioSourceComponent=Ms,t.AudioSourceComponentSystem=As,t.BAKE_COLOR=0,t.BAKE_COLORDIR=1,t.BLENDEQUATION_ADD=0,t.BLENDEQUATION_MAX=4,t.BLENDEQUATION_MIN=3,t.BLENDEQUATION_REVERSE_SUBTRACT=2,t.BLENDEQUATION_SUBTRACT=1,t.BLENDMODE_DST_ALPHA=9,t.BLENDMODE_DST_COLOR=4,t.BLENDMODE_ONE=1,t.BLENDMODE_ONE_MINUS_DST_ALPHA=10,t.BLENDMODE_ONE_MINUS_DST_COLOR=5,t.BLENDMODE_ONE_MINUS_SRC_ALPHA=8,t.BLENDMODE_ONE_MINUS_SRC_COLOR=3,t.BLENDMODE_SRC_ALPHA=6,t.BLENDMODE_SRC_ALPHA_SATURATE=7,t.BLENDMODE_SRC_COLOR=2,t.BLENDMODE_ZERO=0,t.BLEND_ADDITIVE=1,t.BLEND_ADDITIVEALPHA=6,t.BLEND_MAX=10,t.BLEND_MIN=9,t.BLEND_MULTIPLICATIVE=5,t.BLEND_MULTIPLICATIVE2X=7,t.BLEND_NONE=3,t.BLEND_NORMAL=2,t.BLEND_PREMULTIPLIED=4,t.BLEND_SCREEN=8,t.BLEND_SUBTRACTIVE=0,t.BLUR_BOX=0,t.BLUR_GAUSSIAN=1,t.BODYFLAG_KINEMATIC_OBJECT=2,t.BODYFLAG_NORESPONSE_OBJECT=4,t.BODYFLAG_STATIC_OBJECT=1,t.BODYGROUP_DEFAULT=1,t.BODYGROUP_DYNAMIC=1,t.BODYGROUP_ENGINE_1=8,t.BODYGROUP_ENGINE_2=32,t.BODYGROUP_ENGINE_3=64,t.BODYGROUP_KINEMATIC=4,t.BODYGROUP_NONE=0,t.BODYGROUP_STATIC=id,t.BODYGROUP_TRIGGER=16,t.BODYGROUP_USER_1=128,t.BODYGROUP_USER_2=256,t.BODYGROUP_USER_3=512,t.BODYGROUP_USER_4=1024,t.BODYGROUP_USER_5=2048,t.BODYGROUP_USER_6=4096,t.BODYGROUP_USER_7=8192,t.BODYGROUP_USER_8=16384,t.BODYMASK_ALL=65535,t.BODYMASK_NONE=0,t.BODYMASK_NOT_STATIC=sd,t.BODYMASK_NOT_STATIC_KINEMATIC=65529,t.BODYMASK_STATIC=2,t.BODYSTATE_ACTIVE_TAG=1,t.BODYSTATE_DISABLE_DEACTIVATION=4,t.BODYSTATE_DISABLE_SIMULATION=5,t.BODYSTATE_ISLAND_SLEEPING=2,t.BODYSTATE_WANTS_DEACTIVATION=3,t.BODYTYPE_DYNAMIC="dynamic",t.BODYTYPE_KINEMATIC="kinematic",t.BODYTYPE_STATIC=ed,t.BUFFER_DYNAMIC=1,t.BUFFER_GPUDYNAMIC=3,t.BUFFER_STATIC=0,t.BUFFER_STREAM=2,t.BUTTON_TRANSITION_MODE_SPRITE_CHANGE=1,t.BUTTON_TRANSITION_MODE_TINT=Vc,t.BasicMaterial=Nt,t.BasisParser=Ui,t.Batch=_t,t.BatchGroup=gt,t.BatchManager=vt,t.BinaryHandler=Ge,t.BoundingBox=T,t.BoundingSphere=w,t.Bundle=He,t.BundleHandler=qe,t.BundleRegistry=qi,t.ButtonComponent=Cs,t.ButtonComponentSystem=Os,t.CLEARFLAG_COLOR=1,t.CLEARFLAG_DEPTH=2,t.CLEARFLAG_STENCIL=4,t.COMPUPDATED_BLEND=8,t.COMPUPDATED_CAMERAS=4,t.COMPUPDATED_INSTANCES=1,t.COMPUPDATED_LIGHTS=2,t.CUBEFACE_NEGX=1,t.CUBEFACE_NEGY=3,t.CUBEFACE_NEGZ=5,t.CUBEFACE_POSX=0,t.CUBEFACE_POSY=2,t.CUBEFACE_POSZ=4,t.CUBEPROJ_BOX=1,t.CUBEPROJ_NONE=0,t.CULLFACE_BACK=1,t.CULLFACE_FRONT=2,t.CULLFACE_FRONTANDBACK=3,t.CULLFACE_NONE=0,t.CURVE_CARDINAL=3,t.CURVE_CATMULL=2,t.CURVE_LINEAR=0,t.CURVE_SMOOTHSTEP=1,t.CURVE_SPLINE=4,t.CURVE_STEP=5,t.Camera=wt,t.CameraComponent=Yc,t.CameraComponentSystem=$c,t.CanvasFont=Vr,t.CollisionComponent=Zc,t.CollisionComponentSystem=_d,t.Color=o,t.Command=ct,t.Component=as,t.ComponentData=jr,t.ComponentSystem=os,t.ComponentSystemRegistry=Bs,t.ContactPoint=Sn,t.ContactResult=Tn,t.ContainerHandler=Ke,t.ContainerResource=Ye,t.ContextCreationError=qr,t.Controller=Ir,t.CssHandler=$e,t.CubemapHandler=Ze,t.Curve=m,t.CurveSet=_,t.DETAILMODE_ADD="add",t.DETAILMODE_MAX="max",t.DETAILMODE_MIN="min",t.DETAILMODE_MUL="mul",t.DETAILMODE_OVERLAY="overlay",t.DETAILMODE_SCREEN="screen",t.DISTANCE_EXPONENTIAL="exponential",t.DISTANCE_INVERSE=il,t.DISTANCE_LINEAR="linear",t.DefaultAnimBinder=Ie,t.DepthMaterial=xr,t.ELEMENTTYPE_FLOAT32=6,t.ELEMENTTYPE_GROUP=gd,t.ELEMENTTYPE_IMAGE="image",t.ELEMENTTYPE_INT16=2,t.ELEMENTTYPE_INT32=4,t.ELEMENTTYPE_INT8=0,t.ELEMENTTYPE_TEXT="text",t.ELEMENTTYPE_UINT16=3,t.ELEMENTTYPE_UINT32=5,t.ELEMENTTYPE_UINT8=1,t.EMITTERSHAPE_BOX=0,t.EMITTERSHAPE_SPHERE=1,t.EVENT_KEYDOWN="keydown",t.EVENT_KEYUP="keyup",t.EVENT_MOUSEDOWN="mousedown",t.EVENT_MOUSEMOVE="mousemove",t.EVENT_MOUSEUP="mouseup",t.EVENT_MOUSEWHEEL="mousewheel",t.EVENT_SELECT="select",t.EVENT_SELECTEND="selectend",t.EVENT_SELECTSTART="selectstart",t.EVENT_TOUCHCANCEL="touchcancel",t.EVENT_TOUCHEND="touchend",t.EVENT_TOUCHMOVE="touchmove",t.EVENT_TOUCHSTART="touchstart",t.ElementComponent=Ys,t.ElementComponentSystem=$s,t.ElementDragHelper=kn,t.ElementInput=Fr,t.ElementInputEvent=Or,t.ElementMouseEvent=Rr,t.ElementSelectEvent=Lr,t.ElementTouchEvent=Dr,t.Entity=xe,t.EntityReference=Es,t.EventHandler=n,t.FILLMODE_FILL_WINDOW="FILL_WINDOW",t.FILLMODE_KEEP_ASPECT=gc,t.FILLMODE_NONE="NONE",t.FILTER_LINEAR=1,t.FILTER_LINEAR_MIPMAP_LINEAR=5,t.FILTER_LINEAR_MIPMAP_NEAREST=4,t.FILTER_NEAREST=0,t.FILTER_NEAREST_MIPMAP_LINEAR=3,t.FILTER_NEAREST_MIPMAP_NEAREST=2,t.FITTING_BOTH=3,t.FITTING_NONE=Rd,t.FITTING_SHRINK=2,t.FITTING_STRETCH=1,t.FOG_EXP="exp",t.FOG_EXP2="exp2",t.FOG_LINEAR="linear",t.FOG_NONE="none",t.FONT_BITMAP="bitmap",t.FONT_MSDF="msdf",t.FRESNEL_NONE=0,t.FRESNEL_SCHLICK=2,t.FUNC_ALWAYS=7,t.FUNC_EQUAL=2,t.FUNC_GREATER=4,t.FUNC_GREATEREQUAL=6,t.FUNC_LESS=1,t.FUNC_LESSEQUAL=3,t.FUNC_NEVER=0,t.FUNC_NOTEQUAL=5,t.FolderHandler=Qe,t.Font=Je,t.FontHandler=ei,t.ForwardRenderer=Ft,t.Frustum=M,t.GAMMA_NONE=0,t.GAMMA_SRGB=1,t.GAMMA_SRGBFAST=2,t.GAMMA_SRGBHDR=3,t.GamePads=Br,t.GraphNode=Mt,t.GraphicsDevice=mp,t.HierarchyHandler=ri,t.HtmlHandler=ai,t.Http=p,t.I18n=De,t.INDEXFORMAT_UINT16=1,t.INDEXFORMAT_UINT32=2,t.INDEXFORMAT_UINT8=0,t.INTERPOLATION_CUBIC=2,t.INTERPOLATION_LINEAR=1,t.INTERPOLATION_STEP=0,t.ImageElement=zs,t.ImgParser=Vi,t.IndexBuffer=rt,t.IndexedList=h,t.JsonHandler=oi,t.JsonStandardMaterialParser=ci,t.KEY_0=48,t.KEY_1=49,t.KEY_2=50,t.KEY_3=51,t.KEY_4=52,t.KEY_5=53,t.KEY_6=54,t.KEY_7=55,t.KEY_8=56,t.KEY_9=57,t.KEY_A=65,t.KEY_ADD=107,t.KEY_ALT=18,t.KEY_B=66,t.KEY_BACKSPACE=8,t.KEY_BACK_SLASH=220,t.KEY_C=67,t.KEY_CAPS_LOCK=20,t.KEY_CLOSE_BRACKET=221,t.KEY_COMMA=188,t.KEY_CONTEXT_MENU=93,t.KEY_CONTROL=17,t.KEY_D=68,t.KEY_DECIMAL=110,t.KEY_DELETE=46,t.KEY_DIVIDE=111,t.KEY_DOWN=40,t.KEY_E=69,t.KEY_END=35,t.KEY_ENTER=13,t.KEY_EQUAL=61,t.KEY_ESCAPE=27,t.KEY_F=70,t.KEY_F1=112,t.KEY_F10=121,t.KEY_F11=122,t.KEY_F12=123,t.KEY_F2=113,t.KEY_F3=114,t.KEY_F4=115,t.KEY_F5=116,t.KEY_F6=117,t.KEY_F7=118,t.KEY_F8=119,t.KEY_F9=120,t.KEY_G=71,t.KEY_H=72,t.KEY_HOME=36,t.KEY_I=73,t.KEY_INSERT=45,t.KEY_J=74,t.KEY_K=75,t.KEY_L=76,t.KEY_LEFT=37,t.KEY_M=77,t.KEY_META=224,t.KEY_MULTIPLY=106,t.KEY_N=78,t.KEY_NUMPAD_0=96,t.KEY_NUMPAD_1=97,t.KEY_NUMPAD_2=98,t.KEY_NUMPAD_3=99,t.KEY_NUMPAD_4=100,t.KEY_NUMPAD_5=101,t.KEY_NUMPAD_6=102,t.KEY_NUMPAD_7=103,t.KEY_NUMPAD_8=104,t.KEY_NUMPAD_9=105,t.KEY_O=79,t.KEY_OPEN_BRACKET=219,t.KEY_P=80,t.KEY_PAGE_DOWN=34,t.KEY_PAGE_UP=33,t.KEY_PAUSE=19,t.KEY_PERIOD=190,t.KEY_PRINT_SCREEN=44,t.KEY_Q=81,t.KEY_R=82,t.KEY_RETURN=13,t.KEY_RIGHT=39,t.KEY_S=83,t.KEY_SEMICOLON=59,t.KEY_SEPARATOR=108,t.KEY_SHIFT=16,t.KEY_SLASH=191,t.KEY_SPACE=32,t.KEY_SUBTRACT=109,t.KEY_T=84,t.KEY_TAB=9,t.KEY_U=85,t.KEY_UP=38,t.KEY_V=86,t.KEY_W=87,t.KEY_WINDOWS=91,t.KEY_X=88,t.KEY_Y=89,t.KEY_Z=90,t.Key=me,t.Keyboard=Ar,t.KeyboardEvent=wr,t.KtxParser=ji,t.LAYERID_DEPTH=1,t.LAYERID_IMMEDIATE=3,t.LAYERID_SKYBOX=2,t.LAYERID_UI=4,t.LAYERID_WORLD=0,t.LAYER_FX=2,t.LAYER_GIZMO=1,t.LAYER_HUD=0,t.LAYER_WORLD=15,t.LIGHTFALLOFF_INVERSESQUARED=1,t.LIGHTFALLOFF_LINEAR=0,t.LIGHTTYPE_DIRECTIONAL=0,t.LIGHTTYPE_POINT=1,t.LIGHTTYPE_SPOT=2,t.LINEBATCH_GIZMO=2,t.LINEBATCH_OVERLAY=1,t.LINEBATCH_WORLD=0,t.Layer=It,t.LayerComposition=Ut,t.LayoutCalculator=tn,t.LayoutChildComponent=Zs,t.LayoutChildComponentSystem=Od,t.LayoutGroupComponent=sn,t.LayoutGroupComponentSystem=hn,t.LegacyDdsParser=Gi,t.Light=Hd,t.LightComponent=ln,t.LightComponentSystem=dn,t.Lightmapper=jt,t.LocalizedAsset=Us,t.MASK_BAKED=2,t.MASK_DYNAMIC=1,t.MASK_LIGHTMAP=4,t.MOUSEBUTTON_LEFT=0,t.MOUSEBUTTON_MIDDLE=1,t.MOUSEBUTTON_NONE=-1,t.MOUSEBUTTON_RIGHT=2,t.Mat3=g,t.Mat4=x,t.Material=nr,t.MaterialHandler=di,t.Mesh=ht,t.MeshInstance=lt,t.Model=mt,t.ModelComponent=un,t.ModelComponentSystem=fn,t.ModelHandler=gi,t.Morph=ut,t.MorphInstance=pt,t.MorphTarget=ye,t.Mouse=Cr,t.MouseEvent=Er,t.Node=_e,t.ORIENTATION_HORIZONTAL=0,t.ORIENTATION_VERTICAL=1,t.OrientedBox=A,t.PAD_1=0,t.PAD_2=1,t.PAD_3=2,t.PAD_4=3,t.PAD_DOWN=13,t.PAD_FACE_1=0,t.PAD_FACE_2=1,t.PAD_FACE_3=2,t.PAD_FACE_4=3,t.PAD_LEFT=14,t.PAD_L_SHOULDER_1=4,t.PAD_L_SHOULDER_2=6,t.PAD_L_STICK_BUTTON=10,t.PAD_L_STICK_X=0,t.PAD_L_STICK_Y=1,t.PAD_RIGHT=15,t.PAD_R_SHOULDER_1=5,t.PAD_R_SHOULDER_2=7,t.PAD_R_STICK_BUTTON=11,t.PAD_R_STICK_X=2,t.PAD_R_STICK_Y=3,t.PAD_SELECT=8,t.PAD_START=9,t.PAD_UP=12,t.PAD_VENDOR=16,t.PARTICLEMODE_CPU=1,t.PARTICLEMODE_GPU=0,t.PARTICLEORIENTATION_EMITTER=2,t.PARTICLEORIENTATION_SCREEN=0,t.PARTICLEORIENTATION_WORLD=1,t.PARTICLESORT_DISTANCE=1,t.PARTICLESORT_NEWER_FIRST=2,t.PARTICLESORT_NONE=0,t.PARTICLESORT_OLDER_FIRST=3,t.PIXELFORMAT_111110F=18,t.PIXELFORMAT_A8=0,t.PIXELFORMAT_ASTC_4x4=28,t.PIXELFORMAT_ATC_RGB=29,t.PIXELFORMAT_ATC_RGBA=30,t.PIXELFORMAT_DEPTH=16,t.PIXELFORMAT_DEPTHSTENCIL=17,t.PIXELFORMAT_DXT1=8,t.PIXELFORMAT_DXT3=9,t.PIXELFORMAT_DXT5=10,t.PIXELFORMAT_ETC1=21,t.PIXELFORMAT_ETC2_RGB=22,t.PIXELFORMAT_ETC2_RGBA=23,t.PIXELFORMAT_L8=1,t.PIXELFORMAT_L8_A8=2,t.PIXELFORMAT_PVRTC_2BPP_RGBA_1=25,t.PIXELFORMAT_PVRTC_2BPP_RGB_1=24,t.PIXELFORMAT_PVRTC_4BPP_RGBA_1=27,t.PIXELFORMAT_PVRTC_4BPP_RGB_1=26,t.PIXELFORMAT_R32F=15,t.PIXELFORMAT_R4_G4_B4_A4=5,t.PIXELFORMAT_R5_G5_B5_A1=4,t.PIXELFORMAT_R5_G6_B5=3,t.PIXELFORMAT_R8_G8_B8=6,t.PIXELFORMAT_R8_G8_B8_A8=7,t.PIXELFORMAT_RGB16F=11,t.PIXELFORMAT_RGB32F=13,t.PIXELFORMAT_RGBA16F=12,t.PIXELFORMAT_RGBA32F=14,t.PIXELFORMAT_SRGB=19,t.PIXELFORMAT_SRGBA=20,t.PRIMITIVE_LINELOOP=2,t.PRIMITIVE_LINES=1,t.PRIMITIVE_LINESTRIP=3,t.PRIMITIVE_POINTS=0,t.PRIMITIVE_TRIANGLES=4,t.PRIMITIVE_TRIFAN=6,t.PRIMITIVE_TRISTRIP=5,t.PROJECTION_ORTHOGRAPHIC=1,t.PROJECTION_PERSPECTIVE=0,t.ParticleEmitter=tl,t.ParticleSystemComponent=su,t.ParticleSystemComponentSystem=_n,t.PhongMaterial=wf,t.Picker=Sr,t.Plane=E,t.PostEffect=gr,t.PostEffectPass=Wr,t.PostEffectQueue=Rs,t.ProgramLibrary=or,t.Quat=S,t.RENDERSTYLE_POINTS=2,t.RENDERSTYLE_SOLID=0,t.RENDERSTYLE_WIREFRAME=1,t.RESOLUTION_AUTO="AUTO",t.RESOLUTION_FIXED=yc,t.RIGIDBODY_ACTIVE_TAG=1,t.RIGIDBODY_CF_KINEMATIC_OBJECT=2,t.RIGIDBODY_CF_NORESPONSE_OBJECT=4,t.RIGIDBODY_CF_STATIC_OBJECT=1,t.RIGIDBODY_DISABLE_DEACTIVATION=4,t.RIGIDBODY_DISABLE_SIMULATION=5,t.RIGIDBODY_ISLAND_SLEEPING=2,t.RIGIDBODY_TYPE_DYNAMIC="dynamic",t.RIGIDBODY_TYPE_KINEMATIC="kinematic",t.RIGIDBODY_TYPE_STATIC=Cf,t.RIGIDBODY_WANTS_DEACTIVATION=3,t.Ray=P,t.RaycastResult=bn,t.RenderTarget=gp,t.ResourceHandler=Tr,t.ResourceLoader=yi,t.RigidBodyComponent=yn,t.RigidBodyComponentSystem=wn,t.SCALEMODE_BLEND="blend",t.SCALEMODE_NONE=mu,t.SCROLLBAR_VISIBILITY_SHOW_ALWAYS=0,t.SCROLLBAR_VISIBILITY_SHOW_WHEN_REQUIRED=1,t.SCROLL_MODE_BOUNCE=1,t.SCROLL_MODE_CLAMP=0,t.SCROLL_MODE_INFINITE=2,t.SEMANTIC_ATTR="ATTR",t.SEMANTIC_ATTR0="ATTR0",t.SEMANTIC_ATTR1="ATTR1",t.SEMANTIC_ATTR10="ATTR10",t.SEMANTIC_ATTR11="ATTR11",t.SEMANTIC_ATTR12="ATTR12",t.SEMANTIC_ATTR13="ATTR13",t.SEMANTIC_ATTR14="ATTR14",t.SEMANTIC_ATTR15="ATTR15",t.SEMANTIC_ATTR2="ATTR2",t.SEMANTIC_ATTR3="ATTR3",t.SEMANTIC_ATTR4="ATTR4",t.SEMANTIC_ATTR5="ATTR5",t.SEMANTIC_ATTR6="ATTR6",t.SEMANTIC_ATTR7="ATTR7",t.SEMANTIC_ATTR8="ATTR8",t.SEMANTIC_ATTR9="ATTR9",t.SEMANTIC_BLENDINDICES="BLENDINDICES",t.SEMANTIC_BLENDWEIGHT="BLENDWEIGHT",t.SEMANTIC_COLOR="COLOR",t.SEMANTIC_NORMAL="NORMAL",t.SEMANTIC_POSITION="POSITION",t.SEMANTIC_TANGENT="TANGENT",t.SEMANTIC_TEXCOORD="TEXCOORD",t.SEMANTIC_TEXCOORD0="TEXCOORD0",t.SEMANTIC_TEXCOORD1="TEXCOORD1",t.SEMANTIC_TEXCOORD2="TEXCOORD2",t.SEMANTIC_TEXCOORD3="TEXCOORD3",t.SEMANTIC_TEXCOORD4="TEXCOORD4",t.SEMANTIC_TEXCOORD5="TEXCOORD5",t.SEMANTIC_TEXCOORD6="TEXCOORD6",t.SEMANTIC_TEXCOORD7="TEXCOORD7",t.SHADERDEF_DIRLM=128,t.SHADERDEF_INSTANCING=32,t.SHADERDEF_LM=64,t.SHADERDEF_MORPH_NORMAL=2048,t.SHADERDEF_MORPH_POSITION=1024,t.SHADERDEF_MORPH_TEXTURE_BASED=4096,t.SHADERDEF_NOSHADOW=1,t.SHADERDEF_SCREENSPACE=256,t.SHADERDEF_SKIN=2,t.SHADERDEF_TANGENTS=512,t.SHADERDEF_UV0=4,t.SHADERDEF_UV1=8,t.SHADERDEF_VCOLOR=16,t.SHADERTAG_MATERIAL=1,t.SHADER_DEPTH=2,t.SHADER_FORWARD=0,t.SHADER_FORWARDHDR=1,t.SHADER_PICK=18,t.SHADER_SHADOW=3,t.SHADOWUPDATE_NONE=0,t.SHADOWUPDATE_REALTIME=2,t.SHADOWUPDATE_THISFRAME=1,t.SHADOW_DEPTH=0,t.SHADOW_PCF3=0,t.SHADOW_PCF5=4,t.SHADOW_VSM16=2,t.SHADOW_VSM32=3,t.SHADOW_VSM8=1,t.SORTKEY_DEPTH=1,t.SORTKEY_FORWARD=0,t.SORTMODE_BACK2FRONT=3,t.SORTMODE_CUSTOM=5,t.SORTMODE_FRONT2BACK=4,t.SORTMODE_MANUAL=1,t.SORTMODE_MATERIALMESH=2,t.SORTMODE_NONE=0,t.SPECOCC_AO=1,t.SPECOCC_GLOSSDEPENDENT=2,t.SPECOCC_NONE=0,t.SPECULAR_BLINN=1,t.SPECULAR_PHONG=0,t.SPRITETYPE_ANIMATED="animated",t.SPRITETYPE_SIMPLE="simple",t.SPRITE_RENDERMODE_SIMPLE=0,t.SPRITE_RENDERMODE_SLICED=1,t.SPRITE_RENDERMODE_TILED=2,t.STENCILOP_DECREMENT=5,t.STENCILOP_DECREMENTWRAP=6,t.STENCILOP_INCREMENT=3,t.STENCILOP_INCREMENTWRAP=4,t.STENCILOP_INVERT=7,t.STENCILOP_KEEP=0,t.STENCILOP_REPLACE=2,t.STENCILOP_ZERO=1,t.Scene=ce,t.SceneHandler=vi,t.SceneRegistry=ir,t.SceneRegistryItem=er,t.SceneSettingsHandler=bi,t.ScopeId=cr,t.ScopeSpace=dr,t.ScreenComponent=Mn,t.ScreenComponentSystem=An,t.ScriptAttributes=En,t.ScriptComponent=Dn,t.ScriptComponentSystem=Fn,t.ScriptHandler=xi,t.ScriptLegacyComponent=Bn,t.ScriptLegacyComponentSystem=Au,t.ScriptRegistry=Yi,t.ScriptType=Cn,t.ScrollViewComponent=zn,t.ScrollViewComponentSystem=ku,t.ScrollbarComponent=Vn,t.ScrollbarComponentSystem=Gn,t.Shader=q,t.ShaderHandler=Si,t.SingleContactResult=xn,t.Skeleton=cs,t.Skin=ve,t.SkinInstance=ft,t.SortedLoopArray=Rn,t.Sound=Ve,t.SoundComponent=Wn,t.SoundComponentSystem=Gu,t.SoundManager=fe,t.SoundSlot=Hn,t.Sprite=Ti,t.SpriteAnimationClip=Kn,t.SpriteComponent=Hu,t.SpriteComponentSystem=Zn,t.SpriteHandler=wi,t.StandardMaterial=ar,t.StencilParameters=Ns,t.TEXHINT_ASSET=2,t.TEXHINT_LIGHTMAP=3,t.TEXHINT_NONE=0,t.TEXHINT_SHADOWMAP=1,t.TEXTURELOCK_READ=1,t.TEXTURELOCK_WRITE=2,t.TEXTURETYPE_DEFAULT="default",t.TEXTURETYPE_RGBE="rgbe",t.TEXTURETYPE_RGBM="rgbm",t.TEXTURETYPE_SWIZZLEGGGR="swizzleGGGR",t.TONEMAP_ACES=3,t.TONEMAP_ACES2=4,t.TONEMAP_FILMIC=1,t.TONEMAP_HEJL=2,t.TONEMAP_LINEAR=0,t.TYPE_FLOAT32=6,t.TYPE_INT16=2,t.TYPE_INT32=4,t.TYPE_INT8=0,t.TYPE_UINT16=3,t.TYPE_UINT32=5,t.TYPE_UINT8=1,t.Tags=c,t.Template=Ai,t.TemplateHandler=Ei,t.TemplateUtils=kl,t.TextElement=qs,t.TextHandler=Ci,t.Texture=nt,t.TextureAtlas=Ii,t.TextureAtlasHandler=Oi,t.TextureHandler=Wi,t.TextureParser=Hi,t.Timer=d,t.Touch=Nr,t.TouchDevice=zr,t.TouchEvent=kr,t.TransformFeedback=br,t.UNIFORMTYPE_BOOL=0,t.UNIFORMTYPE_BVEC2=9,t.UNIFORMTYPE_BVEC3=10,t.UNIFORMTYPE_BVEC4=11,t.UNIFORMTYPE_FLOAT=2,t.UNIFORMTYPE_FLOATARRAY=17,t.UNIFORMTYPE_INT=1,t.UNIFORMTYPE_IVEC2=6,t.UNIFORMTYPE_IVEC3=7,t.UNIFORMTYPE_IVEC4=8,t.UNIFORMTYPE_MAT2=12,t.UNIFORMTYPE_MAT3=13,t.UNIFORMTYPE_MAT4=14,t.UNIFORMTYPE_TEXTURE2D=15,t.UNIFORMTYPE_TEXTURE2D_SHADOW=18,t.UNIFORMTYPE_TEXTURE3D=20,t.UNIFORMTYPE_TEXTURECUBE=16,t.UNIFORMTYPE_TEXTURECUBE_SHADOW=19,t.UNIFORMTYPE_VEC2=3,t.UNIFORMTYPE_VEC2ARRAY=21,t.UNIFORMTYPE_VEC3=4,t.UNIFORMTYPE_VEC3ARRAY=22,t.UNIFORMTYPE_VEC4=5,t.UNIFORMTYPE_VEC4ARRAY=23,t.URI=u,t.UnsupportedBrowserError=Xr,t.VIEW_CENTER=0,t.VIEW_LEFT=1,t.VIEW_RIGHT=2,t.Vec2=y,t.Vec3=v,t.Vec4=b,t.VertexBuffer=C,t.VertexFormat=O,t.VertexIterator=W,t.VrDisplay=Ki,t.VrManager=$i,t.XRHAND_LEFT="left",t.XRHAND_NONE="none",t.XRHAND_RIGHT="right",t.XRSPACE_BOUNDEDFLOOR="bounded-floor",t.XRSPACE_LOCAL="local",t.XRSPACE_LOCALFLOOR="local-floor";t.XRSPACE_UNBOUNDED="unbounded",t.XRSPACE_VIEWER="viewer",t.XRTARGETRAY_GAZE="gaze",t.XRTARGETRAY_POINTER="tracked-pointer",t.XRTARGETRAY_SCREEN="screen",t.XRTRACKABLE_MESH="mesh",t.XRTRACKABLE_PLANE="plane",t.XRTRACKABLE_POINT="point",t.XRTYPE_AR=xc,t.XRTYPE_INLINE=vc,t.XRTYPE_VR=bc,t.XrHitTest=Qi,t.XrHitTestSource=Zi,t.XrInput=ss,t.XrInputSource=is,t.XrLightEstimation=ns,t.XrManager=rs,t.ZoneComponent=Qn,t.ZoneComponentSystem=qu,t.anim=Pf,t.apps={},t.asset={ASSET_ANIMATION:"animation",ASSET_AUDIO:"audio",ASSET_IMAGE:"image",ASSET_JSON:"json",ASSET_MODEL:"model",ASSET_MATERIAL:"material",ASSET_TEXT:"text",ASSET_TEXTURE:"texture",ASSET_CUBEMAP:"cubemap",ASSET_SCRIPT:"script"},t.audio=Af,t.basisDownload=Ni,t.basisDownloadFromConfig=ki,t.basisInitialize=Bi,t.basisSetDownloadConfig=function(t,e,i){cc={glueUrl:t,wasmUrl:e,fallbackUrl:i}},t.basisTargetFormat=Di,t.basisTranscode=zi,t.calculateNormals=Jt,t.calculateTangents=te,t.common={},t.config={},t.createBox=le,t.createCapsule=re,t.createCone=ae,t.createCylinder=ne,t.createMesh=ee,t.createPlane=he,t.createScript=In,t.createSphere=oe,t.createStyle=function(t){var e=document.createElement("style");return e.type="text/css",e.styleSheet?e.styleSheet.cssText=t:e.appendChild(document.createTextNode(t)),e},t.createTorus=ie,t.createURI=function(t){var e="";if((t.authority||t.scheme)&&(t.host||t.hostpath))throw Error("Can't have 'scheme' or 'authority' and 'host' or 'hostpath' option");if(t.host&&t.hostpath)throw Error("Can't have 'host' and 'hostpath' option");if(t.path&&t.hostpath)throw Error("Can't have 'path' and 'hostpath' option");return t.scheme&&(e+=t.scheme+":"),t.authority&&(e+="//"+t.authority),t.host&&(e+=t.host),t.path&&(e+=t.path),t.hostpath&&(e+=t.hostpath),t.query&&(e+="?"+t.query),t.fragment&&(e+="#"+t.fragment),e},t.data={},t.debug=Jr,t.drawFullscreenQuad=vr,t.drawQuadWithShader=X,t.drawTexture=function(t,e,i,s,n,r,a){s=s||t.getCopyShader(),t.constantTexSource.setValue(e),X(t,i,s,n,r,a)},t.events=ta,t.extend=i,t.fw=If,t.getTouchTargetCoords=Ur,t.gfx=Sf,t.guid=ea,t.http=la,t.inherits=function(t,e){var i=function(){},s=function(i,s,n,r,a,o,h,l){e.call(this,i,s,n,r,a,o,h,l),t.call(this,i,s,n,r,a,o,h,l)};return s._super=e.prototype,i.prototype=e.prototype,s.prototype=new i,s},t.input=Ef,t.isDefined=s,t.log=vf,t.makeArray=function(t){return Array.prototype.slice.call(t)},t.math=oa,t.now=ha,t.path=ia,t.platform=sa,t.posteffect=Tf,t.prefilterCubemap=function(t){var e=t.device,i=t.sourceCubemap,s=t.method,n=t.samples,r=t.cpuSync;if(r&&!i._levels[0])console.error("ERROR: prefilter: cubemap must have _levels");else{var a=i.type,o="rgbm"===a,h=st(e,Ra.fullscreenQuadVS,Ra.rgbmPS+Ra.prefilterCubemapPS.replace(/\$METHOD/g,0===s?"cos":"phong").replace(/\$NUMSAMPLES/g,n).replace(/\$textureCube/g,o?"textureCubeRGBM":"textureCube"),"prefilter"+s+n+o),l=st(e,Ra.fullscreenQuadVS,Ra.outputCubemapPS,"outputCubemap"),c=e.scope.resolve("source"),d=e.scope.resolve("params"),u=new b,p=i.width;n=i.format;var f,m=[[],t.filteredFixed,t.filteredRgbm,t.filteredFixedRgbm],_=0===s?[.9,.85,.7,.4,.25,.15,.1]:[512,128,32,8,2,1,1],g=[64,32,16,8,4,2,1],y=!1;if(r&&(y=i._levels[0][0]instanceof HTMLImageElement),(6===n||y)&&r){var v=new nt(e,{cubemap:!0,type:a,format:n=7,width:p,height:p,mipmaps:!1});for(v.name="prefiltered-cube",f=0;6>f;f++){var x=new gp(e,v,{face:f,depth:!1});u.x=f,u.y=0,c.setValue(i),d.setValue(u.data),X(e,x,l),fr(e,x,f)}i=v}if(128<p){var S=Math.round(Math.log2(p))-Math.round(Math.log2(128));for(y=0;y<S;y++){p=.5*i.width;var T=0===s?1:Math.pow(2,Math.round(Math.log2(_[0])+2*(S-y)));for((v=new nt(e,{cubemap:!0,type:a,format:n,width:p,height:p,mipmaps:!1})).name="prefiltered-cube",f=0;6>f;f++)x=new gp(e,v,{face:f,depth:!1}),u.x=f,u.y=T,u.z=p,u.w=o?3:0,c.setValue(i),d.setValue(u.data),X(e,x,l),y===S-1&&r&&fr(e,x,f);i=v}}if(t.sourceCubemap=i,v=null,!o&&t.filteredFixedRgbm)for((v=new nt(e,{cubemap:!0,type:"rgbm",format:7,width:p,height:p,mipmaps:!1})).name="prefiltered-cube",f=0;6>f;f++)x=new gp(e,v,{face:f,depth:!1}),u.x=f,u.w=2,c.setValue(i),d.setValue(u.data),X(e,x,l),fr(e,x,f);for(p=0===s?1:2048,m[x=0===s?0:-1]=[],y=0;7>y;y++)for(l=x;l<m.length;l++)null!=m[l]&&(m[l][y]=new nt(e,{cubemap:!0,type:2>l?a:"rgbm",format:2>l?n:7,fixCubemapSeams:1===l||3===l,width:g[y],height:g[y],mipmaps:!1}),m[l][y].name="prefiltered-cube");for(l=x;l<m.length;l++)if(null!=m[l])if(1<l&&o)m[l]=m[l-2];else for(y=0;7>y;y++)for(f=0;6>f;f++)x=new gp(e,m[l][y],{face:f,depth:!1}),u.x=f,u.y=0>l?p:_[y],u.z=g[y],u.w=o?3:l,c.setValue(0===y?i:0===s?m[0][y-1]:m[-1][y-1]),d.setValue(u.data),X(e,x,h),r&&fr(e,x,f);if(t.filtered=m[0],r&&t.singleFilteredFixed){for(i=[i].concat(t.filteredFixed),(a=new nt(e,{cubemap:!0,type:a,fixCubemapSeams:!0,format:n,width:128,height:128,addressU:1,addressV:1})).name="prefiltered-cube",y=0;y<i.length;y++)a._levels[y]=i[y]._levels[0];a.upload(),a._prefilteredMips=!0,t.singleFilteredFixed=a}if(r&&t.singleFilteredFixedRgbm&&t.filteredFixedRgbm){for(i=[v].concat(t.filteredFixedRgbm),(a=new nt(e,{cubemap:!0,type:"rgbm",fixCubemapSeams:!0,format:7,width:128,height:128,addressU:1,addressV:1})).name="prefiltered-cube",y=0;y<i.length;y++)a._levels[y]=i[y]._levels[0];a.upload(),a._prefilteredMips=!0,t.singleFilteredFixedRgbm=a}}},t.programlib=Ha,t.registerScript=On,t.reprojectTexture=function(t,e,i,s){var n="decode"+yp(e),r="encode"+yp(i),a=e.cubemap?"sampleCubemap":"sampleEquirect",o=i.cubemap?"getDirectionCubemap":"getDirectionEquirect";for(n=st(t,Ra.fullscreenQuadVS,"#define DECODE_FUNC "+n+"\n#define ENCODE_FUNC "+r+"\n#define SOURCE_FUNC "+a+"\n#define TARGET_FUNC "+o+"\n#define NUM_SAMPLES 1024\n\n"+Ra.reprojectPS,"reproject"+n+r+a+o,null,t.webgl2?"":"#extension GL_OES_standard_derivatives: enable\n"),t.scope.resolve(e.cubemap?"sourceCube":"sourceTex").setValue(e),e=t.scope.resolve("params"),(r=new b).y=void 0!==s?s:1,r.z=void 0!==s?1:0,s=0;s<(i.cubemap?6:1);s++)a=new gp(t,i,{face:s,depth:!1}),r.x=s,e.setValue(r.data),X(t,a,n)},t.revision="100604b",t.scene=Mf,t.script=Ql,t.semanticToLocation=Ea,t.shFromCubemap=_r,t.shaderChunks=Ra,t.shape=xf,t.string=aa,t.time=bf,t.type=e,t.typedArrayIndexFormats=Aa,t.typedArrayIndexFormatsByteSize=[1,2,4],t.typedArrayToType={Int8Array:0,Uint8Array:1,Int16Array:2,Uint16Array:3,Int32Array:4,Uint32Array:5,Float32Array:6},t.typedArrayTypes=Ma,t.typedArrayTypesByteSize=Pa,t.version="1.35.0",Object.defineProperty(t,"__esModule",{value:!0})});
ASSET_PREFIX="",SCRIPT_PREFIX="",SCENE_PATH="977668.json",CONTEXT_OPTIONS={antialias:!0,alpha:!1,preserveDrawingBuffer:!1,preferWebGl2:!0},SCRIPTS=[34621449,34621513,34621375,34621435,34621446,34621316,34621311,34621501,34621436,34621421,34621430,34621514,34621380,34621507,34621448,34621392,34621459,34621454,34621422,34621333,34621300,34621426,34621455,34621437,34621393,34621517,34621495,34621425,34621442,34621405,34621389,34621516,34621411,34621335,34621500,34621377,34621463,34621447,34621458,34621445,34621491,34621423,34621429,34621456,34621383,34621476,34621385,34621487,34621439,34621301,34621488,34621391,34621515,34621427],CONFIG_FILENAME="config.json",INPUT_SETTINGS={useKeyboard:!0,useMouse:!0,useGamepads:!1,useTouch:!0},pc.script.legacy=!1,PRELOAD_MODULES=[{moduleName:"Ammo",glueUrl:"files/assets/34629338/1/ammo.wasm.js",wasmUrl:"files/assets/34629339/1/ammo.wasm.wasm",fallbackUrl:"files/assets/34629337/1/ammo.js",preload:!0}];
var loadModules=function(e,n,o){function t(e,n,o,t){!function(e,n){var o=document.createElement("script");o.onload=function(){n()},o.onerror=function(){throw new Error("failed to load "+e)},o.async=!0,o.src=e,document.head.appendChild(o)}(n,function(){var n=window[e];window[e+"Lib"]=n,n({locateFile:function(){return o}}).then(function(n){window[e]=n,t()})})}if(void 0===e||0===e.length)setTimeout(o);else{var l=e.length,r=function(){0===--l&&o()},a=function(){try{if("object"==typeof WebAssembly&&"function"==typeof WebAssembly.instantiate){const e=new WebAssembly.Module(Uint8Array.of(0,97,115,109,1,0,0,0));if(e instanceof WebAssembly.Module)return new WebAssembly.Instance(e)instanceof WebAssembly.Instance}}catch(e){}return!1}();e.forEach(function(e){if(!e.hasOwnProperty("preload")||e.preload)if(a)t(e.moduleName,n+e.glueUrl,n+e.wasmUrl,r);else{if(!e.fallbackUrl)throw new Error("wasm not supported and no fallback supplied for module "+e.moduleName);t(e.moduleName,n+e.fallbackUrl,"",r)}else r()})}};
!function(){var e,t,n,o=function(){n.resizeCanvas(e.width,e.height),e.style.width="",e.style.height="";var t=n._fillMode;t!=pc.FILLMODE_NONE&&t!=pc.FILLMODE_KEEP_ASPECT||(t==pc.FILLMODE_NONE&&e.clientHeight<window.innerHeight||e.clientWidth/e.clientHeight>=window.innerWidth/window.innerHeight?e.style.marginTop=Math.floor((window.innerHeight-e.clientHeight)/2)+"px":e.style.marginTop="")},i=function(e){var t=document.createElement("div");t.innerHTML=['<table style="background-color: #8CE; width: 100%; height: 100%;">',"  <tr>",'      <td align="center">','          <div style="display: table-cell; vertical-align: middle;">','              <div style="">'+e+"</div>","          </div>","      </td>","  </tr>","</table>"].join("\n"),document.body.appendChild(t)};(e=document.createElement("canvas")).setAttribute("id","application-canvas"),e.setAttribute("tabindex",0),e.onselectstart=function(){return!1},document.body.appendChild(e),t=function(e){return{elementInput:new pc.ElementInput(e,{useMouse:INPUT_SETTINGS.useMouse,useTouch:INPUT_SETTINGS.useTouch}),keyboard:INPUT_SETTINGS.useKeyboard?new pc.Keyboard(window):null,mouse:INPUT_SETTINGS.useMouse?new pc.Mouse(e):null,gamepads:INPUT_SETTINGS.useGamepads?new pc.GamePads:null,touch:INPUT_SETTINGS.useTouch&&pc.platform.touch?new pc.TouchDevice(e):null}}(e=e);try{n=new pc.Application(e,{elementInput:t.elementInput,keyboard:t.keyboard,mouse:t.mouse,gamepads:t.gamepads,touch:t.touch,graphicsDeviceOptions:window.CONTEXT_OPTIONS,assetPrefix:window.ASSET_PREFIX||"",scriptPrefix:window.SCRIPT_PREFIX||"",scriptsOrder:window.SCRIPTS||[]})}catch(e){return void(e instanceof pc.UnsupportedBrowserError?i('This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to find out more.</a>'):e instanceof pc.ContextCreationError?i('It doesn\'t appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>'):i("Could not initialize application. Error: "+e))}var r=function(){n.configure(CONFIG_FILENAME,function(t){t&&console.error(t),function(t,n,o){e.classList&&e.classList.add("fill-mode-"+t);var i="@media screen and (min-aspect-ratio: "+n+"/"+o+") {";i+="    #application-canvas.fill-mode-KEEP_ASPECT {",i+="        width: auto;",i+="        height: 100%;",i+="        margin: 0 auto;",i+="    }",i+="}",document.head.querySelector&&(document.head.querySelector("style").innerHTML+=i)}(n._fillMode,n._width,n._height),setTimeout(function(){o(),window.addEventListener("resize",o,!1),window.addEventListener("orientationchange",o,!1),n.preload(function(e){e&&console.error(e),n.loadScene(SCENE_PATH,function(e,t){e&&console.error(e),n.start()})})})})};PRELOAD_MODULES.length>0?loadModules(PRELOAD_MODULES,ASSET_PREFIX,r):r()}();
pc.script.createLoadingScreen(function(e){var t,a,i=function(){var e=document.getElementById("application-splash-wrapper");e&&e.parentElement&&e.parentElement.removeChild(e)};t=["@import url('https://fonts.googleapis.com/css?family=Kanit:700&display=swap');","body {","   background-color: #283538;","}",".hide {","   opacity: 0 !important;","   transition: opacity 0.35s;","}","@keyframes appear {","   0% {opacity: 0; }","   100% {opacity: 1; }","}","@keyframes rotate {","   0% {transform: rotate(0deg);}","   100% {transform: rotate(180deg);}","}","#application-splash-wrapper {","   background-color: #283538;","   position: absolute;","   top: 0;","   left: 0;","   height: 100%;","   width: 100%;","   opacity: 1","}","#application-splash {","    position: absolute;","    left: 0;","    right: 0;","    top: 0;","    bottom: 0;","    margin: auto;","}","#application-splash #gearMiddle {","   position: absolute;","   left: calc(51% - 75px);","   top: calc(48% - 75px);","   width: 144px;","   animation: appear 1s ease-out, rotate 1.5s linear infinite;","   transition: width 0.2s;","}","#application-splash #gearRight {","   position: absolute;","   left: calc(51% + 1px);","   top: calc(48% - 168px);","   width: 117px;","   animation: appear 1s ease-out, rotate 1.5s linear infinite reverse;","   transition: width 0.2s;","}","#application-splash #gearLeft {","   position: absolute;","   left: calc(51% - 188px);","   top: calc(48% - 57px);","   width: 117px;","   animation: appear 1s ease-out, rotate 1.5s linear infinite reverse;","   transition: width 0.2s;","}","#progress-text {","   position: fixed;","   width: 100%;","   text-align: center;","   top: calc(48% + 85px);;","   color: #ffffff;","   font-size: 32px;","   font-family: Kanit;","   animation: appear 1s ease-out;","}","@media (max-width: 480px), (max-height: 480px) {","   #application-splash #gearMiddle {","       width: 75px;","       left: calc(55% - 42.5px);","       top: calc(48% - 32.5px);","       transition: width 0.2s;","   }","   #application-splash #gearRight {","       width: 58px;","       left: calc(55% - 2px);","       top: calc(48% - 77px);","       transition: width 0.2s;","   }","   #application-splash #gearLeft {","       width: 58px;","       left: calc(55% - 99px);","       top: calc(48% - 22px);","       transition: width 0.2s;","   }","   #progress-text {","       top: calc(48% + 50px);;","       font-size: 28px;","}","}"].join("\n"),(a=document.createElement("style")).type="text/css",a.styleSheet?a.styleSheet.cssText=t:a.appendChild(document.createTextNode(t)),document.head.appendChild(a),function(){var e=document.createElement("div");e.id="application-splash-wrapper",document.body.appendChild(e);var t=document.createElement("div");t.id="application-splash",e.appendChild(t),t.style.display="none";var a=document.createElement("img");a.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAHUAAABxCAYAAADrleyqAAAHKklEQVR4nO2d7VEjRxCG36buP3IErCMAR8BmYBwBcgTgCNBFwDkC6SKQLgLWESBHgByBdBG8/jGzaAEJVtru+Vj2qVIVBVRPa97t3vkeQaKQPAMwa/xqJiLfI7kz0AWSpySnfMvaCx0dktck5/5zQ/I0tk9J4sW88+Lt4zEBP+93+PVE8vfYviVDSzGbTCP6ev2Bb/NUskk0fCU9tRSzyXUEXy9b+rYmeRfav+h0ELPJeUB/z9k+k9Q8kbwM5WM06J72x45iNivNvIFC93o4VNAm8xB+RoGHvTfb8mDs8yl1HsI1yRtLX4NCnVT7HveGvs+VfX1kzimZuqn2I9S7E9zdV9ZiytxSMnf35SxZU7HhxI+7Llo+B2/FH0WgCtnFExX6iBH8f6ByS/5E05inMLDZttwlXYPsYHHpGkX3eDneHIISQKXxQNaIlqEauvfbQtvuEaz8ZwNg6T8b/7cS7iEoGv9fBvJrHxMR+aphSF1UACBJC7s951ZE/tYwZJF+gTQiNSc2UEz7g6hpsBCRn1rGrNLvKdz7bGRhv4cUIvKfljGTSPVP3RCt7ag0BQXs0i8AfDO03Sdm2gZN0m8N3UqFC8syMmcjIr9oG7WMVCB8Rz43ZhZGrSP1FNsO/8BbVBtINaaROjSY3kW9gVRjnX6BIQXvw6whaZp+gedF2SvrcjJjJSK/Whk3j1SrFJM5laVxc1GZ2wx/GJaWxkO8U8sAZeTGytL4IGocSkvjIRpKawwD+69ZishvVsZNI5Vu+8Eg6FsuLNsaZqJ6p2+t7PcAs7oxS78k5wCurOz3gA3cMKHa5HiNSaTSrUIfBH2fEYyi1WI14SlcP6zQtt1DTKLVIlJvMQjaFpNoVY1Uv9LcdLSkh6hHq1qk+rQ707L3iRgBmGgaVIlUPxNTYUi7XShF5B8NQ50ilW7b/BRuLLPQcOgTs9AakGgVqb6LMoJbRFb4zwXSHS1awGWOfe/3wn/GSOthXMFFbKfpymdRfSNnBDfY/FrAHNjAtSQPWu3uH9hbpNOv3sCtipgdK640GjipfKljWMI94Ue3IP1uvRnSyj5LuOhdwmWeVRuhxQ+6Tyw9M6azoDX+Aa+Q/lrlCtutmhXcrM/z9/+CfNLrLmYi8qeWMRH5SbJE+pmrfP0Lkhs4gcdCd2zNm3/KANM5Sd+qH1vZN6QKsfLBgg2MK9xngMqyDCPKXEUdi8i/Acq5QoY7DHIUtRKRHyEK8o2P7Hbv5SjqJHB5g6jGVFrjo23JcT9QbqLGippBVENiNVpymiPOq0sTOvU2yg3R0lYjK1Ejk0205iRqFbn8bPqrOYkamyK2Ay3Z5CRqGbn8InL5bRnlJGq9FipGuVntsT1B/Ag4hFjznKnPr74gq0hFvDnOMlK5R5GbqGWkcseRyj2GVW6iFgx8BYhfu1SELLMj2YkKhJ+lyW6P7Qky6lR7Sga6+sNHaRmiLE1OEH+k5hhm2td+vMbbn1mWYcUJXCMgq6klT2UlLLdXZ6e0Brg1L7Zd+C9T4OUVH2VYlw5iA7fmV20WxTfEFshUUABXbffSnGO7f+ai8XMqfBORv7oa6cHC9omIfD16K6OP6jHSqYQVnLgH3+3io3OCtLPSLipsV+ov6wV5nfen+iheIJ2+3ArbDUZ7t2J4v0ukf5xBcz/NClsB9343rU3H53BPTWrvoRXengOY8hbMDVzGWKLlZqhdqJ350IP3UWwWcIvUO2/00j7IY7jd4jhUD3XWHiacKNv7LKgORVocjjVE62EsROQPTYN9vj81B/I48cz3lbJZThkZlYbRa6ym3iZGdvvE0mr3ntWtjD+Q5+xPSCZWhi3P+73EIOw+TC7uqzFb+eD3veQ2AR8K09UU1stZhgbTW5Yi8t2yAGtRV8b2c8R8j+0ganjMs9dw03FgRMT8LiDL1u9wIe5uTC7CbWKZfseGtnPGPHNZiprdIuhAjK0LMEm/w8DDh4wsxnxrrCJ1iNL3Md29py6qX2WY8rGqKZCXqBgaSG0oLY0PosZh5BcTmKAqqt+NVmja7DFmKVh7NWGup3zHwGz6TfNasDMMgh7CyGqfrWb6HSva+iyYdP2+KNpKZeB+hfdnhwqk896/IHmpfZCmpqgzxOmf1jcuLQ7Zp9rYnjlG3H51CSDK6aitIHnNsDxS4RQ0kmckHwL7XnOjUfem0N3UGKKC1lQ+1i6Q300eNf03hy5q14YVot55p3sgLX2uWZO8Y2ZnHgJwE+Uk7w0q5c7Q52sDf5tMmaOYr6FuSp4G8Heq5GuTBxofExQFdk/JQd5BdBnmsbuOJMknGo7zJoGvsOkRlbNmwLRFl126sKbhayJJSF6yfTSsGSF1kbw5Vkz24b15LL7iPkrJ0dIXyfkBgk4/tZhN+H5KjprCvG9PLcSMchR88tCl5HmjEs1bum3g/vfrA/vYov0s8GX/dc7Ah0kfwv/S4Xz5d4forAAAAABJRU5ErkJggg==",a.id="gearLeft",t.appendChild(a);var i=document.createElement("img");i.src=a.src,i.id="gearRight",t.appendChild(i);var o=document.createElement("img");o.src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAJAAAACWCAYAAAAxHwGlAAAJm0lEQVR4nO2d/3XbOBaFL9SA3UE0FURbgTUVWFtBtBUkW4G1FdhTgTUVWFOBuRVYW4GZCqxUcPcPQB6ZJin+AIgH6H3n+GTGsYUb8PIBBB8eDDKH5BWADYAFgGv3ZygOAPbuvx+MMX8FbEsJDckrki+Mx13sPgiNiS0gJCRvAexiajDGZN3Hs9gCcscNodmSu4FCzne6IkFDMHI30Dy2AKiBkmYeWwDsk1+25G6gZWwBkKEhGNkaSNDkVSNQokiZe0jREQQ10ASQ/BJbQyhyNpCkoWMeW0AocjbQMraAE5axBYQiZwNJikCStHglZwOJmQNBlhavZGkggZNWNVBizGMLqKBDWGIsYwuoQvImtoYQ5GqgeWwBNcxjCwhBlslOJF8h74LtjTH/iC3CN9lFIJLfIM88ALDIcRjLKgK5F6gl5E5aDwCWxpj/xRbii2wikDNPAbnmAay2raBMgdFkYSC37lMgjfWWBYBC4FrVIEYNYSdjemmM+elBzxANdwB+QHbkqeMA4Icx5s8YjZP8Ctdnxpj/Tt143X6rZ5LfpgrPJL/WaEiRZ04UjWiv23eSrxUNL1NpOAp5aumQN5KPDPjE4TohN4JtQiR5Q3tNorRfFfOlR6e8kryjJ3e7tp/7XZekeKWnG4+2r+qiTRvhoxCHX8BnDhziaEPv48B2U+SRA6cCJG/ZPkK08TSkzb7ixtJ5iKO9ix7d71wabyTv2SEq0PbTHftFmyZ6RcDOT2G0d8Qefld5SwBb97kH971jBY0V0ngsn4Id/q76UeXYV77o9cqlj4HuYMukKPmz7rq80MlALoyWYxQpSXEAMDfG/Dr3g11Xorej5CipcQ27OHuWsxGIAmrsKNGYn3vD0BqB3MR561ORkhQP537g3BC2QXrvmBR/rM491jcOYbQv25oeHZXLYQ+bw1Q7oW6LQGfDl3IRLNDihdoIRJsWug0kSEmTRV0m5ScDUX5aqBKHwhjze/WbdUPYBmoe5TNLt6TzgQ8RyK0476EGUuopjTG/nX6jGoEeoOZRmpmzknj2HoHc834xtSIlOQ6wE+qfwMcIpI/tSheucZKVMQNsjjE090bpzvq4Qm30sV0ZSGGM+X0GYA01j9KfJcmbGTrmfShKDcsZZFayUBJhBn3jrozA6OqzMpASwGLmFoQW0EikdGcHu5j4awYAzkRLaO6zcp4HY8w/jwlmdekcl7j/a4+/N+8dKt+f4+Pwfjw+fDORNkl82i/WlFB2C5tQlvu8qIQ1wq7LHqgqrp9W7ivnvmoszdeWE/0FbqwLKCwWXos7udX8HQTWp/bAHsCqaXtPY060Mean2yOd20vWLex+J2+VwYwxv1y23trXZwphCxt5xlWfo63KkXqFjDfaXO+gMJ/KaZ0KTvUprpDykDZpPUKGqWQyFb36qneRTZL3SOv9WZTazLT76gqkNbnu3Ve9y/waY/6NtMb6VYzC3q7N9dTtjqCAnRtO01e05eqk832Szki/nx6H/vvG1ol+gt/qWD6p3ccUg5z7aayBJBeeqt1JGQPKrjOwHFNofNRRB259QGLHbKWYB3ifD0l8z7gfW6Xex1kZhYfP8M02toAaJC7Ijr75szTQ5Gc/dMBpKmPrqFCO/QAfBjqc/5FJkThUHJGsbRBZHPdUQeKc7Ig0AxVjPyBHA5WxBbRQxhbgGzXQhMQ6Uy0kORpImZDsDCTxCaxCEVvACfOxH5CdgZRezMd+gBpIGUV2BmImpyGnQnYGgvwswGVsASeMTnbL0UDL2AKa4EQnWvdgdHpyjgaSnEKaUipwJ3wYSNoFW8cW0IK0DQkihjBpmXbXrCmIHRs3fEnrq8XYYTVHAwEyNUkdvpZjfnmUgWg36kkbwoCTKqKCkGqgUTfbYAO50LcZ03hgNrEFHKHd5SnxRgPszTZ47WxMBNpC9prLkh2354bERcJNbB1n2A79xUG7Mtw+ovXQRidmZYz5K0bDTKsG99YY86++v9TLQK5DCsh7HG3jw9kOU5FoX+1gi0h1rpXUeQhze5tKpNUhgL37d1O+I3NtFUivr1YACnetO9HJQO5pK+VKrgsA+ymezE42EaZmniMLWBN1Wks7ayA339mOFCWBa9iOCbZf3n12yjfakWPUPttXbSXuUhzDu1LA1sDxsnvVRZ0NZC5gjmUL21e186KmIpsp1rYZwhb26WNQGmzmxjmlsU5iXZnfSzzyew97wxQADm2GcvOoJewyxjy4MjnUFp+qHrqb0vqOEocfxpg/jv9jgOznO4p/3hcdjQvJO+Q/31H8sgewNCRfcVljueKPwpBkbBVKuswga6ekkhblDPJKjijpsNVjv5WhFABWM7dEvYmrRUmQ9emJhX9AdmUvRRbb42uN95Vo4bWMFVnMjwZ6T+dw7zgklqJVZLE9falafRemE2qljQNs9HlP7fiQUOb+Qur+JSU+D9W8oKZ8oGcIrnKhROFT9AGaU1rXweUoqfEp+gANBnKTpE1oRUoyHNDwgNWWVP8AeccYKHGojT5A+7Hfv6CP9QpQGmP+0/SXZ3emar7QxdN6IF2XjYVrf1qUxNid27HSaW+8JttfJLWP7VW67o3/AZ1QXxqbLkUWOhlIUz4ujv3p1p02+pZ3eYG/rT8H2GzIEp/Tahfua+2prdQpTr5OWcI+4Kzg9/3lqJOcGyH51cMh9y8kv3WpDkryluQjyTcP7abIK8nvPNNXJK9o+/TFQ5v3/hxTL/Z+gKg3WiN0rjtTafPK/f6l8Ea7xXxIX32hvUZDbro3hq6mT3sxu4p7Zsdo07HtG9q7MlfeSN7RX399I/nUo/1Bph0i7PZMJ9wzYEUw18m58chAfUYble7YfvM9hWi7TdRdRcAzp3Iw3jvl2ecVjMQzBw7tA/vthp+nA68cGPUGVWmVBK1pH5BeFuUBdmdDzAqyxyfqfZ/CmtlBG436jPWxeaK8o58GkXwEOoVpZFIWsNW+srjjczPQFezWpHlkKU10er+UElkdOOcuzDq2jhYai1WmSlYR6Aj9vnLxRWmM+S22CN9kFYFOkFhxpIgtIAS5GkgiZWwBIcjVQBL3+EvUNBo10HSUsQWEIMtJNACQsmo/GmOy7OtcIxAgKwqVsQWEQg00DWVsAaHI2UBlbAEnSDKzV3I2kKSLlu2OFjXQNBSxBYQiWwNNfcjuGcrYAkKRrYEcIqKQMDN7RQ0UHgkagpG7gcrYAiBDQzByN5CEu1+ChmCogcJTxhYQkqwNJGTyKsHEwcjaQI6YZfoKX2fTKxHhsP38Y3nMZetOG/8H7WkUhj37rD8AAAAASUVORK5CYII=",o.id="gearMiddle",t.appendChild(o),o.onload=function(){t.style.display="block"};var p=document.createElement("div");p.id="progress-text",t.appendChild(p),p.innerHTML="0%"}(),e.on("preload:end",function(){console.log("preload:end"),e.off("preload:progress"),skipTitleScreen()&&"undefined"!=typeof famobi&&famobi.onRequest&&famobi.onRequest("startGame",function(){console.log("famobi.startGame"),i(),WindowManager.startGameplay()}),"undefined"!=typeof famobi&&famobi.setPreloadProgress&&setTimeout(()=>famobi.setPreloadProgress(100),200)}),e.on("preload:progress",function(e){var t=document.getElementById("progress-text");t&&(e=Math.min(1,Math.max(0,e)),t.innerHTML=Math.floor(99*e)+"%"),window.famobi&&window.famobi.setPreloadProgress&&window.famobi.setPreloadProgress(Math.floor(99*e))}),e.on("start",function(){console.log("app:start"),skipTitleScreen()||i()})});